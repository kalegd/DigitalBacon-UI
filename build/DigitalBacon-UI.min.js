/*
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */
import*as r from"three";import{Vector3 as x,Mesh as b,BatchedMesh as S,Triangle as C,Plane as I,Line3 as A,Vector2 as R,Matrix4 as B,BufferAttribute as D,Box3 as F,FrontSide as G,Group as N,LineBasicMaterial as H,MeshBasicMaterial as W,Sphere as j,DataTexture as V,NearestFilter as X,UnsignedIntType as q,IntType as $,FloatType as K,RGBAFormat as Y,RGIntegerFormat as Z,BufferGeometry as J,Matrix3 as Q,Object3D as ee,REVISION as te,Ray as ne,UnsignedByteType as re,UnsignedShortType as ie,ByteType as se,ShortType as oe,RGBAIntegerFormat as ae,Vector4 as le,RGFormat as ce,RedFormat as he,RedIntegerFormat as de,BackSide as ue,DoubleSide as pe,TrianglesDrawMode as fe,TriangleFanDrawMode as ge,TriangleStripDrawMode as me,Quaternion as _e,Loader as ye,LoaderUtils as ve,FileLoader as xe,Color as be,LinearSRGBColorSpace as Te,SpotLight as we,PointLight as Se,DirectionalLight as Ce,SRGBColorSpace as Ie,MeshPhysicalMaterial as ke,InstancedMesh as Ae,InstancedBufferAttribute as Ee,TextureLoader as Re,ImageBitmapLoader as Me,InterleavedBuffer as Pe,InterleavedBufferAttribute as Be,LinearFilter as Le,LinearMipmapLinearFilter as Oe,RepeatWrapping as De,PointsMaterial as Ue,Material as Fe,MeshStandardMaterial as Ge,PropertyBinding as Ne,SkinnedMesh as He,LineSegments as We,Line as ze,LineLoop as je,Points as Ve,PerspectiveCamera as Xe,MathUtils as qe,OrthographicCamera as $e,Skeleton as Ke,AnimationClip as Ye,Bone as Ze,InterpolateLinear as Je,ColorManagement as Qe,NearestMipmapNearestFilter as et,LinearMipmapNearestFilter as tt,NearestMipmapLinearFilter as nt,ClampToEdgeWrapping as rt,MirroredRepeatWrapping as it,InterpolateDiscrete as st,Texture as ot,VectorKeyframeTrack as at,NumberKeyframeTrack as lt,QuaternionKeyframeTrack as ct,Interpolant as ht,SphereGeometry as dt,UniformsUtils as ut,MeshDepthMaterial as pt,RGBADepthPacking as ft,MeshDistanceMaterial as gt,ShaderChunk as mt,InstancedBufferGeometry as _t,DynamicDrawUsage as yt,PlaneGeometry as vt}from"three";let xt=new class{constructor(){this._tool=null,this._listeners=new Set}getTool(){return this._tool}setTool(r){this._tool=r;for(let x of this._listeners)x(r)}addUpdateListener(r){this._listeners.add(r)}removeUpdateListener(r){this._listeners.delete(r)}};const bt={IDLE:"IDLE",DISABLED:"DISABLED",HOVERED:"HOVERED",SELECTED:"SELECTED"};class Interactable{constructor(r){this._object=r,this._state=bt.IDLE,this.children=new Set,this._hoveredOwners=new Set,this._selectedOwners=new Set,this._capturedOwners=new Set,this._stateCallbacks=new Set,this._hoveredCallbacks=new Set,this._callbacks={},this._callbacksLength=0,this._toolCounts={},this._hoveredCallbackState=!1,this._disabled=!1}addEventListener(r,x,b){b&&(b={...b});let S=b?.tool||"none";r in this._callbacks||(this._callbacks[r]=new Map),this._callbacks[r].has(x)&&this.removeEventListener(r,x),this._callbacks[r].set(x,b),this._callbacksLength++,this._toolCounts[S]||(this._toolCounts[S]=0),this._toolCounts[S]++}copyEventListenersTo(r){for(let x in this._callbacks)for(let[b,S]of this._callbacks[x])r.addEventListener(x,b,S)}removeEventListener(r,x){if(r in this._callbacks&&this._callbacks[r].has(x)){let b=this._callbacks[r].get(x);this._callbacks[r].delete(x),this._callbacksLength--;let S=b?.tool||"none";this._toolCounts[S]--}}dispatchEvent(r,x){if(this._disabled||!(r in this._callbacks))return;let b=xt.getTool();for(let[S,C]of this._callbacks[r]){let r=C?.tool;r&&r!=b||S(x)}}over(r){this.dispatchEvent("over",r)}out(r){this.dispatchEvent("out",r)}down(r){this.dispatchEvent("down",r)}up(r){this.dispatchEvent("up",r)}click(r){this.dispatchEvent("click",r),this._capturedOwners.has(r.owner)&&this._capturedOwners.delete(r.owner)}move(r){this.dispatchEvent("move",r)}drag(r){this.dispatchEvent("drag",r)}capture(r){this._capturedOwners.add(r)}isCapturedBy(r){return this._capturedOwners.has(r)}getCallbacksLength(r){return r?this._toolCounts[r]:this._callbacksLength}supportsTool(){let r=xt.getTool();return this._toolCounts.none||this._toolCounts[r]}isOnlyGroup(){return!this.supportsTool()}addStateCallback(r){this._stateCallbacks.add(r)}addHoveredCallback(r){this._hoveredCallbacks.add(r)}removeStateCallback(r){this._stateCallbacks.delete(r)}removeHoveredCallback(r){this._hoveredCallbacks.delete(r)}_determineAndSetState(){this._selectedOwners.size>0?this.state=bt.SELECTED:this._hoveredOwners.size>0?this.state=bt.HOVERED:this.state=bt.IDLE}_determineHoveredCallbackState(){if(this._disabled||0==this._hoveredCallbacks.size)return;let r=!1;for(let x of this._hoveredOwners)if(!this._selectedOwners.has(x)){r=!0;break}if(r!=this._hoveredCallbackState){this._hoveredCallbackState=r;for(let x of this._hoveredCallbacks)x(r)}}addHoveredBy(r){this._hoveredOwners.has(r)||(this._hoveredOwners.add(r),this._determineHoveredCallbackState(),0==this._selectedOwners.size&&(this.state=bt.HOVERED))}removeHoveredBy(r){this._hoveredOwners.delete(r),this._determineAndSetState(),this._determineHoveredCallbackState()}addSelectedBy(r){this._selectedOwners.add(r),this.state=bt.SELECTED,this._determineHoveredCallbackState()}removeSelectedBy(r){this._selectedOwners.delete(r),this._determineAndSetState(),this._determineHoveredCallbackState()}reset(){this._hoveredOwners.clear(),this._selectedOwners.clear(),this.state=bt.IDLE,this.children.forEach((r=>{r.reset()}))}addChild(r){r.parent!=this&&(r.parent&&r.parent.removeChild(r),this.children.add(r),r.parent=this)}addChildren(r){r.forEach((r=>{this.addChild(r)}))}removeChild(r){this.children.delete(r),r.parent=null}removeChildren(r){r.forEach((r=>{this.removeChild(r)}))}get disabled(){return this._disabled}get object(){return this._object}get state(){return this._state}set disabled(r){r?(this._hoveredCallbackState&&(this._hoveredCallbacks.forEach((r=>r(!1))),this._hoveredCallbackState=!1),this.state=bt.DISABLED,this._disabled=r):(this._disabled=r,this._determineAndSetState(),this._determineHoveredCallbackState())}set object(r){this._object=r}set state(r){if(!this._disabled&&this._state!=r){this._state=r;for(let x of this._stateCallbacks)x(r)}}}class PointerInteractable extends Interactable{constructor(r){super(r),r&&(r.pointerInteractable=this),this._maxDistance=-1/0,this._hoveredCursor="pointer"}addEventListener(r,x,b={}){null==(b={...b}).maxDistance&&(b.maxDistance=1/0),b.maxDistance>this._maxDistance&&(this._maxDistance=b.maxDistance),super.addEventListener(r,x,b)}removeEventListener(r,x){let b=!1;if(r in this._callbacks&&this._callbacks[r].has(x)){this._callbacks[r].get(x).maxDistance==this._maxDistance&&(b=!0)}if(super.removeEventListener(r,x),b){this._maxDistance=-1/0;for(let r in this._callbacks)for(let[x,b]of this._callbacks[r])b.maxDistance>this._maxDistance&&(this._maxDistance=b.maxDistance)}}dispatchEvent(r,x){if(this._disabled||!(r in this._callbacks))return;let b=xt.getTool();for(let[S,C]of this._callbacks[r]){let r=C.tool;r&&r!=b||(null==x?.userDistance||C.maxDistance>=x.userDistance)&&S(x)}}isWithinReach(r){return r<this._maxDistance}get hoveredCursor(){return this._disabled?"not-allowed":this._hoveredCursor}get object(){return this._object}set hoveredCursor(r){this._hoveredCursor=r}set object(r){this._object=r,r&&(r.pointerInteractable=this)}}const Tt=0,wt=1,St=2,Ct=2,It=1.25,kt=1,At=32,Et=At/4,Rt=65535,Mt=Rt<<16,Pt=Math.pow(2,-24),Bt=Symbol("SKIP_GENERATION");function getVertexCount(r){return r.index?r.index.count:r.attributes.position.count}function getTriCount(r){return getVertexCount(r)/3}function getIndexArray(r,x=ArrayBuffer){return r>65535?new Uint32Array(new x(4*r)):new Uint16Array(new x(2*r))}function getFullGeometryRange(r,x){const b=getTriCount(r),S=x||r.drawRange,C=S.start/3,I=(S.start+S.count)/3,A=Math.max(0,C),R=Math.min(b,I)-A;return[{offset:Math.floor(A),count:Math.floor(R)}]}function getRootIndexRanges(r,x){if(!r.groups||!r.groups.length)return getFullGeometryRange(r,x);const b=[],S=x||r.drawRange,C=S.start/3,I=(S.start+S.count)/3,A=getTriCount(r),R=[];for(const x of r.groups){const{start:r,count:b}=x,S=r/3,B=(r+(isFinite(b)?b:3*A-r))/3;S<I&&B>C&&(R.push({pos:Math.max(C,S),isStart:!0}),R.push({pos:Math.min(I,B),isStart:!1}))}R.sort(((r,x)=>r.pos!==x.pos?r.pos-x.pos:"end"===r.type?-1:1));let B=0,D=null;for(const r of R){const x=r.pos;0!==B&&x!==D&&b.push({offset:D,count:x-D}),B+=r.isStart?1:-1,D=x}return b}function getBounds(r,x,b,S,C){let I=1/0,A=1/0,R=1/0,B=-1/0,D=-1/0,F=-1/0,G=1/0,N=1/0,H=1/0,W=-1/0,j=-1/0,V=-1/0;const X=r.offset||0;for(let S=6*(x-X),C=6*(x+b-X);S<C;S+=6){const x=r[S+0],b=r[S+1],C=x-b,X=x+b;C<I&&(I=C),X>B&&(B=X),x<G&&(G=x),x>W&&(W=x);const q=r[S+2],$=r[S+3],K=q-$,Y=q+$;K<A&&(A=K),Y>D&&(D=Y),q<N&&(N=q),q>j&&(j=q);const Z=r[S+4],J=r[S+5],Q=Z-J,ee=Z+J;Q<R&&(R=Q),ee>F&&(F=ee),Z<H&&(H=Z),Z>V&&(V=Z)}S[0]=I,S[1]=A,S[2]=R,S[3]=B,S[4]=D,S[5]=F,C[0]=G,C[1]=N,C[2]=H,C[3]=W,C[4]=j,C[5]=V}function computeTriangleBounds(r,x,b=null,S=null,C=null){const I=r.attributes.position,A=r.index?r.index.array:null,R=I.normalized;if(null===C)(C=new Float32Array(6*b)).offset=x;else if(x<0||b+x>C.length/6)throw new Error("MeshBVH: compute triangle bounds range is invalid.");const B=I.array,D=I.offset||0;let F=3;I.isInterleavedBufferAttribute&&(F=I.data.stride);const G=["getX","getY","getZ"],N=C.offset;for(let r=x,H=x+b;r<H;r++){const x=3*(S?S[r]:r),b=6*(r-N);let H=x+0,W=x+1,j=x+2;A&&(H=A[H],W=A[W],j=A[j]),R||(H=H*F+D,W=W*F+D,j=j*F+D);for(let r=0;r<3;r++){let x,S,A;R?(x=I[G[r]](H),S=I[G[r]](W),A=I[G[r]](j)):(x=B[H+r],S=B[W+r],A=B[j+r]);let D=x;S<D&&(D=S),A<D&&(D=A);let F=x;S>F&&(F=S),A>F&&(F=A);const N=(F-D)/2,V=2*r;C[b+V+0]=D+N,C[b+V+1]=N+(Math.abs(D)+N)*Pt}}return C}function arrayToBox(r,x,b){return b.min.x=x[r],b.min.y=x[r+1],b.min.z=x[r+2],b.max.x=x[r+3],b.max.y=x[r+4],b.max.z=x[r+5],b}function getLongestEdgeIndex(r){let x=-1,b=-1/0;for(let S=0;S<3;S++){const C=r[S+3]-r[S];C>b&&(b=C,x=S)}return x}function copyBounds(r,x){x.set(r)}function unionBounds(r,x,b){let S,C;for(let I=0;I<3;I++){const A=I+3;S=r[I],C=x[I],b[I]=S<C?S:C,S=r[A],C=x[A],b[A]=S>C?S:C}}function expandByTriangleBounds(r,x,b){for(let S=0;S<3;S++){const C=x[r+2*S],I=x[r+2*S+1],A=C-I,R=C+I;A<b[S]&&(b[S]=A),R>b[S+3]&&(b[S+3]=R)}}function computeSurfaceArea(r){const x=r[3]-r[0],b=r[4]-r[1],S=r[5]-r[2];return 2*(x*b+b*S+S*x)}const Lt=32,binsSort=(r,x)=>r.candidate-x.candidate,Ot=new Array(Lt).fill().map((()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0}))),Dt=new Float32Array(6);class MeshBVHNode{constructor(){this.boundingData=new Float32Array(6)}}function partition(r,x,b,S,C,I){let A=S,R=S+C-1;const B=I.pos,D=2*I.axis,F=b.offset||0;for(;;){for(;A<=R&&b[6*(A-F)+D]<B;)A++;for(;A<=R&&b[6*(R-F)+D]>=B;)R--;if(!(A<R))return A;for(let r=0;r<3;r++){let b=x[3*A+r];x[3*A+r]=x[3*R+r],x[3*R+r]=b}for(let r=0;r<6;r++){const x=A-F,S=R-F,C=b[6*x+r];b[6*x+r]=b[6*S+r],b[6*S+r]=C}A++,R--}}function partition_indirect(r,x,b,S,C,I){let A=S,R=S+C-1;const B=I.pos,D=2*I.axis,F=b.offset||0;for(;;){for(;A<=R&&b[6*(A-F)+D]<B;)A++;for(;A<=R&&b[6*(R-F)+D]>=B;)R--;if(!(A<R))return A;{let x=r[A];r[A]=r[R],r[R]=x;for(let r=0;r<6;r++){const x=A-F,S=R-F,C=b[6*x+r];b[6*x+r]=b[6*S+r],b[6*S+r]=C}A++,R--}}}let Ut,Ft,Gt,Nt;const Ht=Math.pow(2,32);function countNodes(r){return"count"in r?1:1+countNodes(r.left)+countNodes(r.right)}function populateBuffer(r,x,b){return Ut=new Float32Array(b),Ft=new Uint32Array(b),Gt=new Uint16Array(b),Nt=new Uint8Array(b),_populateBuffer(r,x)}function _populateBuffer(r,x){const b=r/4,S=r/2,C="count"in x,I=x.boundingData;for(let r=0;r<6;r++)Ut[b+r]=I[r];if(C)return x.buffer?(Nt.set(new Uint8Array(x.buffer),r),r+x.buffer.byteLength):(Ft[b+6]=x.offset,Gt[S+14]=x.count,Gt[S+15]=Rt,r+At);{const{left:S,right:C,splitAxis:I}=x;let A=_populateBuffer(r+At,S);const R=A/At-r/At;if(R>Ht)throw new Error("MeshBVH: Cannot store relative child node offset greater than 32 bits.");return Ft[b+6]=R,Ft[b+7]=I,_populateBuffer(A,C)}}function buildTree(r,x,b,S,C){const{maxDepth:I,verbose:A,maxLeafTris:R,strategy:B,onProgress:D,indirect:F}=C,G=r._indirectBuffer,N=r.geometry,H=N.index?N.index.array:null,W=F?partition_indirect:partition,j=getTriCount(N),V=new Float32Array(6);let X=!1;const q=new MeshBVHNode;return getBounds(x,b,S,q.boundingData,V),function splitNode(r,b,S,C=null,D=0){!X&&D>=I&&(X=!0,A&&(console.warn(`MeshBVH: Max depth of ${I} reached when generating BVH. Consider increasing maxDepth.`),console.warn(N)));if(S<=R||D>=I)return triggerProgress(b+S),r.offset=b,r.count=S,r;const F=function(r,x,b,S,C,I){let A=-1,R=0;if(I===Tt)A=getLongestEdgeIndex(x),-1!==A&&(R=(x[A]+x[A+3])/2);else if(I===wt)A=getLongestEdgeIndex(r),-1!==A&&(R=function(r,x,b,S){let C=0;const I=r.offset;for(let A=x,R=x+b;A<R;A++)C+=r[6*(A-I)+2*S];return C/b}(b,S,C,A));else if(I===St){const I=computeSurfaceArea(r);let B=It*C;const D=b.offset||0,F=6*(S-D),G=6*(S+C-D);for(let r=0;r<3;r++){const S=x[r],D=(x[r+3]-S)/Lt;if(C<Lt/4){const x=[...Ot];x.length=C;let S=0;for(let C=F;C<G;C+=6,S++){const I=x[S];I.candidate=b[C+2*r],I.count=0;const{bounds:A,leftCacheBounds:R,rightCacheBounds:B}=I;for(let r=0;r<3;r++)B[r]=1/0,B[r+3]=-1/0,R[r]=1/0,R[r+3]=-1/0,A[r]=1/0,A[r+3]=-1/0;expandByTriangleBounds(C,b,A)}x.sort(binsSort);let D=C;for(let r=0;r<D;r++){const b=x[r];for(;r+1<D&&x[r+1].candidate===b.candidate;)x.splice(r+1,1),D--}for(let S=F;S<G;S+=6){const C=b[S+2*r];for(let r=0;r<D;r++){const I=x[r];C>=I.candidate?expandByTriangleBounds(S,b,I.rightCacheBounds):(expandByTriangleBounds(S,b,I.leftCacheBounds),I.count++)}}for(let b=0;b<D;b++){const S=x[b],D=S.count,F=C-S.count,G=S.leftCacheBounds,N=S.rightCacheBounds;let H=0;0!==D&&(H=computeSurfaceArea(G)/I);let W=0;0!==F&&(W=computeSurfaceArea(N)/I);const j=kt+It*(H*D+W*F);j<B&&(A=r,B=j,R=S.candidate)}}else{for(let r=0;r<Lt;r++){const x=Ot[r];x.count=0,x.candidate=S+D+r*D;const b=x.bounds;for(let r=0;r<3;r++)b[r]=1/0,b[r+3]=-1/0}for(let x=F;x<G;x+=6){let C=~~((b[x+2*r]-S)/D);C>=Lt&&(C=Lt-1);const I=Ot[C];I.count++,expandByTriangleBounds(x,b,I.bounds)}const x=Ot[Lt-1];copyBounds(x.bounds,x.rightCacheBounds);for(let r=Lt-2;r>=0;r--){const x=Ot[r],b=Ot[r+1];unionBounds(x.bounds,b.rightCacheBounds,x.rightCacheBounds)}let N=0;for(let x=0;x<Lt-1;x++){const b=Ot[x],S=b.count,D=b.bounds,F=Ot[x+1].rightCacheBounds;0!==S&&(0===N?copyBounds(D,Dt):unionBounds(D,Dt,Dt)),N+=S;let G=0,H=0;0!==N&&(G=computeSurfaceArea(Dt)/I);const W=C-N;0!==W&&(H=computeSurfaceArea(F)/I);const j=kt+It*(G*N+H*W);j<B&&(A=r,B=j,R=b.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${I} used.`);return{axis:A,pos:R}}(r.boundingData,C,x,b,S,B);if(-1===F.axis)return triggerProgress(b+S),r.offset=b,r.count=S,r;const j=W(G,H,x,b,S,F);if(j===b||j===b+S)triggerProgress(b+S),r.offset=b,r.count=S;else{r.splitAxis=F.axis;const C=new MeshBVHNode,I=b,A=j-b;r.left=C,getBounds(x,I,A,C.boundingData,V),splitNode(C,I,A,V,D+1);const R=new MeshBVHNode,B=j,G=S-A;r.right=R,getBounds(x,B,G,R.boundingData,V),splitNode(R,B,G,V,D+1)}return r}(q,b,S,V),q;function triggerProgress(r){D&&D(r/j)}}function buildPackedTree(r,x){const b=x.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,S=r.geometry;let C,I;if(x.indirect){const b=getRootIndexRanges(S,x.range),A=function(r,x,b){const S=(r.index?r.index.count:r.attributes.position.count)/3>65536,C=b.reduce(((r,x)=>r+x.count),0),I=S?4:2,A=x?new SharedArrayBuffer(C*I):new ArrayBuffer(C*I),R=S?new Uint32Array(A):new Uint16Array(A);let B=0;for(let r=0;r<b.length;r++){const{offset:x,count:S}=b[r];for(let r=0;r<S;r++)R[B+r]=x+r;B+=S}return R}(S,x.useSharedArrayBuffer,b);r._indirectBuffer=A,C=computeTriangleBounds(S,0,A.length,A),I=[{offset:0,count:A.length}]}else{!function(r,x){if(!r.index){const b=r.attributes.position.count,S=getIndexArray(b,x.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer);r.setIndex(new D(S,1));for(let r=0;r<b;r++)S[r]=r}}(S,x);const r=getFullGeometryRange(S,x.range)[0];C=computeTriangleBounds(S,r.offset,r.count),I=getRootIndexRanges(S,x.range)}r._roots=I.map((S=>{const I=buildTree(r,C,S.offset,S.count,x),A=countNodes(I),R=new b(At*A);return populateBuffer(0,I,R),R}))}class SeparatingAxisBounds{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(r,x){let b=1/0,S=-1/0;for(let C=0,I=r.length;C<I;C++){const I=r[C][x];b=I<b?I:b,S=I>S?I:S}this.min=b,this.max=S}setFromPoints(r,x){let b=1/0,S=-1/0;for(let C=0,I=x.length;C<I;C++){const I=x[C],A=r.dot(I);b=A<b?A:b,S=A>S?A:S}this.min=b,this.max=S}isSeparated(r){return this.min>r.max||r.min>this.max}}SeparatingAxisBounds.prototype.setFromBox=function(){const r=new x;return function(x,b){const S=b.min,C=b.max;let I=1/0,A=-1/0;for(let b=0;b<=1;b++)for(let R=0;R<=1;R++)for(let B=0;B<=1;B++){r.x=S.x*b+C.x*(1-b),r.y=S.y*R+C.y*(1-R),r.z=S.z*B+C.z*(1-B);const D=x.dot(r);I=Math.min(D,I),A=Math.max(D,A)}this.min=I,this.max=A}}();const Wt=function(){const r=new x,b=new x,S=new x;return function(x,C,I){const A=x.start,R=r,B=C.start,D=b;S.subVectors(A,B),r.subVectors(x.end,x.start),b.subVectors(C.end,C.start);const F=S.dot(D),G=D.dot(R),N=D.dot(D),H=S.dot(R),W=R.dot(R)*N-G*G;let j,V;j=0!==W?(F*G-H*N)/W:0,V=(F+j*G)/N,I.x=j,I.y=V}}(),zt=function(){const r=new R,b=new x,S=new x;return function(x,C,I,A){Wt(x,C,r);let R=r.x,B=r.y;if(R>=0&&R<=1&&B>=0&&B<=1)return x.at(R,I),void C.at(B,A);if(R>=0&&R<=1)return B<0?C.at(0,A):C.at(1,A),void x.closestPointToPoint(A,!0,I);if(B>=0&&B<=1)return R<0?x.at(0,I):x.at(1,I),void C.closestPointToPoint(I,!0,A);{let r,D;r=R<0?x.start:x.end,D=B<0?C.start:C.end;const F=b,G=S;return x.closestPointToPoint(D,!0,b),C.closestPointToPoint(r,!0,S),F.distanceToSquared(D)<=G.distanceToSquared(r)?(I.copy(F),void A.copy(D)):(I.copy(r),void A.copy(G))}}}(),jt=function(){const r=new x,b=new x,S=new I,C=new A;return function(x,I){const{radius:A,center:R}=x,{a:B,b:D,c:F}=I;C.start=B,C.end=D;if(C.closestPointToPoint(R,!0,r).distanceTo(R)<=A)return!0;C.start=B,C.end=F;if(C.closestPointToPoint(R,!0,r).distanceTo(R)<=A)return!0;C.start=D,C.end=F;if(C.closestPointToPoint(R,!0,r).distanceTo(R)<=A)return!0;const G=I.getPlane(S);if(Math.abs(G.distanceToPoint(R))<=A){const r=G.projectPoint(R,b);if(I.containsPoint(r))return!0}return!1}}(),Vt=["x","y","z"],Xt=1e-15;function isNearZero(r){return Math.abs(r)<Xt}class ExtendedTriangle extends C{constructor(...r){super(...r),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map((()=>new x)),this.satBounds=new Array(4).fill().map((()=>new SeparatingAxisBounds)),this.points=[this.a,this.b,this.c],this.plane=new I,this.isDegenerateIntoSegment=!1,this.isDegenerateIntoPoint=!1,this.degenerateSegment=new A,this.needsUpdate=!0}intersectsSphere(r){return jt(r,this)}update(){const r=this.a,x=this.b,b=this.c,S=this.points,C=this.satAxes,I=this.satBounds,A=C[0],R=I[0];this.getNormal(A),R.setFromPoints(A,S);const B=C[1],D=I[1];B.subVectors(r,x),D.setFromPoints(B,S);const F=C[2],G=I[2];F.subVectors(x,b),G.setFromPoints(F,S);const N=C[3],H=I[3];N.subVectors(b,r),H.setFromPoints(N,S);const W=B.length(),j=F.length(),V=N.length();this.isDegenerateIntoPoint=!1,this.isDegenerateIntoSegment=!1,W<Xt?j<Xt||V<Xt?this.isDegenerateIntoPoint=!0:(this.isDegenerateIntoSegment=!0,this.degenerateSegment.start.copy(r),this.degenerateSegment.end.copy(b)):j<Xt?V<Xt?this.isDegenerateIntoPoint=!0:(this.isDegenerateIntoSegment=!0,this.degenerateSegment.start.copy(x),this.degenerateSegment.end.copy(r)):V<Xt&&(this.isDegenerateIntoSegment=!0,this.degenerateSegment.start.copy(b),this.degenerateSegment.end.copy(x)),this.plane.setFromNormalAndCoplanarPoint(A,r),this.needsUpdate=!1}}ExtendedTriangle.prototype.closestPointToSegment=function(){const r=new x,b=new x,S=new A;return function(x,C=null,I=null){const{start:A,end:R}=x,B=this.points;let D,F=1/0;for(let A=0;A<3;A++){const R=(A+1)%3;S.start.copy(B[A]),S.end.copy(B[R]),zt(S,x,r,b),D=r.distanceToSquared(b),D<F&&(F=D,C&&C.copy(r),I&&I.copy(b))}return this.closestPointToPoint(A,r),D=A.distanceToSquared(r),D<F&&(F=D,C&&C.copy(r),I&&I.copy(A)),this.closestPointToPoint(R,r),D=R.distanceToSquared(r),D<F&&(F=D,C&&C.copy(r),I&&I.copy(R)),Math.sqrt(F)}}(),ExtendedTriangle.prototype.intersectsTriangle=function(){const r=new ExtendedTriangle,b=new SeparatingAxisBounds,S=new SeparatingAxisBounds,C=new x,I=new x,B=new x,D=new x,F=new A,G=new A,N=new x,H=new R,W=new R;function coplanarIntersectsTriangle(r,x,I,A){const R=C;r.isDegenerateIntoPoint||r.isDegenerateIntoSegment?R.copy(x.plane.normal):R.copy(r.plane.normal);const B=r.satBounds,F=r.satAxes;for(let C=1;C<4;C++){const I=B[C],A=F[C];if(b.setFromPoints(A,x.points),I.isSeparated(b))return!1;if(D.copy(R).cross(A),b.setFromPoints(D,r.points),S.setFromPoints(D,x.points),b.isSeparated(S))return!1}const G=x.satBounds,N=x.satAxes;for(let C=1;C<4;C++){const I=G[C],A=N[C];if(b.setFromPoints(A,r.points),I.isSeparated(b))return!1;if(D.crossVectors(R,A),b.setFromPoints(D,r.points),S.setFromPoints(D,x.points),b.isSeparated(S))return!1}return I&&(A||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),I.start.set(0,0,0),I.end.set(0,0,0)),!0}function findSingleBounds(r,x,b,S,C,I,A,R,B,D,F){let G=A/(A-R);D.x=S+(C-S)*G,F.start.subVectors(x,r).multiplyScalar(G).add(r),G=A/(A-B),D.y=S+(I-S)*G,F.end.subVectors(b,r).multiplyScalar(G).add(r)}function findIntersectionLineBounds(r,x,b,S,C,I,A,R,B,D,F){if(C>0)findSingleBounds(r.c,r.a,r.b,S,x,b,B,A,R,D,F);else if(I>0)findSingleBounds(r.b,r.a,r.c,b,x,S,R,A,B,D,F);else if(R*B>0||0!=A)findSingleBounds(r.a,r.b,r.c,x,b,S,A,R,B,D,F);else if(0!=R)findSingleBounds(r.b,r.a,r.c,b,x,S,R,A,B,D,F);else{if(0==B)return!0;findSingleBounds(r.c,r.a,r.b,S,x,b,B,A,R,D,F)}return!1}function intersectTriangleSegment(r,x,b,S){const I=x.degenerateSegment,A=r.plane.distanceToPoint(I.start),R=r.plane.distanceToPoint(I.end);return isNearZero(A)?isNearZero(R)?coplanarIntersectsTriangle(r,x,b,S):(b&&(b.start.copy(I.start),b.end.copy(I.start)),r.containsPoint(I.start)):isNearZero(R)?(b&&(b.start.copy(I.end),b.end.copy(I.end)),r.containsPoint(I.end)):null!=r.plane.intersectLine(I,C)&&(b&&(b.start.copy(C),b.end.copy(C)),r.containsPoint(C))}function intersectTrianglePoint(r,x,b){const S=x.a;return!(!isNearZero(r.plane.distanceToPoint(S))||!r.containsPoint(S))&&(b&&(b.start.copy(S),b.end.copy(S)),!0)}function intersectSegmentPoint(r,x,b){const S=r.degenerateSegment,I=x.a;return S.closestPointToPoint(I,!0,C),I.distanceToSquared(C)<1e-30&&(b&&(b.start.copy(I),b.end.copy(I)),!0)}return function(x,b=null,S=!1){this.needsUpdate&&this.update(),x.isExtendedTriangle?x.needsUpdate&&x.update():(r.copy(x),r.update(),x=r);const A=function(r,x,b,S){if(r.isDegenerateIntoSegment){if(x.isDegenerateIntoSegment){const S=r.degenerateSegment,A=x.degenerateSegment,R=I,D=B;S.delta(R),A.delta(D);const F=C.subVectors(A.start,S.start),G=R.x*D.y-R.y*D.x;if(isNearZero(G))return!1;const N=(F.x*D.y-F.y*D.x)/G,H=-(R.x*F.y-R.y*F.x)/G;return!(N<0||N>1||H<0||H>1)&&(!!isNearZero(S.start.z+R.z*N-(A.start.z+D.z*H))&&(b&&(b.start.copy(S.start).addScaledVector(R,N),b.end.copy(S.start).addScaledVector(R,N)),!0))}return x.isDegenerateIntoPoint?intersectSegmentPoint(r,x,b):intersectTriangleSegment(x,r,b,S)}return r.isDegenerateIntoPoint?x.isDegenerateIntoPoint?x.a.distanceToSquared(r.a)<1e-30&&(b&&(b.start.copy(r.a),b.end.copy(r.a)),!0):x.isDegenerateIntoSegment?intersectSegmentPoint(x,r,b):intersectTrianglePoint(x,r,b):x.isDegenerateIntoPoint?intersectTrianglePoint(r,x,b):x.isDegenerateIntoSegment?intersectTriangleSegment(r,x,b,S):void 0}(this,x,b,S);if(void 0!==A)return A;const R=this.plane,D=x.plane;let j=D.distanceToPoint(this.a),V=D.distanceToPoint(this.b),X=D.distanceToPoint(this.c);isNearZero(j)&&(j=0),isNearZero(V)&&(V=0),isNearZero(X)&&(X=0);const q=j*V,$=j*X;if(q>0&&$>0)return!1;let K=R.distanceToPoint(x.a),Y=R.distanceToPoint(x.b),Z=R.distanceToPoint(x.c);isNearZero(K)&&(K=0),isNearZero(Y)&&(Y=0),isNearZero(Z)&&(Z=0);const J=K*Y,Q=K*Z;if(J>0&&Q>0)return!1;I.copy(R.normal),B.copy(D.normal);const ee=I.cross(B);let te=0,ne=Math.abs(ee.x);const re=Math.abs(ee.y);re>ne&&(ne=re,te=1);Math.abs(ee.z)>ne&&(te=2);const ie=Vt[te],se=this.a[ie],oe=this.b[ie],ae=this.c[ie],le=x.a[ie],ce=x.b[ie],he=x.c[ie];if(findIntersectionLineBounds(this,se,oe,ae,q,$,j,V,X,H,F))return coplanarIntersectsTriangle(this,x,b,S);if(findIntersectionLineBounds(x,le,ce,he,J,Q,K,Y,Z,W,G))return coplanarIntersectsTriangle(this,x,b,S);if(H.y<H.x){const r=H.y;H.y=H.x,H.x=r,N.copy(F.start),F.start.copy(F.end),F.end.copy(N)}if(W.y<W.x){const r=W.y;W.y=W.x,W.x=r,N.copy(G.start),G.start.copy(G.end),G.end.copy(N)}return!(H.y<W.x||W.y<H.x)&&(b&&(W.x>H.x?b.start.copy(G.start):b.start.copy(F.start),W.y<H.y?b.end.copy(G.end):b.end.copy(F.end)),!0)}}(),ExtendedTriangle.prototype.distanceToPoint=function(){const r=new x;return function(x){return this.closestPointToPoint(x,r),x.distanceTo(r)}}(),ExtendedTriangle.prototype.distanceToTriangle=function(){const r=new x,b=new x,S=["a","b","c"],C=new A,I=new A;return function(x,A=null,R=null){const B=A||R?C:null;if(this.intersectsTriangle(x,B))return(A||R)&&(A&&B.getCenter(A),R&&B.getCenter(R)),0;let D=1/0;for(let b=0;b<3;b++){let C;const I=S[b],B=x[I];this.closestPointToPoint(B,r),C=B.distanceToSquared(r),C<D&&(D=C,A&&A.copy(r),R&&R.copy(B));const F=this[I];x.closestPointToPoint(F,r),C=F.distanceToSquared(r),C<D&&(D=C,A&&A.copy(F),R&&R.copy(r))}for(let B=0;B<3;B++){const F=S[B],G=S[(B+1)%3];C.set(this[F],this[G]);for(let B=0;B<3;B++){const F=S[B],G=S[(B+1)%3];I.set(x[F],x[G]),zt(C,I,r,b);const N=r.distanceToSquared(b);N<D&&(D=N,A&&A.copy(r),R&&R.copy(b))}}return Math.sqrt(D)}}();class OrientedBox{constructor(r,b,S){this.isOrientedBox=!0,this.min=new x,this.max=new x,this.matrix=new B,this.invMatrix=new B,this.points=new Array(8).fill().map((()=>new x)),this.satAxes=new Array(3).fill().map((()=>new x)),this.satBounds=new Array(3).fill().map((()=>new SeparatingAxisBounds)),this.alignedSatBounds=new Array(3).fill().map((()=>new SeparatingAxisBounds)),this.needsUpdate=!1,r&&this.min.copy(r),b&&this.max.copy(b),S&&this.matrix.copy(S)}set(r,x,b){this.min.copy(r),this.max.copy(x),this.matrix.copy(b),this.needsUpdate=!0}copy(r){this.min.copy(r.min),this.max.copy(r.max),this.matrix.copy(r.matrix),this.needsUpdate=!0}}OrientedBox.prototype.update=function(){const r=this.matrix,x=this.min,b=this.max,S=this.points;for(let C=0;C<=1;C++)for(let I=0;I<=1;I++)for(let A=0;A<=1;A++){const R=S[1*C|2*I|4*A];R.x=C?b.x:x.x,R.y=I?b.y:x.y,R.z=A?b.z:x.z,R.applyMatrix4(r)}const C=this.satBounds,I=this.satAxes,A=S[0];for(let r=0;r<3;r++){const x=I[r],b=C[r],R=S[1<<r];x.subVectors(A,R),b.setFromPoints(x,S)}const R=this.alignedSatBounds;R[0].setFromPointsField(S,"x"),R[1].setFromPointsField(S,"y"),R[2].setFromPointsField(S,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1},OrientedBox.prototype.intersectsBox=function(){const r=new SeparatingAxisBounds;return function(x){this.needsUpdate&&this.update();const b=x.min,S=x.max,C=this.satBounds,I=this.satAxes,A=this.alignedSatBounds;if(r.min=b.x,r.max=S.x,A[0].isSeparated(r))return!1;if(r.min=b.y,r.max=S.y,A[1].isSeparated(r))return!1;if(r.min=b.z,r.max=S.z,A[2].isSeparated(r))return!1;for(let b=0;b<3;b++){const S=I[b],A=C[b];if(r.setFromBox(S,x),A.isSeparated(r))return!1}return!0}}(),OrientedBox.prototype.intersectsTriangle=function(){const r=new ExtendedTriangle,b=new Array(3),S=new SeparatingAxisBounds,C=new SeparatingAxisBounds,I=new x;return function(x){this.needsUpdate&&this.update(),x.isExtendedTriangle?x.needsUpdate&&x.update():(r.copy(x),r.update(),x=r);const A=this.satBounds,R=this.satAxes;b[0]=x.a,b[1]=x.b,b[2]=x.c;for(let r=0;r<3;r++){const x=A[r],C=R[r];if(S.setFromPoints(C,b),x.isSeparated(S))return!1}const B=x.satBounds,D=x.satAxes,F=this.points;for(let r=0;r<3;r++){const x=B[r],b=D[r];if(S.setFromPoints(b,F),x.isSeparated(S))return!1}for(let r=0;r<3;r++){const x=R[r];for(let r=0;r<4;r++){const A=D[r];if(I.crossVectors(x,A),S.setFromPoints(I,b),C.setFromPoints(I,F),S.isSeparated(C))return!1}}return!0}}(),OrientedBox.prototype.closestPointToPoint=function(r,x){return this.needsUpdate&&this.update(),x.copy(r).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),x},OrientedBox.prototype.distanceToPoint=function(){const r=new x;return function(x){return this.closestPointToPoint(x,r),x.distanceTo(r)}}(),OrientedBox.prototype.distanceToBox=function(){const r=["x","y","z"],b=new Array(12).fill().map((()=>new A)),S=new Array(12).fill().map((()=>new A)),C=new x,I=new x;return function(x,A=0,R=null,B=null){if(this.needsUpdate&&this.update(),this.intersectsBox(x))return(R||B)&&(x.getCenter(I),this.closestPointToPoint(I,C),x.closestPointToPoint(C,I),R&&R.copy(C),B&&B.copy(I)),0;const D=A*A,F=x.min,G=x.max,N=this.points;let H=1/0;for(let r=0;r<8;r++){const x=N[r];I.copy(x).clamp(F,G);const b=x.distanceToSquared(I);if(b<H&&(H=b,R&&R.copy(x),B&&B.copy(I),b<D))return Math.sqrt(b)}let W=0;for(let x=0;x<3;x++)for(let C=0;C<=1;C++)for(let I=0;I<=1;I++){const A=(x+1)%3,R=(x+2)%3,B=1<<x|C<<A|I<<R,D=N[C<<A|I<<R],H=N[B];b[W].set(D,H);const j=r[x],V=r[A],X=r[R],q=S[W],$=q.start,K=q.end;$[j]=F[j],$[V]=C?F[V]:G[V],$[X]=I?F[X]:G[V],K[j]=G[j],K[V]=C?F[V]:G[V],K[X]=I?F[X]:G[V],W++}for(let r=0;r<=1;r++)for(let x=0;x<=1;x++)for(let b=0;b<=1;b++){I.x=r?G.x:F.x,I.y=x?G.y:F.y,I.z=b?G.z:F.z,this.closestPointToPoint(I,C);const S=I.distanceToSquared(C);if(S<H&&(H=S,R&&R.copy(C),B&&B.copy(I),S<D))return Math.sqrt(S)}for(let r=0;r<12;r++){const x=b[r];for(let r=0;r<12;r++){const b=S[r];zt(x,b,C,I);const A=C.distanceToSquared(I);if(A<H&&(H=A,R&&R.copy(C),B&&B.copy(I),A<D))return Math.sqrt(A)}}return Math.sqrt(H)}}();class PrimitivePool{constructor(r){this._getNewPrimitive=r,this._primitives=[]}getPrimitive(){const r=this._primitives;return 0===r.length?this._getNewPrimitive():r.pop()}releasePrimitive(r){this._primitives.push(r)}}class ExtendedTrianglePoolBase extends PrimitivePool{constructor(){super((()=>new ExtendedTriangle))}}const qt=new ExtendedTrianglePoolBase;function IS_LEAF(r,x){return x[r+15]===Rt}function OFFSET(r,x){return x[r+6]}function COUNT(r,x){return x[r+14]}function LEFT_NODE(r){return r+Et}function RIGHT_NODE(r,x){return r+x[r+6]*Et}function SPLIT_AXIS(r,x){return x[r+7]}class _BufferStack{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const r=[];let x=null;this.setBuffer=b=>{x&&r.push(x),x=b,this.float32Array=new Float32Array(b),this.uint16Array=new Uint16Array(b),this.uint32Array=new Uint32Array(b)},this.clearBuffer=()=>{x=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,0!==r.length&&this.setBuffer(r.pop())}}}const $t=new _BufferStack;let Kt,Yt;const Zt=[],Jt=new PrimitivePool((()=>new F));function shapecast(r,x,b,S,C,I){Kt=Jt.getPrimitive(),Yt=Jt.getPrimitive(),Zt.push(Kt,Yt),$t.setBuffer(r._roots[x]);const A=shapecastTraverse(0,r.geometry,b,S,C,I);$t.clearBuffer(),Jt.releasePrimitive(Kt),Jt.releasePrimitive(Yt),Zt.pop(),Zt.pop();const R=Zt.length;return R>0&&(Yt=Zt[R-1],Kt=Zt[R-2]),A}function shapecastTraverse(r,x,b,S,C=null,I=0,A=0){const{float32Array:R,uint16Array:B,uint32Array:D}=$t;let F=2*r;if(IS_LEAF(F,B)){const G=OFFSET(r,D),N=COUNT(F,B);return arrayToBox(r,R,Kt),S(G,N,!1,A,I+r/Et,Kt)}{const H=LEFT_NODE(r),W=RIGHT_NODE(r,D);let j,V,X,q,$=H,K=W;if(C&&(X=Kt,q=Yt,arrayToBox($,R,X),arrayToBox(K,R,q),j=C(X),V=C(q),V<j)){$=W,K=H;const ee=j;j=V,V=ee,X=q}X||(X=Kt,arrayToBox($,R,X));const Y=b(X,IS_LEAF(2*$,B),j,A+1,I+$/Et);let Z;if(Y===Ct){const te=getLeftOffset($);Z=S(te,getRightEndOffset($)-te,!0,A+1,I+$/Et,X)}else Z=Y&&shapecastTraverse($,x,b,S,C,I,A+1);if(Z)return!0;q=Yt,arrayToBox(K,R,q);const J=b(q,IS_LEAF(2*K,B),V,A+1,I+K/Et);let Q;if(J===Ct){const ne=getLeftOffset(K);Q=S(ne,getRightEndOffset(K)-ne,!0,A+1,I+K/Et,q)}else Q=J&&shapecastTraverse(K,x,b,S,C,I,A+1);return!!Q;function getLeftOffset(r){const{uint16Array:x,uint32Array:b}=$t;let S=2*r;for(;!IS_LEAF(S,x);)S=2*(r=LEFT_NODE(r));return OFFSET(r,b)}function getRightEndOffset(r){const{uint16Array:x,uint32Array:b}=$t;let S=2*r;for(;!IS_LEAF(S,x);)S=2*(r=RIGHT_NODE(r,b));return OFFSET(r,b)+COUNT(S,x)}}}const Qt=new x,en=new x;const tn=parseInt(te)>=169,nn=parseInt(te)<=161,rn=new x,sn=new x,on=new x,an=new R,ln=new R,cn=new R,hn=new x,dn=new x,un=new x,pn=new x;function checkBufferGeometryIntersection(r,b,S,I,A,B,D,F,G,N,H){rn.fromBufferAttribute(b,B),sn.fromBufferAttribute(b,D),on.fromBufferAttribute(b,F);const W=function(r,x,b,S,C,I,A,R){let B;if(B=I===ue?r.intersectTriangle(S,b,x,!0,C):r.intersectTriangle(x,b,S,I!==pe,C),null===B)return null;const D=r.origin.distanceTo(C);return D<A||D>R?null:{distance:D,point:C.clone()}}(r,rn,sn,on,pn,G,N,H);if(W){if(I){an.fromBufferAttribute(I,B),ln.fromBufferAttribute(I,D),cn.fromBufferAttribute(I,F),W.uv=new R;const r=C.getInterpolation(pn,rn,sn,on,an,ln,cn,W.uv);tn||(W.uv=r)}if(A){an.fromBufferAttribute(A,B),ln.fromBufferAttribute(A,D),cn.fromBufferAttribute(A,F),W.uv1=new R;const r=C.getInterpolation(pn,rn,sn,on,an,ln,cn,W.uv1);tn||(W.uv1=r),nn&&(W.uv2=W.uv1)}if(S){hn.fromBufferAttribute(S,B),dn.fromBufferAttribute(S,D),un.fromBufferAttribute(S,F),W.normal=new x;const b=C.getInterpolation(pn,rn,sn,on,hn,dn,un,W.normal);W.normal.dot(r.direction)>0&&W.normal.multiplyScalar(-1),tn||(W.normal=b)}const b={a:B,b:D,c:F,normal:new x,materialIndex:0};if(C.getNormal(rn,sn,on,b.normal),W.face=b,W.faceIndex=B,tn){const r=new x;C.getBarycoord(pn,rn,sn,on,r),W.barycoord=r}}return W}function getSide(r){return r&&r.isMaterial?r.side:r}function intersectTri(r,x,b,S,C,I,A){const R=3*S;let B=R+0,D=R+1,F=R+2;const{index:G,groups:N}=r;r.index&&(B=G.getX(B),D=G.getX(D),F=G.getX(F));const{position:H,normal:W,uv:j,uv1:V}=r.attributes;if(Array.isArray(x)){const r=3*S;for(let R=0,G=N.length;R<G;R++){const{start:G,count:X,materialIndex:q}=N[R];if(r>=G&&r<G+X){const r=checkBufferGeometryIntersection(b,H,W,j,V,B,D,F,getSide(x[q]),I,A);if(r){if(r.faceIndex=S,r.face.materialIndex=q,!C)return r;C.push(r)}}}}else{const r=checkBufferGeometryIntersection(b,H,W,j,V,B,D,F,getSide(x),I,A);if(r){if(r.faceIndex=S,r.face.materialIndex=0,!C)return r;C.push(r)}}return null}function setTriangle(r,x,b,S){const C=r.a,I=r.b,A=r.c;let R=x,B=x+1,D=x+2;b&&(R=b.getX(R),B=b.getX(B),D=b.getX(D)),C.x=S.getX(R),C.y=S.getY(R),C.z=S.getZ(R),I.x=S.getX(B),I.y=S.getY(B),I.z=S.getZ(B),A.x=S.getX(D),A.y=S.getY(D),A.z=S.getZ(D)}const fn=new x,gn=new x,mn=new x,_n=new R,yn=new R,vn=new R;function iterateOverTriangles(r,x,b,S,C,I,A){const{geometry:R}=b,{index:B}=R,D=R.attributes.position;for(let b=r,R=x+r;b<R;b++){let r;if(r=b,setTriangle(A,3*r,B,D),A.needsUpdate=!0,S(A,r,C,I))return!0}return!1}function refit(r,x=null){x&&Array.isArray(x)&&(x=new Set(x));const b=r.geometry,S=b.index?b.index.array:null,C=b.attributes.position;let I,A,R,B,D=0;const F=r._roots;for(let r=0,x=F.length;r<x;r++)I=F[r],A=new Uint32Array(I),R=new Uint16Array(I),B=new Float32Array(I),_traverse(0,D),D+=I.byteLength;function _traverse(r,b,I=!1){const D=2*r;if(IS_LEAF(D,R)){const x=A[r+6];let b=1/0,I=1/0,F=1/0,G=-1/0,N=-1/0,H=-1/0;for(let r=3*x,A=3*(x+R[D+14]);r<A;r++){let x=S[r];const A=C.getX(x),R=C.getY(x),B=C.getZ(x);A<b&&(b=A),A>G&&(G=A),R<I&&(I=R),R>N&&(N=R),B<F&&(F=B),B>H&&(H=B)}return(B[r+0]!==b||B[r+1]!==I||B[r+2]!==F||B[r+3]!==G||B[r+4]!==N||B[r+5]!==H)&&(B[r+0]=b,B[r+1]=I,B[r+2]=F,B[r+3]=G,B[r+4]=N,B[r+5]=H,!0)}{const S=LEFT_NODE(r),C=RIGHT_NODE(r,A);let R=I,D=!1,F=!1;if(x){if(!R){const r=S/Et+b/At,I=C/Et+b/At;D=x.has(r),F=x.has(I),R=!D&&!F}}else D=!0,F=!0;const G=R||F;let N=!1;(R||D)&&(N=_traverse(S,b,R));let H=!1;G&&(H=_traverse(C,b,R));const W=N||H;if(W)for(let x=0;x<3;x++){const b=S+x,I=C+x,A=B[b],R=B[b+3],D=B[I],F=B[I+3];B[r+x]=A<D?A:D,B[r+x+3]=R>F?R:F}return W}}}function intersectRay(r,x,b,S,C){let I,A,R,B,D,F;const G=1/b.direction.x,N=1/b.direction.y,H=1/b.direction.z,W=b.origin.x,j=b.origin.y,V=b.origin.z;let X=x[r],q=x[r+3],$=x[r+1],K=x[r+3+1],Y=x[r+2],Z=x[r+3+2];return G>=0?(I=(X-W)*G,A=(q-W)*G):(I=(q-W)*G,A=(X-W)*G),N>=0?(R=($-j)*N,B=(K-j)*N):(R=(K-j)*N,B=($-j)*N),!(I>B||R>A)&&((R>I||isNaN(I))&&(I=R),(B<A||isNaN(A))&&(A=B),H>=0?(D=(Y-V)*H,F=(Z-V)*H):(D=(Z-V)*H,F=(Y-V)*H),!(I>F||D>A)&&((D>I||I!=I)&&(I=D),(F<A||A!=A)&&(A=F),I<=C&&A>=S))}function iterateOverTriangles_indirect(r,x,b,S,C,I,A){const{geometry:R}=b,{index:B}=R,D=R.attributes.position;for(let R=r,F=x+r;R<F;R++){let r;if(r=b.resolveTriangleIndex(R),setTriangle(A,3*r,B,D),A.needsUpdate=!0,S(A,r,C,I))return!0}return!1}function raycast(r,x,b,S,C,I,A){$t.setBuffer(r._roots[x]),_raycast$1(0,r,b,S,C,I,A),$t.clearBuffer()}function _raycast$1(r,x,b,S,C,I,A){const{float32Array:R,uint16Array:B,uint32Array:D}=$t,F=2*r;if(IS_LEAF(F,B)){!function(r,x,b,S,C,I,A,R){const{geometry:B,_indirectBuffer:D}=r;for(let r=S,D=S+C;r<D;r++)intersectTri(B,x,b,r,I,A,R)}(x,b,S,OFFSET(r,D),COUNT(F,B),C,I,A)}else{const B=LEFT_NODE(r);intersectRay(B,R,S,I,A)&&_raycast$1(B,x,b,S,C,I,A);const F=RIGHT_NODE(r,D);intersectRay(F,R,S,I,A)&&_raycast$1(F,x,b,S,C,I,A)}}const xn=["x","y","z"];function raycastFirst(r,x,b,S,C,I){$t.setBuffer(r._roots[x]);const A=_raycastFirst$1(0,r,b,S,C,I);return $t.clearBuffer(),A}function _raycastFirst$1(r,x,b,S,C,I){const{float32Array:A,uint16Array:R,uint32Array:B}=$t;let D=2*r;if(IS_LEAF(D,R)){return function(r,x,b,S,C,I,A){const{geometry:R,_indirectBuffer:B}=r;let D=1/0,F=null;for(let r=S,B=S+C;r<B;r++){let S;S=intersectTri(R,x,b,r,null,I,A),S&&S.distance<D&&(F=S,D=S.distance)}return F}(x,b,S,OFFSET(r,B),COUNT(D,R),C,I)}{const R=SPLIT_AXIS(r,B),D=xn[R],F=S.direction[D]>=0;let G,N;F?(G=LEFT_NODE(r),N=RIGHT_NODE(r,B)):(G=RIGHT_NODE(r,B),N=LEFT_NODE(r));const H=intersectRay(G,A,S,C,I)?_raycastFirst$1(G,x,b,S,C,I):null;if(H){const r=H.point[D];if(F?r<=A[N+R]:r>=A[N+R+3])return H}const W=intersectRay(N,A,S,C,I)?_raycastFirst$1(N,x,b,S,C,I):null;return H&&W?H.distance<=W.distance?H:W:H||W||null}}const bn=new F,Tn=new ExtendedTriangle,wn=new ExtendedTriangle,Sn=new B,Cn=new OrientedBox,In=new OrientedBox;function intersectsGeometry(r,x,b,S){$t.setBuffer(r._roots[x]);const C=_intersectsGeometry$1(0,r,b,S);return $t.clearBuffer(),C}function _intersectsGeometry$1(r,x,b,S,C=null){const{float32Array:I,uint16Array:A,uint32Array:R}=$t;let B=2*r;null===C&&(b.boundingBox||b.computeBoundingBox(),Cn.set(b.boundingBox.min,b.boundingBox.max,S),C=Cn);if(!IS_LEAF(B,A)){const A=LEFT_NODE(r),B=RIGHT_NODE(r,R);arrayToBox(A,I,bn);if(C.intersectsBox(bn)&&_intersectsGeometry$1(A,x,b,S,C))return!0;arrayToBox(B,I,bn);return!!(C.intersectsBox(bn)&&_intersectsGeometry$1(B,x,b,S,C))}{const C=x.geometry,D=C.index,F=C.attributes.position,G=b.index,N=b.attributes.position,H=OFFSET(r,R),W=COUNT(B,A);if(Sn.copy(S).invert(),b.boundsTree){arrayToBox(r,I,In),In.matrix.copy(Sn),In.needsUpdate=!0;const x=b.boundsTree.shapecast({intersectsBounds:r=>In.intersectsBox(r),intersectsTriangle:r=>{r.a.applyMatrix4(S),r.b.applyMatrix4(S),r.c.applyMatrix4(S),r.needsUpdate=!0;for(let x=3*H,b=3*(W+H);x<b;x+=3)if(setTriangle(wn,x,D,F),wn.needsUpdate=!0,r.intersectsTriangle(wn))return!0;return!1}});return x}{const r=getTriCount(b);for(let x=3*H,b=3*(W+H);x<b;x+=3){setTriangle(Tn,x,D,F),Tn.a.applyMatrix4(Sn),Tn.b.applyMatrix4(Sn),Tn.c.applyMatrix4(Sn),Tn.needsUpdate=!0;for(let x=0,b=3*r;x<b;x+=3)if(setTriangle(wn,x,G,N),wn.needsUpdate=!0,Tn.intersectsTriangle(wn))return!0}}}}const kn=new B,An=new OrientedBox,En=new OrientedBox,Rn=new x,Mn=new x,Pn=new x,Bn=new x;function closestPointToGeometry(r,x,b,S={},C={},I=0,A=1/0){x.boundingBox||x.computeBoundingBox(),An.set(x.boundingBox.min,x.boundingBox.max,b),An.needsUpdate=!0;const R=r.geometry,B=R.attributes.position,D=R.index,F=x.attributes.position,G=x.index,N=qt.getPrimitive(),H=qt.getPrimitive();let W=Rn,j=Mn,V=null,X=null;C&&(V=Pn,X=Bn);let q=1/0,$=null,K=null;return kn.copy(b).invert(),En.matrix.copy(kn),r.shapecast({boundsTraverseOrder:r=>An.distanceToBox(r),intersectsBounds:(r,x,b)=>b<q&&b<A&&(x&&(En.min.copy(r.min),En.max.copy(r.max),En.needsUpdate=!0),!0),intersectsRange:(r,S)=>{if(x.boundsTree){return x.boundsTree.shapecast({boundsTraverseOrder:r=>En.distanceToBox(r),intersectsBounds:(r,x,b)=>b<q&&b<A,intersectsRange:(x,C)=>{for(let A=x,R=x+C;A<R;A++){setTriangle(H,3*A,G,F),H.a.applyMatrix4(b),H.b.applyMatrix4(b),H.c.applyMatrix4(b),H.needsUpdate=!0;for(let x=r,b=r+S;x<b;x++){setTriangle(N,3*x,D,B),N.needsUpdate=!0;const r=N.distanceToTriangle(H,W,V);if(r<q&&(j.copy(W),X&&X.copy(V),q=r,$=x,K=A),r<I)return!0}}}})}for(let C=0,A=getTriCount(x);C<A;C++){setTriangle(H,3*C,G,F),H.a.applyMatrix4(b),H.b.applyMatrix4(b),H.c.applyMatrix4(b),H.needsUpdate=!0;for(let x=r,b=r+S;x<b;x++){setTriangle(N,3*x,D,B),N.needsUpdate=!0;const r=N.distanceToTriangle(H,W,V);if(r<q&&(j.copy(W),X&&X.copy(V),q=r,$=x,K=C),r<I)return!0}}}}),qt.releasePrimitive(N),qt.releasePrimitive(H),q===1/0?null:(S.point?S.point.copy(j):S.point=j.clone(),S.distance=q,S.faceIndex=$,C&&(C.point?C.point.copy(X):C.point=X.clone(),C.point.applyMatrix4(kn),j.applyMatrix4(kn),C.distance=j.sub(C.point).length(),C.faceIndex=K),S)}function refit_indirect(r,x=null){x&&Array.isArray(x)&&(x=new Set(x));const b=r.geometry,S=b.index?b.index.array:null,C=b.attributes.position;let I,A,R,B,D=0;const F=r._roots;for(let r=0,x=F.length;r<x;r++)I=F[r],A=new Uint32Array(I),R=new Uint16Array(I),B=new Float32Array(I),_traverse(0,D),D+=I.byteLength;function _traverse(b,I,D=!1){const F=2*b;if(IS_LEAF(F,R)){const x=A[b+6];let I=1/0,D=1/0,G=1/0,N=-1/0,H=-1/0,W=-1/0;for(let b=x,A=x+R[F+14];b<A;b++){const x=3*r.resolveTriangleIndex(b);for(let r=0;r<3;r++){let b=x+r;b=S?S[b]:b;const A=C.getX(b),R=C.getY(b),B=C.getZ(b);A<I&&(I=A),A>N&&(N=A),R<D&&(D=R),R>H&&(H=R),B<G&&(G=B),B>W&&(W=B)}}return(B[b+0]!==I||B[b+1]!==D||B[b+2]!==G||B[b+3]!==N||B[b+4]!==H||B[b+5]!==W)&&(B[b+0]=I,B[b+1]=D,B[b+2]=G,B[b+3]=N,B[b+4]=H,B[b+5]=W,!0)}{const r=LEFT_NODE(b),S=RIGHT_NODE(b,A);let C=D,R=!1,F=!1;if(x){if(!C){const b=r/Et+I/At,A=S/Et+I/At;R=x.has(b),F=x.has(A),C=!R&&!F}}else R=!0,F=!0;const G=C||F;let N=!1;(C||R)&&(N=_traverse(r,I,C));let H=!1;G&&(H=_traverse(S,I,C));const W=N||H;if(W)for(let x=0;x<3;x++){const C=r+x,I=S+x,A=B[C],R=B[C+3],D=B[I],F=B[I+3];B[b+x]=A<D?A:D,B[b+x+3]=R>F?R:F}return W}}}function raycast_indirect(r,x,b,S,C,I,A){$t.setBuffer(r._roots[x]),_raycast(0,r,b,S,C,I,A),$t.clearBuffer()}function _raycast(r,x,b,S,C,I,A){const{float32Array:R,uint16Array:B,uint32Array:D}=$t,F=2*r;if(IS_LEAF(F,B)){!function(r,x,b,S,C,I,A,R){const{geometry:B,_indirectBuffer:D}=r;for(let r=S,F=S+C;r<F;r++)intersectTri(B,x,b,D?D[r]:r,I,A,R)}(x,b,S,OFFSET(r,D),COUNT(F,B),C,I,A)}else{const B=LEFT_NODE(r);intersectRay(B,R,S,I,A)&&_raycast(B,x,b,S,C,I,A);const F=RIGHT_NODE(r,D);intersectRay(F,R,S,I,A)&&_raycast(F,x,b,S,C,I,A)}}const Ln=["x","y","z"];function raycastFirst_indirect(r,x,b,S,C,I){$t.setBuffer(r._roots[x]);const A=_raycastFirst(0,r,b,S,C,I);return $t.clearBuffer(),A}function _raycastFirst(r,x,b,S,C,I){const{float32Array:A,uint16Array:R,uint32Array:B}=$t;let D=2*r;if(IS_LEAF(D,R)){return function(r,x,b,S,C,I,A){const{geometry:R,_indirectBuffer:B}=r;let D=1/0,F=null;for(let r=S,G=S+C;r<G;r++){let S;S=intersectTri(R,x,b,B?B[r]:r,null,I,A),S&&S.distance<D&&(F=S,D=S.distance)}return F}(x,b,S,OFFSET(r,B),COUNT(D,R),C,I)}{const R=SPLIT_AXIS(r,B),D=Ln[R],F=S.direction[D]>=0;let G,N;F?(G=LEFT_NODE(r),N=RIGHT_NODE(r,B)):(G=RIGHT_NODE(r,B),N=LEFT_NODE(r));const H=intersectRay(G,A,S,C,I)?_raycastFirst(G,x,b,S,C,I):null;if(H){const r=H.point[D];if(F?r<=A[N+R]:r>=A[N+R+3])return H}const W=intersectRay(N,A,S,C,I)?_raycastFirst(N,x,b,S,C,I):null;return H&&W?H.distance<=W.distance?H:W:H||W||null}}const On=new F,Dn=new ExtendedTriangle,Un=new ExtendedTriangle,Fn=new B,Gn=new OrientedBox,Nn=new OrientedBox;function intersectsGeometry_indirect(r,x,b,S){$t.setBuffer(r._roots[x]);const C=_intersectsGeometry(0,r,b,S);return $t.clearBuffer(),C}function _intersectsGeometry(r,x,b,S,C=null){const{float32Array:I,uint16Array:A,uint32Array:R}=$t;let B=2*r;null===C&&(b.boundingBox||b.computeBoundingBox(),Gn.set(b.boundingBox.min,b.boundingBox.max,S),C=Gn);if(!IS_LEAF(B,A)){const A=LEFT_NODE(r),B=RIGHT_NODE(r,R);arrayToBox(A,I,On);if(C.intersectsBox(On)&&_intersectsGeometry(A,x,b,S,C))return!0;arrayToBox(B,I,On);return!!(C.intersectsBox(On)&&_intersectsGeometry(B,x,b,S,C))}{const C=x.geometry,D=C.index,F=C.attributes.position,G=b.index,N=b.attributes.position,H=OFFSET(r,R),W=COUNT(B,A);if(Fn.copy(S).invert(),b.boundsTree){arrayToBox(r,I,Nn),Nn.matrix.copy(Fn),Nn.needsUpdate=!0;const C=b.boundsTree.shapecast({intersectsBounds:r=>Nn.intersectsBox(r),intersectsTriangle:r=>{r.a.applyMatrix4(S),r.b.applyMatrix4(S),r.c.applyMatrix4(S),r.needsUpdate=!0;for(let b=H,S=W+H;b<S;b++)if(setTriangle(Un,3*x.resolveTriangleIndex(b),D,F),Un.needsUpdate=!0,r.intersectsTriangle(Un))return!0;return!1}});return C}{const r=getTriCount(b);for(let b=H,S=W+H;b<S;b++){const S=x.resolveTriangleIndex(b);setTriangle(Dn,3*S,D,F),Dn.a.applyMatrix4(Fn),Dn.b.applyMatrix4(Fn),Dn.c.applyMatrix4(Fn),Dn.needsUpdate=!0;for(let x=0,b=3*r;x<b;x+=3)if(setTriangle(Un,x,G,N),Un.needsUpdate=!0,Dn.intersectsTriangle(Un))return!0}}}}const Hn=new B,Wn=new OrientedBox,zn=new OrientedBox,jn=new x,Vn=new x,Xn=new x,qn=new x;function closestPointToGeometry_indirect(r,x,b,S={},C={},I=0,A=1/0){x.boundingBox||x.computeBoundingBox(),Wn.set(x.boundingBox.min,x.boundingBox.max,b),Wn.needsUpdate=!0;const R=r.geometry,B=R.attributes.position,D=R.index,F=x.attributes.position,G=x.index,N=qt.getPrimitive(),H=qt.getPrimitive();let W=jn,j=Vn,V=null,X=null;C&&(V=Xn,X=qn);let q=1/0,$=null,K=null;return Hn.copy(b).invert(),zn.matrix.copy(Hn),r.shapecast({boundsTraverseOrder:r=>Wn.distanceToBox(r),intersectsBounds:(r,x,b)=>b<q&&b<A&&(x&&(zn.min.copy(r.min),zn.max.copy(r.max),zn.needsUpdate=!0),!0),intersectsRange:(S,C)=>{if(x.boundsTree){const R=x.boundsTree;return R.shapecast({boundsTraverseOrder:r=>zn.distanceToBox(r),intersectsBounds:(r,x,b)=>b<q&&b<A,intersectsRange:(x,A)=>{for(let Y=x,Z=x+A;Y<Z;Y++){const x=R.resolveTriangleIndex(Y);setTriangle(H,3*x,G,F),H.a.applyMatrix4(b),H.b.applyMatrix4(b),H.c.applyMatrix4(b),H.needsUpdate=!0;for(let x=S,b=S+C;x<b;x++){const b=r.resolveTriangleIndex(x);setTriangle(N,3*b,D,B),N.needsUpdate=!0;const S=N.distanceToTriangle(H,W,V);if(S<q&&(j.copy(W),X&&X.copy(V),q=S,$=x,K=Y),S<I)return!0}}}})}for(let A=0,R=getTriCount(x);A<R;A++){setTriangle(H,3*A,G,F),H.a.applyMatrix4(b),H.b.applyMatrix4(b),H.c.applyMatrix4(b),H.needsUpdate=!0;for(let x=S,b=S+C;x<b;x++){const b=r.resolveTriangleIndex(x);setTriangle(N,3*b,D,B),N.needsUpdate=!0;const S=N.distanceToTriangle(H,W,V);if(S<q&&(j.copy(W),X&&X.copy(V),q=S,$=x,K=A),S<I)return!0}}}}),qt.releasePrimitive(N),qt.releasePrimitive(H),q===1/0?null:(S.point?S.point.copy(j):S.point=j.clone(),S.distance=q,S.faceIndex=$,C&&(C.point?C.point.copy(X):C.point=X.clone(),C.point.applyMatrix4(Hn),j.applyMatrix4(Hn),C.distance=j.sub(C.point).length(),C.faceIndex=K),S)}function isSharedArrayBufferSupported(){return"undefined"!=typeof SharedArrayBuffer}const $n=new $t.constructor,Kn=new $t.constructor,Yn=new PrimitivePool((()=>new F)),Zn=new F,Jn=new F,Qn=new F,er=new F;let tr=!1;function _traverse(r,x,b,S,C,I=0,A=0,R=0,B=0,D=null,F=!1){let G,N;F?(G=Kn,N=$n):(G=$n,N=Kn);const H=G.float32Array,W=G.uint32Array,j=G.uint16Array,V=N.float32Array,X=N.uint32Array,q=N.uint16Array,$=2*x,K=IS_LEAF(2*r,j),Y=IS_LEAF($,q);let Z=!1;if(Y&&K)Z=F?C(OFFSET(x,X),COUNT(2*x,q),OFFSET(r,W),COUNT(2*r,j),B,A+x/Et,R,I+r/Et):C(OFFSET(r,W),COUNT(2*r,j),OFFSET(x,X),COUNT(2*x,q),R,I+r/Et,B,A+x/Et);else if(Y){const D=Yn.getPrimitive();arrayToBox(x,V,D),D.applyMatrix4(b);const G=LEFT_NODE(r),N=RIGHT_NODE(r,W);arrayToBox(G,H,Zn),arrayToBox(N,H,Jn);const j=D.intersectsBox(Zn),X=D.intersectsBox(Jn);Z=j&&_traverse(x,G,S,b,C,A,I,B,R+1,D,!F)||X&&_traverse(x,N,S,b,C,A,I,B,R+1,D,!F),Yn.releasePrimitive(D)}else{const G=LEFT_NODE(x),N=RIGHT_NODE(x,X);arrayToBox(G,V,Qn),arrayToBox(N,V,er);const j=D.intersectsBox(Qn),q=D.intersectsBox(er);if(j&&q)Z=_traverse(r,G,b,S,C,I,A,R,B+1,D,F)||_traverse(r,N,b,S,C,I,A,R,B+1,D,F);else if(j)if(K)Z=_traverse(r,G,b,S,C,I,A,R,B+1,D,F);else{const x=Yn.getPrimitive();x.copy(Qn).applyMatrix4(b);const D=LEFT_NODE(r),N=RIGHT_NODE(r,W);arrayToBox(D,H,Zn),arrayToBox(N,H,Jn);const j=x.intersectsBox(Zn),V=x.intersectsBox(Jn);Z=j&&_traverse(G,D,S,b,C,A,I,B,R+1,x,!F)||V&&_traverse(G,N,S,b,C,A,I,B,R+1,x,!F),Yn.releasePrimitive(x)}else if(q)if(K)Z=_traverse(r,N,b,S,C,I,A,R,B+1,D,F);else{const x=Yn.getPrimitive();x.copy(er).applyMatrix4(b);const D=LEFT_NODE(r),G=RIGHT_NODE(r,W);arrayToBox(D,H,Zn),arrayToBox(G,H,Jn);const j=x.intersectsBox(Zn),V=x.intersectsBox(Jn);Z=j&&_traverse(N,D,S,b,C,A,I,B,R+1,x,!F)||V&&_traverse(N,G,S,b,C,A,I,B,R+1,x,!F),Yn.releasePrimitive(x)}}return Z}const nr=new OrientedBox,rr=new F,ir={strategy:Tt,maxDepth:40,maxLeafTris:10,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,verbose:!0,range:null};class MeshBVH{static serialize(r,x={}){x={cloneBuffers:!0,...x};const b=r.geometry,S=r._roots,C=r._indirectBuffer,I=b.getIndex(),A={version:1,roots:null,index:null,indirectBuffer:null};return x.cloneBuffers?(A.roots=S.map((r=>r.slice())),A.index=I?I.array.slice():null,A.indirectBuffer=C?C.slice():null):(A.roots=S,A.index=I?I.array:null,A.indirectBuffer=C),A}static deserialize(r,x,b={}){b={setIndex:!0,indirect:Boolean(r.indirectBuffer),...b};const{index:S,roots:C,indirectBuffer:I}=r;r.version||(console.warn("MeshBVH.deserialize: Serialization format has been changed and will be fixed up. It is recommended to regenerate any stored serialized data."),function(r){for(let x=0;x<r.length;x++){const b=r[x],S=new Uint32Array(b),C=new Uint16Array(b);for(let r=0,x=b.byteLength/At;r<x;r++){const x=Et*r;IS_LEAF(2*x,C)||(S[x+6]=S[x+6]/Et-r)}}}(C));const A=new MeshBVH(x,{...b,[Bt]:!0});if(A._roots=C,A._indirectBuffer=I||null,b.setIndex){const b=x.getIndex();if(null===b){const b=new D(r.index,1,!1);x.setIndex(b)}else b.array!==S&&(b.array.set(S),b.needsUpdate=!0)}return A}get indirect(){return!!this._indirectBuffer}constructor(r,x={}){if(!r.isBufferGeometry)throw new Error("MeshBVH: Only BufferGeometries are supported.");if(r.index&&r.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.");if((x=Object.assign({...ir,[Bt]:!1},x)).useSharedArrayBuffer&&!isSharedArrayBufferSupported())throw new Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=r,this._roots=null,this._indirectBuffer=null,x[Bt]||(buildPackedTree(this,x),!r.boundingBox&&x.setBoundingBox&&(r.boundingBox=this.getBoundingBox(new F))),this.resolveTriangleIndex=x.indirect?r=>this._indirectBuffer[r]:r=>r}shiftTriangleOffsets(r){const x=this._indirectBuffer;if(x)for(let b=0,S=x.length;b<S;b++)x[b]+=r;else{const x=this._roots;for(let b=0;b<x.length;b++){const S=x[b],C=new Uint32Array(S),I=new Uint16Array(S),A=S.byteLength/At;for(let x=0;x<A;x++){const b=Et*x;IS_LEAF(2*b,I)&&(C[b+6]+=r)}}}}refit(r=null){return(this.indirect?refit_indirect:refit)(this,r)}traverse(r,x=0){const b=this._roots[x],S=new Uint32Array(b),C=new Uint16Array(b);!function _traverse(x,I=0){const A=2*x,R=IS_LEAF(A,C);if(R){const B=S[x+6],D=C[A+14];r(I,R,new Float32Array(b,4*x,6),B,D)}else{const C=LEFT_NODE(x),A=RIGHT_NODE(x,S),B=SPLIT_AXIS(x,S);r(I,R,new Float32Array(b,4*x,6),B)||(_traverse(C,I+1),_traverse(A,I+1))}}(0)}raycast(r,x=G,b=0,S=1/0){const C=this._roots,I=[],A=this.indirect?raycast_indirect:raycast;for(let R=0,B=C.length;R<B;R++)A(this,R,x,r,I,b,S);return I}raycastFirst(r,x=G,b=0,S=1/0){const C=this._roots;let I=null;const A=this.indirect?raycastFirst_indirect:raycastFirst;for(let R=0,B=C.length;R<B;R++){const C=A(this,R,x,r,b,S);null!=C&&(null==I||C.distance<I.distance)&&(I=C)}return I}intersectsGeometry(r,x){let b=!1;const S=this._roots,C=this.indirect?intersectsGeometry_indirect:intersectsGeometry;for(let I=0,A=S.length;I<A&&(b=C(this,I,r,x),!b);I++);return b}shapecast(r){const x=qt.getPrimitive(),b=this.indirect?iterateOverTriangles_indirect:iterateOverTriangles;let{boundsTraverseOrder:S,intersectsBounds:C,intersectsRange:I,intersectsTriangle:A}=r;if(I&&A){const r=I;I=(S,C,I,R,B)=>!!r(S,C,I,R,B)||b(S,C,this,A,I,R,x)}else I||(I=A?(r,S,C,I)=>b(r,S,this,A,C,I,x):(r,x,b)=>b);let R=!1,B=0;const D=this._roots;for(let r=0,x=D.length;r<x;r++){const x=D[r];if(R=shapecast(this,r,C,I,S,B),R)break;B+=x.byteLength/At}return qt.releasePrimitive(x),R}bvhcast(r,x,b){let{intersectsRanges:S,intersectsTriangles:C}=b;const I=qt.getPrimitive(),A=this.geometry.index,R=this.geometry.attributes.position,D=this.indirect?r=>{const x=this.resolveTriangleIndex(r);setTriangle(I,3*x,A,R)}:r=>{setTriangle(I,3*r,A,R)},F=qt.getPrimitive(),G=r.geometry.index,N=r.geometry.attributes.position,H=r.indirect?x=>{const b=r.resolveTriangleIndex(x);setTriangle(F,3*b,G,N)}:r=>{setTriangle(F,3*r,G,N)};if(C){const iterateOverDoubleTriangles=(r,b,S,A,R,B,G,N)=>{for(let W=S,j=S+A;W<j;W++){H(W),F.a.applyMatrix4(x),F.b.applyMatrix4(x),F.c.applyMatrix4(x),F.needsUpdate=!0;for(let x=r,S=r+b;x<S;x++)if(D(x),I.needsUpdate=!0,C(I,F,x,W,R,B,G,N))return!0}return!1};if(S){const r=S;S=function(x,b,S,C,I,A,R,B){return!!r(x,b,S,C,I,A,R,B)||iterateOverDoubleTriangles(x,b,S,C,I,A,R,B)}}else S=iterateOverDoubleTriangles}return function(r,x,b,S){if(tr)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");tr=!0;const C=r._roots,I=x._roots;let A,R=0,D=0;const F=(new B).copy(b).invert();for(let r=0,x=C.length;r<x;r++){$n.setBuffer(C[r]),D=0;const x=Yn.getPrimitive();arrayToBox(0,$n.float32Array,x),x.applyMatrix4(F);for(let r=0,C=I.length;r<C&&(Kn.setBuffer(I[r]),A=_traverse(0,0,b,F,S,R,D,0,0,x),Kn.clearBuffer(),D+=I[r].byteLength/At,!A);r++);if(Yn.releasePrimitive(x),$n.clearBuffer(),R+=C[r].byteLength/At,A)break}return tr=!1,A}(this,r,x,S)}intersectsBox(r,x){return nr.set(r.min,r.max,x),nr.needsUpdate=!0,this.shapecast({intersectsBounds:r=>nr.intersectsBox(r),intersectsTriangle:r=>nr.intersectsTriangle(r)})}intersectsSphere(r){return this.shapecast({intersectsBounds:x=>r.intersectsBox(x),intersectsTriangle:x=>x.intersectsSphere(r)})}closestPointToGeometry(r,x,b={},S={},C=0,I=1/0){return(this.indirect?closestPointToGeometry_indirect:closestPointToGeometry)(this,r,x,b,S,C,I)}closestPointToPoint(r,x={},b=0,S=1/0){return function(r,x,b={},S=0,C=1/0){const I=S*S,A=C*C;let R=1/0,B=null;if(r.shapecast({boundsTraverseOrder:r=>(Qt.copy(x).clamp(r.min,r.max),Qt.distanceToSquared(x)),intersectsBounds:(r,x,b)=>b<R&&b<A,intersectsTriangle:(r,b)=>{r.closestPointToPoint(x,Qt);const S=x.distanceToSquared(Qt);return S<R&&(en.copy(Qt),R=S,B=b),S<I}}),R===1/0)return null;const D=Math.sqrt(R);return b.point?b.point.copy(en):b.point=en.clone(),b.distance=D,b.faceIndex=B,b}(this,r,x,b,S)}getBoundingBox(r){r.makeEmpty();return this._roots.forEach((x=>{arrayToBox(0,new Float32Array(x),rr),r.union(rr)})),r}}const sr=new F,or=new B;class MeshBVHRootHelper extends ee{get isMesh(){return!this.displayEdges}get isLineSegments(){return this.displayEdges}get isLine(){return this.displayEdges}getVertexPosition(...r){return b.prototype.getVertexPosition.call(this,...r)}constructor(r,x,b=10,S=0){super(),this.material=x,this.geometry=new J,this.name="MeshBVHRootHelper",this.depth=b,this.displayParents=!1,this.bvh=r,this.displayEdges=!0,this._group=S}raycast(){}update(){const r=this.geometry,x=this.bvh,b=this._group;if(r.dispose(),this.visible=!1,x){const S=this.depth-1,C=this.displayParents;let I=0;x.traverse(((r,x)=>{if(r>=S||x)return I++,!0;C&&I++}),b);let A=0;const R=new Float32Array(24*I);let B,F;x.traverse(((r,x,b)=>{const I=r>=S||x;if(I||C){arrayToBox(0,b,sr);const{min:r,max:x}=sr;for(let b=-1;b<=1;b+=2){const S=b<0?r.x:x.x;for(let b=-1;b<=1;b+=2){const C=b<0?r.y:x.y;for(let b=-1;b<=1;b+=2){const I=b<0?r.z:x.z;R[A+0]=S,R[A+1]=C,R[A+2]=I,A+=3}}}return I}}),b),F=this.displayEdges?new Uint8Array([0,4,1,5,2,6,3,7,0,2,1,3,4,6,5,7,0,1,2,3,4,5,6,7]):new Uint8Array([0,1,2,2,1,3,4,6,5,6,7,5,1,4,5,0,4,1,2,3,6,3,7,6,0,2,4,2,6,4,1,5,3,3,5,7]),B=R.length>65535?new Uint32Array(F.length*I):new Uint16Array(F.length*I);const G=F.length;for(let r=0;r<I;r++){const x=8*r,b=r*G;for(let r=0;r<G;r++)B[b+r]=x+F[r]}r.setIndex(new D(B,1,!1)),r.setAttribute("position",new D(R,3,!1)),this.visible=!0}}}class MeshBVHHelper extends N{get color(){return this.edgeMaterial.color}get opacity(){return this.edgeMaterial.opacity}set opacity(r){this.edgeMaterial.opacity=r,this.meshMaterial.opacity=r}constructor(r=null,x=null,b=10){r instanceof MeshBVH&&(b=x||10,x=r,r=null),"number"==typeof x&&(b=x,x=null),super(),this.name="MeshBVHHelper",this.depth=b,this.mesh=r,this.bvh=x,this.displayParents=!1,this.displayEdges=!0,this.objectIndex=0,this._roots=[];const S=new H({color:65416,transparent:!0,opacity:.3,depthWrite:!1}),C=new W({color:65416,transparent:!0,opacity:.3,depthWrite:!1});C.color=S.color,this.edgeMaterial=S,this.meshMaterial=C,this.update()}update(){const r=this.mesh;let x=this.bvh||r.geometry.boundsTree||null;if(r&&r.isBatchedMesh&&r.boundsTrees&&!x){const b=r._drawInfo[this.objectIndex];b&&(x=r.boundsTrees[b.geometryIndex]||x)}const b=x?x._roots.length:0;for(;this._roots.length>b;){const r=this._roots.pop();r.geometry.dispose(),this.remove(r)}for(let r=0;r<b;r++){const{depth:b,edgeMaterial:S,meshMaterial:C,displayParents:I,displayEdges:A}=this;if(r>=this._roots.length){const C=new MeshBVHRootHelper(x,S,b,r);this.add(C),this._roots.push(C)}const R=this._roots[r];R.bvh=x,R.depth=b,R.displayParents=I,R.displayEdges=A,R.material=A?S:C,R.update()}}updateMatrixWorld(...r){const x=this.mesh,b=this.parent;null!==x&&(x.updateWorldMatrix(!0,!1),b?this.matrix.copy(b.matrixWorld).invert().multiply(x.matrixWorld):this.matrix.copy(x.matrixWorld),(x.isInstancedMesh||x.isBatchedMesh)&&(x.getMatrixAt(this.objectIndex,or),this.matrix.multiply(or)),this.matrix.decompose(this.position,this.quaternion,this.scale)),super.updateMatrixWorld(...r)}copy(r){this.depth=r.depth,this.mesh=r.mesh,this.bvh=r.bvh,this.opacity=r.opacity,this.color.copy(r.color)}clone(){return new MeshBVHHelper(this.mesh,this.bvh,this.depth)}dispose(){this.edgeMaterial.dispose(),this.meshMaterial.dispose();const r=this.children;for(let x=0,b=r.length;x<b;x++)r[x].geometry.dispose()}}const ar=new F,lr=new F,cr=new x;function getPrimitiveSize(r){switch(typeof r){case"number":return 8;case"string":return 2*r.length;case"boolean":return 4;default:return 0}}function convertRaycastIntersect(r,x,b){return null===r?null:(r.point.applyMatrix4(x.matrixWorld),r.distance=r.point.distanceTo(b.ray.origin),r.object=x,r)}const hr=parseInt(te)>=166,dr=new ne,ur=new x,pr=new B,fr=b.prototype.raycast,gr=S.prototype.raycast,mr=new x,_r=new b,yr=[];function acceleratedBatchedMeshRaycast(r,x){if(this.boundsTrees){const b=this.boundsTrees,S=this._drawInfo||this._instanceInfo,C=this._drawRanges||this._geometryInfo,I=this.matrixWorld;_r.material=this.material,_r.geometry=this.geometry;const A=_r.geometry.boundsTree,R=_r.geometry.drawRange;null===_r.geometry.boundingSphere&&(_r.geometry.boundingSphere=new j);for(let A=0,R=S.length;A<R;A++){if(!this.getVisibleAt(A))continue;const R=S[A].geometryIndex;if(_r.geometry.boundsTree=b[R],this.getMatrixAt(A,_r.matrixWorld).premultiply(I),!_r.geometry.boundsTree){this.getBoundingBoxAt(R,_r.geometry.boundingBox),this.getBoundingSphereAt(R,_r.geometry.boundingSphere);const r=C[R];_r.geometry.setDrawRange(r.start,r.count)}_r.raycast(r,yr);for(let r=0,b=yr.length;r<b;r++){const b=yr[r];b.object=this,b.batchId=A,x.push(b)}yr.length=0}_r.geometry.boundsTree=A,_r.geometry.drawRange=R,_r.material=null,_r.geometry=null}else gr.call(this,r,x)}function acceleratedMeshRaycast(r,x){if(this.geometry.boundsTree){if(void 0===this.material)return;pr.copy(this.matrixWorld).invert(),dr.copy(r.ray).applyMatrix4(pr),mr.setFromMatrixScale(this.matrixWorld),ur.copy(dr.direction).multiply(mr);const b=ur.length(),S=r.near/b,C=r.far/b,I=this.geometry.boundsTree;if(!0===r.firstHitOnly){const b=convertRaycastIntersect(I.raycastFirst(dr,this.material,S,C),this,r);b&&x.push(b)}else{const b=I.raycast(dr,this.material,S,C);for(let S=0,C=b.length;S<C;S++){const C=convertRaycastIntersect(b[S],this,r);C&&x.push(C)}}}else fr.call(this,r,x)}function countToIntFormat(r){switch(r){case 1:return de;case 2:return Z;case 3:case 4:return ae}}class VertexAttributeTexture extends V{constructor(){super(),this.minFilter=X,this.magFilter=X,this.generateMipmaps=!1,this.overrideItemSize=null,this._forcedType=null}updateFrom(r){const x=this.overrideItemSize,b=r.itemSize,S=r.count;if(null!==x){if(b*S%x!=0)throw new Error("VertexAttributeTexture: overrideItemSize must divide evenly into buffer length.");r.itemSize=x,r.count=S*b/x}const C=r.itemSize,I=r.count,A=r.normalized,R=r.array.constructor,B=R.BYTES_PER_ELEMENT;let D,F,G,N,H=this._forcedType,W=C;if(null===H)switch(R){case Float32Array:H=K;break;case Uint8Array:case Uint16Array:case Uint32Array:H=q;break;case Int8Array:case Int16Array:case Int32Array:H=$}let j=function(r){switch(r){case 1:return"R";case 2:return"RG";case 3:case 4:return"RGBA"}throw new Error}(C);switch(H){case K:G=1,F=function(r){switch(r){case 1:return he;case 2:return ce;case 3:case 4:return Y}}(C),A&&1===B?(N=R,j+="8",R===Uint8Array?D=re:(D=se,j+="_SNORM")):(N=Float32Array,j+="32F",D=K);break;case $:j+=8*B+"I",G=A?Math.pow(2,8*R.BYTES_PER_ELEMENT-1):1,F=countToIntFormat(C),1===B?(N=Int8Array,D=se):2===B?(N=Int16Array,D=oe):(N=Int32Array,D=$);break;case q:j+=8*B+"UI",G=A?Math.pow(2,8*R.BYTES_PER_ELEMENT-1):1,F=countToIntFormat(C),1===B?(N=Uint8Array,D=re):2===B?(N=Uint16Array,D=ie):(N=Uint32Array,D=q)}3!==W||F!==Y&&F!==ae||(W=4);const V=Math.ceil(Math.sqrt(I))||1,X=new N(W*V*V),Z=r.normalized;r.normalized=!1;for(let x=0;x<I;x++){const b=W*x;X[b]=r.getX(x)/G,C>=2&&(X[b+1]=r.getY(x)/G),C>=3&&(X[b+2]=r.getZ(x)/G,4===W&&(X[b+3]=1)),C>=4&&(X[b+3]=r.getW(x)/G)}r.normalized=Z,this.internalFormat=j,this.format=F,this.type=D,this.image.width=V,this.image.height=V,this.image.data=X,this.needsUpdate=!0,this.dispose(),r.itemSize=b,r.count=S}}class UIntVertexAttributeTexture extends VertexAttributeTexture{constructor(){super(),this._forcedType=q}}class FloatVertexAttributeTexture extends VertexAttributeTexture{constructor(){super(),this._forcedType=K}}const vr=new x,xr=new x,br=new x,Tr=new le,wr=new x,Sr=new x,Cr=new le,Ir=new le,kr=new B,Ar=new B;function validateAttributes(r,x){if(!r&&!x)return;const b=r.count===x.count,S=r.normalized===x.normalized,C=r.array.constructor===x.array.constructor,I=r.itemSize===x.itemSize;if(!(b&&S&&C&&I))throw new Error}function createAttributeClone(r,x=null){const b=r.array.constructor,S=r.normalized,C=r.itemSize,I=null===x?r.count:x;return new D(new b(C*I),C,S)}function copyAttributeContents(r,x,b=0){if(r.isInterleavedBufferAttribute){const S=r.itemSize;for(let C=0,I=r.count;C<I;C++){const I=C+b;x.setX(I,r.getX(C)),S>=2&&x.setY(I,r.getY(C)),S>=3&&x.setZ(I,r.getZ(C)),S>=4&&x.setW(I,r.getW(C))}}else{const S=x.array,C=S.constructor,I=S.BYTES_PER_ELEMENT*r.itemSize*b;new C(S.buffer,I,r.array.length).set(r.array)}}function addScaledMatrix(r,x,b){const S=r.elements,C=x.elements;for(let r=0,x=C.length;r<x;r++)S[r]+=C[r]*b}function boneNormalTransform(r,x,b){const S=r.skeleton,C=r.geometry,I=S.bones,A=S.boneInverses;Cr.fromBufferAttribute(C.attributes.skinIndex,x),Ir.fromBufferAttribute(C.attributes.skinWeight,x),kr.elements.fill(0);for(let r=0;r<4;r++){const x=Ir.getComponent(r);if(0!==x){const b=Cr.getComponent(r);Ar.multiplyMatrices(I[b].matrixWorld,A[b]),addScaledMatrix(kr,Ar,x)}}return kr.multiply(r.bindMatrix).premultiply(r.bindMatrixInverse),b.transformDirection(kr),b}function applyMorphTarget(r,x,b,S,C){wr.set(0,0,0);for(let I=0,A=r.length;I<A;I++){const A=x[I],R=r[I];0!==A&&(Sr.fromBufferAttribute(R,S),b?wr.addScaledVector(Sr,A):wr.addScaledVector(Sr.sub(C),A))}C.add(wr)}class GeometryDiff{constructor(r){this.matrixWorld=new B,this.geometryHash=null,this.boneMatrices=null,this.primitiveCount=-1,this.mesh=r,this.update()}update(){const r=this.mesh,x=r.geometry,b=r.skeleton,S=(x.index?x.index.count:x.attributes.position.count)/3;if(this.matrixWorld.copy(r.matrixWorld),this.geometryHash=x.attributes.position.version,this.primitiveCount=S,b){b.boneTexture||b.computeBoneTexture(),b.update();const r=b.boneMatrices;this.boneMatrices&&this.boneMatrices.length===r.length?this.boneMatrices.set(r):this.boneMatrices=r.slice()}else this.boneMatrices=null}didChange(){const r=this.mesh,x=r.geometry,b=(x.index?x.index.count:x.attributes.position.count)/3,S=this.matrixWorld.equals(r.matrixWorld)&&this.geometryHash===x.attributes.position.version&&function(r,x){if(null===r||null===x)return r===x;if(r.length!==x.length)return!1;for(let b=0,S=r.length;b<S;b++)if(r[b]!==x[b])return!1;return!0}(r.skeleton&&r.skeleton.boneMatrices||null,this.boneMatrices)&&this.primitiveCount===b;return!S}}class StaticGeometryGenerator{constructor(r){Array.isArray(r)||(r=[r]);const x=[];r.forEach((r=>{r.traverseVisible((r=>{r.isMesh&&x.push(r)}))})),this.meshes=x,this.useGroups=!0,this.applyWorldTransforms=!0,this.attributes=["position","normal","color","tangent","uv","uv2"],this._intermediateGeometry=new Array(x.length).fill().map((()=>new J)),this._diffMap=new WeakMap}getMaterials(){const r=[];return this.meshes.forEach((x=>{Array.isArray(x.material)?r.push(...x.material):r.push(x.material)})),r}generate(r=new J){let x=[];const{meshes:b,useGroups:S,_intermediateGeometry:C,_diffMap:I}=this;for(let r=0,S=b.length;r<S;r++){const S=b[r],A=C[r],R=I.get(S);!R||R.didChange(S)?(this._convertToStaticGeometry(S,A),x.push(!1),R?R.update():I.set(S,new GeometryDiff(S))):x.push(!0)}if(0===C.length){r.setIndex(null);const x=r.attributes;for(const b in x)r.deleteAttribute(b);for(const x in this.attributes)r.setAttribute(this.attributes[x],new D(new Float32Array(0),4,!1))}else!function(r,x={useGroups:!1,updateIndex:!1,skipAttributes:[]},b=new J){const S=null!==r[0].index,{useGroups:C=!1,updateIndex:I=!1,skipAttributes:A=[]}=x,R=new Set(Object.keys(r[0].attributes)),B={};let F=0;b.clearGroups();for(let x=0;x<r.length;++x){const I=r[x];let A=0;if(S!==(null!==I.index))throw new Error("StaticGeometryGenerator: All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them.");for(const r in I.attributes){if(!R.has(r))throw new Error('StaticGeometryGenerator: All geometries must have compatible attributes; make sure "'+r+'" attribute exists among all geometries, or in none of them.');void 0===B[r]&&(B[r]=[]),B[r].push(I.attributes[r]),A++}if(A!==R.size)throw new Error("StaticGeometryGenerator: Make sure all geometries have the same number of attributes.");if(C){let r;if(S)r=I.index.count;else{if(void 0===I.attributes.position)throw new Error("StaticGeometryGenerator: The geometry must have either an index or a position attribute");r=I.attributes.position.count}b.addGroup(F,r,x),F+=r}}if(S){let x=!1;if(!b.index){let S=0;for(let x=0;x<r.length;++x)S+=r[x].index.count;b.setIndex(new D(new Uint32Array(S),1,!1)),x=!0}if(I||x){const x=b.index;let S=0,C=0;for(let b=0;b<r.length;++b){const I=r[b],R=I.index;if(!0!==A[b])for(let r=0;r<R.count;++r)x.setX(S,R.getX(r)+C),S++;C+=I.attributes.position.count}}}for(const r in B){const x=B[r];if(!(r in b.attributes)){let S=0;for(const r in x)S+=x[r].count;b.setAttribute(r,createAttributeClone(B[r][0],S))}const S=b.attributes[r];let C=0;for(let r=0,b=x.length;r<b;r++){const b=x[r];!0!==A[r]&&copyAttributeContents(b,S,C),C+=b.count}}}(C,{useGroups:S,skipAttributes:x},r);for(const x in r.attributes)r.attributes[x].needsUpdate=!0;return r}_convertToStaticGeometry(r,x=new J){const b=r.geometry,S=this.applyWorldTransforms,C=this.attributes.includes("normal"),I=this.attributes.includes("tangent"),A=b.attributes,R=x.attributes;!x.index&&b.index&&(x.index=b.index.clone()),R.position||x.setAttribute("position",createAttributeClone(A.position)),C&&!R.normal&&A.normal&&x.setAttribute("normal",createAttributeClone(A.normal)),I&&!R.tangent&&A.tangent&&x.setAttribute("tangent",createAttributeClone(A.tangent)),validateAttributes(b.index,x.index),validateAttributes(A.position,R.position),C&&validateAttributes(A.normal,R.normal),I&&validateAttributes(A.tangent,R.tangent);const B=A.position,D=C?A.normal:null,F=I?A.tangent:null,G=b.morphAttributes.position,N=b.morphAttributes.normal,H=b.morphAttributes.tangent,W=b.morphTargetsRelative,j=r.morphTargetInfluences,V=new Q;V.getNormalMatrix(r.matrixWorld),b.index&&x.index.array.set(b.index.array);for(let x=0,b=A.position.count;x<b;x++)vr.fromBufferAttribute(B,x),D&&xr.fromBufferAttribute(D,x),F&&(Tr.fromBufferAttribute(F,x),br.fromBufferAttribute(F,x)),j&&(G&&applyMorphTarget(G,j,W,x,vr),N&&applyMorphTarget(N,j,W,x,xr),H&&applyMorphTarget(H,j,W,x,br)),r.isSkinnedMesh&&(r.applyBoneTransform(x,vr),D&&boneNormalTransform(r,x,xr),F&&boneNormalTransform(r,x,br)),S&&vr.applyMatrix4(r.matrixWorld),R.position.setXYZ(x,vr.x,vr.y,vr.z),D&&(S&&xr.applyNormalMatrix(V),R.normal.setXYZ(x,xr.x,xr.y,xr.z)),F&&(S&&br.transformDirection(r.matrixWorld),R.tangent.setXYZW(x,br.x,br.y,br.z,Tr.w));for(const r in this.attributes){const b=this.attributes[r];"position"!==b&&"tangent"!==b&&"normal"!==b&&b in A&&(R[b]||x.setAttribute(b,createAttributeClone(A[b])),validateAttributes(A[b],R[b]),copyAttributeContents(A[b],R[b]))}return r.matrixWorld.determinant()<0&&function(r){const{index:x,attributes:b}=r;if(x)for(let r=0,b=x.count;r<b;r+=3){const b=x.getX(r),S=x.getX(r+2);x.setX(r,S),x.setX(r+2,b)}else for(const r in b){const x=b[r],S=x.itemSize;for(let r=0,b=x.count;r<b;r+=3)for(let b=0;b<S;b++){const S=x.getComponent(r,b),C=x.getComponent(r+2,b);x.setComponent(r,b,C),x.setComponent(r+2,b,S)}}}(x),x}}const Er="\n\n// A stack of uint32 indices can can store the indices for\n// a perfectly balanced tree with a depth up to 31. Lower stack\n// depth gets higher performance.\n//\n// However not all trees are balanced. Best value to set this to\n// is the trees max depth.\n#ifndef BVH_STACK_DEPTH\n#define BVH_STACK_DEPTH 60\n#endif\n\n#ifndef INFINITY\n#define INFINITY 1e20\n#endif\n\n// Utilities\nuvec4 uTexelFetch1D( usampler2D tex, uint index ) {\n\n\tuint width = uint( textureSize( tex, 0 ).x );\n\tuvec2 uv;\n\tuv.x = index % width;\n\tuv.y = index / width;\n\n\treturn texelFetch( tex, ivec2( uv ), 0 );\n\n}\n\nivec4 iTexelFetch1D( isampler2D tex, uint index ) {\n\n\tuint width = uint( textureSize( tex, 0 ).x );\n\tuvec2 uv;\n\tuv.x = index % width;\n\tuv.y = index / width;\n\n\treturn texelFetch( tex, ivec2( uv ), 0 );\n\n}\n\nvec4 texelFetch1D( sampler2D tex, uint index ) {\n\n\tuint width = uint( textureSize( tex, 0 ).x );\n\tuvec2 uv;\n\tuv.x = index % width;\n\tuv.y = index / width;\n\n\treturn texelFetch( tex, ivec2( uv ), 0 );\n\n}\n\nvec4 textureSampleBarycoord( sampler2D tex, vec3 barycoord, uvec3 faceIndices ) {\n\n\treturn\n\t\tbarycoord.x * texelFetch1D( tex, faceIndices.x ) +\n\t\tbarycoord.y * texelFetch1D( tex, faceIndices.y ) +\n\t\tbarycoord.z * texelFetch1D( tex, faceIndices.z );\n\n}\n\nvoid ndcToCameraRay(\n\tvec2 coord, mat4 cameraWorld, mat4 invProjectionMatrix,\n\tout vec3 rayOrigin, out vec3 rayDirection\n) {\n\n\t// get camera look direction and near plane for camera clipping\n\tvec4 lookDirection = cameraWorld * vec4( 0.0, 0.0, - 1.0, 0.0 );\n\tvec4 nearVector = invProjectionMatrix * vec4( 0.0, 0.0, - 1.0, 1.0 );\n\tfloat near = abs( nearVector.z / nearVector.w );\n\n\t// get the camera direction and position from camera matrices\n\tvec4 origin = cameraWorld * vec4( 0.0, 0.0, 0.0, 1.0 );\n\tvec4 direction = invProjectionMatrix * vec4( coord, 0.5, 1.0 );\n\tdirection /= direction.w;\n\tdirection = cameraWorld * direction - origin;\n\n\t// slide the origin along the ray until it sits at the near clip plane position\n\torigin.xyz += direction.xyz * near / dot( direction, lookDirection );\n\n\trayOrigin = origin.xyz;\n\trayDirection = direction.xyz;\n\n}\n",Rr="\n\nfloat dot2( vec3 v ) {\n\n\treturn dot( v, v );\n\n}\n\n// https://www.shadertoy.com/view/ttfGWl\nvec3 closestPointToTriangle( vec3 p, vec3 v0, vec3 v1, vec3 v2, out vec3 barycoord ) {\n\n    vec3 v10 = v1 - v0;\n    vec3 v21 = v2 - v1;\n    vec3 v02 = v0 - v2;\n\n\tvec3 p0 = p - v0;\n\tvec3 p1 = p - v1;\n\tvec3 p2 = p - v2;\n\n    vec3 nor = cross( v10, v02 );\n\n    // method 2, in barycentric space\n    vec3  q = cross( nor, p0 );\n    float d = 1.0 / dot2( nor );\n    float u = d * dot( q, v02 );\n    float v = d * dot( q, v10 );\n    float w = 1.0 - u - v;\n\n\tif( u < 0.0 ) {\n\n\t\tw = clamp( dot( p2, v02 ) / dot2( v02 ), 0.0, 1.0 );\n\t\tu = 0.0;\n\t\tv = 1.0 - w;\n\n\t} else if( v < 0.0 ) {\n\n\t\tu = clamp( dot( p0, v10 ) / dot2( v10 ), 0.0, 1.0 );\n\t\tv = 0.0;\n\t\tw = 1.0 - u;\n\n\t} else if( w < 0.0 ) {\n\n\t\tv = clamp( dot( p1, v21 ) / dot2( v21 ), 0.0, 1.0 );\n\t\tw = 0.0;\n\t\tu = 1.0 - v;\n\n\t}\n\n\tbarycoord = vec3( u, v, w );\n    return u * v1 + v * v2 + w * v0;\n\n}\n\nfloat distanceToTriangles(\n\t// geometry info and triangle range\n\tsampler2D positionAttr, usampler2D indexAttr, uint offset, uint count,\n\n\t// point and cut off range\n\tvec3 point, float closestDistanceSquared,\n\n\t// outputs\n\tinout uvec4 faceIndices, inout vec3 faceNormal, inout vec3 barycoord, inout float side, inout vec3 outPoint\n) {\n\n\tbool found = false;\n\tvec3 localBarycoord;\n\tfor ( uint i = offset, l = offset + count; i < l; i ++ ) {\n\n\t\tuvec3 indices = uTexelFetch1D( indexAttr, i ).xyz;\n\t\tvec3 a = texelFetch1D( positionAttr, indices.x ).rgb;\n\t\tvec3 b = texelFetch1D( positionAttr, indices.y ).rgb;\n\t\tvec3 c = texelFetch1D( positionAttr, indices.z ).rgb;\n\n\t\t// get the closest point and barycoord\n\t\tvec3 closestPoint = closestPointToTriangle( point, a, b, c, localBarycoord );\n\t\tvec3 delta = point - closestPoint;\n\t\tfloat sqDist = dot2( delta );\n\t\tif ( sqDist < closestDistanceSquared ) {\n\n\t\t\t// set the output results\n\t\t\tclosestDistanceSquared = sqDist;\n\t\t\tfaceIndices = uvec4( indices.xyz, i );\n\t\t\tfaceNormal = normalize( cross( a - b, b - c ) );\n\t\t\tbarycoord = localBarycoord;\n\t\t\toutPoint = closestPoint;\n\t\t\tside = sign( dot( faceNormal, delta ) );\n\n\t\t}\n\n\t}\n\n\treturn closestDistanceSquared;\n\n}\n\nfloat distanceSqToBounds( vec3 point, vec3 boundsMin, vec3 boundsMax ) {\n\n\tvec3 clampedPoint = clamp( point, boundsMin, boundsMax );\n\tvec3 delta = point - clampedPoint;\n\treturn dot( delta, delta );\n\n}\n\nfloat distanceSqToBVHNodeBoundsPoint( vec3 point, sampler2D bvhBounds, uint currNodeIndex ) {\n\n\tuint cni2 = currNodeIndex * 2u;\n\tvec3 boundsMin = texelFetch1D( bvhBounds, cni2 ).xyz;\n\tvec3 boundsMax = texelFetch1D( bvhBounds, cni2 + 1u ).xyz;\n\treturn distanceSqToBounds( point, boundsMin, boundsMax );\n\n}\n\n// use a macro to hide the fact that we need to expand the struct into separate fields\n#define\tbvhClosestPointToPoint(\t\tbvh,\t\tpoint, maxDistance, faceIndices, faceNormal, barycoord, side, outPoint\t)\t_bvhClosestPointToPoint(\t\tbvh.position, bvh.index, bvh.bvhBounds, bvh.bvhContents,\t\tpoint, maxDistance, faceIndices, faceNormal, barycoord, side, outPoint\t)\n\nfloat _bvhClosestPointToPoint(\n\t// bvh info\n\tsampler2D bvh_position, usampler2D bvh_index, sampler2D bvh_bvhBounds, usampler2D bvh_bvhContents,\n\n\t// point to check\n\tvec3 point, float maxDistance,\n\n\t// output variables\n\tinout uvec4 faceIndices, inout vec3 faceNormal, inout vec3 barycoord,\n\tinout float side, inout vec3 outPoint\n ) {\n\n\t// stack needs to be twice as long as the deepest tree we expect because\n\t// we push both the left and right child onto the stack every traversal\n\tint ptr = 0;\n\tuint stack[ BVH_STACK_DEPTH ];\n\tstack[ 0 ] = 0u;\n\n\tfloat closestDistanceSquared = maxDistance * maxDistance;\n\tbool found = false;\n\twhile ( ptr > - 1 && ptr < BVH_STACK_DEPTH ) {\n\n\t\tuint currNodeIndex = stack[ ptr ];\n\t\tptr --;\n\n\t\t// check if we intersect the current bounds\n\t\tfloat boundsHitDistance = distanceSqToBVHNodeBoundsPoint( point, bvh_bvhBounds, currNodeIndex );\n\t\tif ( boundsHitDistance > closestDistanceSquared ) {\n\n\t\t\tcontinue;\n\n\t\t}\n\n\t\tuvec2 boundsInfo = uTexelFetch1D( bvh_bvhContents, currNodeIndex ).xy;\n\t\tbool isLeaf = bool( boundsInfo.x & 0xffff0000u );\n\t\tif ( isLeaf ) {\n\n\t\t\tuint count = boundsInfo.x & 0x0000ffffu;\n\t\t\tuint offset = boundsInfo.y;\n\t\t\tclosestDistanceSquared = distanceToTriangles(\n\t\t\t\tbvh_position, bvh_index, offset, count, point, closestDistanceSquared,\n\n\t\t\t\t// outputs\n\t\t\t\tfaceIndices, faceNormal, barycoord, side, outPoint\n\t\t\t);\n\n\t\t} else {\n\n\t\t\tuint leftIndex = currNodeIndex + 1u;\n\t\t\tuint splitAxis = boundsInfo.x & 0x0000ffffu;\n\t\t\tuint rightIndex = currNodeIndex + boundsInfo.y;\n\t\t\tbool leftToRight = distanceSqToBVHNodeBoundsPoint( point, bvh_bvhBounds, leftIndex ) < distanceSqToBVHNodeBoundsPoint( point, bvh_bvhBounds, rightIndex );//rayDirection[ splitAxis ] >= 0.0;\n\t\t\tuint c1 = leftToRight ? leftIndex : rightIndex;\n\t\t\tuint c2 = leftToRight ? rightIndex : leftIndex;\n\n\t\t\t// set c2 in the stack so we traverse it later. We need to keep track of a pointer in\n\t\t\t// the stack while we traverse. The second pointer added is the one that will be\n\t\t\t// traversed first\n\t\t\tptr ++;\n\t\t\tstack[ ptr ] = c2;\n\t\t\tptr ++;\n\t\t\tstack[ ptr ] = c1;\n\n\t\t}\n\n\t}\n\n\treturn sqrt( closestDistanceSquared );\n\n}\n",Mr="\n\n#ifndef TRI_INTERSECT_EPSILON\n#define TRI_INTERSECT_EPSILON 1e-5\n#endif\n\n// Raycasting\nbool intersectsBounds( vec3 rayOrigin, vec3 rayDirection, vec3 boundsMin, vec3 boundsMax, out float dist ) {\n\n\t// https://www.reddit.com/r/opengl/comments/8ntzz5/fast_glsl_ray_box_intersection/\n\t// https://tavianator.com/2011/ray_box.html\n\tvec3 invDir = 1.0 / rayDirection;\n\n\t// find intersection distances for each plane\n\tvec3 tMinPlane = invDir * ( boundsMin - rayOrigin );\n\tvec3 tMaxPlane = invDir * ( boundsMax - rayOrigin );\n\n\t// get the min and max distances from each intersection\n\tvec3 tMinHit = min( tMaxPlane, tMinPlane );\n\tvec3 tMaxHit = max( tMaxPlane, tMinPlane );\n\n\t// get the furthest hit distance\n\tvec2 t = max( tMinHit.xx, tMinHit.yz );\n\tfloat t0 = max( t.x, t.y );\n\n\t// get the minimum hit distance\n\tt = min( tMaxHit.xx, tMaxHit.yz );\n\tfloat t1 = min( t.x, t.y );\n\n\t// set distance to 0.0 if the ray starts inside the box\n\tdist = max( t0, 0.0 );\n\n\treturn t1 >= dist;\n\n}\n\nbool intersectsTriangle(\n\tvec3 rayOrigin, vec3 rayDirection, vec3 a, vec3 b, vec3 c,\n\tout vec3 barycoord, out vec3 norm, out float dist, out float side\n) {\n\n\t// https://stackoverflow.com/questions/42740765/intersection-between-line-and-triangle-in-3d\n\tvec3 edge1 = b - a;\n\tvec3 edge2 = c - a;\n\tnorm = cross( edge1, edge2 );\n\n\tfloat det = - dot( rayDirection, norm );\n\tfloat invdet = 1.0 / det;\n\n\tvec3 AO = rayOrigin - a;\n\tvec3 DAO = cross( AO, rayDirection );\n\n\tvec4 uvt;\n\tuvt.x = dot( edge2, DAO ) * invdet;\n\tuvt.y = - dot( edge1, DAO ) * invdet;\n\tuvt.z = dot( AO, norm ) * invdet;\n\tuvt.w = 1.0 - uvt.x - uvt.y;\n\n\t// set the hit information\n\tbarycoord = uvt.wxy; // arranged in A, B, C order\n\tdist = uvt.z;\n\tside = sign( det );\n\tnorm = side * normalize( norm );\n\n\t// add an epsilon to avoid misses between triangles\n\tuvt += vec4( TRI_INTERSECT_EPSILON );\n\n\treturn all( greaterThanEqual( uvt, vec4( 0.0 ) ) );\n\n}\n\nbool intersectTriangles(\n\t// geometry info and triangle range\n\tsampler2D positionAttr, usampler2D indexAttr, uint offset, uint count,\n\n\t// ray\n\tvec3 rayOrigin, vec3 rayDirection,\n\n\t// outputs\n\tinout float minDistance, inout uvec4 faceIndices, inout vec3 faceNormal, inout vec3 barycoord,\n\tinout float side, inout float dist\n) {\n\n\tbool found = false;\n\tvec3 localBarycoord, localNormal;\n\tfloat localDist, localSide;\n\tfor ( uint i = offset, l = offset + count; i < l; i ++ ) {\n\n\t\tuvec3 indices = uTexelFetch1D( indexAttr, i ).xyz;\n\t\tvec3 a = texelFetch1D( positionAttr, indices.x ).rgb;\n\t\tvec3 b = texelFetch1D( positionAttr, indices.y ).rgb;\n\t\tvec3 c = texelFetch1D( positionAttr, indices.z ).rgb;\n\n\t\tif (\n\t\t\tintersectsTriangle( rayOrigin, rayDirection, a, b, c, localBarycoord, localNormal, localDist, localSide )\n\t\t\t&& localDist < minDistance\n\t\t) {\n\n\t\t\tfound = true;\n\t\t\tminDistance = localDist;\n\n\t\t\tfaceIndices = uvec4( indices.xyz, i );\n\t\t\tfaceNormal = localNormal;\n\n\t\t\tside = localSide;\n\t\t\tbarycoord = localBarycoord;\n\t\t\tdist = localDist;\n\n\t\t}\n\n\t}\n\n\treturn found;\n\n}\n\nbool intersectsBVHNodeBounds( vec3 rayOrigin, vec3 rayDirection, sampler2D bvhBounds, uint currNodeIndex, out float dist ) {\n\n\tuint cni2 = currNodeIndex * 2u;\n\tvec3 boundsMin = texelFetch1D( bvhBounds, cni2 ).xyz;\n\tvec3 boundsMax = texelFetch1D( bvhBounds, cni2 + 1u ).xyz;\n\treturn intersectsBounds( rayOrigin, rayDirection, boundsMin, boundsMax, dist );\n\n}\n\n// use a macro to hide the fact that we need to expand the struct into separate fields\n#define\tbvhIntersectFirstHit(\t\tbvh,\t\trayOrigin, rayDirection, faceIndices, faceNormal, barycoord, side, dist\t)\t_bvhIntersectFirstHit(\t\tbvh.position, bvh.index, bvh.bvhBounds, bvh.bvhContents,\t\trayOrigin, rayDirection, faceIndices, faceNormal, barycoord, side, dist\t)\n\nbool _bvhIntersectFirstHit(\n\t// bvh info\n\tsampler2D bvh_position, usampler2D bvh_index, sampler2D bvh_bvhBounds, usampler2D bvh_bvhContents,\n\n\t// ray\n\tvec3 rayOrigin, vec3 rayDirection,\n\n\t// output variables split into separate variables due to output precision\n\tinout uvec4 faceIndices, inout vec3 faceNormal, inout vec3 barycoord,\n\tinout float side, inout float dist\n) {\n\n\t// stack needs to be twice as long as the deepest tree we expect because\n\t// we push both the left and right child onto the stack every traversal\n\tint ptr = 0;\n\tuint stack[ BVH_STACK_DEPTH ];\n\tstack[ 0 ] = 0u;\n\n\tfloat triangleDistance = INFINITY;\n\tbool found = false;\n\twhile ( ptr > - 1 && ptr < BVH_STACK_DEPTH ) {\n\n\t\tuint currNodeIndex = stack[ ptr ];\n\t\tptr --;\n\n\t\t// check if we intersect the current bounds\n\t\tfloat boundsHitDistance;\n\t\tif (\n\t\t\t! intersectsBVHNodeBounds( rayOrigin, rayDirection, bvh_bvhBounds, currNodeIndex, boundsHitDistance )\n\t\t\t|| boundsHitDistance > triangleDistance\n\t\t) {\n\n\t\t\tcontinue;\n\n\t\t}\n\n\t\tuvec2 boundsInfo = uTexelFetch1D( bvh_bvhContents, currNodeIndex ).xy;\n\t\tbool isLeaf = bool( boundsInfo.x & 0xffff0000u );\n\n\t\tif ( isLeaf ) {\n\n\t\t\tuint count = boundsInfo.x & 0x0000ffffu;\n\t\t\tuint offset = boundsInfo.y;\n\n\t\t\tfound = intersectTriangles(\n\t\t\t\tbvh_position, bvh_index, offset, count,\n\t\t\t\trayOrigin, rayDirection, triangleDistance,\n\t\t\t\tfaceIndices, faceNormal, barycoord, side, dist\n\t\t\t) || found;\n\n\t\t} else {\n\n\t\t\tuint leftIndex = currNodeIndex + 1u;\n\t\t\tuint splitAxis = boundsInfo.x & 0x0000ffffu;\n\t\t\tuint rightIndex = currNodeIndex + boundsInfo.y;\n\n\t\t\tbool leftToRight = rayDirection[ splitAxis ] >= 0.0;\n\t\t\tuint c1 = leftToRight ? leftIndex : rightIndex;\n\t\t\tuint c2 = leftToRight ? rightIndex : leftIndex;\n\n\t\t\t// set c2 in the stack so we traverse it later. We need to keep track of a pointer in\n\t\t\t// the stack while we traverse. The second pointer added is the one that will be\n\t\t\t// traversed first\n\t\t\tptr ++;\n\t\t\tstack[ ptr ] = c2;\n\n\t\t\tptr ++;\n\t\t\tstack[ ptr ] = c1;\n\n\t\t}\n\n\t}\n\n\treturn found;\n\n}\n",Pr="\nstruct BVH {\n\n\tusampler2D index;\n\tsampler2D position;\n\n\tsampler2D bvhBounds;\n\tusampler2D bvhContents;\n\n};\n";var Br=Object.freeze({__proto__:null,bvh_distance_functions:Rr,bvh_ray_functions:Mr,bvh_struct_definitions:Pr,common_functions:Er});const Lr=Pr,Or=Rr,Dr=`\n\t${Er}\n\t${Mr}\n`;var Ur=Object.freeze({__proto__:null,AVERAGE:wt,BVHShaderGLSL:Br,CENTER:Tt,CONTAINED:Ct,ExtendedTriangle:ExtendedTriangle,FloatVertexAttributeTexture:FloatVertexAttributeTexture,INTERSECTED:1,IntVertexAttributeTexture:class extends VertexAttributeTexture{constructor(){super(),this._forcedType=$}},MeshBVH:MeshBVH,MeshBVHHelper:MeshBVHHelper,MeshBVHUniformStruct:class{constructor(){this.index=new UIntVertexAttributeTexture,this.position=new FloatVertexAttributeTexture,this.bvhBounds=new V,this.bvhContents=new V,this._cachedIndexAttr=null,this.index.overrideItemSize=3}updateFrom(r){const{geometry:x}=r;if(function(r,x,b){const S=r._roots;if(1!==S.length)throw new Error("MeshBVHUniformStruct: Multi-root BVHs not supported.");const C=S[0],I=new Uint16Array(C),A=new Uint32Array(C),R=new Float32Array(C),B=C.byteLength/At,D=2*Math.ceil(Math.sqrt(B/2)),F=new Float32Array(4*D*D),G=Math.ceil(Math.sqrt(B)),N=new Uint32Array(2*G*G);for(let r=0;r<B;r++){const x=r*At/4,b=2*x,S=x;for(let x=0;x<3;x++)F[8*r+0+x]=R[S+0+x],F[8*r+4+x]=R[S+3+x];if(IS_LEAF(b,I)){const S=COUNT(b,I),C=OFFSET(x,A),R=Mt|S;N[2*r+0]=R,N[2*r+1]=C}else{const b=A[x+6],S=SPLIT_AXIS(x,A);N[2*r+0]=S,N[2*r+1]=b}}x.image.data=F,x.image.width=D,x.image.height=D,x.format=Y,x.type=K,x.internalFormat="RGBA32F",x.minFilter=X,x.magFilter=X,x.generateMipmaps=!1,x.needsUpdate=!0,x.dispose(),b.image.data=N,b.image.width=G,b.image.height=G,b.format=Z,b.type=q,b.internalFormat="RG32UI",b.minFilter=X,b.magFilter=X,b.generateMipmaps=!1,b.needsUpdate=!0,b.dispose()}(r,this.bvhBounds,this.bvhContents),this.position.updateFrom(x.attributes.position),r.indirect){const b=r._indirectBuffer;if(null===this._cachedIndexAttr||this._cachedIndexAttr.count!==b.length)if(x.index)this._cachedIndexAttr=x.index.clone();else{const r=getIndexArray(getVertexCount(x));this._cachedIndexAttr=new D(r,1,!1)}!function(r,x,b){const S=b.array,C=r.index?r.index.array:null;for(let r=0,b=x.length;r<b;r++){const b=3*r,I=3*x[r];for(let r=0;r<3;r++)S[b+r]=C?C[I+r]:I+r}}(x,b,this._cachedIndexAttr),this.index.updateFrom(this._cachedIndexAttr)}else this.index.updateFrom(x.index)}dispose(){const{index:r,position:x,bvhBounds:b,bvhContents:S}=this;r&&r.dispose(),x&&x.dispose(),b&&b.dispose(),S&&S.dispose()}},NOT_INTERSECTED:0,OrientedBox:OrientedBox,SAH:St,StaticGeometryGenerator:StaticGeometryGenerator,UIntVertexAttributeTexture:UIntVertexAttributeTexture,VertexAttributeTexture:VertexAttributeTexture,acceleratedRaycast:function(r,x){this.isBatchedMesh?acceleratedBatchedMeshRaycast.call(this,r,x):acceleratedMeshRaycast.call(this,r,x)},computeBatchedBoundsTree:function(r=-1,x={}){if(!hr)throw new Error("BatchedMesh: Three r166+ is required to compute bounds trees.");x={...x,range:null};const b=this._drawRanges||this._geometryInfo,S=this._geometryCount;this.boundsTrees||(this.boundsTrees=new Array(S).fill(null));const C=this.boundsTrees;for(;C.length<S;)C.push(null);if(r<0){for(let r=0;r<S;r++)x.range=b[r],C[r]=new MeshBVH(this.geometry,x);return C}return r<b.length&&(x.range=b[r],C[r]=new MeshBVH(this.geometry,x)),C[r]||null},computeBoundsTree:function(r={}){return this.boundsTree=new MeshBVH(this,r),this.boundsTree},disposeBatchedBoundsTree:function(r=-1){r<0?this.boundsTrees.fill(null):r<this.boundsTrees.length&&(this.boundsTrees[r]=null)},disposeBoundsTree:function(){this.boundsTree=null},estimateMemoryInBytes:function(r){const x=new Set,b=[r];let S=0;for(;b.length;){const r=b.pop();if(!x.has(r)){x.add(r);for(let x in r){if(!Object.hasOwn(r,x))continue;S+=getPrimitiveSize(x);const C=r[x];!C||"object"!=typeof C&&"function"!=typeof C?S+=getPrimitiveSize(C):/(Uint|Int|Float)(8|16|32)Array/.test(C.constructor.name)||isSharedArrayBufferSupported()&&C instanceof SharedArrayBuffer||C instanceof ArrayBuffer?S+=C.byteLength:b.push(C)}}}return S},getBVHExtremes:function(r){return r._roots.map(((x,b)=>function(r,x){const b={nodeCount:0,leafNodeCount:0,depth:{min:1/0,max:-1/0},tris:{min:1/0,max:-1/0},splits:[0,0,0],surfaceAreaScore:0};return r.traverse(((r,x,S,C,I)=>{const A=S[3]-S[0],R=S[4]-S[1],B=S[5]-S[2],D=2*(A*R+R*B+B*A);b.nodeCount++,x?(b.leafNodeCount++,b.depth.min=Math.min(r,b.depth.min),b.depth.max=Math.max(r,b.depth.max),b.tris.min=Math.min(I,b.tris.min),b.tris.max=Math.max(I,b.tris.max),b.surfaceAreaScore+=D*It*I):(b.splits[C]++,b.surfaceAreaScore+=D*kt)}),x),b.tris.min===1/0&&(b.tris.min=0,b.tris.max=0),b.depth.min===1/0&&(b.depth.min=0,b.depth.max=0),b}(r,b)))},getJSONStructure:function(r){const x=[];return r.traverse(((r,b,S,C,I)=>{const A={bounds:arrayToBox(0,S,new F)};b?(A.count=I,A.offset=C):(A.left=null,A.right=null),x[r]=A;const R=x[r-1];R&&(null===R.left?R.left=A:R.right=A)})),x[0]},getTriangleHitPointInfo:function(r,b,S,I){const A=b.getIndex().array,B=b.getAttribute("position"),D=b.getAttribute("uv"),F=A[3*S],G=A[3*S+1],N=A[3*S+2];fn.fromBufferAttribute(B,F),gn.fromBufferAttribute(B,G),mn.fromBufferAttribute(B,N);let H=0;const W=b.groups,j=3*S;for(let r=0,x=W.length;r<x;r++){const x=W[r],{start:b,count:S}=x;if(j>=b&&j<b+S){H=x.materialIndex;break}}const V=I&&I.barycoord?I.barycoord:new x;C.getBarycoord(r,fn,gn,mn,V);let X=null;return D&&(_n.fromBufferAttribute(D,F),yn.fromBufferAttribute(D,G),vn.fromBufferAttribute(D,N),X=I&&I.uv?I.uv:new R,C.getInterpolation(r,fn,gn,mn,_n,yn,vn,X)),I?(I.face||(I.face={}),I.face.a=F,I.face.b=G,I.face.c=N,I.face.materialIndex=H,I.face.normal||(I.face.normal=new x),C.getNormal(fn,gn,mn,I.face.normal),X&&(I.uv=X),I.barycoord=V,I):{face:{a:F,b:G,c:N,materialIndex:H,normal:C.getNormal(fn,gn,mn,new x)},uv:X,barycoord:V}},shaderDistanceFunction:Or,shaderIntersectFunction:Dr,shaderStructs:Lr,validateBounds:function(r){const x=r.geometry,b=[],S=x.index,C=x.getAttribute("position");let I=!0;return r.traverse(((x,A,R,B,D)=>{const F={depth:x,isLeaf:A,boundingData:R,offset:B,count:D};b[x]=F,arrayToBox(0,R,ar);const G=b[x-1];if(A)for(let x=B,b=B+D;x<b;x++){const b=r.resolveTriangleIndex(x);let A,R=3*b,B=3*b+1,D=3*b+2;S&&(R=S.getX(R),B=S.getX(B),D=S.getX(D)),cr.fromBufferAttribute(C,R),A=ar.containsPoint(cr),cr.fromBufferAttribute(C,B),A=A&&ar.containsPoint(cr),cr.fromBufferAttribute(C,D),A=A&&ar.containsPoint(cr),console.assert(A,"Leaf bounds does not fully contain triangle."),I=I&&A}if(G){arrayToBox(0,R,lr);const r=lr.containsBox(ar);console.assert(r,"Parent bounds does not fully contain child."),I=I&&r}})),I}});const numberOr=(r,x)=>"number"==typeof r?r:x,capitalizeFirstLetter=r=>r.charAt(0).toUpperCase()+r.slice(1),isDescendant=(r,x)=>{for(;x?.parent;){if(x.parent==r)return!0;x=x.parent}return!1},cartesianToPolar=(r,x)=>[Math.sqrt(r*r+x*x),Math.atan2(x,r)],polarToCartesian=(r,x)=>[r*Math.cos(x),r*Math.sin(x)],radiansToDegrees=r=>(r+Math.PI)/(2*Math.PI)*360;function hueToRGB(r,x,b){return b<0&&(b+=1),b>1&&(b-=1),b<1/6?r+6*(x-r)*b:b<.5?x:b<2/3?r+(x-r)*(2/3-b)*6:r}const hslToRGB=(r,x,b)=>{let S,C,I;if(r/=360,0==x)S=C=I=b;else{let A=b<.5?b*(1+x):b+x-b*x,R=2*b-A;S=hueToRGB(R,A,r+1/3),C=hueToRGB(R,A,r),I=hueToRGB(R,A,r-1/3)}return[Math.round(255*S),Math.round(255*C),Math.round(255*I)]},rgbToHex=(r,x,b)=>r<<16^x<<8^b<<0;function containsGeometry(r){if(r.geometry)return!0;for(let x of r.children)if(containsGeometry(x))return!0;return!1}const setupBVHForComplexObject=r=>{if(!containsGeometry(r))return!1;if(r.parent){let x=r.parent;x.remove(r),r.updateMatrixWorld(!0),x.add(r)}if(r.children?.length){r.staticGeometryGenerator=new StaticGeometryGenerator([r]);try{r.bvhGeometry=r.staticGeometryGenerator.generate()}catch(r){return console.error(r),!1}}else r.bvhGeometry=r.geometry;return r.bvhGeometry.computeBoundsTree(),r.parent&&r.updateMatrixWorld(!0),!0},updateBVHForComplexObject=r=>{if(!r.staticGeometryGenerator)return setupBVHForComplexObject(r);if(r.parent){let x=r.parent;x.remove(r),r.updateMatrixWorld(!0),x.add(r)}r.staticGeometryGenerator.generate(r.bvhGeometry),r.bvhGeometry.boundsTree.refit(),r.parent&&r.updateMatrixWorld(!0)};var Fr=Object.freeze({__proto__:null,addBVHHelper:x=>{if(x.bvhGeometry&&x.geomtry==x.bvhGeometry)return void x.parent.add(new MeshBVHHelper(x));let b=new r.MeshBasicMaterial({wireframe:!0,transparent:!0,opacity:.05,depthWrite:!1}),S=new r.Mesh(x.bvhGeometry,b);x.parent.add(S);let C=new MeshBVHHelper(S,10);x.parent.add(C),x.bvhHelper=C},capitalizeFirstLetter:capitalizeFirstLetter,cartesianToPolar:cartesianToPolar,hslToRGB:hslToRGB,isDescendant:isDescendant,numberOr:numberOr,polarToCartesian:polarToCartesian,radiansToDegrees:radiansToDegrees,rgbToHex:rgbToHex,setupBVHForComplexObject:setupBVHForComplexObject,updateBVHForComplexObject:updateBVHForComplexObject});const Gr=new r.Matrix4;class TouchInteractable extends Interactable{constructor(r){super(r),this._target1={},this._target2={},this._targets=[this._target1,this._target2],r&&(r.touchInteractable=this,r.bvhGeometry||setupBVHForComplexObject(r)),this._createBoundingObject()}_createBoundingObject(){this._boundingBox=new r.Box3}_getBoundingObject(){return this._boundingBox.setFromObject(this._object),this._boundingBox}intersectsSphere(r){let x,b=this._getBoundingObject();return x=!!b&&r.intersectsBox(b),x}intersectsObject(r){if(r?.bvhGeometry?.boundsTree&&(this._object?.bvhGeometry?.boundsTree||setupBVHForComplexObject(this._object)))return Gr.copy(this._object.matrixWorld).invert().multiply(r.matrixWorld),this._object.bvhGeometry.boundsTree.intersectsGeometry(r.bvhGeometry,Gr)}getClosestPointTo(r){if(r.model&&(r=r.model),!r?.bvhGeometry?.boundsTree)return;if(!this._object?.bvhGeometry?.boundsTree)return;return Gr.copy(this._object.matrixWorld).invert().multiply(r.matrixWorld),this._object.bvhGeometry.boundsTree.closestPointToGeometry(r.bvhGeometry,Gr,this._target1,this._target2)?(this._target2.object=r,this._targets):void 0}get object(){return this._object}set object(r){this._object=r,r&&(r.touchInteractable=this)}}let Nr=new r.Color,Hr=new r.Matrix4,Wr=1;const emptyFunc=()=>{};let zr=new class{constructor(){this._idMap={},this._geometries={},this._clippedParents=new Map,this._pendingPositionUpdates=new Set,this._pendingPointerListenerUpdates=new Set,this._pendingTouchListenerUpdates=new Set}registerLayoutComponentClass(r){this._layoutComponentClass=r}createBackground(x,b,S,C,I,A,R,B,D){let F=[b,S,C,I,A,R],G=F.join(":");F.push(B);let N=F.join(":"),H=this._getClosestAncestorWithHiddenOverflow(x);if(!H)return;this._clippedParents.has(H)||this._clippedParents.set(H,{});let W=this._clippedParents.get(H),j=W[N];if(!j){let D=this._geometries[G];if(!D){let B=x.createShape(S,b,C,I,A,R);D=new r.ShapeGeometry(B),this._geometries[G]=D,D.computeBoundsTree()}let F=new r.MeshBasicMaterial({color:16777215,side:r.DoubleSide,transparent:!0,polygonOffset:!0,polygonOffsetFactor:-1*B,polygonOffsetUnits:-1*B});F.clippingPlanes=H.material.clippingPlanes,j=new r.InstancedMesh(D,F,16),W[N]=j,j.isUIManagedInstancedMesh=!0,j.maxCount=16,j.count=0,j.ids=[],this._createInteractables(j,x,H),H.add(j)}if(j.count==j.maxCount){let x=j,b=x.maxCount+Math.min(x.maxCount,64);j=new r.InstancedMesh(x.geometry,x.material,b),j.isUIManagedInstancedMesh=!0,j.maxCount=b,j.count=x.count,j.ids=x.ids,x.pointerInteractable.object=j,x.touchInteractable.object=j;for(let r=0;r<j.count;r++)x.getColorAt(r,Nr),x.getMatrixAt(r,Hr),j.setColorAt(r,Nr),j.setMatrixAt(r,Hr),j.instanceColor.needsUpdate=!0,j.instanceMatrix.needsUpdate=!0;for(let r of j.ids)this._idMap[r].instancedMesh=j;x.parent&&(x.parent.add(j),x.parent.remove(x)),x.dispose(),W[N]=j}else 0==j.count&&H.add(j);let V=Wr,X=j.count;return j.ids.push(V),this._idMap[V]={ancestor:H,component:x,instancedMesh:j,index:X},j.count++,Wr++,this.setPositionFrom(V),this.setColorFrom(V),this.checkAddPointerInteractableListener(V),this.checkAddTouchInteractableListener(V),V}_createInteractables(r,x,b){let S=new PointerInteractable(r),C=new TouchInteractable(r);b.pointerInteractable.addChild(S),b.touchInteractable.addChild(C)}checkAddPointerInteractableListener(r){let{instancedMesh:x,component:b}=this._idMap[r];x&&x.pointerInteractable.isOnlyGroup()&&!b.pointerInteractable.isOnlyGroup()&&x.pointerInteractable.addEventListener("click",emptyFunc)}checkAddTouchInteractableListener(r){let{instancedMesh:x,component:b}=this._idMap[r];x&&x.touchInteractable.isOnlyGroup()&&!b.touchInteractable.isOnlyGroup()&&x.touchInteractable.addEventListener("click",emptyFunc)}checkRemovePointerInteractableListener(r){let x=this._idMap[r]?.instancedMesh;x&&this._pendingPointerListenerUpdates.add(x)}checkRemoveTouchInteractableListener(r){let x=this._idMap[r]?.instancedMesh;x&&this._pendingTouchListenerUpdates.add(x)}_checkRemovePointerInteractableListener(r){for(let x of r.ids){if(r!=this._idMap[x].instancedMesh)return;if(!this._idMap[x].component.pointerInteractable.isOnlyGroup())return}r.pointerInteractable.removeEventListener("click",emptyFunc)}_checkRemoveTouchInteractableListener(r){for(let x of r.ids){if(r!=this._idMap[x].instancedMesh)return;if(!this._idMap[x].component.touchInteractable.isOnlyGroup())return}r.touchInteractable.removeEventListener("click",emptyFunc)}setPositionFrom(r){this._pendingPositionUpdates.add(r)}_setPositionFrom(r){let x=this._idMap[r];if(!x)return;let b=x.component;b.updateWorldMatrix(!0,!1),Hr.copy(x.ancestor._content.matrixWorld).invert(),Hr.multiply(b.matrixWorld),x.instancedMesh.setMatrixAt(x.index,Hr),x.instancedMesh.instanceMatrix.needsUpdate=!0}setColorFrom(r){let x=this._idMap[r];x&&(Nr.set(x.component.materialColor||"#ffffff"),x.instancedMesh.setColorAt(x.index,Nr),x.instancedMesh.instanceColor.needsUpdate=!0)}_getClosestAncestorWithHiddenOverflow(r){for(;r instanceof this._layoutComponentClass;){if("visible"!=r.overflow||"Body"==r.constructor.name)return r;r=r.parentComponent}return null}getComponent(r){return this._idMap[r]?.component}remove(r){let x=this._idMap[r];if(!x)return;let{index:b,instancedMesh:S,component:C,ancestor:I}=x,A=S.count-1;if(b!=A){S.getColorAt(A,Nr),S.getMatrixAt(A,Hr),S.setColorAt(b,Nr),S.setMatrixAt(b,Hr);let r=S.ids[A];S.ids[b]=r,this._idMap[r].index=b}S.count--,S.ids.pop(),0==S.count&&I.remove(S),delete this._idMap[r]}_updatePositions(){let r=new Set;for(let x of this._pendingPositionUpdates){this._setPositionFrom(x);let b=this._idMap[x]?.instancedMesh;b&&r.add(b)}this._pendingPositionUpdates.clear();for(let x of r)x.geometry.computeBoundsTree(),x.computeBoundingSphere(),x.computeBoundingBox()}_updateInteractableListeners(){for(let r of this._pendingPointerListenerUpdates)this._checkRemovePointerInteractableListener(r);this._pendingPointerListenerUpdates.clear();for(let r of this._pendingTouchListenerUpdates)r&&this._checkRemoveTouchInteractableListener(r);this._pendingTouchListenerUpdates.clear()}update(){this._updatePositions(),this._updateInteractableListeners()}};class Style{constructor(r={}){this._listeners=new Set;for(let x of Style.PROPERTIES)x in r&&(this["_"+x]=r[x])}addUpdateListener(r){this._listeners.add(r)}removeUpdateListener(r){this._listeners.delete(r)}_genericGet(r){return this["_"+r]}_genericSet(r,x){this["_"+r]=x;for(let x of this._listeners)x(r)}get alignItems(){return this._genericGet("alignItems")}get backgroundVisible(){return this._genericGet("backgroundVisible")}get borderMaterial(){return this._genericGet("borderMaterial")}get borderRadius(){return this._genericGet("borderRadius")}get borderBottomLeftRadius(){return this._genericGet("borderBottomLeftRadius")}get borderBottomRightRadius(){return this._genericGet("borderBottomRightRadius")}get borderTopLeftRadius(){return this._genericGet("borderTopLeftRadius")}get borderTopRightRadius(){return this._genericGet("borderTopRightRadius")}get borderWidth(){return this._genericGet("borderWidth")}get color(){return this._genericGet("color")}get contentDirection(){return this._genericGet("contentDirection")}get font(){return this._genericGet("font")}get fontSize(){return this._genericGet("fontSize")}get glassmorphism(){return this._genericGet("glassmorphism")}get height(){return this._genericGet("height")}get instanced(){return this._genericGet("instanced")}get justifyContent(){return this._genericGet("justifyContent")}get margin(){return this._genericGet("margin")}get marginBottom(){return this._genericGet("marginBottom")}get marginLeft(){return this._genericGet("marginLeft")}get marginRight(){return this._genericGet("marginRight")}get marginTop(){return this._genericGet("marginTop")}get material(){return this._genericGet("material")}get materialColor(){return this._genericGet("materialColor")}get maxHeight(){return this._genericGet("maxHeight")}get maxWidth(){return this._genericGet("maxWidth")}get minHeight(){return this._genericGet("minHeight")}get minWidth(){return this._genericGet("minWidth")}get opacity(){return this._genericGet("opacity")}get overflow(){return this._genericGet("overflow")}get padding(){return this._genericGet("padding")}get paddingBottom(){return this._genericGet("paddingBottom")}get paddingLeft(){return this._genericGet("paddingLeft")}get paddingRight(){return this._genericGet("paddingRight")}get paddingTop(){return this._genericGet("paddingTop")}get pointerInteractableClassOverride(){return this._genericGet("pointerInteractableClassOverride")}get textAlign(){return this._genericGet("textAlign")}get textureFit(){return this._genericGet("textureFit")}get width(){return this._genericGet("width")}set alignItems(r){this._genericSet("alignItems",r)}set backgroundVisible(r){this._genericSet("backgroundVisible",r)}set borderMaterial(r){this._genericSet("borderMaterial",r)}set borderRadius(r){this._genericSet("borderRadius",r)}set borderBottomLeftRadius(r){this._genericSet("borderBottomLeftRadius",r)}set borderBottomRightRadius(r){this._genericSet("borderBottomRightRadius",r)}set borderTopLeftRadius(r){this._genericSet("borderTopLeftRadius",r)}set borderTopRightRadius(r){this._genericSet("borderTopRightRadius",r)}set borderWidth(r){this._genericSet("borderWidth",r)}set color(r){this._genericSet("color",r)}set contentDirection(r){this._genericSet("contentDirection",r)}set font(r){this._genericSet("font",r)}set fontSize(r){this._genericSet("fontSize",r)}set glassmorphism(r){this._genericSet("glassmorphism",r)}set height(r){this._genericSet("height",r)}set instanced(r){this._genericSet("instanced",r)}set justifyContent(r){this._genericSet("justifyContent",r)}set margin(r){this._genericSet("margin",r)}set marginBottom(r){this._genericSet("marginBottom",r)}set marginLeft(r){this._genericSet("marginLeft",r)}set marginRight(r){this._genericSet("marginRight",r)}set marginTop(r){this._genericSet("marginTop",r)}set material(r){this._genericSet("material",r)}set materialColor(r){this._genericSet("materialColor",r)}set maxHeight(r){this._genericSet("maxHeight",r)}set maxWidth(r){this._genericSet("maxWidth",r)}set minHeight(r){this._genericSet("minHeight",r)}set minWidth(r){this._genericSet("minWidth",r)}set opacity(r){this._genericSet("opacity",r)}set overflow(r){this._genericSet("overflow",r)}set padding(r){this._genericSet("padding",r)}set paddingBottom(r){this._genericSet("paddingBottom",r)}set paddingLeft(r){this._genericSet("paddingLeft",r)}set paddingRight(r){this._genericSet("paddingRight",r)}set paddingTop(r){this._genericSet("paddingTop",r)}set pointerInteractableClassOverride(r){this._genericSet("pointerInteractableClassOverride",r)}set textAlign(r){this._genericSet("textAlign",r)}set textureFit(r){this._genericSet("textureFit",r)}set width(r){this._genericSet("width",r)}static PROPERTIES=["alignItems","backgroundVisible","borderMaterial","borderRadius","borderBottomLeftRadius","borderBottomRightRadius","borderTopLeftRadius","borderTopRightRadius","borderWidth","color","contentDirection","font","fontSize","glassmorphism","height","instanced","justifyContent","margin","marginBottom","marginLeft","marginRight","marginTop","material","materialColor","maxHeight","maxWidth","minHeight","minWidth","padding","paddingBottom","paddingLeft","paddingRight","paddingTop","pointerInteractableClassOverride","opacity","overflow","textAlign","textureFit","width"]}class UIComponent extends r.Object3D{constructor(...r){super(),r=Array.from(new Set(r)),this._styles=[],this._needsUpdate={},this._overrideStyle={},this._latestValue={},this._defaults={},this._styleListener=r=>this._onStyleChange(r);for(let x of r)x&&(x instanceof Style||(x=new Style(x)),this._styles.push(x),x.addUpdateListener(this._styleListener))}addStyle(r){let x=!1;for(let b=this._styles.length-1;b>=0;b--)r==this._styles[b]&&(this._styles.splice(b,1),x=!0);this._styles.push(r);for(let x of Style.PROPERTIES)null!=r[x]&&this._onStyleChange(x);x||r.addUpdateListener(this._styleListener)}_onStyleChange(r){this._needsUpdate[r]=!0;let x="_handleStyleUpdateFor"+capitalizeFirstLetter(r);x in this&&this[x]()}removeStyle(r){let x=!1;for(let b=this._styles.length-1;b>=0;b--)r==this._styles[b]&&(this._styles.splice(b,1),x=!0);if(x){for(let x of Style.PROPERTIES)null!=r[x]&&this._onStyleChange(x);r.removeUpdateListener(this._styleListener)}}_genericGet(r){if(r in this._overrideStyle)return this._overrideStyle[r];if(!this._needsUpdate[r]&&null!=this._latestValue[r])return this._latestValue[r];for(let x=this._styles.length-1;x>=0;x--){let b=this._styles[x][r];if(null!=b)return this._needsUpdate[r]=!1,this._latestValue[r]=b,b}return this._needsUpdate[r]=!1,this._latestValue[r]=this._defaults[r],this._defaults[r]}_genericSet(r,x){null==x?delete this._overrideStyle[r]:this._overrideStyle[r]=x;let b="_handleStyleUpdateFor"+capitalizeFirstLetter(r);b in this&&this[b]()}get alignItems(){return this._genericGet("alignItems")}get backgroundVisible(){return this._genericGet("backgroundVisible")}get borderMaterial(){return this._genericGet("borderMaterial")}get borderRadius(){return this._genericGet("borderRadius")}get borderBottomLeftRadius(){return this._genericGet("borderBottomLeftRadius")}get borderBottomRightRadius(){return this._genericGet("borderBottomRightRadius")}get borderTopLeftRadius(){return this._genericGet("borderTopLeftRadius")}get borderTopRightRadius(){return this._genericGet("borderTopRightRadius")}get borderWidth(){return this._genericGet("borderWidth")}get color(){return this._genericGet("color")}get contentDirection(){return this._genericGet("contentDirection")}get font(){return this._genericGet("font")}get fontSize(){return this._genericGet("fontSize")}get glassmorphism(){return this._genericGet("glassmorphism")}get height(){return this._genericGet("height")}get instanced(){return this._genericGet("instanced")}get justifyContent(){return this._genericGet("justifyContent")}get margin(){return this._genericGet("margin")}get marginBottom(){return this._genericGet("marginBottom")}get marginLeft(){return this._genericGet("marginLeft")}get marginRight(){return this._genericGet("marginRight")}get marginTop(){return this._genericGet("marginTop")}get material(){return this._genericGet("material")}get materialColor(){return this._genericGet("materialColor")}get maxHeight(){return this._genericGet("maxHeight")}get maxWidth(){return this._genericGet("maxWidth")}get minHeight(){return this._genericGet("minHeight")}get minWidth(){return this._genericGet("minWidth")}get opacity(){return this._genericGet("opacity")}get overflow(){return this._genericGet("overflow")}get padding(){return this._genericGet("padding")}get paddingBottom(){return this._genericGet("paddingBottom")}get paddingLeft(){return this._genericGet("paddingLeft")}get paddingRight(){return this._genericGet("paddingRight")}get paddingTop(){return this._genericGet("paddingTop")}get pointerInteractableClassOverride(){return this._genericGet("pointerInteractableClassOverride")}get textAlign(){return this._genericGet("textAlign")}get textureFit(){return this._genericGet("textureFit")}get width(){return this._genericGet("width")}set alignItems(r){this._genericSet("alignItems",r)}set backgroundVisible(r){this._genericSet("backgroundVisible",r)}set borderMaterial(r){this._genericSet("borderMaterial",r)}set borderRadius(r){this._genericSet("borderRadius",r)}set borderBottomLeftRadius(r){this._genericSet("borderBottomLeftRadius",r)}set borderBottomRightRadius(r){this._genericSet("borderBottomRightRadius",r)}set borderTopLeftRadius(r){this._genericSet("borderTopLeftRadius",r)}set borderTopRightRadius(r){this._genericSet("borderTopRightRadius",r)}set borderWidth(r){this._genericSet("borderWidth",r)}set color(r){this._genericSet("color",r)}set contentDirection(r){this._genericSet("contentDirection",r)}set font(r){this._genericSet("font",r)}set fontSize(r){this._genericSet("fontSize",r)}set glassmorphism(r){this._genericSet("glassmorphism",r)}set height(r){this._genericSet("height",r)}set instanced(r){this._genericSet("instanced",r)}set justifyContent(r){this._genericSet("justifyContent",r)}set margin(r){this._genericSet("margin",r)}set marginBottom(r){this._genericSet("marginBottom",r)}set marginLeft(r){this._genericSet("marginLeft",r)}set marginRight(r){this._genericSet("marginRight",r)}set marginTop(r){this._genericSet("marginTop",r)}set material(r){this._genericSet("material",r)}set materialColor(r){this._genericSet("materialColor",r)}set maxHeight(r){this._genericSet("maxHeight",r)}set maxWidth(r){this._genericSet("maxWidth",r)}set minHeight(r){this._genericSet("minHeight",r)}set minWidth(r){this._genericSet("minWidth",r)}set opacity(r){this._genericSet("opacity",r)}set overflow(r){this._genericSet("overflow",r)}set padding(r){this._genericSet("padding",r)}set paddingBottom(r){this._genericSet("paddingBottom",r)}set paddingLeft(r){this._genericSet("paddingLeft",r)}set paddingRight(r){this._genericSet("paddingRight",r)}set paddingTop(r){this._genericSet("paddingTop",r)}set pointerInteractableClassOverride(r){this._genericSet("pointerInteractableClassOverride",r)}set textAlign(r){this._genericSet("textAlign",r)}set textureFit(r){this._genericSet("textureFit",r)}set width(r){this._genericSet("width",r)}}let jr=new class{constructor(){this._backgroundQueue=new Set,this._layoutQueue=new Set}scheduleBackgroundUpdate(r){this._backgroundQueue.add(r)}scheduleLayoutUpdate(r){this._layoutQueue.add(r)}completeLayoutUpdate(r){this._layoutQueue.delete(r)}updateBackgrounds(){for(let r of this._backgroundQueue)r.createBackground(),this._backgroundQueue.delete(r)}updateLayouts(){for(let r of this._layoutQueue)r.updateLayout(),this._layoutQueue.delete(r)}update(){this.updateLayouts(),this.updateBackgrounds()}};let Vr=new class{constructor(){this._listeners=new Set}add(r){this._listeners.add(r)}remove(r){this._listeners.delete(r)}update(){for(let r of this._listeners)r()}};const Xr=new r.MeshBasicMaterial({color:16777215,side:r.DoubleSide,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1}),qr=new r.MeshPhysicalMaterial({color:16777215,roughness:.45,side:r.DoubleSide,specularIntensity:0,transmission:.99,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1}),$r=new r.MeshBasicMaterial({color:16777215,transparent:!0,side:r.DoubleSide,polygonOffset:!0});class LayoutComponent extends UIComponent{constructor(...x){super(...x),this._defaults.alignItems="center",this._defaults.backgroundVisible=!1,this._defaults.borderMaterial=$r.clone(),this._defaults.borderRadius=0,this._defaults.borderWidth=0,this._defaults.contentDirection="column",this._defaults.justifyContent="start",this._defaults.margin=0,this._defaults.material=this.glassmorphism?qr.clone():Xr.clone(),this._defaults.height="auto",this._defaults.overflow="visible",this._defaults.padding=0,this._defaults.width="auto",this._updateListener=()=>this._updateClippingPlanes(),this.descendantInstancedMeshes=new Set,this.computedHeight=0,this.marginedHeight=0,this.unpaddedHeight=0,this.computedWidth=0,this.marginedWidth=0,this.unpaddedWidth=0,this._materialOffset=0,this._content=new r.Object3D,this._content.position.z=1e-8,this.addEventListener("added",(()=>this._onAdded())),this.addEventListener("removed",(()=>this._onRemoved())),this.add(this._content),this._updateLayout(),"visible"!=this.overflow&&this._createClippingPlanes()}_handleStyleUpdateForAlignItems(){this._updateLayout()}_handleStyleUpdateForBackgroundVisible(){this._background&&(this._background.visible=this.backgroundVisible||!1)}_handleStyleUpdateForBorderRadius(){this._createBackground()}_handleStyleUpdateForBorderBottomLeftRadius(){this._createBackground()}_handleStyleUpdateForBorderBottomRightRadius(){this._createBackground()}_handleStyleUpdateForBorderTopLeftRadius(){this._createBackground()}_handleStyleUpdateForBorderTopRightRadius(){this._createBackground()}_handleStyleUpdateForBorderMaterial(){let r=this.borderMaterial;r.polygonOffset=!0,r.polygonOffsetFactor=r.polygonOffsetUnits=-1*this._materialOffset,this._border&&(this._border.material=r)}_handleStyleUpdateForJustifyContent(){this._updateLayout()}_handleStyleUpdateForMargin(){this._updateLayout()}_handleStyleUpdateForMarginBottom(){this._updateLayout()}_handleStyleUpdateForMarginLeft(){this._updateLayout()}_handleStyleUpdateForMarginRight(){this._updateLayout()}_handleStyleUpdateForMarginTop(){this._updateLayout()}_handleStyleUpdateForMaxHeight(){this._updateLayout()}_handleStyleUpdateForMaxWidth(){this._updateLayout()}_handleStyleUpdateForMinHeight(){this._updateLayout()}_handleStyleUpdateForMinWidth(){this._updateLayout()}_handleStyleUpdateForPadding(){this._updateLayout()}_handleStyleUpdateForPaddingBottom(){this._updateLayout()}_handleStyleUpdateForPaddingLeft(){this._updateLayout()}_handleStyleUpdateForPaddingRight(){this._updateLayout()}_handleStyleUpdateForPaddingTop(){this._updateLayout()}_handleStyleUpdateForHeight(){this._updateLayout()}_handleStyleUpdateForWidth(){this._updateLayout()}_handleStyleUpdateForMaterial(){let r=this.material;r.polygonOffset=!0,r.polygonOffsetFactor=r.polygonOffsetUnits=-1*this._materialOffset,this._background.material=r}_handleStyleUpdateForMaterialColor(){let r=this.materialColor;null==r&&(r="#ffffff"),this.material.color.set(r),this._instancedBackgroundId&&zr.setColorFrom(this._instancedBackgroundId)}_handleStyleUpdateForOpacity(){let r=this.opacity;null==r&&(r=1),this.material.opacity=r}_handleStyleUpdateForOverflow(){"visible"!=this.overflow?this.clippingPlanes||this._createClippingPlanes():this.clippingPlanes&&this._clearClippingPlanes()}_createBackground(){jr.scheduleBackgroundUpdate(this)}createBackground(){this._background&&this.remove(this._background),this._border&&this.remove(this._border),this._instancedBackgroundId&&(zr.remove(this._instancedBackgroundId),delete this._instancedBackgroundId),this._background=null,this._border=null;let x=this.material,b=this.materialColor,S=this.opacity;null!=b&&x.color.set(b),S&&(x.opacity=S);let C=this.borderWidth||0,I=this.borderRadius||0,A=numberOr(this.borderTopLeftRadius,I),R=numberOr(this.borderTopRightRadius,I),B=numberOr(this.borderBottomLeftRadius,I),D=numberOr(this.borderBottomRightRadius,I),F=this.computedHeight,G=this.computedWidth,N=this._materialOffset;if(C){let x=this.createShape(G,F,A,R,B,D);A=Math.max(A-C,0),R=Math.max(R-C,0),B=Math.max(B-C,0),D=Math.max(D-C,0),F-=2*C,G-=2*C;let b=this.createShape(G,F,A,R,B,D);if(this.instanced)this._background=new r.Object3D,this._instancedBackgroundId=zr.createBackground(this,F,G,A,R,B,D,this._materialOffset),this._instancedBackgroundId&&(this.updateInstancePosition(),zr.setColorFrom(this._instancedBackgroundId));else{let S=new r.ShapeGeometry(b);this._background=new r.Mesh(S,this.material),this.add(this._background),x.holes.push(b),S=new r.ShapeGeometry(x),this._border=new r.Mesh(S,this.borderMaterial),this.add(this._border),this._border.renderOrder=N}}else if(this.instanced){this._background=new r.Object3D;let x=this.materialColor||"#ffffff";this._instancedBackgroundId=zr.createBackground(this,F,G,A,R,B,D,this._materialOffset,x),this._instancedBackgroundId&&(this.updateInstancePosition(),zr.setColorFrom(this._instancedBackgroundId,this.materialColor||"#ffffff"))}else{let x=this.createShape(G,F,A,R,B,D),b=new r.ShapeGeometry(x);this._background=new r.Mesh(b,this.material),this.add(this._background)}this._background.renderOrder=N,this.backgroundVisible||(this._background.visible=!1)}createShape(x,b,S,C,I,A){let R=new r.Shape,B=x/2,D=b/2,F=-1*B,G=-1*D;return R.moveTo(F,G+I),R.lineTo(F,D-S),S&&R.absarc(F+S,D-S,S,Math.PI,Math.PI/2,!0),R.lineTo(B-C,D),C&&R.absarc(B-C,D-C,C,Math.PI/2,0,!0),R.lineTo(B,G+A),A&&R.absarc(B-A,G+A,A,0,Math.PI/-2,!0),R.lineTo(F+I,G),I&&R.absarc(F+I,G+I,I,Math.PI/-2,-Math.PI,!0),R}_addClippingPlanesUpdateListener(){this.clippingPlanes&&Vr.add(this._updateListener);for(let r of this._content.children)r instanceof LayoutComponent&&r._addClippingPlanesUpdateListener()}_removeClippingPlanesUpdateListener(){Vr.remove(this._updateListener);for(let r of this._content.children)r instanceof LayoutComponent&&r._removeClippingPlanesUpdateListener()}_createClippingPlanes(){this.clippingPlanes=[new r.Plane(new r.Vector3(0,1,0)),new r.Plane(new r.Vector3(0,-1,0)),new r.Plane(new r.Vector3(1,0,0)),new r.Plane(new r.Vector3(-1,0,0))],this._updateClippingPlanes(),this.updateClippingPlanes(!0),Vr.add(this._updateListener)}_getClippingPlanes(){let r=[],x=this;for(;x instanceof LayoutComponent;)x.clippingPlanes&&r.push(...x.clippingPlanes),x=x.parentComponent;return r.length?r:null}_clearClippingPlanes(){this.clippingPlanes=null,Vr.remove(this._updateListener),this.updateClippingPlanes(!0)}_updateClippingPlanes(){let r=this.computedWidth/2,x=this.computedHeight/2;this.clippingPlanes[0].constant=x,this.clippingPlanes[1].constant=x,this.clippingPlanes[2].constant=r,this.clippingPlanes[3].constant=r,this.clippingPlanes[0].normal.set(0,1,0),this.clippingPlanes[1].normal.set(0,-1,0),this.clippingPlanes[2].normal.set(1,0,0),this.clippingPlanes[3].normal.set(-1,0,0),this.updateWorldMatrix(!0);for(let r of this.clippingPlanes)r.applyMatrix4(this.matrixWorld)}updateClippingPlanes(r){let x=this._getClippingPlanes();this.material.clippingPlanes=x,this.borderMaterial.clippingPlanes=x;for(let r of this.descendantInstancedMeshes)r.material.clippingPlanes=x;if(this._text&&(this._text.material.clippingPlanes=x),r)for(let r of this._content.children)r instanceof LayoutComponent&&r.updateClippingPlanes(!0)}_updateLayout(r){r?this.updateLayout(r):jr.scheduleLayoutUpdate(this)}updateLayout(r){let x,b,S,C,I,A,R,B,D,F,G,N,H,W,j,V,X,q=this.computedHeight,$=this.computedWidth,K=this.marginedHeight,Y=this.marginedWidth,Z=this.unpaddedHeight,J=this.unpaddedWidth,Q=this._computeDimension("height"),ee=this._computeDimension("width"),te=this._getContentHeight(),ne=this._getContentWidth(),re=this._content.children.reduce(((r,x)=>r+(x instanceof LayoutComponent?1:0)),0),ie=this.alignItems,se=this.justifyContent,oe=0;"row"==this.contentDirection?(b=-ee,B=Q,D=-ne,S=-this.unpaddedWidth,F="computedWidth",G="computedHeight",I=this.paddingLeft||this.padding,A=this.paddingTop||this.padding,R=this.paddingBottom||this.padding,N="marginLeft",H="marginRight",W="marginTop",j="marginBottom",V="x",X="y",C=1):(b=Q,B=-ee,D=te,S=this.unpaddedHeight,F="computedHeight",G="computedWidth",I=this.paddingTop||this.padding,A=this.paddingLeft||this.padding,R=this.paddingRight||this.padding,N="marginTop",H="marginBottom",W="marginLeft",j="marginRight",V="y",X="x",C=-1),"start"==se?(x=b/2,x+=I*C):"end"==se?(x=b/-2+D,x-=I*C):"center"==se||Math.abs(S)-Math.abs(D)<0?x=D/2:("spaceBetween"==se?(oe=Math.abs(S-D)/(re-1)*C,x=b/2):"spaceAround"==se?(oe=Math.abs(S-D)/re*C,x=b/2+oe/2):"spaceEvenly"==se&&(oe=Math.abs(S-D)/(re+1)*C,x=b/2+oe),x+=I*C);for(let r of this._content.children)if(r instanceof LayoutComponent){let b=r.margin||0,S=numberOr(r[N],b),I=numberOr(r[H],b),D=numberOr(r[W],b),q=numberOr(r[j],b);if(x+=S*C,r.position[V]=x+r[F]/2*C,x+=r[F]*C,x+=I*C,x+=oe,"start"==ie)r.position[X]=B/2-r[G]/2*C-A*C-D*C;else if("end"==ie)r.position[X]=-B/2+r[G]/2*C+R*C+q*C;else{let x=(R-A+q-D)*C/2;r.position[X]=x}}$!=ee||q!=Q?(this._createBackground(),this.clippingPlanes&&this._updateClippingPlanes(),this.parentComponent instanceof LayoutComponent&&this.parent.parent._updateLayout(r),this._updateChildrensLayout($!=ee,q!=Q,r)):K!=this.marginedHeight||Y!=this.marginedWidth?(this.clippingPlanes&&this._updateClippingPlanes(),this.parentComponent instanceof LayoutComponent&&this.parent.parent._updateLayout(r)):Z==this.unpaddedHeight&&J==this.unpaddedWidth||this._updateChildrensLayout(J!=this.unpaddedWidth,Z!=this.unpaddedHeight,r),this._updateInstances(),r&&jr.completeLayoutUpdate(this)}_updateChildrensLayout(r,x,b){for(let S of this._content.children)if(S instanceof LayoutComponent){let C=!1;if(r){let r=S.width;"string"==typeof r&&r.endsWith("%")&&(C=!0)}if(!C&&x){let r=S.height;"string"==typeof r&&r.endsWith("%")&&(C=!0)}C&&S._updateLayout(b)}}_computeDimension(r,x){let b=capitalizeFirstLetter(r),S="computed"+b,C="margined"+b,I="unpadded"+b,A="max"+b,R="min"+b,B=this[x||r];if("number"==typeof B)this[S]=B;else if("auto"==B)if("column"==this.contentDirection==("height"==r)){let x=0;for(let r of this._content.children)r instanceof LayoutComponent&&(x+=r[C]);let b="height"==r?this.paddingVertical:this.paddingHorizontal;this[S]=x+b}else{let x=0;for(let r of this._content.children)r instanceof LayoutComponent&&(x=Math.max(x,r[C]));let b="height"==r?this.paddingVertical:this.paddingHorizontal;this[S]=x+b}else{let r=this.parentComponent;if(r instanceof LayoutComponent){let x=Number(B.replace("%",""))/100;this[S]=r[I]*x}}if(x)return this[S];{let x=!1;if(null!=this[A]){let b=this[S];this._computeDimension(r,A),b<this[S]?this[S]=b:x=!0}if(null!=this[R]&&!x){let x=this[S];this._computeDimension(r,R),x>this[S]&&(this[S]=x)}}return this._computeUnpaddedAndMarginedDimensions(r,this[S]),this[S]}_computeUnpaddedAndMarginedDimensions(r,x){let b="margined"+capitalizeFirstLetter(r),S="height"==r?"Vertical":"Horizontal";this["unpadded"+capitalizeFirstLetter(r)]=x-this["padding"+S],this[b]=x+this["margin"+S],"height"==r?(this.unpaddedHeight=Math.max(x-this.paddingVertical,0),this.marginedHeight=x+this.marginVertical):(this.unpaddedWidth=Math.max(x-this.paddingHorizontal,0),this.marginedWidth=x+this.marginHorizontal)}_getContentHeight(){if("column"==this.contentDirection){let r=0;for(let x of this._content.children)x instanceof LayoutComponent&&(r+=x.marginedHeight);return r}{let r=0;for(let x of this._content.children)x instanceof LayoutComponent&&(r=Math.max(r,x.marginedHeight));return r}}_getContentWidth(){if("row"==this.contentDirection){let r=0;for(let x of this._content.children)x instanceof LayoutComponent&&(r+=x.marginedWidth);return r}{let r=0;for(let x of this._content.children)x instanceof LayoutComponent&&(r=Math.max(r,x.marginedWidth));return r}}_getPaddedContentHeight(){return this._getContentHeight()+this.paddingVertical}_getPaddedContentWidth(){return this._getContentWidth()+this.paddingHorizontal}_updateMaterialOffset(r){this._materialOffset=r+1;let x=this.material,b=this.borderMaterial;b.polygonOffset=x.polygonOffset=!0,b.polygonOffsetFactor=b.polygonOffsetUnits=x.polygonOffsetFactor=x.polygonOffsetUnits=-1*this._materialOffset;for(let r of this._content.children)r instanceof LayoutComponent&&r._updateMaterialOffset(this._materialOffset);let S=this._materialOffset;this._background&&(this._background.renderOrder=S),this._border&&(this._border.renderOrder=S)}updateInstancePosition(){zr.setPositionFrom(this._instancedBackgroundId)}_updateInstances(){if(this.instanced)if(this._instancedBackgroundId)this.updateInstancePosition();else if(this._createBackground(),!this._instancedBackgroundId)return;for(let r of this._content.children)r instanceof LayoutComponent&&r._updateInstances()}_removeInstances(){this.instanced&&this._instancedBackgroundId&&(zr.remove(this._instancedBackgroundId),delete this._instancedBackgroundId);for(let r of this._content.children)r instanceof LayoutComponent&&r._removeInstances()}_onAdded(){this._addClippingPlanesUpdateListener()}_onRemoved(){this._removeClippingPlanesUpdateListener(),this._removeInstances()}add(r){if(arguments.length>1)for(let r of arguments)this.add(r);else r instanceof UIComponent&&!r.bypassContentPositioning?(this._content.add(r),r._updateMaterialOffset(this._materialOffset),r._updateLayout(),r.updateClippingPlanes(!0),this._updateLayout()):r.isUIManagedInstancedMesh?(this.descendantInstancedMeshes.add(r),this._content.add(r)):super.add(r)}remove(r){if(arguments.length>1)for(let r of arguments)this.remove(r);else r instanceof UIComponent&&!r.bypassContentPositioning?(this._content.remove(r),(this._content.children.length||"auto"==this.width||"auto"==this.height)&&this._updateLayout()):r.isUIManagedInstancedMesh?(this.descendantInstancedMeshes.delete(r),this._content.remove(r)):super.remove(r)}get marginHorizontal(){let r=this.margin||0;return numberOr(this.marginLeft,r)+numberOr(this.marginRight,r)}get marginVertical(){let r=this.margin||0;return numberOr(this.marginTop,r)+numberOr(this.marginBottom,r)}get paddingHorizontal(){let r=this.padding||0;return numberOr(this.paddingLeft,r)+numberOr(this.paddingRight,r)}get paddingVertical(){let r=this.padding||0;return numberOr(this.paddingTop,r)+numberOr(this.paddingBottom,r)}get parentComponent(){return this.parent?.parent}}zr.registerLayoutComponentClass(LayoutComponent);const Kr={POINTER:"POINTER",TOUCH_SCREEN:"TOUCH_SCREEN",XR:"XR"},Yr={LEFT:"LEFT",RIGHT:"RIGHT",otherHand:r=>r==Yr.LEFT?Yr.RIGHT:r==Yr.RIGHT?Yr.LEFT:void console.error("ERROR: Unexpected hand provided to Handedness.otherHand")},Zr={CONTROLLER:"CONTROLLER",HAND:"HAND",OTHER:"OTHER"};function toTrianglesDrawMode(r,x){if(x===fe)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),r;if(x===ge||x===me){let b=r.getIndex();if(null===b){const x=[],S=r.getAttribute("position");if(void 0===S)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),r;for(let r=0;r<S.count;r++)x.push(r);r.setIndex(x),b=r.getIndex()}const S=b.count-2,C=[];if(x===ge)for(let r=1;r<=S;r++)C.push(b.getX(0)),C.push(b.getX(r)),C.push(b.getX(r+1));else for(let r=0;r<S;r++)r%2==0?(C.push(b.getX(r)),C.push(b.getX(r+1)),C.push(b.getX(r+2))):(C.push(b.getX(r+2)),C.push(b.getX(r+1)),C.push(b.getX(r)));C.length/3!==S&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const I=r.clone();return I.setIndex(C),I.clearGroups(),I}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",x),r}class GLTFLoader extends ye{constructor(r){super(r),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(r){return new GLTFMaterialsClearcoatExtension(r)})),this.register((function(r){return new GLTFMaterialsDispersionExtension(r)})),this.register((function(r){return new GLTFTextureBasisUExtension(r)})),this.register((function(r){return new GLTFTextureWebPExtension(r)})),this.register((function(r){return new GLTFTextureAVIFExtension(r)})),this.register((function(r){return new GLTFMaterialsSheenExtension(r)})),this.register((function(r){return new GLTFMaterialsTransmissionExtension(r)})),this.register((function(r){return new GLTFMaterialsVolumeExtension(r)})),this.register((function(r){return new GLTFMaterialsIorExtension(r)})),this.register((function(r){return new GLTFMaterialsEmissiveStrengthExtension(r)})),this.register((function(r){return new GLTFMaterialsSpecularExtension(r)})),this.register((function(r){return new GLTFMaterialsIridescenceExtension(r)})),this.register((function(r){return new GLTFMaterialsAnisotropyExtension(r)})),this.register((function(r){return new GLTFMaterialsBumpExtension(r)})),this.register((function(r){return new GLTFLightsExtension(r)})),this.register((function(r){return new GLTFMeshoptCompression(r)})),this.register((function(r){return new GLTFMeshGpuInstancing(r)}))}load(r,x,b,S){const C=this;let I;if(""!==this.resourcePath)I=this.resourcePath;else if(""!==this.path){const x=ve.extractUrlBase(r);I=ve.resolveURL(x,this.path)}else I=ve.extractUrlBase(r);this.manager.itemStart(r);const _onError=function(x){S?S(x):console.error(x),C.manager.itemError(r),C.manager.itemEnd(r)},A=new xe(this.manager);A.setPath(this.path),A.setResponseType("arraybuffer"),A.setRequestHeader(this.requestHeader),A.setWithCredentials(this.withCredentials),A.load(r,(function(b){try{C.parse(b,I,(function(b){x(b),C.manager.itemEnd(r)}),_onError)}catch(r){_onError(r)}}),b,_onError)}setDRACOLoader(r){return this.dracoLoader=r,this}setKTX2Loader(r){return this.ktx2Loader=r,this}setMeshoptDecoder(r){return this.meshoptDecoder=r,this}register(r){return-1===this.pluginCallbacks.indexOf(r)&&this.pluginCallbacks.push(r),this}unregister(r){return-1!==this.pluginCallbacks.indexOf(r)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(r),1),this}parse(r,x,b,S){let C;const I={},A={},R=new TextDecoder;if("string"==typeof r)C=JSON.parse(r);else if(r instanceof ArrayBuffer){if(R.decode(new Uint8Array(r,0,4))===Qr){try{I[Jr.KHR_BINARY_GLTF]=new GLTFBinaryExtension(r)}catch(r){return void(S&&S(r))}C=JSON.parse(I[Jr.KHR_BINARY_GLTF].content)}else C=JSON.parse(R.decode(r))}else C=r;if(void 0===C.asset||C.asset.version[0]<2)return void(S&&S(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const B=new GLTFParser(C,{path:x||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});B.fileLoader.setRequestHeader(this.requestHeader);for(let r=0;r<this.pluginCallbacks.length;r++){const x=this.pluginCallbacks[r](B);x.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),A[x.name]=x,I[x.name]=!0}if(C.extensionsUsed)for(let r=0;r<C.extensionsUsed.length;++r){const x=C.extensionsUsed[r],b=C.extensionsRequired||[];switch(x){case Jr.KHR_MATERIALS_UNLIT:I[x]=new GLTFMaterialsUnlitExtension;break;case Jr.KHR_DRACO_MESH_COMPRESSION:I[x]=new GLTFDracoMeshCompressionExtension(C,this.dracoLoader);break;case Jr.KHR_TEXTURE_TRANSFORM:I[x]=new GLTFTextureTransformExtension;break;case Jr.KHR_MESH_QUANTIZATION:I[x]=new GLTFMeshQuantizationExtension;break;default:b.indexOf(x)>=0&&void 0===A[x]&&console.warn('THREE.GLTFLoader: Unknown extension "'+x+'".')}}B.setExtensions(I),B.setPlugins(A),B.parse(b,S)}parseAsync(r,x){const b=this;return new Promise((function(S,C){b.parse(r,x,S,C)}))}}function GLTFRegistry(){let r={};return{get:function(x){return r[x]},add:function(x,b){r[x]=b},remove:function(x){delete r[x]},removeAll:function(){r={}}}}const Jr={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class GLTFLightsExtension{constructor(r){this.parser=r,this.name=Jr.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const r=this.parser,x=this.parser.json.nodes||[];for(let b=0,S=x.length;b<S;b++){const S=x[b];S.extensions&&S.extensions[this.name]&&void 0!==S.extensions[this.name].light&&r._addNodeRef(this.cache,S.extensions[this.name].light)}}_loadLight(r){const x=this.parser,b="light:"+r;let S=x.cache.get(b);if(S)return S;const C=x.json,I=((C.extensions&&C.extensions[this.name]||{}).lights||[])[r];let A;const R=new be(16777215);void 0!==I.color&&R.setRGB(I.color[0],I.color[1],I.color[2],Te);const B=void 0!==I.range?I.range:0;switch(I.type){case"directional":A=new Ce(R),A.target.position.set(0,0,-1),A.add(A.target);break;case"point":A=new Se(R),A.distance=B;break;case"spot":A=new we(R),A.distance=B,I.spot=I.spot||{},I.spot.innerConeAngle=void 0!==I.spot.innerConeAngle?I.spot.innerConeAngle:0,I.spot.outerConeAngle=void 0!==I.spot.outerConeAngle?I.spot.outerConeAngle:Math.PI/4,A.angle=I.spot.outerConeAngle,A.penumbra=1-I.spot.innerConeAngle/I.spot.outerConeAngle,A.target.position.set(0,0,-1),A.add(A.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+I.type)}return A.position.set(0,0,0),assignExtrasToUserData(A,I),void 0!==I.intensity&&(A.intensity=I.intensity),A.name=x.createUniqueName(I.name||"light_"+r),S=Promise.resolve(A),x.cache.add(b,S),S}getDependency(r,x){if("light"===r)return this._loadLight(x)}createNodeAttachment(r){const x=this,b=this.parser,S=b.json.nodes[r],C=(S.extensions&&S.extensions[this.name]||{}).light;return void 0===C?null:this._loadLight(C).then((function(r){return b._getNodeRef(x.cache,C,r)}))}}class GLTFMaterialsUnlitExtension{constructor(){this.name=Jr.KHR_MATERIALS_UNLIT}getMaterialType(){return W}extendParams(r,x,b){const S=[];r.color=new be(1,1,1),r.opacity=1;const C=x.pbrMetallicRoughness;if(C){if(Array.isArray(C.baseColorFactor)){const x=C.baseColorFactor;r.color.setRGB(x[0],x[1],x[2],Te),r.opacity=x[3]}void 0!==C.baseColorTexture&&S.push(b.assignTexture(r,"map",C.baseColorTexture,Ie))}return Promise.all(S)}}class GLTFMaterialsEmissiveStrengthExtension{constructor(r){this.parser=r,this.name=Jr.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(r,x){const b=this.parser.json.materials[r];if(!b.extensions||!b.extensions[this.name])return Promise.resolve();const S=b.extensions[this.name].emissiveStrength;return void 0!==S&&(x.emissiveIntensity=S),Promise.resolve()}}class GLTFMaterialsClearcoatExtension{constructor(r){this.parser=r,this.name=Jr.KHR_MATERIALS_CLEARCOAT}getMaterialType(r){const x=this.parser.json.materials[r];return x.extensions&&x.extensions[this.name]?ke:null}extendMaterialParams(r,x){const b=this.parser,S=b.json.materials[r];if(!S.extensions||!S.extensions[this.name])return Promise.resolve();const C=[],I=S.extensions[this.name];if(void 0!==I.clearcoatFactor&&(x.clearcoat=I.clearcoatFactor),void 0!==I.clearcoatTexture&&C.push(b.assignTexture(x,"clearcoatMap",I.clearcoatTexture)),void 0!==I.clearcoatRoughnessFactor&&(x.clearcoatRoughness=I.clearcoatRoughnessFactor),void 0!==I.clearcoatRoughnessTexture&&C.push(b.assignTexture(x,"clearcoatRoughnessMap",I.clearcoatRoughnessTexture)),void 0!==I.clearcoatNormalTexture&&(C.push(b.assignTexture(x,"clearcoatNormalMap",I.clearcoatNormalTexture)),void 0!==I.clearcoatNormalTexture.scale)){const r=I.clearcoatNormalTexture.scale;x.clearcoatNormalScale=new R(r,r)}return Promise.all(C)}}class GLTFMaterialsDispersionExtension{constructor(r){this.parser=r,this.name=Jr.KHR_MATERIALS_DISPERSION}getMaterialType(r){const x=this.parser.json.materials[r];return x.extensions&&x.extensions[this.name]?ke:null}extendMaterialParams(r,x){const b=this.parser.json.materials[r];if(!b.extensions||!b.extensions[this.name])return Promise.resolve();const S=b.extensions[this.name];return x.dispersion=void 0!==S.dispersion?S.dispersion:0,Promise.resolve()}}class GLTFMaterialsIridescenceExtension{constructor(r){this.parser=r,this.name=Jr.KHR_MATERIALS_IRIDESCENCE}getMaterialType(r){const x=this.parser.json.materials[r];return x.extensions&&x.extensions[this.name]?ke:null}extendMaterialParams(r,x){const b=this.parser,S=b.json.materials[r];if(!S.extensions||!S.extensions[this.name])return Promise.resolve();const C=[],I=S.extensions[this.name];return void 0!==I.iridescenceFactor&&(x.iridescence=I.iridescenceFactor),void 0!==I.iridescenceTexture&&C.push(b.assignTexture(x,"iridescenceMap",I.iridescenceTexture)),void 0!==I.iridescenceIor&&(x.iridescenceIOR=I.iridescenceIor),void 0===x.iridescenceThicknessRange&&(x.iridescenceThicknessRange=[100,400]),void 0!==I.iridescenceThicknessMinimum&&(x.iridescenceThicknessRange[0]=I.iridescenceThicknessMinimum),void 0!==I.iridescenceThicknessMaximum&&(x.iridescenceThicknessRange[1]=I.iridescenceThicknessMaximum),void 0!==I.iridescenceThicknessTexture&&C.push(b.assignTexture(x,"iridescenceThicknessMap",I.iridescenceThicknessTexture)),Promise.all(C)}}class GLTFMaterialsSheenExtension{constructor(r){this.parser=r,this.name=Jr.KHR_MATERIALS_SHEEN}getMaterialType(r){const x=this.parser.json.materials[r];return x.extensions&&x.extensions[this.name]?ke:null}extendMaterialParams(r,x){const b=this.parser,S=b.json.materials[r];if(!S.extensions||!S.extensions[this.name])return Promise.resolve();const C=[];x.sheenColor=new be(0,0,0),x.sheenRoughness=0,x.sheen=1;const I=S.extensions[this.name];if(void 0!==I.sheenColorFactor){const r=I.sheenColorFactor;x.sheenColor.setRGB(r[0],r[1],r[2],Te)}return void 0!==I.sheenRoughnessFactor&&(x.sheenRoughness=I.sheenRoughnessFactor),void 0!==I.sheenColorTexture&&C.push(b.assignTexture(x,"sheenColorMap",I.sheenColorTexture,Ie)),void 0!==I.sheenRoughnessTexture&&C.push(b.assignTexture(x,"sheenRoughnessMap",I.sheenRoughnessTexture)),Promise.all(C)}}class GLTFMaterialsTransmissionExtension{constructor(r){this.parser=r,this.name=Jr.KHR_MATERIALS_TRANSMISSION}getMaterialType(r){const x=this.parser.json.materials[r];return x.extensions&&x.extensions[this.name]?ke:null}extendMaterialParams(r,x){const b=this.parser,S=b.json.materials[r];if(!S.extensions||!S.extensions[this.name])return Promise.resolve();const C=[],I=S.extensions[this.name];return void 0!==I.transmissionFactor&&(x.transmission=I.transmissionFactor),void 0!==I.transmissionTexture&&C.push(b.assignTexture(x,"transmissionMap",I.transmissionTexture)),Promise.all(C)}}class GLTFMaterialsVolumeExtension{constructor(r){this.parser=r,this.name=Jr.KHR_MATERIALS_VOLUME}getMaterialType(r){const x=this.parser.json.materials[r];return x.extensions&&x.extensions[this.name]?ke:null}extendMaterialParams(r,x){const b=this.parser,S=b.json.materials[r];if(!S.extensions||!S.extensions[this.name])return Promise.resolve();const C=[],I=S.extensions[this.name];x.thickness=void 0!==I.thicknessFactor?I.thicknessFactor:0,void 0!==I.thicknessTexture&&C.push(b.assignTexture(x,"thicknessMap",I.thicknessTexture)),x.attenuationDistance=I.attenuationDistance||1/0;const A=I.attenuationColor||[1,1,1];return x.attenuationColor=(new be).setRGB(A[0],A[1],A[2],Te),Promise.all(C)}}class GLTFMaterialsIorExtension{constructor(r){this.parser=r,this.name=Jr.KHR_MATERIALS_IOR}getMaterialType(r){const x=this.parser.json.materials[r];return x.extensions&&x.extensions[this.name]?ke:null}extendMaterialParams(r,x){const b=this.parser.json.materials[r];if(!b.extensions||!b.extensions[this.name])return Promise.resolve();const S=b.extensions[this.name];return x.ior=void 0!==S.ior?S.ior:1.5,Promise.resolve()}}class GLTFMaterialsSpecularExtension{constructor(r){this.parser=r,this.name=Jr.KHR_MATERIALS_SPECULAR}getMaterialType(r){const x=this.parser.json.materials[r];return x.extensions&&x.extensions[this.name]?ke:null}extendMaterialParams(r,x){const b=this.parser,S=b.json.materials[r];if(!S.extensions||!S.extensions[this.name])return Promise.resolve();const C=[],I=S.extensions[this.name];x.specularIntensity=void 0!==I.specularFactor?I.specularFactor:1,void 0!==I.specularTexture&&C.push(b.assignTexture(x,"specularIntensityMap",I.specularTexture));const A=I.specularColorFactor||[1,1,1];return x.specularColor=(new be).setRGB(A[0],A[1],A[2],Te),void 0!==I.specularColorTexture&&C.push(b.assignTexture(x,"specularColorMap",I.specularColorTexture,Ie)),Promise.all(C)}}class GLTFMaterialsBumpExtension{constructor(r){this.parser=r,this.name=Jr.EXT_MATERIALS_BUMP}getMaterialType(r){const x=this.parser.json.materials[r];return x.extensions&&x.extensions[this.name]?ke:null}extendMaterialParams(r,x){const b=this.parser,S=b.json.materials[r];if(!S.extensions||!S.extensions[this.name])return Promise.resolve();const C=[],I=S.extensions[this.name];return x.bumpScale=void 0!==I.bumpFactor?I.bumpFactor:1,void 0!==I.bumpTexture&&C.push(b.assignTexture(x,"bumpMap",I.bumpTexture)),Promise.all(C)}}class GLTFMaterialsAnisotropyExtension{constructor(r){this.parser=r,this.name=Jr.KHR_MATERIALS_ANISOTROPY}getMaterialType(r){const x=this.parser.json.materials[r];return x.extensions&&x.extensions[this.name]?ke:null}extendMaterialParams(r,x){const b=this.parser,S=b.json.materials[r];if(!S.extensions||!S.extensions[this.name])return Promise.resolve();const C=[],I=S.extensions[this.name];return void 0!==I.anisotropyStrength&&(x.anisotropy=I.anisotropyStrength),void 0!==I.anisotropyRotation&&(x.anisotropyRotation=I.anisotropyRotation),void 0!==I.anisotropyTexture&&C.push(b.assignTexture(x,"anisotropyMap",I.anisotropyTexture)),Promise.all(C)}}class GLTFTextureBasisUExtension{constructor(r){this.parser=r,this.name=Jr.KHR_TEXTURE_BASISU}loadTexture(r){const x=this.parser,b=x.json,S=b.textures[r];if(!S.extensions||!S.extensions[this.name])return null;const C=S.extensions[this.name],I=x.options.ktx2Loader;if(!I){if(b.extensionsRequired&&b.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return x.loadTextureImage(r,C.source,I)}}class GLTFTextureWebPExtension{constructor(r){this.parser=r,this.name=Jr.EXT_TEXTURE_WEBP}loadTexture(r){const x=this.name,b=this.parser,S=b.json,C=S.textures[r];if(!C.extensions||!C.extensions[x])return null;const I=C.extensions[x],A=S.images[I.source];let R=b.textureLoader;if(A.uri){const r=b.options.manager.getHandler(A.uri);null!==r&&(R=r)}return b.loadTextureImage(r,I.source,R)}}class GLTFTextureAVIFExtension{constructor(r){this.parser=r,this.name=Jr.EXT_TEXTURE_AVIF}loadTexture(r){const x=this.name,b=this.parser,S=b.json,C=S.textures[r];if(!C.extensions||!C.extensions[x])return null;const I=C.extensions[x],A=S.images[I.source];let R=b.textureLoader;if(A.uri){const r=b.options.manager.getHandler(A.uri);null!==r&&(R=r)}return b.loadTextureImage(r,I.source,R)}}class GLTFMeshoptCompression{constructor(r){this.name=Jr.EXT_MESHOPT_COMPRESSION,this.parser=r}loadBufferView(r){const x=this.parser.json,b=x.bufferViews[r];if(b.extensions&&b.extensions[this.name]){const r=b.extensions[this.name],S=this.parser.getDependency("buffer",r.buffer),C=this.parser.options.meshoptDecoder;if(!C||!C.supported){if(x.extensionsRequired&&x.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return S.then((function(x){const b=r.byteOffset||0,S=r.byteLength||0,I=r.count,A=r.byteStride,R=new Uint8Array(x,b,S);return C.decodeGltfBufferAsync?C.decodeGltfBufferAsync(I,A,R,r.mode,r.filter).then((function(r){return r.buffer})):C.ready.then((function(){const x=new ArrayBuffer(I*A);return C.decodeGltfBuffer(new Uint8Array(x),I,A,R,r.mode,r.filter),x}))}))}return null}}class GLTFMeshGpuInstancing{constructor(r){this.name=Jr.EXT_MESH_GPU_INSTANCING,this.parser=r}createNodeMesh(r){const b=this.parser.json,S=b.nodes[r];if(!S.extensions||!S.extensions[this.name]||void 0===S.mesh)return null;const C=b.meshes[S.mesh];for(const r of C.primitives)if(r.mode!==ri.TRIANGLES&&r.mode!==ri.TRIANGLE_STRIP&&r.mode!==ri.TRIANGLE_FAN&&void 0!==r.mode)return null;const I=S.extensions[this.name].attributes,A=[],R={};for(const r in I)A.push(this.parser.getDependency("accessor",I[r]).then((x=>(R[r]=x,R[r]))));return A.length<1?null:(A.push(this.parser.createNodeMesh(r)),Promise.all(A).then((r=>{const b=r.pop(),S=b.isGroup?b.children:[b],C=r[0].count,I=[];for(const r of S){const b=new B,S=new x,A=new _e,D=new x(1,1,1),F=new Ae(r.geometry,r.material,C);for(let r=0;r<C;r++)R.TRANSLATION&&S.fromBufferAttribute(R.TRANSLATION,r),R.ROTATION&&A.fromBufferAttribute(R.ROTATION,r),R.SCALE&&D.fromBufferAttribute(R.SCALE,r),F.setMatrixAt(r,b.compose(S,A,D));for(const x in R)if("_COLOR_0"===x){const r=R[x];F.instanceColor=new Ee(r.array,r.itemSize,r.normalized)}else"TRANSLATION"!==x&&"ROTATION"!==x&&"SCALE"!==x&&r.geometry.setAttribute(x,R[x]);ee.prototype.copy.call(F,r),this.parser.assignFinalMaterial(F),I.push(F)}return b.isGroup?(b.clear(),b.add(...I),b):I[0]})))}}const Qr="glTF",ei=1313821514,ti=5130562;class GLTFBinaryExtension{constructor(r){this.name=Jr.KHR_BINARY_GLTF,this.content=null,this.body=null;const x=new DataView(r,0,12),b=new TextDecoder;if(this.header={magic:b.decode(new Uint8Array(r.slice(0,4))),version:x.getUint32(4,!0),length:x.getUint32(8,!0)},this.header.magic!==Qr)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const S=this.header.length-12,C=new DataView(r,12);let I=0;for(;I<S;){const x=C.getUint32(I,!0);I+=4;const S=C.getUint32(I,!0);if(I+=4,S===ei){const S=new Uint8Array(r,12+I,x);this.content=b.decode(S)}else if(S===ti){const b=12+I;this.body=r.slice(b,b+x)}I+=x}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class GLTFDracoMeshCompressionExtension{constructor(r,x){if(!x)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=Jr.KHR_DRACO_MESH_COMPRESSION,this.json=r,this.dracoLoader=x,this.dracoLoader.preload()}decodePrimitive(r,x){const b=this.json,S=this.dracoLoader,C=r.extensions[this.name].bufferView,I=r.extensions[this.name].attributes,A={},R={},B={};for(const r in I){const x=li[r]||r.toLowerCase();A[x]=I[r]}for(const x in r.attributes){const S=li[x]||x.toLowerCase();if(void 0!==I[x]){const C=b.accessors[r.attributes[x]],I=ii[C.componentType];B[S]=I.name,R[S]=!0===C.normalized}}return x.getDependency("bufferView",C).then((function(r){return new Promise((function(x,b){S.decodeDracoFile(r,(function(r){for(const x in r.attributes){const b=r.attributes[x],S=R[x];void 0!==S&&(b.normalized=S)}x(r)}),A,B,Te,b)}))}))}}class GLTFTextureTransformExtension{constructor(){this.name=Jr.KHR_TEXTURE_TRANSFORM}extendTexture(r,x){return void 0!==x.texCoord&&x.texCoord!==r.channel||void 0!==x.offset||void 0!==x.rotation||void 0!==x.scale?(r=r.clone(),void 0!==x.texCoord&&(r.channel=x.texCoord),void 0!==x.offset&&r.offset.fromArray(x.offset),void 0!==x.rotation&&(r.rotation=x.rotation),void 0!==x.scale&&r.repeat.fromArray(x.scale),r.needsUpdate=!0,r):r}}class GLTFMeshQuantizationExtension{constructor(){this.name=Jr.KHR_MESH_QUANTIZATION}}class GLTFCubicSplineInterpolant extends ht{constructor(r,x,b,S){super(r,x,b,S)}copySampleValue_(r){const x=this.resultBuffer,b=this.sampleValues,S=this.valueSize,C=r*S*3+S;for(let r=0;r!==S;r++)x[r]=b[C+r];return x}interpolate_(r,x,b,S){const C=this.resultBuffer,I=this.sampleValues,A=this.valueSize,R=2*A,B=3*A,D=S-x,F=(b-x)/D,G=F*F,N=G*F,H=r*B,W=H-B,j=-2*N+3*G,V=N-G,X=1-j,q=V-G+F;for(let r=0;r!==A;r++){const x=I[W+r+A],b=I[W+r+R]*D,S=I[H+r+A],B=I[H+r]*D;C[r]=X*x+q*b+j*S+V*B}return C}}const ni=new _e;class GLTFCubicSplineQuaternionInterpolant extends GLTFCubicSplineInterpolant{interpolate_(r,x,b,S){const C=super.interpolate_(r,x,b,S);return ni.fromArray(C).normalize().toArray(C),C}}const ri={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},ii={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},si={9728:X,9729:Le,9984:et,9985:tt,9986:nt,9987:Oe},oi={33071:rt,33648:it,10497:De},ai={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},li={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},ci={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},hi={CUBICSPLINE:void 0,LINEAR:Je,STEP:st},di="OPAQUE",ui="MASK",pi="BLEND";function addUnknownExtensionsToUserData(r,x,b){for(const S in b.extensions)void 0===r[S]&&(x.userData.gltfExtensions=x.userData.gltfExtensions||{},x.userData.gltfExtensions[S]=b.extensions[S])}function assignExtrasToUserData(r,x){void 0!==x.extras&&("object"==typeof x.extras?Object.assign(r.userData,x.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+x.extras))}function updateMorphTargets(r,x){if(r.updateMorphTargets(),void 0!==x.weights)for(let b=0,S=x.weights.length;b<S;b++)r.morphTargetInfluences[b]=x.weights[b];if(x.extras&&Array.isArray(x.extras.targetNames)){const b=x.extras.targetNames;if(r.morphTargetInfluences.length===b.length){r.morphTargetDictionary={};for(let x=0,S=b.length;x<S;x++)r.morphTargetDictionary[b[x]]=x}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function createPrimitiveKey(r){let x;const b=r.extensions&&r.extensions[Jr.KHR_DRACO_MESH_COMPRESSION];if(x=b?"draco:"+b.bufferView+":"+b.indices+":"+createAttributesKey(b.attributes):r.indices+":"+createAttributesKey(r.attributes)+":"+r.mode,void 0!==r.targets)for(let b=0,S=r.targets.length;b<S;b++)x+=":"+createAttributesKey(r.targets[b]);return x}function createAttributesKey(r){let x="";const b=Object.keys(r).sort();for(let S=0,C=b.length;S<C;S++)x+=b[S]+":"+r[b[S]]+";";return x}function getNormalizedComponentScale(r){switch(r){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const fi=new B;class GLTFParser{constructor(r={},x={}){this.json=r,this.extensions={},this.plugins={},this.options=x,this.cache=new GLTFRegistry,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let b=!1,S=-1,C=!1,I=-1;if("undefined"!=typeof navigator){const r=navigator.userAgent;b=!0===/^((?!chrome|android).)*safari/i.test(r);const x=r.match(/Version\/(\d+)/);S=b&&x?parseInt(x[1],10):-1,C=r.indexOf("Firefox")>-1,I=C?r.match(/Firefox\/([0-9]+)\./)[1]:-1}"undefined"==typeof createImageBitmap||b&&S<17||C&&I<98?this.textureLoader=new Re(this.options.manager):this.textureLoader=new Me(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new xe(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(r){this.extensions=r}setPlugins(r){this.plugins=r}parse(r,x){const b=this,S=this.json,C=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll((function(r){return r._markDefs&&r._markDefs()})),Promise.all(this._invokeAll((function(r){return r.beforeRoot&&r.beforeRoot()}))).then((function(){return Promise.all([b.getDependencies("scene"),b.getDependencies("animation"),b.getDependencies("camera")])})).then((function(x){const I={scene:x[0][S.scene||0],scenes:x[0],animations:x[1],cameras:x[2],asset:S.asset,parser:b,userData:{}};return addUnknownExtensionsToUserData(C,I,S),assignExtrasToUserData(I,S),Promise.all(b._invokeAll((function(r){return r.afterRoot&&r.afterRoot(I)}))).then((function(){for(const r of I.scenes)r.updateMatrixWorld();r(I)}))})).catch(x)}_markDefs(){const r=this.json.nodes||[],x=this.json.skins||[],b=this.json.meshes||[];for(let b=0,S=x.length;b<S;b++){const S=x[b].joints;for(let x=0,b=S.length;x<b;x++)r[S[x]].isBone=!0}for(let x=0,S=r.length;x<S;x++){const S=r[x];void 0!==S.mesh&&(this._addNodeRef(this.meshCache,S.mesh),void 0!==S.skin&&(b[S.mesh].isSkinnedMesh=!0)),void 0!==S.camera&&this._addNodeRef(this.cameraCache,S.camera)}}_addNodeRef(r,x){void 0!==x&&(void 0===r.refs[x]&&(r.refs[x]=r.uses[x]=0),r.refs[x]++)}_getNodeRef(r,x,b){if(r.refs[x]<=1)return b;const S=b.clone(),updateMappings=(r,x)=>{const b=this.associations.get(r);null!=b&&this.associations.set(x,b);for(const[b,S]of r.children.entries())updateMappings(S,x.children[b])};return updateMappings(b,S),S.name+="_instance_"+r.uses[x]++,S}_invokeOne(r){const x=Object.values(this.plugins);x.push(this);for(let b=0;b<x.length;b++){const S=r(x[b]);if(S)return S}return null}_invokeAll(r){const x=Object.values(this.plugins);x.unshift(this);const b=[];for(let S=0;S<x.length;S++){const C=r(x[S]);C&&b.push(C)}return b}getDependency(r,x){const b=r+":"+x;let S=this.cache.get(b);if(!S){switch(r){case"scene":S=this.loadScene(x);break;case"node":S=this._invokeOne((function(r){return r.loadNode&&r.loadNode(x)}));break;case"mesh":S=this._invokeOne((function(r){return r.loadMesh&&r.loadMesh(x)}));break;case"accessor":S=this.loadAccessor(x);break;case"bufferView":S=this._invokeOne((function(r){return r.loadBufferView&&r.loadBufferView(x)}));break;case"buffer":S=this.loadBuffer(x);break;case"material":S=this._invokeOne((function(r){return r.loadMaterial&&r.loadMaterial(x)}));break;case"texture":S=this._invokeOne((function(r){return r.loadTexture&&r.loadTexture(x)}));break;case"skin":S=this.loadSkin(x);break;case"animation":S=this._invokeOne((function(r){return r.loadAnimation&&r.loadAnimation(x)}));break;case"camera":S=this.loadCamera(x);break;default:if(S=this._invokeOne((function(b){return b!=this&&b.getDependency&&b.getDependency(r,x)})),!S)throw new Error("Unknown type: "+r)}this.cache.add(b,S)}return S}getDependencies(r){let x=this.cache.get(r);if(!x){const b=this,S=this.json[r+("mesh"===r?"es":"s")]||[];x=Promise.all(S.map((function(x,S){return b.getDependency(r,S)}))),this.cache.add(r,x)}return x}loadBuffer(r){const x=this.json.buffers[r],b=this.fileLoader;if(x.type&&"arraybuffer"!==x.type)throw new Error("THREE.GLTFLoader: "+x.type+" buffer type is not supported.");if(void 0===x.uri&&0===r)return Promise.resolve(this.extensions[Jr.KHR_BINARY_GLTF].body);const S=this.options;return new Promise((function(r,C){b.load(ve.resolveURL(x.uri,S.path),r,void 0,(function(){C(new Error('THREE.GLTFLoader: Failed to load buffer "'+x.uri+'".'))}))}))}loadBufferView(r){const x=this.json.bufferViews[r];return this.getDependency("buffer",x.buffer).then((function(r){const b=x.byteLength||0,S=x.byteOffset||0;return r.slice(S,S+b)}))}loadAccessor(r){const x=this,b=this.json,S=this.json.accessors[r];if(void 0===S.bufferView&&void 0===S.sparse){const r=ai[S.type],x=ii[S.componentType],b=!0===S.normalized,C=new x(S.count*r);return Promise.resolve(new D(C,r,b))}const C=[];return void 0!==S.bufferView?C.push(this.getDependency("bufferView",S.bufferView)):C.push(null),void 0!==S.sparse&&(C.push(this.getDependency("bufferView",S.sparse.indices.bufferView)),C.push(this.getDependency("bufferView",S.sparse.values.bufferView))),Promise.all(C).then((function(r){const C=r[0],I=ai[S.type],A=ii[S.componentType],R=A.BYTES_PER_ELEMENT,B=R*I,F=S.byteOffset||0,G=void 0!==S.bufferView?b.bufferViews[S.bufferView].byteStride:void 0,N=!0===S.normalized;let H,W;if(G&&G!==B){const r=Math.floor(F/G),b="InterleavedBuffer:"+S.bufferView+":"+S.componentType+":"+r+":"+S.count;let B=x.cache.get(b);B||(H=new A(C,r*G,S.count*G/R),B=new Pe(H,G/R),x.cache.add(b,B)),W=new Be(B,I,F%G/R,N)}else H=null===C?new A(S.count*I):new A(C,F,S.count*I),W=new D(H,I,N);if(void 0!==S.sparse){const x=ai.SCALAR,b=ii[S.sparse.indices.componentType],R=S.sparse.indices.byteOffset||0,B=S.sparse.values.byteOffset||0,F=new b(r[1],R,S.sparse.count*x),G=new A(r[2],B,S.sparse.count*I);null!==C&&(W=new D(W.array.slice(),W.itemSize,W.normalized)),W.normalized=!1;for(let r=0,x=F.length;r<x;r++){const x=F[r];if(W.setX(x,G[r*I]),I>=2&&W.setY(x,G[r*I+1]),I>=3&&W.setZ(x,G[r*I+2]),I>=4&&W.setW(x,G[r*I+3]),I>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}W.normalized=N}return W}))}loadTexture(r){const x=this.json,b=this.options,S=x.textures[r].source,C=x.images[S];let I=this.textureLoader;if(C.uri){const r=b.manager.getHandler(C.uri);null!==r&&(I=r)}return this.loadTextureImage(r,S,I)}loadTextureImage(r,x,b){const S=this,C=this.json,I=C.textures[r],A=C.images[x],R=(A.uri||A.bufferView)+":"+I.sampler;if(this.textureCache[R])return this.textureCache[R];const B=this.loadImageSource(x,b).then((function(x){x.flipY=!1,x.name=I.name||A.name||"",""===x.name&&"string"==typeof A.uri&&!1===A.uri.startsWith("data:image/")&&(x.name=A.uri);const b=(C.samplers||{})[I.sampler]||{};return x.magFilter=si[b.magFilter]||Le,x.minFilter=si[b.minFilter]||Oe,x.wrapS=oi[b.wrapS]||De,x.wrapT=oi[b.wrapT]||De,x.generateMipmaps=!x.isCompressedTexture&&x.minFilter!==X&&x.minFilter!==Le,S.associations.set(x,{textures:r}),x})).catch((function(){return null}));return this.textureCache[R]=B,B}loadImageSource(r,x){const b=this,S=this.json,C=this.options;if(void 0!==this.sourceCache[r])return this.sourceCache[r].then((r=>r.clone()));const I=S.images[r],A=self.URL||self.webkitURL;let R=I.uri||"",B=!1;if(void 0!==I.bufferView)R=b.getDependency("bufferView",I.bufferView).then((function(r){B=!0;const x=new Blob([r],{type:I.mimeType});return R=A.createObjectURL(x),R}));else if(void 0===I.uri)throw new Error("THREE.GLTFLoader: Image "+r+" is missing URI and bufferView");const D=Promise.resolve(R).then((function(r){return new Promise((function(b,S){let I=b;!0===x.isImageBitmapLoader&&(I=function(r){const x=new ot(r);x.needsUpdate=!0,b(x)}),x.load(ve.resolveURL(r,C.path),I,void 0,S)}))})).then((function(r){var x;return!0===B&&A.revokeObjectURL(R),assignExtrasToUserData(r,I),r.userData.mimeType=I.mimeType||((x=I.uri).search(/\.jpe?g($|\?)/i)>0||0===x.search(/^data\:image\/jpeg/)?"image/jpeg":x.search(/\.webp($|\?)/i)>0||0===x.search(/^data\:image\/webp/)?"image/webp":x.search(/\.ktx2($|\?)/i)>0||0===x.search(/^data\:image\/ktx2/)?"image/ktx2":"image/png"),r})).catch((function(r){throw console.error("THREE.GLTFLoader: Couldn't load texture",R),r}));return this.sourceCache[r]=D,D}assignTexture(r,x,b,S){const C=this;return this.getDependency("texture",b.index).then((function(I){if(!I)return null;if(void 0!==b.texCoord&&b.texCoord>0&&((I=I.clone()).channel=b.texCoord),C.extensions[Jr.KHR_TEXTURE_TRANSFORM]){const r=void 0!==b.extensions?b.extensions[Jr.KHR_TEXTURE_TRANSFORM]:void 0;if(r){const x=C.associations.get(I);I=C.extensions[Jr.KHR_TEXTURE_TRANSFORM].extendTexture(I,r),C.associations.set(I,x)}}return void 0!==S&&(I.colorSpace=S),r[x]=I,I}))}assignFinalMaterial(r){const x=r.geometry;let b=r.material;const S=void 0===x.attributes.tangent,C=void 0!==x.attributes.color,I=void 0===x.attributes.normal;if(r.isPoints){const r="PointsMaterial:"+b.uuid;let x=this.cache.get(r);x||(x=new Ue,Fe.prototype.copy.call(x,b),x.color.copy(b.color),x.map=b.map,x.sizeAttenuation=!1,this.cache.add(r,x)),b=x}else if(r.isLine){const r="LineBasicMaterial:"+b.uuid;let x=this.cache.get(r);x||(x=new H,Fe.prototype.copy.call(x,b),x.color.copy(b.color),x.map=b.map,this.cache.add(r,x)),b=x}if(S||C||I){let r="ClonedMaterial:"+b.uuid+":";S&&(r+="derivative-tangents:"),C&&(r+="vertex-colors:"),I&&(r+="flat-shading:");let x=this.cache.get(r);x||(x=b.clone(),C&&(x.vertexColors=!0),I&&(x.flatShading=!0),S&&(x.normalScale&&(x.normalScale.y*=-1),x.clearcoatNormalScale&&(x.clearcoatNormalScale.y*=-1)),this.cache.add(r,x),this.associations.set(x,this.associations.get(b))),b=x}r.material=b}getMaterialType(){return Ge}loadMaterial(r){const x=this,b=this.json,S=this.extensions,C=b.materials[r];let I;const A={},B=[];if((C.extensions||{})[Jr.KHR_MATERIALS_UNLIT]){const r=S[Jr.KHR_MATERIALS_UNLIT];I=r.getMaterialType(),B.push(r.extendParams(A,C,x))}else{const b=C.pbrMetallicRoughness||{};if(A.color=new be(1,1,1),A.opacity=1,Array.isArray(b.baseColorFactor)){const r=b.baseColorFactor;A.color.setRGB(r[0],r[1],r[2],Te),A.opacity=r[3]}void 0!==b.baseColorTexture&&B.push(x.assignTexture(A,"map",b.baseColorTexture,Ie)),A.metalness=void 0!==b.metallicFactor?b.metallicFactor:1,A.roughness=void 0!==b.roughnessFactor?b.roughnessFactor:1,void 0!==b.metallicRoughnessTexture&&(B.push(x.assignTexture(A,"metalnessMap",b.metallicRoughnessTexture)),B.push(x.assignTexture(A,"roughnessMap",b.metallicRoughnessTexture))),I=this._invokeOne((function(x){return x.getMaterialType&&x.getMaterialType(r)})),B.push(Promise.all(this._invokeAll((function(x){return x.extendMaterialParams&&x.extendMaterialParams(r,A)}))))}!0===C.doubleSided&&(A.side=pe);const D=C.alphaMode||di;if(D===pi?(A.transparent=!0,A.depthWrite=!1):(A.transparent=!1,D===ui&&(A.alphaTest=void 0!==C.alphaCutoff?C.alphaCutoff:.5)),void 0!==C.normalTexture&&I!==W&&(B.push(x.assignTexture(A,"normalMap",C.normalTexture)),A.normalScale=new R(1,1),void 0!==C.normalTexture.scale)){const r=C.normalTexture.scale;A.normalScale.set(r,r)}if(void 0!==C.occlusionTexture&&I!==W&&(B.push(x.assignTexture(A,"aoMap",C.occlusionTexture)),void 0!==C.occlusionTexture.strength&&(A.aoMapIntensity=C.occlusionTexture.strength)),void 0!==C.emissiveFactor&&I!==W){const r=C.emissiveFactor;A.emissive=(new be).setRGB(r[0],r[1],r[2],Te)}return void 0!==C.emissiveTexture&&I!==W&&B.push(x.assignTexture(A,"emissiveMap",C.emissiveTexture,Ie)),Promise.all(B).then((function(){const b=new I(A);return C.name&&(b.name=C.name),assignExtrasToUserData(b,C),x.associations.set(b,{materials:r}),C.extensions&&addUnknownExtensionsToUserData(S,b,C),b}))}createUniqueName(r){const x=Ne.sanitizeNodeName(r||"");return x in this.nodeNamesUsed?x+"_"+ ++this.nodeNamesUsed[x]:(this.nodeNamesUsed[x]=0,x)}loadGeometries(r){const x=this,b=this.extensions,S=this.primitiveCache;function createDracoPrimitive(r){return b[Jr.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(r,x).then((function(b){return addPrimitiveAttributes(b,r,x)}))}const C=[];for(let b=0,I=r.length;b<I;b++){const I=r[b],A=createPrimitiveKey(I),R=S[A];if(R)C.push(R.promise);else{let r;r=I.extensions&&I.extensions[Jr.KHR_DRACO_MESH_COMPRESSION]?createDracoPrimitive(I):addPrimitiveAttributes(new J,I,x),S[A]={primitive:I,promise:r},C.push(r)}}return Promise.all(C)}loadMesh(r){const x=this,S=this.json,C=this.extensions,I=S.meshes[r],A=I.primitives,R=[];for(let r=0,x=A.length;r<x;r++){const x=void 0===A[r].material?(void 0===(B=this.cache).DefaultMaterial&&(B.DefaultMaterial=new Ge({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:G})),B.DefaultMaterial):this.getDependency("material",A[r].material);R.push(x)}var B;return R.push(x.loadGeometries(A)),Promise.all(R).then((function(S){const R=S.slice(0,S.length-1),B=S[S.length-1],D=[];for(let S=0,F=B.length;S<F;S++){const F=B[S],G=A[S];let N;const H=R[S];if(G.mode===ri.TRIANGLES||G.mode===ri.TRIANGLE_STRIP||G.mode===ri.TRIANGLE_FAN||void 0===G.mode)N=!0===I.isSkinnedMesh?new He(F,H):new b(F,H),!0===N.isSkinnedMesh&&N.normalizeSkinWeights(),G.mode===ri.TRIANGLE_STRIP?N.geometry=toTrianglesDrawMode(N.geometry,me):G.mode===ri.TRIANGLE_FAN&&(N.geometry=toTrianglesDrawMode(N.geometry,ge));else if(G.mode===ri.LINES)N=new We(F,H);else if(G.mode===ri.LINE_STRIP)N=new ze(F,H);else if(G.mode===ri.LINE_LOOP)N=new je(F,H);else{if(G.mode!==ri.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+G.mode);N=new Ve(F,H)}Object.keys(N.geometry.morphAttributes).length>0&&updateMorphTargets(N,I),N.name=x.createUniqueName(I.name||"mesh_"+r),assignExtrasToUserData(N,I),G.extensions&&addUnknownExtensionsToUserData(C,N,G),x.assignFinalMaterial(N),D.push(N)}for(let b=0,S=D.length;b<S;b++)x.associations.set(D[b],{meshes:r,primitives:b});if(1===D.length)return I.extensions&&addUnknownExtensionsToUserData(C,D[0],I),D[0];const F=new N;I.extensions&&addUnknownExtensionsToUserData(C,F,I),x.associations.set(F,{meshes:r});for(let r=0,x=D.length;r<x;r++)F.add(D[r]);return F}))}loadCamera(r){let x;const b=this.json.cameras[r],S=b[b.type];if(S)return"perspective"===b.type?x=new Xe(qe.radToDeg(S.yfov),S.aspectRatio||1,S.znear||1,S.zfar||2e6):"orthographic"===b.type&&(x=new $e(-S.xmag,S.xmag,S.ymag,-S.ymag,S.znear,S.zfar)),b.name&&(x.name=this.createUniqueName(b.name)),assignExtrasToUserData(x,b),Promise.resolve(x);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(r){const x=this.json.skins[r],b=[];for(let r=0,S=x.joints.length;r<S;r++)b.push(this._loadNodeShallow(x.joints[r]));return void 0!==x.inverseBindMatrices?b.push(this.getDependency("accessor",x.inverseBindMatrices)):b.push(null),Promise.all(b).then((function(r){const b=r.pop(),S=r,C=[],I=[];for(let r=0,A=S.length;r<A;r++){const A=S[r];if(A){C.push(A);const x=new B;null!==b&&x.fromArray(b.array,16*r),I.push(x)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',x.joints[r])}return new Ke(C,I)}))}loadAnimation(r){const x=this.json,b=this,S=x.animations[r],C=S.name?S.name:"animation_"+r,I=[],A=[],R=[],B=[],D=[];for(let r=0,x=S.channels.length;r<x;r++){const x=S.channels[r],b=S.samplers[x.sampler],C=x.target,F=C.node,G=void 0!==S.parameters?S.parameters[b.input]:b.input,N=void 0!==S.parameters?S.parameters[b.output]:b.output;void 0!==C.node&&(I.push(this.getDependency("node",F)),A.push(this.getDependency("accessor",G)),R.push(this.getDependency("accessor",N)),B.push(b),D.push(C))}return Promise.all([Promise.all(I),Promise.all(A),Promise.all(R),Promise.all(B),Promise.all(D)]).then((function(r){const x=r[0],I=r[1],A=r[2],R=r[3],B=r[4],D=[];for(let r=0,S=x.length;r<S;r++){const S=x[r],C=I[r],F=A[r],G=R[r],N=B[r];if(void 0===S)continue;S.updateMatrix&&S.updateMatrix();const H=b._createAnimationTracks(S,C,F,G,N);if(H)for(let r=0;r<H.length;r++)D.push(H[r])}const F=new Ye(C,void 0,D);return assignExtrasToUserData(F,S),F}))}createNodeMesh(r){const x=this.json,b=this,S=x.nodes[r];return void 0===S.mesh?null:b.getDependency("mesh",S.mesh).then((function(r){const x=b._getNodeRef(b.meshCache,S.mesh,r);return void 0!==S.weights&&x.traverse((function(r){if(r.isMesh)for(let x=0,b=S.weights.length;x<b;x++)r.morphTargetInfluences[x]=S.weights[x]})),x}))}loadNode(r){const x=this,b=this.json.nodes[r],S=x._loadNodeShallow(r),C=[],I=b.children||[];for(let r=0,b=I.length;r<b;r++)C.push(x.getDependency("node",I[r]));const A=void 0===b.skin?Promise.resolve(null):x.getDependency("skin",b.skin);return Promise.all([S,Promise.all(C),A]).then((function(r){const x=r[0],b=r[1],S=r[2];null!==S&&x.traverse((function(r){r.isSkinnedMesh&&r.bind(S,fi)}));for(let r=0,S=b.length;r<S;r++)x.add(b[r]);return x}))}_loadNodeShallow(r){const x=this.json,b=this.extensions,S=this;if(void 0!==this.nodeCache[r])return this.nodeCache[r];const C=x.nodes[r],I=C.name?S.createUniqueName(C.name):"",A=[],R=S._invokeOne((function(x){return x.createNodeMesh&&x.createNodeMesh(r)}));return R&&A.push(R),void 0!==C.camera&&A.push(S.getDependency("camera",C.camera).then((function(r){return S._getNodeRef(S.cameraCache,C.camera,r)}))),S._invokeAll((function(x){return x.createNodeAttachment&&x.createNodeAttachment(r)})).forEach((function(r){A.push(r)})),this.nodeCache[r]=Promise.all(A).then((function(x){let A;if(A=!0===C.isBone?new Ze:x.length>1?new N:1===x.length?x[0]:new ee,A!==x[0])for(let r=0,b=x.length;r<b;r++)A.add(x[r]);if(C.name&&(A.userData.name=C.name,A.name=I),assignExtrasToUserData(A,C),C.extensions&&addUnknownExtensionsToUserData(b,A,C),void 0!==C.matrix){const r=new B;r.fromArray(C.matrix),A.applyMatrix4(r)}else void 0!==C.translation&&A.position.fromArray(C.translation),void 0!==C.rotation&&A.quaternion.fromArray(C.rotation),void 0!==C.scale&&A.scale.fromArray(C.scale);if(S.associations.has(A)){if(void 0!==C.mesh&&S.meshCache.refs[C.mesh]>1){const r=S.associations.get(A);S.associations.set(A,{...r})}}else S.associations.set(A,{});return S.associations.get(A).nodes=r,A})),this.nodeCache[r]}loadScene(r){const x=this.extensions,b=this.json.scenes[r],S=this,C=new N;b.name&&(C.name=S.createUniqueName(b.name)),assignExtrasToUserData(C,b),b.extensions&&addUnknownExtensionsToUserData(x,C,b);const I=b.nodes||[],A=[];for(let r=0,x=I.length;r<x;r++)A.push(S.getDependency("node",I[r]));return Promise.all(A).then((function(r){for(let x=0,b=r.length;x<b;x++)C.add(r[x]);return S.associations=(r=>{const x=new Map;for(const[r,b]of S.associations)(r instanceof Fe||r instanceof ot)&&x.set(r,b);return r.traverse((r=>{const b=S.associations.get(r);null!=b&&x.set(r,b)})),x})(C),C}))}_createAnimationTracks(r,x,b,S,C){const I=[],A=r.name?r.name:r.uuid,R=[];let B;switch(ci[C.path]===ci.weights?r.traverse((function(r){r.morphTargetInfluences&&R.push(r.name?r.name:r.uuid)})):R.push(A),ci[C.path]){case ci.weights:B=lt;break;case ci.rotation:B=ct;break;case ci.translation:case ci.scale:B=at;break;default:if(1===b.itemSize)B=lt;else B=at}const D=void 0!==S.interpolation?hi[S.interpolation]:Je,F=this._getArrayFromAccessor(b);for(let r=0,b=R.length;r<b;r++){const b=new B(R[r]+"."+ci[C.path],x.array,F,D);"CUBICSPLINE"===S.interpolation&&this._createCubicSplineTrackInterpolant(b),I.push(b)}return I}_getArrayFromAccessor(r){let x=r.array;if(r.normalized){const r=getNormalizedComponentScale(x.constructor),b=new Float32Array(x.length);for(let S=0,C=x.length;S<C;S++)b[S]=x[S]*r;x=b}return x}_createCubicSplineTrackInterpolant(r){r.createInterpolant=function(r){return new(this instanceof ct?GLTFCubicSplineQuaternionInterpolant:GLTFCubicSplineInterpolant)(this.times,this.values,this.getValueSize()/3,r)},r.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function addPrimitiveAttributes(r,b,S){const C=b.attributes,I=[];function assignAttributeAccessor(x,b){return S.getDependency("accessor",x).then((function(x){r.setAttribute(b,x)}))}for(const x in C){const b=li[x]||x.toLowerCase();b in r.attributes||I.push(assignAttributeAccessor(C[x],b))}if(void 0!==b.indices&&!r.index){const x=S.getDependency("accessor",b.indices).then((function(x){r.setIndex(x)}));I.push(x)}return Qe.workingColorSpace!==Te&&"COLOR_0"in C&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${Qe.workingColorSpace}" not supported.`),assignExtrasToUserData(r,b),function(r,b,S){const C=b.attributes,I=new F;if(void 0===C.POSITION)return;{const r=S.json.accessors[C.POSITION],b=r.min,A=r.max;if(void 0===b||void 0===A)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(I.set(new x(b[0],b[1],b[2]),new x(A[0],A[1],A[2])),r.normalized){const x=getNormalizedComponentScale(ii[r.componentType]);I.min.multiplyScalar(x),I.max.multiplyScalar(x)}}const A=b.targets;if(void 0!==A){const r=new x,b=new x;for(let x=0,C=A.length;x<C;x++){const C=A[x];if(void 0!==C.POSITION){const x=S.json.accessors[C.POSITION],I=x.min,A=x.max;if(void 0!==I&&void 0!==A){if(b.setX(Math.max(Math.abs(I[0]),Math.abs(A[0]))),b.setY(Math.max(Math.abs(I[1]),Math.abs(A[1]))),b.setZ(Math.max(Math.abs(I[2]),Math.abs(A[2]))),x.normalized){const r=getNormalizedComponentScale(ii[x.componentType]);b.multiplyScalar(r)}r.max(b)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}I.expandByVector(r)}r.boundingBox=I;const R=new j;I.getCenter(R.center),R.radius=I.min.distanceTo(I.max)/2,r.boundingSphere=R}(r,b,S),Promise.all(I).then((function(){return void 0!==b.targets?function(r,x,b){let S=!1,C=!1,I=!1;for(let r=0,b=x.length;r<b;r++){const b=x[r];if(void 0!==b.POSITION&&(S=!0),void 0!==b.NORMAL&&(C=!0),void 0!==b.COLOR_0&&(I=!0),S&&C&&I)break}if(!S&&!C&&!I)return Promise.resolve(r);const A=[],R=[],B=[];for(let D=0,F=x.length;D<F;D++){const F=x[D];if(S){const x=void 0!==F.POSITION?b.getDependency("accessor",F.POSITION):r.attributes.position;A.push(x)}if(C){const x=void 0!==F.NORMAL?b.getDependency("accessor",F.NORMAL):r.attributes.normal;R.push(x)}if(I){const x=void 0!==F.COLOR_0?b.getDependency("accessor",F.COLOR_0):r.attributes.color;B.push(x)}}return Promise.all([Promise.all(A),Promise.all(R),Promise.all(B)]).then((function(x){const b=x[0],A=x[1],R=x[2];return S&&(r.morphAttributes.position=b),C&&(r.morphAttributes.normal=A),I&&(r.morphAttributes.color=R),r.morphTargetsRelative=!0,r}))}(r,b.targets,S):r}))}const gi={Handedness:Object.freeze({NONE:"none",LEFT:"left",RIGHT:"right"}),ComponentState:Object.freeze({DEFAULT:"default",TOUCHED:"touched",PRESSED:"pressed"}),ComponentProperty:Object.freeze({BUTTON:"button",X_AXIS:"xAxis",Y_AXIS:"yAxis",STATE:"state"}),ComponentType:Object.freeze({TRIGGER:"trigger",SQUEEZE:"squeeze",TOUCHPAD:"touchpad",THUMBSTICK:"thumbstick",BUTTON:"button"}),ButtonTouchThreshold:.05,AxisTouchThreshold:.1,VisualResponseProperty:Object.freeze({TRANSFORM:"transform",VISIBILITY:"visibility"})};async function fetchJsonFile(r){const x=await fetch(r);if(x.ok)return x.json();throw new Error(x.statusText)}async function fetchProfile(r,x,b=null,S=!0){if(!r)throw new Error("No xrInputSource supplied");if(!x)throw new Error("No basePath supplied");const C=await async function(r){if(!r)throw new Error("No basePath supplied");return await fetchJsonFile(`${r}/profilesList.json`)}(x);let I;if(r.profiles.some((r=>{const b=C[r];return b&&(I={profileId:r,profilePath:`${x}/${b.path}`,deprecated:!!b.deprecated}),!!I})),!I){if(!b)throw new Error("No matching profile name found");const r=C[b];if(!r)throw new Error(`No matching profile name found and default profile "${b}" missing.`);I={profileId:b,profilePath:`${x}/${r.path}`,deprecated:!!r.deprecated}}const A=await fetchJsonFile(I.profilePath);let R;if(S){let x;if(x="any"===r.handedness?A.layouts[Object.keys(A.layouts)[0]]:A.layouts[r.handedness],!x)throw new Error(`No matching handedness, ${r.handedness}, in profile ${I.profileId}`);x.assetPath&&(R=I.profilePath.replace("profile.json",x.assetPath))}return{profile:A,assetPath:R}}const mi={xAxis:0,yAxis:0,button:0,state:gi.ComponentState.DEFAULT};class VisualResponse{constructor(r){this.componentProperty=r.componentProperty,this.states=r.states,this.valueNodeName=r.valueNodeName,this.valueNodeProperty=r.valueNodeProperty,this.valueNodeProperty===gi.VisualResponseProperty.TRANSFORM&&(this.minNodeName=r.minNodeName,this.maxNodeName=r.maxNodeName),this.value=0,this.updateFromComponent(mi)}updateFromComponent({xAxis:r,yAxis:x,button:b,state:S}){const{normalizedXAxis:C,normalizedYAxis:I}=function(r=0,x=0){let b=r,S=x;if(Math.sqrt(r*r+x*x)>1){const C=Math.atan2(x,r);b=Math.cos(C),S=Math.sin(C)}return{normalizedXAxis:.5*b+.5,normalizedYAxis:.5*S+.5}}(r,x);switch(this.componentProperty){case gi.ComponentProperty.X_AXIS:this.value=this.states.includes(S)?C:.5;break;case gi.ComponentProperty.Y_AXIS:this.value=this.states.includes(S)?I:.5;break;case gi.ComponentProperty.BUTTON:this.value=this.states.includes(S)?b:0;break;case gi.ComponentProperty.STATE:this.valueNodeProperty===gi.VisualResponseProperty.VISIBILITY?this.value=this.states.includes(S):this.value=this.states.includes(S)?1:0;break;default:throw new Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`)}}}class Component{constructor(r,x){if(!(r&&x&&x.visualResponses&&x.gamepadIndices&&0!==Object.keys(x.gamepadIndices).length))throw new Error("Invalid arguments supplied");this.id=r,this.type=x.type,this.rootNodeName=x.rootNodeName,this.touchPointNodeName=x.touchPointNodeName,this.visualResponses={},Object.keys(x.visualResponses).forEach((r=>{const b=new VisualResponse(x.visualResponses[r]);this.visualResponses[r]=b})),this.gamepadIndices=Object.assign({},x.gamepadIndices),this.values={state:gi.ComponentState.DEFAULT,button:void 0!==this.gamepadIndices.button?0:void 0,xAxis:void 0!==this.gamepadIndices.xAxis?0:void 0,yAxis:void 0!==this.gamepadIndices.yAxis?0:void 0}}get data(){return{id:this.id,...this.values}}updateFromGamepad(r){if(this.values.state=gi.ComponentState.DEFAULT,void 0!==this.gamepadIndices.button&&r.buttons.length>this.gamepadIndices.button){const x=r.buttons[this.gamepadIndices.button];this.values.button=x.value,this.values.button=this.values.button<0?0:this.values.button,this.values.button=this.values.button>1?1:this.values.button,x.pressed||1===this.values.button?this.values.state=gi.ComponentState.PRESSED:(x.touched||this.values.button>gi.ButtonTouchThreshold)&&(this.values.state=gi.ComponentState.TOUCHED)}void 0!==this.gamepadIndices.xAxis&&r.axes.length>this.gamepadIndices.xAxis&&(this.values.xAxis=r.axes[this.gamepadIndices.xAxis],this.values.xAxis=this.values.xAxis<-1?-1:this.values.xAxis,this.values.xAxis=this.values.xAxis>1?1:this.values.xAxis,this.values.state===gi.ComponentState.DEFAULT&&Math.abs(this.values.xAxis)>gi.AxisTouchThreshold&&(this.values.state=gi.ComponentState.TOUCHED)),void 0!==this.gamepadIndices.yAxis&&r.axes.length>this.gamepadIndices.yAxis&&(this.values.yAxis=r.axes[this.gamepadIndices.yAxis],this.values.yAxis=this.values.yAxis<-1?-1:this.values.yAxis,this.values.yAxis=this.values.yAxis>1?1:this.values.yAxis,this.values.state===gi.ComponentState.DEFAULT&&Math.abs(this.values.yAxis)>gi.AxisTouchThreshold&&(this.values.state=gi.ComponentState.TOUCHED)),Object.values(this.visualResponses).forEach((r=>{r.updateFromComponent(this.values)}))}}class MotionController{constructor(r,x,b){if(!r)throw new Error("No xrInputSource supplied");if(!x)throw new Error("No profile supplied");this.xrInputSource=r,this.assetUrl=b,this.id=x.profileId,this.layoutDescription=x.layouts[r.handedness],this.components={},Object.keys(this.layoutDescription.components).forEach((r=>{const x=this.layoutDescription.components[r];this.components[r]=new Component(r,x)})),this.updateFromGamepad()}get gripSpace(){return this.xrInputSource.gripSpace}get targetRaySpace(){return this.xrInputSource.targetRaySpace}get data(){const r=[];return Object.values(this.components).forEach((x=>{r.push(x.data)})),r}updateFromGamepad(){Object.values(this.components).forEach((r=>{r.updateFromGamepad(this.xrInputSource.gamepad)}))}}class XRControllerModel extends ee{constructor(){super(),this.motionController=null,this.envMap=null}setEnvironmentMap(r){return this.envMap==r||(this.envMap=r,this.traverse((r=>{r.isMesh&&(r.material.envMap=this.envMap,r.material.needsUpdate=!0)}))),this}updateMatrixWorld(r){if(super.updateMatrixWorld(r),!this.motionController)return;let x=this.motionController.xrInputSource?.gamepad;x&&this.motionController.updateFromGamepad(),Object.values(this.motionController.components).forEach((r=>{Object.values(r.visualResponses).forEach((r=>{const{valueNode:x,minNode:b,maxNode:S,value:C,valueNodeProperty:I}=r;x&&(I===gi.VisualResponseProperty.VISIBILITY?x.visible=C:I===gi.VisualResponseProperty.TRANSFORM&&(x.quaternion.slerpQuaternions(b.quaternion,S.quaternion,C),x.position.lerpVectors(b.position,S.position,C)))}))}))}}function addAssetSceneToControllerModel(r,x){!function(r,x){Object.values(r.components).forEach((r=>{const{type:S,touchPointNodeName:C,visualResponses:I}=r;if(S===gi.ComponentType.TOUCHPAD)if(r.touchPointNode=x.getObjectByName(C),r.touchPointNode){const x=new dt(.001),S=new W({color:255}),C=new b(x,S);r.touchPointNode.add(C)}else console.warn("Could not find touch dot, "+r.touchPointNodeName+", in touchpad component "+r.id);Object.values(I).forEach((r=>{const{valueNodeName:b,minNodeName:S,maxNodeName:C,valueNodeProperty:I}=r;if(I===gi.VisualResponseProperty.TRANSFORM){if(r.minNode=x.getObjectByName(S),r.maxNode=x.getObjectByName(C),!r.minNode)return void console.warn(`Could not find ${S} in the model`);if(!r.maxNode)return void console.warn(`Could not find ${C} in the model`)}r.valueNode=x.getObjectByName(b),r.valueNode||console.warn(`Could not find ${b} in the model`)}))}))}(r.motionController,x),r.envMap&&x.traverse((x=>{x.isMesh&&(x.material.envMap=r.envMap,x.material.needsUpdate=!0)})),r.add(x)}const _i="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles/generic-hand/";class XRHandMeshModel{constructor(r,b,S,I,A=null){this.xrInputSource=b,this.handModel=r,this.bones=[],this._fingertips=[],this._phalanxProximals=[],this._palmTriangleVectors=[new x,new x,new x],this._palmTriangleBones=[],this._palmTriangle=new C,this.isPinching=!1,this.isGrabbing=!1,this.palmDirection=new x,null===A&&(A=new GLTFLoader).setPath(S||_i),A.load(`${I}.glb`,(x=>{const b=x.scene.children[0];this.handModel.add(b),this.assetUrl=_i+`${I}.glb`;const S=b.getObjectByProperty("type","SkinnedMesh");S.frustumCulled=!1,S.castShadow=!0,S.receiveShadow=!0;["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"].forEach((r=>{const x=b.getObjectByName(r);void 0!==x?x.jointName=r:console.warn(`Couldn't find ${r} in ${I} hand mesh`),this.bones.push(x)}));for(let r of[4,9,14,19,24])this._fingertips.push(this.bones[r]);for(let r of[2,6,11,16,21])this._phalanxProximals.push(this.bones[r]);this._palmTriangleBones.push(this.bones[5]),this._palmTriangleBones.push(this.bones[6]),this._palmTriangleBones.push(this.bones[10]),"left"==I&&this._palmTriangleBones.reverse(),setupBVHForComplexObject(r)}))}_updateGestures(){let r=this.bones[0];if(!r)return;let x=!0,b=r.position;for(let r=2;r<5;r++){let S=this._fingertips[r].position,C=this._phalanxProximals[r].position;if(S.distanceTo(b)>C.distanceTo(b)){x=!1;break}}this.isGrabbing=x;let S=this.bones[4],C=this.bones[9],I=S.position.distanceTo(C.position);this.isPinching?I>.025&&(this.isPinching=!1):I<.015&&(this.isPinching=!0);for(let r=0;r<3;r++)this._palmTriangleBones[r].getWorldPosition(this._palmTriangleVectors[r]);this._palmTriangle.setFromPointsAndIndices(this._palmTriangleVectors,0,1,2),this._palmTriangle.getNormal(this.palmDirection)}updateMesh(r,x,b){if(!b)return;b=b.clone().invert();let S=0;for(let C of this.xrInputSource.hand.values()){let I=this.bones[S],A=r.getJointPose(C,x);I&&A&&(I.matrix.fromArray(A.transform.matrix).premultiply(b),I.matrix.decompose(I.position,I.rotation,I.scale)),S++}this._updateGestures()}}class XRHandModel extends ee{constructor(r){super(),this.controller=r,this.motionController=null,this.envMap=null,this.mesh=null}}const yi=new class{constructor(r=null){this.gltfLoader=r,this.path="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",this._assetCache={},this.gltfLoader||(this.gltfLoader=new GLTFLoader)}createControllerModel(r){const x=new XRControllerModel;let b=null;if("tracked-pointer"===r.targetRayMode&&r.gamepad)return fetchProfile(r,this.path,"generic-trigger").then((({profile:S,assetPath:C})=>{x.motionController=new MotionController(r,S,C);const I=this._assetCache[x.motionController.assetUrl];if(I)b=I.scene.clone(),addAssetSceneToControllerModel(x,b);else{if(!this.gltfLoader)throw new Error("GLTFLoader not set.");this.gltfLoader.setPath(""),this.gltfLoader.load(x.motionController.assetUrl,(r=>{this._assetCache[x.motionController.assetUrl]=r,b=r.scene.clone(),addAssetSceneToControllerModel(x,b),setupBVHForComplexObject(x)}),null,(r=>{throw console.error(r),new Error("Asset "+x.motionController.assetUrl+" missing or malformed.")}))}})).catch((r=>{console.warn(r)})),x}},vi=new class{constructor(){this.path=null}setPath(r){return this.path=r,this}createHandModel(r){let x=r;const b=new XRHandModel;return x.hand&&!b.motionController&&(b.xrInputSource=x,b.motionController=new XRHandMeshModel(b,x,this.path,x.handedness)),b}};let xi=new class{init(r,x){this._container=r,this._renderer=x,this._renderer.domElement.tabIndex="1",this._xrInputDevices={};for(let r in Zr)this._xrInputDevices[r]={};this._pointerPosition=new R,this._pointerPressed=!1,this._keysPressed=new Set,this._keyCodesPressed=new Set,this._screenTouched=!1,this._joystickAngle=0,this._joystickDistance=0,this._container.style.position="relative",this._createExtraControls(),this._addEventListeners()}_addEventListeners(){if("XR"==Kr.active)this._renderer.xr.addEventListener("sessionstart",(()=>{this._onXRSessionStart()})),this._renderer.xr.addEventListener("sessionend",(()=>{this._onXRSessionEnd()}));else if("POINTER"==Kr.active)this._container.addEventListener("keydown",(r=>{this._keysPressed.add(r.key),this._keyCodesPressed.add(r.code)})),this._container.addEventListener("keyup",(r=>{this._keysPressed.delete(r.key),this._keyCodesPressed.delete(r.code)})),window.addEventListener("blur",(()=>{this._keysPressed.clear(),this._keyCodesPressed.clear()})),this._renderer.domElement.addEventListener("mousedown",(()=>{this._pointerPressed=!0})),this._renderer.domElement.addEventListener("mouseup",(()=>{this._pointerPressed=!1})),this._renderer.domElement.addEventListener("mousemove",(r=>{let x=r.target.getBoundingClientRect();this._pointerPosition.x=(r.clientX-x.left)/this._renderer.domElement.clientWidth*2-1,this._pointerPosition.y=-(r.clientY-x.top)/this._renderer.domElement.clientHeight*2+1})),this._container.addEventListener("mouseup",(()=>{this._renderer.domElement.focus()}));else if("TOUCH_SCREEN"==Kr.active){this._renderer.domElement.addEventListener("touchstart",(()=>{this._screenTouched=!0;let r=event.target.getBoundingClientRect();this._pointerPosition.x=(event.touches[0].clientX-r.left)/this._renderer.domElement.clientWidth*2-1,this._pointerPosition.y=-(event.touches[0].clientY-r.top)/this._renderer.domElement.clientHeight*2+1})),this._renderer.domElement.addEventListener("touchend",(()=>{this._screenTouched=!1})),this._renderer.domElement.addEventListener("touchmove",(r=>{let x=r.target.getBoundingClientRect();this._pointerPosition.x=(r.touches[0].clientX-x.left)/this._renderer.domElement.clientWidth*2-1,this._pointerPosition.y=-(r.touches[0].clientY-x.top)/this._renderer.domElement.clientHeight*2+1}));let r=0;document.addEventListener("touchend",(function(x){let b=(new Date).getTime();b-r<=300&&x.preventDefault(),r=b}),!1)}}_onXRSessionStart(){this._session=this._renderer.xr.getSession(),this._session.oninputsourceschange=r=>{this._onXRInputSourceChange(r)};let r=this._session.inputSources;for(let x=0;x<r.length;x++)this._addXRInputSource(r[x])}_onXRSessionEnd(){this._session.oninputsourcechange=null,this._session=null;for(let r in this._xrInputDevices)for(let x in this._xrInputDevices[r])delete this._xrInputDevices[r][x].inputSource}_onXRInputSourceChange(r){for(let x=0;x<r.removed.length;x++)this._deleteXRInputSource(r.removed[x]);for(let x=0;x<r.added.length;x++)this._addXRInputSource(r.added[x])}_addXRInputSource(r){if("tracked-pointer"!=r.targetRayMode)return;let x=null!=r.hand?Zr.HAND:Zr.CONTROLLER,b=r.handedness.toUpperCase();if(b in Yr){let S=this._xrInputDevices[x][b];if(S||(S={controllers:{}},this._xrInputDevices[x][b]=S,r.targetRaySpace&&(S.controllers.targetRay=new ee,S.controllers.targetRay.xrInputDeviceType=x,S.controllers.targetRay.handedness=b),r.gripSpace&&(S.controllers.grip=new ee,S.controllers.grip.xrInputDeviceType=x,S.controllers.grip.handedness=b)),S.inputSource=r,S.model){let x=S.model.motionController;x&&(x.xrInputSource=r)}else x==Zr.HAND?S.model=vi.createHandModel(r):x==Zr.CONTROLLER&&(S.model=yi.createControllerModel(r,"mesh"));if(this._xrControllerParent){this._xrControllerParent.add(S.controllers.targetRay);let x=S.controllers;r.gripSpace?(this._xrControllerParent.add(x.grip),x.grip.add(S.model),x.grip.model=S.model):(x.targetRay.add(S.model),x.targetRay.model=S.model)}}}_deleteXRInputSource(r){if("tracked-pointer"!=r.targetRayMode)return;let x=null!=r.hand?Zr.HAND:Zr.CONTROLLER,b=r.handedness.toUpperCase(),S=this._getXRInputDevice(x,b);S?.inputSource&&delete this._xrInputDevices[x][b].inputSource,S?.controllers&&this._xrControllerParent&&(this._xrControllerParent.remove(S.controllers.targetRay),this._xrControllerParent.remove(S.controllers.grip))}_getXRInputDevice(r,x){return this._xrInputDevices[r]?this._xrInputDevices[r][x]:null}getXRInputSource(r,x){let b=this._getXRInputDevice(r,x);return b?b.inputSource:null}getXRGamepad(r){let x=Zr.CONTROLLER,b=this.getXRInputSource(x,r);return b?b.gamepad:null}getXRController(r,x,b){let S=this._getXRInputDevice(r,x);return S?S.controllers[b]:null}getXRControllerModel(r,x){let b=this._getXRInputDevice(r,x);return b?b.model:null}setXRControllerModel(r,x,b){let S=this._getXRInputDevice(r,x);return!!S&&(S.model&&(S.controllers.grip?S.controllers.grip.remove(S.model):S.controllers.targetRay.remove(S.model)),S.model=b,S.controllers.grip?S.controllers.grip.add(b):S.controllers.targetRay.add(b),!0)}enableXRControllerManagement(r){this._xrControllerParent=r}disableXRControllerManagement(){this._xrControllerParent=null}getPointerPosition(){return this._pointerPosition}isPointerPressed(){return this._pointerPressed}isKeyPressed(r){return this._keysPressed.has(r)}isKeyCodePressed(r){return this._keyCodesPressed.has(r)}isScreenTouched(){return this._screenTouched}getJoystickAngle(){return this._joystickAngle}getJoystickDistance(){return this._joystickDistance}_createExtraControls(){this._extraControls={},this._extraControlsDiv=document.createElement("div"),this._extraControlsDiv.style.position="absolute",this._extraControlsDiv.style.bottom="10px",this._extraControlsDiv.style.right="10px",this._container.appendChild(this._extraControlsDiv)}createJoystick(){console.warn("InputHandler.createJoystick() is deprecated, please use InputHandler.showJoystick() instead"),this._createJoystick()}_createJoystick(){if(this._joystickParent)return void this.showJoystick();this._joystickParent=document.createElement("div"),this._joystickParent.style.position="absolute",this._joystickParent.style.width="100px",this._joystickParent.style.height="100px",this._joystickParent.style.left="10px",this._joystickParent.style.bottom=this._joystickParentBottomStyle||"10px",this._container.appendChild(this._joystickParent);let r={zone:this._joystickParent,mode:"static",dynamicPage:!0,position:{left:"50%",top:"50%"}},x=nipplejs.create(r).get(0);x.on("move",((r,x)=>{this._joystickAngle=x.angle.radian,this._joystickDistance=Math.min(x.force,1)})),x.on("end",(()=>{this._joystickDistance=0}))}showJoystick(){this._joystickParent?this._container.contains(this._joystickParent)||this._container.appendChild(this._joystickParent):this._createJoystick()}hideJoystick(){this._joystickParent&&this._container.contains(this._joystickParent)&&this._container.removeChild(this._joystickParent)}configureJoystickForLvhContainer(){this._joystickParent?this._joystickParent.style.bottom="calc(100lvh - 100dvh + 10px)":this._joystickParentBottomStyle="calc(100lvh - 100dvh + 10px)"}addExtraControlsButton(r,x){let b=document.createElement("button");return b.id=r,b.innerText=x,b.style.borderWidth="1px",b.style.borderStyle="solid",b.style.borderColor="#fff",b.style.borderRadius="4px",b.style.background="rgba(0,0,0,0.5)",b.style.padding="12px",b.style.color="#fff",b.style.font="normal 13px sans-serif",b.style.marginLeft="5px",b.style.opacity="0.75",b.style.width="70px",this._extraControlsDiv.appendChild(b),this._extraControls[r]=b,b}getExtraControlsButton(r){return this._extraControls[r]}hideExtraControls(){this._extraControlsDiv.style.display="none"}hideExtraControlsButton(r){let x=this._extraControls[r];x&&(x.style.display="none")}showExtraControls(){this._extraControlsDiv.style.display="block"}showExtraControlsButton(r){let x=this._extraControls[r];x&&(x.style.display="inline-block")}_updateXRController(r,x,b){let S=b.inputSource,C=b.controllers;if(S){let I=r.getPose(S.targetRaySpace,x);if(null!=I&&(C.targetRay.matrix.fromArray(I.transform.matrix),C.targetRay.matrix.decompose(C.targetRay.position,C.targetRay.rotation,C.targetRay.scale)),S.gripSpace){let b=r.getPose(S.gripSpace,x);null!=b&&(C.grip.matrix.fromArray(b.transform.matrix),C.grip.matrix.decompose(C.grip.position,C.grip.rotation,C.grip.scale))}if(S.hand&&b.model){let S=C.grip?C.grip.matrix:C.targetRay.matrix,I=b.model.motionController;I&&(I.updateMesh(r,x,S),b.model.children.length&&updateBVHForComplexObject(b.model))}}}update(r){if(null==r)return;let x=this._renderer.xr.getReferenceSpace();for(let b in this._xrInputDevices)for(let S in this._xrInputDevices[b])this._updateXRController(r,x,this._xrInputDevices[b][S])}};class InteractableHandler{constructor(){this._interactables=new Set,this._hoveredInteractables=new Map,this._selectedInteractables=new Map,this._capturedInteractables=new Map,this._overInteractables=new Map,this._owners=new Map,this._owners.set("POINTER",{id:"POINTER"}),this._owners.set("TOUCH_SCREEN",{id:"TOUCH_SCREEN"}),this._wasPressed=new Map,this._listeners={},this._tool=null,this._toolHandlers={}}_setupXRSubscription(){xt.addUpdateListener((r=>{for(let[r,x]of this._hoveredInteractables)x&&x.removeHoveredBy(r),this._hoveredInteractables.delete(r);for(let[x,b]of this._selectedInteractables){if(!b)continue;let S=0;r&&(S+=b.getCallbacksLength(r)),this._tool&&(S+=b.getCallbacksLength(this._tool)),S&&(b.removeSelectedBy(x),this._selectedInteractables.delete(x))}this._tool=r}))}_getOwner(r){return this._owners.has(r)||this._owners.set(r,{id:r.uuid,object:r}),this._owners.get(r)}init(){"XR"==Kr.active?(this.update=this._updateForXR,this._setupXRSubscription()):"POINTER"==Kr.active?this.update=this._updateForPointer:"TOUCH_SCREEN"==Kr.active&&(this.update=this._updateForTouchScreen)}addEventListener(r,x){r in this._listeners||(this._listeners[r]=new Set),this._listeners[r].add(x)}removeEventListener(r,x){r in this._listeners&&(this._listeners[r].delete(x),0==this._listeners[r].size&&delete this._listeners[r])}_trigger(r,x,b){if(this._listeners[r]){let S={...x};if(b&&(S.target=b.object,b[r](x)),!this._listeners[r])return;let C=[];this._listeners[r].forEach((r=>C.push(r)));for(let r of C)r(S)}else b&&b[r](x)}registerToolHandler(r,x){this._toolHandlers[r]=x}addInteractable(r){this._interactables.add(r)}addInteractables(r){r.forEach((r=>{this._interactables.add(r)}))}removeInteractable(r){this._interactables.delete(r),r.reset()}removeInteractables(r){r.forEach((r=>{this._interactables.delete(r),r.reset()}))}reset(){this._interactables.forEach((r=>{r.reset()})),this._interactables=new Set,this._hoveredInteractables=new Map,this._selectedInteractables=new Map}update(){}_updateForXR(){}_updateForPointer(){}_updateForTouchScreen(){}}const bi=new r.Vector3;let Ti=new class extends InteractableHandler{constructor(){super(),this._cursors={},this._ignoredInteractables=new Set}init(r,x,b,S){super.init(),this._renderer=r,this._scene=x,this._camera=b,this._cameraFocus=S||b}_getXRCursor(x){if(this._cursors[x])return this._cursors[x];let b=document.createElement("canvas");b.width=64,b.height=64;let S=b.getContext("2d");S.beginPath(),S.arc(32,32,29,0,2*Math.PI),S.lineWidth=5,S.stroke(),S.fillStyle="white",S.fill();let C=new r.SpriteMaterial({map:new r.CanvasTexture(b),depthTest:!1,sizeAttenuation:!1});for(let x in Yr){let b=new r.Sprite(C);b.scale.set(.015,.015,.015),b.visible=!1,b.renderOrder=1/0,this._cursors[x]=b,this._scene.add(b)}return this._cursors[x]}_getRaycaster(x){x.raycaster||(x.raycaster=new r.Raycaster);let b=xi.getPointerPosition();return x.raycaster.setFromCamera(b,this._camera),x.raycaster.layers.mask=this._camera.layers.mask,x.raycaster}_getXRRaycaster(x){return x.raycaster||(x.raycaster=new r.Raycaster),x.getWorldPosition(x.raycaster.ray.origin),x.getWorldDirection(x.raycaster.ray.direction).negate().normalize(),x.raycaster.layers.mask=this._camera.layers.mask,x.raycaster}_isXRControllerPressed(r,x){if(r==Zr.HAND){let b=xi.getXRControllerModel(r,x);return 1==b?.motionController?.isPinching}{let r=xi.getXRGamepad(x);return null!=r?.buttons&&r.buttons[0].pressed}}_squashInteractables(r,x,b){for(let S of x){let x=S.object;x&&!S.isOnlyGroup()&&b.push(x),0!=S.children.size&&this._squashInteractables(r,S.children,b)}}_getObjectInteractable(r){for(;null!=r;){let x=r.pointerInteractable;if(x&&!x.isOnlyGroup())return x;r=r.parent}}_raycastInteractables(r,x){this._ignoredInteractables.clear();let b=r.raycaster;if(!b||b.disabled)return;b.firstHitOnly=!0,b.params.Line.threshold=.01;let S=[];this._squashInteractables(r.owner,x,S);let C=b.intersectObjects(S);for(let x of C){let b,S=this._getObjectInteractable(x.object);if(!S||this._ignoredInteractables.has(S))continue;if(this._checkClipped(x)){this._ignoredInteractables.add(S);continue}if(b=this._checkInstanced(x)){if(1==b)continue;if(S=this._getObjectInteractable(b),!S)continue}let C=x.distance,I=C;if("XR"!=Kr.active&&(this._cameraFocus.getWorldPosition(bi),I=x.point.distanceTo(bi)),S.isWithinReach(I))return r.closestPointDistance=C,r.closestPoint=x.point,r.closestInteractable=S,void(r.userDistance=I)}}_checkClipped(r){let{object:x,point:b}=r,S=x?.material?.clippingPlanes;if(S&&S.length>0)for(let r of S)if(r.distanceToPoint(b)<0)return!0;return!1}_checkInstanced(r){let{object:x,point:b,instanceId:S}=r;if(!x.isUIManagedInstancedMesh)return!1;let C=x.ids[S];return zr.getComponent(C)||!0}_updateInteractables(r){let x=r.owner,b=r.isPressed,S=this._hoveredInteractables.get(x),C=this._selectedInteractables.get(x),I=this._overInteractables.get(x),A=r.closestInteractable,R=r.closestPoint,B=r.userDistance;A!=S&&(S&&(S.removeHoveredBy(x),this._hoveredInteractables.delete(x)),!A||(C||b)&&A!=C||(A.addHoveredBy(x),this._hoveredInteractables.set(x,A),S=A));let D={owner:x},F={owner:x,point:R,userDistance:B};C?(b||(C.removeSelectedBy(x),this._selectedInteractables.delete(x)),C==A?(I!=A&&(I&&I.out(D),A.over(F),this._overInteractables.set(x,A)),A.move(F),A.drag(F),b||(this._trigger("up",F,A),A.click(F))):C.isCapturedBy(x)?(C!=I&&(I&&I.out(D),C.over(D),this._overInteractables.set(x,C),I=C),C.move(D),C.drag(D),b||(this._trigger("up",D,C),C.click(D),I&&I.out(D),A?(A.over(F),this._overInteractables.set(x,A)):this._overInteractables.delete(x))):A?(I!=A&&(I&&I.out(D),A.over(F),this._overInteractables.set(x,A)),A.move(F),b||this._trigger("up",F,A)):I&&(I.out(D),this._overInteractables.delete(x))):A?(I!=A&&(I&&I.out(D),A.over(F),this._overInteractables.set(x,A)),A.move(F),b&&!this._wasPressed.get(x)?(this._trigger("down",F,A),A.addSelectedBy(x),this._selectedInteractables.set(x,A)):!b&&this._wasPressed.get(x)&&this._trigger("up",F,A)):(I&&(I.out(D),this._overInteractables.delete(x)),b?this._wasPressed.get(x)||this._trigger("down",D):this._wasPressed.get(x)&&this._trigger("up",D)),this._wasPressed.set(x,b)}_updateCursor(r){let x=r.cursor;x&&(null!=r.closestPoint?(x.position.copy(r.closestPoint),x.visible||(x.visible=!0)):x.visible&&(x.visible=!1))}_updateForXR(){for(let r in Yr){let x=!1;for(let b of[Zr.HAND,Zr.CONTROLLER]){let S=xi.getXRController(b,r,"grip");if(S||(S=xi.getXRController(b,r,"targetRay")),!S)continue;let C,I,A=this._getOwner(S),R=isDescendant(this._scene,S);if(R&&(b==Zr.CONTROLLER?x=!0:x&&(R=!1)),R){let x=xi.getXRController(b,r,"targetRay");C=this._getXRRaycaster(x),A.raycaster||(A.raycaster=C),I=this._isXRControllerPressed(b,r)}let B={owner:A,raycaster:C,isPressed:I,closestPoint:null,closestPointDistance:Number.MAX_SAFE_INTEGER,cursor:R?this._getXRCursor(r):null,userDistance:Number.MAX_SAFE_INTEGER},D=!1;this._toolHandlers[this._tool]&&(D=this._toolHandlers[this._tool](B)),D||(this._raycastInteractables(B,this._interactables),this._updateInteractables(B)),this._updateCursor(B)}}}_updateForPointer(){let r=this._getOwner(Kr.POINTER),x={owner:r,raycaster:this._getRaycaster(r),isPressed:xi.isPointerPressed(),closestPoint:null,closestPointDistance:Number.MAX_SAFE_INTEGER,userDistance:Number.MAX_SAFE_INTEGER},b=!1;this._toolHandlers[this._tool]&&(b=this._toolHandlers[this._tool](x)),b||(this._raycastInteractables(x,this._interactables),this._updateInteractables(x));let S=this._renderer.domElement.style,C=this._hoveredInteractables.get(r);C&&!this._selectedInteractables.get(r)?S.cursor=C.hoveredCursor:""!=S.cursor&&(S.cursor="")}_updateForTouchScreen(){let r=this._getOwner(Kr.TOUCH_SCREEN),x={owner:r,raycaster:this._getRaycaster(r),isPressed:xi.isScreenTouched(),closestPoint:null,closestPointDistance:Number.MAX_SAFE_INTEGER,userDistance:Number.MAX_SAFE_INTEGER};x.raycaster.disabled=!x.isPressed&&!this._wasPressed.get(r);let b=!1;this._toolHandlers[this._tool]&&(b=this._toolHandlers[this._tool](x)),b?this._wasPressed.set(r,x.isPressed):(this._raycastInteractables(x,this._interactables),this._updateInteractables(x))}};const wi=new r.Vector3;let Si=new class extends InteractableHandler{constructor(){super(),this._skipIntersectsCheck=new Map,this._sphere=new r.Sphere,this._box3=new r.Box3}init(r){super.init(),this._scene=r}_setupXRSubscription(){xt.addUpdateListener((r=>{for(let[x,b]of this._selectedInteractables)for(let S of b){if(!S)continue;let b=0;r&&(b+=S.getCallbacksLength(r)),this._tool&&(b+=S.getCallbacksLength(this._tool)),b&&(S.removeSelectedBy(x),this._selectedInteractables.delete(x))}this._tool=r}))}_getBoundingSphere(r){return r?(this._skipIntersectsCheck.get(r)||this._skipIntersectsCheck.set(r,new Map),this._box3.setFromObject(r).getBoundingSphere(this._sphere),this._sphere):null}_scopeInteractables(r,x){let b=r.boundingSphere,S=r.skipIntersectsCheck;if(null!=b)for(let C of x){0!=C.children.size&&this._scopeInteractables(r,C.children);let x=C.object;if(null!=x&&!C.isOnlyGroup()&&(r.activeInteractables.add(C),C.intersectsSphere(b)&&!this._checkClipped(x))){let x=r.model||r.owner.object,b=S.get(C);b?(this._selectedInteractables.get(r.owner).has(C)&&r.touchedInteractables.add(C),S.set(C,b-1)):(C.intersectsObject(x)&&r.touchedInteractables.add(C),S.set(C,5))}}}_checkClipped(r){let x=r?.material?.clippingPlanes;if(x&&x.length>0){r.getWorldPosition(wi);for(let r of x)if(r.distanceToPoint(wi)<0)return!0}return!1}_updateInteractables(r){let x=r.owner;this._scopeInteractables(r,this._interactables),this._selectedInteractables.get(x)||this._selectedInteractables.set(x,new Set);let b=this._selectedInteractables.get(x),S=r.touchedInteractables,C=r.activeInteractables,I={owner:x};for(let r of b)S.has(r)||(r.removeSelectedBy(x),b.delete(r),C.has(r)&&(r.drag(I),this._trigger("up",I,r),r.click(I)));for(let r of S)b.has(r)?r.drag(I):(r.addSelectedBy(x),b.add(r),this._trigger("down",I,r))}_updateForXR(){for(let r in Yr){let x=!1;for(let b of[Zr.HAND,Zr.CONTROLLER]){let S=xi.getXRController(b,r,"grip"),C=xi.getXRControllerModel(b,r);if(S||(S=xi.getXRController(b,r,"targetRay")),!S)continue;let I,A,R=this._getOwner(S),B=isDescendant(this._scene,S);if(B&&(b==Zr.CONTROLLER?x=!0:x&&(B=!1)),B){let r=isDescendant(S,C)?C:S;I=this._getBoundingSphere(r),A=this._skipIntersectsCheck.get(r)}let D={owner:R,model:C,boundingSphere:I,activeInteractables:new Set,touchedInteractables:new Set,skipIntersectsCheck:A},F=!1;this._toolHandlers[this._tool]&&(F=this._toolHandlers[this._tool](D)),F||this._updateInteractables(D)}}}};class InteractableComponent extends LayoutComponent{constructor(...r){super(...r),this.pointerInteractable=this.pointerInteractableClassOverride?new this.pointerInteractableClassOverride(this):new PointerInteractable(this),this.touchInteractable=new TouchInteractable(this),this._clickAction=r=>this._pointerClick(r),this._dragAction=r=>this._pointerDrag(r),this._touchAction=r=>this._touch(r),this._touchDragAction=r=>this._touchDrag(r)}createBackground(){super.createBackground(),this.pointerInteractable.object=this._background,this.touchInteractable.object=this._background}_pointerClick(r){this._onClick&&this._onClick(r)}_pointerDrag(r){this._onDrag&&this._onDrag(r)}_touch(r){this._onTouch&&this._onTouch(r)}_touchDrag(r){this._onTouchDrag&&this._onTouchDrag(r)}_onAdded(){super._onAdded();let x=this.parentComponent;if(this.parent?.pointerInteractable&&this.parent?.touchInteractable)this.parent.pointerInteractable.addChild(this.pointerInteractable),this.parent.touchInteractable.addChild(this.touchInteractable);else if(x instanceof InteractableComponent)x.pointerInteractable.addChild(this.pointerInteractable),x.touchInteractable.addChild(this.touchInteractable);else{for(x=this.parent;x;){if(x instanceof r.Scene)return Ti.addInteractable(this.pointerInteractable),void Si.addInteractable(this.touchInteractable);x=x.parent}Ti.removeInteractable(this.pointerInteractable),Si.removeInteractable(this.touchInteractable)}}_onRemoved(){super._onRemoved(),this.pointerInteractable.parent?this.pointerInteractable.parent.removeChild(this.pointerInteractable):Ti.removeInteractable(this.pointerInteractable),this.touchInteractable.parent?this.touchInteractable.parent.removeChild(this.touchInteractable):Si.removeInteractable(this.touchInteractable)}_setCallback(r,x,b,S){let C="_on"+capitalizeFirstLetter(b),I="_"+b+"Action";S&&!this[C]?r.addEventListener(x,this[I]):!S&&this[C]&&r.removeEventListener(x,this[I]),this[C]=S}_checkInstancedPointerListenerUpdate(r){r?zr.checkRemovePointerInteractableListener(this._instancedBackgroundId):zr.checkAddPointerInteractableListener(this._instancedBackgroundId)}_checkInstancedTouchListenerUpdate(r){r?zr.checkRemoveTouchInteractableListener(this._instancedBackgroundId):zr.checkAddTouchInteractableListener(this._instancedBackgroundId)}get onClick(){return this._onClick}get onDrag(){return this._onDrag}get onTouch(){return this._onTouch}get onTouchDrag(){return this._onTouchDrag}set onClick(r){let x=this.pointerInteractable.isOnlyGroup();this._setCallback(this.pointerInteractable,"click","click",r);let b=this.pointerInteractable.isOnlyGroup();this._instancedBackgroundId&&x!=b&&this._checkInstancedPointerListenerUpdate(b)}set onClickAndTouch(r){this.onClick=r,this.onTouch=r}set onDrag(r){let x=this.pointerInteractable.isOnlyGroup();this._setCallback(this.pointerInteractable,"drag","drag",r);let b=this.pointerInteractable.isOnlyGroup();this._instancedBackgroundId&&x!=b&&this._checkInstancedPointerListenerUpdate(b)}set onTouch(r){let x=this.touchInteractable.isOnlyGroup();this._setCallback(this.touchInteractable,"click","touch",r);let b=this.touchInteractable.isOnlyGroup();this._instancedBackgroundId&&x!=b&&this._checkInstancedTouchListenerUpdate(b)}set onTouchDrag(r){let x=this.touchInteractable.isOnlyGroup();this._setCallback(this.touchInteractable,"drag","touchDrag",r);let b=this.touchInteractable.isOnlyGroup();this._instancedBackgroundId&&x!=b&&this._checkInstancedTouchListenerUpdate(b)}}const Ci=new r.Vector3,Ii=new r.Plane;class ScrollableComponent extends InteractableComponent{constructor(...x){super(...x),this.scrollAmount=0,this._scrollBoundsMin=new r.Vector2,this._scrollBoundsMax=new r.Vector2,this._scrollOwner,this._scrollable=!1,this._scrollableByAncestor=!1,this._wasScrollable=!1,this._scrollableAncestor,this._downAction=r=>this.pointerInteractable.capture(r.owner),this._touchDownAction=r=>this.touchInteractable.capture(r.owner)}updateLayout(r){super.updateLayout(r),this._updateScrollInteractables()}_updateScrollInteractables(){let r=this._scrollableAncestor;this._updateScrollable();let x=this._scrollable||this._scrollableByAncestor;if(x==this._wasScrollable)return void(r!=this._scrollableAncestor&&this._updateChildrenScrollInteractables());this._wasScrollable=x,this._updateChildrenScrollInteractables();let b=x?"addEventListener":"removeEventListener";this.pointerInteractable[b]("down",this._downAction),this.touchInteractable[b]("down",this._touchDownAction),this._onClick||this.pointerInteractable[b]("click",this._clickAction),this._onDrag||this.pointerInteractable[b]("drag",this._dragAction),this._onTouch||this.touchInteractable[b]("click",this._touchAction),this._onTouchDrag||this.touchInteractable[b]("drag",this._touchDragAction)}_updateChildrenScrollInteractables(){for(let r of this._content.children)r instanceof ScrollableComponent&&r._updateScrollInteractables()}_updateScrollable(){let r=this.computedHeight,x=this.computedWidth,b=this._getContentHeight(),S=this._getContentWidth(),C=this._getPaddedContentHeight(),I=this._getPaddedContentWidth(),A="scroll"==this.overflow;if(this._verticallyScrollable=C>r&&A,this._horizontallyScrollable=I>x&&A,this._scrollable=this._verticallyScrollable||this._horizontallyScrollable,this._scrollableAncestor=this._getScrollableAncestor(),this._scrollableByAncestor=null!=this._onClick&&null!=this._scrollableAncestor,!this._scrollable)return this._content.position.x=0,void(this._content.position.y=0);let R,B,D,F,G,N,H,W,j=this.justifyContent,V=this.alignItems;"row"==this.contentDirection?(R=-this.unpaddedWidth,B=this.unpaddedHeight,D=-S,F=b,G="x",N="y",H=this._scrollBoundsMin,W=this._scrollBoundsMax):(R=this.unpaddedHeight,B=-this.unpaddedWidth,D=b,F=-S,G="y",N="x",H=this._scrollBoundsMax,W=this._scrollBoundsMin),"start"==j?(H[G]=D-R,W[G]=0):"end"==j?(H[G]=0,W[G]=-D+R):"center"==j||Math.abs(R)-Math.abs(D)<0?(H[G]=(D-R)/2,W[G]=-1*H[G]):H[G]=W[G]=0,"start"==V?(W[N]=F-B,H[N]=0):"end"==V?(W[N]=0,H[N]=-F+B):(W[N]=(F-B)/2,H[N]=-1*W[N]),this._verticallyScrollable&&this._boundScrollPosition("y"),this._horizontallyScrollable&&this._boundScrollPosition("x")}_pointerClick(r){let{owner:x,point:b}=r;if(this._scrollAncestor){let S=!this._scrollAncestor.scrollThresholdReached;this._scrollAncestor.clearScroll(x),this._scrollAncestor=null,this._onClick&&S&&b&&this._onClick(r)}else this._onClick&&this._onClick(r);this.clearScroll(x)}_pointerDrag(r){let{owner:x,point:b}=r;this._onDrag?this._onDrag(r):this._scrollable?this.handleScroll(x,b):this._scrollableByAncestor&&(this._scrollAncestor?this._scrollAncestor.handleScroll(x,b):(this._scrollAncestor=this._getScrollableAncestor(),this._scrollAncestor&&this._scrollAncestor.handleScroll(x,b)))}_touch(r){let x=r.owner;if(this._scrollAncestor){let x=!this.scrollThresholdReached;this.scrollThresholdReached=!1,this._scrollAncestor=null,this._onTouch&&x&&this._onTouch(r)}else this._onTouch&&this._onTouch(r);this.clearScroll(x)}_touchDrag(r){let x=r.owner;this._onTouchDrag?this._onTouchDrag(x):this._scrollable?this.handleTouchScroll(x,this.touchInteractable):this._scrollAncestor?this._scrollAncestor.scrollThresholdReached&&!this.scrollThresholdReached&&(this.scrollThresholdReached=!0):this._scrollAncestor=this._getScrollableAncestor()}clearScroll(r){this._scrollStart&&r==this._scrollOwner&&(this._scrollOwner=null,this._scrollStart=null,this._scrollStartPosition=null,this._scrollType=null,this._scrollStartThresholdReached=null,this.scrollThresholdReached=null,this.scrollAmount=0)}handleScroll(r,x){this._scrollStart?r==this._scrollOwner&&"POINTER"==this._scrollType&&(x?x=Ci.copy(x):(Ii.set(Ci.set(0,0,1),0),Ii.applyMatrix4(this.matrixWorld),x=r.raycaster.ray.intersectPlane(Ii,Ci)),x&&(x=this.worldToLocal(x),this._horizontallyScrollable&&this._scroll("x",x),this._verticallyScrollable&&this._scroll("y",x))):x&&(this._scrollStart=this.worldToLocal(x.clone()),this._scrollStartPosition=this._content.position.clone(),this._scrollOwner=r,this._scrollType="POINTER")}handleTouchScroll(r,x){if(this._scrollStart){if(r==this._scrollOwner&&"TOUCH"==this._scrollType){let r=this._scrollController.bvhGeometry.getAttribute("position");Ci.fromBufferAttribute(r,this._scrollVertex),this._scrollController.localToWorld(Ci),this.worldToLocal(Ci),this._horizontallyScrollable&&this._scroll("x",Ci),this._verticallyScrollable&&this._scroll("y",Ci)}}else{let b=x.getClosestPointTo(r.object);this._scrollController=b[1].object,this._scrollVertex=this._scrollController.bvhGeometry.index.array[3*b[1].faceIndex];let S=this._scrollController.bvhGeometry.getAttribute("position");Ci.fromBufferAttribute(S,this._scrollVertex),this._scrollController.localToWorld(Ci),this._scrollStart=this.worldToLocal(Ci).clone(),this._scrollStartPosition=this._content.position.clone(),this._scrollOwner=r,this._scrollType="TOUCH"}}_getScrollableAncestor(){let r=this.parentComponent;for(;r instanceof LayoutComponent;){if(r._scrollable)return r;r=r.parentComponent}}_scroll(r,x){let b=this._content.position[r];if(this._content.position[r]=this._scrollStartPosition[r]-this._scrollStart[r]+x[r],this._boundScrollPosition(r),!this.scrollThresholdReached){let S=Math.abs(b-this._content.position[r]);this.scrollAmount+=S;let C="x"==r?this.computedWidth:this.computedHeight;this._scrollStartThresholdReached?this.scrollAmount>.1*C&&(this.scrollThresholdReached=!0):(this._content.position[r]=b,this._scrollStart[r]=x[r],this.scrollAmount>=.02*C&&(this._scrollStartThresholdReached=!0,this.scrollAmount=0))}}_boundScrollPosition(r){this._content.position[r]<this._scrollBoundsMin[r]?this._content.position[r]=this._scrollBoundsMin[r]:this._content.position[r]>this._scrollBoundsMax[r]&&(this._content.position[r]=this._scrollBoundsMax[r])}_setCallback(r,x,b,S){let C="_on"+capitalizeFirstLetter(b),I="_"+b+"Action";this._scrollable||this._scrollableByAncestor||(S&&!this[C]?r.addEventListener(x,this[I]):!S&&this[C]&&r.removeEventListener(x,this[I])),this[C]=S}}class Body extends ScrollableComponent{constructor(...r){super(...r),this.bypassContentPositioning=!0,this._defaults.backgroundVisible=!0,this._defaults.height=1,this._defaults.width=1}}function workerBootstrap(){var r=Object.create(null);function registerModule(x,b){var S=x.id,C=x.name,I=x.dependencies;void 0===I&&(I=[]);var A=x.init;void 0===A&&(A=function(){});var R=x.getTransferables;if(void 0===R&&(R=null),!r[S])try{I=I.map((function(x){return x&&x.isWorkerModule&&(registerModule(x,(function(r){if(r instanceof Error)throw r})),x=r[x.id].value),x})),A=rehydrate("<"+C+">.init",A),R&&(R=rehydrate("<"+C+">.getTransferables",R));var B=null;"function"==typeof A?B=A.apply(void 0,I):console.error("worker module init function failed to rehydrate"),r[S]={id:S,value:B,getTransferables:R},b(B)}catch(r){r&&r.noLog||console.error(r),b(r)}}function rehydrate(r,x){var b=void 0;self.troikaDefine=function(r){return b=r};var S=URL.createObjectURL(new Blob(["/** "+r.replace(/\*/g,"")+" **/\n\ntroikaDefine(\n"+x+"\n)"],{type:"application/javascript"}));try{importScripts(S)}catch(r){console.error(r)}return URL.revokeObjectURL(S),delete self.troikaDefine,b}self.addEventListener("message",(function(x){var b=x.data,S=b.messageId,C=b.action,I=b.data;try{"registerModule"===C&&registerModule(I,(function(r){r instanceof Error?postMessage({messageId:S,success:!1,error:r.message}):postMessage({messageId:S,success:!0,result:{isCallable:"function"==typeof r}})})),"callModule"===C&&function(x,b){var S,C=x.id,I=x.args;r[C]&&"function"==typeof r[C].value||b(new Error("Worker module "+C+": not found or its 'init' did not return a function"));try{var A=(S=r[C]).value.apply(S,I);A&&"function"==typeof A.then?A.then(handleResult,(function(r){return b(r instanceof Error?r:new Error(""+r))})):handleResult(A)}catch(r){b(r)}function handleResult(x){try{var S=r[C].getTransferables&&r[C].getTransferables(x);S&&Array.isArray(S)&&S.length||(S=void 0),b(x,S)}catch(r){console.error(r),b(r)}}}(I,(function(r,x){r instanceof Error?postMessage({messageId:S,success:!1,error:r.message}):postMessage({messageId:S,success:!0,result:r},x||void 0)}))}catch(r){postMessage({messageId:S,success:!1,error:r.stack})}}))}var supportsWorkers=function(){var r=!1;if("undefined"!=typeof window&&void 0!==window.document)try{new Worker(URL.createObjectURL(new Blob([""],{type:"application/javascript"}))).terminate(),r=!0}catch(r){"undefined"!=typeof process&&"test"===process.env.NODE_ENV||console.log("Troika createWorkerModule: web workers not allowed; falling back to main thread execution. Cause: ["+r.message+"]")}return supportsWorkers=function(){return r},r},ki=0,Ai=0,Ei=!1,Ri=Object.create(null),Mi=Object.create(null),Pi=Object.create(null);function defineWorkerModule(r){if(!(r&&"function"==typeof r.init||Ei))throw new Error("requires `options.init` function");var x=r.dependencies,b=r.init,S=r.getTransferables,C=r.workerId,I=function(r){var moduleFunc=function(){for(var r=[],x=arguments.length;x--;)r[x]=arguments[x];return moduleFunc._getInitResult().then((function(x){if("function"==typeof x)return x.apply(void 0,r);throw new Error("Worker module function was called but `init` did not return a callable function")}))};return moduleFunc._getInitResult=function(){var x=r.dependencies,b=r.init;x=Array.isArray(x)?x.map((function(r){return r&&(r=r.onMainThread||r)._getInitResult&&(r=r._getInitResult()),r})):[];var S=Promise.all(x).then((function(r){return b.apply(null,r)}));return moduleFunc._getInitResult=function(){return S},S},moduleFunc}(r);null==C&&(C="#default");var A="workerModule"+ ++ki,R=r.name||A,B=null;function moduleFunc(){for(var r=[],x=arguments.length;x--;)r[x]=arguments[x];if(!supportsWorkers())return I.apply(void 0,r);if(!B){B=callWorker(C,"registerModule",moduleFunc.workerModuleData);var unregister=function(){B=null,Mi[C].delete(unregister)};(Mi[C]||(Mi[C]=new Set)).add(unregister)}return B.then((function(x){if(x.isCallable)return callWorker(C,"callModule",{id:A,args:r});throw new Error("Worker module function was called but `init` did not return a callable function")}))}return x=x&&x.map((function(r){return"function"!=typeof r||r.workerModuleData||(Ei=!0,r=defineWorkerModule({workerId:C,name:"<"+R+"> function dependency: "+r.name,init:"function(){return (\n"+stringifyFunction(r)+"\n)}"}),Ei=!1),r&&r.workerModuleData&&(r=r.workerModuleData),r})),moduleFunc.workerModuleData={isWorkerModule:!0,id:A,name:R,dependencies:x,init:stringifyFunction(b),getTransferables:S&&stringifyFunction(S)},moduleFunc.onMainThread=I,moduleFunc}function stringifyFunction(r){var x=r.toString();return!/^function/.test(x)&&/^\w+\s*\(/.test(x)&&(x="function "+x),x}function callWorker(r,x,b){return new Promise((function(S,C){var I=++Ai;Pi[I]=function(r){r.success?S(r.result):C(new Error("Error in worker "+x+" call: "+r.error))},function(r){var x=Ri[r];if(!x){var b=stringifyFunction(workerBootstrap);(x=Ri[r]=new Worker(URL.createObjectURL(new Blob(["/** Worker Module Bootstrap: "+r.replace(/\*/g,"")+" **/\n\n;("+b+")()"],{type:"application/javascript"})))).onmessage=function(r){var x=r.data,b=x.messageId,S=Pi[b];if(!S)throw new Error("WorkerModule response with empty or unknown messageId");delete Pi[b],S(x)}}return x}(r).postMessage({messageId:I,action:x,data:b})}))}function SDFGenerator(){var r=function(r){function pointOnCubicBezier(r,x,b,S,C,I,A,R,B,D){var F=1-B;D.x=F*F*F*r+3*F*F*B*b+3*F*B*B*C+B*B*B*A,D.y=F*F*F*x+3*F*F*B*S+3*F*B*B*I+B*B*B*R}function forEachPathCommand(r,x){for(var b,S,C,I,A,R=/([MLQCZ])([^MLQCZ]*)/g;b=R.exec(r);){var B=b[2].replace(/^\s*|\s*$/g,"").split(/[,\s]+/).map((function(r){return parseFloat(r)}));switch(b[1]){case"M":I=S=B[0],A=C=B[1];break;case"L":B[0]===I&&B[1]===A||x("L",I,A,I=B[0],A=B[1]);break;case"Q":x("Q",I,A,I=B[2],A=B[3],B[0],B[1]);break;case"C":x("C",I,A,I=B[4],A=B[5],B[0],B[1],B[2],B[3]);break;case"Z":I===S&&A===C||x("L",I,A,S,C)}}}function pathToLineSegments(r,x,b){void 0===b&&(b=16);var S={x:0,y:0};forEachPathCommand(r,(function(r,C,I,A,R,B,D,F,G){switch(r){case"L":x(C,I,A,R);break;case"Q":for(var N=C,H=I,W=1;W<b;W++)q=I,$=D,K=R,J=void 0,J=1-(Y=W/(b-1)),(Z=S).x=J*J*C+2*J*Y*B+Y*Y*A,Z.y=J*J*q+2*J*Y*$+Y*Y*K,x(N,H,S.x,S.y),N=S.x,H=S.y;break;case"C":for(var j=C,V=I,X=1;X<b;X++)pointOnCubicBezier(C,I,B,D,F,G,A,R,X/(b-1),S),x(j,V,S.x,S.y),j=S.x,V=S.y}var q,$,K,Y,Z,J}))}var x="precision highp float;attribute vec2 aUV;varying vec2 vUV;void main(){vUV=aUV;gl_Position=vec4(mix(vec2(-1.0),vec2(1.0),aUV),0.0,1.0);}",b="precision highp float;uniform sampler2D tex;varying vec2 vUV;void main(){gl_FragColor=texture2D(tex,vUV);}",S=new WeakMap,C={premultipliedAlpha:!1,preserveDrawingBuffer:!0,antialias:!1,depth:!1};function withWebGLContext(r,x){var b=r.getContext?r.getContext("webgl",C):r,I=S.get(b);if(!I){var A="undefined"!=typeof WebGL2RenderingContext&&b instanceof WebGL2RenderingContext,R={},B={},D={},F=-1,G=[];function getExtension(r){var x=R[r];if(!x&&!(x=R[r]=b.getExtension(r)))throw new Error(r+" not supported");return x}function compileShader(r,x){var S=b.createShader(x);return b.shaderSource(S,r),b.compileShader(S),S}function withProgram(r,x,S,C){if(!B[r]){var I={},R={},D=b.createProgram();b.attachShader(D,compileShader(x,b.VERTEX_SHADER)),b.attachShader(D,compileShader(S,b.FRAGMENT_SHADER)),b.linkProgram(D),B[r]={program:D,transaction:function(r){b.useProgram(D),r({setUniform:function(r,x){for(var S=[],C=arguments.length-2;C-- >0;)S[C]=arguments[C+2];var I=R[x]||(R[x]=b.getUniformLocation(D,x));b["uniform"+r].apply(b,[I].concat(S))},setAttribute:function(r,x,S,C,R){var B=I[r];B||(B=I[r]={buf:b.createBuffer(),loc:b.getAttribLocation(D,r),data:null}),b.bindBuffer(b.ARRAY_BUFFER,B.buf),b.vertexAttribPointer(B.loc,x,b.FLOAT,!1,0,0),b.enableVertexAttribArray(B.loc),A?b.vertexAttribDivisor(B.loc,C):getExtension("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(B.loc,C),R!==B.data&&(b.bufferData(b.ARRAY_BUFFER,R,S),B.data=R)}})}}}B[r].transaction(C)}function withTexture(r,x){F++;try{b.activeTexture(b.TEXTURE0+F);var S=D[r];S||(S=D[r]=b.createTexture(),b.bindTexture(b.TEXTURE_2D,S),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST)),b.bindTexture(b.TEXTURE_2D,S),x(S,F)}finally{F--}}function withTextureFramebuffer(r,x,S){var C=b.createFramebuffer();G.push(C),b.bindFramebuffer(b.FRAMEBUFFER,C),b.activeTexture(b.TEXTURE0+x),b.bindTexture(b.TEXTURE_2D,r),b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,r,0);try{S(C)}finally{b.deleteFramebuffer(C),b.bindFramebuffer(b.FRAMEBUFFER,G[--G.length-1]||null)}}function handleContextLoss(){R={},B={},D={},F=-1,G.length=0}b.canvas.addEventListener("webglcontextlost",(function(r){handleContextLoss(),r.preventDefault()}),!1),S.set(b,I={gl:b,isWebGL2:A,getExtension:getExtension,withProgram:withProgram,withTexture:withTexture,withTextureFramebuffer:withTextureFramebuffer,handleContextLoss:handleContextLoss})}x(I)}function renderImageData(r,S,C,I,A,R,B,D){void 0===B&&(B=15),void 0===D&&(D=null),withWebGLContext(r,(function(r){var F=r.gl,G=r.withProgram;(0,r.withTexture)("copy",(function(r,N){F.texImage2D(F.TEXTURE_2D,0,F.RGBA,A,R,0,F.RGBA,F.UNSIGNED_BYTE,S),G("copy",x,b,(function(r){var x=r.setUniform;(0,r.setAttribute)("aUV",2,F.STATIC_DRAW,0,new Float32Array([0,0,2,0,0,2])),x("1i","image",N),F.bindFramebuffer(F.FRAMEBUFFER,D||null),F.disable(F.BLEND),F.colorMask(8&B,4&B,2&B,1&B),F.viewport(C,I,A,R),F.scissor(C,I,A,R),F.drawArrays(F.TRIANGLES,0,3)}))}))}))}var I=Object.freeze({__proto__:null,withWebGLContext:withWebGLContext,renderImageData:renderImageData,resizeWebGLCanvasWithoutClearing:function(r,x,b){var S=r.width,C=r.height;withWebGLContext(r,(function(I){var A=I.gl,R=new Uint8Array(S*C*4);A.readPixels(0,0,S,C,A.RGBA,A.UNSIGNED_BYTE,R),r.width=x,r.height=b,renderImageData(A,R,0,0,S,C)}))}});function generate$2(r,x,b,S,C,I){void 0===I&&(I=1);var A=new Uint8Array(r*x),R=S[2]-S[0],B=S[3]-S[1],D=[];pathToLineSegments(b,(function(r,x,b,S){D.push({x1:r,y1:x,x2:b,y2:S,minX:Math.min(r,b),minY:Math.min(x,S),maxX:Math.max(r,b),maxY:Math.max(x,S)})})),D.sort((function(r,x){return r.maxX-x.maxX}));for(var F=0;F<r;F++)for(var G=0;G<x;G++){var N=findNearestSignedDistance(S[0]+R*(F+.5)/r,S[1]+B*(G+.5)/x),H=Math.pow(1-Math.abs(N)/C,I)/2;N<0&&(H=1-H),H=Math.max(0,Math.min(255,Math.round(255*H))),A[G*r+F]=H}return A;function findNearestSignedDistance(r,x){for(var b=1/0,S=1/0,C=D.length;C--;){var I=D[C];if(I.maxX+S<=r)break;if(r+S>I.minX&&x-S<I.maxY&&x+S>I.minY){var A=absSquareDistanceToLineSegment(r,x,I.x1,I.y1,I.x2,I.y2);A<b&&(b=A,S=Math.sqrt(b))}}return function(r,x){for(var b=0,S=D.length;S--;){var C=D[S];if(C.maxX<=r)break;C.y1>x!=C.y2>x&&r<(C.x2-C.x1)*(x-C.y1)/(C.y2-C.y1)+C.x1&&(b+=C.y1<C.y2?1:-1)}return 0!==b}(r,x)&&(S=-S),S}}function generateIntoCanvas$2(r,x,b,S,C,I,A,R,B,D){void 0===I&&(I=1),void 0===R&&(R=0),void 0===B&&(B=0),void 0===D&&(D=0),generateIntoFramebuffer$1(r,x,b,S,C,I,A,null,R,B,D)}function generateIntoFramebuffer$1(r,x,b,S,C,I,A,R,B,D,F){void 0===I&&(I=1),void 0===B&&(B=0),void 0===D&&(D=0),void 0===F&&(F=0);for(var G=generate$2(r,x,b,S,C,I),N=new Uint8Array(4*G.length),H=0;H<G.length;H++)N[4*H+F]=G[H];renderImageData(A,N,B,D,r,x,1<<3-F,R)}function absSquareDistanceToLineSegment(r,x,b,S,C,I){var A=C-b,R=I-S,B=A*A+R*R,D=B?Math.max(0,Math.min(1,((r-b)*A+(x-S)*R)/B)):0,F=r-(b+D*A),G=x-(S+D*R);return F*F+G*G}var A=Object.freeze({__proto__:null,generate:generate$2,generateIntoCanvas:generateIntoCanvas$2,generateIntoFramebuffer:generateIntoFramebuffer$1}),R="precision highp float;uniform vec4 uGlyphBounds;attribute vec2 aUV;attribute vec4 aLineSegment;varying vec4 vLineSegment;varying vec2 vGlyphXY;void main(){vLineSegment=aLineSegment;vGlyphXY=mix(uGlyphBounds.xy,uGlyphBounds.zw,aUV);gl_Position=vec4(mix(vec2(-1.0),vec2(1.0),aUV),0.0,1.0);}",B="precision highp float;uniform vec4 uGlyphBounds;uniform float uMaxDistance;uniform float uExponent;varying vec4 vLineSegment;varying vec2 vGlyphXY;float absDistToSegment(vec2 point,vec2 lineA,vec2 lineB){vec2 lineDir=lineB-lineA;float lenSq=dot(lineDir,lineDir);float t=lenSq==0.0 ? 0.0 : clamp(dot(point-lineA,lineDir)/lenSq,0.0,1.0);vec2 linePt=lineA+t*lineDir;return distance(point,linePt);}void main(){vec4 seg=vLineSegment;vec2 p=vGlyphXY;float dist=absDistToSegment(p,seg.xy,seg.zw);float val=pow(1.0-clamp(dist/uMaxDistance,0.0,1.0),uExponent)*0.5;bool crossing=(seg.y>p.y!=seg.w>p.y)&&(p.x<(seg.z-seg.x)*(p.y-seg.y)/(seg.w-seg.y)+seg.x);bool crossingUp=crossing&&vLineSegment.y<vLineSegment.w;gl_FragColor=vec4(crossingUp ? 1.0/255.0 : 0.0,crossing&&!crossingUp ? 1.0/255.0 : 0.0,0.0,val);}",D="precision highp float;uniform sampler2D tex;varying vec2 vUV;void main(){vec4 color=texture2D(tex,vUV);bool inside=color.r!=color.g;float val=inside ? 1.0-color.a : color.a;gl_FragColor=vec4(val);}",F=new Float32Array([0,0,2,0,0,2]),G=null,N=!1,H={},W=new WeakMap;function validateSupport(r){if(!N&&!isSupported(r))throw new Error("WebGL generation not supported")}function generate$1(r,x,b,S,C,I,A){if(void 0===I&&(I=1),void 0===A&&(A=null),!A&&!(A=G)){var R="function"==typeof OffscreenCanvas?new OffscreenCanvas(1,1):"undefined"!=typeof document?document.createElement("canvas"):null;if(!R)throw new Error("OffscreenCanvas or DOM canvas not supported");A=G=R.getContext("webgl",{depth:!1})}validateSupport(A);var B=new Uint8Array(r*x*4);withWebGLContext(A,(function(A){var R=A.gl,D=A.withTexture,F=A.withTextureFramebuffer;D("readable",(function(A,D){R.texImage2D(R.TEXTURE_2D,0,R.RGBA,r,x,0,R.RGBA,R.UNSIGNED_BYTE,null),F(A,D,(function(A){generateIntoFramebuffer(r,x,b,S,C,I,R,A,0,0,0),R.readPixels(0,0,r,x,R.RGBA,R.UNSIGNED_BYTE,B)}))}))}));for(var D=new Uint8Array(r*x),F=0,N=0;F<B.length;F+=4)D[N++]=B[F];return D}function generateIntoCanvas$1(r,x,b,S,C,I,A,R,B,D){void 0===I&&(I=1),void 0===R&&(R=0),void 0===B&&(B=0),void 0===D&&(D=0),generateIntoFramebuffer(r,x,b,S,C,I,A,null,R,B,D)}function generateIntoFramebuffer(r,b,S,C,I,A,G,N,H,W,j){void 0===A&&(A=1),void 0===H&&(H=0),void 0===W&&(W=0),void 0===j&&(j=0),validateSupport(G);var V=[];pathToLineSegments(S,(function(r,x,b,S){V.push(r,x,b,S)})),V=new Float32Array(V),withWebGLContext(G,(function(S){var G=S.gl,X=S.isWebGL2,q=S.getExtension,$=S.withProgram,K=S.withTexture,Y=S.withTextureFramebuffer,Z=S.handleContextLoss;if(K("rawDistances",(function(S,K){r===S._lastWidth&&b===S._lastHeight||G.texImage2D(G.TEXTURE_2D,0,G.RGBA,S._lastWidth=r,S._lastHeight=b,0,G.RGBA,G.UNSIGNED_BYTE,null),$("main",R,B,(function(x){var R=x.setAttribute,B=x.setUniform,D=!X&&q("ANGLE_instanced_arrays"),N=!X&&q("EXT_blend_minmax");R("aUV",2,G.STATIC_DRAW,0,F),R("aLineSegment",4,G.DYNAMIC_DRAW,1,V),B.apply(void 0,["4f","uGlyphBounds"].concat(C)),B("1f","uMaxDistance",I),B("1f","uExponent",A),Y(S,K,(function(x){G.enable(G.BLEND),G.colorMask(!0,!0,!0,!0),G.viewport(0,0,r,b),G.scissor(0,0,r,b),G.blendFunc(G.ONE,G.ONE),G.blendEquationSeparate(G.FUNC_ADD,X?G.MAX:N.MAX_EXT),G.clear(G.COLOR_BUFFER_BIT),X?G.drawArraysInstanced(G.TRIANGLES,0,3,V.length/4):D.drawArraysInstancedANGLE(G.TRIANGLES,0,3,V.length/4)}))})),$("post",x,D,(function(x){x.setAttribute("aUV",2,G.STATIC_DRAW,0,F),x.setUniform("1i","tex",K),G.bindFramebuffer(G.FRAMEBUFFER,N),G.disable(G.BLEND),G.colorMask(0===j,1===j,2===j,3===j),G.viewport(H,W,r,b),G.scissor(H,W,r,b),G.drawArrays(G.TRIANGLES,0,3)}))})),G.isContextLost())throw Z(),new Error("webgl context lost")}))}function isSupported(r){var x=r&&r!==G?r.canvas||r:H,b=W.get(x);if(void 0===b){N=!0;var S=null;try{var C=[97,106,97,61,99,137,118,80,80,118,137,99,61,97,106,97],I=generate$1(4,4,"M8,8L16,8L24,24L16,24Z",[0,0,32,32],24,1,r);b=I&&C.length===I.length&&I.every((function(r,x){return r===C[x]})),b||(S="bad trial run results",console.info(C,I))}catch(r){b=!1,S=r.message}S&&console.warn("WebGL SDF generation not supported:",S),N=!1,W.set(x,b)}return b}var j=Object.freeze({__proto__:null,generate:generate$1,generateIntoCanvas:generateIntoCanvas$1,generateIntoFramebuffer:generateIntoFramebuffer,isSupported:isSupported});return r.forEachPathCommand=forEachPathCommand,r.generate=function(r,x,b,S,C,I){void 0===C&&(C=Math.max(S[2]-S[0],S[3]-S[1])/2),void 0===I&&(I=1);try{return generate$1.apply(j,arguments)}catch(r){return console.info("WebGL SDF generation failed, falling back to JS",r),generate$2.apply(A,arguments)}},r.generateIntoCanvas=function(r,x,b,S,C,I,R,B,D,F){void 0===C&&(C=Math.max(S[2]-S[0],S[3]-S[1])/2),void 0===I&&(I=1),void 0===B&&(B=0),void 0===D&&(D=0),void 0===F&&(F=0);try{return generateIntoCanvas$1.apply(j,arguments)}catch(r){return console.info("WebGL SDF generation failed, falling back to JS",r),generateIntoCanvas$2.apply(A,arguments)}},r.javascript=A,r.pathToLineSegments=pathToLineSegments,r.webgl=j,r.webglUtils=I,Object.defineProperty(r,"__esModule",{value:!0}),r}({});return r}const Bi=/\bvoid\s+main\s*\(\s*\)\s*{/g;function expandShaderIncludes(r){return r.replace(/^[ \t]*#include +<([\w\d./]+)>/gm,(function(r,x){let b=mt[x];return b?expandShaderIncludes(b):r}))}const Li=[];for(let r=0;r<256;r++)Li[r]=(r<16?"0":"")+r.toString(16);const Oi=Object.assign||function(){let r=arguments[0];for(let x=1,b=arguments.length;x<b;x++){let b=arguments[x];if(b)for(let x in b)Object.prototype.hasOwnProperty.call(b,x)&&(r[x]=b[x])}return r},Di=Date.now(),Ui=new WeakMap,Fi=new Map;let Gi=1e10;function createDerivedMaterial(r,x){const b=function(r){const x=JSON.stringify(r,optionsJsonReplacer);let b=Hi.get(x);null==b&&Hi.set(x,b=++Ni);return b}
/*!
Custom build of Typr.ts (https://github.com/fredli74/Typr.ts) for use in Troika text rendering.
Original MIT license applies: https://github.com/fredli74/Typr.ts/blob/master/LICENSE
*/(x);let S=Ui.get(r);if(S||Ui.set(r,S=Object.create(null)),S[b])return new S[b];const C=`_onBeforeCompile${b}`,onBeforeCompile=function(S,I){r.onBeforeCompile.call(this,S,I);const A=this.customProgramCacheKey()+"|"+S.vertexShader+"|"+S.fragmentShader;let R=Fi[A];if(!R){const r=function(r,{vertexShader:x,fragmentShader:b},S,C){let{vertexDefs:I,vertexMainIntro:A,vertexMainOutro:R,vertexTransform:B,fragmentDefs:D,fragmentMainIntro:F,fragmentMainOutro:G,fragmentColorTransform:N,customRewriter:H,timeUniform:W}=S;I=I||"",A=A||"",R=R||"",D=D||"",F=F||"",G=G||"",(B||H)&&(x=expandShaderIncludes(x));(N||H)&&(b=expandShaderIncludes(b=b.replace(/^[ \t]*#include <((?:tonemapping|encodings|colorspace|fog|premultiplied_alpha|dithering)_fragment)>/gm,"\n//!BEGIN_POST_CHUNK $1\n$&\n//!END_POST_CHUNK\n")));if(H){let r=H({vertexShader:x,fragmentShader:b});x=r.vertexShader,b=r.fragmentShader}if(N){let r=[];b=b.replace(/^\/\/!BEGIN_POST_CHUNK[^]+?^\/\/!END_POST_CHUNK/gm,(x=>(r.push(x),""))),G=`${N}\n${r.join("\n")}\n${G}`}if(W){const r=`\nuniform float ${W};\n`;I=r+I,D=r+D}B&&(I=`${I}\nvoid troikaVertexTransform${C}(inout vec3 position, inout vec3 normal, inout vec2 uv) {\n  ${B}\n}\n`,A=`\ntroika_position_${C} = vec3(position);\ntroika_normal_${C} = vec3(normal);\ntroika_uv_${C} = vec2(uv);\ntroikaVertexTransform${C}(troika_position_${C}, troika_normal_${C}, troika_uv_${C});\n${A}\n`,x=(x=`vec3 troika_position_${C};\nvec3 troika_normal_${C};\nvec2 troika_uv_${C};\n${x}\n`).replace(/\b(position|normal|uv)\b/g,((r,x,b,S)=>/\battribute\s+vec[23]\s+$/.test(S.substr(0,b))?x:`troika_${x}_${C}`)),r.map&&r.map.channel>0||(x=x.replace(/\bMAP_UV\b/g,`troika_uv_${C}`)));return x=injectIntoShaderCode(x,C,I,A,R),b=injectIntoShaderCode(b,C,D,F,G),{vertexShader:x,fragmentShader:b}}(this,S,x,b);R=Fi[A]=r}S.vertexShader=R.vertexShader,S.fragmentShader=R.fragmentShader,Oi(S.uniforms,this.uniforms),x.timeUniform&&(S.uniforms[x.timeUniform]={get value(){return Date.now()-Di}}),this[C]&&this[C](S)},DerivedMaterial=function(){return derive(x.chained?r:r.clone())},derive=function(S){const C=Object.create(S,I);return Object.defineProperty(C,"baseMaterial",{value:r}),Object.defineProperty(C,"id",{value:Gi++}),C.uuid=function(){const r=4294967295*Math.random()|0,x=4294967295*Math.random()|0,b=4294967295*Math.random()|0,S=4294967295*Math.random()|0;return(Li[255&r]+Li[r>>8&255]+Li[r>>16&255]+Li[r>>24&255]+"-"+Li[255&x]+Li[x>>8&255]+"-"+Li[x>>16&15|64]+Li[x>>24&255]+"-"+Li[63&b|128]+Li[b>>8&255]+"-"+Li[b>>16&255]+Li[b>>24&255]+Li[255&S]+Li[S>>8&255]+Li[S>>16&255]+Li[S>>24&255]).toUpperCase()}(),C.uniforms=Oi({},S.uniforms,x.uniforms),C.defines=Oi({},S.defines,x.defines),C.defines[`TROIKA_DERIVED_MATERIAL_${b}`]="",C.extensions=Oi({},S.extensions,x.extensions),C._listeners=void 0,C},I={constructor:{value:DerivedMaterial},isDerivedMaterial:{value:!0},type:{get:()=>r.type,set:x=>{r.type=x}},isDerivedFrom:{writable:!0,configurable:!0,value:function(r){const x=this.baseMaterial;return r===x||x.isDerivedMaterial&&x.isDerivedFrom(r)||!1}},customProgramCacheKey:{writable:!0,configurable:!0,value:function(){return r.customProgramCacheKey()+"|"+b}},onBeforeCompile:{get:()=>onBeforeCompile,set(r){this[C]=r}},copy:{writable:!0,configurable:!0,value:function(x){return r.copy.call(this,x),r.isShaderMaterial||r.isDerivedMaterial||(Oi(this.extensions,x.extensions),Oi(this.defines,x.defines),Oi(this.uniforms,ut.clone(x.uniforms))),this}},clone:{writable:!0,configurable:!0,value:function(){const x=new r.constructor;return derive(x).copy(this)}},getDepthMaterial:{writable:!0,configurable:!0,value:function(){let b=this._depthMaterial;return b||(b=this._depthMaterial=createDerivedMaterial(r.isDerivedMaterial?r.getDepthMaterial():new pt({depthPacking:ft}),x),b.defines.IS_DEPTH_MATERIAL="",b.uniforms=this.uniforms),b}},getDistanceMaterial:{writable:!0,configurable:!0,value:function(){let b=this._distanceMaterial;return b||(b=this._distanceMaterial=createDerivedMaterial(r.isDerivedMaterial?r.getDistanceMaterial():new gt,x),b.defines.IS_DISTANCE_MATERIAL="",b.uniforms=this.uniforms),b}},dispose:{writable:!0,configurable:!0,value(){const{_depthMaterial:x,_distanceMaterial:b}=this;x&&x.dispose(),b&&b.dispose(),r.dispose.call(this)}}};return S[b]=DerivedMaterial,new DerivedMaterial}function injectIntoShaderCode(r,x,b,S,C){return(S||C||b)&&(r=r.replace(Bi,`\n${b}\nvoid troikaOrigMain${x}() {`),r+=`\nvoid main() {\n  ${S}\n  troikaOrigMain${x}();\n  ${C}\n}`),r}function optionsJsonReplacer(r,x){return"uniforms"===r?void 0:"function"==typeof x?x.toString():x}let Ni=0;const Hi=new Map;const Wi=defineWorkerModule({name:"Typr Font Parser",dependencies:[function(){return"undefined"==typeof window&&(self.window=self),function(r){var x={parse:function(r){var b=x._bin,S=new Uint8Array(r);if("ttcf"==b.readASCII(S,0,4)){var C=4;b.readUshort(S,C),C+=2,b.readUshort(S,C),C+=2;var I=b.readUint(S,C);C+=4;for(var A=[],R=0;R<I;R++){var B=b.readUint(S,C);C+=4,A.push(x._readFont(S,B))}return A}return[x._readFont(S,0)]},_readFont:function(r,b){var S=x._bin,C=b;S.readFixed(r,b),b+=4;var I=S.readUshort(r,b);b+=2,S.readUshort(r,b),b+=2,S.readUshort(r,b),b+=2,S.readUshort(r,b),b+=2;for(var A=["cmap","head","hhea","maxp","hmtx","name","OS/2","post","loca","glyf","kern","CFF ","GDEF","GPOS","GSUB","SVG "],R={_data:r,_offset:C},B={},D=0;D<I;D++){var F=S.readASCII(r,b,4);b+=4,S.readUint(r,b),b+=4;var G=S.readUint(r,b);b+=4;var N=S.readUint(r,b);b+=4,B[F]={offset:G,length:N}}for(D=0;D<A.length;D++){var H=A[D];B[H]&&(R[H.trim()]=x[H.trim()].parse(r,B[H].offset,B[H].length,R))}return R},_tabOffset:function(r,b,S){for(var C=x._bin,I=C.readUshort(r,S+4),A=S+12,R=0;R<I;R++){var B=C.readASCII(r,A,4);A+=4,C.readUint(r,A),A+=4;var D=C.readUint(r,A);if(A+=4,C.readUint(r,A),A+=4,B==b)return D}return 0}};x._bin={readFixed:function(r,x){return(r[x]<<8|r[x+1])+(r[x+2]<<8|r[x+3])/65540},readF2dot14:function(r,b){return x._bin.readShort(r,b)/16384},readInt:function(r,b){return x._bin._view(r).getInt32(b)},readInt8:function(r,b){return x._bin._view(r).getInt8(b)},readShort:function(r,b){return x._bin._view(r).getInt16(b)},readUshort:function(r,b){return x._bin._view(r).getUint16(b)},readUshorts:function(r,b,S){for(var C=[],I=0;I<S;I++)C.push(x._bin.readUshort(r,b+2*I));return C},readUint:function(r,b){return x._bin._view(r).getUint32(b)},readUint64:function(r,b){return 4294967296*x._bin.readUint(r,b)+x._bin.readUint(r,b+4)},readASCII:function(r,x,b){for(var S="",C=0;C<b;C++)S+=String.fromCharCode(r[x+C]);return S},readUnicode:function(r,x,b){for(var S="",C=0;C<b;C++){var I=r[x++]<<8|r[x++];S+=String.fromCharCode(I)}return S},_tdec:"undefined"!=typeof window&&window.TextDecoder?new window.TextDecoder:null,readUTF8:function(r,b,S){var C=x._bin._tdec;return C&&0==b&&S==r.length?C.decode(r):x._bin.readASCII(r,b,S)},readBytes:function(r,x,b){for(var S=[],C=0;C<b;C++)S.push(r[x+C]);return S},readASCIIArray:function(r,x,b){for(var S=[],C=0;C<b;C++)S.push(String.fromCharCode(r[x+C]));return S},_view:function(r){return r._dataView||(r._dataView=r.buffer?new DataView(r.buffer,r.byteOffset,r.byteLength):new DataView(new Uint8Array(r).buffer))}},x._lctf={},x._lctf.parse=function(r,b,S,C,I){var A=x._bin,R={},B=b;A.readFixed(r,b),b+=4;var D=A.readUshort(r,b);b+=2;var F=A.readUshort(r,b);b+=2;var G=A.readUshort(r,b);return b+=2,R.scriptList=x._lctf.readScriptList(r,B+D),R.featureList=x._lctf.readFeatureList(r,B+F),R.lookupList=x._lctf.readLookupList(r,B+G,I),R},x._lctf.readLookupList=function(r,b,S){var C=x._bin,I=b,A=[],R=C.readUshort(r,b);b+=2;for(var B=0;B<R;B++){var D=C.readUshort(r,b);b+=2;var F=x._lctf.readLookupTable(r,I+D,S);A.push(F)}return A},x._lctf.readLookupTable=function(r,b,S){var C=x._bin,I=b,A={tabs:[]};A.ltype=C.readUshort(r,b),b+=2,A.flag=C.readUshort(r,b),b+=2;var R=C.readUshort(r,b);b+=2;for(var B=A.ltype,D=0;D<R;D++){var F=C.readUshort(r,b);b+=2;var G=S(r,B,I+F,A);A.tabs.push(G)}return A},x._lctf.numOfOnes=function(r){for(var x=0,b=0;b<32;b++)0!=(r>>>b&1)&&x++;return x},x._lctf.readClassDef=function(r,b){var S=x._bin,C=[],I=S.readUshort(r,b);if(b+=2,1==I){var A=S.readUshort(r,b);b+=2;var R=S.readUshort(r,b);b+=2;for(var B=0;B<R;B++)C.push(A+B),C.push(A+B),C.push(S.readUshort(r,b)),b+=2}if(2==I){var D=S.readUshort(r,b);for(b+=2,B=0;B<D;B++)C.push(S.readUshort(r,b)),b+=2,C.push(S.readUshort(r,b)),b+=2,C.push(S.readUshort(r,b)),b+=2}return C},x._lctf.getInterval=function(r,x){for(var b=0;b<r.length;b+=3){var S=r[b],C=r[b+1];if(r[b+2],S<=x&&x<=C)return b}return-1},x._lctf.readCoverage=function(r,b){var S=x._bin,C={};C.fmt=S.readUshort(r,b),b+=2;var I=S.readUshort(r,b);return b+=2,1==C.fmt&&(C.tab=S.readUshorts(r,b,I)),2==C.fmt&&(C.tab=S.readUshorts(r,b,3*I)),C},x._lctf.coverageIndex=function(r,b){var S=r.tab;if(1==r.fmt)return S.indexOf(b);if(2==r.fmt){var C=x._lctf.getInterval(S,b);if(-1!=C)return S[C+2]+(b-S[C])}return-1},x._lctf.readFeatureList=function(r,b){var S=x._bin,C=b,I=[],A=S.readUshort(r,b);b+=2;for(var R=0;R<A;R++){var B=S.readASCII(r,b,4);b+=4;var D=S.readUshort(r,b);b+=2;var F=x._lctf.readFeatureTable(r,C+D);F.tag=B.trim(),I.push(F)}return I},x._lctf.readFeatureTable=function(r,b){var S=x._bin,C=b,I={},A=S.readUshort(r,b);b+=2,A>0&&(I.featureParams=C+A);var R=S.readUshort(r,b);b+=2,I.tab=[];for(var B=0;B<R;B++)I.tab.push(S.readUshort(r,b+2*B));return I},x._lctf.readScriptList=function(r,b){var S=x._bin,C=b,I={},A=S.readUshort(r,b);b+=2;for(var R=0;R<A;R++){var B=S.readASCII(r,b,4);b+=4;var D=S.readUshort(r,b);b+=2,I[B.trim()]=x._lctf.readScriptTable(r,C+D)}return I},x._lctf.readScriptTable=function(r,b){var S=x._bin,C=b,I={},A=S.readUshort(r,b);b+=2,A>0&&(I.default=x._lctf.readLangSysTable(r,C+A));var R=S.readUshort(r,b);b+=2;for(var B=0;B<R;B++){var D=S.readASCII(r,b,4);b+=4;var F=S.readUshort(r,b);b+=2,I[D.trim()]=x._lctf.readLangSysTable(r,C+F)}return I},x._lctf.readLangSysTable=function(r,b){var S=x._bin,C={};S.readUshort(r,b),b+=2,C.reqFeature=S.readUshort(r,b),b+=2;var I=S.readUshort(r,b);return b+=2,C.features=S.readUshorts(r,b,I),C},x.CFF={},x.CFF.parse=function(r,b,S){var C=x._bin;(r=new Uint8Array(r.buffer,b,S))[b=0],r[++b],r[++b],r[++b],b++;var I=[];b=x.CFF.readIndex(r,b,I);for(var A=[],R=0;R<I.length-1;R++)A.push(C.readASCII(r,b+I[R],I[R+1]-I[R]));b+=I[I.length-1];var B=[];b=x.CFF.readIndex(r,b,B);var D=[];for(R=0;R<B.length-1;R++)D.push(x.CFF.readDict(r,b+B[R],b+B[R+1]));b+=B[B.length-1];var F=D[0],G=[];b=x.CFF.readIndex(r,b,G);var N=[];for(R=0;R<G.length-1;R++)N.push(C.readASCII(r,b+G[R],G[R+1]-G[R]));if(b+=G[G.length-1],x.CFF.readSubrs(r,b,F),F.CharStrings){b=F.CharStrings,G=[],b=x.CFF.readIndex(r,b,G);var H=[];for(R=0;R<G.length-1;R++)H.push(C.readBytes(r,b+G[R],G[R+1]-G[R]));F.CharStrings=H}if(F.ROS){b=F.FDArray;var W=[];for(b=x.CFF.readIndex(r,b,W),F.FDArray=[],R=0;R<W.length-1;R++){var j=x.CFF.readDict(r,b+W[R],b+W[R+1]);x.CFF._readFDict(r,j,N),F.FDArray.push(j)}b+=W[W.length-1],b=F.FDSelect,F.FDSelect=[];var V=r[b];if(b++,3!=V)throw V;var X=C.readUshort(r,b);for(b+=2,R=0;R<X+1;R++)F.FDSelect.push(C.readUshort(r,b),r[b+2]),b+=3}return F.Encoding&&(F.Encoding=x.CFF.readEncoding(r,F.Encoding,F.CharStrings.length)),F.charset&&(F.charset=x.CFF.readCharset(r,F.charset,F.CharStrings.length)),x.CFF._readFDict(r,F,N),F},x.CFF._readFDict=function(r,b,S){var C;for(var I in b.Private&&(C=b.Private[1],b.Private=x.CFF.readDict(r,C,C+b.Private[0]),b.Private.Subrs&&x.CFF.readSubrs(r,C+b.Private.Subrs,b.Private)),b)-1!=["FamilyName","FontName","FullName","Notice","version","Copyright"].indexOf(I)&&(b[I]=S[b[I]-426+35])},x.CFF.readSubrs=function(r,b,S){var C=x._bin,I=[];b=x.CFF.readIndex(r,b,I);var A,R=I.length;A=R<1240?107:R<33900?1131:32768,S.Bias=A,S.Subrs=[];for(var B=0;B<I.length-1;B++)S.Subrs.push(C.readBytes(r,b+I[B],I[B+1]-I[B]))},x.CFF.tableSE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,0,111,112,113,114,0,115,116,117,118,119,120,121,122,0,123,0,124,125,126,127,128,129,130,131,0,132,133,0,134,135,136,137,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,138,0,139,0,0,0,0,140,141,142,143,0,0,0,0,0,144,0,0,0,145,0,0,146,147,148,149,0,0,0,0],x.CFF.glyphByUnicode=function(r,x){for(var b=0;b<r.charset.length;b++)if(r.charset[b]==x)return b;return-1},x.CFF.glyphBySE=function(r,b){return b<0||b>255?-1:x.CFF.glyphByUnicode(r,x.CFF.tableSE[b])},x.CFF.readEncoding=function(r,b,S){x._bin;var C=[".notdef"],I=r[b];if(b++,0!=I)throw"error: unknown encoding format: "+I;var A=r[b];b++;for(var R=0;R<A;R++)C.push(r[b+R]);return C},x.CFF.readCharset=function(r,b,S){var C=x._bin,I=[".notdef"],A=r[b];if(b++,0==A)for(var R=0;R<S;R++){var B=C.readUshort(r,b);b+=2,I.push(B)}else{if(1!=A&&2!=A)throw"error: format: "+A;for(;I.length<S;){B=C.readUshort(r,b),b+=2;var D=0;for(1==A?(D=r[b],b++):(D=C.readUshort(r,b),b+=2),R=0;R<=D;R++)I.push(B),B++}}return I},x.CFF.readIndex=function(r,b,S){var C=x._bin,I=C.readUshort(r,b)+1,A=r[b+=2];if(b++,1==A)for(var R=0;R<I;R++)S.push(r[b+R]);else if(2==A)for(R=0;R<I;R++)S.push(C.readUshort(r,b+2*R));else if(3==A)for(R=0;R<I;R++)S.push(16777215&C.readUint(r,b+3*R-1));else if(1!=I)throw"unsupported offset size: "+A+", count: "+I;return(b+=I*A)-1},x.CFF.getCharString=function(r,b,S){var C=x._bin,I=r[b],A=r[b+1];r[b+2],r[b+3],r[b+4];var R=1,B=null,D=null;I<=20&&(B=I,R=1),12==I&&(B=100*I+A,R=2),21<=I&&I<=27&&(B=I,R=1),28==I&&(D=C.readShort(r,b+1),R=3),29<=I&&I<=31&&(B=I,R=1),32<=I&&I<=246&&(D=I-139,R=1),247<=I&&I<=250&&(D=256*(I-247)+A+108,R=2),251<=I&&I<=254&&(D=256*-(I-251)-A-108,R=2),255==I&&(D=C.readInt(r,b+1)/65535,R=5),S.val=null!=D?D:"o"+B,S.size=R},x.CFF.readCharString=function(r,b,S){for(var C=b+S,I=x._bin,A=[];b<C;){var R=r[b],B=r[b+1];r[b+2],r[b+3],r[b+4];var D=1,F=null,G=null;R<=20&&(F=R,D=1),12==R&&(F=100*R+B,D=2),19!=R&&20!=R||(F=R,D=2),21<=R&&R<=27&&(F=R,D=1),28==R&&(G=I.readShort(r,b+1),D=3),29<=R&&R<=31&&(F=R,D=1),32<=R&&R<=246&&(G=R-139,D=1),247<=R&&R<=250&&(G=256*(R-247)+B+108,D=2),251<=R&&R<=254&&(G=256*-(R-251)-B-108,D=2),255==R&&(G=I.readInt(r,b+1)/65535,D=5),A.push(null!=G?G:"o"+F),b+=D}return A},x.CFF.readDict=function(r,b,S){for(var C=x._bin,I={},A=[];b<S;){var R=r[b],B=r[b+1];r[b+2],r[b+3],r[b+4];var D=1,F=null,G=null;if(28==R&&(G=C.readShort(r,b+1),D=3),29==R&&(G=C.readInt(r,b+1),D=5),32<=R&&R<=246&&(G=R-139,D=1),247<=R&&R<=250&&(G=256*(R-247)+B+108,D=2),251<=R&&R<=254&&(G=256*-(R-251)-B-108,D=2),255==R)throw G=C.readInt(r,b+1)/65535,D=5,"unknown number";if(30==R){var N=[];for(D=1;;){var H=r[b+D];D++;var W=H>>4,j=15&H;if(15!=W&&N.push(W),15!=j&&N.push(j),15==j)break}for(var V="",X=[0,1,2,3,4,5,6,7,8,9,".","e","e-","reserved","-","endOfNumber"],q=0;q<N.length;q++)V+=X[N[q]];G=parseFloat(V)}R<=21&&(F=["version","Notice","FullName","FamilyName","Weight","FontBBox","BlueValues","OtherBlues","FamilyBlues","FamilyOtherBlues","StdHW","StdVW","escape","UniqueID","XUID","charset","Encoding","CharStrings","Private","Subrs","defaultWidthX","nominalWidthX"][R],D=1,12==R&&(F=["Copyright","isFixedPitch","ItalicAngle","UnderlinePosition","UnderlineThickness","PaintType","CharstringType","FontMatrix","StrokeWidth","BlueScale","BlueShift","BlueFuzz","StemSnapH","StemSnapV","ForceBold",0,0,"LanguageGroup","ExpansionFactor","initialRandomSeed","SyntheticBase","PostScript","BaseFontName","BaseFontBlend",0,0,0,0,0,0,"ROS","CIDFontVersion","CIDFontRevision","CIDFontType","CIDCount","UIDBase","FDArray","FDSelect","FontName"][B],D=2)),null!=F?(I[F]=1==A.length?A[0]:A,A=[]):A.push(G),b+=D}return I},x.cmap={},x.cmap.parse=function(r,b,S){r=new Uint8Array(r.buffer,b,S),b=0;var C=x._bin,I={};C.readUshort(r,b),b+=2;var A=C.readUshort(r,b);b+=2;var R=[];I.tables=[];for(var B=0;B<A;B++){var D=C.readUshort(r,b);b+=2;var F=C.readUshort(r,b);b+=2;var G=C.readUint(r,b);b+=4;var N="p"+D+"e"+F,H=R.indexOf(G);if(-1==H){var W;H=I.tables.length,R.push(G);var j=C.readUshort(r,G);0==j?W=x.cmap.parse0(r,G):4==j?W=x.cmap.parse4(r,G):6==j?W=x.cmap.parse6(r,G):12==j?W=x.cmap.parse12(r,G):console.debug("unknown format: "+j,D,F,G),I.tables.push(W)}if(null!=I[N])throw"multiple tables for one platform+encoding";I[N]=H}return I},x.cmap.parse0=function(r,b){var S=x._bin,C={};C.format=S.readUshort(r,b),b+=2;var I=S.readUshort(r,b);b+=2,S.readUshort(r,b),b+=2,C.map=[];for(var A=0;A<I-6;A++)C.map.push(r[b+A]);return C},x.cmap.parse4=function(r,b){var S=x._bin,C=b,I={};I.format=S.readUshort(r,b),b+=2;var A=S.readUshort(r,b);b+=2,S.readUshort(r,b),b+=2;var R=S.readUshort(r,b);b+=2;var B=R/2;I.searchRange=S.readUshort(r,b),b+=2,I.entrySelector=S.readUshort(r,b),b+=2,I.rangeShift=S.readUshort(r,b),b+=2,I.endCount=S.readUshorts(r,b,B),b+=2*B,b+=2,I.startCount=S.readUshorts(r,b,B),b+=2*B,I.idDelta=[];for(var D=0;D<B;D++)I.idDelta.push(S.readShort(r,b)),b+=2;for(I.idRangeOffset=S.readUshorts(r,b,B),b+=2*B,I.glyphIdArray=[];b<C+A;)I.glyphIdArray.push(S.readUshort(r,b)),b+=2;return I},x.cmap.parse6=function(r,b){var S=x._bin,C={};C.format=S.readUshort(r,b),b+=2,S.readUshort(r,b),b+=2,S.readUshort(r,b),b+=2,C.firstCode=S.readUshort(r,b),b+=2;var I=S.readUshort(r,b);b+=2,C.glyphIdArray=[];for(var A=0;A<I;A++)C.glyphIdArray.push(S.readUshort(r,b)),b+=2;return C},x.cmap.parse12=function(r,b){var S=x._bin,C={};C.format=S.readUshort(r,b),b+=2,b+=2,S.readUint(r,b),b+=4,S.readUint(r,b),b+=4;var I=S.readUint(r,b);b+=4,C.groups=[];for(var A=0;A<I;A++){var R=b+12*A,B=S.readUint(r,R+0),D=S.readUint(r,R+4),F=S.readUint(r,R+8);C.groups.push([B,D,F])}return C},x.glyf={},x.glyf.parse=function(r,x,b,S){for(var C=[],I=0;I<S.maxp.numGlyphs;I++)C.push(null);return C},x.glyf._parseGlyf=function(r,b){var S=x._bin,C=r._data,I=x._tabOffset(C,"glyf",r._offset)+r.loca[b];if(r.loca[b]==r.loca[b+1])return null;var A={};if(A.noc=S.readShort(C,I),I+=2,A.xMin=S.readShort(C,I),I+=2,A.yMin=S.readShort(C,I),I+=2,A.xMax=S.readShort(C,I),I+=2,A.yMax=S.readShort(C,I),I+=2,A.xMin>=A.xMax||A.yMin>=A.yMax)return null;if(A.noc>0){A.endPts=[];for(var R=0;R<A.noc;R++)A.endPts.push(S.readUshort(C,I)),I+=2;var B=S.readUshort(C,I);if(I+=2,C.length-I<B)return null;A.instructions=S.readBytes(C,I,B),I+=B;var D=A.endPts[A.noc-1]+1;for(A.flags=[],R=0;R<D;R++){var F=C[I];if(I++,A.flags.push(F),0!=(8&F)){var G=C[I];I++;for(var N=0;N<G;N++)A.flags.push(F),R++}}for(A.xs=[],R=0;R<D;R++){var H=0!=(2&A.flags[R]),W=0!=(16&A.flags[R]);H?(A.xs.push(W?C[I]:-C[I]),I++):W?A.xs.push(0):(A.xs.push(S.readShort(C,I)),I+=2)}for(A.ys=[],R=0;R<D;R++)H=0!=(4&A.flags[R]),W=0!=(32&A.flags[R]),H?(A.ys.push(W?C[I]:-C[I]),I++):W?A.ys.push(0):(A.ys.push(S.readShort(C,I)),I+=2);var j=0,V=0;for(R=0;R<D;R++)j+=A.xs[R],V+=A.ys[R],A.xs[R]=j,A.ys[R]=V}else{var X;A.parts=[];do{X=S.readUshort(C,I),I+=2;var q={m:{a:1,b:0,c:0,d:1,tx:0,ty:0},p1:-1,p2:-1};if(A.parts.push(q),q.glyphIndex=S.readUshort(C,I),I+=2,1&X){var $=S.readShort(C,I);I+=2;var K=S.readShort(C,I);I+=2}else $=S.readInt8(C,I),I++,K=S.readInt8(C,I),I++;2&X?(q.m.tx=$,q.m.ty=K):(q.p1=$,q.p2=K),8&X?(q.m.a=q.m.d=S.readF2dot14(C,I),I+=2):64&X?(q.m.a=S.readF2dot14(C,I),I+=2,q.m.d=S.readF2dot14(C,I),I+=2):128&X&&(q.m.a=S.readF2dot14(C,I),I+=2,q.m.b=S.readF2dot14(C,I),I+=2,q.m.c=S.readF2dot14(C,I),I+=2,q.m.d=S.readF2dot14(C,I),I+=2)}while(32&X);if(256&X){var Y=S.readUshort(C,I);for(I+=2,A.instr=[],R=0;R<Y;R++)A.instr.push(C[I]),I++}}return A},x.GDEF={},x.GDEF.parse=function(r,b,S,C){var I=b;b+=4;var A=x._bin.readUshort(r,b);return{glyphClassDef:0===A?null:x._lctf.readClassDef(r,I+A)}},x.GPOS={},x.GPOS.parse=function(r,b,S,C){return x._lctf.parse(r,b,S,C,x.GPOS.subt)},x.GPOS.subt=function(r,b,S,C){var I=x._bin,A=S,R={};if(R.fmt=I.readUshort(r,S),S+=2,1==b||2==b||3==b||7==b||8==b&&R.fmt<=2){var B=I.readUshort(r,S);S+=2,R.coverage=x._lctf.readCoverage(r,B+A)}if(1==b&&1==R.fmt){var D=I.readUshort(r,S);S+=2,0!=D&&(R.pos=x.GPOS.readValueRecord(r,S,D))}else if(2==b&&R.fmt>=1&&R.fmt<=2){D=I.readUshort(r,S),S+=2;var F=I.readUshort(r,S);S+=2;var G=x._lctf.numOfOnes(D),N=x._lctf.numOfOnes(F);if(1==R.fmt){R.pairsets=[];var H=I.readUshort(r,S);S+=2;for(var W=0;W<H;W++){var j=A+I.readUshort(r,S);S+=2;var V=I.readUshort(r,j);j+=2;for(var X=[],q=0;q<V;q++){var $=I.readUshort(r,j);j+=2,0!=D&&(ee=x.GPOS.readValueRecord(r,j,D),j+=2*G),0!=F&&(te=x.GPOS.readValueRecord(r,j,F),j+=2*N),X.push({gid2:$,val1:ee,val2:te})}R.pairsets.push(X)}}if(2==R.fmt){var K=I.readUshort(r,S);S+=2;var Y=I.readUshort(r,S);S+=2;var Z=I.readUshort(r,S);S+=2;var J=I.readUshort(r,S);for(S+=2,R.classDef1=x._lctf.readClassDef(r,A+K),R.classDef2=x._lctf.readClassDef(r,A+Y),R.matrix=[],W=0;W<Z;W++){var Q=[];for(q=0;q<J;q++){var ee=null,te=null;0!=D&&(ee=x.GPOS.readValueRecord(r,S,D),S+=2*G),0!=F&&(te=x.GPOS.readValueRecord(r,S,F),S+=2*N),Q.push({val1:ee,val2:te})}R.matrix.push(Q)}}}else if(4==b&&1==R.fmt)R.markCoverage=x._lctf.readCoverage(r,I.readUshort(r,S)+A),R.baseCoverage=x._lctf.readCoverage(r,I.readUshort(r,S+2)+A),R.markClassCount=I.readUshort(r,S+4),R.markArray=x.GPOS.readMarkArray(r,I.readUshort(r,S+6)+A),R.baseArray=x.GPOS.readBaseArray(r,I.readUshort(r,S+8)+A,R.markClassCount);else if(6==b&&1==R.fmt)R.mark1Coverage=x._lctf.readCoverage(r,I.readUshort(r,S)+A),R.mark2Coverage=x._lctf.readCoverage(r,I.readUshort(r,S+2)+A),R.markClassCount=I.readUshort(r,S+4),R.mark1Array=x.GPOS.readMarkArray(r,I.readUshort(r,S+6)+A),R.mark2Array=x.GPOS.readBaseArray(r,I.readUshort(r,S+8)+A,R.markClassCount);else{if(9==b&&1==R.fmt){var ne=I.readUshort(r,S);S+=2;var re=I.readUint(r,S);if(S+=4,9==C.ltype)C.ltype=ne;else if(C.ltype!=ne)throw"invalid extension substitution";return x.GPOS.subt(r,C.ltype,A+re)}console.debug("unsupported GPOS table LookupType",b,"format",R.fmt)}return R},x.GPOS.readValueRecord=function(r,b,S){var C=x._bin,I=[];return I.push(1&S?C.readShort(r,b):0),b+=1&S?2:0,I.push(2&S?C.readShort(r,b):0),b+=2&S?2:0,I.push(4&S?C.readShort(r,b):0),b+=4&S?2:0,I.push(8&S?C.readShort(r,b):0),b+=8&S?2:0,I},x.GPOS.readBaseArray=function(r,b,S){var C=x._bin,I=[],A=b,R=C.readUshort(r,b);b+=2;for(var B=0;B<R;B++){for(var D=[],F=0;F<S;F++)D.push(x.GPOS.readAnchorRecord(r,A+C.readUshort(r,b))),b+=2;I.push(D)}return I},x.GPOS.readMarkArray=function(r,b){var S=x._bin,C=[],I=b,A=S.readUshort(r,b);b+=2;for(var R=0;R<A;R++){var B=x.GPOS.readAnchorRecord(r,S.readUshort(r,b+2)+I);B.markClass=S.readUshort(r,b),C.push(B),b+=4}return C},x.GPOS.readAnchorRecord=function(r,b){var S=x._bin,C={};return C.fmt=S.readUshort(r,b),C.x=S.readShort(r,b+2),C.y=S.readShort(r,b+4),C},x.GSUB={},x.GSUB.parse=function(r,b,S,C){return x._lctf.parse(r,b,S,C,x.GSUB.subt)},x.GSUB.subt=function(r,b,S,C){var I=x._bin,A=S,R={};if(R.fmt=I.readUshort(r,S),S+=2,1!=b&&2!=b&&4!=b&&5!=b&&6!=b)return null;if(1==b||2==b||4==b||5==b&&R.fmt<=2||6==b&&R.fmt<=2){var B=I.readUshort(r,S);S+=2,R.coverage=x._lctf.readCoverage(r,A+B)}if(1==b&&R.fmt>=1&&R.fmt<=2){if(1==R.fmt)R.delta=I.readShort(r,S),S+=2;else if(2==R.fmt){var D=I.readUshort(r,S);S+=2,R.newg=I.readUshorts(r,S,D),S+=2*R.newg.length}}else if(2==b&&1==R.fmt){D=I.readUshort(r,S),S+=2,R.seqs=[];for(var F=0;F<D;F++){var G=I.readUshort(r,S)+A;S+=2;var N=I.readUshort(r,G);R.seqs.push(I.readUshorts(r,G+2,N))}}else if(4==b)for(R.vals=[],D=I.readUshort(r,S),S+=2,F=0;F<D;F++){var H=I.readUshort(r,S);S+=2,R.vals.push(x.GSUB.readLigatureSet(r,A+H))}else if(5==b&&2==R.fmt){if(2==R.fmt){var W=I.readUshort(r,S);S+=2,R.cDef=x._lctf.readClassDef(r,A+W),R.scset=[];var j=I.readUshort(r,S);for(S+=2,F=0;F<j;F++){var V=I.readUshort(r,S);S+=2,R.scset.push(0==V?null:x.GSUB.readSubClassSet(r,A+V))}}}else if(6==b&&3==R.fmt){if(3==R.fmt){for(F=0;F<3;F++){D=I.readUshort(r,S),S+=2;for(var X=[],q=0;q<D;q++)X.push(x._lctf.readCoverage(r,A+I.readUshort(r,S+2*q)));S+=2*D,0==F&&(R.backCvg=X),1==F&&(R.inptCvg=X),2==F&&(R.ahedCvg=X)}D=I.readUshort(r,S),S+=2,R.lookupRec=x.GSUB.readSubstLookupRecords(r,S,D)}}else{if(7==b&&1==R.fmt){var $=I.readUshort(r,S);S+=2;var K=I.readUint(r,S);if(S+=4,9==C.ltype)C.ltype=$;else if(C.ltype!=$)throw"invalid extension substitution";return x.GSUB.subt(r,C.ltype,A+K)}console.debug("unsupported GSUB table LookupType",b,"format",R.fmt)}return R},x.GSUB.readSubClassSet=function(r,b){var S=x._bin.readUshort,C=b,I=[],A=S(r,b);b+=2;for(var R=0;R<A;R++){var B=S(r,b);b+=2,I.push(x.GSUB.readSubClassRule(r,C+B))}return I},x.GSUB.readSubClassRule=function(r,b){var S=x._bin.readUshort,C={},I=S(r,b),A=S(r,b+=2);b+=2,C.input=[];for(var R=0;R<I-1;R++)C.input.push(S(r,b)),b+=2;return C.substLookupRecords=x.GSUB.readSubstLookupRecords(r,b,A),C},x.GSUB.readSubstLookupRecords=function(r,b,S){for(var C=x._bin.readUshort,I=[],A=0;A<S;A++)I.push(C(r,b),C(r,b+2)),b+=4;return I},x.GSUB.readChainSubClassSet=function(r,b){var S=x._bin,C=b,I=[],A=S.readUshort(r,b);b+=2;for(var R=0;R<A;R++){var B=S.readUshort(r,b);b+=2,I.push(x.GSUB.readChainSubClassRule(r,C+B))}return I},x.GSUB.readChainSubClassRule=function(r,b){for(var S=x._bin,C={},I=["backtrack","input","lookahead"],A=0;A<I.length;A++){var R=S.readUshort(r,b);b+=2,1==A&&R--,C[I[A]]=S.readUshorts(r,b,R),b+=2*C[I[A]].length}return R=S.readUshort(r,b),b+=2,C.subst=S.readUshorts(r,b,2*R),b+=2*C.subst.length,C},x.GSUB.readLigatureSet=function(r,b){var S=x._bin,C=b,I=[],A=S.readUshort(r,b);b+=2;for(var R=0;R<A;R++){var B=S.readUshort(r,b);b+=2,I.push(x.GSUB.readLigature(r,C+B))}return I},x.GSUB.readLigature=function(r,b){var S=x._bin,C={chain:[]};C.nglyph=S.readUshort(r,b),b+=2;var I=S.readUshort(r,b);b+=2;for(var A=0;A<I-1;A++)C.chain.push(S.readUshort(r,b)),b+=2;return C},x.head={},x.head.parse=function(r,b,S){var C=x._bin,I={};return C.readFixed(r,b),b+=4,I.fontRevision=C.readFixed(r,b),b+=4,C.readUint(r,b),b+=4,C.readUint(r,b),b+=4,I.flags=C.readUshort(r,b),b+=2,I.unitsPerEm=C.readUshort(r,b),b+=2,I.created=C.readUint64(r,b),b+=8,I.modified=C.readUint64(r,b),b+=8,I.xMin=C.readShort(r,b),b+=2,I.yMin=C.readShort(r,b),b+=2,I.xMax=C.readShort(r,b),b+=2,I.yMax=C.readShort(r,b),b+=2,I.macStyle=C.readUshort(r,b),b+=2,I.lowestRecPPEM=C.readUshort(r,b),b+=2,I.fontDirectionHint=C.readShort(r,b),b+=2,I.indexToLocFormat=C.readShort(r,b),b+=2,I.glyphDataFormat=C.readShort(r,b),b+=2,I},x.hhea={},x.hhea.parse=function(r,b,S){var C=x._bin,I={};return C.readFixed(r,b),b+=4,I.ascender=C.readShort(r,b),b+=2,I.descender=C.readShort(r,b),b+=2,I.lineGap=C.readShort(r,b),b+=2,I.advanceWidthMax=C.readUshort(r,b),b+=2,I.minLeftSideBearing=C.readShort(r,b),b+=2,I.minRightSideBearing=C.readShort(r,b),b+=2,I.xMaxExtent=C.readShort(r,b),b+=2,I.caretSlopeRise=C.readShort(r,b),b+=2,I.caretSlopeRun=C.readShort(r,b),b+=2,I.caretOffset=C.readShort(r,b),b+=2,b+=8,I.metricDataFormat=C.readShort(r,b),b+=2,I.numberOfHMetrics=C.readUshort(r,b),b+=2,I},x.hmtx={},x.hmtx.parse=function(r,b,S,C){for(var I=x._bin,A={aWidth:[],lsBearing:[]},R=0,B=0,D=0;D<C.maxp.numGlyphs;D++)D<C.hhea.numberOfHMetrics&&(R=I.readUshort(r,b),b+=2,B=I.readShort(r,b),b+=2),A.aWidth.push(R),A.lsBearing.push(B);return A},x.kern={},x.kern.parse=function(r,b,S,C){var I=x._bin,A=I.readUshort(r,b);if(b+=2,1==A)return x.kern.parseV1(r,b-2,S,C);var R=I.readUshort(r,b);b+=2;for(var B={glyph1:[],rval:[]},D=0;D<R;D++){b+=2,S=I.readUshort(r,b),b+=2;var F=I.readUshort(r,b);b+=2;var G=F>>>8;if(0!=(G&=15))throw"unknown kern table format: "+G;b=x.kern.readFormat0(r,b,B)}return B},x.kern.parseV1=function(r,b,S,C){var I=x._bin;I.readFixed(r,b),b+=4;var A=I.readUint(r,b);b+=4;for(var R={glyph1:[],rval:[]},B=0;B<A;B++){I.readUint(r,b),b+=4;var D=I.readUshort(r,b);b+=2,I.readUshort(r,b),b+=2;var F=D>>>8;if(0!=(F&=15))throw"unknown kern table format: "+F;b=x.kern.readFormat0(r,b,R)}return R},x.kern.readFormat0=function(r,b,S){var C=x._bin,I=-1,A=C.readUshort(r,b);b+=2,C.readUshort(r,b),b+=2,C.readUshort(r,b),b+=2,C.readUshort(r,b),b+=2;for(var R=0;R<A;R++){var B=C.readUshort(r,b);b+=2;var D=C.readUshort(r,b);b+=2;var F=C.readShort(r,b);b+=2,B!=I&&(S.glyph1.push(B),S.rval.push({glyph2:[],vals:[]}));var G=S.rval[S.rval.length-1];G.glyph2.push(D),G.vals.push(F),I=B}return b},x.loca={},x.loca.parse=function(r,b,S,C){var I=x._bin,A=[],R=C.head.indexToLocFormat,B=C.maxp.numGlyphs+1;if(0==R)for(var D=0;D<B;D++)A.push(I.readUshort(r,b+(D<<1))<<1);if(1==R)for(D=0;D<B;D++)A.push(I.readUint(r,b+(D<<2)));return A},x.maxp={},x.maxp.parse=function(r,b,S){var C=x._bin,I={},A=C.readUint(r,b);return b+=4,I.numGlyphs=C.readUshort(r,b),b+=2,65536==A&&(I.maxPoints=C.readUshort(r,b),b+=2,I.maxContours=C.readUshort(r,b),b+=2,I.maxCompositePoints=C.readUshort(r,b),b+=2,I.maxCompositeContours=C.readUshort(r,b),b+=2,I.maxZones=C.readUshort(r,b),b+=2,I.maxTwilightPoints=C.readUshort(r,b),b+=2,I.maxStorage=C.readUshort(r,b),b+=2,I.maxFunctionDefs=C.readUshort(r,b),b+=2,I.maxInstructionDefs=C.readUshort(r,b),b+=2,I.maxStackElements=C.readUshort(r,b),b+=2,I.maxSizeOfInstructions=C.readUshort(r,b),b+=2,I.maxComponentElements=C.readUshort(r,b),b+=2,I.maxComponentDepth=C.readUshort(r,b),b+=2),I},x.name={},x.name.parse=function(r,b,S){var C=x._bin,I={};C.readUshort(r,b),b+=2;var A=C.readUshort(r,b);b+=2,C.readUshort(r,b);for(var R,B=["copyright","fontFamily","fontSubfamily","ID","fullName","version","postScriptName","trademark","manufacturer","designer","description","urlVendor","urlDesigner","licence","licenceURL","---","typoFamilyName","typoSubfamilyName","compatibleFull","sampleText","postScriptCID","wwsFamilyName","wwsSubfamilyName","lightPalette","darkPalette"],D=b+=2,F=0;F<A;F++){var G=C.readUshort(r,b);b+=2;var N=C.readUshort(r,b);b+=2;var H=C.readUshort(r,b);b+=2;var W=C.readUshort(r,b);b+=2;var j=C.readUshort(r,b);b+=2;var V=C.readUshort(r,b);b+=2;var X,q=B[W],$=D+12*A+V;if(0==G)X=C.readUnicode(r,$,j/2);else if(3==G&&0==N)X=C.readUnicode(r,$,j/2);else if(0==N)X=C.readASCII(r,$,j);else if(1==N)X=C.readUnicode(r,$,j/2);else if(3==N)X=C.readUnicode(r,$,j/2);else{if(1!=G)throw"unknown encoding "+N+", platformID: "+G;X=C.readASCII(r,$,j),console.debug("reading unknown MAC encoding "+N+" as ASCII")}var K="p"+G+","+H.toString(16);null==I[K]&&(I[K]={}),I[K][void 0!==q?q:W]=X,I[K]._lang=H}for(var Y in I)if(null!=I[Y].postScriptName&&1033==I[Y]._lang)return I[Y];for(var Y in I)if(null!=I[Y].postScriptName&&0==I[Y]._lang)return I[Y];for(var Y in I)if(null!=I[Y].postScriptName&&3084==I[Y]._lang)return I[Y];for(var Y in I)if(null!=I[Y].postScriptName)return I[Y];for(var Y in I){R=Y;break}return console.debug("returning name table with languageID "+I[R]._lang),I[R]},x["OS/2"]={},x["OS/2"].parse=function(r,b,S){var C=x._bin.readUshort(r,b);b+=2;var I={};if(0==C)x["OS/2"].version0(r,b,I);else if(1==C)x["OS/2"].version1(r,b,I);else if(2==C||3==C||4==C)x["OS/2"].version2(r,b,I);else{if(5!=C)throw"unknown OS/2 table version: "+C;x["OS/2"].version5(r,b,I)}return I},x["OS/2"].version0=function(r,b,S){var C=x._bin;return S.xAvgCharWidth=C.readShort(r,b),b+=2,S.usWeightClass=C.readUshort(r,b),b+=2,S.usWidthClass=C.readUshort(r,b),b+=2,S.fsType=C.readUshort(r,b),b+=2,S.ySubscriptXSize=C.readShort(r,b),b+=2,S.ySubscriptYSize=C.readShort(r,b),b+=2,S.ySubscriptXOffset=C.readShort(r,b),b+=2,S.ySubscriptYOffset=C.readShort(r,b),b+=2,S.ySuperscriptXSize=C.readShort(r,b),b+=2,S.ySuperscriptYSize=C.readShort(r,b),b+=2,S.ySuperscriptXOffset=C.readShort(r,b),b+=2,S.ySuperscriptYOffset=C.readShort(r,b),b+=2,S.yStrikeoutSize=C.readShort(r,b),b+=2,S.yStrikeoutPosition=C.readShort(r,b),b+=2,S.sFamilyClass=C.readShort(r,b),b+=2,S.panose=C.readBytes(r,b,10),b+=10,S.ulUnicodeRange1=C.readUint(r,b),b+=4,S.ulUnicodeRange2=C.readUint(r,b),b+=4,S.ulUnicodeRange3=C.readUint(r,b),b+=4,S.ulUnicodeRange4=C.readUint(r,b),b+=4,S.achVendID=[C.readInt8(r,b),C.readInt8(r,b+1),C.readInt8(r,b+2),C.readInt8(r,b+3)],b+=4,S.fsSelection=C.readUshort(r,b),b+=2,S.usFirstCharIndex=C.readUshort(r,b),b+=2,S.usLastCharIndex=C.readUshort(r,b),b+=2,S.sTypoAscender=C.readShort(r,b),b+=2,S.sTypoDescender=C.readShort(r,b),b+=2,S.sTypoLineGap=C.readShort(r,b),b+=2,S.usWinAscent=C.readUshort(r,b),b+=2,S.usWinDescent=C.readUshort(r,b),b+2},x["OS/2"].version1=function(r,b,S){var C=x._bin;return b=x["OS/2"].version0(r,b,S),S.ulCodePageRange1=C.readUint(r,b),b+=4,S.ulCodePageRange2=C.readUint(r,b),b+4},x["OS/2"].version2=function(r,b,S){var C=x._bin;return b=x["OS/2"].version1(r,b,S),S.sxHeight=C.readShort(r,b),b+=2,S.sCapHeight=C.readShort(r,b),b+=2,S.usDefault=C.readUshort(r,b),b+=2,S.usBreak=C.readUshort(r,b),b+=2,S.usMaxContext=C.readUshort(r,b),b+2},x["OS/2"].version5=function(r,b,S){var C=x._bin;return b=x["OS/2"].version2(r,b,S),S.usLowerOpticalPointSize=C.readUshort(r,b),b+=2,S.usUpperOpticalPointSize=C.readUshort(r,b),b+2},x.post={},x.post.parse=function(r,b,S){var C=x._bin,I={};return I.version=C.readFixed(r,b),b+=4,I.italicAngle=C.readFixed(r,b),b+=4,I.underlinePosition=C.readShort(r,b),b+=2,I.underlineThickness=C.readShort(r,b),b+=2,I},null==x&&(x={}),null==x.U&&(x.U={}),x.U.codeToGlyph=function(r,x){var b=r.cmap,S=-1;if(null!=b.p0e4?S=b.p0e4:null!=b.p3e1?S=b.p3e1:null!=b.p1e0?S=b.p1e0:null!=b.p0e3&&(S=b.p0e3),-1==S)throw"no familiar platform and encoding!";var C=b.tables[S];if(0==C.format)return x>=C.map.length?0:C.map[x];if(4==C.format){for(var I=-1,A=0;A<C.endCount.length;A++)if(x<=C.endCount[A]){I=A;break}return-1==I||C.startCount[I]>x?0:65535&(0!=C.idRangeOffset[I]?C.glyphIdArray[x-C.startCount[I]+(C.idRangeOffset[I]>>1)-(C.idRangeOffset.length-I)]:x+C.idDelta[I])}if(12==C.format){if(x>C.groups[C.groups.length-1][1])return 0;for(A=0;A<C.groups.length;A++){var R=C.groups[A];if(R[0]<=x&&x<=R[1])return R[2]+(x-R[0])}return 0}throw"unknown cmap table format "+C.format},x.U.glyphToPath=function(r,b){var S={cmds:[],crds:[]};if(r.SVG&&r.SVG.entries[b]){var C=r.SVG.entries[b];return null==C?S:("string"==typeof C&&(C=x.SVG.toPath(C),r.SVG.entries[b]=C),C)}if(r.CFF){var I={x:0,y:0,stack:[],nStems:0,haveWidth:!1,width:r.CFF.Private?r.CFF.Private.defaultWidthX:0,open:!1},A=r.CFF,R=r.CFF.Private;if(A.ROS){for(var B=0;A.FDSelect[B+2]<=b;)B+=2;R=A.FDArray[A.FDSelect[B+1]].Private}x.U._drawCFF(r.CFF.CharStrings[b],I,A,R,S)}else r.glyf&&x.U._drawGlyf(b,r,S);return S},x.U._drawGlyf=function(r,b,S){var C=b.glyf[r];null==C&&(C=b.glyf[r]=x.glyf._parseGlyf(b,r)),null!=C&&(C.noc>-1?x.U._simpleGlyph(C,S):x.U._compoGlyph(C,b,S))},x.U._simpleGlyph=function(r,b){for(var S=0;S<r.noc;S++){for(var C=0==S?0:r.endPts[S-1]+1,I=r.endPts[S],A=C;A<=I;A++){var R=A==C?I:A-1,B=A==I?C:A+1,D=1&r.flags[A],F=1&r.flags[R],G=1&r.flags[B],N=r.xs[A],H=r.ys[A];if(A==C)if(D){if(!F){x.U.P.moveTo(b,N,H);continue}x.U.P.moveTo(b,r.xs[R],r.ys[R])}else F?x.U.P.moveTo(b,r.xs[R],r.ys[R]):x.U.P.moveTo(b,(r.xs[R]+N)/2,(r.ys[R]+H)/2);D?F&&x.U.P.lineTo(b,N,H):G?x.U.P.qcurveTo(b,N,H,r.xs[B],r.ys[B]):x.U.P.qcurveTo(b,N,H,(N+r.xs[B])/2,(H+r.ys[B])/2)}x.U.P.closePath(b)}},x.U._compoGlyph=function(r,b,S){for(var C=0;C<r.parts.length;C++){var I={cmds:[],crds:[]},A=r.parts[C];x.U._drawGlyf(A.glyphIndex,b,I);for(var R=A.m,B=0;B<I.crds.length;B+=2){var D=I.crds[B],F=I.crds[B+1];S.crds.push(D*R.a+F*R.b+R.tx),S.crds.push(D*R.c+F*R.d+R.ty)}for(B=0;B<I.cmds.length;B++)S.cmds.push(I.cmds[B])}},x.U._getGlyphClass=function(r,b){var S=x._lctf.getInterval(b,r);return-1==S?0:b[S+2]},x.U._applySubs=function(r,b,S,C){for(var I=r.length-b-1,A=0;A<S.tabs.length;A++)if(null!=S.tabs[A]){var R,B=S.tabs[A];if(!B.coverage||-1!=(R=x._lctf.coverageIndex(B.coverage,r[b])))if(1==S.ltype)r[b],1==B.fmt?r[b]=r[b]+B.delta:r[b]=B.newg[R];else if(4==S.ltype)for(var D=B.vals[R],F=0;F<D.length;F++){var G=D[F],N=G.chain.length;if(!(N>I)){for(var H=!0,W=0,j=0;j<N;j++){for(;-1==r[b+W+(1+j)];)W++;G.chain[j]!=r[b+W+(1+j)]&&(H=!1)}if(H){for(r[b]=G.nglyph,j=0;j<N+W;j++)r[b+j+1]=-1;break}}}else if(5==S.ltype&&2==B.fmt)for(var V=x._lctf.getInterval(B.cDef,r[b]),X=B.cDef[V+2],q=B.scset[X],$=0;$<q.length;$++){var K=q[$],Y=K.input;if(!(Y.length>I)){for(H=!0,j=0;j<Y.length;j++){var Z=x._lctf.getInterval(B.cDef,r[b+1+j]);if(-1==V&&B.cDef[Z+2]!=Y[j]){H=!1;break}}if(H){var J=K.substLookupRecords;for(F=0;F<J.length;F+=2)J[F],J[F+1]}}}else if(6==S.ltype&&3==B.fmt){if(!x.U._glsCovered(r,B.backCvg,b-B.backCvg.length))continue;if(!x.U._glsCovered(r,B.inptCvg,b))continue;if(!x.U._glsCovered(r,B.ahedCvg,b+B.inptCvg.length))continue;var Q=B.lookupRec;for($=0;$<Q.length;$+=2){V=Q[$];var ee=C[Q[$+1]];x.U._applySubs(r,b+V,ee,C)}}}},x.U._glsCovered=function(r,b,S){for(var C=0;C<b.length;C++)if(-1==x._lctf.coverageIndex(b[C],r[S+C]))return!1;return!0},x.U.glyphsToPath=function(r,b,S){for(var C={cmds:[],crds:[]},I=0,A=0;A<b.length;A++){var R=b[A];if(-1!=R){for(var B=A<b.length-1&&-1!=b[A+1]?b[A+1]:0,D=x.U.glyphToPath(r,R),F=0;F<D.crds.length;F+=2)C.crds.push(D.crds[F]+I),C.crds.push(D.crds[F+1]);for(S&&C.cmds.push(S),F=0;F<D.cmds.length;F++)C.cmds.push(D.cmds[F]);S&&C.cmds.push("X"),I+=r.hmtx.aWidth[R],A<b.length-1&&(I+=x.U.getPairAdjustment(r,R,B))}}return C},x.U.P={},x.U.P.moveTo=function(r,x,b){r.cmds.push("M"),r.crds.push(x,b)},x.U.P.lineTo=function(r,x,b){r.cmds.push("L"),r.crds.push(x,b)},x.U.P.curveTo=function(r,x,b,S,C,I,A){r.cmds.push("C"),r.crds.push(x,b,S,C,I,A)},x.U.P.qcurveTo=function(r,x,b,S,C){r.cmds.push("Q"),r.crds.push(x,b,S,C)},x.U.P.closePath=function(r){r.cmds.push("Z")},x.U._drawCFF=function(r,b,S,C,I){for(var A=b.stack,R=b.nStems,B=b.haveWidth,D=b.width,F=b.open,G=0,N=b.x,H=b.y,W=0,j=0,V=0,X=0,q=0,$=0,K=0,Y=0,Z=0,J=0,Q={val:0,size:0};G<r.length;){x.CFF.getCharString(r,G,Q);var ee=Q.val;if(G+=Q.size,"o1"==ee||"o18"==ee)A.length%2!=0&&!B&&(D=A.shift()+C.nominalWidthX),R+=A.length>>1,A.length=0,B=!0;else if("o3"==ee||"o23"==ee)A.length%2!=0&&!B&&(D=A.shift()+C.nominalWidthX),R+=A.length>>1,A.length=0,B=!0;else if("o4"==ee)A.length>1&&!B&&(D=A.shift()+C.nominalWidthX,B=!0),F&&x.U.P.closePath(I),H+=A.pop(),x.U.P.moveTo(I,N,H),F=!0;else if("o5"==ee)for(;A.length>0;)N+=A.shift(),H+=A.shift(),x.U.P.lineTo(I,N,H);else if("o6"==ee||"o7"==ee)for(var te=A.length,ne="o6"==ee,re=0;re<te;re++){var ie=A.shift();ne?N+=ie:H+=ie,ne=!ne,x.U.P.lineTo(I,N,H)}else if("o8"==ee||"o24"==ee){te=A.length;for(var se=0;se+6<=te;)W=N+A.shift(),j=H+A.shift(),V=W+A.shift(),X=j+A.shift(),N=V+A.shift(),H=X+A.shift(),x.U.P.curveTo(I,W,j,V,X,N,H),se+=6;"o24"==ee&&(N+=A.shift(),H+=A.shift(),x.U.P.lineTo(I,N,H))}else{if("o11"==ee)break;if("o1234"==ee||"o1235"==ee||"o1236"==ee||"o1237"==ee)"o1234"==ee&&(j=H,V=(W=N+A.shift())+A.shift(),J=X=j+A.shift(),$=X,Y=H,N=(K=(q=(Z=V+A.shift())+A.shift())+A.shift())+A.shift(),x.U.P.curveTo(I,W,j,V,X,Z,J),x.U.P.curveTo(I,q,$,K,Y,N,H)),"o1235"==ee&&(W=N+A.shift(),j=H+A.shift(),V=W+A.shift(),X=j+A.shift(),Z=V+A.shift(),J=X+A.shift(),q=Z+A.shift(),$=J+A.shift(),K=q+A.shift(),Y=$+A.shift(),N=K+A.shift(),H=Y+A.shift(),A.shift(),x.U.P.curveTo(I,W,j,V,X,Z,J),x.U.P.curveTo(I,q,$,K,Y,N,H)),"o1236"==ee&&(W=N+A.shift(),j=H+A.shift(),V=W+A.shift(),J=X=j+A.shift(),$=X,K=(q=(Z=V+A.shift())+A.shift())+A.shift(),Y=$+A.shift(),N=K+A.shift(),x.U.P.curveTo(I,W,j,V,X,Z,J),x.U.P.curveTo(I,q,$,K,Y,N,H)),"o1237"==ee&&(W=N+A.shift(),j=H+A.shift(),V=W+A.shift(),X=j+A.shift(),Z=V+A.shift(),J=X+A.shift(),q=Z+A.shift(),$=J+A.shift(),K=q+A.shift(),Y=$+A.shift(),Math.abs(K-N)>Math.abs(Y-H)?N=K+A.shift():H=Y+A.shift(),x.U.P.curveTo(I,W,j,V,X,Z,J),x.U.P.curveTo(I,q,$,K,Y,N,H));else if("o14"==ee){if(A.length>0&&!B&&(D=A.shift()+S.nominalWidthX,B=!0),4==A.length){var oe=A.shift(),ae=A.shift(),le=A.shift(),ce=A.shift(),he=x.CFF.glyphBySE(S,le),de=x.CFF.glyphBySE(S,ce);x.U._drawCFF(S.CharStrings[he],b,S,C,I),b.x=oe,b.y=ae,x.U._drawCFF(S.CharStrings[de],b,S,C,I)}F&&(x.U.P.closePath(I),F=!1)}else if("o19"==ee||"o20"==ee)A.length%2!=0&&!B&&(D=A.shift()+C.nominalWidthX),R+=A.length>>1,A.length=0,B=!0,G+=R+7>>3;else if("o21"==ee)A.length>2&&!B&&(D=A.shift()+C.nominalWidthX,B=!0),H+=A.pop(),N+=A.pop(),F&&x.U.P.closePath(I),x.U.P.moveTo(I,N,H),F=!0;else if("o22"==ee)A.length>1&&!B&&(D=A.shift()+C.nominalWidthX,B=!0),N+=A.pop(),F&&x.U.P.closePath(I),x.U.P.moveTo(I,N,H),F=!0;else if("o25"==ee){for(;A.length>6;)N+=A.shift(),H+=A.shift(),x.U.P.lineTo(I,N,H);W=N+A.shift(),j=H+A.shift(),V=W+A.shift(),X=j+A.shift(),N=V+A.shift(),H=X+A.shift(),x.U.P.curveTo(I,W,j,V,X,N,H)}else if("o26"==ee)for(A.length%2&&(N+=A.shift());A.length>0;)W=N,j=H+A.shift(),N=V=W+A.shift(),H=(X=j+A.shift())+A.shift(),x.U.P.curveTo(I,W,j,V,X,N,H);else if("o27"==ee)for(A.length%2&&(H+=A.shift());A.length>0;)j=H,V=(W=N+A.shift())+A.shift(),X=j+A.shift(),N=V+A.shift(),H=X,x.U.P.curveTo(I,W,j,V,X,N,H);else if("o10"==ee||"o29"==ee){var ue="o10"==ee?C:S;if(0==A.length)console.debug("error: empty stack");else{var pe=A.pop(),fe=ue.Subrs[pe+ue.Bias];b.x=N,b.y=H,b.nStems=R,b.haveWidth=B,b.width=D,b.open=F,x.U._drawCFF(fe,b,S,C,I),N=b.x,H=b.y,R=b.nStems,B=b.haveWidth,D=b.width,F=b.open}}else if("o30"==ee||"o31"==ee){var ge=A.length,me=(se=0,"o31"==ee);for(se+=ge-(te=-3&ge);se<te;)me?(j=H,V=(W=N+A.shift())+A.shift(),H=(X=j+A.shift())+A.shift(),te-se==5?(N=V+A.shift(),se++):N=V,me=!1):(W=N,j=H+A.shift(),V=W+A.shift(),X=j+A.shift(),N=V+A.shift(),te-se==5?(H=X+A.shift(),se++):H=X,me=!0),x.U.P.curveTo(I,W,j,V,X,N,H),se+=4}else{if("o"==(ee+"").charAt(0))throw console.debug("Unknown operation: "+ee,r),ee;A.push(ee)}}}b.x=N,b.y=H,b.nStems=R,b.haveWidth=B,b.width=D,b.open=F};var b=x,S={Typr:b};return r.Typr=b,r.default=S,Object.defineProperty(r,"__esModule",{value:!0}),r}({}).Typr}
/*!
Custom bundle of woff2otf (https://github.com/arty-name/woff2otf) with fflate
(https://github.com/101arrowz/fflate) for use in Troika text rendering. 
Original licenses apply: 
- fflate: https://github.com/101arrowz/fflate/blob/master/LICENSE (MIT)
- woff2otf.js: https://github.com/arty-name/woff2otf/blob/master/woff2otf.js (Apache2)
*/,function(){return function(r){var x=Uint8Array,b=Uint16Array,S=Uint32Array,C=new x([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),I=new x([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),A=new x([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),f=function(r,x){for(var C=new b(31),I=0;I<31;++I)C[I]=x+=1<<r[I-1];var A=new S(C[30]);for(I=1;I<30;++I)for(var R=C[I];R<C[I+1];++R)A[R]=R-C[I]<<5|I;return[C,A]},R=f(C,2),B=R[0],D=R[1];B[28]=258,D[258]=28;for(var F=f(I,0)[0],G=new b(32768),N=0;N<32768;++N){var H=(43690&N)>>>1|(21845&N)<<1;H=(61680&(H=(52428&H)>>>2|(13107&H)<<2))>>>4|(3855&H)<<4,G[N]=((65280&H)>>>8|(255&H)<<8)>>>1}var w=function(r,x,S){for(var C=r.length,I=0,A=new b(x);I<C;++I)++A[r[I]-1];var R,B=new b(x);for(I=0;I<x;++I)B[I]=B[I-1]+A[I-1]<<1;R=new b(1<<x);var D=15-x;for(I=0;I<C;++I)if(r[I])for(var F=I<<4|r[I],N=x-r[I],H=B[r[I]-1]++<<N,W=H|(1<<N)-1;H<=W;++H)R[G[H]>>>D]=F;return R},W=new x(288);for(N=0;N<144;++N)W[N]=8;for(N=144;N<256;++N)W[N]=9;for(N=256;N<280;++N)W[N]=7;for(N=280;N<288;++N)W[N]=8;var j=new x(32);for(N=0;N<32;++N)j[N]=5;var V=w(W,9),X=w(j,5),y=function(r){for(var x=r[0],b=1;b<r.length;++b)r[b]>x&&(x=r[b]);return x},L=function(r,x,b){var S=x/8|0;return(r[S]|r[S+1]<<8)>>(7&x)&b},U=function(r,x){var b=x/8|0;return(r[b]|r[b+1]<<8|r[b+2]<<16)>>(7&x)},q=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],T=function(r,x,b){var S=new Error(x||q[r]);if(S.code=r,Error.captureStackTrace&&Error.captureStackTrace(S,T),!b)throw S;return S},O=function(r,R,D){var G=r.length;if(!G||D&&!D.l&&G<5)return R||new x(0);var N=!R||D,H=!D||D.i;D||(D={}),R||(R=new x(3*G));var W,d=function(r){var b=R.length;if(r>b){var S=new x(Math.max(2*b,r));S.set(R),R=S}},j=D.f||0,q=D.p||0,$=D.b||0,K=D.l,Y=D.d,Z=D.m,J=D.n,Q=8*G;do{if(!K){D.f=j=L(r,q,1);var ee=L(r,q+1,3);if(q+=3,!ee){var te=r[(ue=((W=q)/8|0)+(7&W&&1)+4)-4]|r[ue-3]<<8,ne=ue+te;if(ne>G){H&&T(0);break}N&&d($+te),R.set(r.subarray(ue,ne),$),D.b=$+=te,D.p=q=8*ne;continue}if(1==ee)K=V,Y=X,Z=9,J=5;else if(2==ee){var re=L(r,q,31)+257,ie=L(r,q+10,15)+4,se=re+L(r,q+5,31)+1;q+=14;for(var oe=new x(se),ae=new x(19),le=0;le<ie;++le)ae[A[le]]=L(r,q+3*le,7);q+=3*ie;var ce=y(ae),he=(1<<ce)-1,de=w(ae,ce);for(le=0;le<se;){var ue,pe=de[L(r,q,he)];if(q+=15&pe,(ue=pe>>>4)<16)oe[le++]=ue;else{var fe=0,ge=0;for(16==ue?(ge=3+L(r,q,3),q+=2,fe=oe[le-1]):17==ue?(ge=3+L(r,q,7),q+=3):18==ue&&(ge=11+L(r,q,127),q+=7);ge--;)oe[le++]=fe}}var me=oe.subarray(0,re),_e=oe.subarray(re);Z=y(me),J=y(_e),K=w(me,Z),Y=w(_e,J)}else T(1);if(q>Q){H&&T(0);break}}N&&d($+131072);for(var ye=(1<<Z)-1,ve=(1<<J)-1,xe=q;;xe=q){var be=(fe=K[U(r,q)&ye])>>>4;if((q+=15&fe)>Q){H&&T(0);break}if(fe||T(2),be<256)R[$++]=be;else{if(256==be){xe=q,K=null;break}var Te=be-254;if(be>264){var we=C[le=be-257];Te=L(r,q,(1<<we)-1)+B[le],q+=we}var Se=Y[U(r,q)&ve],Ce=Se>>>4;if(Se||T(3),q+=15&Se,_e=F[Ce],Ce>3&&(we=I[Ce],_e+=U(r,q)&(1<<we)-1,q+=we),q>Q){H&&T(0);break}N&&d($+131072);for(var Ie=$+Te;$<Ie;$+=4)R[$]=R[$-_e],R[$+1]=R[$+1-_e],R[$+2]=R[$+2-_e],R[$+3]=R[$+3-_e];$=Ie}}D.l=K,D.p=xe,D.b=$,K&&(j=1,D.m=Z,D.d=Y,D.n=J)}while(!j);return $==R.length?R:function(r,C,I){(null==I||I>r.length)&&(I=r.length);var A=new(r instanceof b?b:r instanceof S?S:x)(I-0);return A.set(r.subarray(0,I)),A}(R,0,$)},$=new x(0),K="undefined"!=typeof TextDecoder&&new TextDecoder;try{K.decode($,{stream:!0})}catch(r){}return r.convert_streams=function(r){var x=new DataView(r),b=0;function t(){var r=x.getUint16(b);return b+=2,r}function a(){var r=x.getUint32(b);return b+=4,r}function i(r){H.setUint16(W,r),W+=2}function o(r){H.setUint32(W,r),W+=4}for(var S={signature:a(),flavor:a(),length:a(),numTables:t(),reserved:t(),totalSfntSize:a(),majorVersion:t(),minorVersion:t(),metaOffset:a(),metaLength:a(),metaOrigLength:a(),privOffset:a(),privLength:a()},C=0;Math.pow(2,C)<=S.numTables;)C++;C--;for(var I=16*Math.pow(2,C),A=16*S.numTables-I,R=12,B=[],D=0;D<S.numTables;D++)B.push({tag:a(),offset:a(),compLength:a(),origLength:a(),origChecksum:a()}),R+=16;var F,G=new Uint8Array(12+16*B.length+B.reduce((function(r,x){return r+x.origLength+4}),0)),N=G.buffer,H=new DataView(N),W=0;return o(S.flavor),i(S.numTables),i(I),i(C),i(A),B.forEach((function(r){o(r.tag),o(r.origChecksum),o(R),o(r.origLength),r.outOffset=R,(R+=r.origLength)%4!=0&&(R+=4-R%4)})),B.forEach((function(x){var b,S=r.slice(x.offset,x.offset+x.compLength);if(x.compLength!=x.origLength){var C=new Uint8Array(x.origLength);b=new Uint8Array(S,2),O(b,C)}else C=new Uint8Array(S);G.set(C,x.outOffset);var I=0;(R=x.outOffset+x.origLength)%4!=0&&(I=4-R%4),G.set(new Uint8Array(I).buffer,x.outOffset+x.origLength),F=R+I})),N.slice(0,F)},Object.defineProperty(r,"__esModule",{value:!0}),r}({}).convert_streams},function(r,x){const b={M:2,L:2,Q:4,C:6,Z:0},S={C:"18g,ca,368,1kz",D:"17k,6,2,2+4,5+c,2+6,2+1,10+1,9+f,j+11,2+1,a,2,2+1,15+2,3,j+2,6+3,2+8,2,2,2+1,w+a,4+e,3+3,2,3+2,3+5,23+w,2f+4,3,2+9,2,b,2+3,3,1k+9,6+1,3+1,2+2,2+d,30g,p+y,1,1+1g,f+x,2,sd2+1d,jf3+4,f+3,2+4,2+2,b+3,42,2,4+2,2+1,2,3,t+1,9f+w,2,el+2,2+g,d+2,2l,2+1,5,3+1,2+1,2,3,6,16wm+1v",R:"17m+3,2,2,6+3,m,15+2,2+2,h+h,13,3+8,2,2,3+1,2,p+1,x,5+4,5,a,2,2,3,u,c+2,g+1,5,2+1,4+1,5j,6+1,2,b,2+2,f,2+1,1s+2,2,3+1,7,1ez0,2,2+1,4+4,b,4,3,b,42,2+2,4,3,2+1,2,o+3,ae,ep,x,2o+2,3+1,3,5+1,6",L:"x9u,jff,a,fd,jv",T:"4t,gj+33,7o+4,1+1,7c+18,2,2+1,2+1,2,21+a,2,1b+k,h,2u+6,3+5,3+1,2+3,y,2,v+q,2k+a,1n+8,a,p+3,2+8,2+2,2+4,18+2,3c+e,2+v,1k,2,5+7,5,4+6,b+1,u,1n,5+3,9,l+1,r,3+1,1m,5+1,5+1,3+2,4,v+1,4,c+1,1m,5+4,2+1,5,l+1,n+5,2,1n,3,2+3,9,8+1,c+1,v,1q,d,1f,4,1m+2,6+2,2+3,8+1,c+1,u,1n,3,7,6+1,l+1,t+1,1m+1,5+3,9,l+1,u,21,8+2,2,2j,3+6,d+7,2r,3+8,c+5,23+1,s,2,2,1k+d,2+4,2+1,6+a,2+z,a,2v+3,2+5,2+1,3+1,q+1,5+2,h+3,e,3+1,7,g,jk+2,qb+2,u+2,u+1,v+1,1t+1,2+6,9,3+a,a,1a+2,3c+1,z,3b+2,5+1,a,7+2,64+1,3,1n,2+6,2,2,3+7,7+9,3,1d+d,1,1+1,1s+3,1d,2+4,2,6,15+8,d+1,x+3,3+1,2+2,1l,2+1,4,2+2,1n+7,3+1,49+2,2+c,2+6,5,7,4+1,5j+1l,2+4,ek,3+1,r+4,1e+4,6+5,2p+c,1+3,1,1+2,1+b,2db+2,3y,2p+v,ff+3,30+1,n9x,1+2,2+9,x+1,29+1,7l,4,5,q+1,6,48+1,r+h,e,13+7,q+a,1b+2,1d,3+3,3+1,14,1w+5,3+1,3+1,d,9,1c,1g,2+2,3+1,6+1,2,17+1,9,6n,3,5,fn5,ki+f,h+f,5s,6y+2,ea,6b,46+4,1af+2,2+1,6+3,15+2,5,4m+1,fy+3,as+1,4a+a,4x,1j+e,1l+2,1e+3,3+1,1y+2,11+4,2+7,1r,d+1,1h+8,b+3,3,2o+2,3,2+1,7,4h,4+7,m+1,1m+1,4,12+6,4+4,5g+7,3+2,2,o,2d+5,2,5+1,2+1,6n+3,7+1,2+1,s+1,2e+7,3,2+1,2z,2,3+5,2,2u+2,3+3,2+4,78+8,2+1,75+1,2,5,41+3,3+1,5,x+9,15+5,3+3,9,a+5,3+2,1b+c,2+1,bb+6,2+5,2,2b+l,3+6,2+1,2+1,3f+5,4,2+1,2+6,2,21+1,4,2,9o+1,470+8,at4+4,1o+6,t5,1s+3,2a,f5l+1,2+3,43o+2,a+7,1+7,3+6,v+3,45+2,1j0+1i,5+1d,9,f,n+4,2+e,11t+6,2+g,3+6,2+1,2+4,7a+6,c6+3,15t+6,32+6,1,gzau,v+2n,3l+6n"},C=1,I=2,A=4,R=8,B=16,D=32;let F;function getCharJoiningType(r){if(!F){const r={R:I,L:C,D:A,C:B,U:D,T:R};F=new Map;for(let x in S){let b=0;S[x].split(",").forEach((S=>{let[C,I]=S.split("+");C=parseInt(C,36),I=I?parseInt(I,36):0,F.set(b+=C,r[x]);for(let S=I;S--;)F.set(++b,r[x])}))}}return F.get(r)||D}const G=1,N=2,H=3,W=4,j=[null,"isol","init","fina","medi"];function detectJoiningForms(r){const x=new Uint8Array(r.length);let b=D,S=G,F=-1;for(let j=0;j<r.length;j++){const V=r.codePointAt(j);let X=0|getCharJoiningType(V),q=G;X&R||(b&(C|A|B)?X&(I|A|B)?(q=H,S!==G&&S!==H||x[F]++):X&(C|D)&&(S!==N&&S!==W||x[F]--):b&(I|D)&&(S!==N&&S!==W||x[F]--),S=x[j]=q,b=X,F=j,V>65535&&j++)}return x}function getGlyphClass(x,b){const S=x.GDEF&&x.GDEF.glyphClassDef;return S?r.U._getGlyphClass(b,S):0}function firstNum(...r){for(let x=0;x<r.length;x++)if("number"==typeof r[x])return r[x]}function wrapFontObj(x){const S=Object.create(null),C=x["OS/2"],I=x.hhea,A=x.head.unitsPerEm,R=firstNum(C&&C.sTypoAscender,I&&I.ascender,A),B={unitsPerEm:A,ascender:R,descender:firstNum(C&&C.sTypoDescender,I&&I.descender,0),capHeight:firstNum(C&&C.sCapHeight,R),xHeight:firstNum(C&&C.sxHeight,R),lineGap:firstNum(C&&C.sTypoLineGap,I&&I.lineGap),supportsCodePoint:b=>r.U.codeToGlyph(x,b)>0,forEachGlyph(C,I,A,R){let D=0;const F=1/B.unitsPerEm*I,G=function(x,b){const S=[];for(let C=0;C<b.length;C++){const I=b.codePointAt(C);I>65535&&C++,S.push(r.U.codeToGlyph(x,I))}const C=x.GSUB;if(C){const{lookupList:x,featureList:I}=C;let A;const R=/^(rlig|liga|mset|isol|init|fina|medi|half|pres|blws|ccmp)$/,B=[];I.forEach((C=>{if(R.test(C.tag))for(let I=0;I<C.tab.length;I++){if(B[C.tab[I]])continue;B[C.tab[I]]=!0;const R=x[C.tab[I]],D=/^(isol|init|fina|medi)$/.test(C.tag);D&&!A&&(A=detectJoiningForms(b));for(let b=0;b<S.length;b++)A&&D&&j[A[b]]!==C.tag||r.U._applySubs(S,b,R,x)}}))}return S}(x,C);let N=0;const H=function(x,b){const S=new Int16Array(3*b.length);let C=0;for(;C<b.length;C++){const I=b[C];if(-1===I)continue;S[3*C+2]=x.hmtx.aWidth[I];const A=x.GPOS;if(A){const R=A.lookupList;for(let A=0;A<R.length;A++){const B=R[A];for(let A=0;A<B.tabs.length;A++){const R=B.tabs[A];if(1===B.ltype){if(-1!==r._lctf.coverageIndex(R.coverage,I)&&R.pos){applyValueRecord(R.pos,C);break}}else if(2===B.ltype){let x=null,S=getPrevGlyphIndex();if(-1!==S){const A=r._lctf.coverageIndex(R.coverage,b[S]);if(-1!==A){if(1===R.fmt){const r=R.pairsets[A];for(let b=0;b<r.length;b++)r[b].gid2===I&&(x=r[b])}else if(2===R.fmt){const C=r.U._getGlyphClass(b[S],R.classDef1),A=r.U._getGlyphClass(I,R.classDef2);x=R.matrix[C][A]}if(x){x.val1&&applyValueRecord(x.val1,S),x.val2&&applyValueRecord(x.val2,C);break}}}}else if(4===B.ltype){const x=r._lctf.coverageIndex(R.markCoverage,I);if(-1!==x){const I=getPrevGlyphIndex(isBaseGlyph),A=-1===I?-1:r._lctf.coverageIndex(R.baseCoverage,b[I]);if(-1!==A){const r=R.markArray[x],b=R.baseArray[A][r.markClass];S[3*C]=b.x-r.x+S[3*I]-S[3*I+2],S[3*C+1]=b.y-r.y+S[3*I+1];break}}}else if(6===B.ltype){const A=r._lctf.coverageIndex(R.mark1Coverage,I);if(-1!==A){const I=getPrevGlyphIndex();if(-1!==I){const B=b[I];if(3===getGlyphClass(x,B)){const x=r._lctf.coverageIndex(R.mark2Coverage,B);if(-1!==x){const r=R.mark1Array[A],b=R.mark2Array[x][r.markClass];S[3*C]=b.x-r.x+S[3*I]-S[3*I+2],S[3*C+1]=b.y-r.y+S[3*I+1];break}}}}}}}}else if(x.kern&&!x.cff){const r=getPrevGlyphIndex();if(-1!==r){const C=x.kern.glyph1.indexOf(b[r]);if(-1!==C){const b=x.kern.rval[C].glyph2.indexOf(I);-1!==b&&(S[3*r+2]+=x.kern.rval[C].vals[b])}}}}return S;function getPrevGlyphIndex(r){for(let x=C-1;x>=0;x--)if(-1!==b[x]&&(!r||r(b[x])))return x;return-1}function isBaseGlyph(r){return 1===getGlyphClass(x,r)}function applyValueRecord(r,x){for(let b=0;b<3;b++)S[3*x+b]+=r[b]||0}}(x,G);return G.forEach(((B,G)=>{if(-1!==B){let C=S[B];if(!C){const{cmds:I,crds:A}=r.U.glyphToPath(x,B);let R,D,F,G,N="",H=0;for(let r=0,x=I.length;r<x;r++){const x=b[I[r]];N+=I[r];for(let r=1;r<=x;r++)N+=(r>1?",":"")+A[H++]}if(A.length){R=D=1/0,F=G=-1/0;for(let r=0,x=A.length;r<x;r+=2){let x=A[r],b=A[r+1];x<R&&(R=x),b<D&&(D=b),x>F&&(F=x),b>G&&(G=b)}}else R=F=D=G=0;C=S[B]={index:B,advanceWidth:x.hmtx.aWidth[B],xMin:R,yMin:D,xMax:F,yMax:G,path:N}}R.call(null,C,D+H[3*G]*F,H[3*G+1]*F,N),D+=H[3*G+2]*F,A&&(D+=A*I)}N+=C.codePointAt(N)>65535?2:1})),D}};return B}return function(b){const S=new Uint8Array(b,0,4),C=r._bin.readASCII(S,0,4);if("wOFF"===C)b=x(b);else if("wOF2"===C)throw new Error("woff2 fonts not supported");return wrapFontObj(r.parse(b)[0])}}],init:(r,x,b)=>b(r(),x())});
/*!
Custom bundle of @unicode-font-resolver/client v1.0.2 (https://github.com/lojjic/unicode-font-resolver)
for use in Troika text rendering. 
Original MIT license applies
*/const zi=defineWorkerModule({name:"FontResolver",dependencies:[function(r,x){const b=Object.create(null),S=Object.create(null);function loadFont(x,C){let I=b[x];I?C(I):S[x]?S[x].push(C):(S[x]=[C],function(x,b){const onError=r=>{console.error(`Failure loading font ${x}`,r)};try{const S=new XMLHttpRequest;S.open("get",x,!0),S.responseType="arraybuffer",S.onload=function(){if(S.status>=400)onError(new Error(S.statusText));else if(S.status>0)try{const C=r(S.response);C.src=x,b(C)}catch(r){onError(r)}},S.onerror=onError,S.send()}catch(r){onError(r)}}(x,(r=>{r.src=x,b[x]=r,S[x].forEach((x=>x(r))),delete S[x]})))}return function(r,S,{lang:C,fonts:I=[],style:A="normal",weight:R="normal",unicodeFontsURL:B}={}){const D=new Uint8Array(r.length),F=[];r.length||allDone();const G=new Map,N=[];if("italic"!==A&&(A="normal"),"number"!=typeof R&&(R="bold"===R?700:400),I&&!Array.isArray(I)&&(I=[I]),(I=I.slice().filter((r=>!r.lang||r.lang.test(C))).reverse()).length){const x=1,S=2;let C=0;!function resolveUserFonts(A=0){for(let R=A,B=r.length;R<B;R++){const A=r.codePointAt(R);if(C===x&&F[D[R-1]].supportsCodePoint(A)||R>0&&/\s/.test(r[R]))D[R]=D[R-1],C===S&&(N[N.length-1][1]=R);else for(let r=D[R],B=I.length;r<=B;r++)if(r===B){(C===S?N[N.length-1]:N[N.length]=[R,R])[1]=R,C=S}else{D[R]=r;const{src:S,unicodeRange:B}=I[r];if(!B||isCodeInRanges(A,B)){const r=b[S];if(!r)return void loadFont(S,(()=>{resolveUserFonts(R)}));if(r.supportsCodePoint(A)){let b=G.get(r);"number"!=typeof b&&(b=F.length,F.push(r),G.set(r,b)),D[R]=b,C=x;break}}}A>65535&&R+1<B&&(D[R+1]=D[R],R++,C===S&&(N[N.length-1][1]=R))}resolveFallbacks()}()}else N.push([0,r.length-1]),resolveFallbacks();function resolveFallbacks(){if(N.length){const b=N.map((x=>r.substring(x[0],x[1]+1))).join("\n");x.getFontsForString(b,{lang:C||void 0,style:A,weight:R,dataUrl:B}).then((({fontUrls:r,chars:x})=>{const b=F.length;let S=0;N.forEach((r=>{for(let C=0,I=r[1]-r[0];C<=I;C++)D[r[0]+C]=x[S++]+b;S++}));let C=0;r.forEach(((x,S)=>{loadFont(x,(x=>{F[S+b]=x,++C===r.length&&allDone()}))}))}))}else allDone()}function allDone(){S({chars:D,fonts:F})}function isCodeInRanges(r,x){for(let b=0;b<x.length;b++){const[S,C=S]=x[b];if(S<=r&&r<=C)return!0}return!1}}},Wi,function(){return function(r){var n=function(){this.buckets=new Map};n.prototype.add=function(r){var x=r>>5;this.buckets.set(x,(this.buckets.get(x)||0)|1<<(31&r))},n.prototype.has=function(r){var x=this.buckets.get(r>>5);return void 0!==x&&0!=(x&1<<(31&r))},n.prototype.serialize=function(){var r=[];return this.buckets.forEach((function(x,b){r.push((+b).toString(36)+":"+x.toString(36))})),r.join(",")},n.prototype.deserialize=function(r){var x=this;this.buckets.clear(),r.split(",").forEach((function(r){var b=r.split(":");x.buckets.set(parseInt(b[0],36),parseInt(b[1],36))}))};var x=Math.pow(2,8),b=x-1,S=~b;function a(r){var b=function(r){return r&S}(r).toString(16),C=function(r){return(r&S)+x-1}(r).toString(16);return"codepoint-index/plane"+(r>>16)+"/"+b+"-"+C+".json"}function i(r,x){var S=r&b,C=x.codePointAt(S/6|0);return 0!=((C=(C||48)-48)&1<<S%6)}function c(r,x){!function(r,x){var b;(b=r,b.replace(/U\+/gi,"").replace(/^,+|,+$/g,"").split(/,+/).map((function(r){return r.split("-").map((function(r){return parseInt(r.trim(),16)}))}))).forEach((function(r){var b=r[0],S=r[1];void 0===S&&(S=b),x(b,S)}))}(r,(function(r,b){for(var S=r;S<=b;S++)x(S)}))}var C={},I={},A=new WeakMap,R="https://cdn.jsdelivr.net/gh/lojjic/unicode-font-resolver@v1.0.1/packages/data";function d(r){var x=A.get(r);return x||(x=new n,c(r.ranges,(function(r){return x.add(r)})),A.set(r,x)),x}var B,D=new Map;function g(r,x,b){return r[x]?x:r[b]?b:function(r){for(var x in r)return x}(r)}function w(r,x){var b=x;if(!r.includes(b)){b=1/0;for(var S=0;S<r.length;S++)Math.abs(r[S]-x)<Math.abs(b-x)&&(b=r[S])}return b}function k(r){return B||(B=new Set,c("9-D,20,85,A0,1680,2000-200A,2028-202F,205F,3000",(function(r){B.add(r)}))),B.has(r)}return r.CodePointSet=n,r.clearCache=function(){C={},I={}},r.getFontsForString=function(r,x){void 0===x&&(x={});var b,S=x.lang;void 0===S&&(S=/\p{Script=Hangul}/u.test(b=r)?"ko":/\p{Script=Hiragana}|\p{Script=Katakana}/u.test(b)?"ja":"en");var A=x.category;void 0===A&&(A="sans-serif");var B=x.style;void 0===B&&(B="normal");var F=x.weight;void 0===F&&(F=400);var G=(x.dataUrl||R).replace(/\/$/g,""),N=new Map,H=new Uint8Array(r.length),W={},j={},V=new Array(r.length),X=new Map,q=!1;function M(r){var x=D.get(r);return x||(x=fetch(G+"/"+r).then((function(r){if(!r.ok)throw new Error(r.statusText);return r.json().then((function(r){if(!Array.isArray(r)||1!==r[0])throw new Error("Incorrect schema version; need 1, got "+r[0]);return r[1]}))})).catch((function(x){if(G!==R)return q||(console.error('unicode-font-resolver: Failed loading from dataUrl "'+G+'", trying default CDN. '+x.message),q=!0),G=R,D.delete(r),M(r);throw x})),D.set(r,x)),x}for(var P=function(x){var b=r.codePointAt(x),S=a(b);V[x]=S,C[S]||X.has(S)||X.set(S,M(S).then((function(r){C[S]=r}))),b>65535&&(x++,$=x)},$=0;$<r.length;$++)P($);return Promise.all(X.values()).then((function(){X.clear();for(var n=function(b){var A=r.codePointAt(b),R=null,B=C[V[b]],D=void 0;for(var F in B){var G=j[F];if(void 0===G&&(G=j[F]=new RegExp(F).test(S||"en")),G){for(var N in D=F,B[F])if(i(A,B[F][N])){R=N;break}break}}if(!R)e:for(var H in B)if(H!==D)for(var W in B[H])if(i(A,B[H][W])){R=W;break e}R||(console.debug("No font coverage for U+"+A.toString(16)),R="latin"),V[b]=R,I[R]||X.has(R)||X.set(R,M("font-meta/"+R+".json").then((function(r){I[R]=r}))),A>65535&&(b++,x=b)},x=0;x<r.length;x++)n(x);return Promise.all(X.values())})).then((function(){for(var x,b=null,S=0;S<r.length;S++){var C=r.codePointAt(S);if(b&&(k(C)||d(b).has(C)))H[S]=H[S-1];else{b=I[V[S]];var R=W[b.id];if(!R){var D=b.typeforms,j=g(D,A,"sans-serif"),X=g(D[j],B,"normal"),q=w(null===(x=D[j])||void 0===x?void 0:x[X],F);R=W[b.id]=G+"/font-files/"+b.id+"/"+j+"."+X+"."+q+".woff"}var $=N.get(R);null==$&&($=N.size,N.set(R,$)),H[S]=$}C>65535&&(S++,H[S]=H[S-1])}return{fontUrls:Array.from(N.keys()),chars:H}}))},Object.defineProperty(r,"__esModule",{value:!0}),r}({})}],init:(r,x,b)=>r(x,b())});const now=()=>(self.performance||Date).now(),ji=SDFGenerator();let Vi;const Xi=[];let qi=0;function nextChunk(){const r=now();for(;Xi.length&&now()-r<5;)Xi.shift()();qi=Xi.length?setTimeout(nextChunk,0):0}const generateSDF_GL=(...r)=>new Promise(((x,b)=>{Xi.push((()=>{const S=now();try{ji.webgl.generateIntoCanvas(...r),x({timing:now()-S})}catch(r){b(r)}})),qi||(qi=setTimeout(nextChunk,0))})),$i=4,Ki=2e3,Yi={};let Zi=0;function generateSDF_JS_Worker(r,x,b,S,C,I,A,R,B,D){const F="TroikaTextSDFGenerator_JS_"+Zi++%$i;let G=Yi[F];return G||(G=Yi[F]={workerModule:defineWorkerModule({name:F,workerId:F,dependencies:[SDFGenerator,now],init(r,x){const b=r().javascript.generate;return function(...r){const S=x();return{textureData:b(...r),timing:x()-S}}},getTransferables:r=>[r.textureData.buffer]}),requests:0,idleTimer:null}),G.requests++,clearTimeout(G.idleTimer),G.workerModule(r,x,b,S,C,I).then((({textureData:b,timing:S})=>{const C=now(),I=new Uint8Array(4*b.length);for(let r=0;r<b.length;r++)I[4*r+D]=b[r];return ji.webglUtils.renderImageData(A,I,R,B,r,x,1<<3-D),S+=now()-C,0==--G.requests&&(G.idleTimer=setTimeout((()=>{!function(r){Mi[r]&&Mi[r].forEach((function(r){r()})),Ri[r]&&(Ri[r].terminate(),delete Ri[r])}(F)}),Ki)),{timing:S}}))}const Ji=ji.webglUtils.resizeWebGLCanvasWithoutClearing,Qi={defaultFontURL:null,unicodeFontsURL:null,sdfGlyphSize:64,sdfMargin:1/16,sdfExponent:9,textureWidth:2048,useWorker:!0},es=new be;let ts=!1;function now$1(){return(self.performance||Date).now()}const ns=Object.create(null);function getTextRenderInfo(r,x){ts=!0,r=assign({},r);const b=now$1(),{defaultFontURL:S}=Qi,C=[];if(S&&C.push({label:"default",src:toAbsoluteURL(S)}),r.font&&C.push({label:"user",src:toAbsoluteURL(r.font)}),r.font=C,r.text=""+r.text,r.sdfGlyphSize=r.sdfGlyphSize||Qi.sdfGlyphSize,r.unicodeFontsURL=r.unicodeFontsURL||Qi.unicodeFontsURL,null!=r.colorRanges){let x={};for(let b in r.colorRanges)if(r.colorRanges.hasOwnProperty(b)){let S=r.colorRanges[b];"number"!=typeof S&&(S=es.set(S).getHex()),x[b]=S}r.colorRanges=x}Object.freeze(r);const{textureWidth:I,sdfExponent:A}=Qi,{sdfGlyphSize:R}=r,B=I/R*4;let D=ns[R];if(!D){const r=document.createElement("canvas");r.width=I,r.height=256*R/B,D=ns[R]={glyphCount:0,sdfGlyphSize:R,sdfCanvas:r,sdfTexture:new ot(r,void 0,void 0,void 0,Le,Le),contextLost:!1,glyphsByFont:new Map},D.sdfTexture.generateMipmaps=!1,function(r){const x=r.sdfCanvas;x.addEventListener("webglcontextlost",(x=>{console.log("Context Lost",x),x.preventDefault(),r.contextLost=!0})),x.addEventListener("webglcontextrestored",(x=>{console.log("Context Restored",x),r.contextLost=!1;const b=[];r.glyphsByFont.forEach((x=>{x.forEach((x=>{b.push(generateGlyphSDF(x,r,!0))}))})),Promise.all(b).then((()=>{safariPre15Workaround(r),r.sdfTexture.needsUpdate=!0}))}))}(D)}const{sdfTexture:F,sdfCanvas:G}=D;(Qi.useWorker?ss:os)(r).then((S=>{const{glyphIds:C,glyphFontIndices:N,fontData:H,glyphPositions:W,fontSize:j,timings:V}=S,X=[],q=new Float32Array(4*C.length);let $=0,K=0;const Y=now$1(),Z=H.map((r=>{let x=D.glyphsByFont.get(r.src);return x||D.glyphsByFont.set(r.src,x=new Map),x}));C.forEach(((r,x)=>{const b=N[x],{src:I,unitsPerEm:A}=H[b];let B=Z[b].get(r);if(!B){const{path:x,pathBounds:C}=S.glyphData[I][r],A=Math.max(C[2]-C[0],C[3]-C[1])/R*(Qi.sdfMargin*R+.5),F=D.glyphCount++,G=[C[0]-A,C[1]-A,C[2]+A,C[3]+A];Z[b].set(r,B={path:x,atlasIndex:F,sdfViewBox:G}),X.push(B)}const{sdfViewBox:F}=B,G=W[K++],V=W[K++],Y=j/A;q[$++]=G+F[0]*Y,q[$++]=V+F[1]*Y,q[$++]=G+F[2]*Y,q[$++]=V+F[3]*Y,C[x]=B.atlasIndex})),V.quads=(V.quads||0)+(now$1()-Y);const J=now$1();V.sdf={};const Q=G.height,ee=Math.ceil(D.glyphCount/B),te=Math.pow(2,Math.ceil(Math.log2(ee*R)));te>Q&&(console.info(`Increasing SDF texture size ${Q}->${te}`),Ji(G,I,te),F.dispose()),Promise.all(X.map((x=>generateGlyphSDF(x,D,r.gpuAccelerateSDF).then((({timing:r})=>{V.sdf[x.atlasIndex]=r}))))).then((()=>{X.length&&!D.contextLost&&(safariPre15Workaround(D),F.needsUpdate=!0),V.sdfTotal=now$1()-J,V.total=now$1()-b,x(Object.freeze({parameters:r,sdfTexture:F,sdfGlyphSize:R,sdfExponent:A,glyphBounds:q,glyphAtlasIndices:C,glyphColors:S.glyphColors,caretPositions:S.caretPositions,chunkedBounds:S.chunkedBounds,ascender:S.ascender,descender:S.descender,lineHeight:S.lineHeight,capHeight:S.capHeight,xHeight:S.xHeight,topBaseline:S.topBaseline,blockBounds:S.blockBounds,visibleBounds:S.visibleBounds,timings:S.timings}))}))})),Promise.resolve().then((()=>{var r;D.contextLost||(r=G)._warm||(ji.webgl.isSupported(r),r._warm=!0)}))}function generateGlyphSDF({path:r,atlasIndex:x,sdfViewBox:b},{sdfGlyphSize:S,sdfCanvas:C,contextLost:I},A){if(I)return Promise.resolve({timing:-1});const{textureWidth:R,sdfExponent:B}=Qi,D=Math.max(b[2]-b[0],b[3]-b[1]),F=Math.floor(x/4);return function(r,x,b,S,C,I,A,R,B,D,F=!0){return F?generateSDF_GL(r,x,b,S,C,I,A,R,B,D).then(null,(F=>(Vi||(console.warn("WebGL SDF generation failed, falling back to JS",F),Vi=!0),generateSDF_JS_Worker(r,x,b,S,C,I,A,R,B,D)))):generateSDF_JS_Worker(r,x,b,S,C,I,A,R,B,D)}(S,S,r,b,D,B,C,F%(R/S)*S,Math.floor(F/(R/S))*S,x%4,A)}function assign(r,x){for(let b in x)x.hasOwnProperty(b)&&(r[b]=x[b]);return r}let rs;function toAbsoluteURL(r){return rs||(rs="undefined"==typeof document?{}:document.createElement("a")),rs.href=r,rs.href}function safariPre15Workaround(r){if("function"!=typeof createImageBitmap){console.info("Safari<15: applying SDF canvas workaround");const{sdfCanvas:x,sdfTexture:b}=r,{width:S,height:C}=x,I=r.sdfCanvas.getContext("webgl");let A=b.image.data;A&&A.length===S*C*4||(A=new Uint8Array(S*C*4),b.image={width:S,height:C,data:A},b.flipY=!1,b.isDataTexture=!0),I.readPixels(0,0,S,C,I.RGBA,I.UNSIGNED_BYTE,A)}}const is=defineWorkerModule({name:"Typesetter",dependencies:[function(r,x){const b=1/0,S=/[\u00AD\u034F\u061C\u115F-\u1160\u17B4-\u17B5\u180B-\u180E\u200B-\u200F\u202A-\u202E\u2060-\u206F\u3164\uFE00-\uFE0F\uFEFF\uFFA0\uFFF0-\uFFF8]/,C="[^\\S\\u00A0]",I=new RegExp(`${C}|[\\-\\u007C\\u00AD\\u2010\\u2012-\\u2014\\u2027\\u2056\\u2E17\\u2E40]`);function typeset({text:A="",font:R,lang:B,sdfGlyphSize:D=64,fontSize:F=400,fontWeight:G=1,fontStyle:N="normal",letterSpacing:H=0,lineHeight:W="normal",maxWidth:j=b,direction:V,textAlign:X="left",textIndent:q=0,whiteSpace:$="normal",overflowWrap:K="normal",anchorX:Y=0,anchorY:Z=0,metricsOnly:J=!1,unicodeFontsURL:Q,preResolvedFonts:ee=null,includeCaretPositions:te=!1,chunkedBoundsSize:ne=8192,colorRanges:re=null},ie){const se=now(),oe={fontLoad:0,typesetting:0};A.indexOf("\r")>-1&&(console.info("Typesetter: got text with \\r chars; normalizing to \\n"),A=A.replace(/\r\n/g,"\n").replace(/\r/g,"\n")),F=+F,H=+H,j=+j,W=W||"normal",q=+q,function({text:x,lang:b,fonts:S,style:C,weight:I,preResolvedFonts:A,unicodeFontsURL:R},B){const onResolved=({chars:r,fonts:x})=>{let b,S;const C=[];for(let I=0;I<r.length;I++)r[I]!==S?(S=r[I],C.push(b={start:I,end:I,fontObj:x[r[I]]})):b.end=I;B(C)};A?onResolved(A):r(x,onResolved,{lang:b,fonts:S,style:C,weight:I,unicodeFontsURL:R})}({text:A,lang:B,style:N,weight:G,fonts:"string"==typeof R?[{src:R}]:R,unicodeFontsURL:Q,preResolvedFonts:ee},(r=>{oe.fontLoad=now()-se;const R=isFinite(j);let B=null,D=null,G=null,N=null,Q=null,ee=null,ae=null,le=null,ce=0,he=0,de="nowrap"!==$;const ue=new Map,pe=now();let fe=q,ge=0,me=new TextLine;const _e=[me];r.forEach((r=>{const{fontObj:x}=r,{ascender:b,descender:B,unitsPerEm:D,lineGap:G,capHeight:N,xHeight:V}=x;let X=ue.get(x);if(!X){const r=F/D,S="normal"===W?(b-B+G)*r:W*F,C=(S-(b-B)*r)/2,I=Math.min(S,(b-B)*r),A=(b+B)/2*r+I/2;X={index:ue.size,src:x.src,fontObj:x,fontSizeMult:r,unitsPerEm:D,ascender:b*r,descender:B*r,capHeight:N*r,xHeight:V*r,lineHeight:S,baseline:-C-b*r,caretTop:A,caretBottom:A-I},ue.set(x,X)}const{fontSizeMult:$}=X,Y=A.slice(r.start,r.end+1);let Z,J;x.forEachGlyph(Y,F,H,((x,b,B,D)=>{b+=ge,D+=r.start,Z=b,J=x;const G=A.charAt(D),N=x.advanceWidth*$,W=me.count;let V;if("isEmpty"in x||(x.isWhitespace=!!G&&new RegExp(C).test(G),x.canBreakAfter=!!G&&I.test(G),x.isEmpty=x.xMin===x.xMax||x.yMin===x.yMax||S.test(G)),x.isWhitespace||x.isEmpty||he++,de&&R&&!x.isWhitespace&&b+N+fe>j&&W){if(me.glyphAt(W-1).glyphObj.canBreakAfter)V=new TextLine,fe=-b;else for(let r=W;r--;){if(0===r&&"break-word"===K){V=new TextLine,fe=-b;break}if(me.glyphAt(r).glyphObj.canBreakAfter){V=me.splitAt(r+1);const x=V.glyphAt(0).x;fe-=x;for(let r=V.count;r--;)V.glyphAt(r).x-=x;break}}V&&(me.isSoftWrapped=!0,me=V,_e.push(me),ce=j)}let Y=me.glyphAt(me.count);Y.glyphObj=x,Y.x=b+fe,Y.y=B,Y.width=N,Y.charIndex=D,Y.fontData=X,"\n"===G&&(me=new TextLine,_e.push(me),fe=-(b+N+H*F)+q)})),ge=Z+J.advanceWidth*$+H*F}));let ye=0;_e.forEach((r=>{let x=!0;for(let b=r.count;b--;){const S=r.glyphAt(b);x&&!S.glyphObj.isWhitespace&&(r.width=S.x+S.width,r.width>ce&&(ce=r.width),x=!1);let{lineHeight:C,capHeight:I,xHeight:A,baseline:R}=S.fontData;C>r.lineHeight&&(r.lineHeight=C);const B=R-r.baseline;B<0&&(r.baseline+=B,r.cap+=B,r.ex+=B),r.cap=Math.max(r.cap,r.baseline+I),r.ex=Math.max(r.ex,r.baseline+A)}r.baseline-=ye,r.cap-=ye,r.ex-=ye,ye+=r.lineHeight}));let ve=0,xe=0;if(Y&&("number"==typeof Y?ve=-Y:"string"==typeof Y&&(ve=-ce*("left"===Y?0:"center"===Y?.5:"right"===Y?1:parsePercent(Y)))),Z&&("number"==typeof Z?xe=-Z:"string"==typeof Z&&(xe="top"===Z?0:"top-baseline"===Z?-_e[0].baseline:"top-cap"===Z?-_e[0].cap:"top-ex"===Z?-_e[0].ex:"middle"===Z?ye/2:"bottom"===Z?ye:"bottom-baseline"===Z?-_e[_e.length-1].baseline:parsePercent(Z)*ye)),!J){const r=x.getEmbeddingLevels(A,V);B=new Uint16Array(he),D=new Uint8Array(he),G=new Float32Array(2*he),N={},ae=[b,b,-b,-b],le=[],te&&(ee=new Float32Array(4*A.length)),re&&(Q=new Uint8Array(3*he));let S,C,I=0,R=-1,F=-1;if(_e.forEach(((H,W)=>{let{count:j,width:V}=H;if(j>0){let W=0;for(let r=j;r--&&H.glyphAt(r).glyphObj.isWhitespace;)W++;let q=0,$=0;if("center"===X)q=(ce-V)/2;else if("right"===X)q=ce-V;else if("justify"===X&&H.isSoftWrapped){let r=0;for(let x=j-W;x--;)H.glyphAt(x).glyphObj.isWhitespace&&r++;$=(ce-V)/r}if($||q){let r=0;for(let x=0;x<j;x++){let b=H.glyphAt(x);const S=b.glyphObj;b.x+=q+r,0!==$&&S.isWhitespace&&x<j-W&&(r+=$,b.width+=$)}}const K=x.getReorderSegments(A,r,H.glyphAt(0).charIndex,H.glyphAt(H.count-1).charIndex);for(let r=0;r<K.length;r++){const[x,b]=K[r];let S=1/0,C=-1/0;for(let r=0;r<j;r++)if(H.glyphAt(r).charIndex>=x){let x=r,I=r;for(;I<j;I++){let r=H.glyphAt(I);if(r.charIndex>b)break;I<j-W&&(S=Math.min(S,r.x),C=Math.max(C,r.x+r.width))}for(let r=x;r<I;r++){const x=H.glyphAt(r);x.x=C-(x.x+x.width-S)}break}}let Y;const setGlyphObj=r=>Y=r;for(let W=0;W<j;W++){const j=H.glyphAt(W);Y=j.glyphObj;const V=Y.index,X=1&r.levels[j.charIndex];if(X){const r=x.getMirroredCharacter(A[j.charIndex]);r&&j.fontData.fontObj.forEachGlyph(r,0,0,setGlyphObj)}if(te){const{charIndex:r,fontData:x}=j,b=j.x+ve,S=j.x+j.width+ve;ee[4*r]=X?S:b,ee[4*r+1]=X?b:S,ee[4*r+2]=H.baseline+x.caretBottom+xe,ee[4*r+3]=H.baseline+x.caretTop+xe;const C=r-R;C>1&&fillLigatureCaretPositions(ee,R,C),R=r}if(re){const{charIndex:r}=j;for(;r>F;)F++,re.hasOwnProperty(F)&&(C=re[F])}if(!Y.isWhitespace&&!Y.isEmpty){const r=I++,{fontSizeMult:x,src:A,index:R}=j.fontData,F=N[A]||(N[A]={});F[V]||(F[V]={path:Y.path,pathBounds:[Y.xMin,Y.yMin,Y.xMax,Y.yMax]});const W=j.x+ve,X=j.y+H.baseline+xe;G[2*r]=W,G[2*r+1]=X;const q=W+Y.xMin*x,$=X+Y.yMin*x,K=W+Y.xMax*x,Z=X+Y.yMax*x;q<ae[0]&&(ae[0]=q),$<ae[1]&&(ae[1]=$),K>ae[2]&&(ae[2]=K),Z>ae[3]&&(ae[3]=Z),r%ne==0&&(S={start:r,end:r,rect:[b,b,-b,-b]},le.push(S)),S.end++;const J=S.rect;if(q<J[0]&&(J[0]=q),$<J[1]&&(J[1]=$),K>J[2]&&(J[2]=K),Z>J[3]&&(J[3]=Z),B[r]=V,D[r]=R,re){const x=3*r;Q[x]=C>>16&255,Q[x+1]=C>>8&255,Q[x+2]=255&C}}}}})),ee){const r=A.length-R;r>1&&fillLigatureCaretPositions(ee,R,r)}}const be=[];ue.forEach((({index:r,src:x,unitsPerEm:b,ascender:S,descender:C,lineHeight:I,capHeight:A,xHeight:R})=>{be[r]={src:x,unitsPerEm:b,ascender:S,descender:C,lineHeight:I,capHeight:A,xHeight:R}})),oe.typesetting=now()-pe,ie({glyphIds:B,glyphFontIndices:D,glyphPositions:G,glyphData:N,fontData:be,caretPositions:ee,glyphColors:Q,chunkedBounds:le,fontSize:F,topBaseline:xe+_e[0].baseline,blockBounds:[ve,xe-ye,ve+ce,xe],visibleBounds:ae,timings:oe})}))}function parsePercent(r){let x=r.match(/^([\d.]+)%$/),b=x?parseFloat(x[1]):NaN;return isNaN(b)?0:b/100}function fillLigatureCaretPositions(r,x,b){const S=r[4*x],C=r[4*x+1],I=r[4*x+2],A=r[4*x+3],R=(C-S)/b;for(let C=0;C<b;C++){const b=4*(x+C);r[b]=S+R*C,r[b+1]=S+R*(C+1),r[b+2]=I,r[b+3]=A}}function now(){return(self.performance||Date).now()}function TextLine(){this.data=[]}const A=["glyphObj","x","y","width","charIndex","fontData"];return TextLine.prototype={width:0,lineHeight:0,baseline:0,cap:0,ex:0,isSoftWrapped:!1,get count(){return Math.ceil(this.data.length/A.length)},glyphAt(r){let x=TextLine.flyweight;return x.data=this.data,x.index=r,x},splitAt(r){let x=new TextLine;return x.data=this.data.splice(r*A.length),x}},TextLine.flyweight=A.reduce(((r,x,b,S)=>(Object.defineProperty(r,x,{get(){return this.data[this.index*A.length+b]},set(r){this.data[this.index*A.length+b]=r}}),r)),{data:null,index:0}),{typeset:typeset,measure:function(r,x){typeset({...r,metricsOnly:!0},(r=>{const[b,S,C,I]=r.blockBounds;x({width:C-b,height:I-S})}))}}},zi,function(){var r=function(r){var x={R:"13k,1a,2,3,3,2+1j,ch+16,a+1,5+2,2+n,5,a,4,6+16,4+3,h+1b,4mo,179q,2+9,2+11,2i9+7y,2+68,4,3+4,5+13,4+3,2+4k,3+29,8+cf,1t+7z,w+17,3+3m,1t+3z,16o1+5r,8+30,8+mc,29+1r,29+4v,75+73",EN:"1c+9,3d+1,6,187+9,513,4+5,7+9,sf+j,175h+9,qw+q,161f+1d,4xt+a,25i+9",ES:"17,2,6dp+1,f+1,av,16vr,mx+1,4o,2",ET:"z+2,3h+3,b+1,ym,3e+1,2o,p4+1,8,6u,7c,g6,1wc,1n9+4,30+1b,2n,6d,qhx+1,h0m,a+1,49+2,63+1,4+1,6bb+3,12jj",AN:"16o+5,2j+9,2+1,35,ed,1ff2+9,87+u",CS:"18,2+1,b,2u,12k,55v,l,17v0,2,3,53,2+1,b",B:"a,3,f+2,2v,690",S:"9,2,k",WS:"c,k,4f4,1vk+a,u,1j,335",ON:"x+1,4+4,h+5,r+5,r+3,z,5+3,2+1,2+1,5,2+2,3+4,o,w,ci+1,8+d,3+d,6+8,2+g,39+1,9,6+1,2,33,b8,3+1,3c+1,7+1,5r,b,7h+3,sa+5,2,3i+6,jg+3,ur+9,2v,ij+1,9g+9,7+a,8m,4+1,49+x,14u,2+2,c+2,e+2,e+2,e+1,i+n,e+e,2+p,u+2,e+2,36+1,2+3,2+1,b,2+2,6+5,2,2,2,h+1,5+4,6+3,3+f,16+2,5+3l,3+81,1y+p,2+40,q+a,m+13,2r+ch,2+9e,75+hf,3+v,2+2w,6e+5,f+6,75+2a,1a+p,2+2g,d+5x,r+b,6+3,4+o,g,6+1,6+2,2k+1,4,2j,5h+z,1m+1,1e+f,t+2,1f+e,d+3,4o+3,2s+1,w,535+1r,h3l+1i,93+2,2s,b+1,3l+x,2v,4g+3,21+3,kz+1,g5v+1,5a,j+9,n+v,2,3,2+8,2+1,3+2,2,3,46+1,4+4,h+5,r+5,r+a,3h+2,4+6,b+4,78,1r+24,4+c,4,1hb,ey+6,103+j,16j+c,1ux+7,5+g,fsh,jdq+1t,4,57+2e,p1,1m,1m,1m,1m,4kt+1,7j+17,5+2r,d+e,3+e,2+e,2+10,m+4,w,1n+5,1q,4z+5,4b+rb,9+c,4+c,4+37,d+2g,8+b,l+b,5+1j,9+9,7+13,9+t,3+1,27+3c,2+29,2+3q,d+d,3+4,4+2,6+6,a+o,8+6,a+2,e+6,16+42,2+1i",BN:"0+8,6+d,2s+5,2+p,e,4m9,1kt+2,2b+5,5+5,17q9+v,7k,6p+8,6+1,119d+3,440+7,96s+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+75,6p+2rz,1ben+1,1ekf+1,1ekf+1",NSM:"lc+33,7o+6,7c+18,2,2+1,2+1,2,21+a,1d+k,h,2u+6,3+5,3+1,2+3,10,v+q,2k+a,1n+8,a,p+3,2+8,2+2,2+4,18+2,3c+e,2+v,1k,2,5+7,5,4+6,b+1,u,1n,5+3,9,l+1,r,3+1,1m,5+1,5+1,3+2,4,v+1,4,c+1,1m,5+4,2+1,5,l+1,n+5,2,1n,3,2+3,9,8+1,c+1,v,1q,d,1f,4,1m+2,6+2,2+3,8+1,c+1,u,1n,g+1,l+1,t+1,1m+1,5+3,9,l+1,u,21,8+2,2,2j,3+6,d+7,2r,3+8,c+5,23+1,s,2,2,1k+d,2+4,2+1,6+a,2+z,a,2v+3,2+5,2+1,3+1,q+1,5+2,h+3,e,3+1,7,g,jk+2,qb+2,u+2,u+1,v+1,1t+1,2+6,9,3+a,a,1a+2,3c+1,z,3b+2,5+1,a,7+2,64+1,3,1n,2+6,2,2,3+7,7+9,3,1d+g,1s+3,1d,2+4,2,6,15+8,d+1,x+3,3+1,2+2,1l,2+1,4,2+2,1n+7,3+1,49+2,2+c,2+6,5,7,4+1,5j+1l,2+4,k1+w,2db+2,3y,2p+v,ff+3,30+1,n9x+3,2+9,x+1,29+1,7l,4,5,q+1,6,48+1,r+h,e,13+7,q+a,1b+2,1d,3+3,3+1,14,1w+5,3+1,3+1,d,9,1c,1g,2+2,3+1,6+1,2,17+1,9,6n,3,5,fn5,ki+f,h+f,r2,6b,46+4,1af+2,2+1,6+3,15+2,5,4m+1,fy+3,as+1,4a+a,4x,1j+e,1l+2,1e+3,3+1,1y+2,11+4,2+7,1r,d+1,1h+8,b+3,3,2o+2,3,2+1,7,4h,4+7,m+1,1m+1,4,12+6,4+4,5g+7,3+2,2,o,2d+5,2,5+1,2+1,6n+3,7+1,2+1,s+1,2e+7,3,2+1,2z,2,3+5,2,2u+2,3+3,2+4,78+8,2+1,75+1,2,5,41+3,3+1,5,x+5,3+1,15+5,3+3,9,a+5,3+2,1b+c,2+1,bb+6,2+5,2d+l,3+6,2+1,2+1,3f+5,4,2+1,2+6,2,21+1,4,2,9o+1,f0c+4,1o+6,t5,1s+3,2a,f5l+1,43t+2,i+7,3+6,v+3,45+2,1j0+1i,5+1d,9,f,n+4,2+e,11t+6,2+g,3+6,2+1,2+4,7a+6,c6+3,15t+6,32+6,gzhy+6n",AL:"16w,3,2,e+1b,z+2,2+2s,g+1,8+1,b+m,2+t,s+2i,c+e,4h+f,1d+1e,1bwe+dp,3+3z,x+c,2+1,35+3y,2rm+z,5+7,b+5,dt+l,c+u,17nl+27,1t+27,4x+6n,3+d",LRO:"6ct",RLO:"6cu",LRE:"6cq",RLE:"6cr",PDF:"6cs",LRI:"6ee",RLI:"6ef",FSI:"6eg",PDI:"6eh"},b={},S={};b.L=1,S[1]="L",Object.keys(x).forEach((function(r,x){b[r]=1<<x+1,S[b[r]]=r})),Object.freeze(b);var C=b.LRI|b.RLI|b.FSI,I=b.L|b.R|b.AL,A=b.B|b.S|b.WS|b.ON|b.FSI|b.LRI|b.RLI|b.PDI,R=b.BN|b.RLE|b.LRE|b.RLO|b.LRO|b.PDF,B=b.S|b.WS|b.B|C|b.PDI|R,D=null;function getBidiCharType(r){return function(){if(!D){D=new Map;var loop=function(r){if(x.hasOwnProperty(r)){var S=0;x[r].split(",").forEach((function(x){var C=x.split("+"),I=C[0],A=C[1];I=parseInt(I,36),A=A?parseInt(A,36):0,D.set(S+=I,b[r]);for(var R=0;R<A;R++)D.set(++S,b[r])}))}};for(var r in x)loop(r)}}(),D.get(r.codePointAt(0))||b.L}var F,G,N,H={pairs:"14>1,1e>2,u>2,2wt>1,1>1,1ge>1,1wp>1,1j>1,f>1,hm>1,1>1,u>1,u6>1,1>1,+5,28>1,w>1,1>1,+3,b8>1,1>1,+3,1>3,-1>-1,3>1,1>1,+2,1s>1,1>1,x>1,th>1,1>1,+2,db>1,1>1,+3,3>1,1>1,+2,14qm>1,1>1,+1,4q>1,1e>2,u>2,2>1,+1",canonical:"6f1>-6dx,6dy>-6dx,6ec>-6ed,6ee>-6ed,6ww>2jj,-2ji>2jj,14r4>-1e7l,1e7m>-1e7l,1e7m>-1e5c,1e5d>-1e5b,1e5c>-14qx,14qy>-14qx,14vn>-1ecg,1ech>-1ecg,1edu>-1ecg,1eci>-1ecg,1eda>-1ecg,1eci>-1ecg,1eci>-168q,168r>-168q,168s>-14ye,14yf>-14ye"};function parseCharacterMap(r,x){var b,S=0,C=new Map,I=x&&new Map;return r.split(",").forEach((function visit(r){if(-1!==r.indexOf("+"))for(var A=+r;A--;)visit(b);else{b=r;var R=r.split(">"),B=R[0],D=R[1];B=String.fromCodePoint(S+=parseInt(B,36)),D=String.fromCodePoint(S+=parseInt(D,36)),C.set(B,D),x&&I.set(D,B)}})),{map:C,reverseMap:I}}function parse$1(){if(!F){var r=parseCharacterMap(H.pairs,!0),x=r.map,b=r.reverseMap;F=x,G=b,N=parseCharacterMap(H.canonical,!1).map}}function openingToClosingBracket(r){return parse$1(),F.get(r)||null}function closingToOpeningBracket(r){return parse$1(),G.get(r)||null}function getCanonicalBracket(r){return parse$1(),N.get(r)||null}var W=b.L,j=b.R,V=b.EN,X=b.ES,q=b.ET,$=b.AN,K=b.CS,Y=b.B,Z=b.S,J=b.ON,Q=b.BN,ee=b.NSM,te=b.AL,ne=b.LRO,re=b.RLO,ie=b.LRE,se=b.RLE,oe=b.PDF,ae=b.LRI,le=b.RLI,ce=b.FSI,he=b.PDI;var de,ue="14>1,j>2,t>2,u>2,1a>g,2v3>1,1>1,1ge>1,1wd>1,b>1,1j>1,f>1,ai>3,-2>3,+1,8>1k0,-1jq>1y7,-1y6>1hf,-1he>1h6,-1h5>1ha,-1h8>1qi,-1pu>1,6>3u,-3s>7,6>1,1>1,f>1,1>1,+2,3>1,1>1,+13,4>1,1>1,6>1eo,-1ee>1,3>1mg,-1me>1mk,-1mj>1mi,-1mg>1mi,-1md>1,1>1,+2,1>10k,-103>1,1>1,4>1,5>1,1>1,+10,3>1,1>8,-7>8,+1,-6>7,+1,a>1,1>1,u>1,u6>1,1>1,+5,26>1,1>1,2>1,2>2,8>1,7>1,4>1,1>1,+5,b8>1,1>1,+3,1>3,-2>1,2>1,1>1,+2,c>1,3>1,1>1,+2,h>1,3>1,a>1,1>1,2>1,3>1,1>1,d>1,f>1,3>1,1a>1,1>1,6>1,7>1,13>1,k>1,1>1,+19,4>1,1>1,+2,2>1,1>1,+18,m>1,a>1,1>1,lk>1,1>1,4>1,2>1,f>1,3>1,1>1,+3,db>1,1>1,+3,3>1,1>1,+2,14qm>1,1>1,+1,6>1,4j>1,j>2,t>2,u>2,2>1,+1";function getMirroredCharacter(r){return function(){if(!de){var r=parseCharacterMap(ue,!0),x=r.map;r.reverseMap.forEach((function(r,b){x.set(b,r)})),de=x}}(),de.get(r)||null}function getReorderSegments(r,x,b,S){var C=r.length;b=Math.max(0,null==b?0:+b),S=Math.min(C-1,null==S?C-1:+S);var I=[];return x.paragraphs.forEach((function(C){var A=Math.max(b,C.start),R=Math.min(S,C.end);if(A<R){for(var D=x.levels.slice(A,R+1),F=R;F>=A&&getBidiCharType(r[F])&B;F--)D[F]=C.level;for(var G=C.level,N=1/0,H=0;H<D.length;H++){var W=D[H];W>G&&(G=W),W<N&&(N=1|W)}for(var j=G;j>=N;j--)for(var V=0;V<D.length;V++)if(D[V]>=j){for(var X=V;V+1<D.length&&D[V+1]>=j;)V++;V>X&&I.push([X+A,V+A])}}})),I}function getReorderedIndices(r,x,b,S){for(var C=getReorderSegments(r,x,b,S),I=[],A=0;A<r.length;A++)I[A]=A;return C.forEach((function(r){for(var x=r[0],b=r[1],S=I.slice(x,b+1),C=S.length;C--;)I[b-C]=S[C]})),I}return r.closingToOpeningBracket=closingToOpeningBracket,r.getBidiCharType=getBidiCharType,r.getBidiCharTypeName=function(r){return S[getBidiCharType(r)]},r.getCanonicalBracket=getCanonicalBracket,r.getEmbeddingLevels=function(r,x){for(var b=new Uint32Array(r.length),S=0;S<r.length;S++)b[S]=getBidiCharType(r[S]);var D=new Map;function changeCharType(r,x){var S=b[r];b[r]=x,D.set(S,D.get(S)-1),S&A&&D.set(A,D.get(A)-1),D.set(x,(D.get(x)||0)+1),x&A&&D.set(A,(D.get(A)||0)+1)}for(var F=new Uint8Array(r.length),G=new Map,N=[],H=null,de=0;de<r.length;de++)H||N.push(H={start:de,end:r.length-1,level:"rtl"===x?1:"ltr"===x?0:determineAutoEmbedLevel(de,!1)}),b[de]&Y&&(H.end=de,H=null);for(var ue=se|ie|re|ne|C|he|oe|Y,nextEven=function(r){return r+(1&r?1:2)},nextOdd=function(r){return r+(1&r?2:1)},pe=0;pe<N.length;pe++){var fe=[{_level:(H=N[pe]).level,_override:0,_isolate:0}],ge=void 0,me=0,_e=0,ye=0;D.clear();for(var ve=H.start;ve<=H.end;ve++){var xe=b[ve];if(ge=fe[fe.length-1],D.set(xe,(D.get(xe)||0)+1),xe&A&&D.set(A,(D.get(A)||0)+1),xe&ue)if(xe&(se|ie)){F[ve]=ge._level;var be=(xe===se?nextOdd:nextEven)(ge._level);be<=125&&!me&&!_e?fe.push({_level:be,_override:0,_isolate:0}):me||_e++}else if(xe&(re|ne)){F[ve]=ge._level;var Te=(xe===re?nextOdd:nextEven)(ge._level);Te<=125&&!me&&!_e?fe.push({_level:Te,_override:xe&re?j:W,_isolate:0}):me||_e++}else if(xe&C){xe&ce&&(xe=1===determineAutoEmbedLevel(ve+1,!0)?le:ae),F[ve]=ge._level,ge._override&&changeCharType(ve,ge._override);var we=(xe===le?nextOdd:nextEven)(ge._level);we<=125&&0===me&&0===_e?(ye++,fe.push({_level:we,_override:0,_isolate:1,_isolInitIndex:ve})):me++}else if(xe&he){if(me>0)me--;else if(ye>0){for(_e=0;!fe[fe.length-1]._isolate;)fe.pop();var Se=fe[fe.length-1]._isolInitIndex;null!=Se&&(G.set(Se,ve),G.set(ve,Se)),fe.pop(),ye--}ge=fe[fe.length-1],F[ve]=ge._level,ge._override&&changeCharType(ve,ge._override)}else xe&oe?(0===me&&(_e>0?_e--:!ge._isolate&&fe.length>1&&(fe.pop(),ge=fe[fe.length-1])),F[ve]=ge._level):xe&Y&&(F[ve]=H.level);else F[ve]=ge._level,ge._override&&xe!==Q&&changeCharType(ve,ge._override)}for(var Ce=[],Ie=null,ke=H.start;ke<=H.end;ke++){var Ae=b[ke];if(!(Ae&R)){var Ee=F[ke],Re=Ae&C,Me=Ae===he;Ie&&Ee===Ie._level?(Ie._end=ke,Ie._endsWithIsolInit=Re):Ce.push(Ie={_start:ke,_end:ke,_level:Ee,_startsWithPDI:Me,_endsWithIsolInit:Re})}}for(var Pe=[],Be=0;Be<Ce.length;Be++){var Le=Ce[Be];if(!Le._startsWithPDI||Le._startsWithPDI&&!G.has(Le._start)){for(var Oe=[Ie=Le],De=void 0;Ie&&Ie._endsWithIsolInit&&null!=(De=G.get(Ie._end));)for(var Ue=Be+1;Ue<Ce.length;Ue++)if(Ce[Ue]._start===De){Oe.push(Ie=Ce[Ue]);break}for(var Fe=[],Ge=0;Ge<Oe.length;Ge++)for(var Ne=Oe[Ge],He=Ne._start;He<=Ne._end;He++)Fe.push(He);for(var We=F[Fe[0]],ze=H.level,je=Fe[0]-1;je>=0;je--)if(!(b[je]&R)){ze=F[je];break}var Ve=Fe[Fe.length-1],Xe=F[Ve],qe=H.level;if(!(b[Ve]&C))for(var $e=Ve+1;$e<=H.end;$e++)if(!(b[$e]&R)){qe=F[$e];break}Pe.push({_seqIndices:Fe,_sosType:Math.max(ze,We)%2?j:W,_eosType:Math.max(qe,Xe)%2?j:W})}}for(var Ke=0;Ke<Pe.length;Ke++){var Ye=Pe[Ke],Ze=Ye._seqIndices,Je=Ye._sosType,Qe=Ye._eosType,et=1&F[Ze[0]]?j:W;if(D.get(ee))for(var tt=0;tt<Ze.length;tt++){var nt=Ze[tt];if(b[nt]&ee){for(var rt=Je,it=tt-1;it>=0;it--)if(!(b[Ze[it]]&R)){rt=b[Ze[it]];break}changeCharType(nt,rt&(C|he)?J:rt)}}if(D.get(V))for(var st=0;st<Ze.length;st++){var ot=Ze[st];if(b[ot]&V)for(var at=st-1;at>=-1;at--){var lt=-1===at?Je:b[Ze[at]];if(lt&I){lt===te&&changeCharType(ot,$);break}}}if(D.get(te))for(var ct=0;ct<Ze.length;ct++){var ht=Ze[ct];b[ht]&te&&changeCharType(ht,j)}if(D.get(X)||D.get(K))for(var dt=1;dt<Ze.length-1;dt++){var ut=Ze[dt];if(b[ut]&(X|K)){for(var pt=0,ft=0,gt=dt-1;gt>=0&&(pt=b[Ze[gt]])&R;gt--);for(var mt=dt+1;mt<Ze.length&&(ft=b[Ze[mt]])&R;mt++);pt===ft&&(b[ut]===X?pt===V:pt&(V|$))&&changeCharType(ut,pt)}}if(D.get(V))for(var _t=0;_t<Ze.length;_t++){var yt=Ze[_t];if(b[yt]&V){for(var vt=_t-1;vt>=0&&b[Ze[vt]]&(q|R);vt--)changeCharType(Ze[vt],V);for(_t++;_t<Ze.length&&b[Ze[_t]]&(q|R|V);_t++)b[Ze[_t]]!==V&&changeCharType(Ze[_t],V)}}if(D.get(q)||D.get(X)||D.get(K))for(var xt=0;xt<Ze.length;xt++){var bt=Ze[xt];if(b[bt]&(q|X|K)){changeCharType(bt,J);for(var Tt=xt-1;Tt>=0&&b[Ze[Tt]]&R;Tt--)changeCharType(Ze[Tt],J);for(var wt=xt+1;wt<Ze.length&&b[Ze[wt]]&R;wt++)changeCharType(Ze[wt],J)}}if(D.get(V))for(var St=0,Ct=Je;St<Ze.length;St++){var It=Ze[St],kt=b[It];kt&V?Ct===W&&changeCharType(It,W):kt&I&&(Ct=kt)}if(D.get(A)){for(var At=j|V|$,Et=At|W,Rt=[],Mt=[],Pt=0;Pt<Ze.length;Pt++)if(b[Ze[Pt]]&A){var Bt=r[Ze[Pt]],Lt=void 0;if(null!==openingToClosingBracket(Bt)){if(!(Mt.length<63))break;Mt.push({char:Bt,seqIndex:Pt})}else if(null!==(Lt=closingToOpeningBracket(Bt)))for(var Ot=Mt.length-1;Ot>=0;Ot--){var Dt=Mt[Ot].char;if(Dt===Lt||Dt===closingToOpeningBracket(getCanonicalBracket(Bt))||openingToClosingBracket(getCanonicalBracket(Dt))===Bt){Rt.push([Mt[Ot].seqIndex,Pt]),Mt.length=Ot;break}}}Rt.sort((function(r,x){return r[0]-x[0]}));for(var Ut=0;Ut<Rt.length;Ut++){for(var Ft=Rt[Ut],Gt=Ft[0],Nt=Ft[1],Ht=!1,Wt=0,zt=Gt+1;zt<Nt;zt++){var jt=Ze[zt];if(b[jt]&Et){Ht=!0;var Vt=b[jt]&At?j:W;if(Vt===et){Wt=Vt;break}}}if(Ht&&!Wt){Wt=Je;for(var Xt=Gt-1;Xt>=0;Xt--){var qt=Ze[Xt];if(b[qt]&Et){var $t=b[qt]&At?j:W;Wt=$t!==et?$t:et;break}}}if(Wt){if(b[Ze[Gt]]=b[Ze[Nt]]=Wt,Wt!==et)for(var Kt=Gt+1;Kt<Ze.length;Kt++)if(!(b[Ze[Kt]]&R)){getBidiCharType(r[Ze[Kt]])&ee&&(b[Ze[Kt]]=Wt);break}if(Wt!==et)for(var Yt=Nt+1;Yt<Ze.length;Yt++)if(!(b[Ze[Yt]]&R)){getBidiCharType(r[Ze[Yt]])&ee&&(b[Ze[Yt]]=Wt);break}}}for(var Zt=0;Zt<Ze.length;Zt++)if(b[Ze[Zt]]&A){for(var Jt=Zt,Qt=Zt,en=Je,tn=Zt-1;tn>=0;tn--){if(!(b[Ze[tn]]&R)){en=b[Ze[tn]]&At?j:W;break}Jt=tn}for(var nn=Qe,rn=Zt+1;rn<Ze.length;rn++){if(!(b[Ze[rn]]&(A|R))){nn=b[Ze[rn]]&At?j:W;break}Qt=rn}for(var sn=Jt;sn<=Qt;sn++)b[Ze[sn]]=en===nn?en:et;Zt=Qt}}}for(var on=H.start;on<=H.end;on++){var an=F[on],ln=b[on];if(1&an?ln&(W|V|$)&&F[on]++:ln&j?F[on]++:ln&($|V)&&(F[on]+=2),ln&R&&(F[on]=0===on?H.level:F[on-1]),on===H.end||getBidiCharType(r[on])&(Z|Y))for(var cn=on;cn>=0&&getBidiCharType(r[cn])&B;cn--)F[cn]=H.level}}return{levels:F,paragraphs:N};function determineAutoEmbedLevel(x,S){for(var I=x;I<r.length;I++){var A=b[I];if(A&(j|te))return 1;if(A&(Y|W)||S&&A===he)return 0;if(A&C){var R=indexOfMatchingPDI(I);I=-1===R?r.length:R}}return 0}function indexOfMatchingPDI(x){for(var S=1,I=x+1;I<r.length;I++){var A=b[I];if(A&Y)break;if(A&he){if(0==--S)return I}else A&C&&S++}return-1}},r.getMirroredCharacter=getMirroredCharacter,r.getMirroredCharactersMap=function(r,x,b,S){var C=r.length;b=Math.max(0,null==b?0:+b),S=Math.min(C-1,null==S?C-1:+S);for(var I=new Map,A=b;A<=S;A++)if(1&x[A]){var R=getMirroredCharacter(r[A]);null!==R&&I.set(A,R)}return I},r.getReorderSegments=getReorderSegments,r.getReorderedIndices=getReorderedIndices,r.getReorderedString=function(r,x,b,S){var C=getReorderedIndices(r,x,b,S),I=[].concat(r);return C.forEach((function(b,S){I[S]=(1&x.levels[b]?getMirroredCharacter(r[b]):null)||r[b]})),I.join("")},r.openingToClosingBracket=openingToClosingBracket,Object.defineProperty(r,"__esModule",{value:!0}),r}({});return r}],init:(r,x,b)=>r(x,b())}),ss=defineWorkerModule({name:"Typesetter",dependencies:[is],init:r=>function(x){return new Promise((b=>{r.typeset(x,b)}))},getTransferables(r){const x=[];for(let b in r)r[b]&&r[b].buffer&&x.push(r[b].buffer);return x}}),os=ss.onMainThread;const as={};const ls="aTroikaGlyphBounds",cs="aTroikaGlyphIndex";class GlyphsGeometry extends _t{constructor(){super(),this.detail=1,this.curveRadius=0,this.groups=[{start:0,count:1/0,materialIndex:0},{start:0,count:1/0,materialIndex:1}],this.boundingSphere=new j,this.boundingBox=new F}computeBoundingSphere(){}computeBoundingBox(){}set detail(r){if(r!==this._detail){this._detail=r,("number"!=typeof r||r<1)&&(r=1);let x=function(r){let x=as[r];return x||(x=as[r]=new vt(1,1,r,r).translate(.5,.5,0)),x}(r);["position","normal","uv"].forEach((r=>{this.attributes[r]=x.attributes[r].clone()})),this.setIndex(x.getIndex().clone())}}get detail(){return this._detail}set curveRadius(r){r!==this._curveRadius&&(this._curveRadius=r,this._updateBounds())}get curveRadius(){return this._curveRadius}updateGlyphs(r,x,b,S,C){this.updateAttributeData(ls,r,4),this.updateAttributeData(cs,x,1),this.updateAttributeData("aTroikaGlyphColor",C,3),this._blockBounds=b,this._chunkedBounds=S,this.instanceCount=x.length,this._updateBounds()}_updateBounds(){const r=this._blockBounds;if(r){const{curveRadius:x,boundingBox:b}=this;if(x){const{PI:S,floor:C,min:I,max:A,sin:R,cos:B}=Math,D=S/2,F=2*S,G=Math.abs(x),N=r[0]/G,H=r[2]/G,W=C((N+D)/F)!==C((H+D)/F)?-G:I(R(N)*G,R(H)*G),j=C((N-D)/F)!==C((H-D)/F)?G:A(R(N)*G,R(H)*G),V=C((N+S)/F)!==C((H+S)/F)?2*G:A(G-B(N)*G,G-B(H)*G);b.min.set(W,r[1],x<0?-V:0),b.max.set(j,r[3],x<0?0:V)}else b.min.set(r[0],r[1],0),b.max.set(r[2],r[3],0);b.getBoundingSphere(this.boundingSphere)}}applyClipRect(r){let x=this.getAttribute(cs).count,b=this._chunkedBounds;if(b)for(let S=b.length;S--;){x=b[S].end;let C=b[S].rect;if(C[1]<r.w&&C[3]>r.y&&C[0]<r.z&&C[2]>r.x)break}this.instanceCount=x}updateAttributeData(r,x,b){const S=this.getAttribute(r);x?S&&S.array.length===x.length?(S.array.set(x),S.needsUpdate=!0):(this.setAttribute(r,new Ee(x,b)),delete this._maxInstanceCount,this.dispose()):S&&this.deleteAttribute(r)}}const hs="\nuniform vec2 uTroikaSDFTextureSize;\nuniform float uTroikaSDFGlyphSize;\nuniform vec4 uTroikaTotalBounds;\nuniform vec4 uTroikaClipRect;\nuniform mat3 uTroikaOrient;\nuniform bool uTroikaUseGlyphColors;\nuniform float uTroikaEdgeOffset;\nuniform float uTroikaBlurRadius;\nuniform vec2 uTroikaPositionOffset;\nuniform float uTroikaCurveRadius;\nattribute vec4 aTroikaGlyphBounds;\nattribute float aTroikaGlyphIndex;\nattribute vec3 aTroikaGlyphColor;\nvarying vec2 vTroikaGlyphUV;\nvarying vec4 vTroikaTextureUVBounds;\nvarying float vTroikaTextureChannel;\nvarying vec3 vTroikaGlyphColor;\nvarying vec2 vTroikaGlyphDimensions;\n",ds="\nvec4 bounds = aTroikaGlyphBounds;\nbounds.xz += uTroikaPositionOffset.x;\nbounds.yw -= uTroikaPositionOffset.y;\n\nvec4 outlineBounds = vec4(\n  bounds.xy - uTroikaEdgeOffset - uTroikaBlurRadius,\n  bounds.zw + uTroikaEdgeOffset + uTroikaBlurRadius\n);\nvec4 clippedBounds = vec4(\n  clamp(outlineBounds.xy, uTroikaClipRect.xy, uTroikaClipRect.zw),\n  clamp(outlineBounds.zw, uTroikaClipRect.xy, uTroikaClipRect.zw)\n);\n\nvec2 clippedXY = (mix(clippedBounds.xy, clippedBounds.zw, position.xy) - bounds.xy) / (bounds.zw - bounds.xy);\n\nposition.xy = mix(bounds.xy, bounds.zw, clippedXY);\n\nuv = (position.xy - uTroikaTotalBounds.xy) / (uTroikaTotalBounds.zw - uTroikaTotalBounds.xy);\n\nfloat rad = uTroikaCurveRadius;\nif (rad != 0.0) {\n  float angle = position.x / rad;\n  position.xz = vec2(sin(angle) * rad, rad - cos(angle) * rad);\n  normal.xz = vec2(sin(angle), cos(angle));\n}\n  \nposition = uTroikaOrient * position;\nnormal = uTroikaOrient * normal;\n\nvTroikaGlyphUV = clippedXY.xy;\nvTroikaGlyphDimensions = vec2(bounds[2] - bounds[0], bounds[3] - bounds[1]);\n\n\nfloat txCols = uTroikaSDFTextureSize.x / uTroikaSDFGlyphSize;\nvec2 txUvPerSquare = uTroikaSDFGlyphSize / uTroikaSDFTextureSize;\nvec2 txStartUV = txUvPerSquare * vec2(\n  mod(floor(aTroikaGlyphIndex / 4.0), txCols),\n  floor(floor(aTroikaGlyphIndex / 4.0) / txCols)\n);\nvTroikaTextureUVBounds = vec4(txStartUV, vec2(txStartUV) + txUvPerSquare);\nvTroikaTextureChannel = mod(aTroikaGlyphIndex, 4.0);\n",us="\nuniform sampler2D uTroikaSDFTexture;\nuniform vec2 uTroikaSDFTextureSize;\nuniform float uTroikaSDFGlyphSize;\nuniform float uTroikaSDFExponent;\nuniform float uTroikaEdgeOffset;\nuniform float uTroikaFillOpacity;\nuniform float uTroikaBlurRadius;\nuniform vec3 uTroikaStrokeColor;\nuniform float uTroikaStrokeWidth;\nuniform float uTroikaStrokeOpacity;\nuniform bool uTroikaSDFDebug;\nvarying vec2 vTroikaGlyphUV;\nvarying vec4 vTroikaTextureUVBounds;\nvarying float vTroikaTextureChannel;\nvarying vec2 vTroikaGlyphDimensions;\n\nfloat troikaSdfValueToSignedDistance(float alpha) {\n  // Inverse of exponential encoding in webgl-sdf-generator\n  \n  float maxDimension = max(vTroikaGlyphDimensions.x, vTroikaGlyphDimensions.y);\n  float absDist = (1.0 - pow(2.0 * (alpha > 0.5 ? 1.0 - alpha : alpha), 1.0 / uTroikaSDFExponent)) * maxDimension;\n  float signedDist = absDist * (alpha > 0.5 ? -1.0 : 1.0);\n  return signedDist;\n}\n\nfloat troikaGlyphUvToSdfValue(vec2 glyphUV) {\n  vec2 textureUV = mix(vTroikaTextureUVBounds.xy, vTroikaTextureUVBounds.zw, glyphUV);\n  vec4 rgba = texture2D(uTroikaSDFTexture, textureUV);\n  float ch = floor(vTroikaTextureChannel + 0.5); //NOTE: can't use round() in WebGL1\n  return ch == 0.0 ? rgba.r : ch == 1.0 ? rgba.g : ch == 2.0 ? rgba.b : rgba.a;\n}\n\nfloat troikaGlyphUvToDistance(vec2 uv) {\n  return troikaSdfValueToSignedDistance(troikaGlyphUvToSdfValue(uv));\n}\n\nfloat troikaGetAADist() {\n  \n  #if defined(GL_OES_standard_derivatives) || __VERSION__ >= 300\n  return length(fwidth(vTroikaGlyphUV * vTroikaGlyphDimensions)) * 0.5;\n  #else\n  return vTroikaGlyphDimensions.x / 64.0;\n  #endif\n}\n\nfloat troikaGetFragDistValue() {\n  vec2 clampedGlyphUV = clamp(vTroikaGlyphUV, 0.5 / uTroikaSDFGlyphSize, 1.0 - 0.5 / uTroikaSDFGlyphSize);\n  float distance = troikaGlyphUvToDistance(clampedGlyphUV);\n \n  // Extrapolate distance when outside bounds:\n  distance += clampedGlyphUV == vTroikaGlyphUV ? 0.0 : \n    length((vTroikaGlyphUV - clampedGlyphUV) * vTroikaGlyphDimensions);\n\n  \n\n  return distance;\n}\n\nfloat troikaGetEdgeAlpha(float distance, float distanceOffset, float aaDist) {\n  #if defined(IS_DEPTH_MATERIAL) || defined(IS_DISTANCE_MATERIAL)\n  float alpha = step(-distanceOffset, -distance);\n  #else\n\n  float alpha = smoothstep(\n    distanceOffset + aaDist,\n    distanceOffset - aaDist,\n    distance\n  );\n  #endif\n\n  return alpha;\n}\n",ps="\nfloat aaDist = troikaGetAADist();\nfloat fragDistance = troikaGetFragDistValue();\nfloat edgeAlpha = uTroikaSDFDebug ?\n  troikaGlyphUvToSdfValue(vTroikaGlyphUV) :\n  troikaGetEdgeAlpha(fragDistance, uTroikaEdgeOffset, max(aaDist, uTroikaBlurRadius));\n\n#if !defined(IS_DEPTH_MATERIAL) && !defined(IS_DISTANCE_MATERIAL)\nvec4 fillRGBA = gl_FragColor;\nfillRGBA.a *= uTroikaFillOpacity;\nvec4 strokeRGBA = uTroikaStrokeWidth == 0.0 ? fillRGBA : vec4(uTroikaStrokeColor, uTroikaStrokeOpacity);\nif (fillRGBA.a == 0.0) fillRGBA.rgb = strokeRGBA.rgb;\ngl_FragColor = mix(fillRGBA, strokeRGBA, smoothstep(\n  -uTroikaStrokeWidth - aaDist,\n  -uTroikaStrokeWidth + aaDist,\n  fragDistance\n));\ngl_FragColor.a *= edgeAlpha;\n#endif\n\nif (edgeAlpha == 0.0) {\n  discard;\n}\n";function createTextDerivedMaterial(r){const x=createDerivedMaterial(r,{chained:!0,extensions:{derivatives:!0},uniforms:{uTroikaSDFTexture:{value:null},uTroikaSDFTextureSize:{value:new R},uTroikaSDFGlyphSize:{value:0},uTroikaSDFExponent:{value:0},uTroikaTotalBounds:{value:new le(0,0,0,0)},uTroikaClipRect:{value:new le(0,0,0,0)},uTroikaEdgeOffset:{value:0},uTroikaFillOpacity:{value:1},uTroikaPositionOffset:{value:new R},uTroikaCurveRadius:{value:0},uTroikaBlurRadius:{value:0},uTroikaStrokeWidth:{value:0},uTroikaStrokeColor:{value:new be},uTroikaStrokeOpacity:{value:1},uTroikaOrient:{value:new Q},uTroikaUseGlyphColors:{value:!0},uTroikaSDFDebug:{value:!1}},vertexDefs:hs,vertexTransform:ds,fragmentDefs:us,fragmentColorTransform:ps,customRewriter({vertexShader:r,fragmentShader:x}){let b=/\buniform\s+vec3\s+diffuse\b/;return b.test(x)&&(x=x.replace(b,"varying vec3 vTroikaGlyphColor").replace(/\bdiffuse\b/g,"vTroikaGlyphColor"),b.test(r)||(r=r.replace(Bi,"uniform vec3 diffuse;\n$&\nvTroikaGlyphColor = uTroikaUseGlyphColors ? aTroikaGlyphColor / 255.0 : diffuse;\n"))),{vertexShader:r,fragmentShader:x}}});return x.transparent=!0,x.forceSinglePass=!0,Object.defineProperties(x,{isTroikaTextMaterial:{value:!0},shadowSide:{get(){return this.side},set(){}}}),x}const fs=new W({color:16777215,side:pe,transparent:!0}),gs=8421504,ms=new B,_s=new x,ys=new x,vs=[],xs=new x,bs="+x+y";function first(r){return Array.isArray(r)?r[0]:r}let getFlatRaycastMesh=()=>{const r=new b(new vt(1,1),fs);return getFlatRaycastMesh=()=>r,r},getCurvedRaycastMesh=()=>{const r=new b(new vt(1,1,32,1),fs);return getCurvedRaycastMesh=()=>r,r};const Ts={type:"syncstart"},ws={type:"synccomplete"},Ss=["font","fontSize","fontStyle","fontWeight","lang","letterSpacing","lineHeight","maxWidth","overflowWrap","text","direction","textAlign","textIndent","whiteSpace","anchorX","anchorY","colorRanges","sdfGlyphSize"],Cs=Ss.concat("material","color","depthOffset","clipRect","curveRadius","orientation","glyphGeometryDetail");class Text extends b{constructor(){super(new GlyphsGeometry,null),this.text="",this.anchorX=0,this.anchorY=0,this.curveRadius=0,this.direction="auto",this.font=null,this.unicodeFontsURL=null,this.fontSize=.1,this.fontWeight="normal",this.fontStyle="normal",this.lang=null,this.letterSpacing=0,this.lineHeight="normal",this.maxWidth=1/0,this.overflowWrap="normal",this.textAlign="left",this.textIndent=0,this.whiteSpace="normal",this.material=null,this.color=null,this.colorRanges=null,this.outlineWidth=0,this.outlineColor=0,this.outlineOpacity=1,this.outlineBlur=0,this.outlineOffsetX=0,this.outlineOffsetY=0,this.strokeWidth=0,this.strokeColor=gs,this.strokeOpacity=1,this.fillOpacity=1,this.depthOffset=0,this.clipRect=null,this.orientation=bs,this.glyphGeometryDetail=1,this.sdfGlyphSize=null,this.gpuAccelerateSDF=!0,this.debugSDF=!1}sync(r){this._needsSync&&(this._needsSync=!1,this._isSyncing?(this._queuedSyncs||(this._queuedSyncs=[])).push(r):(this._isSyncing=!0,this.dispatchEvent(Ts),getTextRenderInfo({text:this.text,font:this.font,lang:this.lang,fontSize:this.fontSize||.1,fontWeight:this.fontWeight||"normal",fontStyle:this.fontStyle||"normal",letterSpacing:this.letterSpacing||0,lineHeight:this.lineHeight||"normal",maxWidth:this.maxWidth,direction:this.direction||"auto",textAlign:this.textAlign,textIndent:this.textIndent,whiteSpace:this.whiteSpace,overflowWrap:this.overflowWrap,anchorX:this.anchorX,anchorY:this.anchorY,colorRanges:this.colorRanges,includeCaretPositions:!0,sdfGlyphSize:this.sdfGlyphSize,gpuAccelerateSDF:this.gpuAccelerateSDF,unicodeFontsURL:this.unicodeFontsURL},(x=>{this._isSyncing=!1,this._textRenderInfo=x,this.geometry.updateGlyphs(x.glyphBounds,x.glyphAtlasIndices,x.blockBounds,x.chunkedBounds,x.glyphColors);const b=this._queuedSyncs;b&&(this._queuedSyncs=null,this._needsSync=!0,this.sync((()=>{b.forEach((r=>r&&r()))}))),this.dispatchEvent(ws),r&&r()}))))}onBeforeRender(r,x,b,S,C,I){this.sync(),C.isTroikaTextMaterial&&this._prepareForRender(C)}dispose(){this.geometry.dispose()}get textRenderInfo(){return this._textRenderInfo||null}createDerivedMaterial(r){return createTextDerivedMaterial(r)}get material(){let r=this._derivedMaterial;const x=this._baseMaterial||this._defaultMaterial||(this._defaultMaterial=fs.clone());if(r&&r.isDerivedFrom(x)||(r=this._derivedMaterial=this.createDerivedMaterial(x),x.addEventListener("dispose",(function onDispose(){x.removeEventListener("dispose",onDispose),r.dispose()}))),this.hasOutline()){let x=r._outlineMtl;return x||(x=r._outlineMtl=Object.create(r,{id:{value:r.id+.1}}),x.isTextOutlineMaterial=!0,x.depthWrite=!1,x.map=null,r.addEventListener("dispose",(function onDispose(){r.removeEventListener("dispose",onDispose),x.dispose()}))),[x,r]}return r}set material(r){r&&r.isTroikaTextMaterial?(this._derivedMaterial=r,this._baseMaterial=r.baseMaterial):this._baseMaterial=r}hasOutline(){return!!(this.outlineWidth||this.outlineBlur||this.outlineOffsetX||this.outlineOffsetY)}get glyphGeometryDetail(){return this.geometry.detail}set glyphGeometryDetail(r){this.geometry.detail=r}get curveRadius(){return this.geometry.curveRadius}set curveRadius(r){this.geometry.curveRadius=r}get customDepthMaterial(){return first(this.material).getDepthMaterial()}set customDepthMaterial(r){}get customDistanceMaterial(){return first(this.material).getDistanceMaterial()}set customDistanceMaterial(r){}_prepareForRender(r){const x=r.isTextOutlineMaterial,b=r.uniforms,S=this.textRenderInfo;if(S){const{sdfTexture:r,blockBounds:C}=S;b.uTroikaSDFTexture.value=r,b.uTroikaSDFTextureSize.value.set(r.image.width,r.image.height),b.uTroikaSDFGlyphSize.value=S.sdfGlyphSize,b.uTroikaSDFExponent.value=S.sdfExponent,b.uTroikaTotalBounds.value.fromArray(C),b.uTroikaUseGlyphColors.value=!x&&!!S.glyphColors;let I,A,R,B=0,D=0,F=0,G=0,N=0;if(x){let{outlineWidth:r,outlineOffsetX:x,outlineOffsetY:b,outlineBlur:S,outlineOpacity:C}=this;B=this._parsePercent(r)||0,D=Math.max(0,this._parsePercent(S)||0),I=C,G=this._parsePercent(x)||0,N=this._parsePercent(b)||0}else F=Math.max(0,this._parsePercent(this.strokeWidth)||0),F&&(R=this.strokeColor,b.uTroikaStrokeColor.value.set(null==R?gs:R),A=this.strokeOpacity,null==A&&(A=1)),I=this.fillOpacity;b.uTroikaEdgeOffset.value=B,b.uTroikaPositionOffset.value.set(G,N),b.uTroikaBlurRadius.value=D,b.uTroikaStrokeWidth.value=F,b.uTroikaStrokeOpacity.value=A,b.uTroikaFillOpacity.value=null==I?1:I,b.uTroikaCurveRadius.value=this.curveRadius||0;let H=this.clipRect;if(H&&Array.isArray(H)&&4===H.length)b.uTroikaClipRect.value.fromArray(H);else{const r=100*(this.fontSize||.1);b.uTroikaClipRect.value.set(C[0]-r,C[1]-r,C[2]+r,C[3]+r)}this.geometry.applyClipRect(b.uTroikaClipRect.value)}b.uTroikaSDFDebug.value=!!this.debugSDF,r.polygonOffset=!!this.depthOffset,r.polygonOffsetFactor=r.polygonOffsetUnits=this.depthOffset||0;const C=x?this.outlineColor||0:this.color;if(null==C)delete r.color;else{const x=r.hasOwnProperty("color")?r.color:r.color=new be;C===x._input&&"object"!=typeof C||x.set(x._input=C)}let I=this.orientation||bs;if(I!==r._orientation){let x=b.uTroikaOrient.value;I=I.replace(/[^-+xyz]/g,"");let S=I!==bs&&I.match(/^([-+])([xyz])([-+])([xyz])$/);if(S){let[,r,b,C,I]=S;_s.set(0,0,0)[b]="-"===r?1:-1,ys.set(0,0,0)[I]="-"===C?-1:1,ms.lookAt(xs,_s.cross(ys),ys),x.setFromMatrix4(ms)}else x.identity();r._orientation=I}}_parsePercent(r){if("string"==typeof r){let x=r.match(/^(-?[\d.]+)%$/),b=x?parseFloat(x[1]):NaN;r=(isNaN(b)?0:b/100)*this.fontSize}return r}localPositionToTextCoords(r,x=new R){x.copy(r);const b=this.curveRadius;return b&&(x.x=Math.atan2(r.x,Math.abs(b)-Math.abs(r.z))*Math.abs(b)),x}worldPositionToTextCoords(r,x=new R){return _s.copy(r),this.localPositionToTextCoords(this.worldToLocal(_s),x)}raycast(r,x){const{textRenderInfo:b,curveRadius:S}=this;if(b){const C=b.blockBounds,I=S?getCurvedRaycastMesh():getFlatRaycastMesh(),A=I.geometry,{position:R,uv:B}=A.attributes;for(let r=0;r<B.count;r++){let x=C[0]+B.getX(r)*(C[2]-C[0]);const b=C[1]+B.getY(r)*(C[3]-C[1]);let I=0;S&&(I=S-Math.cos(x/S)*S,x=Math.sin(x/S)*S),R.setXYZ(r,x,b,I)}A.boundingSphere=this.geometry.boundingSphere,A.boundingBox=this.geometry.boundingBox,I.matrixWorld=this.matrixWorld,I.material.side=this.material.side,vs.length=0,I.raycast(r,vs);for(let r=0;r<vs.length;r++)vs[r].object=this,x.push(vs[r])}}copy(r){const x=this.geometry;return super.copy(r),this.geometry=x,Cs.forEach((x=>{this[x]=r[x]})),this}clone(){return(new this.constructor).copy(this)}}Ss.forEach((r=>{const x="_private_"+r;Object.defineProperty(Text.prototype,r,{get(){return this[x]},set(r){r!==this[x]&&(this[x]=r,this._needsSync=!0)}})}));const Is={type:"syncstart"},ks={type:"synccomplete"},As="aTroikaTextBatchMemberIndex",Es=new F,Rs=new be;class BatchedText extends Text{constructor(){super(),this._members=new Map,this._dataTextures={},this._onMemberSynced=r=>{this._members.get(r.target).dirty=!0}}add(...r){for(let x=0;x<r.length;x++)r[x]instanceof Text?this.addText(r[x]):super.add(r[x]);return this}remove(...r){for(let x=0;x<r.length;x++)r[x]instanceof Text?this.removeText(r[x]):super.remove(r[x]);return this}addText(r){this._members.has(r)||(this._members.set(r,{index:-1,glyphCount:-1,dirty:!0}),r.addEventListener("synccomplete",this._onMemberSynced))}removeText(r){this._needsRepack=!0,r.removeEventListener("synccomplete",this._onMemberSynced),this._members.delete(r)}createDerivedMaterial(r){return function(r){const x="uTroikaMatricesTexture",b="uTroikaMatricesTextureSize";let S=createDerivedMaterial(r,{chained:!0,uniforms:{[b]:{value:new R},[x]:{value:null}},vertexDefs:`\n      uniform highp sampler2D ${x};\n      uniform vec2 ${b};\n      attribute float ${As};\n\n      vec4 troikaBatchTexel(float offset) {\n        offset += ${As} * ${32..toFixed(1)} / 4.0;\n        float w = ${b}.x;\n        vec2 uv = (vec2(mod(offset, w), floor(offset / w)) + 0.5) / ${b};\n        return texture2D(${x}, uv);\n      }\n    `,vertexTransform:"\n      mat4 matrix = mat4(\n        troikaBatchTexel(0.0),\n        troikaBatchTexel(1.0),\n        troikaBatchTexel(2.0),\n        troikaBatchTexel(3.0)\n      );\n      position.xyz = (matrix * vec4(position, 1.0)).xyz;\n    "});return S=createTextDerivedMaterial(S),S=createDerivedMaterial(S,{chained:!0,uniforms:{uTroikaIsOutline:{value:!1}},customRewriter:r=>(["uTroikaTotalBounds","uTroikaClipRect","uTroikaPositionOffset","uTroikaEdgeOffset","uTroikaBlurRadius","uTroikaStrokeWidth","uTroikaStrokeColor","uTroikaStrokeOpacity","uTroikaFillOpacity","uTroikaCurveRadius","diffuse"].forEach((x=>{r=function({vertexShader:r,fragmentShader:x},b,S=b){const C=new RegExp(`uniform\\s+(bool|float|vec[234]|mat[34])\\s+${b}\\b`);let I,A=!1;x=x.replace(C,((r,x)=>(A=!0,`varying ${I=x} ${S}`)));let R=!1;r=r.replace(C,((r,x)=>(R=!0,`${A?"varying":""} ${I=x} ${S}`))),R||(r=`${A?"varying":""} ${I} ${S};\n${r}`);return{vertexShader:r,fragmentShader:x}}(r,x)})),r),vertexDefs:"\n      uniform bool uTroikaIsOutline;\n      vec3 troikaFloatToColor(float v) {\n        return mod(floor(vec3(v / 65536.0, v / 256.0, v)), 256.0) / 256.0;\n      }\n    ",vertexTransform:"\n      uTroikaTotalBounds = troikaBatchTexel(4.0);\n      uTroikaClipRect = troikaBatchTexel(5.0);\n      \n      vec4 data = troikaBatchTexel(6.0);\n      diffuse = troikaFloatToColor(data.x);\n      uTroikaFillOpacity = data.y;\n      uTroikaCurveRadius = data.z;\n      \n      data = troikaBatchTexel(7.0);\n      if (uTroikaIsOutline) {\n        if (data == vec4(0.0)) { // degenerate if zero outline\n          position = vec3(0.0);\n        } else {\n          uTroikaPositionOffset = data.xy;\n          uTroikaEdgeOffset = data.z;\n          uTroikaBlurRadius = data.w;\n        }\n      } else {\n        uTroikaStrokeWidth = data.x;\n        uTroikaStrokeColor = troikaFloatToColor(data.y);\n        uTroikaStrokeOpacity = data.z;\n      }\n    "}),S.setMatrixTexture=r=>{S.uniforms[x].value=r,S.uniforms[b].value.set(r.image.width,r.image.height)},S}(r)}updateMatrixWorld(r){super.updateMatrixWorld(r),this.updateBounds()}updateBounds(){const r=this.geometry.boundingBox.makeEmpty();this._members.forEach(((x,b)=>{b.matrixAutoUpdate&&b.updateMatrix(),Es.copy(b.geometry.boundingBox).applyMatrix4(b.matrix),r.union(Es)})),r.getBoundingSphere(this.geometry.boundingSphere)}hasOutline(){for(let r of this._members.keys())if(r.hasOutline())return!0;return!1}_prepareForRender(r){const x=r.isTextOutlineMaterial;r.uniforms.uTroikaIsOutline.value=x;let b=this._dataTextures[x?"outline":"main"];const S=Math.pow(2,Math.ceil(Math.log2(32*this._members.size)));if(!b||S!==b.image.data.length){b&&b.dispose();const r=Math.min(S/4,1024);b=this._dataTextures[x?"outline":"main"]=new V(new Float32Array(S),r,S/4/r,Y,K)}const C=b.image.data,setTexData=(r,x)=>{x!==C[r]&&(C[r]=x,b.needsUpdate=!0)};this._members.forEach((({index:b,dirty:S},C)=>{if(b>-1){const S=32*b,I=C.matrix.elements;for(let r=0;r<16;r++)setTexData(S+r,I[r]);C._prepareForRender(r);const{uTroikaTotalBounds:A,uTroikaClipRect:R,uTroikaPositionOffset:B,uTroikaEdgeOffset:D,uTroikaBlurRadius:F,uTroikaStrokeWidth:G,uTroikaStrokeColor:N,uTroikaStrokeOpacity:H,uTroikaFillOpacity:W,uTroikaCurveRadius:j}=r.uniforms;for(let r=0;r<4;r++)setTexData(S+16+r,A.value.getComponent(r));for(let r=0;r<4;r++)setTexData(S+20+r,R.value.getComponent(r));let V=x?C.outlineColor||0:C.color;null==V&&(V=this.color),null==V&&(V=this.material.color),null==V&&(V=16777215),setTexData(S+24,Rs.set(V).getHex()),setTexData(S+25,W.value),setTexData(S+26,j.value),x?(setTexData(S+28,B.value.x),setTexData(S+29,B.value.y),setTexData(S+30,D.value),setTexData(S+31,F.value)):(setTexData(S+28,G.value),setTexData(S+29,Rs.set(N.value).getHex()),setTexData(S+30,H.value))}})),r.setMatrixTexture(b),super._prepareForRender(r)}sync(r){let x=this._needsRepack?[]:null;this._needsRepack=!1,this._members.forEach(((r,b)=>{(r.dirty||b._needsSync)&&(r.dirty=!1,(x||(x=[])).push(new Promise((r=>{b._needsSync?b.sync(r):r()}))))})),x&&(this.dispatchEvent(Is),Promise.all(x).then((()=>{const{geometry:x}=this,b=x.attributes;let S=b[As]&&b[As].array||new Uint16Array(0),C=b[cs]&&b[cs].array||new Float32Array(0),I=b[ls]&&b[ls].array||new Float32Array(0),A=0;this._members.forEach(((r,{textRenderInfo:x})=>{x&&(A+=x.glyphAtlasIndices.length,this._textRenderInfo=x)})),A!==S.length&&(S=cloneAndResize(S,A),C=cloneAndResize(C,A),I=cloneAndResize(I,4*A));let R=0,B=0;this._members.forEach(((r,{textRenderInfo:x})=>{if(x){const b=x.glyphAtlasIndices.length;S.fill(R,B,B+b),C.set(x.glyphAtlasIndices,B,B+b),I.set(x.glyphBounds,4*B,4*(B+b)),B+=b,r.index=R++}})),x.updateAttributeData(As,S,1),x.getAttribute(As).setUsage(yt),x.updateAttributeData(cs,C,1),x.updateAttributeData(ls,I,4),this.updateBounds(),this.dispatchEvent(ks),r&&r()})))}copy(r){return r instanceof BatchedText&&(super.copy(r),this._members.forEach(((r,x)=>this.removeText(x))),r._members.forEach(((r,x)=>this.addText(x)))),this}dispose(){super.dispose(),Object.values(this._dataTextures).forEach((r=>r.dispose()))}}function cloneAndResize(r,x){const b=new r.constructor(x);return b.set(r.subarray(0,x)),b}function getCaretAtPoint(r,x,b){let S=null;const C=function(r){let x=Ps.get(r);if(!x){x=[];const{caretPositions:b}=r;let S;const visitCaret=(r,b,C,I)=>{(!S||C<(S.top+S.bottom)/2)&&x.push(S={bottom:b,top:C,carets:[]}),C>S.top&&(S.top=C),b<S.bottom&&(S.bottom=b),S.carets.push({x:r,y:b,height:C-b,charIndex:I})};let C=0;for(;C<b.length;C+=4)visitCaret(b[C],b[C+2],b[C+3],C/4);visitCaret(b[C-3],b[C-2],b[C-1],C/4)}return Ps.set(r,x),x}(r);let I=null;return C.forEach((r=>{(!I||Math.abs(b-(r.top+r.bottom)/2)<Math.abs(b-(I.top+I.bottom)/2))&&(I=r)})),I.carets.forEach((r=>{(!S||Math.abs(x-r.x)<Math.abs(x-S.x))&&(S=r)})),S}const Ms=new WeakMap;const Ps=new WeakMap;var Bs=Object.freeze({__proto__:null,BatchedText:BatchedText,GlyphsGeometry:GlyphsGeometry,Text:Text,configureTextBuilder:function(r){ts?console.warn("configureTextBuilder called after first font request; will be ignored."):assign(Qi,r)},createTextDerivedMaterial:createTextDerivedMaterial,dumpSDFTextures:function(){Object.keys(ns).forEach((r=>{const x=ns[r].sdfCanvas,{width:b,height:S}=x;console.log("%c.",`\n      background: url(${x.toDataURL()});\n      background-size: ${b}px ${S}px;\n      color: transparent;\n      font-size: 0;\n      line-height: ${S}px;\n      padding-left: ${b}px;\n    `)}))},fontResolverWorkerModule:zi,getCaretAtPoint:getCaretAtPoint,getSelectionRects:function(r,x,b){let S;if(r){let C=Ms.get(r);if(C&&C.start===x&&C.end===b)return C.rects;const{caretPositions:I}=r;if(b<x){const r=x;x=b,b=r}x=Math.max(x,0),b=Math.min(b,I.length+1),S=[];let A=null;for(let r=x;r<b;r++){const x=I[4*r],b=I[4*r+1],C=Math.min(x,b),R=Math.max(x,b),B=I[4*r+2],D=I[4*r+3];(!A||B!==A.bottom||D!==A.top||C>A.right||R<A.left)&&(A={left:1/0,right:-1/0,bottom:B,top:D},S.push(A)),A.left=Math.min(C,A.left),A.right=Math.max(R,A.right)}S.sort(((r,x)=>x.bottom-r.bottom||r.left-x.left));for(let r=S.length-1;r-- >0;){const x=S[r],b=S[r+1];x.bottom===b.bottom&&x.top===b.top&&x.left<=b.right&&x.right>=b.left&&(b.left=Math.min(b.left,x.left),b.right=Math.max(b.right,x.right),S.splice(r,1))}Ms.set(r,{start:x,end:b,rects:S})}return S},getTextRenderInfo:getTextRenderInfo,preloadFont:function({font:r,characters:x,sdfGlyphSize:b},S){getTextRenderInfo({font:r,sdfGlyphSize:b,text:Array.isArray(x)?x.join("\n"):""+x},S)},typesetterWorkerModule:is});class Checkbox extends InteractableComponent{constructor(...r){super(...r),this._defaults.backgroundVisible=!0,this._defaults.borderMaterial.color.set(5197647),this._defaults.borderMaterial.opacity=.9,this._defaults.borderWidth=.002,this._defaults.color=16777215,this._defaults.height=.08,this._defaults.width=.08,this._text=new Text,this._text.fontSize=.65*Math.min(numberOr(this.height,.08),numberOr(this.width,.08)),this._content.add(this._text),this._text.text=" ",this._text.color=this.color,this._text.lineHeight=1,this._text.textAlign="center",this._text.anchorX="center",this._text.anchorY="middle",this.onClick=this.onTouch=()=>this._change(),"visible"!=this.overflow&&(this._text.material.clippingPlanes=this._getClippingPlanes())}updateLayout(r){super.updateLayout(r),this._text.fontSize=.65*Math.min(this.computedHeight,this.computedWidth)}_updateMaterialOffset(r){super._updateMaterialOffset(r),this._text.depthOffset=-1*this._materialOffset-1,this._text.renderOrder=this._materialOffset+1}_change(){this._checked=!this._checked,this._checked?(this._text.text="",this.material.color.set(12543),this._text.sync()):(this._text.text="",this.material.color.set(16777215)),this._onChange&&this._onChange(this._checked)}get checked(){return this._checked}get onChange(){return this._onChange}set checked(r){r!=this._checked&&(this._checked=r,r?(this._text.text="",this.material.color.set(12543)):(this._text.text="",this.material.color.set(16777215)),this._text.sync())}set onChange(r){this._onChange=r}}class Div extends ScrollableComponent{constructor(...r){super(...r)}}const Ls=new r.Vector3;class Image extends InteractableComponent{constructor(r,...x){super(...x),this._defaults.backgroundVisible=!0,this._defaults.textureFit="fill",this._imageHeight=0,this._imageWidth=0,this.updateTexture(r)}_handleStyleUpdateForTextureFit(){this._updateFit(-1,1)}_computeDimension(r){if("auto"!=this[r])return super._computeDimension(r);let x="height"==r?"width":"height",b=capitalizeFirstLetter(r),S=capitalizeFirstLetter(x),C="computed"+b;if("auto"==this[x])this[C]=this["_image"+b]/100;else{"height"==r&&this._computeDimension("width");let x=this["computed"+S]/this["_image"+S];this[C]=this["_image"+b]*x||0}return this._computeUnpaddedAndMarginedDimensions(r,this[C]),this[C]}updateLayout(r){let x=this.computedHeight,b=this.computedWidth;super.updateLayout(r),this._updateFit(x,b)}_updateFit(r,x){let b=this.computedHeight,S=this.computedWidth;if((r!=this.computedHeight||x!=this.computedWidth)&&this?._texture?.image)if("cover"==this.textureFit){let C=S/b;if(C!=x/r){let r=this._texture.image.width/this._texture.image.height;C<r?(this._texture.repeat.x=C/r,this._texture.repeat.y=1,this._texture.offset.x=(1-this._texture.repeat.x)/2,this._texture.offset.y=0):(this._texture.repeat.x=1,this._texture.repeat.y=r/C,this._texture.offset.x=0,this._texture.offset.y=(1-this._texture.repeat.y)/2)}}else this._texture.repeat.x=1,this._texture.repeat.y=1,this._texture.offset.x=0,this._texture.offset.y=0}updateTexture(x){x?x instanceof r.Texture?this._updateTexture(x.bypassCloning?x:x.clone()):(new r.TextureLoader).load(x,(x=>{x.colorSpace=r.SRGBColorSpace,this._updateTexture(x)}),(()=>{}),(()=>{console.error("Couldn't load image :(")})):(this._texture&&this._texture.dispose(),this._texture=null,this.material.map=null,this.material.needsUpdate=!0)}_updateTexture(r){let x=this._texture;this._texture=r,this._imageWidth=r.image.width,this._imageHeight=r.image.height,this.material.map=r,this.material.needsUpdate=!0,this.updateLayout(),this._updateFit(-1,1),x&&x.dispose()}createBackground(){super.createBackground();let r=this.computedWidth/2,x=this.computedHeight/2,b=this._background.geometry.attributes.position,S=this._background.geometry.attributes.uv;for(let C=0;C<b.count;C++)Ls.fromBufferAttribute(b,C),S.setXY(C,(Ls.x+r)/this.computedWidth,(Ls.y+x)/this.computedHeight)}}class HueSaturationWheel extends Image{constructor(r,...x){super(r,...x)}createBackground(){this._defaults.borderRadius=Math.min(this.computedHeight,this.computedHeight)/2,super.createBackground()}}const Os=new r.Plane,Ds=new r.Vector3,Us=256,Fs=128;class HSLColor{constructor(r,...x){this._hue=171,this._saturation=1,this._lightness=.5,this._radius=r||.1,this._createTextures(x),this._createCursors()}_createTextures(x){let b=2*this._radius,S=document.createElement("canvas"),C=document.createElement("canvas");S.width=256,S.height=256,C.width=1,C.height=Us,this._colorContext=S.getContext("2d"),this._lightnessContext=C.getContext("2d"),this._updateColorWheel(),this._updateLightnessBar(),this._colorTexture=new r.CanvasTexture(S),this._colorTexture.colorSpace=r.SRGBColorSpace,this._colorTexture.bypassCloning=!0,this._lightnessTexture=new r.CanvasTexture(C),this._lightnessTexture.colorSpace=r.SRGBColorSpace,this._lightnessTexture.bypassCloning=!0,this.hueSaturationWheel=new HueSaturationWheel(this._colorTexture,{height:b,width:b},...x),this.lightnessBar=new Image(this._lightnessTexture,{borderRadius:b/20,height:b,width:b/10},...x),this.hueSaturationWheel.pointerInteractable.addEventListener("down",(r=>this.hueSaturationWheel.pointerInteractable.capture(r.owner))),this.hueSaturationWheel.onClick=r=>{this._handleColorCursorDrag(r),this._onBlur&&this._onBlur(this.getColor())},this.hueSaturationWheel.onDrag=r=>{this._handleColorCursorDrag(r)},this.lightnessBar.pointerInteractable.addEventListener("down",(r=>this.lightnessBar.pointerInteractable.capture(r.owner))),this.lightnessBar.onClick=r=>{this._handleLightnessCursorDrag(r),this._onBlur&&this._onBlur(this.getColor())},this.lightnessBar.onDrag=r=>{this._handleLightnessCursorDrag(r)}}_updateColorWheel(){let r=this._colorContext.getImageData(0,0,256,256),x=r.data;this._drawColorWheel(x),this._colorContext.putImageData(r,0,0)}_drawColorWheel(r){let x=this._lightness;for(let b=-128;b<=Fs;b++){let S=b*b,C=Math.ceil(Math.sqrt(16384-S));for(let S=-C;S<=C;S++){let[C,I]=cartesianToPolar(b,S);if(C>Fs)continue;let A=4*(b+Fs+(S+Fs)*256),R=radiansToDegrees(I),B=C/Fs,[D,F,G]=hslToRGB(R,B,x);r[A]=D,r[A+1]=F,r[A+2]=G,r[A+3]=255}}}_updateLightnessBar(){let r=this._lightnessContext.getImageData(0,0,1,Us),x=r.data;for(let r=0;r<1;r++)for(let b=0;b<Us;b++){let S=4*(r+1*b),C=this._hue,I=this._saturation,A=1-b/Us,[R,B,D]=hslToRGB(C,I,A);x[S]=R,x[S+1]=B,x[S+2]=D,x[S+3]=255}this._lightnessContext.putImageData(r,0,0)}_handleColorCursorDrag(r){let{owner:x,point:b}=r;b||(Os.set(Ds.set(0,0,1),0),Os.applyMatrix4(this.hueSaturationWheel.matrixWorld),b=x.raycaster.ray.intersectPlane(Os,Ds)),Ds.copy(b),this.hueSaturationWheel.worldToLocal(Ds);let S=this.selectColorFromXY(Ds.x,Ds.y);null!=S&&this._onChange&&(this._onChange(S),this._updateColorCursor(),this._colorCursor.visible||(this._colorCursor.visible=!0))}_handleLightnessCursorDrag(r){let{owner:x,point:b}=r;b||(Os.set(Ds.set(0,0,1),0),Os.applyMatrix4(this.lightnessBar.matrixWorld),b=x.raycaster.ray.intersectPlane(Os,Ds)),Ds.copy(b),this.lightnessBar.worldToLocal(Ds);let S=this.selectLightnessFromXY(Ds.x,Ds.y);null!=S&&this._onChange&&(this._onChange(S),this._updateLightnessCursor(),this._lightnessCursor.visible||(this._lightnessCursor.visible=!0))}_createCursors(){let x=new r.RingGeometry(this._radius/12,this._radius/10,16),b=new r.MeshBasicMaterial({color:16777215,side:r.FrontSide,transparent:!0,polygonOffset:!0,polygonOffsetFactor:-10,polygonOffsetUnits:-10});this._colorCursor=new r.Mesh(x,b),this._colorCursor.position.setZ(2e-8),this.hueSaturationWheel.add(this._colorCursor),this._colorCursor.visible=!1,x=new r.RingGeometry(this._radius/9,this._radius/7.5,4,1,Math.PI/4);let S=x.getAttribute("position");for(let r=0;r<S.count;r++){let x=S.getY(r);x>0&&S.setY(r,x-this._radius/20),x<0&&S.setY(r,x+this._radius/20)}this._lightnessCursor=new r.Mesh(x,b),this._lightnessCursor.position.setZ(2e-8),this.lightnessBar.add(this._lightnessCursor),this._lightnessCursor.visible=!1}_updateColorCursor(){let[r,x]=this.getXY(this._radius);Ds.set(r,-x,0),this._colorCursor.position.setX(Ds.x),this._colorCursor.position.setY(Ds.y);let b=this._colorCursor.material,S=this.hueSaturationWheel._materialOffset+1;b.polygonOffsetFactor!=-1*S&&(b.polygonOffsetFactor=-1*S,b.polygonOffsetUnits=-1*S,this._colorCursor.renderOrder=S)}_updateLightnessCursor(){let r=this.getLightness(this._radius);Ds.set(0,(r-.5)*this._radius*2,0),this._lightnessCursor.position.setX(Ds.x),this._lightnessCursor.position.setY(Ds.y)}getColorTexture(){return this._colorTexture}getLightnessTexture(){return this._lightnessTexture}getXY(x){return polarToCartesian(this._saturation*x,r.MathUtils.degToRad(this._hue+180))}getLightness(){return this._lightness}setFromHSL(r){this._hue=360*r.h,this._saturation=r.s,this._lightness=r.l,this._updateColorWheel(),this._updateColorCursor(),this._updateLightnessBar(),this._updateLightnessCursor(),this._colorTexture.needsUpdate=!0,this._lightnessTexture.needsUpdate=!0}selectColorFromXY(r,x){let[b,S]=cartesianToPolar(r,x);b>this._radius&&(b=this._radius);let C=radiansToDegrees(-S),I=b/this._radius;return this._hue=C,this._saturation=I,this._updateLightnessBar(),this._lightnessTexture.needsUpdate=!0,this.getColor()}selectLightnessFromXY(r,x){let b=x/(2*this._radius)+.5;return b<0&&(b=0),b>1&&(b=1),this._lightness=b,this._updateColorWheel(),this._colorTexture.needsUpdate=!0,this.getColor()}getColor(){let[r,x,b]=hslToRGB(this._hue,this._saturation,this._lightness);return rgbToHex(r,x,b)}isDragging(){return this.hueSaturationWheel.pointerInteractable.state==bt.SELECTED||bt.SELECTED==this.lightnessBar.pointerInteractable.state}get onBlur(){return this._onBlur}get onChange(){return this._onChange}get radius(){return this._radius}set onBlur(r){this._onBlur=r}set onChange(r){this._onChange=r}set radius(r){this._radius=r}}class Span extends ScrollableComponent{constructor(...r){super(...r),this._defaults.contentDirection="row"}}class TextComponent extends LayoutComponent{constructor(r,...x){super(...x),this._defaults.color=0,this._defaults.fontSize=.1,this._defaults.textAlign="left",this._text=new Text,this._content.add(this._text),this.font&&(this._text.font=this.font),this._text.color=this.color,this._text.fontSize=this.fontSize,this._text.textAlign=this.textAlign,this._text.anchorX="center",this._text.anchorY="middle",this._text.overflowWrap="break-word",typeof this.maxWidth==Number&&(this._text.maxWidth=this.maxWidth),this._text.addEventListener("synccomplete",(()=>this._updateLayout())),this._text.sync(),this._text.text=r||"",this._text.sync(),"visible"!=this.overflow&&(this._text.material.clippingPlanes=this._getClippingPlanes())}_handleStyleUpdateForColor(){this._text.color=this.color}_handleStyleUpdateForFont(){this._text.font=this.font,"auto"!=this.width&&"auto"!=this.height||this._updateLayout()}_handleStyleUpdateForFontSize(){this._text.fontSize=this.fontSize,"auto"!=this.width&&"auto"!=this.height||this._updateLayout()}_handleStyleUpdateForTextAlign(){this._text.textAlign=this.textAlign}_handleStyleUpdateForMaxWidth(){null!=this.maxWidth?"number"==typeof this.maxWidth&&(this._text.maxWidth=this.maxWidth):this._text.maxWidth=null,super._handleStyleUpdateForMaxWidth()}_computeDimension(r,x){if("auto"!=this[x||r]){let b=super._computeDimension(r,x);return"width"==r&&(this._text.maxWidth=b),b}let b=capitalizeFirstLetter(r),S="computed"+b,C="max"+b,I="min"+b,A=this._text.textRenderInfo;if(A){let x=A.blockBounds;this[S]="width"==r?Math.abs(x[0]-x[2]):Math.abs(x[1]-x[3])}if(x)return this[S];if(0==this[S]&&null!=this[I])this._computeDimension(r,I);else if("width"==r&&this[C]){let x=this[S];this._computeDimension(r,C),this._text.maxWidth=this[S],x<this[S]&&(this[S]=x)}return this._computeUnpaddedAndMarginedDimensions(r,this[S]),this[S]}_updateMaterialOffset(r){super._updateMaterialOffset(r),this._text.depthOffset=-1*this._materialOffset-1,this._text.renderOrder=this._materialOffset+1}get text(){return this._text.text}get troikaText(){return this._text}set text(r){this._text.text=r,this._text.sync()}}const Gs={name:"English",pages:[{style:{padding:.01},rows:[{keys:["q","w",{text:"e",type:"key",value:"e",additionalCharacters:["","","",""]},"r","t","y",{text:"u",type:"key",value:"u",additionalCharacters:["","","",""]},{text:"i",type:"key",value:"i",additionalCharacters:["","","",""]},{text:"o",type:"key",value:"o",additionalCharacters:["","","","",""]},"p"]},{keys:[{text:"a",type:"key",value:"a",additionalCharacters:["","","",""]},"s","d","f","g","h","j","k","l"]},{keys:[{text:"",type:"shift",style:{width:.155}},"z","x",{text:"c",type:"key",value:"c",additionalCharacters:[""]},"v","b",{text:"n",type:"key",value:"n",additionalCharacters:[""]},"m",{text:"",type:"key",value:"Backspace",style:{width:.155}}]},{keys:[{text:"123",type:"page",page:1,style:{width:.155}},",",{text:"space",type:"key",value:" ",style:{width:.539}},".",{text:"",type:"key",value:"Enter",style:{width:.155}}]}]},{style:{padding:.01},rows:[{keys:["1","2","3","4","5","6","7","8","9","0"]},{keys:["-","/",":",";","(",")","$","&","@",'"']},{keys:[{text:"#+=",type:"page",page:2,style:{width:.155,marginRight:.115}},".",",","?","!","'",{text:"",type:"key",value:"Backspace",style:{width:.155,marginLeft:.115}}]},{keys:[{text:"ABC",type:"page",page:0,style:{width:.155}},{text:"space",type:"key",value:" ",style:{width:.759}},{text:"",type:"key",value:"Enter",style:{width:.155}}]}]},{style:{padding:.01},rows:[{keys:["[","]","{","}","#","%","^","*","+","="]},{keys:["_","\\","|","~","<",">","","","",""]},{style:{justifyContent:"spaceBetween",width:"100%"},keys:[{text:"123",type:"page",page:1,style:{width:.155,marginRight:.115}},".",",","?","!","'",{text:"",type:"key",value:"Backspace",style:{width:.155,marginLeft:.115}}]},{keys:[{text:"ABC",type:"page",page:0,style:{width:.155}},{text:"space",type:"key",value:" ",style:{width:.759}},{text:"",type:"key",value:"Enter",style:{width:.155}}]}]}]},Ns={name:"Numbers",pages:[{style:{padding:.01},rows:[{keys:["1","2","3"]},{keys:["4","5","6"]},{keys:["7","8","9"]},{keys:[".","0",{text:"",type:"key",value:"Backspace"}]},{keys:["",{text:"",type:"key",value:"Enter",style:{width:.21}}]}]}]},Hs={name:"",pages:[{style:{padding:.01},rows:[{keys:["","","","","","","","","","","",""]},{keys:["","","","","","","","","","","",""]},{keys:[{text:"",type:"shift",style:{width:.155}},"","","","","","","","","",{text:"",type:"key",value:"Backspace",style:{width:.155}}]},{keys:[{text:"123",type:"page",page:1,style:{width:.155}},",",{text:"space",type:"key",value:" ",style:{width:.539}},".",{text:"",type:"key",value:"Enter",style:{width:.155}}]}]},{style:{padding:.01,marginLeft:.11,marginRight:.11},rows:[{keys:["1","2","3","4","5","6","7","8","9","0"]},{keys:["@","#",":",";","%","-","+","=","(",")"]},{keys:[{text:"~[<",type:"page",page:2,style:{width:.155}},".",",","?","!",'"',"'","",{text:"",type:"key",value:"Backspace",style:{width:.155}}]},{keys:[{text:"",type:"page",page:0,style:{width:.155}},"\\",{text:"space",type:"key",value:" ",style:{width:.539}},"/",{text:"",type:"key",value:"Enter",style:{width:.155}}]}]},{style:{padding:.01,marginLeft:.11,marginRight:.11},rows:[{keys:["[","]","{","}","`","^","*","&","",""]},{keys:["$","","","","","_","|","~","<",">"]},{style:{justifyContent:"spaceBetween",width:"100%"},keys:[{text:"123",type:"page",page:1,style:{width:.155}},".",",","?","!",'"',"'","",{text:"",type:"key",value:"Backspace",style:{width:.155}}]},{keys:[{text:"",type:"page",page:0,style:{width:.155}},"\\",{text:"space",type:"key",value:" ",style:{width:.539}},"/",{text:"",type:"key",value:"Enter",style:{width:.155}}]}]}]},Ws={name:"",pages:[{style:{padding:.01},rows:[{keys:["","","","","","","","","",""]},{keys:["","","","","","","","","",""]},{keys:["","","","","","","","","",""]},{keys:[{text:"",type:"page",page:3,style:{width:.155}},{text:"",type:"page",page:1,style:{width:.155}},{text:"space",type:"key",value:" ",style:{width:.429}},{text:"",type:"key",value:"Enter",style:{width:.155}},{text:"",type:"key",value:"Backspace",style:{width:.155}}]}]},{style:{padding:.01},rows:[{keys:["","","","","","","","","",""]},{keys:["","","","","","","","","",""]},{keys:["","","","","","","","","",""]},{keys:[{text:"",type:"page",page:0,style:{width:.155}},{text:"",type:"page",page:2,style:{width:.155}},{text:"space",type:"key",value:" ",style:{width:.429}},{text:"",type:"key",value:"Enter",style:{width:.155}},{text:"",type:"key",value:"Backspace",style:{width:.155}}]}]},{style:{padding:.01},rows:[{keys:["","","","","","","","","",""]},{keys:["","","","","","","","","",""]},{keys:["","","","","","","","","",""]},{keys:[{text:"",type:"page",page:1,style:{width:.155}},{text:"",type:"page",page:3,style:{width:.155}},{text:"space",type:"key",value:" ",style:{width:.429}},{text:"",type:"key",value:"Enter",style:{width:.155}},{text:"",type:"key",value:"Backspace",style:{width:.155}}]}]},{style:{padding:.01},rows:[{keys:["","","","","","","","","",""]},{keys:["","","","","","","","","",""]},{keys:["","","","","","","","","",""]},{keys:[{text:"",type:"page",page:2,style:{width:.155}},{text:"",type:"page",page:0,style:{width:.155}},{text:"space",type:"key",value:" ",style:{width:.429}},{text:"",type:"key",value:"Enter",style:{width:.155}},{text:"",type:"key",value:"Backspace",style:{width:.155}}]}]}]},zs=new Style({backgroundVisible:!0,borderRadius:.01,height:.1,justifyContent:"center",margin:.005,paddingLeft:.02,paddingRight:.02,width:.1}),js=new Style({material:new r.MeshBasicMaterial({color:15790320,side:r.DoubleSide,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1})}),Vs={fontSize:.065},Xs="UNSHIFTED",qs="SHIFTED",$s="CAPS_LOCK";function getComponentBody(r){for(;r&&!(r instanceof Body);)r=r.parent;return r}let Ks=new class extends InteractableComponent{constructor(...r){super(...r),this.bypassContentPositioning=!0,this._defaults.backgroundVisible=!0,this._defaults.materialColor=12633550,this._layouts={},this._keyboardPageLayouts=[],this._timeoutIds=new Map,this._updateListeners=new Map,this._setupGrabBar(),this._createOptionsPanel(),this._addLayout(Gs),this._addLayout(Hs),this._addLayout(Ws),this._setLayout(Gs),this.types={NUMBER:"NUMBER"},this.onClick=()=>{}}createBackground(){this._defaults.borderRadius=Math.min(this.computedHeight,this.computedHeight)/20,super.createBackground()}_createOptionsPanel(){this._optionsPanelParent=new r.Object3D,this.add(this._optionsPanelParent),this._optionsPanel=new Div({backgroundVisible:!0,borderRadius:.06,height:.12,justifyContent:"center",materialColor:12633550,width:.12});let x=new Div({backgroundVisible:!0,borderRadius:.05,height:.1,justifyContent:"center",width:.1}),b=new TextComponent("",Vs);this._optionsPanel.add(x),x.add(b),x.pointerInteractable.addHoveredCallback((r=>{r?x.addStyle(js):x.removeStyle(js)})),x.onClick=x.onTouch=()=>{this._setLanguagesPage()}}_addOptionsPanel(){this._optionsPanelParent.add(this._optionsPanel),this._optionsPanelParent.position.x=this.computedWidth/-2-.1}_addLayout(r){this._layouts[r.name]=r}_setLayout(r){if("string"!=typeof r||(r=this._layouts[r])){for(let r of this._content.children)r instanceof LayoutComponent&&this.remove(r);this._keyboardLayout=r,this._keyboardPageLayouts=[],this._keyboardPage=null,this._shiftState=Xs,this._setPage(0)}}_setPage(r){if(this._keyboardPage==r)return;for(let r of this._content.children)r instanceof LayoutComponent&&this.remove(r);if(this._keyboardPage=r,this._keyboardPageLayouts[r])return this.add(this._keyboardPageLayouts[r]),void this._addOptionsPanel();let x=new Div(this._keyboardLayout.pages[r].style);for(let b of this._keyboardLayout.pages[r].rows){let S=new Span(b.style);for(let x of b.keys){let b=new Div(zs,x.style),C=x;"string"!=typeof x&&(C=x.text);let I=new TextComponent(C,Vs);b.add(I),S.add(b),b.pointerInteractable.addHoveredCallback((r=>{r?b.addStyle(js):b.removeStyle(js)})),"string"!=typeof x&&x.additionalCharacters&&this._addAdditionalCharacters(b,x);let listener=()=>{if(this._registeredComponent)if("string"==typeof x){let x=this._shiftState==Xs?C:C.toUpperCase();this._registeredComponent.handleKey(x),this._shiftState==qs&&x!=C&&(this._shiftState=Xs,this._shiftCase(r,!1))}else if("key"==x.type){let b=this._shiftState==Xs||x.value.length>1?x.value:x.value.toUpperCase();this._registeredComponent.handleKey(b),this._shiftState==qs&&b!=x.value&&(this._shiftState=Xs,this._shiftCase(r,!1))}else"page"==x.type?(this._shiftState!=Xs&&(this._shiftState=Xs,this._shiftCase(r,!1)),this._setPage(x.page)):"shift"==x.type&&(this._shiftState==Xs?(this._shiftState=qs,this._shiftCase(r,!0)):this._shiftState==qs?this._shiftState=$s:this._shiftState==$s&&(this._shiftState=Xs,this._shiftCase(r,!1)))};b.pointerInteractable.addEventListener("click",listener),b.touchInteractable.addEventListener("click",listener)}x.add(S)}this._keyboardPageLayouts[r]=x,this.add(x),this._addOptionsPanel(),this._reposition()}_addAdditionalCharacters(r,x){r.pointerInteractable.addEventListener("down",(b=>{let S=b.owner;if(b.additionalCharactersOwner)return;this._timeoutIds.set(S,setTimeout((()=>{this._displayAdditionalCharacters(r,x),this._timeoutIds.delete(S)}),500)),r.additionalCharactersOwner=S;let outCallback=x=>{x.owner==S&&(this._timeoutIds.has(S)&&(clearTimeout(this._timeoutIds.get(S)),this._timeoutIds.delete(S),Vr.remove(this._updateListeners.get(S)),delete r.additionalCharactersOwner),r.pointerInteractable.removeEventListener("out",outCallback))};r.pointerInteractable.addEventListener("out",outCallback),this._updateListeners.set(S,(()=>{let x;x="XR"==Kr.active?this._isXRControllerPressed(S):"POINTER"==Kr.active?xi.isPointerPressed():xi.isScreenTouched(),x||(this._timeoutIds.has(S)&&(clearTimeout(this._timeoutIds.get(S)),this._timeoutIds.delete(S)),r.additionalCharactersSpan&&r.remove(r.additionalCharactersSpan),r.pointerInteractable.removeEventListener("out",outCallback),Vr.remove(this._updateListeners.get(S)),delete r.additionalCharactersOwner)})),Vr.add(this._updateListeners.get(S))}))}_isXRControllerPressed(r){let x=r.object.xrInputDeviceType,b=r.object.handedness;if(x==Zr.HAND){let r=xi.getXRControllerModel(x,b);return 1==r?.motionController?.isPinching}{let r=xi.getXRGamepad(b);return null!=r?.buttons&&r.buttons[0].pressed}}_displayAdditionalCharacters(r,x){if(r.additionalCharactersSpan)return r.additionalCharactersSpan.borderRadius=this.borderRadius,r.additionalCharactersSpan._updateMaterialOffset(r._materialOffset+1),void r.add(r.additionalCharactersSpan);let b=x.additionalCharacters,S=new Span({backgroundVisible:!0,materialColor:12633550});S.bypassContentPositioning=!0,S.position.y=r.computedHeight;for(let r of b){let b=new Div(zs,x.style),C=new TextComponent(r,Vs);this._shiftState!=Xs&&(C.text=C.text.toUpperCase()),b.add(C),S.add(b),b.pointerInteractable.addEventListener("over",(()=>{b.addStyle(js)})),b.pointerInteractable.addEventListener("out",(()=>{b.removeStyle(js)})),b.pointerInteractable.addEventListener("up",(()=>{let x=this._shiftState==Xs?r:r.toUpperCase();this._registeredComponent.handleKey(x),this._shiftState==qs&&(this._shiftState=Xs,this._shiftCase(this._keyboardPage,!1))}))}S.borderRadius=this.borderRadius;let C=r?.parentComponent?.parentComponent?.padding;C&&(S.padding=C,S.position.y+=C),S._updateMaterialOffset(r._materialOffset+1),r.additionalCharactersSpan=S,r.add(S)}_setLanguagesPage(){for(let r of this._content.children)r instanceof LayoutComponent&&this.remove(r);let r,x=0,b=new Div({padding:.01});for(let S in this._layouts){x%2==0&&(r=new Span,b.add(r)),x++;let C=new Div(zs,{width:.3}),I=new TextComponent(S,Vs);C.add(I),r.add(C),C.pointerInteractable.addHoveredCallback((r=>{r?C.addStyle(js):C.removeStyle(js)})),C.onClick=C.onTouch=()=>{this._setLayout(S)}}this.add(b),this._optionsPanelParent.remove(this._optionsPanel),this._reposition()}_setNumberPage(){this._lastKeyboardLayout||(this._lastKeyboardLayout=this._keyboardLayout),this._setLayout(Ns),this._optionsPanelParent.remove(this._optionsPanel)}_shiftCase(r,x){let b=x?"toUpperCase":"toLowerCase";for(let x of this._keyboardPageLayouts[r]._content.children)for(let r of x._content.children){let x=r._content.children[0];if(1==x.text.length&&(x.text=x.text[b]()),r.additionalCharactersSpan){let x=r.additionalCharactersSpan._content.children;for(let r of x){let x=r._content.children[0];x.text=x.text[b]()}}}}_reposition(){if(this._placeGrabBar(),!this._onPopup&&this._registeredComponent){let r=getComponentBody(this._registeredComponent);if(r||(r=this._registeredComponent),this.parent!=r)return;this.position.set(0,(-r.computedHeight-this.computedHeight*this.scale.y)/2-.025,0)}}register(r,x){this._registeredComponent&&this._registeredComponent.blur(),this._registeredComponent=r;let b=getComponentBody(r);x==this.types.NUMBER&&this._setNumberPage(),this._placeGrabBar(),this._onPopup?this._onPopup(r,b):(b||(b=r),this.position.set(0,(-b.computedHeight-this.computedHeight*this.scale.y)/2-.025,0),this.rotation.set(0,0,0),b.add(this),this._updateMaterialOffset(r._materialOffset))}unregister(r){this._registeredComponent==r&&(this._registeredComponent=null,this.parent&&this.parent.remove(this),this._grabBarOwner=this._priorParent=null),this._lastKeyboardLayout&&(this._setLayout(this._lastKeyboardLayout),this._lastKeyboardLayout=null)}_placeGrabBar(){this._grabBar.position.y=-this.computedHeight/2-.025}_setupGrabBar(){this._grabBar=new Body({backgroundVisible:!1,borderRadius:.025,height:.05,justifyContent:"center",width:.21});let r=new Div({backgroundVisible:!0,borderRadius:.01,height:.02,materialColor:12633550,width:.2});this._grabBar.pointerInteractable.addHoveredCallback((x=>{r.material.color.set(x?16777215:12633550)})),this._grabBar.pointerInteractable.addEventListener("down",(r=>{this._grabBarOwner||(this._priorParent=this.parent),this._grabBarOwner=r.owner,r.owner.object.attach(this),this._grabBar.pointerInteractable.capture(r.owner)})),this._grabBar.pointerInteractable.addEventListener("click",(r=>{this.parent==r.owner.object&&(this._priorParent.attach(this),this._grabBarOwner=this._priorParent=null)})),this._grabBar.add(r),this.add(this._grabBar)}get onPopup(){return this._onPopup}set onPopup(r){this._onPopup=r}};let Ys=new class{constructor(){this._listeners=new Set}setup(){"XR"!=Kr.active&&(this._eventType="TOUCH_SCREEN"==Kr.active?"touchend":"click",this._clickListener=()=>{setTimeout((()=>{for(let r of this._listeners)r(),this._listeners.delete(r)}),30)},document.addEventListener(this._eventType,this._clickListener))}trigger(r){this._listeners.add(r)}};var Zs;!function(r){r[r.HIGH_SURROGATE_START=55296]="HIGH_SURROGATE_START",r[r.HIGH_SURROGATE_END=56319]="HIGH_SURROGATE_END",r[r.LOW_SURROGATE_START=56320]="LOW_SURROGATE_START",r[r.REGIONAL_INDICATOR_START=127462]="REGIONAL_INDICATOR_START",r[r.REGIONAL_INDICATOR_END=127487]="REGIONAL_INDICATOR_END",r[r.FITZPATRICK_MODIFIER_START=127995]="FITZPATRICK_MODIFIER_START",r[r.FITZPATRICK_MODIFIER_END=127999]="FITZPATRICK_MODIFIER_END",r[r.VARIATION_MODIFIER_START=65024]="VARIATION_MODIFIER_START",r[r.VARIATION_MODIFIER_END=65039]="VARIATION_MODIFIER_END",r[r.DIACRITICAL_MARKS_START=8400]="DIACRITICAL_MARKS_START",r[r.DIACRITICAL_MARKS_END=8447]="DIACRITICAL_MARKS_END",r[r.SUBDIVISION_INDICATOR_START=127988]="SUBDIVISION_INDICATOR_START",r[r.TAGS_START=917504]="TAGS_START",r[r.TAGS_END=917631]="TAGS_END",r[r.ZWJ=8205]="ZWJ"}(Zs||(Zs={}));const Js=Object.freeze([776,2359,2367,2984,3007,3021,3633,3635,3648,3657,4352,4449,4520]);var Qs;function runes(r){if("string"!=typeof r)throw new TypeError("string cannot be undefined or null");const x=[];let b=0,S=0;for(;b<r.length;)S+=nextUnits(b+S,r),isGrapheme(r[b+S])&&S++,isVariationSelector(r[b+S])&&S++,isDiacriticalMark(r[b+S])&&S++,isZeroWidthJoiner(r[b+S])?S++:(x.push(r.substring(b,b+S)),b+=S,S=0);return x}function nextUnits(r,x){const b=x[r];if(!function(r){return r&&betweenInclusive(r[0].charCodeAt(0),55296,56319)}(b)||r===x.length-1)return 1;const S=b+x[r+1];let C=x.substring(r+2,r+5);return isRegionalIndicator(S)&&isRegionalIndicator(C)?4:function(r){return betweenInclusive(codePointFromSurrogatePair(r),127988,127988)}(S)&&function(r){const x=r.codePointAt(0);return"string"==typeof r&&"number"==typeof x&&betweenInclusive(x,917504,917631)}(C)?x.slice(r).indexOf(String.fromCodePoint(917631))+2:function(r){return betweenInclusive(codePointFromSurrogatePair(r),127995,127999)}(C)?4:2}function isRegionalIndicator(r){return betweenInclusive(codePointFromSurrogatePair(r),127462,127487)}function isVariationSelector(r){return"string"==typeof r&&betweenInclusive(r.charCodeAt(0),65024,65039)}function isDiacriticalMark(r){return"string"==typeof r&&betweenInclusive(r.charCodeAt(0),8400,8447)}function isGrapheme(r){return"string"==typeof r&&Js.includes(r.charCodeAt(0))}function isZeroWidthJoiner(r){return"string"==typeof r&&8205===r.charCodeAt(0)}function codePointFromSurrogatePair(r){return(r.charCodeAt(0)-55296<<10)+(r.charCodeAt(1)-56320)+65536}function betweenInclusive(r,x,b){return r>=x&&r<=b}!function(r){r[r.unit_1=1]="unit_1",r[r.unit_2=2]="unit_2",r[r.unit_4=4]="unit_4"}(Qs||(Qs={}));const eo=new r.Vector3,to=new Set,no=new Set;to.add("ArrowLeft"),to.add("ArrowRight"),to.add("ArrowUp"),to.add("ArrowDown"),no.add("Alt"),no.add("Backspace"),no.add("CapsLock"),no.add("Control"),no.add("Enter"),no.add("Escape"),no.add("Meta"),no.add("Shift"),no.add("Tab");class TextArea extends ScrollableComponent{constructor(...r){super(...r),this._defaults.alignItems="start",this._defaults.backgroundVisible=!0,this._defaults.borderMaterial.color.set(5197647),this._defaults.borderWidth=.002,this._defaults.color=0,this._defaults.contentDirection="row",this._defaults.justifyContent="start",this._defaults.fontSize=.06,this._defaults.overflow="scroll",this._defaults.paddingLeft=.01,this._defaults.height=.1,this._defaults.width=.4,this._latestValue.overflow=null,this._value=[],this._runeLengths=[],this._textStyle=new Style({color:this.color,fontSize:this.fontSize,textAlign:"left",maxWidth:0,minHeight:0}),this._text=new TextComponent("",this._textStyle),this._placeholder=new TextComponent("",this._textStyle,{color:8421504}),this._placeholder.troikaText.material.opacity=.75,this._content.add(this._text),this._content.add(this._placeholder),this._createCaret(),this.onClick=r=>this._select(r),this.onTouch=r=>this._selectTouch(r),this._keyListener=r=>this.handleKey(r.key),this._pasteListener=r=>this._handlePaste(r),this._downListener=r=>{let x=r.target;for(;x;){if(x==Ks||x==this)return;x=x.parent}this.blur()},this._syncCompleteListener=()=>{this._updateCaret(),this._checkForCaretScroll()},"visible"==this.overflow||this.clippingPlanes||this._createClippingPlanes()}_handleStyleUpdateForColor(){this._textStyle.color=this.color}_handleStyleUpdateForFontSize(){this._textStyle.fontSize=this.fontSize}_computeUnpaddedAndMarginedDimensions(r,x){super._computeUnpaddedAndMarginedDimensions(r,x),"width"==r&&this._textStyle.maxWidth!=this.unpaddedWidth&&(this._textStyle.maxWidth=this.unpaddedWidth)}_updateMaterialOffset(r){super._updateMaterialOffset(r),this._caret._updateMaterialOffset(this._materialOffset+1)}_selectTouch(r){let x=this.touchInteractable.getClosestPointTo(r.owner.object),b=x[1].object,S=b.bvhGeometry.index.array[3*x[1].faceIndex],C=b.bvhGeometry.getAttribute("position");eo.fromBufferAttribute(C,S),b.localToWorld(eo),this._select({point:eo})}_select(r){let{point:x}=r;if(!x)return;this._textStyle.minHeight!=this._caret.computedHeight&&(this._textStyle.minHeight=this._caret.computedHeight),this._text._content.add(this._caretParent);let b=this._text._text;b.worldToLocal(eo.copy(x));let S=getCaretAtPoint(b.textRenderInfo,eo.x,eo.y);this._setCaretIndexFromCharIndex(S.charIndex),this._updateCaret(),this._hasListeners||this._addListeners()}_addListeners(){this._hasListeners=!0,"XR"==Kr.active?(Ks.register(this),Ti.addEventListener("down",this._downListener)):"TOUCH_SCREEN"==Kr.active?this._displayMobileTextArea():(document.addEventListener("keydown",this._keyListener),document.addEventListener("paste",this._pasteListener),Ti.addEventListener("down",this._downListener)),this._text._text.addEventListener("synccomplete",this._syncCompleteListener),this._onFocus&&this._onFocus()}_removeListeners(){this._hasListeners=!1,"XR"==Kr.active?(Ks.unregister(this),Ti.removeEventListener("down",this._downListener)):"TOUCH_SCREEN"==Kr.active?document.body.removeChild(this._mobileTextAreaParent):(document.removeEventListener("keydown",this._keyListener),document.removeEventListener("paste",this._pasteListener),Ti.removeEventListener("down",this._downListener)),this._text._text.removeEventListener("synccomplete",this._syncCompleteListener),this._text._content.remove(this._caretParent),this._triggerBlurCallback()}_triggerBlurCallback(){this._onBlur&&this._onBlur(this._text.text)}_triggerChangeCallback(){this._onChange&&this._onChange(this._text.text)}_displayMobileTextArea(){if(!this._mobileTextArea){let r=document.createElement("div"),x=document.createElement("textarea");x.rows=5,x.style.fontSize="16px",x.style.minWidth="250px",x.style.width="33%",r.style.width="100%",r.style.height="100%",r.style.position="fixed",r.style.top="0px",r.style.left="0px",r.style.display="flex",r.style.justifyContent="center",r.style.alignItems="center",r.style.backgroundColor="#00000069",r.appendChild(x),r.onclick=b=>{b.target==r&&(this._text.text=x.value,this.blur())},x.onblur=()=>{this._text.text=x.value,this.blur()},x.addEventListener("compositionend",(()=>{this._text.text!=x.value&&(this._text.text=x.value,this._triggerChangeCallback())})),x.onkeyup=()=>{this._text.text!=x.value&&(this._text.text=x.value,this._triggerChangeCallback())},this._mobileTextAreaParent=r,this._mobileTextArea=x}document.body.appendChild(this._mobileTextAreaParent),Ys.trigger((()=>this._mobileTextArea.click()))}_createCaret(){this._caretParent=new r.Object3D,this._caret=new TextComponent("|",this._textStyle),this._caret._text.fillOpacity=.75,this._caretParent.add(this._caret)}_getCharIndex(r=this._caretIndex){let x=0;for(let b=0;b<r;b++)x+=this._runeLengths[b];return x}_setCaretIndexFromCharIndex(r=0){let x,b=0,S=0;for(x=0;x<this._runeLengths.length&&b<r;x++)S=b,b+=this._runeLengths[x];let C=Math.abs(r-b),I=Math.abs(r-S);this._caretIndex=b==r||C<I?x:x-1}_updateCaret(){let r=this._getCharIndex(),x=4*r,b=0;if(r==this._text.text.length){if(0==r)return void this._caretParent.position.set(0,0,0);x-=4,b=1}let S=this._text._text.textRenderInfo.caretPositions,C=S[x+b],I=(S[x+2]+S[x+3])/2;isNaN(I)||this._caretParent.position.set(C,I,0)}handleKey(r){xi.isKeyPressed("Control")||xi.isKeyPressed("Meta")||("Backspace"==r?this._deleteChar():"Enter"==r?this.insertContent("\n"):"Escape"==r?this.blur():to.has(r)?this._moveCaret(r):no.has(r)||this.insertContent(r))}_handlePaste(r){if(r.clipboardData.types.indexOf("text/plain")<0)return;let x=r.clipboardData.getData("text/plain");this.insertContent(x),r.preventDefault()}_moveCaret(r){if("ArrowLeft"==r)this._caretIndex>0&&(this._caretIndex--,this._updateCaret());else if("ArrowRight"==r)this._caretIndex<this._value.length&&(this._caretIndex++,this._updateCaret());else{let x=this._getCharIndex(),b=this._text.text,S="ArrowUp"==r?1:-1,C=4*x,I=0;this._caretIndex==b.length&&0!=this._caretIndex&&(C-=4,I=1);let A=this._text._text,R=A.textRenderInfo.caretPositions,B=R[C+I],D=(R[C+2]+R[C+3])/2,F=Math.abs(R[C+2]-R[C+3]),G=getCaretAtPoint(A.textRenderInfo,B,D+S*F);this._setCaretIndexFromCharIndex(G.charIndex),this._updateCaret()}this._checkForCaretScroll()}_deleteChar(){0!=this._caretIndex&&(this._value.splice(this._caretIndex-1,1),this._runeLengths.splice(this._caretIndex-1,1),this._text.text=this._value.join(""),this._caretIndex--,this._updateCaret(),0!=this._value.length||this._placeholder.parentComponent||this._content.add(this._placeholder),this._triggerChangeCallback())}_checkForCaretScroll(){if(!this._scrollable&&0!=this._content.position.y)return void(this._content.position.y=0);eo.copy(this._caretParent.position),this._caretParent.parent.localToWorld(eo),this.worldToLocal(eo);let r=this.computedHeight/2,x=this._caret.computedHeight/2;eo.y+x>r?this._content.position.y+=r-eo.y-x:eo.y-x<this.computedHeight/-2&&(this._content.position.y+=-r-eo.y+x)}_sanitizeText(){}blur(){this._hasListeners&&this._removeListeners()}insertContent(r){let x=runes(r);this._value.splice(this._caretIndex,0,...x),this._text.text=this._value.join("");for(let r=0;r<x.length;r++)this._runeLengths.splice(this._caretIndex,0,x[r].length),this._caretIndex++;this._sanitizeText(),this._placeholder.parentComponent&&this._content.remove(this._placeholder),this._triggerChangeCallback()}get onBlur(){return this._onBlur}get onChange(){return this._onChange}get onFocus(){return this._onFocus}get placeholder(){return this._placeholder.text}get value(){return this._text.text}set onBlur(r){this._onBlur=r}set onChange(r){this._onChange=r}set onFocus(r){this._onFocus=r}set placeholder(r){this._placeholder.text=r}set value(r){r||(r=""),this._value=runes(r),this._text.text=r,this._runeLengths=[];for(let r=0;r<this._value.length;r++)this._runeLengths.push(this._value[r].length);0==this._value.length?this._placeholder.parentComponent||this._content.add(this._placeholder):this._placeholder.parentComponent&&this._content.remove(this._placeholder)}}const ro=new r.Vector3,io=new Set,so=new Set;io.add("ArrowLeft"),io.add("ArrowRight"),so.add("ArrowUp"),so.add("ArrowDown"),so.add("Alt"),so.add("Backspace"),so.add("CapsLock"),so.add("Control"),so.add("Enter"),so.add("Escape"),so.add("Meta"),so.add("Shift"),so.add("Tab");class TextInput extends TextArea{constructor(...r){super(...r),this._defaults.alignItems="center",this._latestValue.alignItems=null,this._text._overrideStyle.maxWidth=null,this._text._text.whiteSpace="nowrap"}_displayMobileTextArea(){if(!this._mobileTextArea){let r=document.createElement("div"),x=document.createElement("input");x.type="text",x.style.fontSize="16px",x.style.minWidth="250px",x.style.width="33%",r.style.width="100%",r.style.height="100%",r.style.position="fixed",r.style.top="0px",r.style.left="0px",r.style.display="flex",r.style.justifyContent="center",r.style.alignItems="center",r.style.backgroundColor="#00000069",r.appendChild(x),r.onclick=b=>{b.target==r&&(this._text.text=x.value,this.blur())},x.onblur=()=>{this._text.text=x.value,this.blur()},x.addEventListener("compositionend",(()=>{this._text.text!=x.value&&(this._text.text=x.value,this._triggerChangeCallback())})),x.onkeyup=r=>{"Enter"!=r.code?this._text.text!=x.value&&(this._text.text=x.value,this._triggerChangeCallback()):this._onEnter&&this._onEnter(this._text.text)},this._mobileTextAreaParent=r,this._mobileTextArea=x}document.body.appendChild(this._mobileTextAreaParent),Ys.trigger((()=>this._mobileTextArea.click()))}handleKey(r){xi.isKeyPressed("Control")||xi.isKeyPressed("Meta")||("Backspace"==r?this._deleteChar():"Enter"==r?this._onEnter&&this._onEnter(this._text.text):"Escape"==r?this.blur():io.has(r)?this._moveCaret(r):so.has(r)||this.insertContent(r))}_handlePaste(r){if(r.clipboardData.types.indexOf("text/plain")<0)return;let x=r.clipboardData.getData("text/plain");this.insertContent(x.replaceAll("\n"," ")),r.preventDefault()}_moveCaret(r){"ArrowLeft"==r?this._caretIndex>0&&(this._caretIndex--,this._updateCaret()):"ArrowRight"==r&&this._caretIndex<this._value.length&&(this._caretIndex++,this._updateCaret()),this._checkForCaretScroll()}_checkForCaretScroll(){if(!this._scrollable&&0!=this._content.position.x)return void(this._content.position.x=0);ro.copy(this._caretParent.position),this._caretParent.parent.localToWorld(ro),this.worldToLocal(ro);let r=this.computedWidth/2,x=this._caret.computedWidth/2;ro.x+x>r?this._content.position.x+=r-ro.x-x:ro.x-x<this.computedWidth/-2&&(this._content.position.x+=-r-ro.x+x)}get onEnter(){return this._onEnter}get value(){return super.value}set onEnter(r){this._onEnter=r}set value(r){r||(r=""),r=r.replaceAll("\n"," "),super.value=r}}const oo=new r.Vector3,ao=new Set,lo=new Set;ao.add("ArrowLeft"),ao.add("ArrowRight"),lo.add("e"),lo.add("E"),lo.add("+");class NumberInput extends TextInput{constructor(...r){super(...r),this._defaults.alignItems="center",this._latestValue.alignItems=null,this._text._overrideStyle.maxWidth=null,this._text._text.whiteSpace="nowrap",this._minValue=-1/0,this._maxValue=1/0,this._lastValidValue=""}_addListeners(){this._hasListeners=!0,"XR"==Kr.active?(Ks.register(this,Ks.types.NUMBER),Ti.addEventListener("down",this._downListener)):"TOUCH_SCREEN"==Kr.active?this._displayMobileTextArea():(document.addEventListener("keydown",this._keyListener),document.addEventListener("paste",this._pasteListener),Ti.addEventListener("down",this._downListener)),this._text._text.addEventListener("synccomplete",this._syncCompleteListener),this._onFocus&&this._onFocus()}_displayMobileTextArea(){if(!this._mobileTextArea){let r=document.createElement("div"),x=document.createElement("input");x.type="text",x.inputMode="decimal",x.style.fontSize="16px",x.style.minWidth="250px",x.style.width="33%",r.style.width="100%",r.style.height="100%",r.style.position="fixed",r.style.top="0px",r.style.left="0px",r.style.display="flex",r.style.justifyContent="center",r.style.alignItems="center",r.style.backgroundColor="#00000069",r.appendChild(x),r.onclick=b=>{b.target==r&&(this._text.text=x.value,this.blur())},x.onblur=()=>{this._text.text=x.value,this.blur()},x.onkeydown=r=>{(lo.has(r.key)||x.value.includes(".")&&"."==r.key||!r.key.match(/^[0-9.-]*$/)&&"Backspace"!=r.key&&"Enter"!=r.key)&&r.preventDefault()},x.onkeyup=r=>{"Enter"!=r.key?this._text.text!=x.value&&(this._text.text=x.value,this._triggerChangeCallback()):this._onEnter&&this._onEnter(this._text.text)},this._mobileTextAreaParent=r,this._mobileTextArea=x}document.body.appendChild(this._mobileTextAreaParent),Ys.trigger((()=>this._mobileTextArea.click()))}handleKey(r){xi.isKeyPressed("Control")||xi.isKeyPressed("Meta")||("Backspace"==r?this._deleteChar():"Enter"==r?this._onEnter&&this._onEnter(this._text.text):"Escape"==r?this.blur():""==r?this._negate():ao.has(r)?this._moveCaret(r):r.match(/^[0-9.-]*$/)&&this.insertContent(r))}_handlePaste(r){if(r.clipboardData.types.indexOf("text/plain")<0)return;let x=r.clipboardData.getData("text/plain");this.insertContent(x),r.preventDefault()}_checkForCaretScroll(){if(!this._scrollable&&0!=this._content.position.x)return void(this._content.position.x=0);oo.copy(this._caretParent.position),this._caretParent.parent.localToWorld(oo),this.worldToLocal(oo);let r=this.computedWidth/2,x=this._caret.computedWidth/2;oo.x+x>r?this._content.position.x+=r-oo.x-x:oo.x-x<this.computedWidth/-2&&(this._content.position.x+=-r-oo.x+x)}_triggerBlurCallback(){let r=Number.parseFloat(this._text.text);isNaN(r)?this.value=this._lastValidValue:"number"==typeof this._minValue&&r<this._minValue?this.value=this._minValue:"number"==typeof this._maxValue&&r>this._maxValue&&(this.value=this._maxValue),this._lastValidValue=this._text.text,this._onBlur&&this._onBlur(this._text.text)}_triggerChangeCallback(){let r=Number.parseFloat(this._text.text);isNaN(r)||"number"==typeof this._minValue&&r<this._minValue||"number"==typeof this._maxValue&&r>this._maxValue||(this._lastValidValue=this._text.text,this._onChange&&this._onChange(this._text.text))}_sanitizeIncomingText(r,x){let b=!1,S=!1;return r=r.replaceAll(/[^0-9.-]/g,""),x&&(-1!=x.indexOf(".")&&(b=!0),-1!=x.indexOf("-")&&(S=!0)),b?r=r.replaceAll(".",""):-1!=r.indexOf(".")&&(r=r.split(".")[0]+"."+r.split(".").slice(1).join("")),S?r=r.replaceAll("-",""):-1!=r.indexOf("-")&&(r="-"+r.replaceAll("-","")),r}_negate(){this._text.text.indexOf("-")>=0?(this.value=this._text.text.replaceAll("-",""),this._moveCaret("ArrowLeft")):(this.value="-"+this.value,this._moveCaret("ArrowRight"))}_sanitizeScientificNotation(r){let x=r.toString().split("e"),b=x[0].replaceAll(".",""),S=Math.abs(x[1])-1,C="0."+"0".repeat(S)+b;return C.indexOf("-")>-1&&(C="-"+C.replace("-","")),C}_sanitizeText(){this._text.text.indexOf("-")>0&&(this.value="-"+this._text.text.replaceAll("-",""))}insertContent(r){r=this._sanitizeIncomingText(r,this._text.text),super.insertContent(r)}get maxValue(){return this._maxValue}get minValue(){return this._minValue}get onEnter(){return this._onEnter}get value(){return super.value}set maxValue(r){this._maxValue=r}set minValue(r){this._minValue=r}set onEnter(r){this._onEnter=r}set value(r){null==r&&(r=Math.max(this._minValue,0)),r=0==r?"0":Math.abs(r)<=1e-7?this._sanitizeScientificNotation(r):this._sanitizeIncomingText(String(r)),super.value=r,this._lastValidValue=this._text.text}}const co={},ho=new r.MeshBasicMaterial({color:12543,side:r.DoubleSide,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1});class Radio extends InteractableComponent{constructor(r,...x){super(...x),this._defaults.backgroundVisible=!0,this._defaults.borderMaterial.color.set(5197647),this._defaults.borderWidth=.002,this._defaults.height=.08,this._defaults.materialColor=16777215,this._defaults.width=.08,this._name=r,this._toggleMaterial=ho.clone(),this.onClick=this.onTouch=()=>this._select(),r in co||(co[r]=new Set),co[r].add(this)}createBackground(){this._defaults.borderRadius=Math.min(this.computedHeight,this.computedHeight)/2,super.createBackground(),this._toggleChild?.parent&&this._toggleChild.parent.remove(this._toggleChild),this._toggleChild=new r.Mesh(this._background.geometry,this._toggleMaterial),this._background.add(this._toggleChild),this._toggleChild.scale.set(.75,.75,.75),this._toggleChild.visible=!!this._selected,this.borderMaterial.color.set(this._selected?12543:5197647)}_updateMaterialOffset(r){super._updateMaterialOffset(r),this._toggleMaterial.polygonOffsetFactor=this._toggleMaterial.polygonOffsetUnits=-1*this._materialOffset-1,this._toggleChild&&(this._toggleChild.renderOrder=this._materialOffset+1)}_select(r){for(let r of co[this._name])r!=this&&r.unselect();this._selected=!0,this.borderMaterial.color.set(12543),this._toggleChild&&(this._toggleChild.visible=!0),r||(this._onChange&&this._onChange(this._selected),this._onSelect&&this._onSelect())}_unselect(r){this._selected=!1,this.borderMaterial.color.set(5197647),this._toggleChild&&(this._toggleChild.visible=!1),this._onChange&&!r&&this._onChange(this._selected)}select(){this._select()}unselect(){this._unselect()}get onChange(){return this._onChange}get onSelect(){return this._onSelect}get selected(){return this._selected}set onChange(r){this._onChange=r}set onSelect(r){this._onSelect=r}set selected(r){r!=this._selected&&(r?this._select(!0):this.unselect(!0))}}const uo=new r.MeshBasicMaterial({color:12543,side:r.DoubleSide,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1}),po=new r.Vector3,fo=new r.Plane;class Range extends InteractableComponent{constructor(...r){super(...r),this._defaults.backgroundVisible=!0,this._defaults.borderMaterial.color.set(5197647),this._defaults.borderWidth=.002,this._defaults.height=.02,this._defaults.materialColor=16777215,this._defaults.width=.4,this._value=0,this._scrubberMaterial=uo.clone(),this._scrubbingOwner,this.pointerInteractable.addEventListener("down",(r=>this.pointerInteractable.capture(r.owner))),this.onClick=r=>this._select(r),this.onTouch=r=>this._touchSelect(r),this.onDrag=r=>this._drag(r),this.onTouchDrag=r=>this._touchDrag(r)}createBackground(){this._defaults.borderRadius=Math.min(this.computedHeight,this.computedWidth)/2,super.createBackground(),this._scrubberChild?.parent&&this._scrubberChild.parent.remove(this._scrubberChild),this._scrubberValue?.parent&&this._scrubberValue.parent.remove(this._scrubberValue);let x=new r.CircleGeometry(1.5*this.computedHeight);this._scrubberChild=new r.Mesh(x,this._scrubberMaterial),this._scrubberValue=new r.Mesh(this._background.geometry,this._scrubberMaterial),this._background.add(this._scrubberChild),this._background.add(this._scrubberValue),this._updateScrubber()}_updateScrubber(){this._scrubberChild&&(this._scrubberChild.position.setX((this._value-.5)*this.width),this._scrubberValue.scale.setX(this._value),this._scrubberValue.position.setX(this.width*(this._value-1)/2))}_updateMaterialOffset(r){super._updateMaterialOffset(r),this._scrubberMaterial.polygonOffsetFactor=this._scrubberMaterial.polygonOffsetUnits=-1*this._materialOffset-1,this._scrubberChild&&(this._scrubberChild.renderOrder=this._materialOffset+1)}_select(r){let{owner:x,point:b}=r;this._scrubbingOwner==x&&(this._updateValue(x,b),this._scrubbingOwner=null,this._onBlur&&this._onBlur(this._value))}_touchSelect(r){this._scrubbingOwner==r.owner&&(this._scrubbingOwner=null,this._onBlur&&this._onBlur(this._value))}_drag(r){let{owner:x,point:b}=r;this._updateValue(x,b)&&this._onChange&&this._onChange(this._value)}_touchDrag(r){let x=r.owner;this._updateValueFromTouch(x)&&this._onChange&&this._onChange(this._value)}_updateValue(r,x){if(this._scrubbingOwner){if(this._scrubbingOwner!=r)return!1}else this._scrubbingOwner=r;if(x?x=po.copy(x):(fo.set(po.set(0,0,1),0),fo.applyMatrix4(this.matrixWorld),x=r.raycaster.ray.intersectPlane(fo,po)),x){let r=(x=this.worldToLocal(x)).x/this.width+.5;r=Math.max(0,Math.min(r,1));let b=this._value!=r;return this._value=r,b&&this._updateScrubber(),b}return!1}_updateValueFromTouch(r){if(this._scrubbingOwner){if(this._scrubbingOwner!=r)return!1}else{this._scrubbingOwner=r;let x=this.touchInteractable.getClosestPointTo(r.object);this._touchController=x[1].object,this._scrollVertex=this._touchController.bvhGeometry.index.array[3*x[1].faceIndex]}let x=this._touchController.bvhGeometry.getAttribute("position");po.fromBufferAttribute(x,this._scrollVertex),this._touchController.localToWorld(po),this.worldToLocal(po);let b=po.x/this.width+.5;b=Math.max(0,Math.min(b,1));let S=this._value!=b;return this._value=b,S&&this._updateScrubber(),S}get onBlur(){return this._onBlur}get onChange(){return this._onChange}get value(){return this._value}set onBlur(r){this._onBlur=r}set onChange(r){this._onChange=r}set value(r){this._value=Math.max(0,Math.min(r,1)),this._updateScrubber()}}class Select extends ScrollableComponent{constructor(...r){super(...r),this._defaults.backgroundVisible=!0,this._defaults.borderMaterial.color.set(5197647),this._defaults.borderWidth=.002,this._defaults.height=.1,this._defaults.width=.4,this._optionsDivStyle=new Style({backgroundVisible:this.backgroundVisible,borderMaterial:this.borderMaterial.clone(),borderWidth:this.borderWidth,overflow:"scroll",paddingBottom:this.borderWidth,paddingTop:this.borderWidth,width:this.width}),this._optionsDiv=new Div(this._optionsDivStyle),this._optionsDiv._content.position.z*=3,this._optionsStyle=new Style({backgroundVisible:this.backgroundVisible,width:"90%"}),this.pointerInteractableClassOverride&&(this._optionsStyle.pointerInteractableClassOverride=this.pointerInteractableClassOverride),this._optionsTextStyle=new Style({maxWidth:"100%"}),this.padding&&(this._optionsTextStyle.padding=this.padding),this._value,this._options=[],this._textSpan=new Span({alignItems:"start",justifyContent:"spaceBetween",height:"100%",overflow:"hidden",width:"90%"}),this._text=new TextComponent(" ",this._optionsTextStyle,{maxWidth:"85%",minWidth:"85%"}),this._text._text.lineHeight=1/.55,this._caret=new TextComponent(""),this._caret._text.anchorY="85%",this._content.add(this._textSpan),this._textSpan.add(this._text),this._textSpan.add(this._caret),this._downListener=r=>{let x=r.target;for(;x;){if(x==this)return;x=x.parent}this.hideOptions()},this.onClick=this.onTouch=()=>this._select()}updateLayout(r){super.updateLayout(r),this._optionsStyle.minHeight!=this.computedHeight&&(this._optionsStyle.minHeight=this.computedHeight),this._optionsTextStyle.minWidth!=.9*this.unpaddedWidth&&(this._optionsTextStyle.minWidth=.9*this.unpaddedWidth),this._optionsTextStyle.fontSize!=.55*this.unpaddedHeight&&(this._optionsTextStyle.fontSize=.55*this.unpaddedHeight,this._caret.fontSize=.8*this.unpaddedHeight)}_handleStyleUpdateForWidth(){super._handleStyleUpdateForWidth(),this._optionsDivStyle.width=this.width}_select(){this.remove(this._textSpan),this.add(this._optionsDiv),this._optionsDiv._updateMaterialOffset(this._materialOffset+3),this.onClick=this.onTouch=null,Ti.addEventListener("down",this._downListener)}_selectOption(r){let x=this._value!=r;this._value=r,this._text.text=r,this.hideOptions(),x&&this._onChange&&this._onChange(this._value)}addOptions(...r){for(let x of r){let r=new Span(this._optionsStyle),b=new TextComponent(x,this._optionsTextStyle);r.onClick=r.onTouch=()=>this._selectOption(b.text),r.add(b),r.pointerInteractable.addStateCallback((x=>{x==bt.HOVERED?r.material.color.set(30207):x==bt.IDLE&&r.material.color.set(16777215)})),this._optionsDiv.add(r)}}hideOptions(){this.remove(this._optionsDiv),this.add(this._textSpan),this.onClick=this.onTouch=()=>this._select(),Ti.removeEventListener("down",this._downListener)}get maxDisplayOptions(){return this._maxDisplayOptions}get onChange(){return this._onChange}get value(){return this._value}set maxDisplayOptions(r){this._maxDisplayOptions=r,this._optionsDivStyle.maxHeight=null==r?null:100*this._maxDisplayOptions+"%"}set onChange(r){this._onChange=r}set value(r){this._value=r,this._text.text=r}}const go=new r.MeshBasicMaterial({color:16777215,side:r.DoubleSide,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1});class Toggle extends InteractableComponent{constructor(...r){super(...r),this._defaults.backgroundVisible=!0,this._defaults.color=16777215,this._defaults.height=.08,this._defaults.materialColor=13421772,this._defaults.width=.14,this._toggleMaterial=go.clone(),this.onClick=this.onTouch=()=>this._change()}createBackground(){super.createBackground(),this._toggleChild?.parent&&this._toggleChild.parent.remove(this._toggleChild);let x=this.borderRadius||0,b=numberOr(this.borderTopLeftRadius,x),S=numberOr(this.borderTopRightRadius,x),C=numberOr(this.borderBottomLeftRadius,x),I=numberOr(this.borderBottomRightRadius,x),A=.24*this.computedHeight,R=this.computedHeight-A,B=(this.computedWidth-A)/2;this._toggleOffset=(this.computedWidth-B-A)/2,b=Math.max(b-A/2,0),S=Math.max(S-A/2,0),C=Math.max(C-A/2,0),I=Math.max(I-A/2,0);let D=this._materialOffset+1,F=this.createShape(B,R,b,S,C,I),G=new r.ShapeGeometry(F);this._toggleChild=new r.Mesh(G,this._toggleMaterial),this._toggleChild.renderOrder=D,this._background.add(this._toggleChild),this._checked?this._toggleChild.position.setX(this._toggleOffset):this._toggleChild.position.setX(-this._toggleOffset)}_updateMaterialOffset(r){super._updateMaterialOffset(r),this._toggleMaterial.polygonOffsetFactor=this._toggleMaterial.polygonOffsetUnits=-1*this._materialOffset-1,this._toggleChild&&(this._toggleChild.renderOrder=this._materialOffset+1)}_change(){this._checked=!this._checked,this._checked?(this.materialColor=12543,this._toggleChild&&this._toggleChild.position.setX(this._toggleOffset)):(this.materialColor=13421772,this._toggleChild&&this._toggleChild.position.setX(-this._toggleOffset)),this._onChange&&this._onChange(this._checked)}get checked(){return this._checked}get onChange(){return this._onChange}set checked(r){r!=this._checked&&(this._checked=r,r?(this.materialColor=12543,this._toggleChild&&this._toggleChild.position.setX(this._toggleOffset)):(this.materialColor=13421772,this._toggleChild&&this._toggleChild.position.setX(-this._toggleOffset)))}set onChange(r){this._onChange=r}}const mo=new r.Vector3;class GripInteractable extends Interactable{constructor(r){super(r),r&&(r.gripInteractable=this),this._createBoundingObject()}_createBoundingObject(){this._boundingBox=new r.Box3}_getBoundingObject(){return this._boundingBox.setFromObject(this._object),this._boundingBox}intersectsSphere(r){let x,b=this._getBoundingObject();return x=!!b&&r.intersectsBox(b),x}distanceToSphere(r){return r.distanceToPoint(this._boundingBox.getCenter(mo))}get object(){return this._object}set object(r){this._object=r,r&&(r.gripInteractable=this)}}let _o=new class extends InteractableHandler{constructor(){super()}init(x){super.init(),this._scene=x,this._sphere=new r.Sphere,this._box3=new r.Box3}_getBoundingSphere(r){return r?(this._box3.setFromObject(r).getBoundingSphere(this._sphere),this._sphere):null}_isXRControllerPressed(r,x){if(r==Zr.HAND){let b=xi.getXRControllerModel(r,x);return 1==b?.motionController?.isGrabbing}{let r=xi.getXRGamepad(x);return null!=r?.buttons&&r.buttons[1].pressed}}_scopeInteractables(r,x){let b=r.boundingSphere;if(null!=b)for(let S of x){if((0!=S.children.size&&this._scopeInteractables(r,S.children),null!=S.object&&!S.isOnlyGroup())&&S.intersectsSphere(b)){let x=S.distanceToSphere(b);x<r.closestPointDistance&&(r.closestPointDistance=x,r.closestInteractable=S)}}}_updateInteractables(r){let x=r.owner,b=r.isPressed,S=this._hoveredInteractables.get(x),C=this._selectedInteractables.get(x),I=this._overInteractables.get(x),A=r.closestInteractable;A!=S&&(S&&(S.removeHoveredBy(x),this._hoveredInteractables.delete(x)),!A||(C||b)&&A!=C||(A.addHoveredBy(x),this._hoveredInteractables.set(x,A),S=A));let R={owner:x};C?(b||(C.removeSelectedBy(x),this._selectedInteractables.delete(x)),C==A?(I!=A&&(I&&I.out(R),A.over(R),this._overInteractables.set(x,A)),A.move(R),A.drag(R),b||(this._trigger("up",R,A),A.click(R))):C.isCapturedBy(x)?(C!=I&&(I&&I.out(R),C.over(R),this._overInteractables.set(x,C),I=C),C.move(R),C.drag(R),b||(this._trigger("up",R,C),C.click(R),I&&I.out(R),A?(A.over(R),this._overInteractables.set(x,A)):this._overInteractables.delete(x))):A?(I!=A&&(I&&I.out(R),A.over(R),this._overInteractables.set(x,A)),A.move(R),b||this._trigger("up",R,A)):I&&(I.out(R),this._overInteractables.delete(x))):A?(I!=A&&(I&&I.out(R),A.over(R),this._overInteractables.set(x,A)),A.move(R),b&&!this._wasPressed.get(x)?(this._trigger("down",R,A),A.addSelectedBy(x),this._selectedInteractables.set(x,A)):!b&&this._wasPressed.get(x)&&this._trigger("up",R,A)):(I&&(I.out(R),this._overInteractables.delete(x)),b?this._wasPressed.get(x)||this._trigger("down",R):this._wasPressed.get(x)&&this._trigger("up",R)),this._wasPressed.set(x,b)}_updateForXR(){for(let r in Yr){let x=!1;for(let b of[Zr.CONTROLLER,Zr.HAND]){let S=xi.getXRController(b,r,"grip"),C=xi.getXRControllerModel(b,r);if(S||(S=xi.getXRController(b,r,"targetRay")),!S)continue;let I,A,R=this._getOwner(S),B=isDescendant(this._scene,S);if(B&&(b==Zr.CONTROLLER?x=!0:x&&(B=!1)),B){I=isDescendant(S,C)?this._getBoundingSphere(C):this._getBoundingSphere(S),A=this._isXRControllerPressed(b,r)}let D={owner:R,boundingSphere:I,isPressed:A,closestPointDistance:Number.MAX_SAFE_INTEGER},F=!1;this._toolHandlers[this._tool]&&(F=this._toolHandlers[this._tool](D)),F||(this._scopeInteractables(D,this._interactables),this._updateInteractables(D))}}}};!function(r,x){"object"==typeof exports&&"object"==typeof module?module.exports=x():"function"==typeof define&&define.amd?define("nipplejs",[],x):"object"==typeof exports?exports.nipplejs=x():r.nipplejs=x()}(window,(function(){return function(r){var x={};function e(b){if(x[b])return x[b].exports;var S=x[b]={i:b,l:!1,exports:{}};return r[b].call(S.exports,S,S.exports,e),S.l=!0,S.exports}return e.m=r,e.c=x,e.d=function(r,x,b){e.o(r,x)||Object.defineProperty(r,x,{enumerable:!0,get:b})},e.r=function(r){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(r,"__esModule",{value:!0})},e.t=function(r,x){if(1&x&&(r=e(r)),8&x)return r;if(4&x&&"object"==typeof r&&r&&r.__esModule)return r;var b=Object.create(null);if(e.r(b),Object.defineProperty(b,"default",{enumerable:!0,value:r}),2&x&&"string"!=typeof r)for(var S in r)e.d(b,S,function(x){return r[x]}.bind(null,S));return b},e.n=function(r){var x=r&&r.__esModule?function(){return r.default}:function(){return r};return e.d(x,"a",x),x},e.o=function(r,x){return Object.prototype.hasOwnProperty.call(r,x)},e.p="",e(e.s=0)}([function(r,x,b){b.r(x);var S,n=function(r,x){var b=x.x-r.x,S=x.y-r.y;return Math.sqrt(b*b+S*S)},s=function(r){return r*(Math.PI/180)},C=new Map,a=function(r){C.has(r)&&clearTimeout(C.get(r)),C.set(r,setTimeout(r,100))},p=function(r,x,b){for(var S,C=x.split(/[ ,]+/g),I=0;I<C.length;I+=1)S=C[I],r.addEventListener?r.addEventListener(S,b,!1):r.attachEvent&&r.attachEvent(S,b)},c=function(r,x,b){for(var S,C=x.split(/[ ,]+/g),I=0;I<C.length;I+=1)S=C[I],r.removeEventListener?r.removeEventListener(S,b):r.detachEvent&&r.detachEvent(S,b)},l=function(r){return r.preventDefault(),r.type.match(/^touch/)?r.changedTouches:r},h=function(){return{x:void 0!==window.pageXOffset?window.pageXOffset:(document.documentElement||document.body.parentNode||document.body).scrollLeft,y:void 0!==window.pageYOffset?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop}},u=function(r,x){x.top||x.right||x.bottom||x.left?(r.style.top=x.top,r.style.right=x.right,r.style.bottom=x.bottom,r.style.left=x.left):(r.style.left=x.x+"px",r.style.top=x.y+"px")},f=function(r,x,b){var S=y(r);for(var C in S)if(S.hasOwnProperty(C))if("string"==typeof x)S[C]=x+" "+b;else{for(var I="",A=0,R=x.length;A<R;A+=1)I+=x[A]+" "+b+", ";S[C]=I.slice(0,-2)}return S},y=function(r){var x={};return x[r]="",["webkit","Moz","o"].forEach((function(b){x[b+r.charAt(0).toUpperCase()+r.slice(1)]=""})),x},m=function(r,x){for(var b in x)x.hasOwnProperty(b)&&(r[b]=x[b]);return r},v=function(r,x){if(r.length)for(var b=0,S=r.length;b<S;b+=1)x(r[b]);else x(r)},I=!!("ontouchstart"in window),A=!!window.PointerEvent,R=!!window.MSPointerEvent,B={start:"mousedown",move:"mousemove",end:"mouseup"},D={};function _(){}A?S={start:"pointerdown",move:"pointermove",end:"pointerup, pointercancel"}:R?S={start:"MSPointerDown",move:"MSPointerMove",end:"MSPointerUp"}:I?(S={start:"touchstart",move:"touchmove",end:"touchend, touchcancel"},D=B):S=B,_.prototype.on=function(r,x){var b,S=r.split(/[ ,]+/g);this._handlers_=this._handlers_||{};for(var C=0;C<S.length;C+=1)b=S[C],this._handlers_[b]=this._handlers_[b]||[],this._handlers_[b].push(x);return this},_.prototype.off=function(r,x){return this._handlers_=this._handlers_||{},void 0===r?this._handlers_={}:void 0===x?this._handlers_[r]=null:this._handlers_[r]&&this._handlers_[r].indexOf(x)>=0&&this._handlers_[r].splice(this._handlers_[r].indexOf(x),1),this},_.prototype.trigger=function(r,x){var b,S=this,C=r.split(/[ ,]+/g);S._handlers_=S._handlers_||{};for(var I=0;I<C.length;I+=1)b=C[I],S._handlers_[b]&&S._handlers_[b].length&&S._handlers_[b].forEach((function(r){r.call(S,{type:b,target:S},x)}))},_.prototype.config=function(r){this.options=this.defaults||{},r&&(this.options=function(r,x){var b={};for(var S in r)r.hasOwnProperty(S)&&x.hasOwnProperty(S)?b[S]=x[S]:r.hasOwnProperty(S)&&(b[S]=r[S]);return b}(this.options,r))},_.prototype.bindEvt=function(r,x){var b=this;return b._domHandlers_=b._domHandlers_||{},b._domHandlers_[x]=function(){"function"==typeof b["on"+x]?b["on"+x].apply(b,arguments):console.warn('[WARNING] : Missing "on'+x+'" handler.')},p(r,S[x],b._domHandlers_[x]),D[x]&&p(r,D[x],b._domHandlers_[x]),b},_.prototype.unbindEvt=function(r,x){return this._domHandlers_=this._domHandlers_||{},c(r,S[x],this._domHandlers_[x]),D[x]&&c(r,D[x],this._domHandlers_[x]),delete this._domHandlers_[x],this};var F=_;function k(r,x){return this.identifier=x.identifier,this.position=x.position,this.frontPosition=x.frontPosition,this.collection=r,this.defaults={size:100,threshold:.1,color:"white",fadeTime:250,dataOnly:!1,restJoystick:!0,restOpacity:.5,mode:"dynamic",zone:document.body,lockX:!1,lockY:!1,shape:"circle"},this.config(x),"dynamic"===this.options.mode&&(this.options.restOpacity=0),this.id=k.id,k.id+=1,this.buildEl().stylize(),this.instance={el:this.ui.el,on:this.on.bind(this),off:this.off.bind(this),show:this.show.bind(this),hide:this.hide.bind(this),add:this.addToDom.bind(this),remove:this.removeFromDom.bind(this),destroy:this.destroy.bind(this),setPosition:this.setPosition.bind(this),resetDirection:this.resetDirection.bind(this),computeDirection:this.computeDirection.bind(this),trigger:this.trigger.bind(this),position:this.position,frontPosition:this.frontPosition,ui:this.ui,identifier:this.identifier,id:this.id,options:this.options},this.instance}k.prototype=new F,k.constructor=k,k.id=0,k.prototype.buildEl=function(r){return this.ui={},this.options.dataOnly||(this.ui.el=document.createElement("div"),this.ui.back=document.createElement("div"),this.ui.front=document.createElement("div"),this.ui.el.className="nipple collection_"+this.collection.id,this.ui.back.className="back",this.ui.front.className="front",this.ui.el.setAttribute("id","nipple_"+this.collection.id+"_"+this.id),this.ui.el.appendChild(this.ui.back),this.ui.el.appendChild(this.ui.front)),this},k.prototype.stylize=function(){if(this.options.dataOnly)return this;var r=this.options.fadeTime+"ms",x=function(r,x){var b=y("borderRadius");for(var S in b)b.hasOwnProperty(S)&&(b[S]="50%");return b}(),b=f("transition","opacity",r),S={};return S.el={position:"absolute",opacity:this.options.restOpacity,display:"block",zIndex:999},S.back={position:"absolute",display:"block",width:this.options.size+"px",height:this.options.size+"px",marginLeft:-this.options.size/2+"px",marginTop:-this.options.size/2+"px",background:this.options.color,opacity:".5"},S.front={width:this.options.size/2+"px",height:this.options.size/2+"px",position:"absolute",display:"block",marginLeft:-this.options.size/4+"px",marginTop:-this.options.size/4+"px",background:this.options.color,opacity:".5",transform:"translate(0px, 0px)"},m(S.el,b),"circle"===this.options.shape&&m(S.back,x),m(S.front,x),this.applyStyles(S),this},k.prototype.applyStyles=function(r){for(var x in this.ui)if(this.ui.hasOwnProperty(x))for(var b in r[x])this.ui[x].style[b]=r[x][b];return this},k.prototype.addToDom=function(){return this.options.dataOnly||document.body.contains(this.ui.el)||this.options.zone.appendChild(this.ui.el),this},k.prototype.removeFromDom=function(){return this.options.dataOnly||!document.body.contains(this.ui.el)||this.options.zone.removeChild(this.ui.el),this},k.prototype.destroy=function(){clearTimeout(this.removeTimeout),clearTimeout(this.showTimeout),clearTimeout(this.restTimeout),this.trigger("destroyed",this.instance),this.removeFromDom(),this.off()},k.prototype.show=function(r){var x=this;return x.options.dataOnly||(clearTimeout(x.removeTimeout),clearTimeout(x.showTimeout),clearTimeout(x.restTimeout),x.addToDom(),x.restCallback(),setTimeout((function(){x.ui.el.style.opacity=1}),0),x.showTimeout=setTimeout((function(){x.trigger("shown",x.instance),"function"==typeof r&&r.call(this)}),x.options.fadeTime)),x},k.prototype.hide=function(r){var x=this;if(x.options.dataOnly)return x;if(x.ui.el.style.opacity=x.options.restOpacity,clearTimeout(x.removeTimeout),clearTimeout(x.showTimeout),clearTimeout(x.restTimeout),x.removeTimeout=setTimeout((function(){var b="dynamic"===x.options.mode?"none":"block";x.ui.el.style.display=b,"function"==typeof r&&r.call(x),x.trigger("hidden",x.instance)}),x.options.fadeTime),x.options.restJoystick){var b=x.options.restJoystick,S={};S.x=!0===b||!1!==b.x?0:x.instance.frontPosition.x,S.y=!0===b||!1!==b.y?0:x.instance.frontPosition.y,x.setPosition(r,S)}return x},k.prototype.setPosition=function(r,x){var b=this;b.frontPosition={x:x.x,y:x.y};var S=b.options.fadeTime+"ms",C={};C.front=f("transition",["transform"],S);var I={front:{}};I.front={transform:"translate("+b.frontPosition.x+"px,"+b.frontPosition.y+"px)"},b.applyStyles(C),b.applyStyles(I),b.restTimeout=setTimeout((function(){"function"==typeof r&&r.call(b),b.restCallback()}),b.options.fadeTime)},k.prototype.restCallback=function(){var r={};r.front=f("transition","none",""),this.applyStyles(r),this.trigger("rested",this.instance)},k.prototype.resetDirection=function(){this.direction={x:!1,y:!1,angle:!1}},k.prototype.computeDirection=function(r){var x,b,S,C=r.angle.radian,I=Math.PI/4,A=Math.PI/2;if(C>I&&C<3*I&&!r.lockX?x="up":C>-I&&C<=I&&!r.lockY?x="left":C>3*-I&&C<=-I&&!r.lockX?x="down":r.lockY||(x="right"),r.lockY||(b=C>-A&&C<A?"left":"right"),r.lockX||(S=C>0?"up":"down"),r.force>this.options.threshold){var R,B={};for(R in this.direction)this.direction.hasOwnProperty(R)&&(B[R]=this.direction[R]);var D={};for(R in this.direction={x:b,y:S,angle:x},r.direction=this.direction,B)B[R]===this.direction[R]&&(D[R]=!0);if(D.x&&D.y&&D.angle)return r;D.x&&D.y||this.trigger("plain",r),D.x||this.trigger("plain:"+b,r),D.y||this.trigger("plain:"+S,r),D.angle||this.trigger("dir dir:"+x,r)}else this.resetDirection();return r};var G=k;function E(r,x){this.nipples=[],this.idles=[],this.actives=[],this.ids=[],this.pressureIntervals={},this.manager=r,this.id=E.id,E.id+=1,this.defaults={zone:document.body,multitouch:!1,maxNumberOfNipples:10,mode:"dynamic",position:{top:0,left:0},catchDistance:200,size:100,threshold:.1,color:"white",fadeTime:250,dataOnly:!1,restJoystick:!0,restOpacity:.5,lockX:!1,lockY:!1,shape:"circle",dynamicPage:!1,follow:!1},this.config(x),"static"!==this.options.mode&&"semi"!==this.options.mode||(this.options.multitouch=!1),this.options.multitouch||(this.options.maxNumberOfNipples=1);var b=getComputedStyle(this.options.zone.parentElement);return b&&"flex"===b.display&&(this.parentIsFlex=!0),this.updateBox(),this.prepareNipples(),this.bindings(),this.begin(),this.nipples}E.prototype=new F,E.constructor=E,E.id=0,E.prototype.prepareNipples=function(){var r=this.nipples;r.on=this.on.bind(this),r.off=this.off.bind(this),r.options=this.options,r.destroy=this.destroy.bind(this),r.ids=this.ids,r.id=this.id,r.processOnMove=this.processOnMove.bind(this),r.processOnEnd=this.processOnEnd.bind(this),r.get=function(x){if(void 0===x)return r[0];for(var b=0,S=r.length;b<S;b+=1)if(r[b].identifier===x)return r[b];return!1}},E.prototype.bindings=function(){this.bindEvt(this.options.zone,"start"),this.options.zone.style.touchAction="none",this.options.zone.style.msTouchAction="none"},E.prototype.begin=function(){var r=this.options;if("static"===r.mode){var x=this.createNipple(r.position,this.manager.getIdentifier());x.add(),this.idles.push(x)}},E.prototype.createNipple=function(r,x){var b=this.manager.scroll,S={},C=this.options,I=this.parentIsFlex?b.x:b.x+this.box.left,A=this.parentIsFlex?b.y:b.y+this.box.top;if(r.x&&r.y)S={x:r.x-I,y:r.y-A};else if(r.top||r.right||r.bottom||r.left){var R=document.createElement("DIV");R.style.display="hidden",R.style.top=r.top,R.style.right=r.right,R.style.bottom=r.bottom,R.style.left=r.left,R.style.position="absolute",C.zone.appendChild(R);var B=R.getBoundingClientRect();C.zone.removeChild(R),S=r,r={x:B.left+b.x,y:B.top+b.y}}var D=new G(this,{color:C.color,size:C.size,threshold:C.threshold,fadeTime:C.fadeTime,dataOnly:C.dataOnly,restJoystick:C.restJoystick,restOpacity:C.restOpacity,mode:C.mode,identifier:x,position:r,zone:C.zone,frontPosition:{x:0,y:0},shape:C.shape});return C.dataOnly||(u(D.ui.el,S),u(D.ui.front,D.frontPosition)),this.nipples.push(D),this.trigger("added "+D.identifier+":added",D),this.manager.trigger("added "+D.identifier+":added",D),this.bindNipple(D),D},E.prototype.updateBox=function(){this.box=this.options.zone.getBoundingClientRect()},E.prototype.bindNipple=function(r){var x,b=this,o=function(r,S){x=r.type+" "+S.id+":"+r.type,b.trigger(x,S)};r.on("destroyed",b.onDestroyed.bind(b)),r.on("shown hidden rested dir plain",o),r.on("dir:up dir:right dir:down dir:left",o),r.on("plain:up plain:right plain:down plain:left",o)},E.prototype.pressureFn=function(r,x,b){var S=this,C=0;clearInterval(S.pressureIntervals[b]),S.pressureIntervals[b]=setInterval(function(){var b=r.force||r.pressure||r.webkitForce||0;b!==C&&(x.trigger("pressure",b),S.trigger("pressure "+x.identifier+":pressure",b),C=b)}.bind(S),100)},E.prototype.onstart=function(r){var x=this,b=x.options,S=r;return r=l(r),x.updateBox(),v(r,(function(C){x.actives.length<b.maxNumberOfNipples?x.processOnStart(C):S.type.match(/^touch/)&&(Object.keys(x.manager.ids).forEach((function(b){if(Object.values(S.touches).findIndex((function(r){return r.identifier===b}))<0){var C=[r[0]];C.identifier=b,x.processOnEnd(C)}})),x.actives.length<b.maxNumberOfNipples&&x.processOnStart(C))})),x.manager.bindDocument(),!1},E.prototype.processOnStart=function(r){var x,b=this,S=b.options,C=b.manager.getIdentifier(r),I=r.force||r.pressure||r.webkitForce||0,A={x:r.pageX,y:r.pageY},R=b.getOrCreate(C,A);R.identifier!==C&&b.manager.removeIdentifier(R.identifier),R.identifier=C;var p=function(x){x.trigger("start",x),b.trigger("start "+x.id+":start",x),x.show(),I>0&&b.pressureFn(r,x,x.identifier),b.processOnMove(r)};if((x=b.idles.indexOf(R))>=0&&b.idles.splice(x,1),b.actives.push(R),b.ids.push(R.identifier),"semi"!==S.mode)p(R);else{if(!(n(A,R.position)<=S.catchDistance))return R.destroy(),void b.processOnStart(r);p(R)}return R},E.prototype.getOrCreate=function(r,x){var b,S=this.options;return/(semi|static)/.test(S.mode)?(b=this.idles[0])?(this.idles.splice(0,1),b):"semi"===S.mode?this.createNipple(x,r):(console.warn("Coudln't find the needed nipple."),!1):b=this.createNipple(x,r)},E.prototype.processOnMove=function(r){var x=this.options,b=this.manager.getIdentifier(r),S=this.nipples.get(b),C=this.manager.scroll;if(function(r){return isNaN(r.buttons)?0!==r.pressure:0!==r.buttons}(r)){if(!S)return console.error("Found zombie joystick with ID "+b),void this.manager.removeIdentifier(b);if(x.dynamicPage){var I=S.el.getBoundingClientRect();S.position={x:C.x+I.left,y:C.y+I.top}}S.identifier=b;var A=S.options.size/2,R={x:r.pageX,y:r.pageY};x.lockX&&(R.y=S.position.y),x.lockY&&(R.x=S.position.x);var B,D,F,G,N,H,W,j,V,X,q=n(R,S.position),$=(B=R,F=(D=S.position).x-B.x,G=D.y-B.y,function(r){return r*(180/Math.PI)}(Math.atan2(G,F))),K=s($),Y=q/A,Z={distance:q,position:R};if("circle"===S.options.shape?(N=Math.min(q,A),W=S.position,j=N,X={x:0,y:0},V=s(V=$),X.x=W.x-j*Math.cos(V),X.y=W.y-j*Math.sin(V),H=X):(H=function(r,x,b){return{x:Math.min(Math.max(r.x,x.x-b),x.x+b),y:Math.min(Math.max(r.y,x.y-b),x.y+b)}}(R,S.position,A),N=n(H,S.position)),x.follow){if(q>A){var J=R.x-H.x,Q=R.y-H.y;S.position.x+=J,S.position.y+=Q,S.el.style.top=S.position.y-(this.box.top+C.y)+"px",S.el.style.left=S.position.x-(this.box.left+C.x)+"px",q=n(R,S.position)}}else R=H,q=N;var ee=R.x-S.position.x,te=R.y-S.position.y;S.frontPosition={x:ee,y:te},x.dataOnly||(S.ui.front.style.transform="translate("+ee+"px,"+te+"px)");var ne={identifier:S.identifier,position:R,force:Y,pressure:r.force||r.pressure||r.webkitForce||0,distance:q,angle:{radian:K,degree:$},vector:{x:ee/A,y:-te/A},raw:Z,instance:S,lockX:x.lockX,lockY:x.lockY};(ne=S.computeDirection(ne)).angle={radian:s(180-$),degree:180-$},S.trigger("move",ne),this.trigger("move "+S.id+":move",ne)}else this.processOnEnd(r)},E.prototype.processOnEnd=function(r){var x=this,b=x.options,S=x.manager.getIdentifier(r),C=x.nipples.get(S),I=x.manager.removeIdentifier(C.identifier);C&&(b.dataOnly||C.hide((function(){"dynamic"===b.mode&&(C.trigger("removed",C),x.trigger("removed "+C.id+":removed",C),x.manager.trigger("removed "+C.id+":removed",C),C.destroy())})),clearInterval(x.pressureIntervals[C.identifier]),C.resetDirection(),C.trigger("end",C),x.trigger("end "+C.id+":end",C),x.ids.indexOf(C.identifier)>=0&&x.ids.splice(x.ids.indexOf(C.identifier),1),x.actives.indexOf(C)>=0&&x.actives.splice(x.actives.indexOf(C),1),/(semi|static)/.test(b.mode)?x.idles.push(C):x.nipples.indexOf(C)>=0&&x.nipples.splice(x.nipples.indexOf(C),1),x.manager.unbindDocument(),/(semi|static)/.test(b.mode)&&(x.manager.ids[I.id]=I.identifier))},E.prototype.onDestroyed=function(r,x){this.nipples.indexOf(x)>=0&&this.nipples.splice(this.nipples.indexOf(x),1),this.actives.indexOf(x)>=0&&this.actives.splice(this.actives.indexOf(x),1),this.idles.indexOf(x)>=0&&this.idles.splice(this.idles.indexOf(x),1),this.ids.indexOf(x.identifier)>=0&&this.ids.splice(this.ids.indexOf(x.identifier),1),this.manager.removeIdentifier(x.identifier),this.manager.unbindDocument()},E.prototype.destroy=function(){for(var r in this.unbindEvt(this.options.zone,"start"),this.nipples.forEach((function(r){r.destroy()})),this.pressureIntervals)this.pressureIntervals.hasOwnProperty(r)&&clearInterval(this.pressureIntervals[r]);this.trigger("destroyed",this.nipples),this.manager.unbindDocument(),this.off()};var N=E;function z(r){var x=this;x.ids={},x.index=0,x.collections=[],x.scroll=h(),x.config(r),x.prepareCollections();var e=function(){var r;x.collections.forEach((function(b){b.forEach((function(b){r=b.el.getBoundingClientRect(),b.position={x:x.scroll.x+r.left,y:x.scroll.y+r.top}}))}))};p(window,"resize",(function(){a(e)}));var o=function(){x.scroll=h()};return p(window,"scroll",(function(){a(o)})),x.collections}z.prototype=new F,z.constructor=z,z.prototype.prepareCollections=function(){var r=this;r.collections.create=r.create.bind(r),r.collections.on=r.on.bind(r),r.collections.off=r.off.bind(r),r.collections.destroy=r.destroy.bind(r),r.collections.get=function(x){var b;return r.collections.every((function(r){return!(b=r.get(x))})),b}},z.prototype.create=function(r){return this.createCollection(r)},z.prototype.createCollection=function(r){var x=new N(this,r);return this.bindCollection(x),this.collections.push(x),x},z.prototype.bindCollection=function(r){var x,b=this,o=function(r,S){x=r.type+" "+S.id+":"+r.type,b.trigger(x,S)};r.on("destroyed",b.onDestroyed.bind(b)),r.on("shown hidden rested dir plain",o),r.on("dir:up dir:right dir:down dir:left",o),r.on("plain:up plain:right plain:down plain:left",o)},z.prototype.bindDocument=function(){this.binded||(this.bindEvt(document,"move").bindEvt(document,"end"),this.binded=!0)},z.prototype.unbindDocument=function(r){Object.keys(this.ids).length&&!0!==r||(this.unbindEvt(document,"move").unbindEvt(document,"end"),this.binded=!1)},z.prototype.getIdentifier=function(r){var x;return r?void 0===(x=void 0===r.identifier?r.pointerId:r.identifier)&&(x=this.latest||0):x=this.index,void 0===this.ids[x]&&(this.ids[x]=this.index,this.index+=1),this.latest=x,this.ids[x]},z.prototype.removeIdentifier=function(r){var x={};for(var b in this.ids)if(this.ids[b]===r){x.id=b,x.identifier=this.ids[b],delete this.ids[b];break}return x},z.prototype.onmove=function(r){return this.onAny("move",r),!1},z.prototype.onend=function(r){return this.onAny("end",r),!1},z.prototype.oncancel=function(r){return this.onAny("end",r),!1},z.prototype.onAny=function(r,x){var b,S=this,C="processOn"+r.charAt(0).toUpperCase()+r.slice(1);x=l(x);var s=function(r,x,b){b.ids.indexOf(x)>=0&&(b[C](r),r._found_=!0)};return v(x,(function(r){b=S.getIdentifier(r),v(S.collections,s.bind(null,r,b)),r._found_||S.removeIdentifier(b)})),!1},z.prototype.destroy=function(){this.unbindDocument(!0),this.ids={},this.index=0,this.collections.forEach((function(r){r.destroy()})),this.off()},z.prototype.onDestroyed=function(r,x){if(this.collections.indexOf(x)<0)return!1;this.collections.splice(this.collections.indexOf(x),1)};var H=new z;x.default={create:function(r){return H.create(r)},factory:H}}]).default}));const{computeBoundsTree:yo,disposeBoundsTree:vo,acceleratedRaycast:xo}=Ur;r.BufferGeometry.prototype.computeBoundsTree=yo,r.BufferGeometry.prototype.disposeBoundsTree=vo,r.Mesh.prototype.raycast=xo;const bo="0.2.2",addGripInteractable=r=>{_o.addInteractable(r)},removeGripInteractable=r=>{_o.removeInteractable(r)},addPointerInteractable=r=>{Ti.addInteractable(r)},removePointerInteractable=r=>{Ti.removeInteractable(r)},addTouchInteractable=r=>{Si.addInteractable(r)},removeTouchInteractable=r=>{Si.removeInteractable(r)};const init=async(r,x,b,S,C,I)=>{C||(await async function(){if(navigator.userAgent){let r=navigator.userAgent.toLowerCase();if(r.indexOf("iphone")>=0||r.indexOf("ipad")>=0)return!1}return"xr"in navigator&&(await navigator.xr.isSessionSupported("immersive-vr")||await navigator.xr.isSessionSupported("immersive-ar"))}()?(C="XR",x.xr.enabled||(x.xr.enabled=!0)):C="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0?"TOUCH_SCREEN":"POINTER"),Kr.active=C,x.localClippingEnabled=!0,xi.init(r,x),Ti.init(x,b,S,I),_o.init(b),Si.init(b),"XR"!=C&&Ys.setup()},update=r=>{"XR"==Kr.active&&(xi.update(r),_o.update(),Si.update()),Ti.update(),Vr.update(),jr.update(),zr.update()};export{Body,Checkbox,Ys as DelayedClickHandler,Kr as DeviceTypes,Div,GripInteractable,_o as GripInteractableHandler,HSLColor,Yr as Handedness,Image,xi as InputHandler,zr as InstancedBackgroundManager,Interactable,bt as InteractableStates,xt as InteractionToolHandler,Ks as Keyboard,jr as LayoutUpdateHandler,NumberInput,PointerInteractable,Ti as PointerInteractableHandler,Radio,Range,Select,Span,Style,TextComponent as Text,TextArea,TextInput,Ur as ThreeMeshBVH,Toggle,TouchInteractable,Si as TouchInteractableHandler,Bs as TroikaThreeText,Vr as UpdateHandler,Zr as XRInputDeviceTypes,addGripInteractable,addPointerInteractable,addTouchInteractable,init,removeGripInteractable,removePointerInteractable,removeTouchInteractable,update,Fr as utils,bo as version};
