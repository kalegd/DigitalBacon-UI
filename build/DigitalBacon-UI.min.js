/*
 * This Source Code Form is subject to the terms of the Mozilla Public
 * License, v. 2.0. If a copy of the MPL was not distributed with this
 * file, You can obtain one at https://mozilla.org/MPL/2.0/.
 */
import*as r from"three";import{Vector3 as x,Vector2 as b,Plane as S,Line3 as C,Box3 as A,Mesh as I,BatchedMesh as R,Triangle as B,Sphere as D,Matrix4 as F,BufferAttribute as G,FrontSide as N,Group as H,LineBasicMaterial as W,MeshBasicMaterial as V,DataTexture as j,NearestFilter as X,UnsignedIntType as q,IntType as K,FloatType as $,RGBAFormat as Y,RGIntegerFormat as J,BufferGeometry as Z,Matrix3 as Q,Object3D as ee,REVISION as te,Ray as ne,UnsignedByteType as re,UnsignedShortType as ie,ByteType as se,ShortType as oe,RGBAIntegerFormat as ae,Vector4 as le,RGFormat as he,RedFormat as ce,RedIntegerFormat as de,BackSide as ue,DoubleSide as pe,TrianglesDrawMode as fe,TriangleFanDrawMode as ge,TriangleStripDrawMode as me,Quaternion as _e,Loader as ye,LoaderUtils as ve,FileLoader as xe,Color as be,LinearSRGBColorSpace as Te,SpotLight as we,PointLight as Se,DirectionalLight as Ce,SRGBColorSpace as Ae,MeshPhysicalMaterial as Ie,InstancedMesh as ke,InstancedBufferAttribute as Ee,TextureLoader as Re,ImageBitmapLoader as Me,InterleavedBuffer as Be,InterleavedBufferAttribute as Pe,LinearFilter as Le,LinearMipmapLinearFilter as Oe,RepeatWrapping as De,PointsMaterial as Ue,Material as Fe,MeshStandardMaterial as Ge,PropertyBinding as Ne,SkinnedMesh as He,LineSegments as We,Line as Ve,LineLoop as ze,Points as je,PerspectiveCamera as Xe,MathUtils as qe,OrthographicCamera as Ke,Skeleton as $e,AnimationClip as Ye,Bone as Je,InterpolateLinear as Ze,ColorManagement as Qe,NearestMipmapNearestFilter as et,LinearMipmapNearestFilter as tt,NearestMipmapLinearFilter as nt,ClampToEdgeWrapping as rt,MirroredRepeatWrapping as it,InterpolateDiscrete as st,Texture as ot,VectorKeyframeTrack as at,NumberKeyframeTrack as lt,QuaternionKeyframeTrack as ht,Interpolant as ct,SphereGeometry as dt,UniformsUtils as ut,MeshDepthMaterial as pt,RGBADepthPacking as ft,MeshDistanceMaterial as gt,ShaderChunk as mt,InstancedBufferGeometry as _t,PlaneGeometry as yt,Float32BufferAttribute as vt}from"three";class Style{constructor(r={}){this._listeners=new Set;for(let x of Style.PROPERTIES)x in r&&(this["_"+x]=r[x])}addUpdateListener(r){this._listeners.add(r)}removeUpdateListener(r){this._listeners.delete(r)}_genericGet(r){return this["_"+r]}_genericSet(r,x){this["_"+r]=x;for(let x of this._listeners)x(r)}get alignItems(){return this._genericGet("alignItems")}get backgroundVisible(){return this._genericGet("backgroundVisible")}get borderMaterial(){return this._genericGet("borderMaterial")}get borderRadius(){return this._genericGet("borderRadius")}get borderBottomLeftRadius(){return this._genericGet("borderBottomLeftRadius")}get borderBottomRightRadius(){return this._genericGet("borderBottomRightRadius")}get borderTopLeftRadius(){return this._genericGet("borderTopLeftRadius")}get borderTopRightRadius(){return this._genericGet("borderTopRightRadius")}get borderWidth(){return this._genericGet("borderWidth")}get color(){return this._genericGet("color")}get contentDirection(){return this._genericGet("contentDirection")}get font(){return this._genericGet("font")}get fontSize(){return this._genericGet("fontSize")}get glassmorphism(){return this._genericGet("glassmorphism")}get height(){return this._genericGet("height")}get justifyContent(){return this._genericGet("justifyContent")}get margin(){return this._genericGet("margin")}get marginBottom(){return this._genericGet("marginBottom")}get marginLeft(){return this._genericGet("marginLeft")}get marginRight(){return this._genericGet("marginRight")}get marginTop(){return this._genericGet("marginTop")}get material(){return this._genericGet("material")}get materialColor(){return this._genericGet("materialColor")}get maxHeight(){return this._genericGet("maxHeight")}get maxWidth(){return this._genericGet("maxWidth")}get minHeight(){return this._genericGet("minHeight")}get minWidth(){return this._genericGet("minWidth")}get opacity(){return this._genericGet("opacity")}get overflow(){return this._genericGet("overflow")}get padding(){return this._genericGet("padding")}get paddingBottom(){return this._genericGet("paddingBottom")}get paddingLeft(){return this._genericGet("paddingLeft")}get paddingRight(){return this._genericGet("paddingRight")}get paddingTop(){return this._genericGet("paddingTop")}get pointerInteractableClassOverride(){return this._genericGet("pointerInteractableClassOverride")}get textAlign(){return this._genericGet("textAlign")}get textureFit(){return this._genericGet("textureFit")}get width(){return this._genericGet("width")}set alignItems(r){this._genericSet("alignItems",r)}set backgroundVisible(r){this._genericSet("backgroundVisible",r)}set borderMaterial(r){this._genericSet("borderMaterial",r)}set borderRadius(r){this._genericSet("borderRadius",r)}set borderBottomLeftRadius(r){this._genericSet("borderBottomLeftRadius",r)}set borderBottomRightRadius(r){this._genericSet("borderBottomRightRadius",r)}set borderTopLeftRadius(r){this._genericSet("borderTopLeftRadius",r)}set borderTopRightRadius(r){this._genericSet("borderTopRightRadius",r)}set borderWidth(r){this._genericSet("borderWidth",r)}set color(r){this._genericSet("color",r)}set contentDirection(r){this._genericSet("contentDirection",r)}set font(r){this._genericSet("font",r)}set fontSize(r){this._genericSet("fontSize",r)}set glassmorphism(r){this._genericSet("glassmorphism",r)}set height(r){this._genericSet("height",r)}set justifyContent(r){this._genericSet("justifyContent",r)}set margin(r){this._genericSet("margin",r)}set marginBottom(r){this._genericSet("marginBottom",r)}set marginLeft(r){this._genericSet("marginLeft",r)}set marginRight(r){this._genericSet("marginRight",r)}set marginTop(r){this._genericSet("marginTop",r)}set material(r){this._genericSet("material",r)}set materialColor(r){this._genericSet("materialColor",r)}set maxHeight(r){this._genericSet("maxHeight",r)}set maxWidth(r){this._genericSet("maxWidth",r)}set minHeight(r){this._genericSet("minHeight",r)}set minWidth(r){this._genericSet("minWidth",r)}set opacity(r){this._genericSet("opacity",r)}set overflow(r){this._genericSet("overflow",r)}set padding(r){this._genericSet("padding",r)}set paddingBottom(r){this._genericSet("paddingBottom",r)}set paddingLeft(r){this._genericSet("paddingLeft",r)}set paddingRight(r){this._genericSet("paddingRight",r)}set paddingTop(r){this._genericSet("paddingTop",r)}set pointerInteractableClassOverride(r){this._genericSet("pointerInteractableClassOverride",r)}set textAlign(r){this._genericSet("textAlign",r)}set textureFit(r){this._genericSet("textureFit",r)}set width(r){this._genericSet("width",r)}static PROPERTIES=["alignItems","backgroundVisible","borderMaterial","borderRadius","borderBottomLeftRadius","borderBottomRightRadius","borderTopLeftRadius","borderTopRightRadius","borderWidth","color","contentDirection","font","fontSize","glassmorphism","height","justifyContent","margin","marginBottom","marginLeft","marginRight","marginTop","material","materialColor","maxHeight","maxWidth","minHeight","minWidth","padding","paddingBottom","paddingLeft","paddingRight","paddingTop","pointerInteractableClassOverride","opacity","overflow","textAlign","textureFit","width"]}const xt=0,bt=1,Tt=2,wt=2,St=1.25,Ct=1,At=32,It=65535,kt=Math.pow(2,-24),Et=Symbol("SKIP_GENERATION");function getVertexCount(r){return r.index?r.index.count:r.attributes.position.count}function getTriCount(r){return getVertexCount(r)/3}function getIndexArray(r,x=ArrayBuffer){return r>65535?new Uint32Array(new x(4*r)):new Uint16Array(new x(2*r))}function getFullGeometryRange(r,x){const b=getTriCount(r),S=x||r.drawRange,C=S.start/3,A=(S.start+S.count)/3,I=Math.max(0,C),R=Math.min(b,A)-I;return[{offset:Math.floor(I),count:Math.floor(R)}]}function getRootIndexRanges(r,x){if(!r.groups||!r.groups.length)return getFullGeometryRange(r,x);const b=[],S=new Set,C=x||r.drawRange,A=C.start/3,I=(C.start+C.count)/3;for(const x of r.groups){const r=x.start/3,b=(x.start+x.count)/3;S.add(Math.max(A,r)),S.add(Math.min(I,b))}const R=Array.from(S.values()).sort(((r,x)=>r-x));for(let r=0;r<R.length-1;r++){const x=R[r],S=R[r+1];b.push({offset:Math.floor(x),count:Math.floor(S-x)})}return b}function getBounds(r,x,b,S,C){let A=1/0,I=1/0,R=1/0,B=-1/0,D=-1/0,F=-1/0,G=1/0,N=1/0,H=1/0,W=-1/0,V=-1/0,j=-1/0;for(let S=6*x,C=6*(x+b);S<C;S+=6){const x=r[S+0],b=r[S+1],C=x-b,X=x+b;C<A&&(A=C),X>B&&(B=X),x<G&&(G=x),x>W&&(W=x);const q=r[S+2],K=r[S+3],$=q-K,Y=q+K;$<I&&(I=$),Y>D&&(D=Y),q<N&&(N=q),q>V&&(V=q);const J=r[S+4],Z=r[S+5],Q=J-Z,ee=J+Z;Q<R&&(R=Q),ee>F&&(F=ee),J<H&&(H=J),J>j&&(j=J)}S[0]=A,S[1]=I,S[2]=R,S[3]=B,S[4]=D,S[5]=F,C[0]=G,C[1]=N,C[2]=H,C[3]=W,C[4]=V,C[5]=j}function arrayToBox(r,x,b){return b.min.x=x[r],b.min.y=x[r+1],b.min.z=x[r+2],b.max.x=x[r+3],b.max.y=x[r+4],b.max.z=x[r+5],b}function getLongestEdgeIndex(r){let x=-1,b=-1/0;for(let S=0;S<3;S++){const C=r[S+3]-r[S];C>b&&(b=C,x=S)}return x}function copyBounds(r,x){x.set(r)}function unionBounds(r,x,b){let S,C;for(let A=0;A<3;A++){const I=A+3;S=r[A],C=x[A],b[A]=S<C?S:C,S=r[I],C=x[I],b[I]=S>C?S:C}}function expandByTriangleBounds(r,x,b){for(let S=0;S<3;S++){const C=x[r+2*S],A=x[r+2*S+1],I=C-A,R=C+A;I<b[S]&&(b[S]=I),R>b[S+3]&&(b[S+3]=R)}}function computeSurfaceArea(r){const x=r[3]-r[0],b=r[4]-r[1],S=r[5]-r[2];return 2*(x*b+b*S+S*x)}const Rt=32,binsSort=(r,x)=>r.candidate-x.candidate,Mt=new Array(Rt).fill().map((()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0}))),Bt=new Float32Array(6);class MeshBVHNode{constructor(){this.boundingData=new Float32Array(6)}}function partition(r,x,b,S,C,A){let I=S,R=S+C-1;const B=A.pos,D=2*A.axis;for(;;){for(;I<=R&&b[6*I+D]<B;)I++;for(;I<=R&&b[6*R+D]>=B;)R--;if(!(I<R))return I;for(let r=0;r<3;r++){let b=x[3*I+r];x[3*I+r]=x[3*R+r],x[3*R+r]=b}for(let r=0;r<6;r++){let x=b[6*I+r];b[6*I+r]=b[6*R+r],b[6*R+r]=x}I++,R--}}function partition_indirect(r,x,b,S,C,A){let I=S,R=S+C-1;const B=A.pos,D=2*A.axis;for(;;){for(;I<=R&&b[6*I+D]<B;)I++;for(;I<=R&&b[6*R+D]>=B;)R--;if(!(I<R))return I;{let x=r[I];r[I]=r[R],r[R]=x;for(let r=0;r<6;r++){let x=b[6*I+r];b[6*I+r]=b[6*R+r],b[6*R+r]=x}I++,R--}}}function IS_LEAF(r,x){return 65535===x[r+15]}function OFFSET(r,x){return x[r+6]}function COUNT(r,x){return x[r+14]}function LEFT_NODE(r){return r+8}function RIGHT_NODE(r,x){return x[r+6]}function SPLIT_AXIS(r,x){return x[r+7]}let Pt,Lt,Ot,Dt;const Ut=Math.pow(2,32);function countNodes(r){return"count"in r?1:1+countNodes(r.left)+countNodes(r.right)}function populateBuffer(r,x,b){return Pt=new Float32Array(b),Lt=new Uint32Array(b),Ot=new Uint16Array(b),Dt=new Uint8Array(b),_populateBuffer(r,x)}function _populateBuffer(r,x){const b=r/4,S=r/2,C="count"in x,A=x.boundingData;for(let r=0;r<6;r++)Pt[b+r]=A[r];if(C){if(x.buffer){const S=x.buffer;Dt.set(new Uint8Array(S),r);for(let x=r,C=r+S.byteLength;x<C;x+=At){IS_LEAF(x/2,Ot)||(Lt[x/4+6]+=b)}return r+S.byteLength}{const C=x.offset,A=x.count;return Lt[b+6]=C,Ot[S+14]=A,Ot[S+15]=It,r+At}}{const S=x.left,C=x.right,A=x.splitAxis;let I;if(I=_populateBuffer(r+At,S),I/4>Ut)throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return Lt[b+6]=I/4,I=_populateBuffer(I,C),Lt[b+7]=A,I}}function buildTree(r,x,b,S,C){const{maxDepth:A,verbose:I,maxLeafTris:R,strategy:B,onProgress:D,indirect:F}=C,G=r._indirectBuffer,N=r.geometry,H=N.index?N.index.array:null,W=F?partition_indirect:partition,V=getTriCount(N),j=new Float32Array(6);let X=!1;const q=new MeshBVHNode;return getBounds(x,b,S,q.boundingData,j),function splitNode(r,b,S,C=null,D=0){!X&&D>=A&&(X=!0,I&&(console.warn(`MeshBVH: Max depth of ${A} reached when generating BVH. Consider increasing maxDepth.`),console.warn(N)));if(S<=R||D>=A)return triggerProgress(b+S),r.offset=b,r.count=S,r;const F=function(r,x,b,S,C,A){let I=-1,R=0;if(A===xt)I=getLongestEdgeIndex(x),-1!==I&&(R=(x[I]+x[I+3])/2);else if(A===bt)I=getLongestEdgeIndex(r),-1!==I&&(R=function(r,x,b,S){let C=0;for(let A=x,I=x+b;A<I;A++)C+=r[6*A+2*S];return C/b}(b,S,C,I));else if(A===Tt){const A=computeSurfaceArea(r);let B=St*C;const D=6*S,F=6*(S+C);for(let r=0;r<3;r++){const S=x[r],G=(x[r+3]-S)/Rt;if(C<Rt/4){const x=[...Mt];x.length=C;let S=0;for(let C=D;C<F;C+=6,S++){const A=x[S];A.candidate=b[C+2*r],A.count=0;const{bounds:I,leftCacheBounds:R,rightCacheBounds:B}=A;for(let r=0;r<3;r++)B[r]=1/0,B[r+3]=-1/0,R[r]=1/0,R[r+3]=-1/0,I[r]=1/0,I[r+3]=-1/0;expandByTriangleBounds(C,b,I)}x.sort(binsSort);let G=C;for(let r=0;r<G;r++){const b=x[r];for(;r+1<G&&x[r+1].candidate===b.candidate;)x.splice(r+1,1),G--}for(let S=D;S<F;S+=6){const C=b[S+2*r];for(let r=0;r<G;r++){const A=x[r];C>=A.candidate?expandByTriangleBounds(S,b,A.rightCacheBounds):(expandByTriangleBounds(S,b,A.leftCacheBounds),A.count++)}}for(let b=0;b<G;b++){const S=x[b],D=S.count,F=C-S.count,G=S.leftCacheBounds,N=S.rightCacheBounds;let H=0;0!==D&&(H=computeSurfaceArea(G)/A);let W=0;0!==F&&(W=computeSurfaceArea(N)/A);const V=Ct+St*(H*D+W*F);V<B&&(I=r,B=V,R=S.candidate)}}else{for(let r=0;r<Rt;r++){const x=Mt[r];x.count=0,x.candidate=S+G+r*G;const b=x.bounds;for(let r=0;r<3;r++)b[r]=1/0,b[r+3]=-1/0}for(let x=D;x<F;x+=6){let C=~~((b[x+2*r]-S)/G);C>=Rt&&(C=Rt-1);const A=Mt[C];A.count++,expandByTriangleBounds(x,b,A.bounds)}const x=Mt[Rt-1];copyBounds(x.bounds,x.rightCacheBounds);for(let r=Rt-2;r>=0;r--){const x=Mt[r],b=Mt[r+1];unionBounds(x.bounds,b.rightCacheBounds,x.rightCacheBounds)}let N=0;for(let x=0;x<Rt-1;x++){const b=Mt[x],S=b.count,D=b.bounds,F=Mt[x+1].rightCacheBounds;0!==S&&(0===N?copyBounds(D,Bt):unionBounds(D,Bt,Bt)),N+=S;let G=0,H=0;0!==N&&(G=computeSurfaceArea(Bt)/A);const W=C-N;0!==W&&(H=computeSurfaceArea(F)/A);const V=Ct+St*(G*N+H*W);V<B&&(I=r,B=V,R=b.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${A} used.`);return{axis:I,pos:R}}(r.boundingData,C,x,b,S,B);if(-1===F.axis)return triggerProgress(b+S),r.offset=b,r.count=S,r;const V=W(G,H,x,b,S,F);if(V===b||V===b+S)triggerProgress(b+S),r.offset=b,r.count=S;else{r.splitAxis=F.axis;const C=new MeshBVHNode,A=b,I=V-b;r.left=C,getBounds(x,A,I,C.boundingData,j),splitNode(C,A,I,j,D+1);const R=new MeshBVHNode,B=V,G=S-I;r.right=R,getBounds(x,B,G,R.boundingData,j),splitNode(R,B,G,j,D+1)}return r}(q,b,S,j),q;function triggerProgress(r){D&&D(r/V)}}function buildPackedTree(r,x){const b=r.geometry;x.indirect&&(r._indirectBuffer=function(r,x){const b=(r.index?r.index.count:r.attributes.position.count)/3,S=b>65536,C=S?4:2,A=x?new SharedArrayBuffer(b*C):new ArrayBuffer(b*C),I=S?new Uint32Array(A):new Uint16Array(A);for(let r=0,x=I.length;r<x;r++)I[r]=r;return I}(b,x.useSharedArrayBuffer),function(r,x){const b=getTriCount(r),S=getRootIndexRanges(r,x).sort(((r,x)=>r.offset-x.offset)),C=S[S.length-1];C.count=Math.min(b-C.offset,C.count);let A=0;return S.forEach((({count:r})=>A+=r)),b!==A}(b,x.range)&&!x.verbose&&console.warn('MeshBVH: Provided geometry contains groups or a range that do not fully span the vertex contents while using the "indirect" option. BVH may incorrectly report intersections on unrendered portions of the geometry.')),r._indirectBuffer||function(r,x){if(!r.index){const b=r.attributes.position.count,S=getIndexArray(b,x.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer);r.setIndex(new G(S,1));for(let r=0;r<b;r++)S[r]=r}}(b,x);const S=x.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,C=function(r,x=null,b=null,S=null){const C=r.attributes.position,A=r.index?r.index.array:null,I=getTriCount(r),R=C.normalized;let B;null===x?(B=new Float32Array(6*I*4),b=0,S=I):(B=x,b=b||0,S=S||I);const D=C.array,F=C.offset||0;let G=3;C.isInterleavedBufferAttribute&&(G=C.data.stride);const N=["getX","getY","getZ"];for(let r=b;r<b+S;r++){const x=3*r,b=6*r;let S=x+0,I=x+1,H=x+2;A&&(S=A[S],I=A[I],H=A[H]),R||(S=S*G+F,I=I*G+F,H=H*G+F);for(let r=0;r<3;r++){let x,A,F;R?(x=C[N[r]](S),A=C[N[r]](I),F=C[N[r]](H)):(x=D[S+r],A=D[I+r],F=D[H+r]);let G=x;A<G&&(G=A),F<G&&(G=F);let W=x;A>W&&(W=A),F>W&&(W=F);const V=(W-G)/2,j=2*r;B[b+j+0]=G+V,B[b+j+1]=V+(Math.abs(G)+V)*kt}}return B}(b),A=x.indirect?getFullGeometryRange(b,x.range):getRootIndexRanges(b,x.range);r._roots=A.map((b=>{const A=buildTree(r,C,b.offset,b.count,x),I=countNodes(A),R=new S(At*I);return populateBuffer(0,A,R),R}))}class SeparatingAxisBounds{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(r,x){let b=1/0,S=-1/0;for(let C=0,A=r.length;C<A;C++){const A=r[C][x];b=A<b?A:b,S=A>S?A:S}this.min=b,this.max=S}setFromPoints(r,x){let b=1/0,S=-1/0;for(let C=0,A=x.length;C<A;C++){const A=x[C],I=r.dot(A);b=I<b?I:b,S=I>S?I:S}this.min=b,this.max=S}isSeparated(r){return this.min>r.max||r.min>this.max}}SeparatingAxisBounds.prototype.setFromBox=function(){const r=new x;return function(x,b){const S=b.min,C=b.max;let A=1/0,I=-1/0;for(let b=0;b<=1;b++)for(let R=0;R<=1;R++)for(let B=0;B<=1;B++){r.x=S.x*b+C.x*(1-b),r.y=S.y*R+C.y*(1-R),r.z=S.z*B+C.z*(1-B);const D=x.dot(r);A=Math.min(D,A),I=Math.max(D,I)}this.min=A,this.max=I}}();const Ft=function(){const r=new x,b=new x,S=new x;return function(x,C,A){const I=x.start,R=r,B=C.start,D=b;S.subVectors(I,B),r.subVectors(x.end,x.start),b.subVectors(C.end,C.start);const F=S.dot(D),G=D.dot(R),N=D.dot(D),H=S.dot(R),W=R.dot(R)*N-G*G;let V,j;V=0!==W?(F*G-H*N)/W:0,j=(F+V*G)/N,A.x=V,A.y=j}}(),Gt=function(){const r=new b,S=new x,C=new x;return function(x,b,A,I){Ft(x,b,r);let R=r.x,B=r.y;if(R>=0&&R<=1&&B>=0&&B<=1)return x.at(R,A),void b.at(B,I);if(R>=0&&R<=1)return B<0?b.at(0,I):b.at(1,I),void x.closestPointToPoint(I,!0,A);if(B>=0&&B<=1)return R<0?x.at(0,A):x.at(1,A),void b.closestPointToPoint(A,!0,I);{let r,D;r=R<0?x.start:x.end,D=B<0?b.start:b.end;const F=S,G=C;return x.closestPointToPoint(D,!0,S),b.closestPointToPoint(r,!0,C),F.distanceToSquared(D)<=G.distanceToSquared(r)?(A.copy(F),void I.copy(D)):(A.copy(r),void I.copy(G))}}}(),Nt=function(){const r=new x,b=new x,A=new S,I=new C;return function(x,S){const{radius:C,center:R}=x,{a:B,b:D,c:F}=S;I.start=B,I.end=D;if(I.closestPointToPoint(R,!0,r).distanceTo(R)<=C)return!0;I.start=B,I.end=F;if(I.closestPointToPoint(R,!0,r).distanceTo(R)<=C)return!0;I.start=D,I.end=F;if(I.closestPointToPoint(R,!0,r).distanceTo(R)<=C)return!0;const G=S.getPlane(A);if(Math.abs(G.distanceToPoint(R))<=C){const r=G.projectPoint(R,b);if(S.containsPoint(r))return!0}return!1}}();function isNearZero(r){return Math.abs(r)<1e-15}class ExtendedTriangle extends B{constructor(...r){super(...r),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map((()=>new x)),this.satBounds=new Array(4).fill().map((()=>new SeparatingAxisBounds)),this.points=[this.a,this.b,this.c],this.sphere=new D,this.plane=new S,this.needsUpdate=!0}intersectsSphere(r){return Nt(r,this)}update(){const r=this.a,x=this.b,b=this.c,S=this.points,C=this.satAxes,A=this.satBounds,I=C[0],R=A[0];this.getNormal(I),R.setFromPoints(I,S);const B=C[1],D=A[1];B.subVectors(r,x),D.setFromPoints(B,S);const F=C[2],G=A[2];F.subVectors(x,b),G.setFromPoints(F,S);const N=C[3],H=A[3];N.subVectors(b,r),H.setFromPoints(N,S),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(I,r),this.needsUpdate=!1}}ExtendedTriangle.prototype.closestPointToSegment=function(){const r=new x,b=new x,S=new C;return function(x,C=null,A=null){const{start:I,end:R}=x,B=this.points;let D,F=1/0;for(let I=0;I<3;I++){const R=(I+1)%3;S.start.copy(B[I]),S.end.copy(B[R]),Gt(S,x,r,b),D=r.distanceToSquared(b),D<F&&(F=D,C&&C.copy(r),A&&A.copy(b))}return this.closestPointToPoint(I,r),D=I.distanceToSquared(r),D<F&&(F=D,C&&C.copy(r),A&&A.copy(I)),this.closestPointToPoint(R,r),D=R.distanceToSquared(r),D<F&&(F=D,C&&C.copy(r),A&&A.copy(R)),Math.sqrt(F)}}(),ExtendedTriangle.prototype.intersectsTriangle=function(){const r=new ExtendedTriangle,b=new Array(3),S=new Array(3),A=new SeparatingAxisBounds,I=new SeparatingAxisBounds,R=new x,B=new x,D=new x,F=new x,G=new x,N=new C,H=new C,W=new C,V=new x;function triIntersectPlane(r,x,b){const S=r.points;let C=0,A=-1;for(let r=0;r<3;r++){const{start:I,end:R}=N;I.copy(S[r]),R.copy(S[(r+1)%3]),N.delta(B);const D=isNearZero(x.distanceToPoint(I));if(isNearZero(x.normal.dot(B))&&D){b.copy(N),C=2;break}const F=x.intersectLine(N,V);if(!F&&D&&V.copy(I),(F||D)&&!isNearZero(V.distanceTo(R))){if(C<=1){(1===C?b.start:b.end).copy(V),D&&(A=C)}else if(C>=2){(1===A?b.start:b.end).copy(V),C=2;break}if(C++,2===C&&-1===A)break}}return C}return function(x,C=null,B=!1){this.needsUpdate&&this.update(),x.isExtendedTriangle?x.needsUpdate&&x.update():(r.copy(x),r.update(),x=r);const N=this.plane,V=x.plane;if(Math.abs(N.normal.dot(V.normal))>1-1e-10){const r=this.satBounds,D=this.satAxes;S[0]=x.a,S[1]=x.b,S[2]=x.c;for(let x=0;x<4;x++){const b=r[x],C=D[x];if(A.setFromPoints(C,S),b.isSeparated(A))return!1}const F=x.satBounds,G=x.satAxes;b[0]=this.a,b[1]=this.b,b[2]=this.c;for(let r=0;r<4;r++){const x=F[r],S=G[r];if(A.setFromPoints(S,b),x.isSeparated(A))return!1}for(let r=0;r<4;r++){const x=D[r];for(let r=0;r<4;r++){const C=G[r];if(R.crossVectors(x,C),A.setFromPoints(R,b),I.setFromPoints(R,S),A.isSeparated(I))return!1}}return C&&(B||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),C.start.set(0,0,0),C.end.set(0,0,0)),!0}{const r=triIntersectPlane(this,V,H);if(1===r&&x.containsPoint(H.end))return C&&(C.start.copy(H.end),C.end.copy(H.end)),!0;if(2!==r)return!1;const b=triIntersectPlane(x,N,W);if(1===b&&this.containsPoint(W.end))return C&&(C.start.copy(W.end),C.end.copy(W.end)),!0;if(2!==b)return!1;if(H.delta(D),W.delta(F),D.dot(F)<0){let r=W.start;W.start=W.end,W.end=r}const S=H.start.dot(D),A=H.end.dot(D),I=W.start.dot(D),R=W.end.dot(D);return(S===R||I===A||A<I!==S<R)&&(C&&(G.subVectors(H.start,W.start),G.dot(D)>0?C.start.copy(H.start):C.start.copy(W.start),G.subVectors(H.end,W.end),G.dot(D)<0?C.end.copy(H.end):C.end.copy(W.end)),!0)}}}(),ExtendedTriangle.prototype.distanceToPoint=function(){const r=new x;return function(x){return this.closestPointToPoint(x,r),x.distanceTo(r)}}(),ExtendedTriangle.prototype.distanceToTriangle=function(){const r=new x,b=new x,S=["a","b","c"],A=new C,I=new C;return function(x,C=null,R=null){const B=C||R?A:null;if(this.intersectsTriangle(x,B))return(C||R)&&(C&&B.getCenter(C),R&&B.getCenter(R)),0;let D=1/0;for(let b=0;b<3;b++){let A;const I=S[b],B=x[I];this.closestPointToPoint(B,r),A=B.distanceToSquared(r),A<D&&(D=A,C&&C.copy(r),R&&R.copy(B));const F=this[I];x.closestPointToPoint(F,r),A=F.distanceToSquared(r),A<D&&(D=A,C&&C.copy(F),R&&R.copy(r))}for(let B=0;B<3;B++){const F=S[B],G=S[(B+1)%3];A.set(this[F],this[G]);for(let B=0;B<3;B++){const F=S[B],G=S[(B+1)%3];I.set(x[F],x[G]),Gt(A,I,r,b);const N=r.distanceToSquared(b);N<D&&(D=N,C&&C.copy(r),R&&R.copy(b))}}return Math.sqrt(D)}}();class OrientedBox{constructor(r,b,S){this.isOrientedBox=!0,this.min=new x,this.max=new x,this.matrix=new F,this.invMatrix=new F,this.points=new Array(8).fill().map((()=>new x)),this.satAxes=new Array(3).fill().map((()=>new x)),this.satBounds=new Array(3).fill().map((()=>new SeparatingAxisBounds)),this.alignedSatBounds=new Array(3).fill().map((()=>new SeparatingAxisBounds)),this.needsUpdate=!1,r&&this.min.copy(r),b&&this.max.copy(b),S&&this.matrix.copy(S)}set(r,x,b){this.min.copy(r),this.max.copy(x),this.matrix.copy(b),this.needsUpdate=!0}copy(r){this.min.copy(r.min),this.max.copy(r.max),this.matrix.copy(r.matrix),this.needsUpdate=!0}}OrientedBox.prototype.update=function(){const r=this.matrix,x=this.min,b=this.max,S=this.points;for(let C=0;C<=1;C++)for(let A=0;A<=1;A++)for(let I=0;I<=1;I++){const R=S[1*C|2*A|4*I];R.x=C?b.x:x.x,R.y=A?b.y:x.y,R.z=I?b.z:x.z,R.applyMatrix4(r)}const C=this.satBounds,A=this.satAxes,I=S[0];for(let r=0;r<3;r++){const x=A[r],b=C[r],R=S[1<<r];x.subVectors(I,R),b.setFromPoints(x,S)}const R=this.alignedSatBounds;R[0].setFromPointsField(S,"x"),R[1].setFromPointsField(S,"y"),R[2].setFromPointsField(S,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1},OrientedBox.prototype.intersectsBox=function(){const r=new SeparatingAxisBounds;return function(x){this.needsUpdate&&this.update();const b=x.min,S=x.max,C=this.satBounds,A=this.satAxes,I=this.alignedSatBounds;if(r.min=b.x,r.max=S.x,I[0].isSeparated(r))return!1;if(r.min=b.y,r.max=S.y,I[1].isSeparated(r))return!1;if(r.min=b.z,r.max=S.z,I[2].isSeparated(r))return!1;for(let b=0;b<3;b++){const S=A[b],I=C[b];if(r.setFromBox(S,x),I.isSeparated(r))return!1}return!0}}(),OrientedBox.prototype.intersectsTriangle=function(){const r=new ExtendedTriangle,b=new Array(3),S=new SeparatingAxisBounds,C=new SeparatingAxisBounds,A=new x;return function(x){this.needsUpdate&&this.update(),x.isExtendedTriangle?x.needsUpdate&&x.update():(r.copy(x),r.update(),x=r);const I=this.satBounds,R=this.satAxes;b[0]=x.a,b[1]=x.b,b[2]=x.c;for(let r=0;r<3;r++){const x=I[r],C=R[r];if(S.setFromPoints(C,b),x.isSeparated(S))return!1}const B=x.satBounds,D=x.satAxes,F=this.points;for(let r=0;r<3;r++){const x=B[r],b=D[r];if(S.setFromPoints(b,F),x.isSeparated(S))return!1}for(let r=0;r<3;r++){const x=R[r];for(let r=0;r<4;r++){const I=D[r];if(A.crossVectors(x,I),S.setFromPoints(A,b),C.setFromPoints(A,F),S.isSeparated(C))return!1}}return!0}}(),OrientedBox.prototype.closestPointToPoint=function(r,x){return this.needsUpdate&&this.update(),x.copy(r).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),x},OrientedBox.prototype.distanceToPoint=function(){const r=new x;return function(x){return this.closestPointToPoint(x,r),x.distanceTo(r)}}(),OrientedBox.prototype.distanceToBox=function(){const r=["x","y","z"],b=new Array(12).fill().map((()=>new C)),S=new Array(12).fill().map((()=>new C)),A=new x,I=new x;return function(x,C=0,R=null,B=null){if(this.needsUpdate&&this.update(),this.intersectsBox(x))return(R||B)&&(x.getCenter(I),this.closestPointToPoint(I,A),x.closestPointToPoint(A,I),R&&R.copy(A),B&&B.copy(I)),0;const D=C*C,F=x.min,G=x.max,N=this.points;let H=1/0;for(let r=0;r<8;r++){const x=N[r];I.copy(x).clamp(F,G);const b=x.distanceToSquared(I);if(b<H&&(H=b,R&&R.copy(x),B&&B.copy(I),b<D))return Math.sqrt(b)}let W=0;for(let x=0;x<3;x++)for(let C=0;C<=1;C++)for(let A=0;A<=1;A++){const I=(x+1)%3,R=(x+2)%3,B=1<<x|C<<I|A<<R,D=N[C<<I|A<<R],H=N[B];b[W].set(D,H);const V=r[x],j=r[I],X=r[R],q=S[W],K=q.start,$=q.end;K[V]=F[V],K[j]=C?F[j]:G[j],K[X]=A?F[X]:G[j],$[V]=G[V],$[j]=C?F[j]:G[j],$[X]=A?F[X]:G[j],W++}for(let r=0;r<=1;r++)for(let x=0;x<=1;x++)for(let b=0;b<=1;b++){I.x=r?G.x:F.x,I.y=x?G.y:F.y,I.z=b?G.z:F.z,this.closestPointToPoint(I,A);const S=I.distanceToSquared(A);if(S<H&&(H=S,R&&R.copy(A),B&&B.copy(I),S<D))return Math.sqrt(S)}for(let r=0;r<12;r++){const x=b[r];for(let r=0;r<12;r++){const b=S[r];Gt(x,b,A,I);const C=A.distanceToSquared(I);if(C<H&&(H=C,R&&R.copy(A),B&&B.copy(I),C<D))return Math.sqrt(C)}}return Math.sqrt(H)}}();class PrimitivePool{constructor(r){this._getNewPrimitive=r,this._primitives=[]}getPrimitive(){const r=this._primitives;return 0===r.length?this._getNewPrimitive():r.pop()}releasePrimitive(r){this._primitives.push(r)}}class ExtendedTrianglePoolBase extends PrimitivePool{constructor(){super((()=>new ExtendedTriangle))}}const Ht=new ExtendedTrianglePoolBase;const Wt=new class{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const r=[];let x=null;this.setBuffer=b=>{x&&r.push(x),x=b,this.float32Array=new Float32Array(b),this.uint16Array=new Uint16Array(b),this.uint32Array=new Uint32Array(b)},this.clearBuffer=()=>{x=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,0!==r.length&&this.setBuffer(r.pop())}}};let Vt,zt;const jt=[],Xt=new PrimitivePool((()=>new A));function shapecast(r,x,b,S,C,A){Vt=Xt.getPrimitive(),zt=Xt.getPrimitive(),jt.push(Vt,zt),Wt.setBuffer(r._roots[x]);const I=shapecastTraverse(0,r.geometry,b,S,C,A);Wt.clearBuffer(),Xt.releasePrimitive(Vt),Xt.releasePrimitive(zt),jt.pop(),jt.pop();const R=jt.length;return R>0&&(zt=jt[R-1],Vt=jt[R-2]),I}function shapecastTraverse(r,x,b,S,C=null,A=0,I=0){const{float32Array:R,uint16Array:B,uint32Array:D}=Wt;let F=2*r;if(IS_LEAF(F,B)){const G=OFFSET(r,D),N=COUNT(F,B);return arrayToBox(r,R,Vt),S(G,N,!1,I,A+r,Vt)}{const H=LEFT_NODE(r),W=RIGHT_NODE(r,D);let V,j,X,q,K=H,$=W;if(C&&(X=Vt,q=zt,arrayToBox(K,R,X),arrayToBox($,R,q),V=C(X),j=C(q),j<V)){K=W,$=H;const ee=V;V=j,j=ee,X=q}X||(X=Vt,arrayToBox(K,R,X));const Y=b(X,IS_LEAF(2*K,B),V,I+1,A+K);let J;if(Y===wt){const te=getLeftOffset(K);J=S(te,getRightEndOffset(K)-te,!0,I+1,A+K,X)}else J=Y&&shapecastTraverse(K,x,b,S,C,A,I+1);if(J)return!0;q=zt,arrayToBox($,R,q);const Z=b(q,IS_LEAF(2*$,B),j,I+1,A+$);let Q;if(Z===wt){const ne=getLeftOffset($);Q=S(ne,getRightEndOffset($)-ne,!0,I+1,A+$,q)}else Q=Z&&shapecastTraverse($,x,b,S,C,A,I+1);return!!Q;function getLeftOffset(r){const{uint16Array:x,uint32Array:b}=Wt;let S=2*r;for(;!IS_LEAF(S,x);)S=2*(r=LEFT_NODE(r));return OFFSET(r,b)}function getRightEndOffset(r){const{uint16Array:x,uint32Array:b}=Wt;let S=2*r;for(;!IS_LEAF(S,x);)S=2*(r=RIGHT_NODE(r,b));return OFFSET(r,b)+COUNT(S,x)}}}const qt=new x,Kt=new x;const $t=new x,Yt=new x,Jt=new x,Zt=new b,Qt=new b,en=new b,tn=new x,nn=new x,rn=new x,sn=new x;function checkBufferGeometryIntersection(r,S,C,A,I,R,D,F,G,N,H){$t.fromBufferAttribute(S,R),Yt.fromBufferAttribute(S,D),Jt.fromBufferAttribute(S,F);const W=function(r,x,b,S,C,A,I,R){let B;if(B=A===ue?r.intersectTriangle(S,b,x,!0,C):r.intersectTriangle(x,b,S,A!==pe,C),null===B)return null;const D=r.origin.distanceTo(C);return D<I||D>R?null:{distance:D,point:C.clone()}}(r,$t,Yt,Jt,sn,G,N,H);if(W){A&&(Zt.fromBufferAttribute(A,R),Qt.fromBufferAttribute(A,D),en.fromBufferAttribute(A,F),W.uv=B.getInterpolation(sn,$t,Yt,Jt,Zt,Qt,en,new b)),I&&(Zt.fromBufferAttribute(I,R),Qt.fromBufferAttribute(I,D),en.fromBufferAttribute(I,F),W.uv1=B.getInterpolation(sn,$t,Yt,Jt,Zt,Qt,en,new b)),C&&(tn.fromBufferAttribute(C,R),nn.fromBufferAttribute(C,D),rn.fromBufferAttribute(C,F),W.normal=B.getInterpolation(sn,$t,Yt,Jt,tn,nn,rn,new x),W.normal.dot(r.direction)>0&&W.normal.multiplyScalar(-1));const S={a:R,b:D,c:F,normal:new x,materialIndex:0};B.getNormal($t,Yt,Jt,S.normal),W.face=S,W.faceIndex=R}return W}function intersectTri(r,x,b,S,C,A,I){const R=3*S;let B=R+0,D=R+1,F=R+2;const G=r.index;r.index&&(B=G.getX(B),D=G.getX(D),F=G.getX(F));const{position:N,normal:H,uv:W,uv1:V}=r.attributes,j=checkBufferGeometryIntersection(b,N,H,W,V,B,D,F,x,A,I);return j?(j.faceIndex=S,C&&C.push(j),j):null}function setTriangle(r,x,b,S){const C=r.a,A=r.b,I=r.c;let R=x,B=x+1,D=x+2;b&&(R=b.getX(R),B=b.getX(B),D=b.getX(D)),C.x=S.getX(R),C.y=S.getY(R),C.z=S.getZ(R),A.x=S.getX(B),A.y=S.getY(B),A.z=S.getZ(B),I.x=S.getX(D),I.y=S.getY(D),I.z=S.getZ(D)}const on=new x,an=new x,ln=new x,hn=new b,cn=new b,dn=new b;function iterateOverTriangles(r,x,b,S,C,A,I){const{geometry:R}=b,{index:B}=R,D=R.attributes.position;for(let b=r,R=x+r;b<R;b++){let r;if(r=b,setTriangle(I,3*r,B,D),I.needsUpdate=!0,S(I,r,C,A))return!0}return!1}function refit(r,x=null){x&&Array.isArray(x)&&(x=new Set(x));const b=r.geometry,S=b.index?b.index.array:null,C=b.attributes.position;let A,I,R,B,D=0;const F=r._roots;for(let r=0,x=F.length;r<x;r++)A=F[r],I=new Uint32Array(A),R=new Uint16Array(A),B=new Float32Array(A),_traverse(0,D),D+=A.byteLength;function _traverse(r,b,A=!1){const D=2*r;if(R[D+15]===It){const x=I[r+6];let b=1/0,A=1/0,F=1/0,G=-1/0,N=-1/0,H=-1/0;for(let r=3*x,I=3*(x+R[D+14]);r<I;r++){let x=S[r];const I=C.getX(x),R=C.getY(x),B=C.getZ(x);I<b&&(b=I),I>G&&(G=I),R<A&&(A=R),R>N&&(N=R),B<F&&(F=B),B>H&&(H=B)}return(B[r+0]!==b||B[r+1]!==A||B[r+2]!==F||B[r+3]!==G||B[r+4]!==N||B[r+5]!==H)&&(B[r+0]=b,B[r+1]=A,B[r+2]=F,B[r+3]=G,B[r+4]=N,B[r+5]=H,!0)}{const S=r+8,C=I[r+6],R=S+b,D=C+b;let F=A,G=!1,N=!1;x?F||(G=x.has(R),N=x.has(D),F=!G&&!N):(G=!0,N=!0);const H=F||N;let W=!1;(F||G)&&(W=_traverse(S,b,F));let V=!1;H&&(V=_traverse(C,b,F));const j=W||V;if(j)for(let x=0;x<3;x++){const b=S+x,A=C+x,I=B[b],R=B[b+3],D=B[A],F=B[A+3];B[r+x]=I<D?I:D,B[r+x+3]=R>F?R:F}return j}}}function intersectRay(r,x,b,S,C){let A,I,R,B,D,F;const G=1/b.direction.x,N=1/b.direction.y,H=1/b.direction.z,W=b.origin.x,V=b.origin.y,j=b.origin.z;let X=x[r],q=x[r+3],K=x[r+1],$=x[r+3+1],Y=x[r+2],J=x[r+3+2];return G>=0?(A=(X-W)*G,I=(q-W)*G):(A=(q-W)*G,I=(X-W)*G),N>=0?(R=(K-V)*N,B=($-V)*N):(R=($-V)*N,B=(K-V)*N),!(A>B||R>I)&&((R>A||isNaN(A))&&(A=R),(B<I||isNaN(I))&&(I=B),H>=0?(D=(Y-j)*H,F=(J-j)*H):(D=(J-j)*H,F=(Y-j)*H),!(A>F||D>I)&&((D>A||A!=A)&&(A=D),(F<I||I!=I)&&(I=F),A<=C&&I>=S))}function iterateOverTriangles_indirect(r,x,b,S,C,A,I){const{geometry:R}=b,{index:B}=R,D=R.attributes.position;for(let R=r,F=x+r;R<F;R++){let r;if(r=b.resolveTriangleIndex(R),setTriangle(I,3*r,B,D),I.needsUpdate=!0,S(I,r,C,A))return!0}return!1}function raycast(r,x,b,S,C,A,I){Wt.setBuffer(r._roots[x]),_raycast$1(0,r,b,S,C,A,I),Wt.clearBuffer()}function _raycast$1(r,x,b,S,C,A,I){const{float32Array:R,uint16Array:B,uint32Array:D}=Wt,F=2*r;if(IS_LEAF(F,B)){!function(r,x,b,S,C,A,I,R){const{geometry:B,_indirectBuffer:D}=r;for(let r=S,D=S+C;r<D;r++)intersectTri(B,x,b,r,A,I,R)}(x,b,S,OFFSET(r,D),COUNT(F,B),C,A,I)}else{const B=LEFT_NODE(r);intersectRay(B,R,S,A,I)&&_raycast$1(B,x,b,S,C,A,I);const F=RIGHT_NODE(r,D);intersectRay(F,R,S,A,I)&&_raycast$1(F,x,b,S,C,A,I)}}const un=["x","y","z"];function raycastFirst(r,x,b,S,C,A){Wt.setBuffer(r._roots[x]);const I=_raycastFirst$1(0,r,b,S,C,A);return Wt.clearBuffer(),I}function _raycastFirst$1(r,x,b,S,C,A){const{float32Array:I,uint16Array:R,uint32Array:B}=Wt;let D=2*r;if(IS_LEAF(D,R)){return function(r,x,b,S,C,A,I){const{geometry:R,_indirectBuffer:B}=r;let D=1/0,F=null;for(let r=S,B=S+C;r<B;r++){let S;S=intersectTri(R,x,b,r,null,A,I),S&&S.distance<D&&(F=S,D=S.distance)}return F}(x,b,S,OFFSET(r,B),COUNT(D,R),C,A)}{const R=SPLIT_AXIS(r,B),D=un[R],F=S.direction[D]>=0;let G,N;F?(G=LEFT_NODE(r),N=RIGHT_NODE(r,B)):(G=RIGHT_NODE(r,B),N=LEFT_NODE(r));const H=intersectRay(G,I,S,C,A)?_raycastFirst$1(G,x,b,S,C,A):null;if(H){const r=H.point[D];if(F?r<=I[N+R]:r>=I[N+R+3])return H}const W=intersectRay(N,I,S,C,A)?_raycastFirst$1(N,x,b,S,C,A):null;return H&&W?H.distance<=W.distance?H:W:H||W||null}}const pn=new A,fn=new ExtendedTriangle,gn=new ExtendedTriangle,mn=new F,_n=new OrientedBox,yn=new OrientedBox;function intersectsGeometry(r,x,b,S){Wt.setBuffer(r._roots[x]);const C=_intersectsGeometry$1(0,r,b,S);return Wt.clearBuffer(),C}function _intersectsGeometry$1(r,x,b,S,C=null){const{float32Array:A,uint16Array:I,uint32Array:R}=Wt;let B=2*r;null===C&&(b.boundingBox||b.computeBoundingBox(),_n.set(b.boundingBox.min,b.boundingBox.max,S),C=_n);if(!IS_LEAF(B,I)){const I=r+8,B=R[r+6];arrayToBox(I,A,pn);if(C.intersectsBox(pn)&&_intersectsGeometry$1(I,x,b,S,C))return!0;arrayToBox(B,A,pn);return!!(C.intersectsBox(pn)&&_intersectsGeometry$1(B,x,b,S,C))}{const C=x.geometry,D=C.index,F=C.attributes.position,G=b.index,N=b.attributes.position,H=OFFSET(r,R),W=COUNT(B,I);if(mn.copy(S).invert(),b.boundsTree){arrayToBox(r,A,yn),yn.matrix.copy(mn),yn.needsUpdate=!0;const x=b.boundsTree.shapecast({intersectsBounds:r=>yn.intersectsBox(r),intersectsTriangle:r=>{r.a.applyMatrix4(S),r.b.applyMatrix4(S),r.c.applyMatrix4(S),r.needsUpdate=!0;for(let x=3*H,b=3*(W+H);x<b;x+=3)if(setTriangle(gn,x,D,F),gn.needsUpdate=!0,r.intersectsTriangle(gn))return!0;return!1}});return x}for(let r=3*H,x=3*(W+H);r<x;r+=3){setTriangle(fn,r,D,F),fn.a.applyMatrix4(mn),fn.b.applyMatrix4(mn),fn.c.applyMatrix4(mn),fn.needsUpdate=!0;for(let r=0,x=G.count;r<x;r+=3)if(setTriangle(gn,r,G,N),gn.needsUpdate=!0,fn.intersectsTriangle(gn))return!0}}}const vn=new F,xn=new OrientedBox,bn=new OrientedBox,Tn=new x,wn=new x,Sn=new x,Cn=new x;function closestPointToGeometry(r,x,b,S={},C={},A=0,I=1/0){x.boundingBox||x.computeBoundingBox(),xn.set(x.boundingBox.min,x.boundingBox.max,b),xn.needsUpdate=!0;const R=r.geometry,B=R.attributes.position,D=R.index,F=x.attributes.position,G=x.index,N=Ht.getPrimitive(),H=Ht.getPrimitive();let W=Tn,V=wn,j=null,X=null;C&&(j=Sn,X=Cn);let q=1/0,K=null,$=null;return vn.copy(b).invert(),bn.matrix.copy(vn),r.shapecast({boundsTraverseOrder:r=>xn.distanceToBox(r),intersectsBounds:(r,x,b)=>b<q&&b<I&&(x&&(bn.min.copy(r.min),bn.max.copy(r.max),bn.needsUpdate=!0),!0),intersectsRange:(r,S)=>{if(x.boundsTree){return x.boundsTree.shapecast({boundsTraverseOrder:r=>bn.distanceToBox(r),intersectsBounds:(r,x,b)=>b<q&&b<I,intersectsRange:(x,C)=>{for(let I=x,R=x+C;I<R;I++){setTriangle(H,3*I,G,F),H.a.applyMatrix4(b),H.b.applyMatrix4(b),H.c.applyMatrix4(b),H.needsUpdate=!0;for(let x=r,b=r+S;x<b;x++){setTriangle(N,3*x,D,B),N.needsUpdate=!0;const r=N.distanceToTriangle(H,W,j);if(r<q&&(V.copy(W),X&&X.copy(j),q=r,K=x,$=I),r<A)return!0}}}})}for(let C=0,I=getTriCount(x);C<I;C++){setTriangle(H,3*C,G,F),H.a.applyMatrix4(b),H.b.applyMatrix4(b),H.c.applyMatrix4(b),H.needsUpdate=!0;for(let x=r,b=r+S;x<b;x++){setTriangle(N,3*x,D,B),N.needsUpdate=!0;const r=N.distanceToTriangle(H,W,j);if(r<q&&(V.copy(W),X&&X.copy(j),q=r,K=x,$=C),r<A)return!0}}}}),Ht.releasePrimitive(N),Ht.releasePrimitive(H),q===1/0?null:(S.point?S.point.copy(V):S.point=V.clone(),S.distance=q,S.faceIndex=K,C&&(C.point?C.point.copy(X):C.point=X.clone(),C.point.applyMatrix4(vn),V.applyMatrix4(vn),C.distance=V.sub(C.point).length(),C.faceIndex=$),S)}function refit_indirect(r,x=null){x&&Array.isArray(x)&&(x=new Set(x));const b=r.geometry,S=b.index?b.index.array:null,C=b.attributes.position;let A,I,R,B,D=0;const F=r._roots;for(let r=0,x=F.length;r<x;r++)A=F[r],I=new Uint32Array(A),R=new Uint16Array(A),B=new Float32Array(A),_traverse(0,D),D+=A.byteLength;function _traverse(b,A,D=!1){const F=2*b;if(R[F+15]===It){const x=I[b+6];let A=1/0,D=1/0,G=1/0,N=-1/0,H=-1/0,W=-1/0;for(let b=x,I=x+R[F+14];b<I;b++){const x=3*r.resolveTriangleIndex(b);for(let r=0;r<3;r++){let b=x+r;b=S?S[b]:b;const I=C.getX(b),R=C.getY(b),B=C.getZ(b);I<A&&(A=I),I>N&&(N=I),R<D&&(D=R),R>H&&(H=R),B<G&&(G=B),B>W&&(W=B)}}return(B[b+0]!==A||B[b+1]!==D||B[b+2]!==G||B[b+3]!==N||B[b+4]!==H||B[b+5]!==W)&&(B[b+0]=A,B[b+1]=D,B[b+2]=G,B[b+3]=N,B[b+4]=H,B[b+5]=W,!0)}{const r=b+8,S=I[b+6],C=r+A,R=S+A;let F=D,G=!1,N=!1;x?F||(G=x.has(C),N=x.has(R),F=!G&&!N):(G=!0,N=!0);const H=F||N;let W=!1;(F||G)&&(W=_traverse(r,A,F));let V=!1;H&&(V=_traverse(S,A,F));const j=W||V;if(j)for(let x=0;x<3;x++){const C=r+x,A=S+x,I=B[C],R=B[C+3],D=B[A],F=B[A+3];B[b+x]=I<D?I:D,B[b+x+3]=R>F?R:F}return j}}}function raycast_indirect(r,x,b,S,C,A,I){Wt.setBuffer(r._roots[x]),_raycast(0,r,b,S,C,A,I),Wt.clearBuffer()}function _raycast(r,x,b,S,C,A,I){const{float32Array:R,uint16Array:B,uint32Array:D}=Wt,F=2*r;if(IS_LEAF(F,B)){!function(r,x,b,S,C,A,I,R){const{geometry:B,_indirectBuffer:D}=r;for(let r=S,F=S+C;r<F;r++)intersectTri(B,x,b,D?D[r]:r,A,I,R)}(x,b,S,OFFSET(r,D),COUNT(F,B),C,A,I)}else{const B=LEFT_NODE(r);intersectRay(B,R,S,A,I)&&_raycast(B,x,b,S,C,A,I);const F=RIGHT_NODE(r,D);intersectRay(F,R,S,A,I)&&_raycast(F,x,b,S,C,A,I)}}const An=["x","y","z"];function raycastFirst_indirect(r,x,b,S,C,A){Wt.setBuffer(r._roots[x]);const I=_raycastFirst(0,r,b,S,C,A);return Wt.clearBuffer(),I}function _raycastFirst(r,x,b,S,C,A){const{float32Array:I,uint16Array:R,uint32Array:B}=Wt;let D=2*r;if(IS_LEAF(D,R)){return function(r,x,b,S,C,A,I){const{geometry:R,_indirectBuffer:B}=r;let D=1/0,F=null;for(let r=S,G=S+C;r<G;r++){let S;S=intersectTri(R,x,b,B?B[r]:r,null,A,I),S&&S.distance<D&&(F=S,D=S.distance)}return F}(x,b,S,OFFSET(r,B),COUNT(D,R),C,A)}{const R=SPLIT_AXIS(r,B),D=An[R],F=S.direction[D]>=0;let G,N;F?(G=LEFT_NODE(r),N=RIGHT_NODE(r,B)):(G=RIGHT_NODE(r,B),N=LEFT_NODE(r));const H=intersectRay(G,I,S,C,A)?_raycastFirst(G,x,b,S,C,A):null;if(H){const r=H.point[D];if(F?r<=I[N+R]:r>=I[N+R+3])return H}const W=intersectRay(N,I,S,C,A)?_raycastFirst(N,x,b,S,C,A):null;return H&&W?H.distance<=W.distance?H:W:H||W||null}}const In=new A,kn=new ExtendedTriangle,En=new ExtendedTriangle,Rn=new F,Mn=new OrientedBox,Bn=new OrientedBox;function intersectsGeometry_indirect(r,x,b,S){Wt.setBuffer(r._roots[x]);const C=_intersectsGeometry(0,r,b,S);return Wt.clearBuffer(),C}function _intersectsGeometry(r,x,b,S,C=null){const{float32Array:A,uint16Array:I,uint32Array:R}=Wt;let B=2*r;null===C&&(b.boundingBox||b.computeBoundingBox(),Mn.set(b.boundingBox.min,b.boundingBox.max,S),C=Mn);if(!IS_LEAF(B,I)){const I=r+8,B=R[r+6];arrayToBox(I,A,In);if(C.intersectsBox(In)&&_intersectsGeometry(I,x,b,S,C))return!0;arrayToBox(B,A,In);return!!(C.intersectsBox(In)&&_intersectsGeometry(B,x,b,S,C))}{const C=x.geometry,D=C.index,F=C.attributes.position,G=b.index,N=b.attributes.position,H=OFFSET(r,R),W=COUNT(B,I);if(Rn.copy(S).invert(),b.boundsTree){arrayToBox(r,A,Bn),Bn.matrix.copy(Rn),Bn.needsUpdate=!0;const C=b.boundsTree.shapecast({intersectsBounds:r=>Bn.intersectsBox(r),intersectsTriangle:r=>{r.a.applyMatrix4(S),r.b.applyMatrix4(S),r.c.applyMatrix4(S),r.needsUpdate=!0;for(let b=H,S=W+H;b<S;b++)if(setTriangle(En,3*x.resolveTriangleIndex(b),D,F),En.needsUpdate=!0,r.intersectsTriangle(En))return!0;return!1}});return C}for(let r=H,b=W+H;r<b;r++){const b=x.resolveTriangleIndex(r);setTriangle(kn,3*b,D,F),kn.a.applyMatrix4(Rn),kn.b.applyMatrix4(Rn),kn.c.applyMatrix4(Rn),kn.needsUpdate=!0;for(let r=0,x=G.count;r<x;r+=3)if(setTriangle(En,r,G,N),En.needsUpdate=!0,kn.intersectsTriangle(En))return!0}}}const Pn=new F,Ln=new OrientedBox,On=new OrientedBox,Dn=new x,Un=new x,Fn=new x,Gn=new x;function closestPointToGeometry_indirect(r,x,b,S={},C={},A=0,I=1/0){x.boundingBox||x.computeBoundingBox(),Ln.set(x.boundingBox.min,x.boundingBox.max,b),Ln.needsUpdate=!0;const R=r.geometry,B=R.attributes.position,D=R.index,F=x.attributes.position,G=x.index,N=Ht.getPrimitive(),H=Ht.getPrimitive();let W=Dn,V=Un,j=null,X=null;C&&(j=Fn,X=Gn);let q=1/0,K=null,$=null;return Pn.copy(b).invert(),On.matrix.copy(Pn),r.shapecast({boundsTraverseOrder:r=>Ln.distanceToBox(r),intersectsBounds:(r,x,b)=>b<q&&b<I&&(x&&(On.min.copy(r.min),On.max.copy(r.max),On.needsUpdate=!0),!0),intersectsRange:(S,C)=>{if(x.boundsTree){const R=x.boundsTree;return R.shapecast({boundsTraverseOrder:r=>On.distanceToBox(r),intersectsBounds:(r,x,b)=>b<q&&b<I,intersectsRange:(x,I)=>{for(let Y=x,J=x+I;Y<J;Y++){const x=R.resolveTriangleIndex(Y);setTriangle(H,3*x,G,F),H.a.applyMatrix4(b),H.b.applyMatrix4(b),H.c.applyMatrix4(b),H.needsUpdate=!0;for(let x=S,b=S+C;x<b;x++){const b=r.resolveTriangleIndex(x);setTriangle(N,3*b,D,B),N.needsUpdate=!0;const S=N.distanceToTriangle(H,W,j);if(S<q&&(V.copy(W),X&&X.copy(j),q=S,K=x,$=Y),S<A)return!0}}}})}for(let I=0,R=getTriCount(x);I<R;I++){setTriangle(H,3*I,G,F),H.a.applyMatrix4(b),H.b.applyMatrix4(b),H.c.applyMatrix4(b),H.needsUpdate=!0;for(let x=S,b=S+C;x<b;x++){const b=r.resolveTriangleIndex(x);setTriangle(N,3*b,D,B),N.needsUpdate=!0;const S=N.distanceToTriangle(H,W,j);if(S<q&&(V.copy(W),X&&X.copy(j),q=S,K=x,$=I),S<A)return!0}}}}),Ht.releasePrimitive(N),Ht.releasePrimitive(H),q===1/0?null:(S.point?S.point.copy(V):S.point=V.clone(),S.distance=q,S.faceIndex=K,C&&(C.point?C.point.copy(X):C.point=X.clone(),C.point.applyMatrix4(Pn),V.applyMatrix4(Pn),C.distance=V.sub(C.point).length(),C.faceIndex=$),S)}function isSharedArrayBufferSupported(){return"undefined"!=typeof SharedArrayBuffer}const Nn=new Wt.constructor,Hn=new Wt.constructor,Wn=new PrimitivePool((()=>new A)),Vn=new A,zn=new A,jn=new A,Xn=new A;let qn=!1;function _traverse(r,x,b,S,C,A=0,I=0,R=0,B=0,D=null,F=!1){let G,N;F?(G=Hn,N=Nn):(G=Nn,N=Hn);const H=G.float32Array,W=G.uint32Array,V=G.uint16Array,j=N.float32Array,X=N.uint32Array,q=N.uint16Array,K=2*x,$=IS_LEAF(2*r,V),Y=IS_LEAF(K,q);let J=!1;if(Y&&$)J=F?C(OFFSET(x,X),COUNT(2*x,q),OFFSET(r,W),COUNT(2*r,V),B,I+x,R,A+r):C(OFFSET(r,W),COUNT(2*r,V),OFFSET(x,X),COUNT(2*x,q),R,A+r,B,I+x);else if(Y){const D=Wn.getPrimitive();arrayToBox(x,j,D),D.applyMatrix4(b);const G=LEFT_NODE(r),N=RIGHT_NODE(r,W);arrayToBox(G,H,Vn),arrayToBox(N,H,zn);const V=D.intersectsBox(Vn),X=D.intersectsBox(zn);J=V&&_traverse(x,G,S,b,C,I,A,B,R+1,D,!F)||X&&_traverse(x,N,S,b,C,I,A,B,R+1,D,!F),Wn.releasePrimitive(D)}else{const G=LEFT_NODE(x),N=RIGHT_NODE(x,X);arrayToBox(G,j,jn),arrayToBox(N,j,Xn);const V=D.intersectsBox(jn),q=D.intersectsBox(Xn);if(V&&q)J=_traverse(r,G,b,S,C,A,I,R,B+1,D,F)||_traverse(r,N,b,S,C,A,I,R,B+1,D,F);else if(V)if($)J=_traverse(r,G,b,S,C,A,I,R,B+1,D,F);else{const x=Wn.getPrimitive();x.copy(jn).applyMatrix4(b);const D=LEFT_NODE(r),N=RIGHT_NODE(r,W);arrayToBox(D,H,Vn),arrayToBox(N,H,zn);const V=x.intersectsBox(Vn),j=x.intersectsBox(zn);J=V&&_traverse(G,D,S,b,C,I,A,B,R+1,x,!F)||j&&_traverse(G,N,S,b,C,I,A,B,R+1,x,!F),Wn.releasePrimitive(x)}else if(q)if($)J=_traverse(r,N,b,S,C,A,I,R,B+1,D,F);else{const x=Wn.getPrimitive();x.copy(Xn).applyMatrix4(b);const D=LEFT_NODE(r),G=RIGHT_NODE(r,W);arrayToBox(D,H,Vn),arrayToBox(G,H,zn);const V=x.intersectsBox(Vn),j=x.intersectsBox(zn);J=V&&_traverse(N,D,S,b,C,I,A,B,R+1,x,!F)||j&&_traverse(N,G,S,b,C,I,A,B,R+1,x,!F),Wn.releasePrimitive(x)}}return J}const Kn=new OrientedBox,$n=new A,Yn={strategy:xt,maxDepth:40,maxLeafTris:10,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,verbose:!0,range:null};class MeshBVH{static serialize(r,x={}){x={cloneBuffers:!0,...x};const b=r.geometry,S=r._roots,C=r._indirectBuffer,A=b.getIndex();let I;return I=x.cloneBuffers?{roots:S.map((r=>r.slice())),index:A?A.array.slice():null,indirectBuffer:C?C.slice():null}:{roots:S,index:A?A.array:null,indirectBuffer:C},I}static deserialize(r,x,b={}){b={setIndex:!0,indirect:Boolean(r.indirectBuffer),...b};const{index:S,roots:C,indirectBuffer:A}=r,I=new MeshBVH(x,{...b,[Et]:!0});if(I._roots=C,I._indirectBuffer=A||null,b.setIndex){const b=x.getIndex();if(null===b){const b=new G(r.index,1,!1);x.setIndex(b)}else b.array!==S&&(b.array.set(S),b.needsUpdate=!0)}return I}get indirect(){return!!this._indirectBuffer}constructor(r,x={}){if(!r.isBufferGeometry)throw new Error("MeshBVH: Only BufferGeometries are supported.");if(r.index&&r.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.");if((x=Object.assign({...Yn,[Et]:!1},x)).useSharedArrayBuffer&&!isSharedArrayBufferSupported())throw new Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=r,this._roots=null,this._indirectBuffer=null,x[Et]||(buildPackedTree(this,x),!r.boundingBox&&x.setBoundingBox&&(r.boundingBox=this.getBoundingBox(new A))),this.resolveTriangleIndex=x.indirect?r=>this._indirectBuffer[r]:r=>r}refit(r=null){return(this.indirect?refit_indirect:refit)(this,r)}traverse(r,x=0){const b=this._roots[x],S=new Uint32Array(b),C=new Uint16Array(b);!function _traverse(x,A=0){const I=2*x,R=C[I+15]===It;if(R){const B=S[x+6],D=C[I+14];r(A,R,new Float32Array(b,4*x,6),B,D)}else{const C=x+At/4,I=S[x+6],B=S[x+7];r(A,R,new Float32Array(b,4*x,6),B)||(_traverse(C,A+1),_traverse(I,A+1))}}(0)}raycast(r,x=N,b=0,S=1/0){const C=this._roots,A=this.geometry,I=[],R=x.isMaterial,B=Array.isArray(x),D=A.groups,F=R?x.side:x,G=this.indirect?raycast_indirect:raycast;for(let A=0,R=C.length;A<R;A++){const C=B?x[D[A].materialIndex].side:F,R=I.length;if(G(this,A,C,r,I,b,S),B){const r=D[A].materialIndex;for(let x=R,b=I.length;x<b;x++)I[x].face.materialIndex=r}}return I}raycastFirst(r,x=N,b=0,S=1/0){const C=this._roots,A=this.geometry,I=x.isMaterial,R=Array.isArray(x);let B=null;const D=A.groups,F=I?x.side:x,G=this.indirect?raycastFirst_indirect:raycastFirst;for(let A=0,I=C.length;A<I;A++){const C=G(this,A,R?x[D[A].materialIndex].side:F,r,b,S);null!=C&&(null==B||C.distance<B.distance)&&(B=C,R&&(C.face.materialIndex=D[A].materialIndex))}return B}intersectsGeometry(r,x){let b=!1;const S=this._roots,C=this.indirect?intersectsGeometry_indirect:intersectsGeometry;for(let A=0,I=S.length;A<I&&(b=C(this,A,r,x),!b);A++);return b}shapecast(r){const x=Ht.getPrimitive(),b=this.indirect?iterateOverTriangles_indirect:iterateOverTriangles;let{boundsTraverseOrder:S,intersectsBounds:C,intersectsRange:A,intersectsTriangle:I}=r;if(A&&I){const r=A;A=(S,C,A,R,B)=>!!r(S,C,A,R,B)||b(S,C,this,I,A,R,x)}else A||(A=I?(r,S,C,A)=>b(r,S,this,I,C,A,x):(r,x,b)=>b);let R=!1,B=0;const D=this._roots;for(let r=0,x=D.length;r<x;r++){const x=D[r];if(R=shapecast(this,r,C,A,S,B),R)break;B+=x.byteLength}return Ht.releasePrimitive(x),R}bvhcast(r,x,b){let{intersectsRanges:S,intersectsTriangles:C}=b;const A=Ht.getPrimitive(),I=this.geometry.index,R=this.geometry.attributes.position,B=this.indirect?r=>{const x=this.resolveTriangleIndex(r);setTriangle(A,3*x,I,R)}:r=>{setTriangle(A,3*r,I,R)},D=Ht.getPrimitive(),G=r.geometry.index,N=r.geometry.attributes.position,H=r.indirect?x=>{const b=r.resolveTriangleIndex(x);setTriangle(D,3*b,G,N)}:r=>{setTriangle(D,3*r,G,N)};if(C){const iterateOverDoubleTriangles=(r,b,S,I,R,F,G,N)=>{for(let W=S,V=S+I;W<V;W++){H(W),D.a.applyMatrix4(x),D.b.applyMatrix4(x),D.c.applyMatrix4(x),D.needsUpdate=!0;for(let x=r,S=r+b;x<S;x++)if(B(x),A.needsUpdate=!0,C(A,D,x,W,R,F,G,N))return!0}return!1};if(S){const r=S;S=function(x,b,S,C,A,I,R,B){return!!r(x,b,S,C,A,I,R,B)||iterateOverDoubleTriangles(x,b,S,C,A,I,R,B)}}else S=iterateOverDoubleTriangles}return function(r,x,b,S){if(qn)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");qn=!0;const C=r._roots,A=x._roots;let I,R=0,B=0;const D=(new F).copy(b).invert();for(let r=0,x=C.length;r<x;r++){Nn.setBuffer(C[r]),B=0;const x=Wn.getPrimitive();arrayToBox(0,Nn.float32Array,x),x.applyMatrix4(D);for(let r=0,C=A.length;r<C&&(Hn.setBuffer(A[r]),I=_traverse(0,0,b,D,S,R,B,0,0,x),Hn.clearBuffer(),B+=A[r].length,!I);r++);if(Wn.releasePrimitive(x),Nn.clearBuffer(),R+=C[r].length,I)break}return qn=!1,I}(this,r,x,S)}intersectsBox(r,x){return Kn.set(r.min,r.max,x),Kn.needsUpdate=!0,this.shapecast({intersectsBounds:r=>Kn.intersectsBox(r),intersectsTriangle:r=>Kn.intersectsTriangle(r)})}intersectsSphere(r){return this.shapecast({intersectsBounds:x=>r.intersectsBox(x),intersectsTriangle:x=>x.intersectsSphere(r)})}closestPointToGeometry(r,x,b={},S={},C=0,A=1/0){return(this.indirect?closestPointToGeometry_indirect:closestPointToGeometry)(this,r,x,b,S,C,A)}closestPointToPoint(r,x={},b=0,S=1/0){return function(r,x,b={},S=0,C=1/0){const A=S*S,I=C*C;let R=1/0,B=null;if(r.shapecast({boundsTraverseOrder:r=>(qt.copy(x).clamp(r.min,r.max),qt.distanceToSquared(x)),intersectsBounds:(r,x,b)=>b<R&&b<I,intersectsTriangle:(r,b)=>{r.closestPointToPoint(x,qt);const S=x.distanceToSquared(qt);return S<R&&(Kt.copy(qt),R=S,B=b),S<A}}),R===1/0)return null;const D=Math.sqrt(R);return b.point?b.point.copy(Kt):b.point=Kt.clone(),b.distance=D,b.faceIndex=B,b}(this,r,x,b,S)}getBoundingBox(r){r.makeEmpty();return this._roots.forEach((x=>{arrayToBox(0,new Float32Array(x),$n),r.union($n)})),r}}const Jn=new A,Zn=new F;class MeshBVHRootHelper extends ee{get isMesh(){return!this.displayEdges}get isLineSegments(){return this.displayEdges}get isLine(){return this.displayEdges}getVertexPosition(...r){return I.prototype.getVertexPosition.call(this,...r)}constructor(r,x,b=10,S=0){super(),this.material=x,this.geometry=new Z,this.name="MeshBVHRootHelper",this.depth=b,this.displayParents=!1,this.bvh=r,this.displayEdges=!0,this._group=S}raycast(){}update(){const r=this.geometry,x=this.bvh,b=this._group;if(r.dispose(),this.visible=!1,x){const S=this.depth-1,C=this.displayParents;let A=0;x.traverse(((r,x)=>{if(r>=S||x)return A++,!0;C&&A++}),b);let I=0;const R=new Float32Array(24*A);let B,D;x.traverse(((r,x,b)=>{const A=r>=S||x;if(A||C){arrayToBox(0,b,Jn);const{min:r,max:x}=Jn;for(let b=-1;b<=1;b+=2){const S=b<0?r.x:x.x;for(let b=-1;b<=1;b+=2){const C=b<0?r.y:x.y;for(let b=-1;b<=1;b+=2){const A=b<0?r.z:x.z;R[I+0]=S,R[I+1]=C,R[I+2]=A,I+=3}}}return A}}),b),D=this.displayEdges?new Uint8Array([0,4,1,5,2,6,3,7,0,2,1,3,4,6,5,7,0,1,2,3,4,5,6,7]):new Uint8Array([0,1,2,2,1,3,4,6,5,6,7,5,1,4,5,0,4,1,2,3,6,3,7,6,0,2,4,2,6,4,1,5,3,3,5,7]),B=R.length>65535?new Uint32Array(D.length*A):new Uint16Array(D.length*A);const F=D.length;for(let r=0;r<A;r++){const x=8*r,b=r*F;for(let r=0;r<F;r++)B[b+r]=x+D[r]}r.setIndex(new G(B,1,!1)),r.setAttribute("position",new G(R,3,!1)),this.visible=!0}}}class MeshBVHHelper extends H{get color(){return this.edgeMaterial.color}get opacity(){return this.edgeMaterial.opacity}set opacity(r){this.edgeMaterial.opacity=r,this.meshMaterial.opacity=r}constructor(r=null,x=null,b=10){r instanceof MeshBVH&&(b=x||10,x=r,r=null),"number"==typeof x&&(b=x,x=null),super(),this.name="MeshBVHHelper",this.depth=b,this.mesh=r,this.bvh=x,this.displayParents=!1,this.displayEdges=!0,this.objectIndex=0,this._roots=[];const S=new W({color:65416,transparent:!0,opacity:.3,depthWrite:!1}),C=new V({color:65416,transparent:!0,opacity:.3,depthWrite:!1});C.color=S.color,this.edgeMaterial=S,this.meshMaterial=C,this.update()}update(){const r=this.mesh;let x=this.bvh||r.geometry.boundsTree||null;if(r.isBatchedMesh&&r.boundsTrees&&!x){const b=r._drawInfo[this.objectIndex];b&&(x=r.boundsTrees[b.geometryIndex]||x)}const b=x?x._roots.length:0;for(;this._roots.length>b;){const r=this._roots.pop();r.geometry.dispose(),this.remove(r)}for(let r=0;r<b;r++){const{depth:b,edgeMaterial:S,meshMaterial:C,displayParents:A,displayEdges:I}=this;if(r>=this._roots.length){const C=new MeshBVHRootHelper(x,S,b,r);this.add(C),this._roots.push(C)}const R=this._roots[r];R.bvh=x,R.depth=b,R.displayParents=A,R.displayEdges=I,R.material=I?S:C,R.update()}}updateMatrixWorld(...r){const x=this.mesh,b=this.parent;null!==x&&(x.updateWorldMatrix(!0,!1),b?this.matrix.copy(b.matrixWorld).invert().multiply(x.matrixWorld):this.matrix.copy(x.matrixWorld),(x.isInstancedMesh||x.isBatchedMesh)&&(x.getMatrixAt(this.objectIndex,Zn),this.matrix.multiply(Zn)),this.matrix.decompose(this.position,this.quaternion,this.scale)),super.updateMatrixWorld(...r)}copy(r){this.depth=r.depth,this.mesh=r.mesh,this.bvh=r.bvh,this.opacity=r.opacity,this.color.copy(r.color)}clone(){return new MeshBVHHelper(this.mesh,this.bvh,this.depth)}dispose(){this.edgeMaterial.dispose(),this.meshMaterial.dispose();const r=this.children;for(let x=0,b=r.length;x<b;x++)r[x].geometry.dispose()}}const Qn=new A,er=new A,tr=new x;function getPrimitiveSize(r){switch(typeof r){case"number":return 8;case"string":return 2*r.length;case"boolean":return 4;default:return 0}}function convertRaycastIntersect(r,x,b){return null===r?null:(r.point.applyMatrix4(x.matrixWorld),r.distance=r.point.distanceTo(b.ray.origin),r.object=x,r)}const nr=parseInt(te)>=166,rr=new ne,ir=new x,sr=new F,or=I.prototype.raycast,ar=R.prototype.raycast,lr=new x,hr=new I,cr=[];function acceleratedBatchedMeshRaycast(r,x){if(this.boundsTrees){const b=this.boundsTrees,S=this._drawInfo,C=this._drawRanges,A=this.matrixWorld;hr.material=this.material,hr.geometry=this.geometry;const I=hr.geometry.boundsTree,R=hr.geometry.drawRange;null===hr.geometry.boundingSphere&&(hr.geometry.boundingSphere=new D);for(let I=0,R=S.length;I<R;I++){if(!this.getVisibleAt(I))continue;const R=S[I].geometryIndex;if(hr.geometry.boundsTree=b[R],this.getMatrixAt(I,hr.matrixWorld).premultiply(A),!hr.geometry.boundsTree){this.getBoundingBoxAt(R,hr.geometry.boundingBox),this.getBoundingSphereAt(R,hr.geometry.boundingSphere);const r=C[R];hr.geometry.setDrawRange(r.start,r.count)}hr.raycast(r,cr);for(let r=0,b=cr.length;r<b;r++){const b=cr[r];b.object=this,b.batchId=I,x.push(b)}cr.length=0}hr.geometry.boundsTree=I,hr.geometry.drawRange=R,hr.material=null,hr.geometry=null}else ar.call(this,r,x)}function acceleratedMeshRaycast(r,x){if(this.geometry.boundsTree){if(void 0===this.material)return;sr.copy(this.matrixWorld).invert(),rr.copy(r.ray).applyMatrix4(sr),lr.setFromMatrixScale(this.matrixWorld),ir.copy(rr.direction).multiply(lr);const b=ir.length(),S=r.near/b,C=r.far/b,A=this.geometry.boundsTree;if(!0===r.firstHitOnly){const b=convertRaycastIntersect(A.raycastFirst(rr,this.material,S,C),this,r);b&&x.push(b)}else{const b=A.raycast(rr,this.material,S,C);for(let S=0,C=b.length;S<C;S++){const C=convertRaycastIntersect(b[S],this,r);C&&x.push(C)}}}else or.call(this,r,x)}function countToIntFormat(r){switch(r){case 1:return de;case 2:return J;case 3:case 4:return ae}}class VertexAttributeTexture extends j{constructor(){super(),this.minFilter=X,this.magFilter=X,this.generateMipmaps=!1,this.overrideItemSize=null,this._forcedType=null}updateFrom(r){const x=this.overrideItemSize,b=r.itemSize,S=r.count;if(null!==x){if(b*S%x!=0)throw new Error("VertexAttributeTexture: overrideItemSize must divide evenly into buffer length.");r.itemSize=x,r.count=S*b/x}const C=r.itemSize,A=r.count,I=r.normalized,R=r.array.constructor,B=R.BYTES_PER_ELEMENT;let D,F,G,N,H=this._forcedType,W=C;if(null===H)switch(R){case Float32Array:H=$;break;case Uint8Array:case Uint16Array:case Uint32Array:H=q;break;case Int8Array:case Int16Array:case Int32Array:H=K}let V=function(r){switch(r){case 1:return"R";case 2:return"RG";case 3:case 4:return"RGBA"}throw new Error}(C);switch(H){case $:G=1,F=function(r){switch(r){case 1:return ce;case 2:return he;case 3:case 4:return Y}}(C),I&&1===B?(N=R,V+="8",R===Uint8Array?D=re:(D=se,V+="_SNORM")):(N=Float32Array,V+="32F",D=$);break;case K:V+=8*B+"I",G=I?Math.pow(2,8*R.BYTES_PER_ELEMENT-1):1,F=countToIntFormat(C),1===B?(N=Int8Array,D=se):2===B?(N=Int16Array,D=oe):(N=Int32Array,D=K);break;case q:V+=8*B+"UI",G=I?Math.pow(2,8*R.BYTES_PER_ELEMENT-1):1,F=countToIntFormat(C),1===B?(N=Uint8Array,D=re):2===B?(N=Uint16Array,D=ie):(N=Uint32Array,D=q)}3!==W||F!==Y&&F!==ae||(W=4);const j=Math.ceil(Math.sqrt(A))||1,X=new N(W*j*j),J=r.normalized;r.normalized=!1;for(let x=0;x<A;x++){const b=W*x;X[b]=r.getX(x)/G,C>=2&&(X[b+1]=r.getY(x)/G),C>=3&&(X[b+2]=r.getZ(x)/G,4===W&&(X[b+3]=1)),C>=4&&(X[b+3]=r.getW(x)/G)}r.normalized=J,this.internalFormat=V,this.format=F,this.type=D,this.image.width=j,this.image.height=j,this.image.data=X,this.needsUpdate=!0,this.dispose(),r.itemSize=b,r.count=S}}class UIntVertexAttributeTexture extends VertexAttributeTexture{constructor(){super(),this._forcedType=q}}class FloatVertexAttributeTexture extends VertexAttributeTexture{constructor(){super(),this._forcedType=$}}const dr=new x,ur=new x,pr=new x,fr=new le,gr=new x,mr=new x,_r=new le,yr=new le,vr=new F,xr=new F;function validateAttributes(r,x){if(!r&&!x)return;const b=r.count===x.count,S=r.normalized===x.normalized,C=r.array.constructor===x.array.constructor,A=r.itemSize===x.itemSize;if(!(b&&S&&C&&A))throw new Error}function createAttributeClone(r,x=null){const b=r.array.constructor,S=r.normalized,C=r.itemSize,A=null===x?r.count:x;return new G(new b(C*A),C,S)}function copyAttributeContents(r,x,b=0){if(r.isInterleavedBufferAttribute){const S=r.itemSize;for(let C=0,A=r.count;C<A;C++){const A=C+b;x.setX(A,r.getX(C)),S>=2&&x.setY(A,r.getY(C)),S>=3&&x.setZ(A,r.getZ(C)),S>=4&&x.setW(A,r.getW(C))}}else{const S=x.array,C=S.constructor,A=S.BYTES_PER_ELEMENT*r.itemSize*b;new C(S.buffer,A,r.array.length).set(r.array)}}function addScaledMatrix(r,x,b){const S=r.elements,C=x.elements;for(let r=0,x=C.length;r<x;r++)S[r]+=C[r]*b}function boneNormalTransform(r,x,b){const S=r.skeleton,C=r.geometry,A=S.bones,I=S.boneInverses;_r.fromBufferAttribute(C.attributes.skinIndex,x),yr.fromBufferAttribute(C.attributes.skinWeight,x),vr.elements.fill(0);for(let r=0;r<4;r++){const x=yr.getComponent(r);if(0!==x){const b=_r.getComponent(r);xr.multiplyMatrices(A[b].matrixWorld,I[b]),addScaledMatrix(vr,xr,x)}}return vr.multiply(r.bindMatrix).premultiply(r.bindMatrixInverse),b.transformDirection(vr),b}function applyMorphTarget(r,x,b,S,C){gr.set(0,0,0);for(let A=0,I=r.length;A<I;A++){const I=x[A],R=r[A];0!==I&&(mr.fromBufferAttribute(R,S),b?gr.addScaledVector(mr,I):gr.addScaledVector(mr.sub(C),I))}C.add(gr)}class GeometryDiff{constructor(r){this.matrixWorld=new F,this.geometryHash=null,this.boneMatrices=null,this.primitiveCount=-1,this.mesh=r,this.update()}update(){const r=this.mesh,x=r.geometry,b=r.skeleton,S=(x.index?x.index.count:x.attributes.position.count)/3;if(this.matrixWorld.copy(r.matrixWorld),this.geometryHash=x.attributes.position.version,this.primitiveCount=S,b){b.boneTexture||b.computeBoneTexture(),b.update();const r=b.boneMatrices;this.boneMatrices&&this.boneMatrices.length===r.length?this.boneMatrices.set(r):this.boneMatrices=r.slice()}else this.boneMatrices=null}didChange(){const r=this.mesh,x=r.geometry,b=(x.index?x.index.count:x.attributes.position.count)/3,S=this.matrixWorld.equals(r.matrixWorld)&&this.geometryHash===x.attributes.position.version&&function(r,x){if(null===r||null===x)return r===x;if(r.length!==x.length)return!1;for(let b=0,S=r.length;b<S;b++)if(r[b]!==x[b])return!1;return!0}(r.skeleton&&r.skeleton.boneMatrices||null,this.boneMatrices)&&this.primitiveCount===b;return!S}}class StaticGeometryGenerator{constructor(r){Array.isArray(r)||(r=[r]);const x=[];r.forEach((r=>{r.traverseVisible((r=>{r.isMesh&&x.push(r)}))})),this.meshes=x,this.useGroups=!0,this.applyWorldTransforms=!0,this.attributes=["position","normal","color","tangent","uv","uv2"],this._intermediateGeometry=new Array(x.length).fill().map((()=>new Z)),this._diffMap=new WeakMap}getMaterials(){const r=[];return this.meshes.forEach((x=>{Array.isArray(x.material)?r.push(...x.material):r.push(x.material)})),r}generate(r=new Z){let x=[];const{meshes:b,useGroups:S,_intermediateGeometry:C,_diffMap:A}=this;for(let r=0,S=b.length;r<S;r++){const S=b[r],I=C[r],R=A.get(S);!R||R.didChange(S)?(this._convertToStaticGeometry(S,I),x.push(!1),R?R.update():A.set(S,new GeometryDiff(S))):x.push(!0)}if(0===C.length){r.setIndex(null);const x=r.attributes;for(const b in x)r.deleteAttribute(b);for(const x in this.attributes)r.setAttribute(this.attributes[x],new G(new Float32Array(0),4,!1))}else!function(r,x={useGroups:!1,updateIndex:!1,skipAttributes:[]},b=new Z){const S=null!==r[0].index,{useGroups:C=!1,updateIndex:A=!1,skipAttributes:I=[]}=x,R=new Set(Object.keys(r[0].attributes)),B={};let D=0;b.clearGroups();for(let x=0;x<r.length;++x){const A=r[x];let I=0;if(S!==(null!==A.index))throw new Error("StaticGeometryGenerator: All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them.");for(const r in A.attributes){if(!R.has(r))throw new Error('StaticGeometryGenerator: All geometries must have compatible attributes; make sure "'+r+'" attribute exists among all geometries, or in none of them.');void 0===B[r]&&(B[r]=[]),B[r].push(A.attributes[r]),I++}if(I!==R.size)throw new Error("StaticGeometryGenerator: Make sure all geometries have the same number of attributes.");if(C){let r;if(S)r=A.index.count;else{if(void 0===A.attributes.position)throw new Error("StaticGeometryGenerator: The geometry must have either an index or a position attribute");r=A.attributes.position.count}b.addGroup(D,r,x),D+=r}}if(S){let x=!1;if(!b.index){let S=0;for(let x=0;x<r.length;++x)S+=r[x].index.count;b.setIndex(new G(new Uint32Array(S),1,!1)),x=!0}if(A||x){const x=b.index;let S=0,C=0;for(let b=0;b<r.length;++b){const A=r[b],R=A.index;if(!0!==I[b])for(let r=0;r<R.count;++r)x.setX(S,R.getX(r)+C),S++;C+=A.attributes.position.count}}}for(const r in B){const x=B[r];if(!(r in b.attributes)){let S=0;for(const r in x)S+=x[r].count;b.setAttribute(r,createAttributeClone(B[r][0],S))}const S=b.attributes[r];let C=0;for(let r=0,b=x.length;r<b;r++){const b=x[r];!0!==I[r]&&copyAttributeContents(b,S,C),C+=b.count}}}(C,{useGroups:S,skipAttributes:x},r);for(const x in r.attributes)r.attributes[x].needsUpdate=!0;return r}_convertToStaticGeometry(r,x=new Z){const b=r.geometry,S=this.applyWorldTransforms,C=this.attributes.includes("normal"),A=this.attributes.includes("tangent"),I=b.attributes,R=x.attributes;!x.index&&b.index&&(x.index=b.index.clone()),R.position||x.setAttribute("position",createAttributeClone(I.position)),C&&!R.normal&&I.normal&&x.setAttribute("normal",createAttributeClone(I.normal)),A&&!R.tangent&&I.tangent&&x.setAttribute("tangent",createAttributeClone(I.tangent)),validateAttributes(b.index,x.index),validateAttributes(I.position,R.position),C&&validateAttributes(I.normal,R.normal),A&&validateAttributes(I.tangent,R.tangent);const B=I.position,D=C?I.normal:null,F=A?I.tangent:null,G=b.morphAttributes.position,N=b.morphAttributes.normal,H=b.morphAttributes.tangent,W=b.morphTargetsRelative,V=r.morphTargetInfluences,j=new Q;j.getNormalMatrix(r.matrixWorld),b.index&&x.index.array.set(b.index.array);for(let x=0,b=I.position.count;x<b;x++)dr.fromBufferAttribute(B,x),D&&ur.fromBufferAttribute(D,x),F&&(fr.fromBufferAttribute(F,x),pr.fromBufferAttribute(F,x)),V&&(G&&applyMorphTarget(G,V,W,x,dr),N&&applyMorphTarget(N,V,W,x,ur),H&&applyMorphTarget(H,V,W,x,pr)),r.isSkinnedMesh&&(r.applyBoneTransform(x,dr),D&&boneNormalTransform(r,x,ur),F&&boneNormalTransform(r,x,pr)),S&&dr.applyMatrix4(r.matrixWorld),R.position.setXYZ(x,dr.x,dr.y,dr.z),D&&(S&&ur.applyNormalMatrix(j),R.normal.setXYZ(x,ur.x,ur.y,ur.z)),F&&(S&&pr.transformDirection(r.matrixWorld),R.tangent.setXYZW(x,pr.x,pr.y,pr.z,fr.w));for(const r in this.attributes){const b=this.attributes[r];"position"!==b&&"tangent"!==b&&"normal"!==b&&b in I&&(R[b]||x.setAttribute(b,createAttributeClone(I[b])),validateAttributes(I[b],R[b]),copyAttributeContents(I[b],R[b]))}return r.matrixWorld.determinant()<0&&function(r){const{index:x,attributes:b}=r;if(x)for(let r=0,b=x.count;r<b;r+=3){const b=x.getX(r),S=x.getX(r+2);x.setX(r,S),x.setX(r+2,b)}else for(const r in b){const x=b[r],S=x.itemSize;for(let r=0,b=x.count;r<b;r+=3)for(let b=0;b<S;b++){const S=x.getComponent(r,b),C=x.getComponent(r+2,b);x.setComponent(r,b,C),x.setComponent(r+2,b,S)}}}(x),x}}const br="\n\n// A stack of uint32 indices can can store the indices for\n// a perfectly balanced tree with a depth up to 31. Lower stack\n// depth gets higher performance.\n//\n// However not all trees are balanced. Best value to set this to\n// is the trees max depth.\n#ifndef BVH_STACK_DEPTH\n#define BVH_STACK_DEPTH 60\n#endif\n\n#ifndef INFINITY\n#define INFINITY 1e20\n#endif\n\n// Utilities\nuvec4 uTexelFetch1D( usampler2D tex, uint index ) {\n\n\tuint width = uint( textureSize( tex, 0 ).x );\n\tuvec2 uv;\n\tuv.x = index % width;\n\tuv.y = index / width;\n\n\treturn texelFetch( tex, ivec2( uv ), 0 );\n\n}\n\nivec4 iTexelFetch1D( isampler2D tex, uint index ) {\n\n\tuint width = uint( textureSize( tex, 0 ).x );\n\tuvec2 uv;\n\tuv.x = index % width;\n\tuv.y = index / width;\n\n\treturn texelFetch( tex, ivec2( uv ), 0 );\n\n}\n\nvec4 texelFetch1D( sampler2D tex, uint index ) {\n\n\tuint width = uint( textureSize( tex, 0 ).x );\n\tuvec2 uv;\n\tuv.x = index % width;\n\tuv.y = index / width;\n\n\treturn texelFetch( tex, ivec2( uv ), 0 );\n\n}\n\nvec4 textureSampleBarycoord( sampler2D tex, vec3 barycoord, uvec3 faceIndices ) {\n\n\treturn\n\t\tbarycoord.x * texelFetch1D( tex, faceIndices.x ) +\n\t\tbarycoord.y * texelFetch1D( tex, faceIndices.y ) +\n\t\tbarycoord.z * texelFetch1D( tex, faceIndices.z );\n\n}\n\nvoid ndcToCameraRay(\n\tvec2 coord, mat4 cameraWorld, mat4 invProjectionMatrix,\n\tout vec3 rayOrigin, out vec3 rayDirection\n) {\n\n\t// get camera look direction and near plane for camera clipping\n\tvec4 lookDirection = cameraWorld * vec4( 0.0, 0.0, - 1.0, 0.0 );\n\tvec4 nearVector = invProjectionMatrix * vec4( 0.0, 0.0, - 1.0, 1.0 );\n\tfloat near = abs( nearVector.z / nearVector.w );\n\n\t// get the camera direction and position from camera matrices\n\tvec4 origin = cameraWorld * vec4( 0.0, 0.0, 0.0, 1.0 );\n\tvec4 direction = invProjectionMatrix * vec4( coord, 0.5, 1.0 );\n\tdirection /= direction.w;\n\tdirection = cameraWorld * direction - origin;\n\n\t// slide the origin along the ray until it sits at the near clip plane position\n\torigin.xyz += direction.xyz * near / dot( direction, lookDirection );\n\n\trayOrigin = origin.xyz;\n\trayDirection = direction.xyz;\n\n}\n",Tr="\n\nfloat dot2( vec3 v ) {\n\n\treturn dot( v, v );\n\n}\n\n// https://www.shadertoy.com/view/ttfGWl\nvec3 closestPointToTriangle( vec3 p, vec3 v0, vec3 v1, vec3 v2, out vec3 barycoord ) {\n\n    vec3 v10 = v1 - v0;\n    vec3 v21 = v2 - v1;\n    vec3 v02 = v0 - v2;\n\n\tvec3 p0 = p - v0;\n\tvec3 p1 = p - v1;\n\tvec3 p2 = p - v2;\n\n    vec3 nor = cross( v10, v02 );\n\n    // method 2, in barycentric space\n    vec3  q = cross( nor, p0 );\n    float d = 1.0 / dot2( nor );\n    float u = d * dot( q, v02 );\n    float v = d * dot( q, v10 );\n    float w = 1.0 - u - v;\n\n\tif( u < 0.0 ) {\n\n\t\tw = clamp( dot( p2, v02 ) / dot2( v02 ), 0.0, 1.0 );\n\t\tu = 0.0;\n\t\tv = 1.0 - w;\n\n\t} else if( v < 0.0 ) {\n\n\t\tu = clamp( dot( p0, v10 ) / dot2( v10 ), 0.0, 1.0 );\n\t\tv = 0.0;\n\t\tw = 1.0 - u;\n\n\t} else if( w < 0.0 ) {\n\n\t\tv = clamp( dot( p1, v21 ) / dot2( v21 ), 0.0, 1.0 );\n\t\tw = 0.0;\n\t\tu = 1.0-v;\n\n\t}\n\n\tbarycoord = vec3( u, v, w );\n    return u * v1 + v * v2 + w * v0;\n\n}\n\nfloat distanceToTriangles(\n\t// geometry info and triangle range\n\tsampler2D positionAttr, usampler2D indexAttr, uint offset, uint count,\n\n\t// point and cut off range\n\tvec3 point, float closestDistanceSquared,\n\n\t// outputs\n\tinout uvec4 faceIndices, inout vec3 faceNormal, inout vec3 barycoord, inout float side, inout vec3 outPoint\n) {\n\n\tbool found = false;\n\tvec3 localBarycoord;\n\tfor ( uint i = offset, l = offset + count; i < l; i ++ ) {\n\n\t\tuvec3 indices = uTexelFetch1D( indexAttr, i ).xyz;\n\t\tvec3 a = texelFetch1D( positionAttr, indices.x ).rgb;\n\t\tvec3 b = texelFetch1D( positionAttr, indices.y ).rgb;\n\t\tvec3 c = texelFetch1D( positionAttr, indices.z ).rgb;\n\n\t\t// get the closest point and barycoord\n\t\tvec3 closestPoint = closestPointToTriangle( point, a, b, c, localBarycoord );\n\t\tvec3 delta = point - closestPoint;\n\t\tfloat sqDist = dot2( delta );\n\t\tif ( sqDist < closestDistanceSquared ) {\n\n\t\t\t// set the output results\n\t\t\tclosestDistanceSquared = sqDist;\n\t\t\tfaceIndices = uvec4( indices.xyz, i );\n\t\t\tfaceNormal = normalize( cross( a - b, b - c ) );\n\t\t\tbarycoord = localBarycoord;\n\t\t\toutPoint = closestPoint;\n\t\t\tside = sign( dot( faceNormal, delta ) );\n\n\t\t}\n\n\t}\n\n\treturn closestDistanceSquared;\n\n}\n\nfloat distanceSqToBounds( vec3 point, vec3 boundsMin, vec3 boundsMax ) {\n\n\tvec3 clampedPoint = clamp( point, boundsMin, boundsMax );\n\tvec3 delta = point - clampedPoint;\n\treturn dot( delta, delta );\n\n}\n\nfloat distanceSqToBVHNodeBoundsPoint( vec3 point, sampler2D bvhBounds, uint currNodeIndex ) {\n\n\tuint cni2 = currNodeIndex * 2u;\n\tvec3 boundsMin = texelFetch1D( bvhBounds, cni2 ).xyz;\n\tvec3 boundsMax = texelFetch1D( bvhBounds, cni2 + 1u ).xyz;\n\treturn distanceSqToBounds( point, boundsMin, boundsMax );\n\n}\n\n// use a macro to hide the fact that we need to expand the struct into separate fields\n#define\tbvhClosestPointToPoint(\t\tbvh,\t\tpoint, faceIndices, faceNormal, barycoord, side, outPoint\t)\t_bvhClosestPointToPoint(\t\tbvh.position, bvh.index, bvh.bvhBounds, bvh.bvhContents,\t\tpoint, faceIndices, faceNormal, barycoord, side, outPoint\t)\n\nfloat _bvhClosestPointToPoint(\n\t// bvh info\n\tsampler2D bvh_position, usampler2D bvh_index, sampler2D bvh_bvhBounds, usampler2D bvh_bvhContents,\n\n\t// point to check\n\tvec3 point,\n\n\t// output variables\n\tinout uvec4 faceIndices, inout vec3 faceNormal, inout vec3 barycoord,\n\tinout float side, inout vec3 outPoint\n ) {\n\n\t// stack needs to be twice as long as the deepest tree we expect because\n\t// we push both the left and right child onto the stack every traversal\n\tint ptr = 0;\n\tuint stack[ BVH_STACK_DEPTH ];\n\tstack[ 0 ] = 0u;\n\n\tfloat closestDistanceSquared = pow( 100000.0, 2.0 );\n\tbool found = false;\n\twhile ( ptr > - 1 && ptr < BVH_STACK_DEPTH ) {\n\n\t\tuint currNodeIndex = stack[ ptr ];\n\t\tptr --;\n\n\t\t// check if we intersect the current bounds\n\t\tfloat boundsHitDistance = distanceSqToBVHNodeBoundsPoint( point, bvh_bvhBounds, currNodeIndex );\n\t\tif ( boundsHitDistance > closestDistanceSquared ) {\n\n\t\t\tcontinue;\n\n\t\t}\n\n\t\tuvec2 boundsInfo = uTexelFetch1D( bvh_bvhContents, currNodeIndex ).xy;\n\t\tbool isLeaf = bool( boundsInfo.x & 0xffff0000u );\n\t\tif ( isLeaf ) {\n\n\t\t\tuint count = boundsInfo.x & 0x0000ffffu;\n\t\t\tuint offset = boundsInfo.y;\n\t\t\tclosestDistanceSquared = distanceToTriangles(\n\t\t\t\tbvh_position, bvh_index, offset, count, point, closestDistanceSquared,\n\n\t\t\t\t// outputs\n\t\t\t\tfaceIndices, faceNormal, barycoord, side, outPoint\n\t\t\t);\n\n\t\t} else {\n\n\t\t\tuint leftIndex = currNodeIndex + 1u;\n\t\t\tuint splitAxis = boundsInfo.x & 0x0000ffffu;\n\t\t\tuint rightIndex = boundsInfo.y;\n\t\t\tbool leftToRight = distanceSqToBVHNodeBoundsPoint( point, bvh_bvhBounds, leftIndex ) < distanceSqToBVHNodeBoundsPoint( point, bvh_bvhBounds, rightIndex );//rayDirection[ splitAxis ] >= 0.0;\n\t\t\tuint c1 = leftToRight ? leftIndex : rightIndex;\n\t\t\tuint c2 = leftToRight ? rightIndex : leftIndex;\n\n\t\t\t// set c2 in the stack so we traverse it later. We need to keep track of a pointer in\n\t\t\t// the stack while we traverse. The second pointer added is the one that will be\n\t\t\t// traversed first\n\t\t\tptr ++;\n\t\t\tstack[ ptr ] = c2;\n\t\t\tptr ++;\n\t\t\tstack[ ptr ] = c1;\n\n\t\t}\n\n\t}\n\n\treturn sqrt( closestDistanceSquared );\n\n}\n",wr="\n\n#ifndef TRI_INTERSECT_EPSILON\n#define TRI_INTERSECT_EPSILON 1e-5\n#endif\n\n// Raycasting\nbool intersectsBounds( vec3 rayOrigin, vec3 rayDirection, vec3 boundsMin, vec3 boundsMax, out float dist ) {\n\n\t// https://www.reddit.com/r/opengl/comments/8ntzz5/fast_glsl_ray_box_intersection/\n\t// https://tavianator.com/2011/ray_box.html\n\tvec3 invDir = 1.0 / rayDirection;\n\n\t// find intersection distances for each plane\n\tvec3 tMinPlane = invDir * ( boundsMin - rayOrigin );\n\tvec3 tMaxPlane = invDir * ( boundsMax - rayOrigin );\n\n\t// get the min and max distances from each intersection\n\tvec3 tMinHit = min( tMaxPlane, tMinPlane );\n\tvec3 tMaxHit = max( tMaxPlane, tMinPlane );\n\n\t// get the furthest hit distance\n\tvec2 t = max( tMinHit.xx, tMinHit.yz );\n\tfloat t0 = max( t.x, t.y );\n\n\t// get the minimum hit distance\n\tt = min( tMaxHit.xx, tMaxHit.yz );\n\tfloat t1 = min( t.x, t.y );\n\n\t// set distance to 0.0 if the ray starts inside the box\n\tdist = max( t0, 0.0 );\n\n\treturn t1 >= dist;\n\n}\n\nbool intersectsTriangle(\n\tvec3 rayOrigin, vec3 rayDirection, vec3 a, vec3 b, vec3 c,\n\tout vec3 barycoord, out vec3 norm, out float dist, out float side\n) {\n\n\t// https://stackoverflow.com/questions/42740765/intersection-between-line-and-triangle-in-3d\n\tvec3 edge1 = b - a;\n\tvec3 edge2 = c - a;\n\tnorm = cross( edge1, edge2 );\n\n\tfloat det = - dot( rayDirection, norm );\n\tfloat invdet = 1.0 / det;\n\n\tvec3 AO = rayOrigin - a;\n\tvec3 DAO = cross( AO, rayDirection );\n\n\tvec4 uvt;\n\tuvt.x = dot( edge2, DAO ) * invdet;\n\tuvt.y = - dot( edge1, DAO ) * invdet;\n\tuvt.z = dot( AO, norm ) * invdet;\n\tuvt.w = 1.0 - uvt.x - uvt.y;\n\n\t// set the hit information\n\tbarycoord = uvt.wxy; // arranged in A, B, C order\n\tdist = uvt.z;\n\tside = sign( det );\n\tnorm = side * normalize( norm );\n\n\t// add an epsilon to avoid misses between triangles\n\tuvt += vec4( TRI_INTERSECT_EPSILON );\n\n\treturn all( greaterThanEqual( uvt, vec4( 0.0 ) ) );\n\n}\n\nbool intersectTriangles(\n\t// geometry info and triangle range\n\tsampler2D positionAttr, usampler2D indexAttr, uint offset, uint count,\n\n\t// ray\n\tvec3 rayOrigin, vec3 rayDirection,\n\n\t// outputs\n\tinout float minDistance, inout uvec4 faceIndices, inout vec3 faceNormal, inout vec3 barycoord,\n\tinout float side, inout float dist\n) {\n\n\tbool found = false;\n\tvec3 localBarycoord, localNormal;\n\tfloat localDist, localSide;\n\tfor ( uint i = offset, l = offset + count; i < l; i ++ ) {\n\n\t\tuvec3 indices = uTexelFetch1D( indexAttr, i ).xyz;\n\t\tvec3 a = texelFetch1D( positionAttr, indices.x ).rgb;\n\t\tvec3 b = texelFetch1D( positionAttr, indices.y ).rgb;\n\t\tvec3 c = texelFetch1D( positionAttr, indices.z ).rgb;\n\n\t\tif (\n\t\t\tintersectsTriangle( rayOrigin, rayDirection, a, b, c, localBarycoord, localNormal, localDist, localSide )\n\t\t\t&& localDist < minDistance\n\t\t) {\n\n\t\t\tfound = true;\n\t\t\tminDistance = localDist;\n\n\t\t\tfaceIndices = uvec4( indices.xyz, i );\n\t\t\tfaceNormal = localNormal;\n\n\t\t\tside = localSide;\n\t\t\tbarycoord = localBarycoord;\n\t\t\tdist = localDist;\n\n\t\t}\n\n\t}\n\n\treturn found;\n\n}\n\nbool intersectsBVHNodeBounds( vec3 rayOrigin, vec3 rayDirection, sampler2D bvhBounds, uint currNodeIndex, out float dist ) {\n\n\tuint cni2 = currNodeIndex * 2u;\n\tvec3 boundsMin = texelFetch1D( bvhBounds, cni2 ).xyz;\n\tvec3 boundsMax = texelFetch1D( bvhBounds, cni2 + 1u ).xyz;\n\treturn intersectsBounds( rayOrigin, rayDirection, boundsMin, boundsMax, dist );\n\n}\n\n// use a macro to hide the fact that we need to expand the struct into separate fields\n#define\tbvhIntersectFirstHit(\t\tbvh,\t\trayOrigin, rayDirection, faceIndices, faceNormal, barycoord, side, dist\t)\t_bvhIntersectFirstHit(\t\tbvh.position, bvh.index, bvh.bvhBounds, bvh.bvhContents,\t\trayOrigin, rayDirection, faceIndices, faceNormal, barycoord, side, dist\t)\n\nbool _bvhIntersectFirstHit(\n\t// bvh info\n\tsampler2D bvh_position, usampler2D bvh_index, sampler2D bvh_bvhBounds, usampler2D bvh_bvhContents,\n\n\t// ray\n\tvec3 rayOrigin, vec3 rayDirection,\n\n\t// output variables split into separate variables due to output precision\n\tinout uvec4 faceIndices, inout vec3 faceNormal, inout vec3 barycoord,\n\tinout float side, inout float dist\n) {\n\n\t// stack needs to be twice as long as the deepest tree we expect because\n\t// we push both the left and right child onto the stack every traversal\n\tint ptr = 0;\n\tuint stack[ BVH_STACK_DEPTH ];\n\tstack[ 0 ] = 0u;\n\n\tfloat triangleDistance = INFINITY;\n\tbool found = false;\n\twhile ( ptr > - 1 && ptr < BVH_STACK_DEPTH ) {\n\n\t\tuint currNodeIndex = stack[ ptr ];\n\t\tptr --;\n\n\t\t// check if we intersect the current bounds\n\t\tfloat boundsHitDistance;\n\t\tif (\n\t\t\t! intersectsBVHNodeBounds( rayOrigin, rayDirection, bvh_bvhBounds, currNodeIndex, boundsHitDistance )\n\t\t\t|| boundsHitDistance > triangleDistance\n\t\t) {\n\n\t\t\tcontinue;\n\n\t\t}\n\n\t\tuvec2 boundsInfo = uTexelFetch1D( bvh_bvhContents, currNodeIndex ).xy;\n\t\tbool isLeaf = bool( boundsInfo.x & 0xffff0000u );\n\n\t\tif ( isLeaf ) {\n\n\t\t\tuint count = boundsInfo.x & 0x0000ffffu;\n\t\t\tuint offset = boundsInfo.y;\n\n\t\t\tfound = intersectTriangles(\n\t\t\t\tbvh_position, bvh_index, offset, count,\n\t\t\t\trayOrigin, rayDirection, triangleDistance,\n\t\t\t\tfaceIndices, faceNormal, barycoord, side, dist\n\t\t\t) || found;\n\n\t\t} else {\n\n\t\t\tuint leftIndex = currNodeIndex + 1u;\n\t\t\tuint splitAxis = boundsInfo.x & 0x0000ffffu;\n\t\t\tuint rightIndex = boundsInfo.y;\n\n\t\t\tbool leftToRight = rayDirection[ splitAxis ] >= 0.0;\n\t\t\tuint c1 = leftToRight ? leftIndex : rightIndex;\n\t\t\tuint c2 = leftToRight ? rightIndex : leftIndex;\n\n\t\t\t// set c2 in the stack so we traverse it later. We need to keep track of a pointer in\n\t\t\t// the stack while we traverse. The second pointer added is the one that will be\n\t\t\t// traversed first\n\t\t\tptr ++;\n\t\t\tstack[ ptr ] = c2;\n\n\t\t\tptr ++;\n\t\t\tstack[ ptr ] = c1;\n\n\t\t}\n\n\t}\n\n\treturn found;\n\n}\n",Sr="\nstruct BVH {\n\n\tusampler2D index;\n\tsampler2D position;\n\n\tsampler2D bvhBounds;\n\tusampler2D bvhContents;\n\n};\n";var Cr=Object.freeze({__proto__:null,bvh_distance_functions:Tr,bvh_ray_functions:wr,bvh_struct_definitions:Sr,common_functions:br});const Ar=Sr,Ir=Tr,kr=`\n\t${br}\n\t${wr}\n`;var Er=Object.freeze({__proto__:null,AVERAGE:bt,BVHShaderGLSL:Cr,CENTER:xt,CONTAINED:wt,ExtendedTriangle:ExtendedTriangle,FloatVertexAttributeTexture:FloatVertexAttributeTexture,INTERSECTED:1,IntVertexAttributeTexture:class extends VertexAttributeTexture{constructor(){super(),this._forcedType=K}},MeshBVH:MeshBVH,MeshBVHHelper:MeshBVHHelper,MeshBVHUniformStruct:class{constructor(){this.index=new UIntVertexAttributeTexture,this.position=new FloatVertexAttributeTexture,this.bvhBounds=new j,this.bvhContents=new j,this._cachedIndexAttr=null,this.index.overrideItemSize=3}updateFrom(r){const{geometry:x}=r;if(function(r,x,b){const S=r._roots;if(1!==S.length)throw new Error("MeshBVHUniformStruct: Multi-root BVHs not supported.");const C=S[0],A=new Uint16Array(C),I=new Uint32Array(C),R=new Float32Array(C),B=C.byteLength/At,D=2*Math.ceil(Math.sqrt(B/2)),F=new Float32Array(4*D*D),G=Math.ceil(Math.sqrt(B)),N=new Uint32Array(2*G*G);for(let r=0;r<B;r++){const x=r*At/4,b=2*x,S=x;for(let x=0;x<3;x++)F[8*r+0+x]=R[S+0+x],F[8*r+4+x]=R[S+3+x];if(IS_LEAF(b,A)){const S=COUNT(b,A),C=OFFSET(x,I),R=4294901760|S;N[2*r+0]=R,N[2*r+1]=C}else{const b=4*RIGHT_NODE(x,I)/At,S=SPLIT_AXIS(x,I);N[2*r+0]=S,N[2*r+1]=b}}x.image.data=F,x.image.width=D,x.image.height=D,x.format=Y,x.type=$,x.internalFormat="RGBA32F",x.minFilter=X,x.magFilter=X,x.generateMipmaps=!1,x.needsUpdate=!0,x.dispose(),b.image.data=N,b.image.width=G,b.image.height=G,b.format=J,b.type=q,b.internalFormat="RG32UI",b.minFilter=X,b.magFilter=X,b.generateMipmaps=!1,b.needsUpdate=!0,b.dispose()}(r,this.bvhBounds,this.bvhContents),this.position.updateFrom(x.attributes.position),r.indirect){const b=r._indirectBuffer;if(null===this._cachedIndexAttr||this._cachedIndexAttr.count!==b.length)if(x.index)this._cachedIndexAttr=x.index.clone();else{const r=getIndexArray(getVertexCount(x));this._cachedIndexAttr=new G(r,1,!1)}!function(r,x,b){const S=b.array,C=r.index?r.index.array:null;for(let r=0,b=x.length;r<b;r++){const b=3*r,A=3*x[r];for(let r=0;r<3;r++)S[b+r]=C?C[A+r]:A+r}}(x,b,this._cachedIndexAttr),this.index.updateFrom(this._cachedIndexAttr)}else this.index.updateFrom(x.index)}dispose(){const{index:r,position:x,bvhBounds:b,bvhContents:S}=this;r&&r.dispose(),x&&x.dispose(),b&&b.dispose(),S&&S.dispose()}},NOT_INTERSECTED:0,OrientedBox:OrientedBox,SAH:Tt,StaticGeometryGenerator:StaticGeometryGenerator,UIntVertexAttributeTexture:UIntVertexAttributeTexture,VertexAttributeTexture:VertexAttributeTexture,acceleratedRaycast:function(r,x){this.isBatchedMesh?acceleratedBatchedMeshRaycast.call(this,r,x):acceleratedMeshRaycast.call(this,r,x)},computeBatchedBoundsTree:function(r=-1,x={}){if(!nr)throw new Error("BatchedMesh: Three r166+ is required to compute bounds trees.");x.indirect&&console.warn('"Indirect" is set to false because it is not supported for BatchedMesh.'),x={...x,indirect:!1,range:null};const b=this._drawRanges,S=this._geometryCount;this.boundsTrees||(this.boundsTrees=new Array(S).fill(null));const C=this.boundsTrees;for(;C.length<S;)C.push(null);if(r<0){for(let r=0;r<S;r++)x.range=b[r],C[r]=new MeshBVH(this.geometry,x);return C}return r<b.length&&(x.range=b[r],C[r]=new MeshBVH(this.geometry,x)),C[r]||null},computeBoundsTree:function(r={}){return this.boundsTree=new MeshBVH(this,r),this.boundsTree},disposeBatchedBoundsTree:function(r=-1){r<0?this.boundsTrees.fill(null):r<this.boundsTree.length&&(this.boundsTrees[r]=null)},disposeBoundsTree:function(){this.boundsTree=null},estimateMemoryInBytes:function(r){const x=new Set,b=[r];let S=0;for(;b.length;){const r=b.pop();if(!x.has(r)){x.add(r);for(let x in r){if(!Object.hasOwn(r,x))continue;S+=getPrimitiveSize(x);const C=r[x];!C||"object"!=typeof C&&"function"!=typeof C?S+=getPrimitiveSize(C):/(Uint|Int|Float)(8|16|32)Array/.test(C.constructor.name)||isSharedArrayBufferSupported()&&C instanceof SharedArrayBuffer||C instanceof ArrayBuffer?S+=C.byteLength:b.push(C)}}}return S},getBVHExtremes:function(r){return r._roots.map(((x,b)=>function(r,x){const b={nodeCount:0,leafNodeCount:0,depth:{min:1/0,max:-1/0},tris:{min:1/0,max:-1/0},splits:[0,0,0],surfaceAreaScore:0};return r.traverse(((r,x,S,C,A)=>{const I=S[3]-S[0],R=S[4]-S[1],B=S[5]-S[2],D=2*(I*R+R*B+B*I);b.nodeCount++,x?(b.leafNodeCount++,b.depth.min=Math.min(r,b.depth.min),b.depth.max=Math.max(r,b.depth.max),b.tris.min=Math.min(A,b.tris.min),b.tris.max=Math.max(A,b.tris.max),b.surfaceAreaScore+=D*St*A):(b.splits[C]++,b.surfaceAreaScore+=D*Ct)}),x),b.tris.min===1/0&&(b.tris.min=0,b.tris.max=0),b.depth.min===1/0&&(b.depth.min=0,b.depth.max=0),b}(r,b)))},getJSONStructure:function(r){const x=[];return r.traverse(((r,b,S,C,I)=>{const R={bounds:arrayToBox(0,S,new A)};b?(R.count=I,R.offset=C):(R.left=null,R.right=null),x[r]=R;const B=x[r-1];B&&(null===B.left?B.left=R:B.right=R)})),x[0]},getTriangleHitPointInfo:function(r,S,C,A){const I=S.getIndex().array,R=S.getAttribute("position"),D=S.getAttribute("uv"),F=I[3*C],G=I[3*C+1],N=I[3*C+2];on.fromBufferAttribute(R,F),an.fromBufferAttribute(R,G),ln.fromBufferAttribute(R,N);let H=0;const W=S.groups,V=3*C;for(let r=0,x=W.length;r<x;r++){const x=W[r],{start:b,count:S}=x;if(V>=b&&V<b+S){H=x.materialIndex;break}}let j=null;return D&&(hn.fromBufferAttribute(D,F),cn.fromBufferAttribute(D,G),dn.fromBufferAttribute(D,N),j=A&&A.uv?A.uv:new b,B.getInterpolation(r,on,an,ln,hn,cn,dn,j)),A?(A.face||(A.face={}),A.face.a=F,A.face.b=G,A.face.c=N,A.face.materialIndex=H,A.face.normal||(A.face.normal=new x),B.getNormal(on,an,ln,A.face.normal),j&&(A.uv=j),A):{face:{a:F,b:G,c:N,materialIndex:H,normal:B.getNormal(on,an,ln,new x)},uv:j}},shaderDistanceFunction:Ir,shaderIntersectFunction:kr,shaderStructs:Ar,validateBounds:function(r){const x=r.geometry,b=[],S=x.index,C=x.getAttribute("position");let A=!0;return r.traverse(((x,I,R,B,D)=>{const F={depth:x,isLeaf:I,boundingData:R,offset:B,count:D};b[x]=F,arrayToBox(0,R,Qn);const G=b[x-1];if(I)for(let x=B,b=B+D;x<b;x++){const b=r.resolveTriangleIndex(x);let I,R=3*b,B=3*b+1,D=3*b+2;S&&(R=S.getX(R),B=S.getX(B),D=S.getX(D)),tr.fromBufferAttribute(C,R),I=Qn.containsPoint(tr),tr.fromBufferAttribute(C,B),I=I&&Qn.containsPoint(tr),tr.fromBufferAttribute(C,D),I=I&&Qn.containsPoint(tr),console.assert(I,"Leaf bounds does not fully contain triangle."),A=A&&I}if(G){arrayToBox(0,R,er);const r=er.containsBox(Qn);console.assert(r,"Parent bounds does not fully contain child."),A=A&&r}})),A}});const numberOr=(r,x)=>"number"==typeof r?r:x,capitalizeFirstLetter=r=>r.charAt(0).toUpperCase()+r.slice(1),isDescendant=(r,x)=>{for(;x?.parent;){if(x.parent==r)return!0;x=x.parent}return!1},cartesianToPolar=(r,x)=>[Math.sqrt(r*r+x*x),Math.atan2(x,r)],polarToCartesian=(r,x)=>[r*Math.cos(x),r*Math.sin(x)],radiansToDegrees=r=>(r+Math.PI)/(2*Math.PI)*360;function hueToRGB(r,x,b){return b<0&&(b+=1),b>1&&(b-=1),b<1/6?r+6*(x-r)*b:b<.5?x:b<2/3?r+(x-r)*(2/3-b)*6:r}const hslToRGB=(r,x,b)=>{let S,C,A;if(r/=360,0==x)S=C=A=b;else{let I=b<.5?b*(1+x):b+x-b*x,R=2*b-I;S=hueToRGB(R,I,r+1/3),C=hueToRGB(R,I,r),A=hueToRGB(R,I,r-1/3)}return[Math.round(255*S),Math.round(255*C),Math.round(255*A)]},rgbToHex=(r,x,b)=>r<<16^x<<8^b<<0;function containsGeometry(r){if(r.geometry)return!0;for(let x of r.children)if(containsGeometry(x))return!0;return!1}const setupBVHForComplexObject=r=>{if(!containsGeometry(r))return!1;if(r.parent){let x=r.parent;x.remove(r),r.updateMatrixWorld(!0),x.add(r)}if(r.children?.length){r.staticGeometryGenerator=new StaticGeometryGenerator([r]);try{r.bvhGeometry=r.staticGeometryGenerator.generate()}catch(r){return console.error(r),!1}}else r.bvhGeometry=r.geometry;return r.bvhGeometry.computeBoundsTree(),r.parent&&r.updateMatrixWorld(!0),!0},updateBVHForComplexObject=r=>{if(!r.staticGeometryGenerator)return setupBVHForComplexObject(r);if(r.parent){let x=r.parent;x.remove(r),r.updateMatrixWorld(!0),x.add(r)}r.staticGeometryGenerator.generate(r.bvhGeometry),r.bvhGeometry.boundsTree.refit(),r.parent&&r.updateMatrixWorld(!0)};var Rr=Object.freeze({__proto__:null,addBVHHelper:x=>{if(x.bvhGeometry&&x.geomtry==x.bvhGeometry)return void x.parent.add(new MeshBVHHelper(x));let b=new r.MeshBasicMaterial({wireframe:!0,transparent:!0,opacity:.05,depthWrite:!1}),S=new r.Mesh(x.bvhGeometry,b);x.parent.add(S);let C=new MeshBVHHelper(S,10);x.parent.add(C),x.bvhHelper=C},capitalizeFirstLetter:capitalizeFirstLetter,cartesianToPolar:cartesianToPolar,hslToRGB:hslToRGB,isDescendant:isDescendant,numberOr:numberOr,polarToCartesian:polarToCartesian,radiansToDegrees:radiansToDegrees,rgbToHex:rgbToHex,setupBVHForComplexObject:setupBVHForComplexObject,updateBVHForComplexObject:updateBVHForComplexObject});class UIComponent extends r.Object3D{constructor(...r){super(),r=Array.from(new Set(r)),this._styles=[],this._needsUpdate={},this._overrideStyle={},this._latestValue={},this._defaults={},this._styleListener=r=>this._onStyleChange(r);for(let x of r)x&&(x instanceof Style||(x=new Style(x)),this._styles.push(x),x.addUpdateListener(this._styleListener))}addStyle(r){let x=!1;for(let b=this._styles.length-1;b>=0;b--)r==this._styles[b]&&(this._styles.splice(b,1),x=!0);this._styles.push(r);for(let x of Style.PROPERTIES)null!=r[x]&&this._onStyleChange(x);x||r.addUpdateListener(this._styleListener)}_onStyleChange(r){this._needsUpdate[r]=!0;let x="_handleStyleUpdateFor"+capitalizeFirstLetter(r);x in this&&this[x]()}removeStyle(r){let x=!1;for(let b=this._styles.length-1;b>=0;b--)r==this._styles[b]&&(this._styles.splice(b,1),x=!0);if(x){for(let x of Style.PROPERTIES)null!=r[x]&&this._onStyleChange(x);r.removeUpdateListener(this._styleListener)}}_genericGet(r){if(r in this._overrideStyle)return this._overrideStyle[r];if(!this._needsUpdate[r]&&null!=this._latestValue[r])return this._latestValue[r];for(let x=this._styles.length-1;x>=0;x--){let b=this._styles[x][r];if(null!=b)return this._needsUpdate[r]=!1,this._latestValue[r]=b,b}return this._needsUpdate[r]=!1,this._latestValue[r]=this._defaults[r],this._defaults[r]}_genericSet(r,x){null==x?delete this._overrideStyle[r]:this._overrideStyle[r]=x;let b="_handleStyleUpdateFor"+capitalizeFirstLetter(r);b in this&&this[b]()}get alignItems(){return this._genericGet("alignItems")}get backgroundVisible(){return this._genericGet("backgroundVisible")}get borderMaterial(){return this._genericGet("borderMaterial")}get borderRadius(){return this._genericGet("borderRadius")}get borderBottomLeftRadius(){return this._genericGet("borderBottomLeftRadius")}get borderBottomRightRadius(){return this._genericGet("borderBottomRightRadius")}get borderTopLeftRadius(){return this._genericGet("borderTopLeftRadius")}get borderTopRightRadius(){return this._genericGet("borderTopRightRadius")}get borderWidth(){return this._genericGet("borderWidth")}get color(){return this._genericGet("color")}get contentDirection(){return this._genericGet("contentDirection")}get font(){return this._genericGet("font")}get fontSize(){return this._genericGet("fontSize")}get glassmorphism(){return this._genericGet("glassmorphism")}get height(){return this._genericGet("height")}get justifyContent(){return this._genericGet("justifyContent")}get margin(){return this._genericGet("margin")}get marginBottom(){return this._genericGet("marginBottom")}get marginLeft(){return this._genericGet("marginLeft")}get marginRight(){return this._genericGet("marginRight")}get marginTop(){return this._genericGet("marginTop")}get material(){return this._genericGet("material")}get materialColor(){return this._genericGet("materialColor")}get maxHeight(){return this._genericGet("maxHeight")}get maxWidth(){return this._genericGet("maxWidth")}get minHeight(){return this._genericGet("minHeight")}get minWidth(){return this._genericGet("minWidth")}get opacity(){return this._genericGet("opacity")}get overflow(){return this._genericGet("overflow")}get padding(){return this._genericGet("padding")}get paddingBottom(){return this._genericGet("paddingBottom")}get paddingLeft(){return this._genericGet("paddingLeft")}get paddingRight(){return this._genericGet("paddingRight")}get paddingTop(){return this._genericGet("paddingTop")}get pointerInteractableClassOverride(){return this._genericGet("pointerInteractableClassOverride")}get textAlign(){return this._genericGet("textAlign")}get textureFit(){return this._genericGet("textureFit")}get width(){return this._genericGet("width")}set alignItems(r){this._genericSet("alignItems",r)}set backgroundVisible(r){this._genericSet("backgroundVisible",r)}set borderMaterial(r){this._genericSet("borderMaterial",r)}set borderRadius(r){this._genericSet("borderRadius",r)}set borderBottomLeftRadius(r){this._genericSet("borderBottomLeftRadius",r)}set borderBottomRightRadius(r){this._genericSet("borderBottomRightRadius",r)}set borderTopLeftRadius(r){this._genericSet("borderTopLeftRadius",r)}set borderTopRightRadius(r){this._genericSet("borderTopRightRadius",r)}set borderWidth(r){this._genericSet("borderWidth",r)}set color(r){this._genericSet("color",r)}set contentDirection(r){this._genericSet("contentDirection",r)}set font(r){this._genericSet("font",r)}set fontSize(r){this._genericSet("fontSize",r)}set glassmorphism(r){this._genericSet("glassmorphism",r)}set height(r){this._genericSet("height",r)}set justifyContent(r){this._genericSet("justifyContent",r)}set margin(r){this._genericSet("margin",r)}set marginBottom(r){this._genericSet("marginBottom",r)}set marginLeft(r){this._genericSet("marginLeft",r)}set marginRight(r){this._genericSet("marginRight",r)}set marginTop(r){this._genericSet("marginTop",r)}set material(r){this._genericSet("material",r)}set materialColor(r){this._genericSet("materialColor",r)}set maxHeight(r){this._genericSet("maxHeight",r)}set maxWidth(r){this._genericSet("maxWidth",r)}set minHeight(r){this._genericSet("minHeight",r)}set minWidth(r){this._genericSet("minWidth",r)}set opacity(r){this._genericSet("opacity",r)}set overflow(r){this._genericSet("overflow",r)}set padding(r){this._genericSet("padding",r)}set paddingBottom(r){this._genericSet("paddingBottom",r)}set paddingLeft(r){this._genericSet("paddingLeft",r)}set paddingRight(r){this._genericSet("paddingRight",r)}set paddingTop(r){this._genericSet("paddingTop",r)}set pointerInteractableClassOverride(r){this._genericSet("pointerInteractableClassOverride",r)}set textAlign(r){this._genericSet("textAlign",r)}set textureFit(r){this._genericSet("textureFit",r)}set width(r){this._genericSet("width",r)}}let Mr=new class{constructor(){this._listeners=new Set}add(r){this._listeners.add(r)}remove(r){this._listeners.delete(r)}update(){for(let r of this._listeners)r()}};const Br=new r.MeshBasicMaterial({color:16777215,side:r.DoubleSide,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1}),Pr=new r.MeshPhysicalMaterial({color:16777215,roughness:.45,side:r.DoubleSide,specularIntensity:0,transmission:.99,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1}),Lr=new r.MeshBasicMaterial({color:16777215,transparent:!0,side:r.DoubleSide,polygonOffset:!0});class LayoutComponent extends UIComponent{constructor(...x){super(...x),this._defaults.alignItems="center",this._defaults.backgroundVisible=!1,this._defaults.borderMaterial=Lr.clone(),this._defaults.borderRadius=0,this._defaults.borderWidth=0,this._defaults.contentDirection="column",this._defaults.justifyContent="start",this._defaults.margin=0,this._defaults.material=this.glassmorphism?Pr.clone():Br.clone(),this._defaults.height="auto",this._defaults.overflow="visible",this._defaults.padding=0,this._defaults.width="auto",this._updateListener=()=>this._updateClippingPlanes(),this.computedHeight=0,this.marginedHeight=0,this.unpaddedHeight=0,this.computedWidth=0,this.marginedWidth=0,this.unpaddedWidth=0,this._materialOffset=0,this._content=new r.Object3D,this._content.position.z=1e-8,this.addEventListener("added",(()=>this._onAdded())),this.addEventListener("removed",(()=>this._onRemoved())),this.add(this._content),"visible"!=this.overflow&&this._createClippingPlanes()}_handleStyleUpdateForAlignItems(){this.updateLayout()}_handleStyleUpdateForBackgroundVisible(){this._background&&(this._background.visible=this.backgroundVisible||!1)}_handleStyleUpdateForBorderRadius(){this._createBackground()}_handleStyleUpdateForBorderBottomLeftRadius(){this._createBackground()}_handleStyleUpdateForBorderBottomRightRadius(){this._createBackground()}_handleStyleUpdateForBorderTopLeftRadius(){this._createBackground()}_handleStyleUpdateForBorderTopRightRadius(){this._createBackground()}_handleStyleUpdateForJustifyContent(){this.updateLayout()}_handleStyleUpdateForMargin(){this.updateLayout()}_handleStyleUpdateForMarginBottom(){this.updateLayout()}_handleStyleUpdateForMarginLeft(){this.updateLayout()}_handleStyleUpdateForMarginRight(){this.updateLayout()}_handleStyleUpdateForMarginTop(){this.updateLayout()}_handleStyleUpdateForMaxHeight(){this.updateLayout()}_handleStyleUpdateForMaxWidth(){this.updateLayout()}_handleStyleUpdateForMinHeight(){this.updateLayout()}_handleStyleUpdateForMinWidth(){this.updateLayout()}_handleStyleUpdateForPadding(){this.updateLayout()}_handleStyleUpdateForPaddingBottom(){this.updateLayout()}_handleStyleUpdateForPaddingLeft(){this.updateLayout()}_handleStyleUpdateForPaddingRight(){this.updateLayout()}_handleStyleUpdateForPaddingTop(){this.updateLayout()}_handleStyleUpdateForHeight(){this.updateLayout()}_handleStyleUpdateForWidth(){this.updateLayout()}_handleStyleUpdateForMaterial(){let r=this.material;r.polygonOffset=!0,r.polygonOffsetFactor=r.polygonOffsetUnits=-1*this._materialOffset,this._background.material=r}_handleStyleUpdateForMaterialColor(){let r=this.materialColor;null==r&&(r="#ffffff"),this.material.color.set(r)}_handleStyleUpdateForOpacity(){let r=this.opacity;null==r&&(r=1),this.material.opacity=r}_handleStyleUpdateForOverflow(){"visible"!=this.overflow?this.clippingPlanes||this._createClippingPlanes():this.clippingPlanes&&this._clearClippingPlanes()}_createBackground(){this._background&&this.remove(this._background),this._border&&this.remove(this._border),this._background=null,this._border=null;let x=this.material,b=this.materialColor,S=this.opacity;null!=b&&x.color.set(b),S&&(x.opacity=S);let C=this.borderWidth||0,A=this.borderRadius||0,I=numberOr(this.borderTopLeftRadius,A),R=numberOr(this.borderTopRightRadius,A),B=numberOr(this.borderBottomLeftRadius,A),D=numberOr(this.borderBottomRightRadius,A),F=this.computedHeight,G=this.computedWidth,N=this._materialOffset;if(C){let x=LayoutComponent.createShape(G,F,I,R,B,D);I=Math.max(I-C,0),R=Math.max(R-C,0),B=Math.max(B-C,0),D=Math.max(D-C,0),F-=2*C,G-=2*C;let b=LayoutComponent.createShape(G,F,I,R,B,D),S=new r.ShapeGeometry(b);this._background=new r.Mesh(S,this.material),this.add(this._background),x.holes.push(b),S=new r.ShapeGeometry(x),this._border=new r.Mesh(S,this.borderMaterial),this.add(this._border),this._border.renderOrder=N}else{let x=LayoutComponent.createShape(G,F,I,R,B,D),b=new r.ShapeGeometry(x);this._background=new r.Mesh(b,this.material),this.add(this._background)}this._background.renderOrder=N,this.backgroundVisible||(this._background.visible=!1)}_addClippingPlanesUpdateListener(){this.clippingPlanes&&Mr.add(this._updateListener);for(let r of this._content.children)r instanceof LayoutComponent&&r._addClippingPlanesUpdateListener()}_removeClippingPlanesUpdateListener(){Mr.remove(this._updateListener);for(let r of this._content.children)r instanceof LayoutComponent&&r._removeClippingPlanesUpdateListener()}_createClippingPlanes(){this.clippingPlanes=[new r.Plane(new r.Vector3(0,1,0)),new r.Plane(new r.Vector3(0,-1,0)),new r.Plane(new r.Vector3(1,0,0)),new r.Plane(new r.Vector3(-1,0,0))],this._updateClippingPlanes(),this.updateClippingPlanes(!0),Mr.add(this._updateListener)}_getClippingPlanes(){let r=[],x=this;for(;x instanceof LayoutComponent;)x.clippingPlanes&&r.push(...x.clippingPlanes),x=x.parentComponent;return r.length?r:null}_clearClippingPlanes(){this.clippingPlanes=null,Mr.remove(this._updateListener),this.updateClippingPlanes(!0)}_updateClippingPlanes(){let r=this.computedWidth/2,x=this.computedHeight/2;this.clippingPlanes[0].constant=x,this.clippingPlanes[1].constant=x,this.clippingPlanes[2].constant=r,this.clippingPlanes[3].constant=r,this.clippingPlanes[0].normal.set(0,1,0),this.clippingPlanes[1].normal.set(0,-1,0),this.clippingPlanes[2].normal.set(1,0,0),this.clippingPlanes[3].normal.set(-1,0,0),this.updateWorldMatrix(!0);for(let r of this.clippingPlanes)r.applyMatrix4(this.matrixWorld)}updateClippingPlanes(r){let x=this._getClippingPlanes();if(this.material.clippingPlanes=x,this.borderMaterial.clippingPlanes=x,this._text&&(this._text.material.clippingPlanes=x),r)for(let r of this._content.children)r instanceof LayoutComponent&&r.updateClippingPlanes(!0)}updateLayout(){let r,x,b,S,C,A,I,R,B,D,F,G,N,H,W,V,j,X=this.computedHeight,q=this.computedWidth,K=this.marginedHeight,$=this.marginedWidth,Y=this._computeDimension("height"),J=this._computeDimension("width"),Z=this._getContentHeight(),Q=this._getContentWidth(),ee=this._content.children.reduce(((r,x)=>r+(x instanceof LayoutComponent?1:0)),0),te=this.alignItems,ne=this.justifyContent,re=0;"row"==this.contentDirection?(x=-J,R=Y,B=-Q,b=-this.unpaddedWidth,D="computedWidth",F="computedHeight",C=this.paddingLeft||this.padding,A=this.paddingTop||this.padding,I=this.paddingBottom||this.padding,G="marginLeft",N="marginRight",H="marginTop",W="marginBottom",V="x",j="y",S=1):(x=Y,R=-J,B=Z,b=this.unpaddedHeight,D="computedHeight",F="computedWidth",C=this.paddingTop||this.padding,A=this.paddingLeft||this.padding,I=this.paddingRight||this.padding,G="marginTop",N="marginBottom",H="marginLeft",W="marginRight",V="y",j="x",S=-1),"start"==ne?(r=x/2,r+=C*S):"end"==ne?(r=x/-2+B,r-=C*S):"center"==ne||Math.abs(b)-Math.abs(B)<0?r=B/2:("spaceBetween"==ne?(re=Math.abs(b-B)/(ee-1)*S,r=x/2):"spaceAround"==ne?(re=Math.abs(b-B)/ee*S,r=x/2+re/2):"spaceEvenly"==ne&&(re=Math.abs(b-B)/(ee+1)*S,r=x/2+re),r+=C*S);for(let x of this._content.children)if(x instanceof LayoutComponent){let b=x.margin||0,C=numberOr(x[G],b),B=numberOr(x[N],b),X=numberOr(x[H],b),q=numberOr(x[W],b);if(r+=C*S,x.position[V]=r+x[D]/2*S,r+=x[D]*S,r+=B*S,r+=re,"start"==te)x.position[j]=R/2-x[F]/2*S-A*S-X*S;else if("end"==te)x.position[j]=-R/2+x[F]/2*S+I*S+q*S;else{let r=(I-A+q-X)*S/2;x.position[j]=r}}q!=J||X!=Y?(this._createBackground(),this.clippingPlanes&&this._updateClippingPlanes(),this.parentComponent instanceof LayoutComponent&&this.parent.parent.updateLayout(),this._updateChildrensLayout(q!=J,X!=Y)):K==this.marginedHeight&&$==this.marginedWidth||(this.clippingPlanes&&this._updateClippingPlanes(),this.parentComponent instanceof LayoutComponent&&this.parent.parent.updateLayout())}_updateChildrensLayout(r,x){for(let b of this._content.children)if(b instanceof LayoutComponent){let S=!1;if(r){let r=b.width;"string"==typeof r&&r.endsWith("%")&&(S=!0)}if(!S&&x){let r=b.height;"string"==typeof r&&r.endsWith("%")&&(S=!0)}S&&b.updateLayout()}}_computeDimension(r,x){let b=capitalizeFirstLetter(r),S="computed"+b,C="margined"+b,A="unpadded"+b,I="max"+b,R="min"+b,B=this[x||r];if("number"==typeof B)this[S]=B;else if("auto"==B)if("column"==this.contentDirection==("height"==r)){let x=0;for(let r of this._content.children)r instanceof LayoutComponent&&(x+=r[C]);let b="height"==r?this.paddingVertical:this.paddingHorizontal;this[S]=x+b}else{let x=0;for(let r of this._content.children)r instanceof LayoutComponent&&(x=Math.max(x,r[C]));let b="height"==r?this.paddingVertical:this.paddingHorizontal;this[S]=x+b}else{let r=this.parentComponent;if(r instanceof LayoutComponent){let x=Number(B.replace("%",""))/100;this[S]=r[A]*x}}if(x)return this[S];{let x=!1;if(null!=this[I]){let b=this[S];this._computeDimension(r,I),b<this[S]?this[S]=b:x=!0}if(null!=this[R]&&!x){let x=this[S];this._computeDimension(r,R),x>this[S]&&(this[S]=x)}}return this._computeUnpaddedAndMarginedDimensions(r,this[S]),this[S]}_computeUnpaddedAndMarginedDimensions(r,x){let b="margined"+capitalizeFirstLetter(r),S="height"==r?"Vertical":"Horizontal";this["unpadded"+capitalizeFirstLetter(r)]=x-this["padding"+S],this[b]=x+this["margin"+S],"height"==r?(this.unpaddedHeight=Math.max(x-this.paddingVertical,0),this.marginedHeight=x+this.marginVertical):(this.unpaddedWidth=Math.max(x-this.paddingHorizontal,0),this.marginedWidth=x+this.marginHorizontal)}_getContentHeight(){if("column"==this.contentDirection){let r=0;for(let x of this._content.children)x instanceof LayoutComponent&&(r+=x.marginedHeight);return r}{let r=0;for(let x of this._content.children)x instanceof LayoutComponent&&(r=Math.max(r,x.marginedHeight));return r}}_getContentWidth(){if("row"==this.contentDirection){let r=0;for(let x of this._content.children)x instanceof LayoutComponent&&(r+=x.marginedWidth);return r}{let r=0;for(let x of this._content.children)x instanceof LayoutComponent&&(r=Math.max(r,x.marginedWidth));return r}}_updateMaterialOffset(r){this._materialOffset=r+1;let x=this.material,b=this.borderMaterial;b.polygonOffset=x.polygonOffset=!0,b.polygonOffsetFactor=b.polygonOffsetUnits=x.polygonOffsetFactor=x.polygonOffsetUnits=-1*this._materialOffset;for(let r of this._content.children)r instanceof LayoutComponent&&r._updateMaterialOffset(this._materialOffset);let S=this._materialOffset;this._background&&(this._background.renderOrder=S),this._border&&(this._border.renderOrder=S)}_onAdded(){this._addClippingPlanesUpdateListener()}_onRemoved(){this._removeClippingPlanesUpdateListener()}add(r){if(arguments.length>1)for(let r of arguments)this.add(r);else r instanceof UIComponent&&!r.bypassContentPositioning?(this._content.add(r),r.updateLayout(),r._updateMaterialOffset(this._materialOffset),r.updateClippingPlanes(!0),this.updateLayout()):super.add(r)}remove(r){if(arguments.length>1)for(let r of arguments)this.add(r);else r instanceof UIComponent&&!r.bypassContentPositioning?this._content.remove(r):super.remove(r)}get marginHorizontal(){let r=this.margin||0;return numberOr(this.marginLeft,r)+numberOr(this.marginRight,r)}get marginVertical(){let r=this.margin||0;return numberOr(this.marginTop,r)+numberOr(this.marginBottom,r)}get paddingHorizontal(){let r=this.padding||0;return numberOr(this.paddingLeft,r)+numberOr(this.paddingRight,r)}get paddingVertical(){let r=this.padding||0;return numberOr(this.paddingTop,r)+numberOr(this.paddingBottom,r)}get parentComponent(){return this.parent?.parent}static createShape(x,b,S,C,A,I){let R=new r.Shape,B=x/2,D=b/2,F=-1*B,G=-1*D;return R.moveTo(F,G+A),R.lineTo(F,D-S),S&&R.absarc(F+S,D-S,S,Math.PI,Math.PI/2,!0),R.lineTo(B-C,D),C&&R.absarc(B-C,D-C,C,Math.PI/2,0,!0),R.lineTo(B,G+I),I&&R.absarc(B-I,G+I,I,0,Math.PI/-2,!0),R.lineTo(F+A,G),A&&R.absarc(F+A,G+A,A,Math.PI/-2,-Math.PI,!0),R}}let Or=new class{constructor(){this._tool=null,this._listeners=new Set}getTool(){return this._tool}setTool(r){this._tool=r;for(let x of this._listeners)x(r)}addUpdateListener(r){this._listeners.add(r)}removeUpdateListener(r){this._listeners.delete(r)}};const Dr={IDLE:"IDLE",DISABLED:"DISABLED",HOVERED:"HOVERED",SELECTED:"SELECTED"};class Interactable{constructor(r){this._object=r,this._state=Dr.IDLE,this.children=new Set,this._hoveredOwners=new Set,this._selectedOwners=new Set,this._capturedOwners=new Set,this._stateCallbacks=new Set,this._hoveredCallbacks=new Set,this._callbacks={},this._callbacksLength=0,this._toolCounts={},this._hoveredCallbackState=!1,this._disabled=!1}addEventListener(r,x,b){b&&(b={...b});let S=b?.tool||"none";r in this._callbacks||(this._callbacks[r]=new Map),this._callbacks[r].has(x)&&this.removeEventListener(r,x),this._callbacks[r].set(x,b),this._callbacksLength++,this._toolCounts[S]||(this._toolCounts[S]=0),this._toolCounts[S]++}copyEventListenersTo(r){for(let x in this._callbacks)for(let[b,S]of this._callbacks[x])r.addEventListener(x,b,S)}removeEventListener(r,x){if(r in this._callbacks&&this._callbacks[r].has(x)){let b=this._callbacks[r].get(x);this._callbacks[r].delete(x),this._callbacksLength--;let S=b?.tool||"none";this._toolCounts[S]--}}dispatchEvent(r,x){if(this._disabled||!(r in this._callbacks))return;let b=Or.getTool();for(let[S,C]of this._callbacks[r]){let r=C?.tool;r&&r!=b||S(x)}}over(r){this.dispatchEvent("over",r)}out(r){this.dispatchEvent("out",r)}down(r){this.dispatchEvent("down",r)}up(r){this.dispatchEvent("up",r)}click(r){this.dispatchEvent("click",r),this._capturedOwners.has(r.owner)&&this._capturedOwners.delete(r.owner)}move(r){this.dispatchEvent("move",r)}drag(r){this.dispatchEvent("drag",r)}capture(r){this._capturedOwners.add(r)}isCapturedBy(r){return this._capturedOwners.has(r)}getCallbacksLength(r){return r?this._toolCounts[r]:this._callbacksLength}supportsTool(){let r=Or.getTool();return this._toolCounts.none||this._toolCounts[r]}isOnlyGroup(){return!this.supportsTool()}addStateCallback(r){this._stateCallbacks.add(r)}addHoveredCallback(r){this._hoveredCallbacks.add(r)}removeStateCallback(r){this._stateCallbacks.delete(r)}removeHoveredCallback(r){this._hoveredCallbacks.delete(r)}_determineAndSetState(){this._selectedOwners.size>0?this.state=Dr.SELECTED:this._hoveredOwners.size>0?this.state=Dr.HOVERED:this.state=Dr.IDLE}_determineHoveredCallbackState(){if(this._disabled||0==this._hoveredCallbacks.size)return;let r=!1;for(let x of this._hoveredOwners)if(!this._selectedOwners.has(x)){r=!0;break}if(r!=this._hoveredCallbackState){this._hoveredCallbackState=r;for(let x of this._hoveredCallbacks)x(r)}}addHoveredBy(r){this._hoveredOwners.has(r)||(this._hoveredOwners.add(r),this._determineHoveredCallbackState(),0==this._selectedOwners.size&&(this.state=Dr.HOVERED))}removeHoveredBy(r){this._hoveredOwners.delete(r),this._determineAndSetState(),this._determineHoveredCallbackState()}addSelectedBy(r){this._selectedOwners.add(r),this.state=Dr.SELECTED,this._determineHoveredCallbackState()}removeSelectedBy(r){this._selectedOwners.delete(r),this._determineAndSetState(),this._determineHoveredCallbackState()}reset(){this._hoveredOwners.clear(),this._selectedOwners.clear(),this.state=Dr.IDLE,this.children.forEach((r=>{r.reset()}))}addChild(r){r.parent!=this&&(r.parent&&r.parent.removeChild(r),this.children.add(r),r.parent=this)}addChildren(r){r.forEach((r=>{this.addChild(r)}))}removeChild(r){this.children.delete(r),r.parent=null}removeChildren(r){r.forEach((r=>{this.removeChild(r)}))}get disabled(){return this._disabled}get object(){return this._object}get state(){return this._state}set disabled(r){r?(this._hoveredCallbackState&&(this._hoveredCallbacks.forEach((r=>r(!1))),this._hoveredCallbackState=!1),this.state=Dr.DISABLED,this._disabled=r):(this._disabled=r,this._determineAndSetState(),this._determineHoveredCallbackState())}set object(r){this._object=r}set state(r){if(!this._disabled&&this._state!=r){this._state=r;for(let x of this._stateCallbacks)x(r)}}}class PointerInteractable extends Interactable{constructor(r){super(r),r&&(r.pointerInteractable=this),this._maxDistance=-1/0,this._hoveredCursor="pointer"}addEventListener(r,x,b={}){null==(b={...b}).maxDistance&&(b.maxDistance=1/0),b.maxDistance>this._maxDistance&&(this._maxDistance=b.maxDistance),super.addEventListener(r,x,b)}removeEventListener(r,x){let b=!1;if(r in this._callbacks&&this._callbacks[r].has(x)){this._callbacks[r].get(x).maxDistance==this._maxDistance&&(b=!0)}if(super.removeEventListener(r,x),b){this._maxDistance=-1/0;for(let r in this._callbacks)for(let[x,b]of this._callbacks[r])b.maxDistance>this._maxDistance&&(this._maxDistance=b.maxDistance)}}dispatchEvent(r,x){if(this._disabled||!(r in this._callbacks))return;let b=Or.getTool();for(let[S,C]of this._callbacks[r]){let r=C.tool;r&&r!=b||(null==x?.userDistance||C.maxDistance>=x.userDistance)&&S(x)}}isWithinReach(r){return r<this._maxDistance}get hoveredCursor(){return this._disabled?"not-allowed":this._hoveredCursor}set hoveredCursor(r){this._hoveredCursor=r}}const Ur=new r.Matrix4;class TouchInteractable extends Interactable{constructor(r){super(r),this._target1={},this._target2={},this._targets=[this._target1,this._target2],r&&(r.touchInteractable=this,r.bvhGeometry||setupBVHForComplexObject(r)),this._createBoundingObject()}_createBoundingObject(){this._boundingBox=new r.Box3}_getBoundingObject(){return this._boundingBox.setFromObject(this._object),this._boundingBox}intersectsSphere(r){let x,b=this._getBoundingObject();return x=!!b&&r.intersectsBox(b),x}intersectsObject(r){if(r?.bvhGeometry?.boundsTree&&(this._object?.bvhGeometry?.boundsTree||setupBVHForComplexObject(this._object)))return Ur.copy(this._object.matrixWorld).invert().multiply(r.matrixWorld),this._object.bvhGeometry.boundsTree.intersectsGeometry(r.bvhGeometry,Ur)}getClosestPointTo(r){if(r.model&&(r=r.model),!r?.bvhGeometry?.boundsTree)return;if(!this._object?.bvhGeometry?.boundsTree)return;return Ur.copy(this._object.matrixWorld).invert().multiply(r.matrixWorld),this._object.bvhGeometry.boundsTree.closestPointToGeometry(r.bvhGeometry,Ur,this._target1,this._target2)?(this._target2.object=r,this._targets):void 0}}const Fr={POINTER:"POINTER",TOUCH_SCREEN:"TOUCH_SCREEN",XR:"XR"},Gr={LEFT:"LEFT",RIGHT:"RIGHT",otherHand:r=>r==Gr.LEFT?Gr.RIGHT:r==Gr.RIGHT?Gr.LEFT:void console.error("ERROR: Unexpected hand provided to Handedness.otherHand")},Nr={CONTROLLER:"CONTROLLER",HAND:"HAND",OTHER:"OTHER"};function toTrianglesDrawMode(r,x){if(x===fe)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),r;if(x===ge||x===me){let b=r.getIndex();if(null===b){const x=[],S=r.getAttribute("position");if(void 0===S)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),r;for(let r=0;r<S.count;r++)x.push(r);r.setIndex(x),b=r.getIndex()}const S=b.count-2,C=[];if(x===ge)for(let r=1;r<=S;r++)C.push(b.getX(0)),C.push(b.getX(r)),C.push(b.getX(r+1));else for(let r=0;r<S;r++)r%2==0?(C.push(b.getX(r)),C.push(b.getX(r+1)),C.push(b.getX(r+2))):(C.push(b.getX(r+2)),C.push(b.getX(r+1)),C.push(b.getX(r)));C.length/3!==S&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const A=r.clone();return A.setIndex(C),A.clearGroups(),A}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",x),r}class GLTFLoader extends ye{constructor(r){super(r),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(r){return new GLTFMaterialsClearcoatExtension(r)})),this.register((function(r){return new GLTFMaterialsDispersionExtension(r)})),this.register((function(r){return new GLTFTextureBasisUExtension(r)})),this.register((function(r){return new GLTFTextureWebPExtension(r)})),this.register((function(r){return new GLTFTextureAVIFExtension(r)})),this.register((function(r){return new GLTFMaterialsSheenExtension(r)})),this.register((function(r){return new GLTFMaterialsTransmissionExtension(r)})),this.register((function(r){return new GLTFMaterialsVolumeExtension(r)})),this.register((function(r){return new GLTFMaterialsIorExtension(r)})),this.register((function(r){return new GLTFMaterialsEmissiveStrengthExtension(r)})),this.register((function(r){return new GLTFMaterialsSpecularExtension(r)})),this.register((function(r){return new GLTFMaterialsIridescenceExtension(r)})),this.register((function(r){return new GLTFMaterialsAnisotropyExtension(r)})),this.register((function(r){return new GLTFMaterialsBumpExtension(r)})),this.register((function(r){return new GLTFLightsExtension(r)})),this.register((function(r){return new GLTFMeshoptCompression(r)})),this.register((function(r){return new GLTFMeshGpuInstancing(r)}))}load(r,x,b,S){const C=this;let A;if(""!==this.resourcePath)A=this.resourcePath;else if(""!==this.path){const x=ve.extractUrlBase(r);A=ve.resolveURL(x,this.path)}else A=ve.extractUrlBase(r);this.manager.itemStart(r);const _onError=function(x){S?S(x):console.error(x),C.manager.itemError(r),C.manager.itemEnd(r)},I=new xe(this.manager);I.setPath(this.path),I.setResponseType("arraybuffer"),I.setRequestHeader(this.requestHeader),I.setWithCredentials(this.withCredentials),I.load(r,(function(b){try{C.parse(b,A,(function(b){x(b),C.manager.itemEnd(r)}),_onError)}catch(r){_onError(r)}}),b,_onError)}setDRACOLoader(r){return this.dracoLoader=r,this}setKTX2Loader(r){return this.ktx2Loader=r,this}setMeshoptDecoder(r){return this.meshoptDecoder=r,this}register(r){return-1===this.pluginCallbacks.indexOf(r)&&this.pluginCallbacks.push(r),this}unregister(r){return-1!==this.pluginCallbacks.indexOf(r)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(r),1),this}parse(r,x,b,S){let C;const A={},I={},R=new TextDecoder;if("string"==typeof r)C=JSON.parse(r);else if(r instanceof ArrayBuffer){if(R.decode(new Uint8Array(r,0,4))===Wr){try{A[Hr.KHR_BINARY_GLTF]=new GLTFBinaryExtension(r)}catch(r){return void(S&&S(r))}C=JSON.parse(A[Hr.KHR_BINARY_GLTF].content)}else C=JSON.parse(R.decode(r))}else C=r;if(void 0===C.asset||C.asset.version[0]<2)return void(S&&S(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const B=new GLTFParser(C,{path:x||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});B.fileLoader.setRequestHeader(this.requestHeader);for(let r=0;r<this.pluginCallbacks.length;r++){const x=this.pluginCallbacks[r](B);x.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),I[x.name]=x,A[x.name]=!0}if(C.extensionsUsed)for(let r=0;r<C.extensionsUsed.length;++r){const x=C.extensionsUsed[r],b=C.extensionsRequired||[];switch(x){case Hr.KHR_MATERIALS_UNLIT:A[x]=new GLTFMaterialsUnlitExtension;break;case Hr.KHR_DRACO_MESH_COMPRESSION:A[x]=new GLTFDracoMeshCompressionExtension(C,this.dracoLoader);break;case Hr.KHR_TEXTURE_TRANSFORM:A[x]=new GLTFTextureTransformExtension;break;case Hr.KHR_MESH_QUANTIZATION:A[x]=new GLTFMeshQuantizationExtension;break;default:b.indexOf(x)>=0&&void 0===I[x]&&console.warn('THREE.GLTFLoader: Unknown extension "'+x+'".')}}B.setExtensions(A),B.setPlugins(I),B.parse(b,S)}parseAsync(r,x){const b=this;return new Promise((function(S,C){b.parse(r,x,S,C)}))}}function GLTFRegistry(){let r={};return{get:function(x){return r[x]},add:function(x,b){r[x]=b},remove:function(x){delete r[x]},removeAll:function(){r={}}}}const Hr={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class GLTFLightsExtension{constructor(r){this.parser=r,this.name=Hr.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const r=this.parser,x=this.parser.json.nodes||[];for(let b=0,S=x.length;b<S;b++){const S=x[b];S.extensions&&S.extensions[this.name]&&void 0!==S.extensions[this.name].light&&r._addNodeRef(this.cache,S.extensions[this.name].light)}}_loadLight(r){const x=this.parser,b="light:"+r;let S=x.cache.get(b);if(S)return S;const C=x.json,A=((C.extensions&&C.extensions[this.name]||{}).lights||[])[r];let I;const R=new be(16777215);void 0!==A.color&&R.setRGB(A.color[0],A.color[1],A.color[2],Te);const B=void 0!==A.range?A.range:0;switch(A.type){case"directional":I=new Ce(R),I.target.position.set(0,0,-1),I.add(I.target);break;case"point":I=new Se(R),I.distance=B;break;case"spot":I=new we(R),I.distance=B,A.spot=A.spot||{},A.spot.innerConeAngle=void 0!==A.spot.innerConeAngle?A.spot.innerConeAngle:0,A.spot.outerConeAngle=void 0!==A.spot.outerConeAngle?A.spot.outerConeAngle:Math.PI/4,I.angle=A.spot.outerConeAngle,I.penumbra=1-A.spot.innerConeAngle/A.spot.outerConeAngle,I.target.position.set(0,0,-1),I.add(I.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+A.type)}return I.position.set(0,0,0),I.decay=2,assignExtrasToUserData(I,A),void 0!==A.intensity&&(I.intensity=A.intensity),I.name=x.createUniqueName(A.name||"light_"+r),S=Promise.resolve(I),x.cache.add(b,S),S}getDependency(r,x){if("light"===r)return this._loadLight(x)}createNodeAttachment(r){const x=this,b=this.parser,S=b.json.nodes[r],C=(S.extensions&&S.extensions[this.name]||{}).light;return void 0===C?null:this._loadLight(C).then((function(r){return b._getNodeRef(x.cache,C,r)}))}}class GLTFMaterialsUnlitExtension{constructor(){this.name=Hr.KHR_MATERIALS_UNLIT}getMaterialType(){return V}extendParams(r,x,b){const S=[];r.color=new be(1,1,1),r.opacity=1;const C=x.pbrMetallicRoughness;if(C){if(Array.isArray(C.baseColorFactor)){const x=C.baseColorFactor;r.color.setRGB(x[0],x[1],x[2],Te),r.opacity=x[3]}void 0!==C.baseColorTexture&&S.push(b.assignTexture(r,"map",C.baseColorTexture,Ae))}return Promise.all(S)}}class GLTFMaterialsEmissiveStrengthExtension{constructor(r){this.parser=r,this.name=Hr.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(r,x){const b=this.parser.json.materials[r];if(!b.extensions||!b.extensions[this.name])return Promise.resolve();const S=b.extensions[this.name].emissiveStrength;return void 0!==S&&(x.emissiveIntensity=S),Promise.resolve()}}class GLTFMaterialsClearcoatExtension{constructor(r){this.parser=r,this.name=Hr.KHR_MATERIALS_CLEARCOAT}getMaterialType(r){const x=this.parser.json.materials[r];return x.extensions&&x.extensions[this.name]?Ie:null}extendMaterialParams(r,x){const S=this.parser,C=S.json.materials[r];if(!C.extensions||!C.extensions[this.name])return Promise.resolve();const A=[],I=C.extensions[this.name];if(void 0!==I.clearcoatFactor&&(x.clearcoat=I.clearcoatFactor),void 0!==I.clearcoatTexture&&A.push(S.assignTexture(x,"clearcoatMap",I.clearcoatTexture)),void 0!==I.clearcoatRoughnessFactor&&(x.clearcoatRoughness=I.clearcoatRoughnessFactor),void 0!==I.clearcoatRoughnessTexture&&A.push(S.assignTexture(x,"clearcoatRoughnessMap",I.clearcoatRoughnessTexture)),void 0!==I.clearcoatNormalTexture&&(A.push(S.assignTexture(x,"clearcoatNormalMap",I.clearcoatNormalTexture)),void 0!==I.clearcoatNormalTexture.scale)){const r=I.clearcoatNormalTexture.scale;x.clearcoatNormalScale=new b(r,r)}return Promise.all(A)}}class GLTFMaterialsDispersionExtension{constructor(r){this.parser=r,this.name=Hr.KHR_MATERIALS_DISPERSION}getMaterialType(r){const x=this.parser.json.materials[r];return x.extensions&&x.extensions[this.name]?Ie:null}extendMaterialParams(r,x){const b=this.parser.json.materials[r];if(!b.extensions||!b.extensions[this.name])return Promise.resolve();const S=b.extensions[this.name];return x.dispersion=void 0!==S.dispersion?S.dispersion:0,Promise.resolve()}}class GLTFMaterialsIridescenceExtension{constructor(r){this.parser=r,this.name=Hr.KHR_MATERIALS_IRIDESCENCE}getMaterialType(r){const x=this.parser.json.materials[r];return x.extensions&&x.extensions[this.name]?Ie:null}extendMaterialParams(r,x){const b=this.parser,S=b.json.materials[r];if(!S.extensions||!S.extensions[this.name])return Promise.resolve();const C=[],A=S.extensions[this.name];return void 0!==A.iridescenceFactor&&(x.iridescence=A.iridescenceFactor),void 0!==A.iridescenceTexture&&C.push(b.assignTexture(x,"iridescenceMap",A.iridescenceTexture)),void 0!==A.iridescenceIor&&(x.iridescenceIOR=A.iridescenceIor),void 0===x.iridescenceThicknessRange&&(x.iridescenceThicknessRange=[100,400]),void 0!==A.iridescenceThicknessMinimum&&(x.iridescenceThicknessRange[0]=A.iridescenceThicknessMinimum),void 0!==A.iridescenceThicknessMaximum&&(x.iridescenceThicknessRange[1]=A.iridescenceThicknessMaximum),void 0!==A.iridescenceThicknessTexture&&C.push(b.assignTexture(x,"iridescenceThicknessMap",A.iridescenceThicknessTexture)),Promise.all(C)}}class GLTFMaterialsSheenExtension{constructor(r){this.parser=r,this.name=Hr.KHR_MATERIALS_SHEEN}getMaterialType(r){const x=this.parser.json.materials[r];return x.extensions&&x.extensions[this.name]?Ie:null}extendMaterialParams(r,x){const b=this.parser,S=b.json.materials[r];if(!S.extensions||!S.extensions[this.name])return Promise.resolve();const C=[];x.sheenColor=new be(0,0,0),x.sheenRoughness=0,x.sheen=1;const A=S.extensions[this.name];if(void 0!==A.sheenColorFactor){const r=A.sheenColorFactor;x.sheenColor.setRGB(r[0],r[1],r[2],Te)}return void 0!==A.sheenRoughnessFactor&&(x.sheenRoughness=A.sheenRoughnessFactor),void 0!==A.sheenColorTexture&&C.push(b.assignTexture(x,"sheenColorMap",A.sheenColorTexture,Ae)),void 0!==A.sheenRoughnessTexture&&C.push(b.assignTexture(x,"sheenRoughnessMap",A.sheenRoughnessTexture)),Promise.all(C)}}class GLTFMaterialsTransmissionExtension{constructor(r){this.parser=r,this.name=Hr.KHR_MATERIALS_TRANSMISSION}getMaterialType(r){const x=this.parser.json.materials[r];return x.extensions&&x.extensions[this.name]?Ie:null}extendMaterialParams(r,x){const b=this.parser,S=b.json.materials[r];if(!S.extensions||!S.extensions[this.name])return Promise.resolve();const C=[],A=S.extensions[this.name];return void 0!==A.transmissionFactor&&(x.transmission=A.transmissionFactor),void 0!==A.transmissionTexture&&C.push(b.assignTexture(x,"transmissionMap",A.transmissionTexture)),Promise.all(C)}}class GLTFMaterialsVolumeExtension{constructor(r){this.parser=r,this.name=Hr.KHR_MATERIALS_VOLUME}getMaterialType(r){const x=this.parser.json.materials[r];return x.extensions&&x.extensions[this.name]?Ie:null}extendMaterialParams(r,x){const b=this.parser,S=b.json.materials[r];if(!S.extensions||!S.extensions[this.name])return Promise.resolve();const C=[],A=S.extensions[this.name];x.thickness=void 0!==A.thicknessFactor?A.thicknessFactor:0,void 0!==A.thicknessTexture&&C.push(b.assignTexture(x,"thicknessMap",A.thicknessTexture)),x.attenuationDistance=A.attenuationDistance||1/0;const I=A.attenuationColor||[1,1,1];return x.attenuationColor=(new be).setRGB(I[0],I[1],I[2],Te),Promise.all(C)}}class GLTFMaterialsIorExtension{constructor(r){this.parser=r,this.name=Hr.KHR_MATERIALS_IOR}getMaterialType(r){const x=this.parser.json.materials[r];return x.extensions&&x.extensions[this.name]?Ie:null}extendMaterialParams(r,x){const b=this.parser.json.materials[r];if(!b.extensions||!b.extensions[this.name])return Promise.resolve();const S=b.extensions[this.name];return x.ior=void 0!==S.ior?S.ior:1.5,Promise.resolve()}}class GLTFMaterialsSpecularExtension{constructor(r){this.parser=r,this.name=Hr.KHR_MATERIALS_SPECULAR}getMaterialType(r){const x=this.parser.json.materials[r];return x.extensions&&x.extensions[this.name]?Ie:null}extendMaterialParams(r,x){const b=this.parser,S=b.json.materials[r];if(!S.extensions||!S.extensions[this.name])return Promise.resolve();const C=[],A=S.extensions[this.name];x.specularIntensity=void 0!==A.specularFactor?A.specularFactor:1,void 0!==A.specularTexture&&C.push(b.assignTexture(x,"specularIntensityMap",A.specularTexture));const I=A.specularColorFactor||[1,1,1];return x.specularColor=(new be).setRGB(I[0],I[1],I[2],Te),void 0!==A.specularColorTexture&&C.push(b.assignTexture(x,"specularColorMap",A.specularColorTexture,Ae)),Promise.all(C)}}class GLTFMaterialsBumpExtension{constructor(r){this.parser=r,this.name=Hr.EXT_MATERIALS_BUMP}getMaterialType(r){const x=this.parser.json.materials[r];return x.extensions&&x.extensions[this.name]?Ie:null}extendMaterialParams(r,x){const b=this.parser,S=b.json.materials[r];if(!S.extensions||!S.extensions[this.name])return Promise.resolve();const C=[],A=S.extensions[this.name];return x.bumpScale=void 0!==A.bumpFactor?A.bumpFactor:1,void 0!==A.bumpTexture&&C.push(b.assignTexture(x,"bumpMap",A.bumpTexture)),Promise.all(C)}}class GLTFMaterialsAnisotropyExtension{constructor(r){this.parser=r,this.name=Hr.KHR_MATERIALS_ANISOTROPY}getMaterialType(r){const x=this.parser.json.materials[r];return x.extensions&&x.extensions[this.name]?Ie:null}extendMaterialParams(r,x){const b=this.parser,S=b.json.materials[r];if(!S.extensions||!S.extensions[this.name])return Promise.resolve();const C=[],A=S.extensions[this.name];return void 0!==A.anisotropyStrength&&(x.anisotropy=A.anisotropyStrength),void 0!==A.anisotropyRotation&&(x.anisotropyRotation=A.anisotropyRotation),void 0!==A.anisotropyTexture&&C.push(b.assignTexture(x,"anisotropyMap",A.anisotropyTexture)),Promise.all(C)}}class GLTFTextureBasisUExtension{constructor(r){this.parser=r,this.name=Hr.KHR_TEXTURE_BASISU}loadTexture(r){const x=this.parser,b=x.json,S=b.textures[r];if(!S.extensions||!S.extensions[this.name])return null;const C=S.extensions[this.name],A=x.options.ktx2Loader;if(!A){if(b.extensionsRequired&&b.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return x.loadTextureImage(r,C.source,A)}}class GLTFTextureWebPExtension{constructor(r){this.parser=r,this.name=Hr.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(r){const x=this.name,b=this.parser,S=b.json,C=S.textures[r];if(!C.extensions||!C.extensions[x])return null;const A=C.extensions[x],I=S.images[A.source];let R=b.textureLoader;if(I.uri){const r=b.options.manager.getHandler(I.uri);null!==r&&(R=r)}return this.detectSupport().then((function(C){if(C)return b.loadTextureImage(r,A.source,R);if(S.extensionsRequired&&S.extensionsRequired.indexOf(x)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return b.loadTexture(r)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(r){const x=new Image;x.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",x.onload=x.onerror=function(){r(1===x.height)}}))),this.isSupported}}class GLTFTextureAVIFExtension{constructor(r){this.parser=r,this.name=Hr.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(r){const x=this.name,b=this.parser,S=b.json,C=S.textures[r];if(!C.extensions||!C.extensions[x])return null;const A=C.extensions[x],I=S.images[A.source];let R=b.textureLoader;if(I.uri){const r=b.options.manager.getHandler(I.uri);null!==r&&(R=r)}return this.detectSupport().then((function(C){if(C)return b.loadTextureImage(r,A.source,R);if(S.extensionsRequired&&S.extensionsRequired.indexOf(x)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return b.loadTexture(r)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(r){const x=new Image;x.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",x.onload=x.onerror=function(){r(1===x.height)}}))),this.isSupported}}class GLTFMeshoptCompression{constructor(r){this.name=Hr.EXT_MESHOPT_COMPRESSION,this.parser=r}loadBufferView(r){const x=this.parser.json,b=x.bufferViews[r];if(b.extensions&&b.extensions[this.name]){const r=b.extensions[this.name],S=this.parser.getDependency("buffer",r.buffer),C=this.parser.options.meshoptDecoder;if(!C||!C.supported){if(x.extensionsRequired&&x.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return S.then((function(x){const b=r.byteOffset||0,S=r.byteLength||0,A=r.count,I=r.byteStride,R=new Uint8Array(x,b,S);return C.decodeGltfBufferAsync?C.decodeGltfBufferAsync(A,I,R,r.mode,r.filter).then((function(r){return r.buffer})):C.ready.then((function(){const x=new ArrayBuffer(A*I);return C.decodeGltfBuffer(new Uint8Array(x),A,I,R,r.mode,r.filter),x}))}))}return null}}class GLTFMeshGpuInstancing{constructor(r){this.name=Hr.EXT_MESH_GPU_INSTANCING,this.parser=r}createNodeMesh(r){const b=this.parser.json,S=b.nodes[r];if(!S.extensions||!S.extensions[this.name]||void 0===S.mesh)return null;const C=b.meshes[S.mesh];for(const r of C.primitives)if(r.mode!==Xr.TRIANGLES&&r.mode!==Xr.TRIANGLE_STRIP&&r.mode!==Xr.TRIANGLE_FAN&&void 0!==r.mode)return null;const A=S.extensions[this.name].attributes,I=[],R={};for(const r in A)I.push(this.parser.getDependency("accessor",A[r]).then((x=>(R[r]=x,R[r]))));return I.length<1?null:(I.push(this.parser.createNodeMesh(r)),Promise.all(I).then((r=>{const b=r.pop(),S=b.isGroup?b.children:[b],C=r[0].count,A=[];for(const r of S){const b=new F,S=new x,I=new _e,B=new x(1,1,1),D=new ke(r.geometry,r.material,C);for(let r=0;r<C;r++)R.TRANSLATION&&S.fromBufferAttribute(R.TRANSLATION,r),R.ROTATION&&I.fromBufferAttribute(R.ROTATION,r),R.SCALE&&B.fromBufferAttribute(R.SCALE,r),D.setMatrixAt(r,b.compose(S,I,B));for(const x in R)if("_COLOR_0"===x){const r=R[x];D.instanceColor=new Ee(r.array,r.itemSize,r.normalized)}else"TRANSLATION"!==x&&"ROTATION"!==x&&"SCALE"!==x&&r.geometry.setAttribute(x,R[x]);ee.prototype.copy.call(D,r),this.parser.assignFinalMaterial(D),A.push(D)}return b.isGroup?(b.clear(),b.add(...A),b):A[0]})))}}const Wr="glTF",Vr=1313821514,zr=5130562;class GLTFBinaryExtension{constructor(r){this.name=Hr.KHR_BINARY_GLTF,this.content=null,this.body=null;const x=new DataView(r,0,12),b=new TextDecoder;if(this.header={magic:b.decode(new Uint8Array(r.slice(0,4))),version:x.getUint32(4,!0),length:x.getUint32(8,!0)},this.header.magic!==Wr)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const S=this.header.length-12,C=new DataView(r,12);let A=0;for(;A<S;){const x=C.getUint32(A,!0);A+=4;const S=C.getUint32(A,!0);if(A+=4,S===Vr){const S=new Uint8Array(r,12+A,x);this.content=b.decode(S)}else if(S===zr){const b=12+A;this.body=r.slice(b,b+x)}A+=x}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class GLTFDracoMeshCompressionExtension{constructor(r,x){if(!x)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=Hr.KHR_DRACO_MESH_COMPRESSION,this.json=r,this.dracoLoader=x,this.dracoLoader.preload()}decodePrimitive(r,x){const b=this.json,S=this.dracoLoader,C=r.extensions[this.name].bufferView,A=r.extensions[this.name].attributes,I={},R={},B={};for(const r in A){const x=Jr[r]||r.toLowerCase();I[x]=A[r]}for(const x in r.attributes){const S=Jr[x]||x.toLowerCase();if(void 0!==A[x]){const C=b.accessors[r.attributes[x]],A=qr[C.componentType];B[S]=A.name,R[S]=!0===C.normalized}}return x.getDependency("bufferView",C).then((function(r){return new Promise((function(x,b){S.decodeDracoFile(r,(function(r){for(const x in r.attributes){const b=r.attributes[x],S=R[x];void 0!==S&&(b.normalized=S)}x(r)}),I,B,Te,b)}))}))}}class GLTFTextureTransformExtension{constructor(){this.name=Hr.KHR_TEXTURE_TRANSFORM}extendTexture(r,x){return void 0!==x.texCoord&&x.texCoord!==r.channel||void 0!==x.offset||void 0!==x.rotation||void 0!==x.scale?(r=r.clone(),void 0!==x.texCoord&&(r.channel=x.texCoord),void 0!==x.offset&&r.offset.fromArray(x.offset),void 0!==x.rotation&&(r.rotation=x.rotation),void 0!==x.scale&&r.repeat.fromArray(x.scale),r.needsUpdate=!0,r):r}}class GLTFMeshQuantizationExtension{constructor(){this.name=Hr.KHR_MESH_QUANTIZATION}}class GLTFCubicSplineInterpolant extends ct{constructor(r,x,b,S){super(r,x,b,S)}copySampleValue_(r){const x=this.resultBuffer,b=this.sampleValues,S=this.valueSize,C=r*S*3+S;for(let r=0;r!==S;r++)x[r]=b[C+r];return x}interpolate_(r,x,b,S){const C=this.resultBuffer,A=this.sampleValues,I=this.valueSize,R=2*I,B=3*I,D=S-x,F=(b-x)/D,G=F*F,N=G*F,H=r*B,W=H-B,V=-2*N+3*G,j=N-G,X=1-V,q=j-G+F;for(let r=0;r!==I;r++){const x=A[W+r+I],b=A[W+r+R]*D,S=A[H+r+I],B=A[H+r]*D;C[r]=X*x+q*b+V*S+j*B}return C}}const jr=new _e;class GLTFCubicSplineQuaternionInterpolant extends GLTFCubicSplineInterpolant{interpolate_(r,x,b,S){const C=super.interpolate_(r,x,b,S);return jr.fromArray(C).normalize().toArray(C),C}}const Xr={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},qr={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Kr={9728:X,9729:Le,9984:et,9985:tt,9986:nt,9987:Oe},$r={33071:rt,33648:it,10497:De},Yr={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Jr={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Zr={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},Qr={CUBICSPLINE:void 0,LINEAR:Ze,STEP:st},ei="OPAQUE",ti="MASK",ni="BLEND";function addUnknownExtensionsToUserData(r,x,b){for(const S in b.extensions)void 0===r[S]&&(x.userData.gltfExtensions=x.userData.gltfExtensions||{},x.userData.gltfExtensions[S]=b.extensions[S])}function assignExtrasToUserData(r,x){void 0!==x.extras&&("object"==typeof x.extras?Object.assign(r.userData,x.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+x.extras))}function updateMorphTargets(r,x){if(r.updateMorphTargets(),void 0!==x.weights)for(let b=0,S=x.weights.length;b<S;b++)r.morphTargetInfluences[b]=x.weights[b];if(x.extras&&Array.isArray(x.extras.targetNames)){const b=x.extras.targetNames;if(r.morphTargetInfluences.length===b.length){r.morphTargetDictionary={};for(let x=0,S=b.length;x<S;x++)r.morphTargetDictionary[b[x]]=x}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function createPrimitiveKey(r){let x;const b=r.extensions&&r.extensions[Hr.KHR_DRACO_MESH_COMPRESSION];if(x=b?"draco:"+b.bufferView+":"+b.indices+":"+createAttributesKey(b.attributes):r.indices+":"+createAttributesKey(r.attributes)+":"+r.mode,void 0!==r.targets)for(let b=0,S=r.targets.length;b<S;b++)x+=":"+createAttributesKey(r.targets[b]);return x}function createAttributesKey(r){let x="";const b=Object.keys(r).sort();for(let S=0,C=b.length;S<C;S++)x+=b[S]+":"+r[b[S]]+";";return x}function getNormalizedComponentScale(r){switch(r){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const ri=new F;class GLTFParser{constructor(r={},x={}){this.json=r,this.extensions={},this.plugins={},this.options=x,this.cache=new GLTFRegistry,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let b=!1,S=-1,C=!1,A=-1;if("undefined"!=typeof navigator){const r=navigator.userAgent;b=!0===/^((?!chrome|android).)*safari/i.test(r);const x=r.match(/Version\/(\d+)/);S=b&&x?parseInt(x[1],10):-1,C=r.indexOf("Firefox")>-1,A=C?r.match(/Firefox\/([0-9]+)\./)[1]:-1}"undefined"==typeof createImageBitmap||b&&S<17||C&&A<98?this.textureLoader=new Re(this.options.manager):this.textureLoader=new Me(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new xe(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(r){this.extensions=r}setPlugins(r){this.plugins=r}parse(r,x){const b=this,S=this.json,C=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll((function(r){return r._markDefs&&r._markDefs()})),Promise.all(this._invokeAll((function(r){return r.beforeRoot&&r.beforeRoot()}))).then((function(){return Promise.all([b.getDependencies("scene"),b.getDependencies("animation"),b.getDependencies("camera")])})).then((function(x){const A={scene:x[0][S.scene||0],scenes:x[0],animations:x[1],cameras:x[2],asset:S.asset,parser:b,userData:{}};return addUnknownExtensionsToUserData(C,A,S),assignExtrasToUserData(A,S),Promise.all(b._invokeAll((function(r){return r.afterRoot&&r.afterRoot(A)}))).then((function(){for(const r of A.scenes)r.updateMatrixWorld();r(A)}))})).catch(x)}_markDefs(){const r=this.json.nodes||[],x=this.json.skins||[],b=this.json.meshes||[];for(let b=0,S=x.length;b<S;b++){const S=x[b].joints;for(let x=0,b=S.length;x<b;x++)r[S[x]].isBone=!0}for(let x=0,S=r.length;x<S;x++){const S=r[x];void 0!==S.mesh&&(this._addNodeRef(this.meshCache,S.mesh),void 0!==S.skin&&(b[S.mesh].isSkinnedMesh=!0)),void 0!==S.camera&&this._addNodeRef(this.cameraCache,S.camera)}}_addNodeRef(r,x){void 0!==x&&(void 0===r.refs[x]&&(r.refs[x]=r.uses[x]=0),r.refs[x]++)}_getNodeRef(r,x,b){if(r.refs[x]<=1)return b;const S=b.clone(),updateMappings=(r,x)=>{const b=this.associations.get(r);null!=b&&this.associations.set(x,b);for(const[b,S]of r.children.entries())updateMappings(S,x.children[b])};return updateMappings(b,S),S.name+="_instance_"+r.uses[x]++,S}_invokeOne(r){const x=Object.values(this.plugins);x.push(this);for(let b=0;b<x.length;b++){const S=r(x[b]);if(S)return S}return null}_invokeAll(r){const x=Object.values(this.plugins);x.unshift(this);const b=[];for(let S=0;S<x.length;S++){const C=r(x[S]);C&&b.push(C)}return b}getDependency(r,x){const b=r+":"+x;let S=this.cache.get(b);if(!S){switch(r){case"scene":S=this.loadScene(x);break;case"node":S=this._invokeOne((function(r){return r.loadNode&&r.loadNode(x)}));break;case"mesh":S=this._invokeOne((function(r){return r.loadMesh&&r.loadMesh(x)}));break;case"accessor":S=this.loadAccessor(x);break;case"bufferView":S=this._invokeOne((function(r){return r.loadBufferView&&r.loadBufferView(x)}));break;case"buffer":S=this.loadBuffer(x);break;case"material":S=this._invokeOne((function(r){return r.loadMaterial&&r.loadMaterial(x)}));break;case"texture":S=this._invokeOne((function(r){return r.loadTexture&&r.loadTexture(x)}));break;case"skin":S=this.loadSkin(x);break;case"animation":S=this._invokeOne((function(r){return r.loadAnimation&&r.loadAnimation(x)}));break;case"camera":S=this.loadCamera(x);break;default:if(S=this._invokeOne((function(b){return b!=this&&b.getDependency&&b.getDependency(r,x)})),!S)throw new Error("Unknown type: "+r)}this.cache.add(b,S)}return S}getDependencies(r){let x=this.cache.get(r);if(!x){const b=this,S=this.json[r+("mesh"===r?"es":"s")]||[];x=Promise.all(S.map((function(x,S){return b.getDependency(r,S)}))),this.cache.add(r,x)}return x}loadBuffer(r){const x=this.json.buffers[r],b=this.fileLoader;if(x.type&&"arraybuffer"!==x.type)throw new Error("THREE.GLTFLoader: "+x.type+" buffer type is not supported.");if(void 0===x.uri&&0===r)return Promise.resolve(this.extensions[Hr.KHR_BINARY_GLTF].body);const S=this.options;return new Promise((function(r,C){b.load(ve.resolveURL(x.uri,S.path),r,void 0,(function(){C(new Error('THREE.GLTFLoader: Failed to load buffer "'+x.uri+'".'))}))}))}loadBufferView(r){const x=this.json.bufferViews[r];return this.getDependency("buffer",x.buffer).then((function(r){const b=x.byteLength||0,S=x.byteOffset||0;return r.slice(S,S+b)}))}loadAccessor(r){const x=this,b=this.json,S=this.json.accessors[r];if(void 0===S.bufferView&&void 0===S.sparse){const r=Yr[S.type],x=qr[S.componentType],b=!0===S.normalized,C=new x(S.count*r);return Promise.resolve(new G(C,r,b))}const C=[];return void 0!==S.bufferView?C.push(this.getDependency("bufferView",S.bufferView)):C.push(null),void 0!==S.sparse&&(C.push(this.getDependency("bufferView",S.sparse.indices.bufferView)),C.push(this.getDependency("bufferView",S.sparse.values.bufferView))),Promise.all(C).then((function(r){const C=r[0],A=Yr[S.type],I=qr[S.componentType],R=I.BYTES_PER_ELEMENT,B=R*A,D=S.byteOffset||0,F=void 0!==S.bufferView?b.bufferViews[S.bufferView].byteStride:void 0,N=!0===S.normalized;let H,W;if(F&&F!==B){const r=Math.floor(D/F),b="InterleavedBuffer:"+S.bufferView+":"+S.componentType+":"+r+":"+S.count;let B=x.cache.get(b);B||(H=new I(C,r*F,S.count*F/R),B=new Be(H,F/R),x.cache.add(b,B)),W=new Pe(B,A,D%F/R,N)}else H=null===C?new I(S.count*A):new I(C,D,S.count*A),W=new G(H,A,N);if(void 0!==S.sparse){const x=Yr.SCALAR,b=qr[S.sparse.indices.componentType],R=S.sparse.indices.byteOffset||0,B=S.sparse.values.byteOffset||0,D=new b(r[1],R,S.sparse.count*x),F=new I(r[2],B,S.sparse.count*A);null!==C&&(W=new G(W.array.slice(),W.itemSize,W.normalized)),W.normalized=!1;for(let r=0,x=D.length;r<x;r++){const x=D[r];if(W.setX(x,F[r*A]),A>=2&&W.setY(x,F[r*A+1]),A>=3&&W.setZ(x,F[r*A+2]),A>=4&&W.setW(x,F[r*A+3]),A>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}W.normalized=N}return W}))}loadTexture(r){const x=this.json,b=this.options,S=x.textures[r].source,C=x.images[S];let A=this.textureLoader;if(C.uri){const r=b.manager.getHandler(C.uri);null!==r&&(A=r)}return this.loadTextureImage(r,S,A)}loadTextureImage(r,x,b){const S=this,C=this.json,A=C.textures[r],I=C.images[x],R=(I.uri||I.bufferView)+":"+A.sampler;if(this.textureCache[R])return this.textureCache[R];const B=this.loadImageSource(x,b).then((function(x){x.flipY=!1,x.name=A.name||I.name||"",""===x.name&&"string"==typeof I.uri&&!1===I.uri.startsWith("data:image/")&&(x.name=I.uri);const b=(C.samplers||{})[A.sampler]||{};return x.magFilter=Kr[b.magFilter]||Le,x.minFilter=Kr[b.minFilter]||Oe,x.wrapS=$r[b.wrapS]||De,x.wrapT=$r[b.wrapT]||De,S.associations.set(x,{textures:r}),x})).catch((function(){return null}));return this.textureCache[R]=B,B}loadImageSource(r,x){const b=this,S=this.json,C=this.options;if(void 0!==this.sourceCache[r])return this.sourceCache[r].then((r=>r.clone()));const A=S.images[r],I=self.URL||self.webkitURL;let R=A.uri||"",B=!1;if(void 0!==A.bufferView)R=b.getDependency("bufferView",A.bufferView).then((function(r){B=!0;const x=new Blob([r],{type:A.mimeType});return R=I.createObjectURL(x),R}));else if(void 0===A.uri)throw new Error("THREE.GLTFLoader: Image "+r+" is missing URI and bufferView");const D=Promise.resolve(R).then((function(r){return new Promise((function(b,S){let A=b;!0===x.isImageBitmapLoader&&(A=function(r){const x=new ot(r);x.needsUpdate=!0,b(x)}),x.load(ve.resolveURL(r,C.path),A,void 0,S)}))})).then((function(r){var x;return!0===B&&I.revokeObjectURL(R),assignExtrasToUserData(r,A),r.userData.mimeType=A.mimeType||((x=A.uri).search(/\.jpe?g($|\?)/i)>0||0===x.search(/^data\:image\/jpeg/)?"image/jpeg":x.search(/\.webp($|\?)/i)>0||0===x.search(/^data\:image\/webp/)?"image/webp":"image/png"),r})).catch((function(r){throw console.error("THREE.GLTFLoader: Couldn't load texture",R),r}));return this.sourceCache[r]=D,D}assignTexture(r,x,b,S){const C=this;return this.getDependency("texture",b.index).then((function(A){if(!A)return null;if(void 0!==b.texCoord&&b.texCoord>0&&((A=A.clone()).channel=b.texCoord),C.extensions[Hr.KHR_TEXTURE_TRANSFORM]){const r=void 0!==b.extensions?b.extensions[Hr.KHR_TEXTURE_TRANSFORM]:void 0;if(r){const x=C.associations.get(A);A=C.extensions[Hr.KHR_TEXTURE_TRANSFORM].extendTexture(A,r),C.associations.set(A,x)}}return void 0!==S&&(A.colorSpace=S),r[x]=A,A}))}assignFinalMaterial(r){const x=r.geometry;let b=r.material;const S=void 0===x.attributes.tangent,C=void 0!==x.attributes.color,A=void 0===x.attributes.normal;if(r.isPoints){const r="PointsMaterial:"+b.uuid;let x=this.cache.get(r);x||(x=new Ue,Fe.prototype.copy.call(x,b),x.color.copy(b.color),x.map=b.map,x.sizeAttenuation=!1,this.cache.add(r,x)),b=x}else if(r.isLine){const r="LineBasicMaterial:"+b.uuid;let x=this.cache.get(r);x||(x=new W,Fe.prototype.copy.call(x,b),x.color.copy(b.color),x.map=b.map,this.cache.add(r,x)),b=x}if(S||C||A){let r="ClonedMaterial:"+b.uuid+":";S&&(r+="derivative-tangents:"),C&&(r+="vertex-colors:"),A&&(r+="flat-shading:");let x=this.cache.get(r);x||(x=b.clone(),C&&(x.vertexColors=!0),A&&(x.flatShading=!0),S&&(x.normalScale&&(x.normalScale.y*=-1),x.clearcoatNormalScale&&(x.clearcoatNormalScale.y*=-1)),this.cache.add(r,x),this.associations.set(x,this.associations.get(b))),b=x}r.material=b}getMaterialType(){return Ge}loadMaterial(r){const x=this,S=this.json,C=this.extensions,A=S.materials[r];let I;const R={},B=[];if((A.extensions||{})[Hr.KHR_MATERIALS_UNLIT]){const r=C[Hr.KHR_MATERIALS_UNLIT];I=r.getMaterialType(),B.push(r.extendParams(R,A,x))}else{const b=A.pbrMetallicRoughness||{};if(R.color=new be(1,1,1),R.opacity=1,Array.isArray(b.baseColorFactor)){const r=b.baseColorFactor;R.color.setRGB(r[0],r[1],r[2],Te),R.opacity=r[3]}void 0!==b.baseColorTexture&&B.push(x.assignTexture(R,"map",b.baseColorTexture,Ae)),R.metalness=void 0!==b.metallicFactor?b.metallicFactor:1,R.roughness=void 0!==b.roughnessFactor?b.roughnessFactor:1,void 0!==b.metallicRoughnessTexture&&(B.push(x.assignTexture(R,"metalnessMap",b.metallicRoughnessTexture)),B.push(x.assignTexture(R,"roughnessMap",b.metallicRoughnessTexture))),I=this._invokeOne((function(x){return x.getMaterialType&&x.getMaterialType(r)})),B.push(Promise.all(this._invokeAll((function(x){return x.extendMaterialParams&&x.extendMaterialParams(r,R)}))))}!0===A.doubleSided&&(R.side=pe);const D=A.alphaMode||ei;if(D===ni?(R.transparent=!0,R.depthWrite=!1):(R.transparent=!1,D===ti&&(R.alphaTest=void 0!==A.alphaCutoff?A.alphaCutoff:.5)),void 0!==A.normalTexture&&I!==V&&(B.push(x.assignTexture(R,"normalMap",A.normalTexture)),R.normalScale=new b(1,1),void 0!==A.normalTexture.scale)){const r=A.normalTexture.scale;R.normalScale.set(r,r)}if(void 0!==A.occlusionTexture&&I!==V&&(B.push(x.assignTexture(R,"aoMap",A.occlusionTexture)),void 0!==A.occlusionTexture.strength&&(R.aoMapIntensity=A.occlusionTexture.strength)),void 0!==A.emissiveFactor&&I!==V){const r=A.emissiveFactor;R.emissive=(new be).setRGB(r[0],r[1],r[2],Te)}return void 0!==A.emissiveTexture&&I!==V&&B.push(x.assignTexture(R,"emissiveMap",A.emissiveTexture,Ae)),Promise.all(B).then((function(){const b=new I(R);return A.name&&(b.name=A.name),assignExtrasToUserData(b,A),x.associations.set(b,{materials:r}),A.extensions&&addUnknownExtensionsToUserData(C,b,A),b}))}createUniqueName(r){const x=Ne.sanitizeNodeName(r||"");return x in this.nodeNamesUsed?x+"_"+ ++this.nodeNamesUsed[x]:(this.nodeNamesUsed[x]=0,x)}loadGeometries(r){const x=this,b=this.extensions,S=this.primitiveCache;function createDracoPrimitive(r){return b[Hr.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(r,x).then((function(b){return addPrimitiveAttributes(b,r,x)}))}const C=[];for(let b=0,A=r.length;b<A;b++){const A=r[b],I=createPrimitiveKey(A),R=S[I];if(R)C.push(R.promise);else{let r;r=A.extensions&&A.extensions[Hr.KHR_DRACO_MESH_COMPRESSION]?createDracoPrimitive(A):addPrimitiveAttributes(new Z,A,x),S[I]={primitive:A,promise:r},C.push(r)}}return Promise.all(C)}loadMesh(r){const x=this,b=this.json,S=this.extensions,C=b.meshes[r],A=C.primitives,R=[];for(let r=0,x=A.length;r<x;r++){const x=void 0===A[r].material?(void 0===(B=this.cache).DefaultMaterial&&(B.DefaultMaterial=new Ge({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:N})),B.DefaultMaterial):this.getDependency("material",A[r].material);R.push(x)}var B;return R.push(x.loadGeometries(A)),Promise.all(R).then((function(b){const R=b.slice(0,b.length-1),B=b[b.length-1],D=[];for(let b=0,F=B.length;b<F;b++){const F=B[b],G=A[b];let N;const H=R[b];if(G.mode===Xr.TRIANGLES||G.mode===Xr.TRIANGLE_STRIP||G.mode===Xr.TRIANGLE_FAN||void 0===G.mode)N=!0===C.isSkinnedMesh?new He(F,H):new I(F,H),!0===N.isSkinnedMesh&&N.normalizeSkinWeights(),G.mode===Xr.TRIANGLE_STRIP?N.geometry=toTrianglesDrawMode(N.geometry,me):G.mode===Xr.TRIANGLE_FAN&&(N.geometry=toTrianglesDrawMode(N.geometry,ge));else if(G.mode===Xr.LINES)N=new We(F,H);else if(G.mode===Xr.LINE_STRIP)N=new Ve(F,H);else if(G.mode===Xr.LINE_LOOP)N=new ze(F,H);else{if(G.mode!==Xr.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+G.mode);N=new je(F,H)}Object.keys(N.geometry.morphAttributes).length>0&&updateMorphTargets(N,C),N.name=x.createUniqueName(C.name||"mesh_"+r),assignExtrasToUserData(N,C),G.extensions&&addUnknownExtensionsToUserData(S,N,G),x.assignFinalMaterial(N),D.push(N)}for(let b=0,S=D.length;b<S;b++)x.associations.set(D[b],{meshes:r,primitives:b});if(1===D.length)return C.extensions&&addUnknownExtensionsToUserData(S,D[0],C),D[0];const F=new H;C.extensions&&addUnknownExtensionsToUserData(S,F,C),x.associations.set(F,{meshes:r});for(let r=0,x=D.length;r<x;r++)F.add(D[r]);return F}))}loadCamera(r){let x;const b=this.json.cameras[r],S=b[b.type];if(S)return"perspective"===b.type?x=new Xe(qe.radToDeg(S.yfov),S.aspectRatio||1,S.znear||1,S.zfar||2e6):"orthographic"===b.type&&(x=new Ke(-S.xmag,S.xmag,S.ymag,-S.ymag,S.znear,S.zfar)),b.name&&(x.name=this.createUniqueName(b.name)),assignExtrasToUserData(x,b),Promise.resolve(x);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(r){const x=this.json.skins[r],b=[];for(let r=0,S=x.joints.length;r<S;r++)b.push(this._loadNodeShallow(x.joints[r]));return void 0!==x.inverseBindMatrices?b.push(this.getDependency("accessor",x.inverseBindMatrices)):b.push(null),Promise.all(b).then((function(r){const b=r.pop(),S=r,C=[],A=[];for(let r=0,I=S.length;r<I;r++){const I=S[r];if(I){C.push(I);const x=new F;null!==b&&x.fromArray(b.array,16*r),A.push(x)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',x.joints[r])}return new $e(C,A)}))}loadAnimation(r){const x=this.json,b=this,S=x.animations[r],C=S.name?S.name:"animation_"+r,A=[],I=[],R=[],B=[],D=[];for(let r=0,x=S.channels.length;r<x;r++){const x=S.channels[r],b=S.samplers[x.sampler],C=x.target,F=C.node,G=void 0!==S.parameters?S.parameters[b.input]:b.input,N=void 0!==S.parameters?S.parameters[b.output]:b.output;void 0!==C.node&&(A.push(this.getDependency("node",F)),I.push(this.getDependency("accessor",G)),R.push(this.getDependency("accessor",N)),B.push(b),D.push(C))}return Promise.all([Promise.all(A),Promise.all(I),Promise.all(R),Promise.all(B),Promise.all(D)]).then((function(r){const x=r[0],S=r[1],A=r[2],I=r[3],R=r[4],B=[];for(let r=0,C=x.length;r<C;r++){const C=x[r],D=S[r],F=A[r],G=I[r],N=R[r];if(void 0===C)continue;C.updateMatrix&&C.updateMatrix();const H=b._createAnimationTracks(C,D,F,G,N);if(H)for(let r=0;r<H.length;r++)B.push(H[r])}return new Ye(C,void 0,B)}))}createNodeMesh(r){const x=this.json,b=this,S=x.nodes[r];return void 0===S.mesh?null:b.getDependency("mesh",S.mesh).then((function(r){const x=b._getNodeRef(b.meshCache,S.mesh,r);return void 0!==S.weights&&x.traverse((function(r){if(r.isMesh)for(let x=0,b=S.weights.length;x<b;x++)r.morphTargetInfluences[x]=S.weights[x]})),x}))}loadNode(r){const x=this,b=this.json.nodes[r],S=x._loadNodeShallow(r),C=[],A=b.children||[];for(let r=0,b=A.length;r<b;r++)C.push(x.getDependency("node",A[r]));const I=void 0===b.skin?Promise.resolve(null):x.getDependency("skin",b.skin);return Promise.all([S,Promise.all(C),I]).then((function(r){const x=r[0],b=r[1],S=r[2];null!==S&&x.traverse((function(r){r.isSkinnedMesh&&r.bind(S,ri)}));for(let r=0,S=b.length;r<S;r++)x.add(b[r]);return x}))}_loadNodeShallow(r){const x=this.json,b=this.extensions,S=this;if(void 0!==this.nodeCache[r])return this.nodeCache[r];const C=x.nodes[r],A=C.name?S.createUniqueName(C.name):"",I=[],R=S._invokeOne((function(x){return x.createNodeMesh&&x.createNodeMesh(r)}));return R&&I.push(R),void 0!==C.camera&&I.push(S.getDependency("camera",C.camera).then((function(r){return S._getNodeRef(S.cameraCache,C.camera,r)}))),S._invokeAll((function(x){return x.createNodeAttachment&&x.createNodeAttachment(r)})).forEach((function(r){I.push(r)})),this.nodeCache[r]=Promise.all(I).then((function(x){let I;if(I=!0===C.isBone?new Je:x.length>1?new H:1===x.length?x[0]:new ee,I!==x[0])for(let r=0,b=x.length;r<b;r++)I.add(x[r]);if(C.name&&(I.userData.name=C.name,I.name=A),assignExtrasToUserData(I,C),C.extensions&&addUnknownExtensionsToUserData(b,I,C),void 0!==C.matrix){const r=new F;r.fromArray(C.matrix),I.applyMatrix4(r)}else void 0!==C.translation&&I.position.fromArray(C.translation),void 0!==C.rotation&&I.quaternion.fromArray(C.rotation),void 0!==C.scale&&I.scale.fromArray(C.scale);return S.associations.has(I)||S.associations.set(I,{}),S.associations.get(I).nodes=r,I})),this.nodeCache[r]}loadScene(r){const x=this.extensions,b=this.json.scenes[r],S=this,C=new H;b.name&&(C.name=S.createUniqueName(b.name)),assignExtrasToUserData(C,b),b.extensions&&addUnknownExtensionsToUserData(x,C,b);const A=b.nodes||[],I=[];for(let r=0,x=A.length;r<x;r++)I.push(S.getDependency("node",A[r]));return Promise.all(I).then((function(r){for(let x=0,b=r.length;x<b;x++)C.add(r[x]);return S.associations=(r=>{const x=new Map;for(const[r,b]of S.associations)(r instanceof Fe||r instanceof ot)&&x.set(r,b);return r.traverse((r=>{const b=S.associations.get(r);null!=b&&x.set(r,b)})),x})(C),C}))}_createAnimationTracks(r,x,b,S,C){const A=[],I=r.name?r.name:r.uuid,R=[];let B;switch(Zr[C.path]===Zr.weights?r.traverse((function(r){r.morphTargetInfluences&&R.push(r.name?r.name:r.uuid)})):R.push(I),Zr[C.path]){case Zr.weights:B=lt;break;case Zr.rotation:B=ht;break;case Zr.position:case Zr.scale:B=at;break;default:if(1===b.itemSize)B=lt;else B=at}const D=void 0!==S.interpolation?Qr[S.interpolation]:Ze,F=this._getArrayFromAccessor(b);for(let r=0,b=R.length;r<b;r++){const b=new B(R[r]+"."+Zr[C.path],x.array,F,D);"CUBICSPLINE"===S.interpolation&&this._createCubicSplineTrackInterpolant(b),A.push(b)}return A}_getArrayFromAccessor(r){let x=r.array;if(r.normalized){const r=getNormalizedComponentScale(x.constructor),b=new Float32Array(x.length);for(let S=0,C=x.length;S<C;S++)b[S]=x[S]*r;x=b}return x}_createCubicSplineTrackInterpolant(r){r.createInterpolant=function(r){return new(this instanceof ht?GLTFCubicSplineQuaternionInterpolant:GLTFCubicSplineInterpolant)(this.times,this.values,this.getValueSize()/3,r)},r.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function addPrimitiveAttributes(r,b,S){const C=b.attributes,I=[];function assignAttributeAccessor(x,b){return S.getDependency("accessor",x).then((function(x){r.setAttribute(b,x)}))}for(const x in C){const b=Jr[x]||x.toLowerCase();b in r.attributes||I.push(assignAttributeAccessor(C[x],b))}if(void 0!==b.indices&&!r.index){const x=S.getDependency("accessor",b.indices).then((function(x){r.setIndex(x)}));I.push(x)}return Qe.workingColorSpace!==Te&&"COLOR_0"in C&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${Qe.workingColorSpace}" not supported.`),assignExtrasToUserData(r,b),function(r,b,S){const C=b.attributes,I=new A;if(void 0===C.POSITION)return;{const r=S.json.accessors[C.POSITION],b=r.min,A=r.max;if(void 0===b||void 0===A)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(I.set(new x(b[0],b[1],b[2]),new x(A[0],A[1],A[2])),r.normalized){const x=getNormalizedComponentScale(qr[r.componentType]);I.min.multiplyScalar(x),I.max.multiplyScalar(x)}}const R=b.targets;if(void 0!==R){const r=new x,b=new x;for(let x=0,C=R.length;x<C;x++){const C=R[x];if(void 0!==C.POSITION){const x=S.json.accessors[C.POSITION],A=x.min,I=x.max;if(void 0!==A&&void 0!==I){if(b.setX(Math.max(Math.abs(A[0]),Math.abs(I[0]))),b.setY(Math.max(Math.abs(A[1]),Math.abs(I[1]))),b.setZ(Math.max(Math.abs(A[2]),Math.abs(I[2]))),x.normalized){const r=getNormalizedComponentScale(qr[x.componentType]);b.multiplyScalar(r)}r.max(b)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}I.expandByVector(r)}r.boundingBox=I;const B=new D;I.getCenter(B.center),B.radius=I.min.distanceTo(I.max)/2,r.boundingSphere=B}(r,b,S),Promise.all(I).then((function(){return void 0!==b.targets?function(r,x,b){let S=!1,C=!1,A=!1;for(let r=0,b=x.length;r<b;r++){const b=x[r];if(void 0!==b.POSITION&&(S=!0),void 0!==b.NORMAL&&(C=!0),void 0!==b.COLOR_0&&(A=!0),S&&C&&A)break}if(!S&&!C&&!A)return Promise.resolve(r);const I=[],R=[],B=[];for(let D=0,F=x.length;D<F;D++){const F=x[D];if(S){const x=void 0!==F.POSITION?b.getDependency("accessor",F.POSITION):r.attributes.position;I.push(x)}if(C){const x=void 0!==F.NORMAL?b.getDependency("accessor",F.NORMAL):r.attributes.normal;R.push(x)}if(A){const x=void 0!==F.COLOR_0?b.getDependency("accessor",F.COLOR_0):r.attributes.color;B.push(x)}}return Promise.all([Promise.all(I),Promise.all(R),Promise.all(B)]).then((function(x){const b=x[0],I=x[1],R=x[2];return S&&(r.morphAttributes.position=b),C&&(r.morphAttributes.normal=I),A&&(r.morphAttributes.color=R),r.morphTargetsRelative=!0,r}))}(r,b.targets,S):r}))}const ii={Handedness:Object.freeze({NONE:"none",LEFT:"left",RIGHT:"right"}),ComponentState:Object.freeze({DEFAULT:"default",TOUCHED:"touched",PRESSED:"pressed"}),ComponentProperty:Object.freeze({BUTTON:"button",X_AXIS:"xAxis",Y_AXIS:"yAxis",STATE:"state"}),ComponentType:Object.freeze({TRIGGER:"trigger",SQUEEZE:"squeeze",TOUCHPAD:"touchpad",THUMBSTICK:"thumbstick",BUTTON:"button"}),ButtonTouchThreshold:.05,AxisTouchThreshold:.1,VisualResponseProperty:Object.freeze({TRANSFORM:"transform",VISIBILITY:"visibility"})};async function fetchJsonFile(r){const x=await fetch(r);if(x.ok)return x.json();throw new Error(x.statusText)}async function fetchProfile(r,x,b=null,S=!0){if(!r)throw new Error("No xrInputSource supplied");if(!x)throw new Error("No basePath supplied");const C=await async function(r){if(!r)throw new Error("No basePath supplied");return await fetchJsonFile(`${r}/profilesList.json`)}(x);let A;if(r.profiles.some((r=>{const b=C[r];return b&&(A={profileId:r,profilePath:`${x}/${b.path}`,deprecated:!!b.deprecated}),!!A})),!A){if(!b)throw new Error("No matching profile name found");const r=C[b];if(!r)throw new Error(`No matching profile name found and default profile "${b}" missing.`);A={profileId:b,profilePath:`${x}/${r.path}`,deprecated:!!r.deprecated}}const I=await fetchJsonFile(A.profilePath);let R;if(S){let x;if(x="any"===r.handedness?I.layouts[Object.keys(I.layouts)[0]]:I.layouts[r.handedness],!x)throw new Error(`No matching handedness, ${r.handedness}, in profile ${A.profileId}`);x.assetPath&&(R=A.profilePath.replace("profile.json",x.assetPath))}return{profile:I,assetPath:R}}const si={xAxis:0,yAxis:0,button:0,state:ii.ComponentState.DEFAULT};class VisualResponse{constructor(r){this.componentProperty=r.componentProperty,this.states=r.states,this.valueNodeName=r.valueNodeName,this.valueNodeProperty=r.valueNodeProperty,this.valueNodeProperty===ii.VisualResponseProperty.TRANSFORM&&(this.minNodeName=r.minNodeName,this.maxNodeName=r.maxNodeName),this.value=0,this.updateFromComponent(si)}updateFromComponent({xAxis:r,yAxis:x,button:b,state:S}){const{normalizedXAxis:C,normalizedYAxis:A}=function(r=0,x=0){let b=r,S=x;if(Math.sqrt(r*r+x*x)>1){const C=Math.atan2(x,r);b=Math.cos(C),S=Math.sin(C)}return{normalizedXAxis:.5*b+.5,normalizedYAxis:.5*S+.5}}(r,x);switch(this.componentProperty){case ii.ComponentProperty.X_AXIS:this.value=this.states.includes(S)?C:.5;break;case ii.ComponentProperty.Y_AXIS:this.value=this.states.includes(S)?A:.5;break;case ii.ComponentProperty.BUTTON:this.value=this.states.includes(S)?b:0;break;case ii.ComponentProperty.STATE:this.valueNodeProperty===ii.VisualResponseProperty.VISIBILITY?this.value=this.states.includes(S):this.value=this.states.includes(S)?1:0;break;default:throw new Error(`Unexpected visualResponse componentProperty ${this.componentProperty}`)}}}class Component{constructor(r,x){if(!(r&&x&&x.visualResponses&&x.gamepadIndices&&0!==Object.keys(x.gamepadIndices).length))throw new Error("Invalid arguments supplied");this.id=r,this.type=x.type,this.rootNodeName=x.rootNodeName,this.touchPointNodeName=x.touchPointNodeName,this.visualResponses={},Object.keys(x.visualResponses).forEach((r=>{const b=new VisualResponse(x.visualResponses[r]);this.visualResponses[r]=b})),this.gamepadIndices=Object.assign({},x.gamepadIndices),this.values={state:ii.ComponentState.DEFAULT,button:void 0!==this.gamepadIndices.button?0:void 0,xAxis:void 0!==this.gamepadIndices.xAxis?0:void 0,yAxis:void 0!==this.gamepadIndices.yAxis?0:void 0}}get data(){return{id:this.id,...this.values}}updateFromGamepad(r){if(this.values.state=ii.ComponentState.DEFAULT,void 0!==this.gamepadIndices.button&&r.buttons.length>this.gamepadIndices.button){const x=r.buttons[this.gamepadIndices.button];this.values.button=x.value,this.values.button=this.values.button<0?0:this.values.button,this.values.button=this.values.button>1?1:this.values.button,x.pressed||1===this.values.button?this.values.state=ii.ComponentState.PRESSED:(x.touched||this.values.button>ii.ButtonTouchThreshold)&&(this.values.state=ii.ComponentState.TOUCHED)}void 0!==this.gamepadIndices.xAxis&&r.axes.length>this.gamepadIndices.xAxis&&(this.values.xAxis=r.axes[this.gamepadIndices.xAxis],this.values.xAxis=this.values.xAxis<-1?-1:this.values.xAxis,this.values.xAxis=this.values.xAxis>1?1:this.values.xAxis,this.values.state===ii.ComponentState.DEFAULT&&Math.abs(this.values.xAxis)>ii.AxisTouchThreshold&&(this.values.state=ii.ComponentState.TOUCHED)),void 0!==this.gamepadIndices.yAxis&&r.axes.length>this.gamepadIndices.yAxis&&(this.values.yAxis=r.axes[this.gamepadIndices.yAxis],this.values.yAxis=this.values.yAxis<-1?-1:this.values.yAxis,this.values.yAxis=this.values.yAxis>1?1:this.values.yAxis,this.values.state===ii.ComponentState.DEFAULT&&Math.abs(this.values.yAxis)>ii.AxisTouchThreshold&&(this.values.state=ii.ComponentState.TOUCHED)),Object.values(this.visualResponses).forEach((r=>{r.updateFromComponent(this.values)}))}}class MotionController{constructor(r,x,b){if(!r)throw new Error("No xrInputSource supplied");if(!x)throw new Error("No profile supplied");this.xrInputSource=r,this.assetUrl=b,this.id=x.profileId,this.layoutDescription=x.layouts[r.handedness],this.components={},Object.keys(this.layoutDescription.components).forEach((r=>{const x=this.layoutDescription.components[r];this.components[r]=new Component(r,x)})),this.updateFromGamepad()}get gripSpace(){return this.xrInputSource.gripSpace}get targetRaySpace(){return this.xrInputSource.targetRaySpace}get data(){const r=[];return Object.values(this.components).forEach((x=>{r.push(x.data)})),r}updateFromGamepad(){Object.values(this.components).forEach((r=>{r.updateFromGamepad(this.xrInputSource.gamepad)}))}}class XRControllerModel extends ee{constructor(){super(),this.motionController=null,this.envMap=null}setEnvironmentMap(r){return this.envMap==r||(this.envMap=r,this.traverse((r=>{r.isMesh&&(r.material.envMap=this.envMap,r.material.needsUpdate=!0)}))),this}updateMatrixWorld(r){if(super.updateMatrixWorld(r),!this.motionController)return;let x=this.motionController.xrInputSource?.gamepad;x&&this.motionController.updateFromGamepad(),Object.values(this.motionController.components).forEach((r=>{Object.values(r.visualResponses).forEach((r=>{const{valueNode:x,minNode:b,maxNode:S,value:C,valueNodeProperty:A}=r;x&&(A===ii.VisualResponseProperty.VISIBILITY?x.visible=C:A===ii.VisualResponseProperty.TRANSFORM&&(x.quaternion.slerpQuaternions(b.quaternion,S.quaternion,C),x.position.lerpVectors(b.position,S.position,C)))}))}))}}function addAssetSceneToControllerModel(r,x){!function(r,x){Object.values(r.components).forEach((r=>{const{type:b,touchPointNodeName:S,visualResponses:C}=r;if(b===ii.ComponentType.TOUCHPAD)if(r.touchPointNode=x.getObjectByName(S),r.touchPointNode){const x=new dt(.001),b=new V({color:255}),S=new I(x,b);r.touchPointNode.add(S)}else console.warn("Could not find touch dot, "+r.touchPointNodeName+", in touchpad component "+r.id);Object.values(C).forEach((r=>{const{valueNodeName:b,minNodeName:S,maxNodeName:C,valueNodeProperty:A}=r;if(A===ii.VisualResponseProperty.TRANSFORM){if(r.minNode=x.getObjectByName(S),r.maxNode=x.getObjectByName(C),!r.minNode)return void console.warn(`Could not find ${S} in the model`);if(!r.maxNode)return void console.warn(`Could not find ${C} in the model`)}r.valueNode=x.getObjectByName(b),r.valueNode||console.warn(`Could not find ${b} in the model`)}))}))}(r.motionController,x),r.envMap&&x.traverse((x=>{x.isMesh&&(x.material.envMap=r.envMap,x.material.needsUpdate=!0)})),r.add(x)}const oi="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles/generic-hand/";class XRHandMeshModel{constructor(r,b,S,C,A=null){this.xrInputSource=b,this.handModel=r,this.bones=[],this._fingertips=[],this._phalanxProximals=[],this._palmTriangleVectors=[new x,new x,new x],this._palmTriangleBones=[],this._palmTriangle=new B,this.isPinching=!1,this.isGrabbing=!1,this.palmDirection=new x,null===A&&(A=new GLTFLoader).setPath(S||oi),A.load(`${C}.glb`,(x=>{const b=x.scene.children[0];this.handModel.add(b),this.assetUrl=oi+`${C}.glb`;const S=b.getObjectByProperty("type","SkinnedMesh");S.frustumCulled=!1,S.castShadow=!0,S.receiveShadow=!0;["wrist","thumb-metacarpal","thumb-phalanx-proximal","thumb-phalanx-distal","thumb-tip","index-finger-metacarpal","index-finger-phalanx-proximal","index-finger-phalanx-intermediate","index-finger-phalanx-distal","index-finger-tip","middle-finger-metacarpal","middle-finger-phalanx-proximal","middle-finger-phalanx-intermediate","middle-finger-phalanx-distal","middle-finger-tip","ring-finger-metacarpal","ring-finger-phalanx-proximal","ring-finger-phalanx-intermediate","ring-finger-phalanx-distal","ring-finger-tip","pinky-finger-metacarpal","pinky-finger-phalanx-proximal","pinky-finger-phalanx-intermediate","pinky-finger-phalanx-distal","pinky-finger-tip"].forEach((r=>{const x=b.getObjectByName(r);void 0!==x?x.jointName=r:console.warn(`Couldn't find ${r} in ${C} hand mesh`),this.bones.push(x)}));for(let r of[4,9,14,19,24])this._fingertips.push(this.bones[r]);for(let r of[2,6,11,16,21])this._phalanxProximals.push(this.bones[r]);this._palmTriangleBones.push(this.bones[5]),this._palmTriangleBones.push(this.bones[6]),this._palmTriangleBones.push(this.bones[10]),"left"==C&&this._palmTriangleBones.reverse(),setupBVHForComplexObject(r)}))}_updateGestures(){let r=this.bones[0];if(!r)return;let x=!0,b=r.position;for(let r=2;r<5;r++){let S=this._fingertips[r].position,C=this._phalanxProximals[r].position;if(S.distanceTo(b)>C.distanceTo(b)){x=!1;break}}this.isGrabbing=x;let S=this.bones[4],C=this.bones[9],A=S.position.distanceTo(C.position);this.isPinching?A>.025&&(this.isPinching=!1):A<.015&&(this.isPinching=!0);for(let r=0;r<3;r++)this._palmTriangleBones[r].getWorldPosition(this._palmTriangleVectors[r]);this._palmTriangle.setFromPointsAndIndices(this._palmTriangleVectors,0,1,2),this._palmTriangle.getNormal(this.palmDirection)}updateMesh(r,x,b){if(!b)return;b=b.clone().invert();let S=0;for(let C of this.xrInputSource.hand.values()){let A=this.bones[S],I=r.getJointPose(C,x);A&&I&&(A.matrix.fromArray(I.transform.matrix).premultiply(b),A.matrix.decompose(A.position,A.rotation,A.scale)),S++}this._updateGestures()}}class XRHandModel extends ee{constructor(r){super(),this.controller=r,this.motionController=null,this.envMap=null,this.mesh=null}}const ai=new class{constructor(r=null){this.gltfLoader=r,this.path="https://cdn.jsdelivr.net/npm/@webxr-input-profiles/assets@1.0/dist/profiles",this._assetCache={},this.gltfLoader||(this.gltfLoader=new GLTFLoader)}createControllerModel(r){const x=new XRControllerModel;let b=null;if("tracked-pointer"===r.targetRayMode&&r.gamepad)return fetchProfile(r,this.path,"generic-trigger").then((({profile:S,assetPath:C})=>{x.motionController=new MotionController(r,S,C);const A=this._assetCache[x.motionController.assetUrl];if(A)b=A.scene.clone(),addAssetSceneToControllerModel(x,b);else{if(!this.gltfLoader)throw new Error("GLTFLoader not set.");this.gltfLoader.setPath(""),this.gltfLoader.load(x.motionController.assetUrl,(r=>{this._assetCache[x.motionController.assetUrl]=r,b=r.scene.clone(),addAssetSceneToControllerModel(x,b),setupBVHForComplexObject(x)}),null,(r=>{throw console.error(r),new Error("Asset "+x.motionController.assetUrl+" missing or malformed.")}))}})).catch((r=>{console.warn(r)})),x}},li=new class{constructor(){this.path=null}setPath(r){return this.path=r,this}createHandModel(r){let x=r;const b=new XRHandModel;return x.hand&&!b.motionController&&(b.xrInputSource=x,b.motionController=new XRHandMeshModel(b,x,this.path,x.handedness)),b}};let hi=new class{init(r,x){this._container=r,this._renderer=x,this._renderer.domElement.tabIndex="1",this._xrInputDevices={};for(let r in Nr)this._xrInputDevices[r]={};this._pointerPosition=new b,this._pointerPressed=!1,this._keysPressed=new Set,this._keyCodesPressed=new Set,this._screenTouched=!1,this._joystickAngle=0,this._joystickDistance=0,this._container.style.position="relative",this._createExtraControls(),this._addEventListeners()}_addEventListeners(){if("XR"==Fr.active)this._renderer.xr.addEventListener("sessionstart",(()=>{this._onXRSessionStart()})),this._renderer.xr.addEventListener("sessionend",(()=>{this._onXRSessionEnd()}));else if("POINTER"==Fr.active)this._container.addEventListener("keydown",(r=>{this._keysPressed.add(r.key),this._keyCodesPressed.add(r.code)})),this._container.addEventListener("keyup",(r=>{this._keysPressed.delete(r.key),this._keyCodesPressed.delete(r.code)})),window.addEventListener("blur",(()=>{this._keysPressed.clear(),this._keyCodesPressed.clear()})),this._renderer.domElement.addEventListener("mousedown",(()=>{this._pointerPressed=!0})),this._renderer.domElement.addEventListener("mouseup",(()=>{this._pointerPressed=!1})),this._renderer.domElement.addEventListener("mousemove",(r=>{let x=r.target.getBoundingClientRect();this._pointerPosition.x=(r.clientX-x.left)/this._renderer.domElement.clientWidth*2-1,this._pointerPosition.y=-(r.clientY-x.top)/this._renderer.domElement.clientHeight*2+1})),this._container.addEventListener("mouseup",(()=>{this._renderer.domElement.focus()}));else if("TOUCH_SCREEN"==Fr.active){this._renderer.domElement.addEventListener("touchstart",(()=>{this._screenTouched=!0;let r=event.target.getBoundingClientRect();this._pointerPosition.x=(event.touches[0].clientX-r.left)/this._renderer.domElement.clientWidth*2-1,this._pointerPosition.y=-(event.touches[0].clientY-r.top)/this._renderer.domElement.clientHeight*2+1})),this._renderer.domElement.addEventListener("touchend",(()=>{this._screenTouched=!1})),this._renderer.domElement.addEventListener("touchmove",(r=>{let x=r.target.getBoundingClientRect();this._pointerPosition.x=(r.touches[0].clientX-x.left)/this._renderer.domElement.clientWidth*2-1,this._pointerPosition.y=-(r.touches[0].clientY-x.top)/this._renderer.domElement.clientHeight*2+1}));let r=0;document.addEventListener("touchend",(function(x){let b=(new Date).getTime();b-r<=300&&x.preventDefault(),r=b}),!1)}}_onXRSessionStart(){this._session=this._renderer.xr.getSession(),this._session.oninputsourceschange=r=>{this._onXRInputSourceChange(r)};let r=this._session.inputSources;for(let x=0;x<r.length;x++)this._addXRInputSource(r[x])}_onXRSessionEnd(){this._session.oninputsourcechange=null,this._session=null;for(let r in this._xrInputDevices)for(let x in this._xrInputDevices[r])delete this._xrInputDevices[r][x].inputSource}_onXRInputSourceChange(r){for(let x=0;x<r.removed.length;x++)this._deleteXRInputSource(r.removed[x]);for(let x=0;x<r.added.length;x++)this._addXRInputSource(r.added[x])}_addXRInputSource(r){if("tracked-pointer"!=r.targetRayMode)return;let x=null!=r.hand?Nr.HAND:Nr.CONTROLLER,b=r.handedness.toUpperCase();if(b in Gr){let S=this._xrInputDevices[x][b];if(S||(S={controllers:{}},this._xrInputDevices[x][b]=S,r.targetRaySpace&&(S.controllers.targetRay=new ee,S.controllers.targetRay.xrInputDeviceType=x,S.controllers.targetRay.handedness=b),r.gripSpace&&(S.controllers.grip=new ee,S.controllers.grip.xrInputDeviceType=x,S.controllers.grip.handedness=b)),S.inputSource=r,S.model){let x=S.model.motionController;x&&(x.xrInputSource=r)}else x==Nr.HAND?S.model=li.createHandModel(r):x==Nr.CONTROLLER&&(S.model=ai.createControllerModel(r,"mesh"));if(this._xrControllerParent){this._xrControllerParent.add(S.controllers.targetRay);let x=S.controllers;r.gripSpace?(this._xrControllerParent.add(x.grip),x.grip.add(S.model),x.grip.model=S.model):(x.targetRay.add(S.model),x.targetRay.model=S.model)}}}_deleteXRInputSource(r){if("tracked-pointer"!=r.targetRayMode)return;let x=null!=r.hand?Nr.HAND:Nr.CONTROLLER,b=r.handedness.toUpperCase(),S=this._getXRInputDevice(x,b);S?.inputSource&&delete this._xrInputDevices[x][b].inputSource,S?.controllers&&this._xrControllerParent&&(this._xrControllerParent.remove(S.controllers.targetRay),this._xrControllerParent.remove(S.controllers.grip))}_getXRInputDevice(r,x){return this._xrInputDevices[r]?this._xrInputDevices[r][x]:null}getXRInputSource(r,x){let b=this._getXRInputDevice(r,x);return b?b.inputSource:null}getXRGamepad(r){let x=Nr.CONTROLLER,b=this.getXRInputSource(x,r);return b?b.gamepad:null}getXRController(r,x,b){let S=this._getXRInputDevice(r,x);return S?S.controllers[b]:null}getXRControllerModel(r,x){let b=this._getXRInputDevice(r,x);return b?b.model:null}setXRControllerModel(r,x,b){let S=this._getXRInputDevice(r,x);return!!S&&(S.model&&(S.controllers.grip?S.controllers.grip.remove(S.model):S.controllers.targetRay.remove(S.model)),S.model=b,S.controllers.grip?S.controllers.grip.add(b):S.controllers.targetRay.add(b),!0)}enableXRControllerManagement(r){this._xrControllerParent=r}disableXRControllerManagement(){this._xrControllerParent=null}getPointerPosition(){return this._pointerPosition}isPointerPressed(){return this._pointerPressed}isKeyPressed(r){return this._keysPressed.has(r)}isKeyCodePressed(r){return this._keyCodesPressed.has(r)}isScreenTouched(){return this._screenTouched}getJoystickAngle(){return this._joystickAngle}getJoystickDistance(){return this._joystickDistance}_createExtraControls(){this._extraControls={},this._extraControlsDiv=document.createElement("div"),this._extraControlsDiv.style.position="absolute",this._extraControlsDiv.style.bottom="10px",this._extraControlsDiv.style.right="10px",this._container.appendChild(this._extraControlsDiv)}createJoystick(){console.warn("InputHandler.createJoystick() is deprecated, please use InputHandler.showJoystick() instead"),this._createJoystick()}_createJoystick(){if(this._joystickParent)return void this.showJoystick();this._joystickParent=document.createElement("div"),this._joystickParent.style.position="absolute",this._joystickParent.style.width="100px",this._joystickParent.style.height="100px",this._joystickParent.style.left="10px",this._joystickParent.style.bottom="10px",this._container.appendChild(this._joystickParent);let r={zone:this._joystickParent,mode:"static",position:{left:"50%",top:"50%"}},x=nipplejs.create(r).get(0);x.on("move",((r,x)=>{this._joystickAngle=x.angle.radian,this._joystickDistance=Math.min(x.force,1)})),x.on("end",(()=>{this._joystickDistance=0}))}showJoystick(){this._joystickParent?this._container.contains(this._joystickParent)||this._container.appendChild(this._joystickParent):this._createJoystick(),window.dispatchEvent(new Event("resize"))}hideJoystick(){this._joystickParent&&this._container.contains(this._joystickParent)&&this._container.removeChild(this._joystickParent)}addExtraControlsButton(r,x){let b=document.createElement("button");return b.id=r,b.innerText=x,b.style.borderWidth="1px",b.style.borderStyle="solid",b.style.borderColor="#fff",b.style.borderRadius="4px",b.style.background="rgba(0,0,0,0.5)",b.style.padding="12px",b.style.color="#fff",b.style.font="normal 13px sans-serif",b.style.marginLeft="5px",b.style.opacity="0.75",b.style.width="70px",this._extraControlsDiv.appendChild(b),this._extraControls[r]=b,b}getExtraControlsButton(r){return this._extraControls[r]}hideExtraControls(){this._extraControlsDiv.style.display="none"}hideExtraControlsButton(r){let x=this._extraControls[r];x&&(x.style.display="none")}showExtraControls(){this._extraControlsDiv.style.display="block"}showExtraControlsButton(r){let x=this._extraControls[r];x&&(x.style.display="inline-block")}_updateXRController(r,x,b){let S=b.inputSource,C=b.controllers;if(S){let A=r.getPose(S.targetRaySpace,x);if(null!=A&&(C.targetRay.matrix.fromArray(A.transform.matrix),C.targetRay.matrix.decompose(C.targetRay.position,C.targetRay.rotation,C.targetRay.scale)),S.gripSpace){let b=r.getPose(S.gripSpace,x);null!=b&&(C.grip.matrix.fromArray(b.transform.matrix),C.grip.matrix.decompose(C.grip.position,C.grip.rotation,C.grip.scale))}if(S.hand&&b.model){let S=C.grip?C.grip.matrix:C.targetRay.matrix,A=b.model.motionController;A&&(A.updateMesh(r,x,S),b.model.children.length&&updateBVHForComplexObject(b.model))}}}update(r){if(null==r)return;let x=this._renderer.xr.getReferenceSpace();for(let b in this._xrInputDevices)for(let S in this._xrInputDevices[b])this._updateXRController(r,x,this._xrInputDevices[b][S])}};class InteractableHandler{constructor(){this._interactables=new Set,this._hoveredInteractables=new Map,this._selectedInteractables=new Map,this._capturedInteractables=new Map,this._overInteractables=new Map,this._owners=new Map,this._owners.set("POINTER",{id:"POINTER"}),this._owners.set("TOUCH_SCREEN",{id:"TOUCH_SCREEN"}),this._wasPressed=new Map,this._listeners={},this._tool=null,this._toolHandlers={}}_setupXRSubscription(){Or.addUpdateListener((r=>{for(let[r,x]of this._hoveredInteractables)x&&x.removeHoveredBy(r),this._hoveredInteractables.delete(r);for(let[x,b]of this._selectedInteractables){if(!b)continue;let S=0;r&&(S+=b.getCallbacksLength(r)),this._tool&&(S+=b.getCallbacksLength(this._tool)),S&&(b.removeSelectedBy(x),this._selectedInteractables.delete(x))}this._tool=r}))}_getOwner(r){return this._owners.has(r)||this._owners.set(r,{id:r.uuid,object:r}),this._owners.get(r)}init(){"XR"==Fr.active?(this.update=this._updateForXR,this._setupXRSubscription()):"POINTER"==Fr.active?this.update=this._updateForPointer:"TOUCH_SCREEN"==Fr.active&&(this.update=this._updateForTouchScreen)}addEventListener(r,x){r in this._listeners||(this._listeners[r]=new Set),this._listeners[r].add(x)}removeEventListener(r,x){r in this._listeners&&(this._listeners[r].delete(x),0==this._listeners[r].size&&delete this._listeners[r])}_trigger(r,x,b){if(this._listeners[r]){let S={...x};if(b&&(S.target=b.object,b[r](x)),!this._listeners[r])return;let C=[];this._listeners[r].forEach((r=>C.push(r)));for(let r of C)r(S)}else b&&b[r](x)}registerToolHandler(r,x){this._toolHandlers[r]=x}addInteractable(r){this._interactables.add(r)}addInteractables(r){r.forEach((r=>{this._interactables.add(r)}))}removeInteractable(r){this._interactables.delete(r),r.reset()}removeInteractables(r){r.forEach((r=>{this._interactables.delete(r),r.reset()}))}reset(){this._interactables.forEach((r=>{r.reset()})),this._interactables=new Set,this._hoveredInteractables=new Map,this._selectedInteractables=new Map}update(){}_updateForXR(){}_updateForPointer(){}_updateForTouchScreen(){}}const ci=new r.Vector3;let di=new class extends InteractableHandler{constructor(){super(),this._cursors={},this._ignoredInteractables=new Set}init(r,x,b,S){super.init(),this._renderer=r,this._scene=x,this._camera=b,this._cameraFocus=S||b}_getXRCursor(x){if(this._cursors[x])return this._cursors[x];let b=document.createElement("canvas");b.width=64,b.height=64;let S=b.getContext("2d");S.beginPath(),S.arc(32,32,29,0,2*Math.PI),S.lineWidth=5,S.stroke(),S.fillStyle="white",S.fill();let C=new r.SpriteMaterial({map:new r.CanvasTexture(b),depthTest:!1,sizeAttenuation:!1});for(let x in Gr){let b=new r.Sprite(C);b.scale.set(.015,.015,.015),b.visible=!1,b.renderOrder=1/0,this._cursors[x]=b,this._scene.add(b)}return this._cursors[x]}_getRaycaster(x){x.raycaster||(x.raycaster=new r.Raycaster);let b=hi.getPointerPosition();return x.raycaster.setFromCamera(b,this._camera),x.raycaster}_getXRRaycaster(x){return x.raycaster||(x.raycaster=new r.Raycaster),x.getWorldPosition(x.raycaster.ray.origin),x.getWorldDirection(x.raycaster.ray.direction).negate().normalize(),x.raycaster}_isXRControllerPressed(r,x){if(r==Nr.HAND){let b=hi.getXRControllerModel(r,x);return 1==b?.motionController?.isPinching}{let r=hi.getXRGamepad(x);return null!=r?.buttons&&r.buttons[0].pressed}}_squashInteractables(r,x,b){for(let S of x){let x=S.object;x&&!S.isOnlyGroup()&&b.push(x),0!=S.children.size&&this._squashInteractables(r,S.children,b)}}_getObjectInteractable(r){for(;null!=r;){let x=r.pointerInteractable;if(x&&!x.isOnlyGroup())return x;r=r.parent}}_raycastInteractables(r,x){this._ignoredInteractables.clear();let b=r.raycaster;if(!b||b.disabled)return;b.firstHitOnly=!0,b.params.Line.threshold=.01;let S=[];this._squashInteractables(r.owner,x,S);let C=b.intersectObjects(S);for(let x of C){let b=this._getObjectInteractable(x.object);if(!b||this._ignoredInteractables.has(b))continue;if(this._checkClipped(x.object,x.point)){this._ignoredInteractables.add(b);continue}let S=x.distance,C=S;if("XR"!=Fr.active&&(this._cameraFocus.getWorldPosition(ci),C=x.point.distanceTo(ci)),b.isWithinReach(C))return r.closestPointDistance=S,r.closestPoint=x.point,r.closestInteractable=b,void(r.userDistance=C)}}_checkClipped(r,x){let b=r?.material?.clippingPlanes;if(b&&b.length>0)for(let r of b)if(r.distanceToPoint(x)<0)return!0;return!1}_updateInteractables(r){let x=r.owner,b=r.isPressed,S=this._hoveredInteractables.get(x),C=this._selectedInteractables.get(x),A=this._overInteractables.get(x),I=r.closestInteractable,R=r.closestPoint,B=r.userDistance;I!=S&&(S&&(S.removeHoveredBy(x),this._hoveredInteractables.delete(x)),!I||(C||b)&&I!=C||(I.addHoveredBy(x),this._hoveredInteractables.set(x,I),S=I));let D={owner:x},F={owner:x,point:R,userDistance:B};C?(b||(C.removeSelectedBy(x),this._selectedInteractables.delete(x)),C==I?(A!=I&&(A&&A.out(D),I.over(F),this._overInteractables.set(x,I)),I.move(F),I.drag(F),b||(this._trigger("up",F,I),I.click(F))):C.isCapturedBy(x)?(C!=A&&(A&&A.out(D),C.over(D),this._overInteractables.set(x,C),A=C),C.move(D),C.drag(D),b||(this._trigger("up",D,C),C.click(D),A&&A.out(D),I?(I.over(F),this._overInteractables.set(x,I)):this._overInteractables.delete(x))):I?(A!=I&&(A&&A.out(D),I.over(F),this._overInteractables.set(x,I)),I.move(F),b||this._trigger("up",F,I)):A&&(A.out(D),this._overInteractables.delete(x))):I?(A!=I&&(A&&A.out(D),I.over(F),this._overInteractables.set(x,I)),I.move(F),b&&!this._wasPressed.get(x)?(this._trigger("down",F,I),I.addSelectedBy(x),this._selectedInteractables.set(x,I)):!b&&this._wasPressed.get(x)&&this._trigger("up",F,I)):(A&&(A.out(D),this._overInteractables.delete(x)),b?this._wasPressed.get(x)||this._trigger("down",D):this._wasPressed.get(x)&&this._trigger("up",D)),this._wasPressed.set(x,b)}_updateCursor(r){let x=r.cursor;x&&(null!=r.closestPoint?(x.position.copy(r.closestPoint),x.visible||(x.visible=!0)):x.visible&&(x.visible=!1))}_updateForXR(){for(let r in Gr){let x=!1;for(let b of[Nr.HAND,Nr.CONTROLLER]){let S=hi.getXRController(b,r,"grip");if(S||(S=hi.getXRController(b,r,"targetRay")),!S)continue;let C,A,I=this._getOwner(S),R=isDescendant(this._scene,S);if(R&&(b==Nr.CONTROLLER?x=!0:x&&(R=!1)),R){let x=hi.getXRController(b,r,"targetRay");C=this._getXRRaycaster(x),I.raycaster||(I.raycaster=C),A=this._isXRControllerPressed(b,r)}let B={owner:I,raycaster:C,isPressed:A,closestPoint:null,closestPointDistance:Number.MAX_SAFE_INTEGER,cursor:R?this._getXRCursor(r):null,userDistance:Number.MAX_SAFE_INTEGER},D=!1;this._toolHandlers[this._tool]&&(D=this._toolHandlers[this._tool](B)),D||(this._raycastInteractables(B,this._interactables),this._updateInteractables(B)),this._updateCursor(B)}}}_updateForPointer(){let r=this._getOwner(Fr.POINTER),x={owner:r,raycaster:this._getRaycaster(r),isPressed:hi.isPointerPressed(),closestPoint:null,closestPointDistance:Number.MAX_SAFE_INTEGER,userDistance:Number.MAX_SAFE_INTEGER},b=!1;this._toolHandlers[this._tool]&&(b=this._toolHandlers[this._tool](x)),b||(this._raycastInteractables(x,this._interactables),this._updateInteractables(x));let S=this._renderer.domElement.style,C=this._hoveredInteractables.get(r);C&&!this._selectedInteractables.get(r)?S.cursor=C.hoveredCursor:""!=S.cursor&&(S.cursor="")}_updateForTouchScreen(){let r=this._getOwner(Fr.TOUCH_SCREEN),x={owner:r,raycaster:this._getRaycaster(r),isPressed:hi.isScreenTouched(),closestPoint:null,closestPointDistance:Number.MAX_SAFE_INTEGER,userDistance:Number.MAX_SAFE_INTEGER};x.raycaster.disabled=!x.isPressed&&!this._wasPressed.get(r);let b=!1;this._toolHandlers[this._tool]&&(b=this._toolHandlers[this._tool](x)),b?this._wasPressed.set(r,x.isPressed):(this._raycastInteractables(x,this._interactables),this._updateInteractables(x))}};const ui=new r.Vector3;let pi=new class extends InteractableHandler{constructor(){super(),this._skipIntersectsCheck=new Map,this._sphere=new r.Sphere,this._box3=new r.Box3}init(r){super.init(),this._scene=r}_setupXRSubscription(){Or.addUpdateListener((r=>{for(let[x,b]of this._selectedInteractables)for(let S of b){if(!S)continue;let b=0;r&&(b+=S.getCallbacksLength(r)),this._tool&&(b+=S.getCallbacksLength(this._tool)),b&&(S.removeSelectedBy(x),this._selectedInteractables.delete(x))}this._tool=r}))}_getBoundingSphere(r){return r?(this._skipIntersectsCheck.get(r)||this._skipIntersectsCheck.set(r,new Map),this._box3.setFromObject(r).getBoundingSphere(this._sphere),this._sphere):null}_scopeInteractables(r,x){let b=r.boundingSphere,S=r.skipIntersectsCheck;if(null!=b)for(let C of x){0!=C.children.size&&this._scopeInteractables(r,C.children);let x=C.object;if(null!=x&&!C.isOnlyGroup()&&(r.activeInteractables.add(C),C.intersectsSphere(b)&&!this._checkClipped(x))){let x=r.model||r.owner.object,b=S.get(C);b?(this._selectedInteractables.get(r.owner).has(C)&&r.touchedInteractables.add(C),S.set(C,b-1)):(C.intersectsObject(x)&&r.touchedInteractables.add(C),S.set(C,5))}}}_checkClipped(r){let x=r?.material?.clippingPlanes;if(x&&x.length>0){r.getWorldPosition(ui);for(let r of x)if(r.distanceToPoint(ui)<0)return!0}return!1}_updateInteractables(r){let x=r.owner;this._scopeInteractables(r,this._interactables),this._selectedInteractables.get(x)||this._selectedInteractables.set(x,new Set);let b=this._selectedInteractables.get(x),S=r.touchedInteractables,C=r.activeInteractables,A={owner:x};for(let r of b)S.has(r)||(r.removeSelectedBy(x),b.delete(r),C.has(r)&&(r.drag(A),this._trigger("up",A,r),r.click(A)));for(let r of S)b.has(r)?r.drag(A):(r.addSelectedBy(x),b.add(r),this._trigger("down",A,r))}_updateForXR(){for(let r in Gr){let x=!1;for(let b of[Nr.HAND,Nr.CONTROLLER]){let S=hi.getXRController(b,r,"grip"),C=hi.getXRControllerModel(b,r);if(S||(S=hi.getXRController(b,r,"targetRay")),!S)continue;let A,I,R=this._getOwner(S),B=isDescendant(this._scene,S);if(B&&(b==Nr.CONTROLLER?x=!0:x&&(B=!1)),B){let r=isDescendant(S,C)?C:S;A=this._getBoundingSphere(r),I=this._skipIntersectsCheck.get(r)}let D={owner:R,model:C,boundingSphere:A,activeInteractables:new Set,touchedInteractables:new Set,skipIntersectsCheck:I},F=!1;this._toolHandlers[this._tool]&&(F=this._toolHandlers[this._tool](D)),F||this._updateInteractables(D)}}}};class InteractableComponent extends LayoutComponent{constructor(...r){super(...r),this.pointerInteractable=this.pointerInteractableClassOverride?new this.pointerInteractableClassOverride(this):new PointerInteractable(this),this.touchInteractable=new TouchInteractable(this),this._clickAction=r=>this._pointerClick(r),this._dragAction=r=>this._pointerDrag(r),this._touchAction=r=>this._touch(r),this._touchDragAction=r=>this._touchDrag(r)}_createBackground(){super._createBackground(),this.pointerInteractable.object=this._background,this.touchInteractable.object=this._background}_pointerClick(r){this._onClick&&this._onClick(r)}_pointerDrag(r){this._onDrag&&this._onDrag(r)}_touch(r){this._onTouch&&this._onTouch(r)}_touchDrag(r){this._onTouchDrag&&this._onTouchDrag(r)}_onAdded(){super._onAdded();let x=this.parentComponent;if(this.parent?.pointerInteractable&&this.parent?.touchInteractable)this.parent.pointerInteractable.addChild(this.pointerInteractable),this.parent.touchInteractable.addChild(this.touchInteractable);else if(x instanceof InteractableComponent)x.pointerInteractable.addChild(this.pointerInteractable),x.touchInteractable.addChild(this.touchInteractable);else{for(x=this.parent;x;){if(x instanceof r.Scene)return di.addInteractable(this.pointerInteractable),void pi.addInteractable(this.touchInteractable);x=x.parent}di.removeInteractable(this.pointerInteractable),pi.removeInteractable(this.touchInteractable)}}_onRemoved(){super._onRemoved(),this.pointerInteractable.parent?this.pointerInteractable.parent.removeChild(this.pointerInteractable):di.removeInteractable(this.pointerInteractable),this.touchInteractable.parent?this.touchInteractable.parent.removeChild(this.touchInteractable):pi.removeInteractable(this.touchInteractable)}_setCallback(r,x,b,S){let C="_on"+capitalizeFirstLetter(b),A="_"+b+"Action";S&&!this[C]?r.addEventListener(x,this[A]):!S&&this[C]&&r.removeEventListener(x,this[A]),this[C]=S}get onClick(){return this._onClick}get onDrag(){return this._onDrag}get onTouch(){return this._onTouch}get onTouchDrag(){return this._onTouchDrag}set onClick(r){this._setCallback(this.pointerInteractable,"click","click",r)}set onClickAndTouch(r){this._setCallback(this.pointerInteractable,"click","click",r),this._setCallback(this.touchInteractable,"click","touch",r)}set onDrag(r){this._setCallback(this.pointerInteractable,"drag","drag",r)}set onTouch(r){this._setCallback(this.touchInteractable,"click","touch",r)}set onTouchDrag(r){this._setCallback(this.touchInteractable,"drag","touchDrag",r)}}const fi=new r.Vector3,gi=new r.Plane;class ScrollableComponent extends InteractableComponent{constructor(...x){super(...x),this.scrollAmount=0,this._scrollBoundsMin=new r.Vector2,this._scrollBoundsMax=new r.Vector2,this._scrollOwner,this._scrollable=!1,this._scrollableByAncestor=!1,this._downAction=r=>this.pointerInteractable.capture(r.owner),this._touchDownAction=r=>this.touchInteractable.capture(r.owner)}updateLayout(){super.updateLayout(),this._updateScrollInteractables()}_updateScrollInteractables(){let r=this._scrollable||this._scrollableByAncestor;if(this._updateScrollable(),r==(this._scrollable||this._scrollableByAncestor))return;for(let r of this._content.children)r instanceof ScrollableComponent&&r._updateScrollInteractables();let x=r?"removeEventListener":"addEventListener";this.pointerInteractable[x]("down",this._downAction),this.touchInteractable[x]("down",this._touchDownAction),this._onClick||this.pointerInteractable[x]("click",this._clickAction),this._onDrag||this.pointerInteractable[x]("drag",this._dragAction),this._onTouch||this.touchInteractable[x]("click",this._touchAction),this._onTouchDrag||this.touchInteractable[x]("drag",this._touchDragAction)}_updateScrollable(){let r=this.computedHeight,x=this.computedWidth,b=this._getContentHeight(),S=this._getContentWidth(),C="scroll"==this.overflow;if(this._verticallyScrollable=b>r&&C,this._horizontallyScrollable=S>x&&C,this._scrollable=this._verticallyScrollable||this._horizontallyScrollable,this._scrollableByAncestor=null!=this._onClick&&null!=this._getScrollableAncestor(),!this._scrollable)return this._content.position.x=0,void(this._content.position.y=0);let A,I,R,B,D,F,G,N,H=this.justifyContent,W=this.alignItems;"row"==this.contentDirection?(A=-this.unpaddedWidth,I=this.unpaddedHeight,R=-S,B=b,D="x",F="y",G=this._scrollBoundsMin,N=this._scrollBoundsMax):(A=this.unpaddedHeight,I=-this.unpaddedWidth,R=b,B=-S,D="y",F="x",G=this._scrollBoundsMax,N=this._scrollBoundsMin),"start"==H?(G[D]=R-A,N[D]=0):"end"==H?(G[D]=0,N[D]=-R+A):"center"==H||Math.abs(A)-Math.abs(R)<0?(G[D]=(R-A)/2,N[D]=-1*G[D]):G[D]=N[D]=0,"start"==W?(N[F]=B-I,G[F]=0):"end"==W?(N[F]=0,G[F]=-B+I):(N[F]=(B-I)/2,G[F]=-1*N[F]),this._verticallyScrollable&&this._boundScrollPosition("y"),this._horizontallyScrollable&&this._boundScrollPosition("x")}_pointerClick(r){let{owner:x,point:b}=r;if(this._scrollAncestor){let S=!this._scrollAncestor.scrollThresholdReached;this._scrollAncestor.clearScroll(x),this._scrollAncestor=null,this._onClick&&S&&b&&this._onClick(r)}else this._onClick&&this._onClick(r);this.clearScroll(x)}_pointerDrag(r){let{owner:x,point:b}=r;this._onDrag?this._onDrag(r):this._scrollable?this.handleScroll(x,b):this._scrollableByAncestor&&(this._scrollAncestor?this._scrollAncestor.handleScroll(x,b):(this._scrollAncestor=this._getScrollableAncestor(),this._scrollAncestor&&this._scrollAncestor.handleScroll(x,b)))}_touch(r){let x=r.owner;if(this._scrollAncestor){let x=!this.scrollThresholdReached;this.scrollThresholdReached=!1,this._scrollAncestor=null,this._onTouch&&x&&this._onTouch(r)}else this._onTouch&&this._onTouch(r);this.clearScroll(x)}_touchDrag(r){let x=r.owner;this._onTouchDrag?this._onTouchDrag(x):this._scrollable?this.handleTouchScroll(x,this.touchInteractable):this._scrollAncestor?this._scrollAncestor.scrollThresholdReached&&!this.scrollThresholdReached&&(this.scrollThresholdReached=!0):this._scrollAncestor=this._getScrollableAncestor()}clearScroll(r){this._scrollStart&&r==this._scrollOwner&&(this._scrollOwner=null,this._scrollStart=null,this._scrollStartPosition=null,this._scrollType=null,this._scrollStartThresholdReached=null,this.scrollThresholdReached=null,this.scrollAmount=0)}handleScroll(r,x){this._scrollStart?r==this._scrollOwner&&"POINTER"==this._scrollType&&(x?x=fi.copy(x):(gi.set(fi.set(0,0,1),0),gi.applyMatrix4(this.matrixWorld),x=r.raycaster.ray.intersectPlane(gi,fi)),x&&(x=this.worldToLocal(x),this._horizontallyScrollable&&this._scroll("x",x),this._verticallyScrollable&&this._scroll("y",x))):x&&(this._scrollStart=this.worldToLocal(x.clone()),this._scrollStartPosition=this._content.position.clone(),this._scrollOwner=r,this._scrollType="POINTER")}handleTouchScroll(r,x){if(this._scrollStart){if(r==this._scrollOwner&&"TOUCH"==this._scrollType){let r=this._scrollController.bvhGeometry.getAttribute("position");fi.fromBufferAttribute(r,this._scrollVertex),this._scrollController.localToWorld(fi),this.worldToLocal(fi),this._horizontallyScrollable&&this._scroll("x",fi),this._verticallyScrollable&&this._scroll("y",fi)}}else{let b=x.getClosestPointTo(r.object);this._scrollController=b[1].object,this._scrollVertex=this._scrollController.bvhGeometry.index.array[3*b[1].faceIndex];let S=this._scrollController.bvhGeometry.getAttribute("position");fi.fromBufferAttribute(S,this._scrollVertex),this._scrollController.localToWorld(fi),this._scrollStart=this.worldToLocal(fi).clone(),this._scrollStartPosition=this._content.position.clone(),this._scrollOwner=r,this._scrollType="TOUCH"}}_getScrollableAncestor(){let r=this.parentComponent;for(;r instanceof LayoutComponent;){if(r._scrollable)return r;r=r.parentComponent}}_scroll(r,x){let b=this._content.position[r];if(this._content.position[r]=this._scrollStartPosition[r]-this._scrollStart[r]+x[r],this._boundScrollPosition(r),!this.scrollThresholdReached){let S=Math.abs(b-this._content.position[r]);this.scrollAmount+=S;let C="x"==r?this.computedWidth:this.computedHeight;this._scrollStartThresholdReached?this.scrollAmount>.1*C&&(this.scrollThresholdReached=!0):(this._content.position[r]=b,this._scrollStart[r]=x[r],this.scrollAmount>=.02*C&&(this._scrollStartThresholdReached=!0,this.scrollAmount=0))}}_boundScrollPosition(r){this._content.position[r]<this._scrollBoundsMin[r]?this._content.position[r]=this._scrollBoundsMin[r]:this._content.position[r]>this._scrollBoundsMax[r]&&(this._content.position[r]=this._scrollBoundsMax[r])}_setCallback(r,x,b,S){let C="_on"+capitalizeFirstLetter(b),A="_"+b+"Action";this._scrollable||this._scrollableByAncestor||(S&&!this[C]?r.addEventListener(x,this[A]):!S&&this[C]&&r.removeEventListener(x,this[A])),this[C]=S}}class Body extends ScrollableComponent{constructor(...r){super(...r),this.bypassContentPositioning=!0,this._defaults.backgroundVisible=!0,this._defaults.height=1,this._defaults.width=1,this.updateLayout()}}function workerBootstrap(){var r=Object.create(null);function registerModule(x,b){var S=x.id,C=x.name,A=x.dependencies;void 0===A&&(A=[]);var I=x.init;void 0===I&&(I=function(){});var R=x.getTransferables;if(void 0===R&&(R=null),!r[S])try{A=A.map((function(x){return x&&x.isWorkerModule&&(registerModule(x,(function(r){if(r instanceof Error)throw r})),x=r[x.id].value),x})),I=rehydrate("<"+C+">.init",I),R&&(R=rehydrate("<"+C+">.getTransferables",R));var B=null;"function"==typeof I?B=I.apply(void 0,A):console.error("worker module init function failed to rehydrate"),r[S]={id:S,value:B,getTransferables:R},b(B)}catch(r){r&&r.noLog||console.error(r),b(r)}}function rehydrate(r,x){var b=void 0;self.troikaDefine=function(r){return b=r};var S=URL.createObjectURL(new Blob(["/** "+r.replace(/\*/g,"")+" **/\n\ntroikaDefine(\n"+x+"\n)"],{type:"application/javascript"}));try{importScripts(S)}catch(r){console.error(r)}return URL.revokeObjectURL(S),delete self.troikaDefine,b}self.addEventListener("message",(function(x){var b=x.data,S=b.messageId,C=b.action,A=b.data;try{"registerModule"===C&&registerModule(A,(function(r){r instanceof Error?postMessage({messageId:S,success:!1,error:r.message}):postMessage({messageId:S,success:!0,result:{isCallable:"function"==typeof r}})})),"callModule"===C&&function(x,b){var S,C=x.id,A=x.args;r[C]&&"function"==typeof r[C].value||b(new Error("Worker module "+C+": not found or its 'init' did not return a function"));try{var I=(S=r[C]).value.apply(S,A);I&&"function"==typeof I.then?I.then(handleResult,(function(r){return b(r instanceof Error?r:new Error(""+r))})):handleResult(I)}catch(r){b(r)}function handleResult(x){try{var S=r[C].getTransferables&&r[C].getTransferables(x);S&&Array.isArray(S)&&S.length||(S=void 0),b(x,S)}catch(r){console.error(r),b(r)}}}(A,(function(r,x){r instanceof Error?postMessage({messageId:S,success:!1,error:r.message}):postMessage({messageId:S,success:!0,result:r},x||void 0)}))}catch(r){postMessage({messageId:S,success:!1,error:r.stack})}}))}var supportsWorkers=function(){var r=!1;if("undefined"!=typeof window&&void 0!==window.document)try{new Worker(URL.createObjectURL(new Blob([""],{type:"application/javascript"}))).terminate(),r=!0}catch(r){"undefined"!=typeof process&&"test"===process.env.NODE_ENV||console.log("Troika createWorkerModule: web workers not allowed; falling back to main thread execution. Cause: ["+r.message+"]")}return supportsWorkers=function(){return r},r},mi=0,_i=0,yi=!1,vi=Object.create(null),xi=Object.create(null),bi=Object.create(null);function defineWorkerModule(r){if(!(r&&"function"==typeof r.init||yi))throw new Error("requires `options.init` function");var x=r.dependencies,b=r.init,S=r.getTransferables,C=r.workerId;if(!supportsWorkers())return function(r){var moduleFunc=function(){for(var r=[],x=arguments.length;x--;)r[x]=arguments[x];return moduleFunc._getInitResult().then((function(x){if("function"==typeof x)return x.apply(void 0,r);throw new Error("Worker module function was called but `init` did not return a callable function")}))};return moduleFunc._getInitResult=function(){var x=r.dependencies,b=r.init;x=Array.isArray(x)?x.map((function(r){return r&&r._getInitResult?r._getInitResult():r})):[];var S=Promise.all(x).then((function(r){return b.apply(null,r)}));return moduleFunc._getInitResult=function(){return S},S},moduleFunc}(r);null==C&&(C="#default");var A="workerModule"+ ++mi,I=r.name||A,R=null;function moduleFunc(){for(var r=[],x=arguments.length;x--;)r[x]=arguments[x];if(!R){R=callWorker(C,"registerModule",moduleFunc.workerModuleData);var unregister=function(){R=null,xi[C].delete(unregister)};(xi[C]||(xi[C]=new Set)).add(unregister)}return R.then((function(x){if(x.isCallable)return callWorker(C,"callModule",{id:A,args:r});throw new Error("Worker module function was called but `init` did not return a callable function")}))}return x=x&&x.map((function(r){return"function"!=typeof r||r.workerModuleData||(yi=!0,r=defineWorkerModule({workerId:C,name:"<"+I+"> function dependency: "+r.name,init:"function(){return (\n"+stringifyFunction(r)+"\n)}"}),yi=!1),r&&r.workerModuleData&&(r=r.workerModuleData),r})),moduleFunc.workerModuleData={isWorkerModule:!0,id:A,name:I,dependencies:x,init:stringifyFunction(b),getTransferables:S&&stringifyFunction(S)},moduleFunc}function stringifyFunction(r){var x=r.toString();return!/^function/.test(x)&&/^\w+\s*\(/.test(x)&&(x="function "+x),x}function callWorker(r,x,b){return new Promise((function(S,C){var A=++_i;bi[A]=function(r){r.success?S(r.result):C(new Error("Error in worker "+x+" call: "+r.error))},function(r){var x=vi[r];if(!x){var b=stringifyFunction(workerBootstrap);(x=vi[r]=new Worker(URL.createObjectURL(new Blob(["/** Worker Module Bootstrap: "+r.replace(/\*/g,"")+" **/\n\n;("+b+")()"],{type:"application/javascript"})))).onmessage=function(r){var x=r.data,b=x.messageId,S=bi[b];if(!S)throw new Error("WorkerModule response with empty or unknown messageId");delete bi[b],S(x)}}return x}(r).postMessage({messageId:A,action:x,data:b})}))}function SDFGenerator(){var r=function(r){function pointOnCubicBezier(r,x,b,S,C,A,I,R,B,D){var F=1-B;D.x=F*F*F*r+3*F*F*B*b+3*F*B*B*C+B*B*B*I,D.y=F*F*F*x+3*F*F*B*S+3*F*B*B*A+B*B*B*R}function forEachPathCommand(r,x){for(var b,S,C,A,I,R=/([MLQCZ])([^MLQCZ]*)/g;b=R.exec(r);){var B=b[2].replace(/^\s*|\s*$/g,"").split(/[,\s]+/).map((function(r){return parseFloat(r)}));switch(b[1]){case"M":A=S=B[0],I=C=B[1];break;case"L":B[0]===A&&B[1]===I||x("L",A,I,A=B[0],I=B[1]);break;case"Q":x("Q",A,I,A=B[2],I=B[3],B[0],B[1]);break;case"C":x("C",A,I,A=B[4],I=B[5],B[0],B[1],B[2],B[3]);break;case"Z":A===S&&I===C||x("L",A,I,S,C)}}}function pathToLineSegments(r,x,b){void 0===b&&(b=16);var S={x:0,y:0};forEachPathCommand(r,(function(r,C,A,I,R,B,D,F,G){switch(r){case"L":x(C,A,I,R);break;case"Q":for(var N=C,H=A,W=1;W<b;W++)q=A,K=D,$=R,Z=void 0,Z=1-(Y=W/(b-1)),(J=S).x=Z*Z*C+2*Z*Y*B+Y*Y*I,J.y=Z*Z*q+2*Z*Y*K+Y*Y*$,x(N,H,S.x,S.y),N=S.x,H=S.y;break;case"C":for(var V=C,j=A,X=1;X<b;X++)pointOnCubicBezier(C,A,B,D,F,G,I,R,X/(b-1),S),x(V,j,S.x,S.y),V=S.x,j=S.y}var q,K,$,Y,J,Z}))}var x="precision highp float;attribute vec2 aUV;varying vec2 vUV;void main(){vUV=aUV;gl_Position=vec4(mix(vec2(-1.0),vec2(1.0),aUV),0.0,1.0);}",b="precision highp float;uniform sampler2D tex;varying vec2 vUV;void main(){gl_FragColor=texture2D(tex,vUV);}",S=new WeakMap,C={premultipliedAlpha:!1,preserveDrawingBuffer:!0,antialias:!1,depth:!1};function withWebGLContext(r,x){var b=r.getContext?r.getContext("webgl",C):r,A=S.get(b);if(!A){var I="undefined"!=typeof WebGL2RenderingContext&&b instanceof WebGL2RenderingContext,R={},B={},D={},F=-1,G=[];function getExtension(r){var x=R[r];if(!x&&!(x=R[r]=b.getExtension(r)))throw new Error(r+" not supported");return x}function compileShader(r,x){var S=b.createShader(x);return b.shaderSource(S,r),b.compileShader(S),S}function withProgram(r,x,S,C){if(!B[r]){var A={},R={},D=b.createProgram();b.attachShader(D,compileShader(x,b.VERTEX_SHADER)),b.attachShader(D,compileShader(S,b.FRAGMENT_SHADER)),b.linkProgram(D),B[r]={program:D,transaction:function(r){b.useProgram(D),r({setUniform:function(r,x){for(var S=[],C=arguments.length-2;C-- >0;)S[C]=arguments[C+2];var A=R[x]||(R[x]=b.getUniformLocation(D,x));b["uniform"+r].apply(b,[A].concat(S))},setAttribute:function(r,x,S,C,R){var B=A[r];B||(B=A[r]={buf:b.createBuffer(),loc:b.getAttribLocation(D,r),data:null}),b.bindBuffer(b.ARRAY_BUFFER,B.buf),b.vertexAttribPointer(B.loc,x,b.FLOAT,!1,0,0),b.enableVertexAttribArray(B.loc),I?b.vertexAttribDivisor(B.loc,C):getExtension("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(B.loc,C),R!==B.data&&(b.bufferData(b.ARRAY_BUFFER,R,S),B.data=R)}})}}}B[r].transaction(C)}function withTexture(r,x){F++;try{b.activeTexture(b.TEXTURE0+F);var S=D[r];S||(S=D[r]=b.createTexture(),b.bindTexture(b.TEXTURE_2D,S),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST)),b.bindTexture(b.TEXTURE_2D,S),x(S,F)}finally{F--}}function withTextureFramebuffer(r,x,S){var C=b.createFramebuffer();G.push(C),b.bindFramebuffer(b.FRAMEBUFFER,C),b.activeTexture(b.TEXTURE0+x),b.bindTexture(b.TEXTURE_2D,r),b.framebufferTexture2D(b.FRAMEBUFFER,b.COLOR_ATTACHMENT0,b.TEXTURE_2D,r,0);try{S(C)}finally{b.deleteFramebuffer(C),b.bindFramebuffer(b.FRAMEBUFFER,G[--G.length-1]||null)}}function handleContextLoss(){R={},B={},D={},F=-1,G.length=0}b.canvas.addEventListener("webglcontextlost",(function(r){handleContextLoss(),r.preventDefault()}),!1),S.set(b,A={gl:b,isWebGL2:I,getExtension:getExtension,withProgram:withProgram,withTexture:withTexture,withTextureFramebuffer:withTextureFramebuffer,handleContextLoss:handleContextLoss})}x(A)}function renderImageData(r,S,C,A,I,R,B,D){void 0===B&&(B=15),void 0===D&&(D=null),withWebGLContext(r,(function(r){var F=r.gl,G=r.withProgram;(0,r.withTexture)("copy",(function(r,N){F.texImage2D(F.TEXTURE_2D,0,F.RGBA,I,R,0,F.RGBA,F.UNSIGNED_BYTE,S),G("copy",x,b,(function(r){var x=r.setUniform;(0,r.setAttribute)("aUV",2,F.STATIC_DRAW,0,new Float32Array([0,0,2,0,0,2])),x("1i","image",N),F.bindFramebuffer(F.FRAMEBUFFER,D||null),F.disable(F.BLEND),F.colorMask(8&B,4&B,2&B,1&B),F.viewport(C,A,I,R),F.scissor(C,A,I,R),F.drawArrays(F.TRIANGLES,0,3)}))}))}))}var A=Object.freeze({__proto__:null,withWebGLContext:withWebGLContext,renderImageData:renderImageData,resizeWebGLCanvasWithoutClearing:function(r,x,b){var S=r.width,C=r.height;withWebGLContext(r,(function(A){var I=A.gl,R=new Uint8Array(S*C*4);I.readPixels(0,0,S,C,I.RGBA,I.UNSIGNED_BYTE,R),r.width=x,r.height=b,renderImageData(I,R,0,0,S,C)}))}});function generate$2(r,x,b,S,C,A){void 0===A&&(A=1);var I=new Uint8Array(r*x),R=S[2]-S[0],B=S[3]-S[1],D=[];pathToLineSegments(b,(function(r,x,b,S){D.push({x1:r,y1:x,x2:b,y2:S,minX:Math.min(r,b),minY:Math.min(x,S),maxX:Math.max(r,b),maxY:Math.max(x,S)})})),D.sort((function(r,x){return r.maxX-x.maxX}));for(var F=0;F<r;F++)for(var G=0;G<x;G++){var N=findNearestSignedDistance(S[0]+R*(F+.5)/r,S[1]+B*(G+.5)/x),H=Math.pow(1-Math.abs(N)/C,A)/2;N<0&&(H=1-H),H=Math.max(0,Math.min(255,Math.round(255*H))),I[G*r+F]=H}return I;function findNearestSignedDistance(r,x){for(var b=1/0,S=1/0,C=D.length;C--;){var A=D[C];if(A.maxX+S<=r)break;if(r+S>A.minX&&x-S<A.maxY&&x+S>A.minY){var I=absSquareDistanceToLineSegment(r,x,A.x1,A.y1,A.x2,A.y2);I<b&&(b=I,S=Math.sqrt(b))}}return function(r,x){for(var b=0,S=D.length;S--;){var C=D[S];if(C.maxX<=r)break;C.y1>x!=C.y2>x&&r<(C.x2-C.x1)*(x-C.y1)/(C.y2-C.y1)+C.x1&&(b+=C.y1<C.y2?1:-1)}return 0!==b}(r,x)&&(S=-S),S}}function generateIntoCanvas$2(r,x,b,S,C,A,I,R,B,D){void 0===A&&(A=1),void 0===R&&(R=0),void 0===B&&(B=0),void 0===D&&(D=0),generateIntoFramebuffer$1(r,x,b,S,C,A,I,null,R,B,D)}function generateIntoFramebuffer$1(r,x,b,S,C,A,I,R,B,D,F){void 0===A&&(A=1),void 0===B&&(B=0),void 0===D&&(D=0),void 0===F&&(F=0);for(var G=generate$2(r,x,b,S,C,A),N=new Uint8Array(4*G.length),H=0;H<G.length;H++)N[4*H+F]=G[H];renderImageData(I,N,B,D,r,x,1<<3-F,R)}function absSquareDistanceToLineSegment(r,x,b,S,C,A){var I=C-b,R=A-S,B=I*I+R*R,D=B?Math.max(0,Math.min(1,((r-b)*I+(x-S)*R)/B)):0,F=r-(b+D*I),G=x-(S+D*R);return F*F+G*G}var I=Object.freeze({__proto__:null,generate:generate$2,generateIntoCanvas:generateIntoCanvas$2,generateIntoFramebuffer:generateIntoFramebuffer$1}),R="precision highp float;uniform vec4 uGlyphBounds;attribute vec2 aUV;attribute vec4 aLineSegment;varying vec4 vLineSegment;varying vec2 vGlyphXY;void main(){vLineSegment=aLineSegment;vGlyphXY=mix(uGlyphBounds.xy,uGlyphBounds.zw,aUV);gl_Position=vec4(mix(vec2(-1.0),vec2(1.0),aUV),0.0,1.0);}",B="precision highp float;uniform vec4 uGlyphBounds;uniform float uMaxDistance;uniform float uExponent;varying vec4 vLineSegment;varying vec2 vGlyphXY;float absDistToSegment(vec2 point,vec2 lineA,vec2 lineB){vec2 lineDir=lineB-lineA;float lenSq=dot(lineDir,lineDir);float t=lenSq==0.0 ? 0.0 : clamp(dot(point-lineA,lineDir)/lenSq,0.0,1.0);vec2 linePt=lineA+t*lineDir;return distance(point,linePt);}void main(){vec4 seg=vLineSegment;vec2 p=vGlyphXY;float dist=absDistToSegment(p,seg.xy,seg.zw);float val=pow(1.0-clamp(dist/uMaxDistance,0.0,1.0),uExponent)*0.5;bool crossing=(seg.y>p.y!=seg.w>p.y)&&(p.x<(seg.z-seg.x)*(p.y-seg.y)/(seg.w-seg.y)+seg.x);bool crossingUp=crossing&&vLineSegment.y<vLineSegment.w;gl_FragColor=vec4(crossingUp ? 1.0/255.0 : 0.0,crossing&&!crossingUp ? 1.0/255.0 : 0.0,0.0,val);}",D="precision highp float;uniform sampler2D tex;varying vec2 vUV;void main(){vec4 color=texture2D(tex,vUV);bool inside=color.r!=color.g;float val=inside ? 1.0-color.a : color.a;gl_FragColor=vec4(val);}",F=new Float32Array([0,0,2,0,0,2]),G=null,N=!1,H={},W=new WeakMap;function validateSupport(r){if(!N&&!isSupported(r))throw new Error("WebGL generation not supported")}function generate$1(r,x,b,S,C,A,I){if(void 0===A&&(A=1),void 0===I&&(I=null),!I&&!(I=G)){var R="function"==typeof OffscreenCanvas?new OffscreenCanvas(1,1):"undefined"!=typeof document?document.createElement("canvas"):null;if(!R)throw new Error("OffscreenCanvas or DOM canvas not supported");I=G=R.getContext("webgl",{depth:!1})}validateSupport(I);var B=new Uint8Array(r*x*4);withWebGLContext(I,(function(I){var R=I.gl,D=I.withTexture,F=I.withTextureFramebuffer;D("readable",(function(I,D){R.texImage2D(R.TEXTURE_2D,0,R.RGBA,r,x,0,R.RGBA,R.UNSIGNED_BYTE,null),F(I,D,(function(I){generateIntoFramebuffer(r,x,b,S,C,A,R,I,0,0,0),R.readPixels(0,0,r,x,R.RGBA,R.UNSIGNED_BYTE,B)}))}))}));for(var D=new Uint8Array(r*x),F=0,N=0;F<B.length;F+=4)D[N++]=B[F];return D}function generateIntoCanvas$1(r,x,b,S,C,A,I,R,B,D){void 0===A&&(A=1),void 0===R&&(R=0),void 0===B&&(B=0),void 0===D&&(D=0),generateIntoFramebuffer(r,x,b,S,C,A,I,null,R,B,D)}function generateIntoFramebuffer(r,b,S,C,A,I,G,N,H,W,V){void 0===I&&(I=1),void 0===H&&(H=0),void 0===W&&(W=0),void 0===V&&(V=0),validateSupport(G);var j=[];pathToLineSegments(S,(function(r,x,b,S){j.push(r,x,b,S)})),j=new Float32Array(j),withWebGLContext(G,(function(S){var G=S.gl,X=S.isWebGL2,q=S.getExtension,K=S.withProgram,$=S.withTexture,Y=S.withTextureFramebuffer,J=S.handleContextLoss;if($("rawDistances",(function(S,$){r===S._lastWidth&&b===S._lastHeight||G.texImage2D(G.TEXTURE_2D,0,G.RGBA,S._lastWidth=r,S._lastHeight=b,0,G.RGBA,G.UNSIGNED_BYTE,null),K("main",R,B,(function(x){var R=x.setAttribute,B=x.setUniform,D=!X&&q("ANGLE_instanced_arrays"),N=!X&&q("EXT_blend_minmax");R("aUV",2,G.STATIC_DRAW,0,F),R("aLineSegment",4,G.DYNAMIC_DRAW,1,j),B.apply(void 0,["4f","uGlyphBounds"].concat(C)),B("1f","uMaxDistance",A),B("1f","uExponent",I),Y(S,$,(function(x){G.enable(G.BLEND),G.colorMask(!0,!0,!0,!0),G.viewport(0,0,r,b),G.scissor(0,0,r,b),G.blendFunc(G.ONE,G.ONE),G.blendEquationSeparate(G.FUNC_ADD,X?G.MAX:N.MAX_EXT),G.clear(G.COLOR_BUFFER_BIT),X?G.drawArraysInstanced(G.TRIANGLES,0,3,j.length/4):D.drawArraysInstancedANGLE(G.TRIANGLES,0,3,j.length/4)}))})),K("post",x,D,(function(x){x.setAttribute("aUV",2,G.STATIC_DRAW,0,F),x.setUniform("1i","tex",$),G.bindFramebuffer(G.FRAMEBUFFER,N),G.disable(G.BLEND),G.colorMask(0===V,1===V,2===V,3===V),G.viewport(H,W,r,b),G.scissor(H,W,r,b),G.drawArrays(G.TRIANGLES,0,3)}))})),G.isContextLost())throw J(),new Error("webgl context lost")}))}function isSupported(r){var x=r&&r!==G?r.canvas||r:H,b=W.get(x);if(void 0===b){N=!0;var S=null;try{var C=[97,106,97,61,99,137,118,80,80,118,137,99,61,97,106,97],A=generate$1(4,4,"M8,8L16,8L24,24L16,24Z",[0,0,32,32],24,1,r);b=A&&C.length===A.length&&A.every((function(r,x){return r===C[x]})),b||(S="bad trial run results",console.info(C,A))}catch(r){b=!1,S=r.message}S&&console.warn("WebGL SDF generation not supported:",S),N=!1,W.set(x,b)}return b}var V=Object.freeze({__proto__:null,generate:generate$1,generateIntoCanvas:generateIntoCanvas$1,generateIntoFramebuffer:generateIntoFramebuffer,isSupported:isSupported});return r.forEachPathCommand=forEachPathCommand,r.generate=function(r,x,b,S,C,A){void 0===C&&(C=Math.max(S[2]-S[0],S[3]-S[1])/2),void 0===A&&(A=1);try{return generate$1.apply(V,arguments)}catch(r){return console.info("WebGL SDF generation failed, falling back to JS",r),generate$2.apply(I,arguments)}},r.generateIntoCanvas=function(r,x,b,S,C,A,R,B,D,F){void 0===C&&(C=Math.max(S[2]-S[0],S[3]-S[1])/2),void 0===A&&(A=1),void 0===B&&(B=0),void 0===D&&(D=0),void 0===F&&(F=0);try{return generateIntoCanvas$1.apply(V,arguments)}catch(r){return console.info("WebGL SDF generation failed, falling back to JS",r),generateIntoCanvas$2.apply(I,arguments)}},r.javascript=I,r.pathToLineSegments=pathToLineSegments,r.webgl=V,r.webglUtils=A,Object.defineProperty(r,"__esModule",{value:!0}),r}({});return r}const Ti=/\bvoid\s+main\s*\(\s*\)\s*{/g;function expandShaderIncludes(r){return r.replace(/^[ \t]*#include +<([\w\d./]+)>/gm,(function(r,x){let b=mt[x];return b?expandShaderIncludes(b):r}))}const wi=[];for(let r=0;r<256;r++)wi[r]=(r<16?"0":"")+r.toString(16);const Si=Object.assign||function(){let r=arguments[0];for(let x=1,b=arguments.length;x<b;x++){let b=arguments[x];if(b)for(let x in b)Object.prototype.hasOwnProperty.call(b,x)&&(r[x]=b[x])}return r},Ci=Date.now(),Ai=new WeakMap,Ii=new Map;let ki=1e10;function createDerivedMaterial(r,x){const b=function(r){const x=JSON.stringify(r,optionsJsonReplacer);let b=Ri.get(x);null==b&&Ri.set(x,b=++Ei);return b}
/*!
Custom build of Typr.ts (https://github.com/fredli74/Typr.ts) for use in Troika text rendering.
Original MIT license applies: https://github.com/fredli74/Typr.ts/blob/master/LICENSE
*/(x);let S=Ai.get(r);if(S||Ai.set(r,S=Object.create(null)),S[b])return new S[b];const C=`_onBeforeCompile${b}`,onBeforeCompile=function(S,A){r.onBeforeCompile.call(this,S,A);const I=this.customProgramCacheKey()+"|"+S.vertexShader+"|"+S.fragmentShader;let R=Ii[I];if(!R){const r=function(r,{vertexShader:x,fragmentShader:b},S,C){let{vertexDefs:A,vertexMainIntro:I,vertexMainOutro:R,vertexTransform:B,fragmentDefs:D,fragmentMainIntro:F,fragmentMainOutro:G,fragmentColorTransform:N,customRewriter:H,timeUniform:W}=S;A=A||"",I=I||"",R=R||"",D=D||"",F=F||"",G=G||"",(B||H)&&(x=expandShaderIncludes(x));(N||H)&&(b=expandShaderIncludes(b=b.replace(/^[ \t]*#include <((?:tonemapping|encodings|fog|premultiplied_alpha|dithering)_fragment)>/gm,"\n//!BEGIN_POST_CHUNK $1\n$&\n//!END_POST_CHUNK\n")));if(H){let r=H({vertexShader:x,fragmentShader:b});x=r.vertexShader,b=r.fragmentShader}if(N){let r=[];b=b.replace(/^\/\/!BEGIN_POST_CHUNK[^]+?^\/\/!END_POST_CHUNK/gm,(x=>(r.push(x),""))),G=`${N}\n${r.join("\n")}\n${G}`}if(W){const r=`\nuniform float ${W};\n`;A=r+A,D=r+D}B&&(A=`${A}\nvoid troikaVertexTransform${C}(inout vec3 position, inout vec3 normal, inout vec2 uv) {\n  ${B}\n}\n`,I=`\ntroika_position_${C} = vec3(position);\ntroika_normal_${C} = vec3(normal);\ntroika_uv_${C} = vec2(uv);\ntroikaVertexTransform${C}(troika_position_${C}, troika_normal_${C}, troika_uv_${C});\n${I}\n`,x=(x=`vec3 troika_position_${C};\nvec3 troika_normal_${C};\nvec2 troika_uv_${C};\n${x}\n`).replace(/\b(position|normal|uv)\b/g,((r,x,b,S)=>/\battribute\s+vec[23]\s+$/.test(S.substr(0,b))?x:`troika_${x}_${C}`)),r.map&&r.map.channel>0||(x=x.replace(/\bMAP_UV\b/g,`troika_uv_${C}`)));return x=injectIntoShaderCode(x,C,A,I,R),b=injectIntoShaderCode(b,C,D,F,G),{vertexShader:x,fragmentShader:b}}(this,S,x,b);R=Ii[I]=r}S.vertexShader=R.vertexShader,S.fragmentShader=R.fragmentShader,Si(S.uniforms,this.uniforms),x.timeUniform&&(S.uniforms[x.timeUniform]={get value(){return Date.now()-Ci}}),this[C]&&this[C](S)},DerivedMaterial=function(){return derive(x.chained?r:r.clone())},derive=function(S){const C=Object.create(S,A);return Object.defineProperty(C,"baseMaterial",{value:r}),Object.defineProperty(C,"id",{value:ki++}),C.uuid=function(){const r=4294967295*Math.random()|0,x=4294967295*Math.random()|0,b=4294967295*Math.random()|0,S=4294967295*Math.random()|0;return(wi[255&r]+wi[r>>8&255]+wi[r>>16&255]+wi[r>>24&255]+"-"+wi[255&x]+wi[x>>8&255]+"-"+wi[x>>16&15|64]+wi[x>>24&255]+"-"+wi[63&b|128]+wi[b>>8&255]+"-"+wi[b>>16&255]+wi[b>>24&255]+wi[255&S]+wi[S>>8&255]+wi[S>>16&255]+wi[S>>24&255]).toUpperCase()}(),C.uniforms=Si({},S.uniforms,x.uniforms),C.defines=Si({},S.defines,x.defines),C.defines[`TROIKA_DERIVED_MATERIAL_${b}`]="",C.extensions=Si({},S.extensions,x.extensions),C._listeners=void 0,C},A={constructor:{value:DerivedMaterial},isDerivedMaterial:{value:!0},customProgramCacheKey:{writable:!0,configurable:!0,value:function(){return r.customProgramCacheKey()+"|"+b}},onBeforeCompile:{get:()=>onBeforeCompile,set(r){this[C]=r}},copy:{writable:!0,configurable:!0,value:function(x){return r.copy.call(this,x),r.isShaderMaterial||r.isDerivedMaterial||(Si(this.extensions,x.extensions),Si(this.defines,x.defines),Si(this.uniforms,ut.clone(x.uniforms))),this}},clone:{writable:!0,configurable:!0,value:function(){const x=new r.constructor;return derive(x).copy(this)}},getDepthMaterial:{writable:!0,configurable:!0,value:function(){let b=this._depthMaterial;return b||(b=this._depthMaterial=createDerivedMaterial(r.isDerivedMaterial?r.getDepthMaterial():new pt({depthPacking:ft}),x),b.defines.IS_DEPTH_MATERIAL="",b.uniforms=this.uniforms),b}},getDistanceMaterial:{writable:!0,configurable:!0,value:function(){let b=this._distanceMaterial;return b||(b=this._distanceMaterial=createDerivedMaterial(r.isDerivedMaterial?r.getDistanceMaterial():new gt,x),b.defines.IS_DISTANCE_MATERIAL="",b.uniforms=this.uniforms),b}},dispose:{writable:!0,configurable:!0,value(){const{_depthMaterial:x,_distanceMaterial:b}=this;x&&x.dispose(),b&&b.dispose(),r.dispose.call(this)}}};return S[b]=DerivedMaterial,new DerivedMaterial}function injectIntoShaderCode(r,x,b,S,C){return(S||C||b)&&(r=r.replace(Ti,`\n${b}\nvoid troikaOrigMain${x}() {`),r+=`\nvoid main() {\n  ${S}\n  troikaOrigMain${x}();\n  ${C}\n}`),r}function optionsJsonReplacer(r,x){return"uniforms"===r?void 0:"function"==typeof x?x.toString():x}let Ei=0;const Ri=new Map;const Mi=defineWorkerModule({name:"Typr Font Parser",dependencies:[function(){return"undefined"==typeof window&&(self.window=self),function(r){var x={parse:function(r){var b=x._bin,S=new Uint8Array(r);if("ttcf"==b.readASCII(S,0,4)){var C=4;b.readUshort(S,C),C+=2,b.readUshort(S,C),C+=2;var A=b.readUint(S,C);C+=4;for(var I=[],R=0;R<A;R++){var B=b.readUint(S,C);C+=4,I.push(x._readFont(S,B))}return I}return[x._readFont(S,0)]},_readFont:function(r,b){var S=x._bin,C=b;S.readFixed(r,b),b+=4;var A=S.readUshort(r,b);b+=2,S.readUshort(r,b),b+=2,S.readUshort(r,b),b+=2,S.readUshort(r,b),b+=2;for(var I=["cmap","head","hhea","maxp","hmtx","name","OS/2","post","loca","glyf","kern","CFF ","GDEF","GPOS","GSUB","SVG "],R={_data:r,_offset:C},B={},D=0;D<A;D++){var F=S.readASCII(r,b,4);b+=4,S.readUint(r,b),b+=4;var G=S.readUint(r,b);b+=4;var N=S.readUint(r,b);b+=4,B[F]={offset:G,length:N}}for(D=0;D<I.length;D++){var H=I[D];B[H]&&(R[H.trim()]=x[H.trim()].parse(r,B[H].offset,B[H].length,R))}return R},_tabOffset:function(r,b,S){for(var C=x._bin,A=C.readUshort(r,S+4),I=S+12,R=0;R<A;R++){var B=C.readASCII(r,I,4);I+=4,C.readUint(r,I),I+=4;var D=C.readUint(r,I);if(I+=4,C.readUint(r,I),I+=4,B==b)return D}return 0}};x._bin={readFixed:function(r,x){return(r[x]<<8|r[x+1])+(r[x+2]<<8|r[x+3])/65540},readF2dot14:function(r,b){return x._bin.readShort(r,b)/16384},readInt:function(r,b){return x._bin._view(r).getInt32(b)},readInt8:function(r,b){return x._bin._view(r).getInt8(b)},readShort:function(r,b){return x._bin._view(r).getInt16(b)},readUshort:function(r,b){return x._bin._view(r).getUint16(b)},readUshorts:function(r,b,S){for(var C=[],A=0;A<S;A++)C.push(x._bin.readUshort(r,b+2*A));return C},readUint:function(r,b){return x._bin._view(r).getUint32(b)},readUint64:function(r,b){return 4294967296*x._bin.readUint(r,b)+x._bin.readUint(r,b+4)},readASCII:function(r,x,b){for(var S="",C=0;C<b;C++)S+=String.fromCharCode(r[x+C]);return S},readUnicode:function(r,x,b){for(var S="",C=0;C<b;C++){var A=r[x++]<<8|r[x++];S+=String.fromCharCode(A)}return S},_tdec:"undefined"!=typeof window&&window.TextDecoder?new window.TextDecoder:null,readUTF8:function(r,b,S){var C=x._bin._tdec;return C&&0==b&&S==r.length?C.decode(r):x._bin.readASCII(r,b,S)},readBytes:function(r,x,b){for(var S=[],C=0;C<b;C++)S.push(r[x+C]);return S},readASCIIArray:function(r,x,b){for(var S=[],C=0;C<b;C++)S.push(String.fromCharCode(r[x+C]));return S},_view:function(r){return r._dataView||(r._dataView=r.buffer?new DataView(r.buffer,r.byteOffset,r.byteLength):new DataView(new Uint8Array(r).buffer))}},x._lctf={},x._lctf.parse=function(r,b,S,C,A){var I=x._bin,R={},B=b;I.readFixed(r,b),b+=4;var D=I.readUshort(r,b);b+=2;var F=I.readUshort(r,b);b+=2;var G=I.readUshort(r,b);return b+=2,R.scriptList=x._lctf.readScriptList(r,B+D),R.featureList=x._lctf.readFeatureList(r,B+F),R.lookupList=x._lctf.readLookupList(r,B+G,A),R},x._lctf.readLookupList=function(r,b,S){var C=x._bin,A=b,I=[],R=C.readUshort(r,b);b+=2;for(var B=0;B<R;B++){var D=C.readUshort(r,b);b+=2;var F=x._lctf.readLookupTable(r,A+D,S);I.push(F)}return I},x._lctf.readLookupTable=function(r,b,S){var C=x._bin,A=b,I={tabs:[]};I.ltype=C.readUshort(r,b),b+=2,I.flag=C.readUshort(r,b),b+=2;var R=C.readUshort(r,b);b+=2;for(var B=I.ltype,D=0;D<R;D++){var F=C.readUshort(r,b);b+=2;var G=S(r,B,A+F,I);I.tabs.push(G)}return I},x._lctf.numOfOnes=function(r){for(var x=0,b=0;b<32;b++)0!=(r>>>b&1)&&x++;return x},x._lctf.readClassDef=function(r,b){var S=x._bin,C=[],A=S.readUshort(r,b);if(b+=2,1==A){var I=S.readUshort(r,b);b+=2;var R=S.readUshort(r,b);b+=2;for(var B=0;B<R;B++)C.push(I+B),C.push(I+B),C.push(S.readUshort(r,b)),b+=2}if(2==A){var D=S.readUshort(r,b);for(b+=2,B=0;B<D;B++)C.push(S.readUshort(r,b)),b+=2,C.push(S.readUshort(r,b)),b+=2,C.push(S.readUshort(r,b)),b+=2}return C},x._lctf.getInterval=function(r,x){for(var b=0;b<r.length;b+=3){var S=r[b],C=r[b+1];if(r[b+2],S<=x&&x<=C)return b}return-1},x._lctf.readCoverage=function(r,b){var S=x._bin,C={};C.fmt=S.readUshort(r,b),b+=2;var A=S.readUshort(r,b);return b+=2,1==C.fmt&&(C.tab=S.readUshorts(r,b,A)),2==C.fmt&&(C.tab=S.readUshorts(r,b,3*A)),C},x._lctf.coverageIndex=function(r,b){var S=r.tab;if(1==r.fmt)return S.indexOf(b);if(2==r.fmt){var C=x._lctf.getInterval(S,b);if(-1!=C)return S[C+2]+(b-S[C])}return-1},x._lctf.readFeatureList=function(r,b){var S=x._bin,C=b,A=[],I=S.readUshort(r,b);b+=2;for(var R=0;R<I;R++){var B=S.readASCII(r,b,4);b+=4;var D=S.readUshort(r,b);b+=2;var F=x._lctf.readFeatureTable(r,C+D);F.tag=B.trim(),A.push(F)}return A},x._lctf.readFeatureTable=function(r,b){var S=x._bin,C=b,A={},I=S.readUshort(r,b);b+=2,I>0&&(A.featureParams=C+I);var R=S.readUshort(r,b);b+=2,A.tab=[];for(var B=0;B<R;B++)A.tab.push(S.readUshort(r,b+2*B));return A},x._lctf.readScriptList=function(r,b){var S=x._bin,C=b,A={},I=S.readUshort(r,b);b+=2;for(var R=0;R<I;R++){var B=S.readASCII(r,b,4);b+=4;var D=S.readUshort(r,b);b+=2,A[B.trim()]=x._lctf.readScriptTable(r,C+D)}return A},x._lctf.readScriptTable=function(r,b){var S=x._bin,C=b,A={},I=S.readUshort(r,b);b+=2,I>0&&(A.default=x._lctf.readLangSysTable(r,C+I));var R=S.readUshort(r,b);b+=2;for(var B=0;B<R;B++){var D=S.readASCII(r,b,4);b+=4;var F=S.readUshort(r,b);b+=2,A[D.trim()]=x._lctf.readLangSysTable(r,C+F)}return A},x._lctf.readLangSysTable=function(r,b){var S=x._bin,C={};S.readUshort(r,b),b+=2,C.reqFeature=S.readUshort(r,b),b+=2;var A=S.readUshort(r,b);return b+=2,C.features=S.readUshorts(r,b,A),C},x.CFF={},x.CFF.parse=function(r,b,S){var C=x._bin;(r=new Uint8Array(r.buffer,b,S))[b=0],r[++b],r[++b],r[++b],b++;var A=[];b=x.CFF.readIndex(r,b,A);for(var I=[],R=0;R<A.length-1;R++)I.push(C.readASCII(r,b+A[R],A[R+1]-A[R]));b+=A[A.length-1];var B=[];b=x.CFF.readIndex(r,b,B);var D=[];for(R=0;R<B.length-1;R++)D.push(x.CFF.readDict(r,b+B[R],b+B[R+1]));b+=B[B.length-1];var F=D[0],G=[];b=x.CFF.readIndex(r,b,G);var N=[];for(R=0;R<G.length-1;R++)N.push(C.readASCII(r,b+G[R],G[R+1]-G[R]));if(b+=G[G.length-1],x.CFF.readSubrs(r,b,F),F.CharStrings){b=F.CharStrings,G=[],b=x.CFF.readIndex(r,b,G);var H=[];for(R=0;R<G.length-1;R++)H.push(C.readBytes(r,b+G[R],G[R+1]-G[R]));F.CharStrings=H}if(F.ROS){b=F.FDArray;var W=[];for(b=x.CFF.readIndex(r,b,W),F.FDArray=[],R=0;R<W.length-1;R++){var V=x.CFF.readDict(r,b+W[R],b+W[R+1]);x.CFF._readFDict(r,V,N),F.FDArray.push(V)}b+=W[W.length-1],b=F.FDSelect,F.FDSelect=[];var j=r[b];if(b++,3!=j)throw j;var X=C.readUshort(r,b);for(b+=2,R=0;R<X+1;R++)F.FDSelect.push(C.readUshort(r,b),r[b+2]),b+=3}return F.Encoding&&(F.Encoding=x.CFF.readEncoding(r,F.Encoding,F.CharStrings.length)),F.charset&&(F.charset=x.CFF.readCharset(r,F.charset,F.CharStrings.length)),x.CFF._readFDict(r,F,N),F},x.CFF._readFDict=function(r,b,S){var C;for(var A in b.Private&&(C=b.Private[1],b.Private=x.CFF.readDict(r,C,C+b.Private[0]),b.Private.Subrs&&x.CFF.readSubrs(r,C+b.Private.Subrs,b.Private)),b)-1!=["FamilyName","FontName","FullName","Notice","version","Copyright"].indexOf(A)&&(b[A]=S[b[A]-426+35])},x.CFF.readSubrs=function(r,b,S){var C=x._bin,A=[];b=x.CFF.readIndex(r,b,A);var I,R=A.length;I=R<1240?107:R<33900?1131:32768,S.Bias=I,S.Subrs=[];for(var B=0;B<A.length-1;B++)S.Subrs.push(C.readBytes(r,b+A[B],A[B+1]-A[B]))},x.CFF.tableSE=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,0,111,112,113,114,0,115,116,117,118,119,120,121,122,0,123,0,124,125,126,127,128,129,130,131,0,132,133,0,134,135,136,137,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,138,0,139,0,0,0,0,140,141,142,143,0,0,0,0,0,144,0,0,0,145,0,0,146,147,148,149,0,0,0,0],x.CFF.glyphByUnicode=function(r,x){for(var b=0;b<r.charset.length;b++)if(r.charset[b]==x)return b;return-1},x.CFF.glyphBySE=function(r,b){return b<0||b>255?-1:x.CFF.glyphByUnicode(r,x.CFF.tableSE[b])},x.CFF.readEncoding=function(r,b,S){x._bin;var C=[".notdef"],A=r[b];if(b++,0!=A)throw"error: unknown encoding format: "+A;var I=r[b];b++;for(var R=0;R<I;R++)C.push(r[b+R]);return C},x.CFF.readCharset=function(r,b,S){var C=x._bin,A=[".notdef"],I=r[b];if(b++,0==I)for(var R=0;R<S;R++){var B=C.readUshort(r,b);b+=2,A.push(B)}else{if(1!=I&&2!=I)throw"error: format: "+I;for(;A.length<S;){B=C.readUshort(r,b),b+=2;var D=0;for(1==I?(D=r[b],b++):(D=C.readUshort(r,b),b+=2),R=0;R<=D;R++)A.push(B),B++}}return A},x.CFF.readIndex=function(r,b,S){var C=x._bin,A=C.readUshort(r,b)+1,I=r[b+=2];if(b++,1==I)for(var R=0;R<A;R++)S.push(r[b+R]);else if(2==I)for(R=0;R<A;R++)S.push(C.readUshort(r,b+2*R));else if(3==I)for(R=0;R<A;R++)S.push(16777215&C.readUint(r,b+3*R-1));else if(1!=A)throw"unsupported offset size: "+I+", count: "+A;return(b+=A*I)-1},x.CFF.getCharString=function(r,b,S){var C=x._bin,A=r[b],I=r[b+1];r[b+2],r[b+3],r[b+4];var R=1,B=null,D=null;A<=20&&(B=A,R=1),12==A&&(B=100*A+I,R=2),21<=A&&A<=27&&(B=A,R=1),28==A&&(D=C.readShort(r,b+1),R=3),29<=A&&A<=31&&(B=A,R=1),32<=A&&A<=246&&(D=A-139,R=1),247<=A&&A<=250&&(D=256*(A-247)+I+108,R=2),251<=A&&A<=254&&(D=256*-(A-251)-I-108,R=2),255==A&&(D=C.readInt(r,b+1)/65535,R=5),S.val=null!=D?D:"o"+B,S.size=R},x.CFF.readCharString=function(r,b,S){for(var C=b+S,A=x._bin,I=[];b<C;){var R=r[b],B=r[b+1];r[b+2],r[b+3],r[b+4];var D=1,F=null,G=null;R<=20&&(F=R,D=1),12==R&&(F=100*R+B,D=2),19!=R&&20!=R||(F=R,D=2),21<=R&&R<=27&&(F=R,D=1),28==R&&(G=A.readShort(r,b+1),D=3),29<=R&&R<=31&&(F=R,D=1),32<=R&&R<=246&&(G=R-139,D=1),247<=R&&R<=250&&(G=256*(R-247)+B+108,D=2),251<=R&&R<=254&&(G=256*-(R-251)-B-108,D=2),255==R&&(G=A.readInt(r,b+1)/65535,D=5),I.push(null!=G?G:"o"+F),b+=D}return I},x.CFF.readDict=function(r,b,S){for(var C=x._bin,A={},I=[];b<S;){var R=r[b],B=r[b+1];r[b+2],r[b+3],r[b+4];var D=1,F=null,G=null;if(28==R&&(G=C.readShort(r,b+1),D=3),29==R&&(G=C.readInt(r,b+1),D=5),32<=R&&R<=246&&(G=R-139,D=1),247<=R&&R<=250&&(G=256*(R-247)+B+108,D=2),251<=R&&R<=254&&(G=256*-(R-251)-B-108,D=2),255==R)throw G=C.readInt(r,b+1)/65535,D=5,"unknown number";if(30==R){var N=[];for(D=1;;){var H=r[b+D];D++;var W=H>>4,V=15&H;if(15!=W&&N.push(W),15!=V&&N.push(V),15==V)break}for(var j="",X=[0,1,2,3,4,5,6,7,8,9,".","e","e-","reserved","-","endOfNumber"],q=0;q<N.length;q++)j+=X[N[q]];G=parseFloat(j)}R<=21&&(F=["version","Notice","FullName","FamilyName","Weight","FontBBox","BlueValues","OtherBlues","FamilyBlues","FamilyOtherBlues","StdHW","StdVW","escape","UniqueID","XUID","charset","Encoding","CharStrings","Private","Subrs","defaultWidthX","nominalWidthX"][R],D=1,12==R&&(F=["Copyright","isFixedPitch","ItalicAngle","UnderlinePosition","UnderlineThickness","PaintType","CharstringType","FontMatrix","StrokeWidth","BlueScale","BlueShift","BlueFuzz","StemSnapH","StemSnapV","ForceBold",0,0,"LanguageGroup","ExpansionFactor","initialRandomSeed","SyntheticBase","PostScript","BaseFontName","BaseFontBlend",0,0,0,0,0,0,"ROS","CIDFontVersion","CIDFontRevision","CIDFontType","CIDCount","UIDBase","FDArray","FDSelect","FontName"][B],D=2)),null!=F?(A[F]=1==I.length?I[0]:I,I=[]):I.push(G),b+=D}return A},x.cmap={},x.cmap.parse=function(r,b,S){r=new Uint8Array(r.buffer,b,S),b=0;var C=x._bin,A={};C.readUshort(r,b),b+=2;var I=C.readUshort(r,b);b+=2;var R=[];A.tables=[];for(var B=0;B<I;B++){var D=C.readUshort(r,b);b+=2;var F=C.readUshort(r,b);b+=2;var G=C.readUint(r,b);b+=4;var N="p"+D+"e"+F,H=R.indexOf(G);if(-1==H){var W;H=A.tables.length,R.push(G);var V=C.readUshort(r,G);0==V?W=x.cmap.parse0(r,G):4==V?W=x.cmap.parse4(r,G):6==V?W=x.cmap.parse6(r,G):12==V?W=x.cmap.parse12(r,G):console.debug("unknown format: "+V,D,F,G),A.tables.push(W)}if(null!=A[N])throw"multiple tables for one platform+encoding";A[N]=H}return A},x.cmap.parse0=function(r,b){var S=x._bin,C={};C.format=S.readUshort(r,b),b+=2;var A=S.readUshort(r,b);b+=2,S.readUshort(r,b),b+=2,C.map=[];for(var I=0;I<A-6;I++)C.map.push(r[b+I]);return C},x.cmap.parse4=function(r,b){var S=x._bin,C=b,A={};A.format=S.readUshort(r,b),b+=2;var I=S.readUshort(r,b);b+=2,S.readUshort(r,b),b+=2;var R=S.readUshort(r,b);b+=2;var B=R/2;A.searchRange=S.readUshort(r,b),b+=2,A.entrySelector=S.readUshort(r,b),b+=2,A.rangeShift=S.readUshort(r,b),b+=2,A.endCount=S.readUshorts(r,b,B),b+=2*B,b+=2,A.startCount=S.readUshorts(r,b,B),b+=2*B,A.idDelta=[];for(var D=0;D<B;D++)A.idDelta.push(S.readShort(r,b)),b+=2;for(A.idRangeOffset=S.readUshorts(r,b,B),b+=2*B,A.glyphIdArray=[];b<C+I;)A.glyphIdArray.push(S.readUshort(r,b)),b+=2;return A},x.cmap.parse6=function(r,b){var S=x._bin,C={};C.format=S.readUshort(r,b),b+=2,S.readUshort(r,b),b+=2,S.readUshort(r,b),b+=2,C.firstCode=S.readUshort(r,b),b+=2;var A=S.readUshort(r,b);b+=2,C.glyphIdArray=[];for(var I=0;I<A;I++)C.glyphIdArray.push(S.readUshort(r,b)),b+=2;return C},x.cmap.parse12=function(r,b){var S=x._bin,C={};C.format=S.readUshort(r,b),b+=2,b+=2,S.readUint(r,b),b+=4,S.readUint(r,b),b+=4;var A=S.readUint(r,b);b+=4,C.groups=[];for(var I=0;I<A;I++){var R=b+12*I,B=S.readUint(r,R+0),D=S.readUint(r,R+4),F=S.readUint(r,R+8);C.groups.push([B,D,F])}return C},x.glyf={},x.glyf.parse=function(r,x,b,S){for(var C=[],A=0;A<S.maxp.numGlyphs;A++)C.push(null);return C},x.glyf._parseGlyf=function(r,b){var S=x._bin,C=r._data,A=x._tabOffset(C,"glyf",r._offset)+r.loca[b];if(r.loca[b]==r.loca[b+1])return null;var I={};if(I.noc=S.readShort(C,A),A+=2,I.xMin=S.readShort(C,A),A+=2,I.yMin=S.readShort(C,A),A+=2,I.xMax=S.readShort(C,A),A+=2,I.yMax=S.readShort(C,A),A+=2,I.xMin>=I.xMax||I.yMin>=I.yMax)return null;if(I.noc>0){I.endPts=[];for(var R=0;R<I.noc;R++)I.endPts.push(S.readUshort(C,A)),A+=2;var B=S.readUshort(C,A);if(A+=2,C.length-A<B)return null;I.instructions=S.readBytes(C,A,B),A+=B;var D=I.endPts[I.noc-1]+1;for(I.flags=[],R=0;R<D;R++){var F=C[A];if(A++,I.flags.push(F),0!=(8&F)){var G=C[A];A++;for(var N=0;N<G;N++)I.flags.push(F),R++}}for(I.xs=[],R=0;R<D;R++){var H=0!=(2&I.flags[R]),W=0!=(16&I.flags[R]);H?(I.xs.push(W?C[A]:-C[A]),A++):W?I.xs.push(0):(I.xs.push(S.readShort(C,A)),A+=2)}for(I.ys=[],R=0;R<D;R++)H=0!=(4&I.flags[R]),W=0!=(32&I.flags[R]),H?(I.ys.push(W?C[A]:-C[A]),A++):W?I.ys.push(0):(I.ys.push(S.readShort(C,A)),A+=2);var V=0,j=0;for(R=0;R<D;R++)V+=I.xs[R],j+=I.ys[R],I.xs[R]=V,I.ys[R]=j}else{var X;I.parts=[];do{X=S.readUshort(C,A),A+=2;var q={m:{a:1,b:0,c:0,d:1,tx:0,ty:0},p1:-1,p2:-1};if(I.parts.push(q),q.glyphIndex=S.readUshort(C,A),A+=2,1&X){var K=S.readShort(C,A);A+=2;var $=S.readShort(C,A);A+=2}else K=S.readInt8(C,A),A++,$=S.readInt8(C,A),A++;2&X?(q.m.tx=K,q.m.ty=$):(q.p1=K,q.p2=$),8&X?(q.m.a=q.m.d=S.readF2dot14(C,A),A+=2):64&X?(q.m.a=S.readF2dot14(C,A),A+=2,q.m.d=S.readF2dot14(C,A),A+=2):128&X&&(q.m.a=S.readF2dot14(C,A),A+=2,q.m.b=S.readF2dot14(C,A),A+=2,q.m.c=S.readF2dot14(C,A),A+=2,q.m.d=S.readF2dot14(C,A),A+=2)}while(32&X);if(256&X){var Y=S.readUshort(C,A);for(A+=2,I.instr=[],R=0;R<Y;R++)I.instr.push(C[A]),A++}}return I},x.GDEF={},x.GDEF.parse=function(r,b,S,C){var A=b;b+=4;var I=x._bin.readUshort(r,b);return{glyphClassDef:0===I?null:x._lctf.readClassDef(r,A+I)}},x.GPOS={},x.GPOS.parse=function(r,b,S,C){return x._lctf.parse(r,b,S,C,x.GPOS.subt)},x.GPOS.subt=function(r,b,S,C){var A=x._bin,I=S,R={};if(R.fmt=A.readUshort(r,S),S+=2,1==b||2==b||3==b||7==b||8==b&&R.fmt<=2){var B=A.readUshort(r,S);S+=2,R.coverage=x._lctf.readCoverage(r,B+I)}if(1==b&&1==R.fmt){var D=A.readUshort(r,S);S+=2,0!=D&&(R.pos=x.GPOS.readValueRecord(r,S,D))}else if(2==b&&R.fmt>=1&&R.fmt<=2){D=A.readUshort(r,S),S+=2;var F=A.readUshort(r,S);S+=2;var G=x._lctf.numOfOnes(D),N=x._lctf.numOfOnes(F);if(1==R.fmt){R.pairsets=[];var H=A.readUshort(r,S);S+=2;for(var W=0;W<H;W++){var V=I+A.readUshort(r,S);S+=2;var j=A.readUshort(r,V);V+=2;for(var X=[],q=0;q<j;q++){var K=A.readUshort(r,V);V+=2,0!=D&&(ee=x.GPOS.readValueRecord(r,V,D),V+=2*G),0!=F&&(te=x.GPOS.readValueRecord(r,V,F),V+=2*N),X.push({gid2:K,val1:ee,val2:te})}R.pairsets.push(X)}}if(2==R.fmt){var $=A.readUshort(r,S);S+=2;var Y=A.readUshort(r,S);S+=2;var J=A.readUshort(r,S);S+=2;var Z=A.readUshort(r,S);for(S+=2,R.classDef1=x._lctf.readClassDef(r,I+$),R.classDef2=x._lctf.readClassDef(r,I+Y),R.matrix=[],W=0;W<J;W++){var Q=[];for(q=0;q<Z;q++){var ee=null,te=null;0!=D&&(ee=x.GPOS.readValueRecord(r,S,D),S+=2*G),0!=F&&(te=x.GPOS.readValueRecord(r,S,F),S+=2*N),Q.push({val1:ee,val2:te})}R.matrix.push(Q)}}}else if(4==b&&1==R.fmt)R.markCoverage=x._lctf.readCoverage(r,A.readUshort(r,S)+I),R.baseCoverage=x._lctf.readCoverage(r,A.readUshort(r,S+2)+I),R.markClassCount=A.readUshort(r,S+4),R.markArray=x.GPOS.readMarkArray(r,A.readUshort(r,S+6)+I),R.baseArray=x.GPOS.readBaseArray(r,A.readUshort(r,S+8)+I,R.markClassCount);else if(6==b&&1==R.fmt)R.mark1Coverage=x._lctf.readCoverage(r,A.readUshort(r,S)+I),R.mark2Coverage=x._lctf.readCoverage(r,A.readUshort(r,S+2)+I),R.markClassCount=A.readUshort(r,S+4),R.mark1Array=x.GPOS.readMarkArray(r,A.readUshort(r,S+6)+I),R.mark2Array=x.GPOS.readBaseArray(r,A.readUshort(r,S+8)+I,R.markClassCount);else{if(9==b&&1==R.fmt){var ne=A.readUshort(r,S);S+=2;var re=A.readUint(r,S);if(S+=4,9==C.ltype)C.ltype=ne;else if(C.ltype!=ne)throw"invalid extension substitution";return x.GPOS.subt(r,C.ltype,I+re)}console.debug("unsupported GPOS table LookupType",b,"format",R.fmt)}return R},x.GPOS.readValueRecord=function(r,b,S){var C=x._bin,A=[];return A.push(1&S?C.readShort(r,b):0),b+=1&S?2:0,A.push(2&S?C.readShort(r,b):0),b+=2&S?2:0,A.push(4&S?C.readShort(r,b):0),b+=4&S?2:0,A.push(8&S?C.readShort(r,b):0),b+=8&S?2:0,A},x.GPOS.readBaseArray=function(r,b,S){var C=x._bin,A=[],I=b,R=C.readUshort(r,b);b+=2;for(var B=0;B<R;B++){for(var D=[],F=0;F<S;F++)D.push(x.GPOS.readAnchorRecord(r,I+C.readUshort(r,b))),b+=2;A.push(D)}return A},x.GPOS.readMarkArray=function(r,b){var S=x._bin,C=[],A=b,I=S.readUshort(r,b);b+=2;for(var R=0;R<I;R++){var B=x.GPOS.readAnchorRecord(r,S.readUshort(r,b+2)+A);B.markClass=S.readUshort(r,b),C.push(B),b+=4}return C},x.GPOS.readAnchorRecord=function(r,b){var S=x._bin,C={};return C.fmt=S.readUshort(r,b),C.x=S.readShort(r,b+2),C.y=S.readShort(r,b+4),C},x.GSUB={},x.GSUB.parse=function(r,b,S,C){return x._lctf.parse(r,b,S,C,x.GSUB.subt)},x.GSUB.subt=function(r,b,S,C){var A=x._bin,I=S,R={};if(R.fmt=A.readUshort(r,S),S+=2,1!=b&&2!=b&&4!=b&&5!=b&&6!=b)return null;if(1==b||2==b||4==b||5==b&&R.fmt<=2||6==b&&R.fmt<=2){var B=A.readUshort(r,S);S+=2,R.coverage=x._lctf.readCoverage(r,I+B)}if(1==b&&R.fmt>=1&&R.fmt<=2){if(1==R.fmt)R.delta=A.readShort(r,S),S+=2;else if(2==R.fmt){var D=A.readUshort(r,S);S+=2,R.newg=A.readUshorts(r,S,D),S+=2*R.newg.length}}else if(2==b&&1==R.fmt){D=A.readUshort(r,S),S+=2,R.seqs=[];for(var F=0;F<D;F++){var G=A.readUshort(r,S)+I;S+=2;var N=A.readUshort(r,G);R.seqs.push(A.readUshorts(r,G+2,N))}}else if(4==b)for(R.vals=[],D=A.readUshort(r,S),S+=2,F=0;F<D;F++){var H=A.readUshort(r,S);S+=2,R.vals.push(x.GSUB.readLigatureSet(r,I+H))}else if(5==b&&2==R.fmt){if(2==R.fmt){var W=A.readUshort(r,S);S+=2,R.cDef=x._lctf.readClassDef(r,I+W),R.scset=[];var V=A.readUshort(r,S);for(S+=2,F=0;F<V;F++){var j=A.readUshort(r,S);S+=2,R.scset.push(0==j?null:x.GSUB.readSubClassSet(r,I+j))}}}else if(6==b&&3==R.fmt){if(3==R.fmt){for(F=0;F<3;F++){D=A.readUshort(r,S),S+=2;for(var X=[],q=0;q<D;q++)X.push(x._lctf.readCoverage(r,I+A.readUshort(r,S+2*q)));S+=2*D,0==F&&(R.backCvg=X),1==F&&(R.inptCvg=X),2==F&&(R.ahedCvg=X)}D=A.readUshort(r,S),S+=2,R.lookupRec=x.GSUB.readSubstLookupRecords(r,S,D)}}else{if(7==b&&1==R.fmt){var K=A.readUshort(r,S);S+=2;var $=A.readUint(r,S);if(S+=4,9==C.ltype)C.ltype=K;else if(C.ltype!=K)throw"invalid extension substitution";return x.GSUB.subt(r,C.ltype,I+$)}console.debug("unsupported GSUB table LookupType",b,"format",R.fmt)}return R},x.GSUB.readSubClassSet=function(r,b){var S=x._bin.readUshort,C=b,A=[],I=S(r,b);b+=2;for(var R=0;R<I;R++){var B=S(r,b);b+=2,A.push(x.GSUB.readSubClassRule(r,C+B))}return A},x.GSUB.readSubClassRule=function(r,b){var S=x._bin.readUshort,C={},A=S(r,b),I=S(r,b+=2);b+=2,C.input=[];for(var R=0;R<A-1;R++)C.input.push(S(r,b)),b+=2;return C.substLookupRecords=x.GSUB.readSubstLookupRecords(r,b,I),C},x.GSUB.readSubstLookupRecords=function(r,b,S){for(var C=x._bin.readUshort,A=[],I=0;I<S;I++)A.push(C(r,b),C(r,b+2)),b+=4;return A},x.GSUB.readChainSubClassSet=function(r,b){var S=x._bin,C=b,A=[],I=S.readUshort(r,b);b+=2;for(var R=0;R<I;R++){var B=S.readUshort(r,b);b+=2,A.push(x.GSUB.readChainSubClassRule(r,C+B))}return A},x.GSUB.readChainSubClassRule=function(r,b){for(var S=x._bin,C={},A=["backtrack","input","lookahead"],I=0;I<A.length;I++){var R=S.readUshort(r,b);b+=2,1==I&&R--,C[A[I]]=S.readUshorts(r,b,R),b+=2*C[A[I]].length}return R=S.readUshort(r,b),b+=2,C.subst=S.readUshorts(r,b,2*R),b+=2*C.subst.length,C},x.GSUB.readLigatureSet=function(r,b){var S=x._bin,C=b,A=[],I=S.readUshort(r,b);b+=2;for(var R=0;R<I;R++){var B=S.readUshort(r,b);b+=2,A.push(x.GSUB.readLigature(r,C+B))}return A},x.GSUB.readLigature=function(r,b){var S=x._bin,C={chain:[]};C.nglyph=S.readUshort(r,b),b+=2;var A=S.readUshort(r,b);b+=2;for(var I=0;I<A-1;I++)C.chain.push(S.readUshort(r,b)),b+=2;return C},x.head={},x.head.parse=function(r,b,S){var C=x._bin,A={};return C.readFixed(r,b),b+=4,A.fontRevision=C.readFixed(r,b),b+=4,C.readUint(r,b),b+=4,C.readUint(r,b),b+=4,A.flags=C.readUshort(r,b),b+=2,A.unitsPerEm=C.readUshort(r,b),b+=2,A.created=C.readUint64(r,b),b+=8,A.modified=C.readUint64(r,b),b+=8,A.xMin=C.readShort(r,b),b+=2,A.yMin=C.readShort(r,b),b+=2,A.xMax=C.readShort(r,b),b+=2,A.yMax=C.readShort(r,b),b+=2,A.macStyle=C.readUshort(r,b),b+=2,A.lowestRecPPEM=C.readUshort(r,b),b+=2,A.fontDirectionHint=C.readShort(r,b),b+=2,A.indexToLocFormat=C.readShort(r,b),b+=2,A.glyphDataFormat=C.readShort(r,b),b+=2,A},x.hhea={},x.hhea.parse=function(r,b,S){var C=x._bin,A={};return C.readFixed(r,b),b+=4,A.ascender=C.readShort(r,b),b+=2,A.descender=C.readShort(r,b),b+=2,A.lineGap=C.readShort(r,b),b+=2,A.advanceWidthMax=C.readUshort(r,b),b+=2,A.minLeftSideBearing=C.readShort(r,b),b+=2,A.minRightSideBearing=C.readShort(r,b),b+=2,A.xMaxExtent=C.readShort(r,b),b+=2,A.caretSlopeRise=C.readShort(r,b),b+=2,A.caretSlopeRun=C.readShort(r,b),b+=2,A.caretOffset=C.readShort(r,b),b+=2,b+=8,A.metricDataFormat=C.readShort(r,b),b+=2,A.numberOfHMetrics=C.readUshort(r,b),b+=2,A},x.hmtx={},x.hmtx.parse=function(r,b,S,C){for(var A=x._bin,I={aWidth:[],lsBearing:[]},R=0,B=0,D=0;D<C.maxp.numGlyphs;D++)D<C.hhea.numberOfHMetrics&&(R=A.readUshort(r,b),b+=2,B=A.readShort(r,b),b+=2),I.aWidth.push(R),I.lsBearing.push(B);return I},x.kern={},x.kern.parse=function(r,b,S,C){var A=x._bin,I=A.readUshort(r,b);if(b+=2,1==I)return x.kern.parseV1(r,b-2,S,C);var R=A.readUshort(r,b);b+=2;for(var B={glyph1:[],rval:[]},D=0;D<R;D++){b+=2,S=A.readUshort(r,b),b+=2;var F=A.readUshort(r,b);b+=2;var G=F>>>8;if(0!=(G&=15))throw"unknown kern table format: "+G;b=x.kern.readFormat0(r,b,B)}return B},x.kern.parseV1=function(r,b,S,C){var A=x._bin;A.readFixed(r,b),b+=4;var I=A.readUint(r,b);b+=4;for(var R={glyph1:[],rval:[]},B=0;B<I;B++){A.readUint(r,b),b+=4;var D=A.readUshort(r,b);b+=2,A.readUshort(r,b),b+=2;var F=D>>>8;if(0!=(F&=15))throw"unknown kern table format: "+F;b=x.kern.readFormat0(r,b,R)}return R},x.kern.readFormat0=function(r,b,S){var C=x._bin,A=-1,I=C.readUshort(r,b);b+=2,C.readUshort(r,b),b+=2,C.readUshort(r,b),b+=2,C.readUshort(r,b),b+=2;for(var R=0;R<I;R++){var B=C.readUshort(r,b);b+=2;var D=C.readUshort(r,b);b+=2;var F=C.readShort(r,b);b+=2,B!=A&&(S.glyph1.push(B),S.rval.push({glyph2:[],vals:[]}));var G=S.rval[S.rval.length-1];G.glyph2.push(D),G.vals.push(F),A=B}return b},x.loca={},x.loca.parse=function(r,b,S,C){var A=x._bin,I=[],R=C.head.indexToLocFormat,B=C.maxp.numGlyphs+1;if(0==R)for(var D=0;D<B;D++)I.push(A.readUshort(r,b+(D<<1))<<1);if(1==R)for(D=0;D<B;D++)I.push(A.readUint(r,b+(D<<2)));return I},x.maxp={},x.maxp.parse=function(r,b,S){var C=x._bin,A={},I=C.readUint(r,b);return b+=4,A.numGlyphs=C.readUshort(r,b),b+=2,65536==I&&(A.maxPoints=C.readUshort(r,b),b+=2,A.maxContours=C.readUshort(r,b),b+=2,A.maxCompositePoints=C.readUshort(r,b),b+=2,A.maxCompositeContours=C.readUshort(r,b),b+=2,A.maxZones=C.readUshort(r,b),b+=2,A.maxTwilightPoints=C.readUshort(r,b),b+=2,A.maxStorage=C.readUshort(r,b),b+=2,A.maxFunctionDefs=C.readUshort(r,b),b+=2,A.maxInstructionDefs=C.readUshort(r,b),b+=2,A.maxStackElements=C.readUshort(r,b),b+=2,A.maxSizeOfInstructions=C.readUshort(r,b),b+=2,A.maxComponentElements=C.readUshort(r,b),b+=2,A.maxComponentDepth=C.readUshort(r,b),b+=2),A},x.name={},x.name.parse=function(r,b,S){var C=x._bin,A={};C.readUshort(r,b),b+=2;var I=C.readUshort(r,b);b+=2,C.readUshort(r,b);for(var R,B=["copyright","fontFamily","fontSubfamily","ID","fullName","version","postScriptName","trademark","manufacturer","designer","description","urlVendor","urlDesigner","licence","licenceURL","---","typoFamilyName","typoSubfamilyName","compatibleFull","sampleText","postScriptCID","wwsFamilyName","wwsSubfamilyName","lightPalette","darkPalette"],D=b+=2,F=0;F<I;F++){var G=C.readUshort(r,b);b+=2;var N=C.readUshort(r,b);b+=2;var H=C.readUshort(r,b);b+=2;var W=C.readUshort(r,b);b+=2;var V=C.readUshort(r,b);b+=2;var j=C.readUshort(r,b);b+=2;var X,q=B[W],K=D+12*I+j;if(0==G)X=C.readUnicode(r,K,V/2);else if(3==G&&0==N)X=C.readUnicode(r,K,V/2);else if(0==N)X=C.readASCII(r,K,V);else if(1==N)X=C.readUnicode(r,K,V/2);else if(3==N)X=C.readUnicode(r,K,V/2);else{if(1!=G)throw"unknown encoding "+N+", platformID: "+G;X=C.readASCII(r,K,V),console.debug("reading unknown MAC encoding "+N+" as ASCII")}var $="p"+G+","+H.toString(16);null==A[$]&&(A[$]={}),A[$][void 0!==q?q:W]=X,A[$]._lang=H}for(var Y in A)if(null!=A[Y].postScriptName&&1033==A[Y]._lang)return A[Y];for(var Y in A)if(null!=A[Y].postScriptName&&0==A[Y]._lang)return A[Y];for(var Y in A)if(null!=A[Y].postScriptName&&3084==A[Y]._lang)return A[Y];for(var Y in A)if(null!=A[Y].postScriptName)return A[Y];for(var Y in A){R=Y;break}return console.debug("returning name table with languageID "+A[R]._lang),A[R]},x["OS/2"]={},x["OS/2"].parse=function(r,b,S){var C=x._bin.readUshort(r,b);b+=2;var A={};if(0==C)x["OS/2"].version0(r,b,A);else if(1==C)x["OS/2"].version1(r,b,A);else if(2==C||3==C||4==C)x["OS/2"].version2(r,b,A);else{if(5!=C)throw"unknown OS/2 table version: "+C;x["OS/2"].version5(r,b,A)}return A},x["OS/2"].version0=function(r,b,S){var C=x._bin;return S.xAvgCharWidth=C.readShort(r,b),b+=2,S.usWeightClass=C.readUshort(r,b),b+=2,S.usWidthClass=C.readUshort(r,b),b+=2,S.fsType=C.readUshort(r,b),b+=2,S.ySubscriptXSize=C.readShort(r,b),b+=2,S.ySubscriptYSize=C.readShort(r,b),b+=2,S.ySubscriptXOffset=C.readShort(r,b),b+=2,S.ySubscriptYOffset=C.readShort(r,b),b+=2,S.ySuperscriptXSize=C.readShort(r,b),b+=2,S.ySuperscriptYSize=C.readShort(r,b),b+=2,S.ySuperscriptXOffset=C.readShort(r,b),b+=2,S.ySuperscriptYOffset=C.readShort(r,b),b+=2,S.yStrikeoutSize=C.readShort(r,b),b+=2,S.yStrikeoutPosition=C.readShort(r,b),b+=2,S.sFamilyClass=C.readShort(r,b),b+=2,S.panose=C.readBytes(r,b,10),b+=10,S.ulUnicodeRange1=C.readUint(r,b),b+=4,S.ulUnicodeRange2=C.readUint(r,b),b+=4,S.ulUnicodeRange3=C.readUint(r,b),b+=4,S.ulUnicodeRange4=C.readUint(r,b),b+=4,S.achVendID=[C.readInt8(r,b),C.readInt8(r,b+1),C.readInt8(r,b+2),C.readInt8(r,b+3)],b+=4,S.fsSelection=C.readUshort(r,b),b+=2,S.usFirstCharIndex=C.readUshort(r,b),b+=2,S.usLastCharIndex=C.readUshort(r,b),b+=2,S.sTypoAscender=C.readShort(r,b),b+=2,S.sTypoDescender=C.readShort(r,b),b+=2,S.sTypoLineGap=C.readShort(r,b),b+=2,S.usWinAscent=C.readUshort(r,b),b+=2,S.usWinDescent=C.readUshort(r,b),b+2},x["OS/2"].version1=function(r,b,S){var C=x._bin;return b=x["OS/2"].version0(r,b,S),S.ulCodePageRange1=C.readUint(r,b),b+=4,S.ulCodePageRange2=C.readUint(r,b),b+4},x["OS/2"].version2=function(r,b,S){var C=x._bin;return b=x["OS/2"].version1(r,b,S),S.sxHeight=C.readShort(r,b),b+=2,S.sCapHeight=C.readShort(r,b),b+=2,S.usDefault=C.readUshort(r,b),b+=2,S.usBreak=C.readUshort(r,b),b+=2,S.usMaxContext=C.readUshort(r,b),b+2},x["OS/2"].version5=function(r,b,S){var C=x._bin;return b=x["OS/2"].version2(r,b,S),S.usLowerOpticalPointSize=C.readUshort(r,b),b+=2,S.usUpperOpticalPointSize=C.readUshort(r,b),b+2},x.post={},x.post.parse=function(r,b,S){var C=x._bin,A={};return A.version=C.readFixed(r,b),b+=4,A.italicAngle=C.readFixed(r,b),b+=4,A.underlinePosition=C.readShort(r,b),b+=2,A.underlineThickness=C.readShort(r,b),b+=2,A},null==x&&(x={}),null==x.U&&(x.U={}),x.U.codeToGlyph=function(r,x){var b=r.cmap,S=-1;if(null!=b.p0e4?S=b.p0e4:null!=b.p3e1?S=b.p3e1:null!=b.p1e0?S=b.p1e0:null!=b.p0e3&&(S=b.p0e3),-1==S)throw"no familiar platform and encoding!";var C=b.tables[S];if(0==C.format)return x>=C.map.length?0:C.map[x];if(4==C.format){for(var A=-1,I=0;I<C.endCount.length;I++)if(x<=C.endCount[I]){A=I;break}return-1==A||C.startCount[A]>x?0:65535&(0!=C.idRangeOffset[A]?C.glyphIdArray[x-C.startCount[A]+(C.idRangeOffset[A]>>1)-(C.idRangeOffset.length-A)]:x+C.idDelta[A])}if(12==C.format){if(x>C.groups[C.groups.length-1][1])return 0;for(I=0;I<C.groups.length;I++){var R=C.groups[I];if(R[0]<=x&&x<=R[1])return R[2]+(x-R[0])}return 0}throw"unknown cmap table format "+C.format},x.U.glyphToPath=function(r,b){var S={cmds:[],crds:[]};if(r.SVG&&r.SVG.entries[b]){var C=r.SVG.entries[b];return null==C?S:("string"==typeof C&&(C=x.SVG.toPath(C),r.SVG.entries[b]=C),C)}if(r.CFF){var A={x:0,y:0,stack:[],nStems:0,haveWidth:!1,width:r.CFF.Private?r.CFF.Private.defaultWidthX:0,open:!1},I=r.CFF,R=r.CFF.Private;if(I.ROS){for(var B=0;I.FDSelect[B+2]<=b;)B+=2;R=I.FDArray[I.FDSelect[B+1]].Private}x.U._drawCFF(r.CFF.CharStrings[b],A,I,R,S)}else r.glyf&&x.U._drawGlyf(b,r,S);return S},x.U._drawGlyf=function(r,b,S){var C=b.glyf[r];null==C&&(C=b.glyf[r]=x.glyf._parseGlyf(b,r)),null!=C&&(C.noc>-1?x.U._simpleGlyph(C,S):x.U._compoGlyph(C,b,S))},x.U._simpleGlyph=function(r,b){for(var S=0;S<r.noc;S++){for(var C=0==S?0:r.endPts[S-1]+1,A=r.endPts[S],I=C;I<=A;I++){var R=I==C?A:I-1,B=I==A?C:I+1,D=1&r.flags[I],F=1&r.flags[R],G=1&r.flags[B],N=r.xs[I],H=r.ys[I];if(I==C)if(D){if(!F){x.U.P.moveTo(b,N,H);continue}x.U.P.moveTo(b,r.xs[R],r.ys[R])}else F?x.U.P.moveTo(b,r.xs[R],r.ys[R]):x.U.P.moveTo(b,(r.xs[R]+N)/2,(r.ys[R]+H)/2);D?F&&x.U.P.lineTo(b,N,H):G?x.U.P.qcurveTo(b,N,H,r.xs[B],r.ys[B]):x.U.P.qcurveTo(b,N,H,(N+r.xs[B])/2,(H+r.ys[B])/2)}x.U.P.closePath(b)}},x.U._compoGlyph=function(r,b,S){for(var C=0;C<r.parts.length;C++){var A={cmds:[],crds:[]},I=r.parts[C];x.U._drawGlyf(I.glyphIndex,b,A);for(var R=I.m,B=0;B<A.crds.length;B+=2){var D=A.crds[B],F=A.crds[B+1];S.crds.push(D*R.a+F*R.b+R.tx),S.crds.push(D*R.c+F*R.d+R.ty)}for(B=0;B<A.cmds.length;B++)S.cmds.push(A.cmds[B])}},x.U._getGlyphClass=function(r,b){var S=x._lctf.getInterval(b,r);return-1==S?0:b[S+2]},x.U._applySubs=function(r,b,S,C){for(var A=r.length-b-1,I=0;I<S.tabs.length;I++)if(null!=S.tabs[I]){var R,B=S.tabs[I];if(!B.coverage||-1!=(R=x._lctf.coverageIndex(B.coverage,r[b])))if(1==S.ltype)r[b],1==B.fmt?r[b]=r[b]+B.delta:r[b]=B.newg[R];else if(4==S.ltype)for(var D=B.vals[R],F=0;F<D.length;F++){var G=D[F],N=G.chain.length;if(!(N>A)){for(var H=!0,W=0,V=0;V<N;V++){for(;-1==r[b+W+(1+V)];)W++;G.chain[V]!=r[b+W+(1+V)]&&(H=!1)}if(H){for(r[b]=G.nglyph,V=0;V<N+W;V++)r[b+V+1]=-1;break}}}else if(5==S.ltype&&2==B.fmt)for(var j=x._lctf.getInterval(B.cDef,r[b]),X=B.cDef[j+2],q=B.scset[X],K=0;K<q.length;K++){var $=q[K],Y=$.input;if(!(Y.length>A)){for(H=!0,V=0;V<Y.length;V++){var J=x._lctf.getInterval(B.cDef,r[b+1+V]);if(-1==j&&B.cDef[J+2]!=Y[V]){H=!1;break}}if(H){var Z=$.substLookupRecords;for(F=0;F<Z.length;F+=2)Z[F],Z[F+1]}}}else if(6==S.ltype&&3==B.fmt){if(!x.U._glsCovered(r,B.backCvg,b-B.backCvg.length))continue;if(!x.U._glsCovered(r,B.inptCvg,b))continue;if(!x.U._glsCovered(r,B.ahedCvg,b+B.inptCvg.length))continue;var Q=B.lookupRec;for(K=0;K<Q.length;K+=2){j=Q[K];var ee=C[Q[K+1]];x.U._applySubs(r,b+j,ee,C)}}}},x.U._glsCovered=function(r,b,S){for(var C=0;C<b.length;C++)if(-1==x._lctf.coverageIndex(b[C],r[S+C]))return!1;return!0},x.U.glyphsToPath=function(r,b,S){for(var C={cmds:[],crds:[]},A=0,I=0;I<b.length;I++){var R=b[I];if(-1!=R){for(var B=I<b.length-1&&-1!=b[I+1]?b[I+1]:0,D=x.U.glyphToPath(r,R),F=0;F<D.crds.length;F+=2)C.crds.push(D.crds[F]+A),C.crds.push(D.crds[F+1]);for(S&&C.cmds.push(S),F=0;F<D.cmds.length;F++)C.cmds.push(D.cmds[F]);S&&C.cmds.push("X"),A+=r.hmtx.aWidth[R],I<b.length-1&&(A+=x.U.getPairAdjustment(r,R,B))}}return C},x.U.P={},x.U.P.moveTo=function(r,x,b){r.cmds.push("M"),r.crds.push(x,b)},x.U.P.lineTo=function(r,x,b){r.cmds.push("L"),r.crds.push(x,b)},x.U.P.curveTo=function(r,x,b,S,C,A,I){r.cmds.push("C"),r.crds.push(x,b,S,C,A,I)},x.U.P.qcurveTo=function(r,x,b,S,C){r.cmds.push("Q"),r.crds.push(x,b,S,C)},x.U.P.closePath=function(r){r.cmds.push("Z")},x.U._drawCFF=function(r,b,S,C,A){for(var I=b.stack,R=b.nStems,B=b.haveWidth,D=b.width,F=b.open,G=0,N=b.x,H=b.y,W=0,V=0,j=0,X=0,q=0,K=0,$=0,Y=0,J=0,Z=0,Q={val:0,size:0};G<r.length;){x.CFF.getCharString(r,G,Q);var ee=Q.val;if(G+=Q.size,"o1"==ee||"o18"==ee)I.length%2!=0&&!B&&(D=I.shift()+C.nominalWidthX),R+=I.length>>1,I.length=0,B=!0;else if("o3"==ee||"o23"==ee)I.length%2!=0&&!B&&(D=I.shift()+C.nominalWidthX),R+=I.length>>1,I.length=0,B=!0;else if("o4"==ee)I.length>1&&!B&&(D=I.shift()+C.nominalWidthX,B=!0),F&&x.U.P.closePath(A),H+=I.pop(),x.U.P.moveTo(A,N,H),F=!0;else if("o5"==ee)for(;I.length>0;)N+=I.shift(),H+=I.shift(),x.U.P.lineTo(A,N,H);else if("o6"==ee||"o7"==ee)for(var te=I.length,ne="o6"==ee,re=0;re<te;re++){var ie=I.shift();ne?N+=ie:H+=ie,ne=!ne,x.U.P.lineTo(A,N,H)}else if("o8"==ee||"o24"==ee){te=I.length;for(var se=0;se+6<=te;)W=N+I.shift(),V=H+I.shift(),j=W+I.shift(),X=V+I.shift(),N=j+I.shift(),H=X+I.shift(),x.U.P.curveTo(A,W,V,j,X,N,H),se+=6;"o24"==ee&&(N+=I.shift(),H+=I.shift(),x.U.P.lineTo(A,N,H))}else{if("o11"==ee)break;if("o1234"==ee||"o1235"==ee||"o1236"==ee||"o1237"==ee)"o1234"==ee&&(V=H,j=(W=N+I.shift())+I.shift(),Z=X=V+I.shift(),K=X,Y=H,N=($=(q=(J=j+I.shift())+I.shift())+I.shift())+I.shift(),x.U.P.curveTo(A,W,V,j,X,J,Z),x.U.P.curveTo(A,q,K,$,Y,N,H)),"o1235"==ee&&(W=N+I.shift(),V=H+I.shift(),j=W+I.shift(),X=V+I.shift(),J=j+I.shift(),Z=X+I.shift(),q=J+I.shift(),K=Z+I.shift(),$=q+I.shift(),Y=K+I.shift(),N=$+I.shift(),H=Y+I.shift(),I.shift(),x.U.P.curveTo(A,W,V,j,X,J,Z),x.U.P.curveTo(A,q,K,$,Y,N,H)),"o1236"==ee&&(W=N+I.shift(),V=H+I.shift(),j=W+I.shift(),Z=X=V+I.shift(),K=X,$=(q=(J=j+I.shift())+I.shift())+I.shift(),Y=K+I.shift(),N=$+I.shift(),x.U.P.curveTo(A,W,V,j,X,J,Z),x.U.P.curveTo(A,q,K,$,Y,N,H)),"o1237"==ee&&(W=N+I.shift(),V=H+I.shift(),j=W+I.shift(),X=V+I.shift(),J=j+I.shift(),Z=X+I.shift(),q=J+I.shift(),K=Z+I.shift(),$=q+I.shift(),Y=K+I.shift(),Math.abs($-N)>Math.abs(Y-H)?N=$+I.shift():H=Y+I.shift(),x.U.P.curveTo(A,W,V,j,X,J,Z),x.U.P.curveTo(A,q,K,$,Y,N,H));else if("o14"==ee){if(I.length>0&&!B&&(D=I.shift()+S.nominalWidthX,B=!0),4==I.length){var oe=I.shift(),ae=I.shift(),le=I.shift(),he=I.shift(),ce=x.CFF.glyphBySE(S,le),de=x.CFF.glyphBySE(S,he);x.U._drawCFF(S.CharStrings[ce],b,S,C,A),b.x=oe,b.y=ae,x.U._drawCFF(S.CharStrings[de],b,S,C,A)}F&&(x.U.P.closePath(A),F=!1)}else if("o19"==ee||"o20"==ee)I.length%2!=0&&!B&&(D=I.shift()+C.nominalWidthX),R+=I.length>>1,I.length=0,B=!0,G+=R+7>>3;else if("o21"==ee)I.length>2&&!B&&(D=I.shift()+C.nominalWidthX,B=!0),H+=I.pop(),N+=I.pop(),F&&x.U.P.closePath(A),x.U.P.moveTo(A,N,H),F=!0;else if("o22"==ee)I.length>1&&!B&&(D=I.shift()+C.nominalWidthX,B=!0),N+=I.pop(),F&&x.U.P.closePath(A),x.U.P.moveTo(A,N,H),F=!0;else if("o25"==ee){for(;I.length>6;)N+=I.shift(),H+=I.shift(),x.U.P.lineTo(A,N,H);W=N+I.shift(),V=H+I.shift(),j=W+I.shift(),X=V+I.shift(),N=j+I.shift(),H=X+I.shift(),x.U.P.curveTo(A,W,V,j,X,N,H)}else if("o26"==ee)for(I.length%2&&(N+=I.shift());I.length>0;)W=N,V=H+I.shift(),N=j=W+I.shift(),H=(X=V+I.shift())+I.shift(),x.U.P.curveTo(A,W,V,j,X,N,H);else if("o27"==ee)for(I.length%2&&(H+=I.shift());I.length>0;)V=H,j=(W=N+I.shift())+I.shift(),X=V+I.shift(),N=j+I.shift(),H=X,x.U.P.curveTo(A,W,V,j,X,N,H);else if("o10"==ee||"o29"==ee){var ue="o10"==ee?C:S;if(0==I.length)console.debug("error: empty stack");else{var pe=I.pop(),fe=ue.Subrs[pe+ue.Bias];b.x=N,b.y=H,b.nStems=R,b.haveWidth=B,b.width=D,b.open=F,x.U._drawCFF(fe,b,S,C,A),N=b.x,H=b.y,R=b.nStems,B=b.haveWidth,D=b.width,F=b.open}}else if("o30"==ee||"o31"==ee){var ge=I.length,me=(se=0,"o31"==ee);for(se+=ge-(te=-3&ge);se<te;)me?(V=H,j=(W=N+I.shift())+I.shift(),H=(X=V+I.shift())+I.shift(),te-se==5?(N=j+I.shift(),se++):N=j,me=!1):(W=N,V=H+I.shift(),j=W+I.shift(),X=V+I.shift(),N=j+I.shift(),te-se==5?(H=X+I.shift(),se++):H=X,me=!0),x.U.P.curveTo(A,W,V,j,X,N,H),se+=4}else{if("o"==(ee+"").charAt(0))throw console.debug("Unknown operation: "+ee,r),ee;I.push(ee)}}}b.x=N,b.y=H,b.nStems=R,b.haveWidth=B,b.width=D,b.open=F};var b=x,S={Typr:b};return r.Typr=b,r.default=S,Object.defineProperty(r,"__esModule",{value:!0}),r}({}).Typr}
/*!
Custom bundle of woff2otf (https://github.com/arty-name/woff2otf) with fflate
(https://github.com/101arrowz/fflate) for use in Troika text rendering. 
Original licenses apply: 
- fflate: https://github.com/101arrowz/fflate/blob/master/LICENSE (MIT)
- woff2otf.js: https://github.com/arty-name/woff2otf/blob/master/woff2otf.js (Apache2)
*/,function(){return function(r){var x=Uint8Array,b=Uint16Array,S=Uint32Array,C=new x([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),A=new x([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),I=new x([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),f=function(r,x){for(var C=new b(31),A=0;A<31;++A)C[A]=x+=1<<r[A-1];var I=new S(C[30]);for(A=1;A<30;++A)for(var R=C[A];R<C[A+1];++R)I[R]=R-C[A]<<5|A;return[C,I]},R=f(C,2),B=R[0],D=R[1];B[28]=258,D[258]=28;for(var F=f(A,0)[0],G=new b(32768),N=0;N<32768;++N){var H=(43690&N)>>>1|(21845&N)<<1;H=(61680&(H=(52428&H)>>>2|(13107&H)<<2))>>>4|(3855&H)<<4,G[N]=((65280&H)>>>8|(255&H)<<8)>>>1}var w=function(r,x,S){for(var C=r.length,A=0,I=new b(x);A<C;++A)++I[r[A]-1];var R,B=new b(x);for(A=0;A<x;++A)B[A]=B[A-1]+I[A-1]<<1;R=new b(1<<x);var D=15-x;for(A=0;A<C;++A)if(r[A])for(var F=A<<4|r[A],N=x-r[A],H=B[r[A]-1]++<<N,W=H|(1<<N)-1;H<=W;++H)R[G[H]>>>D]=F;return R},W=new x(288);for(N=0;N<144;++N)W[N]=8;for(N=144;N<256;++N)W[N]=9;for(N=256;N<280;++N)W[N]=7;for(N=280;N<288;++N)W[N]=8;var V=new x(32);for(N=0;N<32;++N)V[N]=5;var j=w(W,9),X=w(V,5),y=function(r){for(var x=r[0],b=1;b<r.length;++b)r[b]>x&&(x=r[b]);return x},L=function(r,x,b){var S=x/8|0;return(r[S]|r[S+1]<<8)>>(7&x)&b},U=function(r,x){var b=x/8|0;return(r[b]|r[b+1]<<8|r[b+2]<<16)>>(7&x)},q=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],T=function(r,x,b){var S=new Error(x||q[r]);if(S.code=r,Error.captureStackTrace&&Error.captureStackTrace(S,T),!b)throw S;return S},O=function(r,R,D){var G=r.length;if(!G||D&&!D.l&&G<5)return R||new x(0);var N=!R||D,H=!D||D.i;D||(D={}),R||(R=new x(3*G));var W,d=function(r){var b=R.length;if(r>b){var S=new x(Math.max(2*b,r));S.set(R),R=S}},V=D.f||0,q=D.p||0,K=D.b||0,$=D.l,Y=D.d,J=D.m,Z=D.n,Q=8*G;do{if(!$){D.f=V=L(r,q,1);var ee=L(r,q+1,3);if(q+=3,!ee){var te=r[(ue=((W=q)/8|0)+(7&W&&1)+4)-4]|r[ue-3]<<8,ne=ue+te;if(ne>G){H&&T(0);break}N&&d(K+te),R.set(r.subarray(ue,ne),K),D.b=K+=te,D.p=q=8*ne;continue}if(1==ee)$=j,Y=X,J=9,Z=5;else if(2==ee){var re=L(r,q,31)+257,ie=L(r,q+10,15)+4,se=re+L(r,q+5,31)+1;q+=14;for(var oe=new x(se),ae=new x(19),le=0;le<ie;++le)ae[I[le]]=L(r,q+3*le,7);q+=3*ie;var he=y(ae),ce=(1<<he)-1,de=w(ae,he);for(le=0;le<se;){var ue,pe=de[L(r,q,ce)];if(q+=15&pe,(ue=pe>>>4)<16)oe[le++]=ue;else{var fe=0,ge=0;for(16==ue?(ge=3+L(r,q,3),q+=2,fe=oe[le-1]):17==ue?(ge=3+L(r,q,7),q+=3):18==ue&&(ge=11+L(r,q,127),q+=7);ge--;)oe[le++]=fe}}var me=oe.subarray(0,re),_e=oe.subarray(re);J=y(me),Z=y(_e),$=w(me,J),Y=w(_e,Z)}else T(1);if(q>Q){H&&T(0);break}}N&&d(K+131072);for(var ye=(1<<J)-1,ve=(1<<Z)-1,xe=q;;xe=q){var be=(fe=$[U(r,q)&ye])>>>4;if((q+=15&fe)>Q){H&&T(0);break}if(fe||T(2),be<256)R[K++]=be;else{if(256==be){xe=q,$=null;break}var Te=be-254;if(be>264){var we=C[le=be-257];Te=L(r,q,(1<<we)-1)+B[le],q+=we}var Se=Y[U(r,q)&ve],Ce=Se>>>4;if(Se||T(3),q+=15&Se,_e=F[Ce],Ce>3&&(we=A[Ce],_e+=U(r,q)&(1<<we)-1,q+=we),q>Q){H&&T(0);break}N&&d(K+131072);for(var Ae=K+Te;K<Ae;K+=4)R[K]=R[K-_e],R[K+1]=R[K+1-_e],R[K+2]=R[K+2-_e],R[K+3]=R[K+3-_e];K=Ae}}D.l=$,D.p=xe,D.b=K,$&&(V=1,D.m=J,D.d=Y,D.n=Z)}while(!V);return K==R.length?R:function(r,C,A){(null==A||A>r.length)&&(A=r.length);var I=new(r instanceof b?b:r instanceof S?S:x)(A-0);return I.set(r.subarray(0,A)),I}(R,0,K)},K=new x(0),$="undefined"!=typeof TextDecoder&&new TextDecoder;try{$.decode(K,{stream:!0})}catch(r){}return r.convert_streams=function(r){var x=new DataView(r),b=0;function t(){var r=x.getUint16(b);return b+=2,r}function a(){var r=x.getUint32(b);return b+=4,r}function i(r){H.setUint16(W,r),W+=2}function o(r){H.setUint32(W,r),W+=4}for(var S={signature:a(),flavor:a(),length:a(),numTables:t(),reserved:t(),totalSfntSize:a(),majorVersion:t(),minorVersion:t(),metaOffset:a(),metaLength:a(),metaOrigLength:a(),privOffset:a(),privLength:a()},C=0;Math.pow(2,C)<=S.numTables;)C++;C--;for(var A=16*Math.pow(2,C),I=16*S.numTables-A,R=12,B=[],D=0;D<S.numTables;D++)B.push({tag:a(),offset:a(),compLength:a(),origLength:a(),origChecksum:a()}),R+=16;var F,G=new Uint8Array(12+16*B.length+B.reduce((function(r,x){return r+x.origLength+4}),0)),N=G.buffer,H=new DataView(N),W=0;return o(S.flavor),i(S.numTables),i(A),i(C),i(I),B.forEach((function(r){o(r.tag),o(r.origChecksum),o(R),o(r.origLength),r.outOffset=R,(R+=r.origLength)%4!=0&&(R+=4-R%4)})),B.forEach((function(x){var b,S=r.slice(x.offset,x.offset+x.compLength);if(x.compLength!=x.origLength){var C=new Uint8Array(x.origLength);b=new Uint8Array(S,2),O(b,C)}else C=new Uint8Array(S);G.set(C,x.outOffset);var A=0;(R=x.outOffset+x.origLength)%4!=0&&(A=4-R%4),G.set(new Uint8Array(A).buffer,x.outOffset+x.origLength),F=R+A})),N.slice(0,F)},Object.defineProperty(r,"__esModule",{value:!0}),r}({}).convert_streams},function(r,x){const b={M:2,L:2,Q:4,C:6,Z:0},S={C:"18g,ca,368,1kz",D:"17k,6,2,2+4,5+c,2+6,2+1,10+1,9+f,j+11,2+1,a,2,2+1,15+2,3,j+2,6+3,2+8,2,2,2+1,w+a,4+e,3+3,2,3+2,3+5,23+w,2f+4,3,2+9,2,b,2+3,3,1k+9,6+1,3+1,2+2,2+d,30g,p+y,1,1+1g,f+x,2,sd2+1d,jf3+4,f+3,2+4,2+2,b+3,42,2,4+2,2+1,2,3,t+1,9f+w,2,el+2,2+g,d+2,2l,2+1,5,3+1,2+1,2,3,6,16wm+1v",R:"17m+3,2,2,6+3,m,15+2,2+2,h+h,13,3+8,2,2,3+1,2,p+1,x,5+4,5,a,2,2,3,u,c+2,g+1,5,2+1,4+1,5j,6+1,2,b,2+2,f,2+1,1s+2,2,3+1,7,1ez0,2,2+1,4+4,b,4,3,b,42,2+2,4,3,2+1,2,o+3,ae,ep,x,2o+2,3+1,3,5+1,6",L:"x9u,jff,a,fd,jv",T:"4t,gj+33,7o+4,1+1,7c+18,2,2+1,2+1,2,21+a,2,1b+k,h,2u+6,3+5,3+1,2+3,y,2,v+q,2k+a,1n+8,a,p+3,2+8,2+2,2+4,18+2,3c+e,2+v,1k,2,5+7,5,4+6,b+1,u,1n,5+3,9,l+1,r,3+1,1m,5+1,5+1,3+2,4,v+1,4,c+1,1m,5+4,2+1,5,l+1,n+5,2,1n,3,2+3,9,8+1,c+1,v,1q,d,1f,4,1m+2,6+2,2+3,8+1,c+1,u,1n,3,7,6+1,l+1,t+1,1m+1,5+3,9,l+1,u,21,8+2,2,2j,3+6,d+7,2r,3+8,c+5,23+1,s,2,2,1k+d,2+4,2+1,6+a,2+z,a,2v+3,2+5,2+1,3+1,q+1,5+2,h+3,e,3+1,7,g,jk+2,qb+2,u+2,u+1,v+1,1t+1,2+6,9,3+a,a,1a+2,3c+1,z,3b+2,5+1,a,7+2,64+1,3,1n,2+6,2,2,3+7,7+9,3,1d+d,1,1+1,1s+3,1d,2+4,2,6,15+8,d+1,x+3,3+1,2+2,1l,2+1,4,2+2,1n+7,3+1,49+2,2+c,2+6,5,7,4+1,5j+1l,2+4,ek,3+1,r+4,1e+4,6+5,2p+c,1+3,1,1+2,1+b,2db+2,3y,2p+v,ff+3,30+1,n9x,1+2,2+9,x+1,29+1,7l,4,5,q+1,6,48+1,r+h,e,13+7,q+a,1b+2,1d,3+3,3+1,14,1w+5,3+1,3+1,d,9,1c,1g,2+2,3+1,6+1,2,17+1,9,6n,3,5,fn5,ki+f,h+f,5s,6y+2,ea,6b,46+4,1af+2,2+1,6+3,15+2,5,4m+1,fy+3,as+1,4a+a,4x,1j+e,1l+2,1e+3,3+1,1y+2,11+4,2+7,1r,d+1,1h+8,b+3,3,2o+2,3,2+1,7,4h,4+7,m+1,1m+1,4,12+6,4+4,5g+7,3+2,2,o,2d+5,2,5+1,2+1,6n+3,7+1,2+1,s+1,2e+7,3,2+1,2z,2,3+5,2,2u+2,3+3,2+4,78+8,2+1,75+1,2,5,41+3,3+1,5,x+9,15+5,3+3,9,a+5,3+2,1b+c,2+1,bb+6,2+5,2,2b+l,3+6,2+1,2+1,3f+5,4,2+1,2+6,2,21+1,4,2,9o+1,470+8,at4+4,1o+6,t5,1s+3,2a,f5l+1,2+3,43o+2,a+7,1+7,3+6,v+3,45+2,1j0+1i,5+1d,9,f,n+4,2+e,11t+6,2+g,3+6,2+1,2+4,7a+6,c6+3,15t+6,32+6,1,gzau,v+2n,3l+6n"},C=1,A=2,I=4,R=8,B=16,D=32;let F;function getCharJoiningType(r){if(!F){const r={R:A,L:C,D:I,C:B,U:D,T:R};F=new Map;for(let x in S){let b=0;S[x].split(",").forEach((S=>{let[C,A]=S.split("+");C=parseInt(C,36),A=A?parseInt(A,36):0,F.set(b+=C,r[x]);for(let S=A;S--;)F.set(++b,r[x])}))}}return F.get(r)||D}const G=1,N=2,H=3,W=4,V=[null,"isol","init","fina","medi"];function detectJoiningForms(r){const x=new Uint8Array(r.length);let b=D,S=G,F=-1;for(let V=0;V<r.length;V++){const j=r.codePointAt(V);let X=0|getCharJoiningType(j),q=G;X&R||(b&(C|I|B)?X&(A|I|B)?(q=H,S!==G&&S!==H||x[F]++):X&(C|D)&&(S!==N&&S!==W||x[F]--):b&(A|D)&&(S!==N&&S!==W||x[F]--),S=x[V]=q,b=X,F=V,j>65535&&V++)}return x}function getGlyphClass(x,b){const S=x.GDEF&&x.GDEF.glyphClassDef;return S?r.U._getGlyphClass(b,S):0}function firstNum(...r){for(let x=0;x<r.length;x++)if("number"==typeof r[x])return r[x]}function wrapFontObj(x){const S=Object.create(null),C=x["OS/2"],A=x.hhea,I=x.head.unitsPerEm,R=firstNum(C&&C.sTypoAscender,A&&A.ascender,I),B={unitsPerEm:I,ascender:R,descender:firstNum(C&&C.sTypoDescender,A&&A.descender,0),capHeight:firstNum(C&&C.sCapHeight,R),xHeight:firstNum(C&&C.sxHeight,R),lineGap:firstNum(C&&C.sTypoLineGap,A&&A.lineGap),supportsCodePoint:b=>r.U.codeToGlyph(x,b)>0,forEachGlyph(C,A,I,R){let D=0;const F=1/B.unitsPerEm*A,G=function(x,b){const S=[];for(let C=0;C<b.length;C++){const A=b.codePointAt(C);A>65535&&C++,S.push(r.U.codeToGlyph(x,A))}const C=x.GSUB;if(C){const{lookupList:x,featureList:A}=C;let I;const R=/^(rlig|liga|mset|isol|init|fina|medi|half|pres|blws|ccmp)$/,B=[];A.forEach((C=>{if(R.test(C.tag))for(let A=0;A<C.tab.length;A++){if(B[C.tab[A]])continue;B[C.tab[A]]=!0;const R=x[C.tab[A]],D=/^(isol|init|fina|medi)$/.test(C.tag);D&&!I&&(I=detectJoiningForms(b));for(let b=0;b<S.length;b++)I&&D&&V[I[b]]!==C.tag||r.U._applySubs(S,b,R,x)}}))}return S}(x,C);let N=0;const H=function(x,b){const S=new Int16Array(3*b.length);let C=0;for(;C<b.length;C++){const A=b[C];if(-1===A)continue;S[3*C+2]=x.hmtx.aWidth[A];const I=x.GPOS;if(I){const R=I.lookupList;for(let I=0;I<R.length;I++){const B=R[I];for(let I=0;I<B.tabs.length;I++){const R=B.tabs[I];if(1===B.ltype){if(-1!==r._lctf.coverageIndex(R.coverage,A)&&R.pos){applyValueRecord(R.pos,C);break}}else if(2===B.ltype){let x=null,S=getPrevGlyphIndex();if(-1!==S){const I=r._lctf.coverageIndex(R.coverage,b[S]);if(-1!==I){if(1===R.fmt){const r=R.pairsets[I];for(let b=0;b<r.length;b++)r[b].gid2===A&&(x=r[b])}else if(2===R.fmt){const C=r.U._getGlyphClass(b[S],R.classDef1),I=r.U._getGlyphClass(A,R.classDef2);x=R.matrix[C][I]}if(x){x.val1&&applyValueRecord(x.val1,S),x.val2&&applyValueRecord(x.val2,C);break}}}}else if(4===B.ltype){const x=r._lctf.coverageIndex(R.markCoverage,A);if(-1!==x){const A=getPrevGlyphIndex(isBaseGlyph),I=-1===A?-1:r._lctf.coverageIndex(R.baseCoverage,b[A]);if(-1!==I){const r=R.markArray[x],b=R.baseArray[I][r.markClass];S[3*C]=b.x-r.x+S[3*A]-S[3*A+2],S[3*C+1]=b.y-r.y+S[3*A+1];break}}}else if(6===B.ltype){const I=r._lctf.coverageIndex(R.mark1Coverage,A);if(-1!==I){const A=getPrevGlyphIndex();if(-1!==A){const B=b[A];if(3===getGlyphClass(x,B)){const x=r._lctf.coverageIndex(R.mark2Coverage,B);if(-1!==x){const r=R.mark1Array[I],b=R.mark2Array[x][r.markClass];S[3*C]=b.x-r.x+S[3*A]-S[3*A+2],S[3*C+1]=b.y-r.y+S[3*A+1];break}}}}}}}}else if(x.kern&&!x.cff){const r=getPrevGlyphIndex();if(-1!==r){const C=x.kern.glyph1.indexOf(b[r]);if(-1!==C){const b=x.kern.rval[C].glyph2.indexOf(A);-1!==b&&(S[3*r+2]+=x.kern.rval[C].vals[b])}}}}return S;function getPrevGlyphIndex(r){for(let x=C-1;x>=0;x--)if(-1!==b[x]&&(!r||r(b[x])))return x;return-1}function isBaseGlyph(r){return 1===getGlyphClass(x,r)}function applyValueRecord(r,x){for(let b=0;b<3;b++)S[3*x+b]+=r[b]||0}}(x,G);return G.forEach(((B,G)=>{if(-1!==B){let C=S[B];if(!C){const{cmds:A,crds:I}=r.U.glyphToPath(x,B);let R,D,F,G,N="",H=0;for(let r=0,x=A.length;r<x;r++){const x=b[A[r]];N+=A[r];for(let r=1;r<=x;r++)N+=(r>1?",":"")+I[H++]}if(I.length){R=D=1/0,F=G=-1/0;for(let r=0,x=I.length;r<x;r+=2){let x=I[r],b=I[r+1];x<R&&(R=x),b<D&&(D=b),x>F&&(F=x),b>G&&(G=b)}}else R=F=D=G=0;C=S[B]={index:B,advanceWidth:x.hmtx.aWidth[B],xMin:R,yMin:D,xMax:F,yMax:G,path:N}}R.call(null,C,D+H[3*G]*F,H[3*G+1]*F,N),D+=H[3*G+2]*F,I&&(D+=I*A)}N+=C.codePointAt(N)>65535?2:1})),D}};return B}return function(b){const S=new Uint8Array(b,0,4),C=r._bin.readASCII(S,0,4);if("wOFF"===C)b=x(b);else if("wOF2"===C)throw new Error("woff2 fonts not supported");return wrapFontObj(r.parse(b)[0])}}],init:(r,x,b)=>b(r(),x())});
/*!
Custom bundle of @unicode-font-resolver/client v1.0.2 (https://github.com/lojjic/unicode-font-resolver)
for use in Troika text rendering. 
Original MIT license applies
*/const Bi=defineWorkerModule({name:"FontResolver",dependencies:[function(r,x){const b=Object.create(null),S=Object.create(null);function loadFont(x,C){let A=b[x];A?C(A):S[x]?S[x].push(C):(S[x]=[C],function(x,b){const onError=r=>{console.error(`Failure loading font ${x}`,r)};try{const S=new XMLHttpRequest;S.open("get",x,!0),S.responseType="arraybuffer",S.onload=function(){if(S.status>=400)onError(new Error(S.statusText));else if(S.status>0)try{const C=r(S.response);C.src=x,b(C)}catch(r){onError(r)}},S.onerror=onError,S.send()}catch(r){onError(r)}}(x,(r=>{r.src=x,b[x]=r,S[x].forEach((x=>x(r))),delete S[x]})))}return function(r,S,{lang:C,fonts:A=[],style:I="normal",weight:R="normal",unicodeFontsURL:B}={}){const D=new Uint8Array(r.length),F=[];r.length||allDone();const G=new Map,N=[];if("italic"!==I&&(I="normal"),"number"!=typeof R&&(R="bold"===R?700:400),A&&!Array.isArray(A)&&(A=[A]),(A=A.slice().filter((r=>!r.lang||r.lang.test(C))).reverse()).length){const x=1,S=2;let C=0;!function resolveUserFonts(I=0){for(let R=I,B=r.length;R<B;R++){const I=r.codePointAt(R);if(C===x&&F[D[R-1]].supportsCodePoint(I)||/\s/.test(r[R]))D[R]=D[R-1],C===S&&(N[N.length-1][1]=R);else for(let r=D[R],B=A.length;r<=B;r++)if(r===B){(C===S?N[N.length-1]:N[N.length]=[R,R])[1]=R,C=S}else{D[R]=r;const{src:S,unicodeRange:B}=A[r];if(!B||isCodeInRanges(I,B)){const r=b[S];if(!r)return void loadFont(S,(()=>{resolveUserFonts(R)}));if(r.supportsCodePoint(I)){let b=G.get(r);"number"!=typeof b&&(b=F.length,F.push(r),G.set(r,b)),D[R]=b,C=x;break}}}I>65535&&R+1<B&&(D[R+1]=D[R],R++,C===S&&(N[N.length-1][1]=R))}resolveFallbacks()}()}else N.push([0,r.length-1]),resolveFallbacks();function resolveFallbacks(){if(N.length){const b=N.map((x=>r.substring(x[0],x[1]+1))).join("\n");x.getFontsForString(b,{lang:C||void 0,style:I,weight:R,dataUrl:B}).then((({fontUrls:r,chars:x})=>{const b=F.length;let S=0;N.forEach((r=>{for(let C=0,A=r[1]-r[0];C<=A;C++)D[r[0]+C]=x[S++]+b;S++}));let C=0;r.forEach(((x,S)=>{loadFont(x,(x=>{F[S+b]=x,++C===r.length&&allDone()}))}))}))}else allDone()}function allDone(){S({chars:D,fonts:F})}function isCodeInRanges(r,x){for(let b=0;b<x.length;b++){const[S,C=S]=x[b];if(S<=r&&r<=C)return!0}return!1}}},Mi,function(){return function(r){var n=function(){this.buckets=new Map};n.prototype.add=function(r){var x=r>>5;this.buckets.set(x,(this.buckets.get(x)||0)|1<<(31&r))},n.prototype.has=function(r){var x=this.buckets.get(r>>5);return void 0!==x&&0!=(x&1<<(31&r))},n.prototype.serialize=function(){var r=[];return this.buckets.forEach((function(x,b){r.push((+b).toString(36)+":"+x.toString(36))})),r.join(",")},n.prototype.deserialize=function(r){var x=this;this.buckets.clear(),r.split(",").forEach((function(r){var b=r.split(":");x.buckets.set(parseInt(b[0],36),parseInt(b[1],36))}))};var x=Math.pow(2,8),b=x-1,S=~b;function a(r){var b=function(r){return r&S}(r).toString(16),C=function(r){return(r&S)+x-1}(r).toString(16);return"codepoint-index/plane"+(r>>16)+"/"+b+"-"+C+".json"}function i(r,x){var S=r&b,C=x.codePointAt(S/6|0);return 0!=((C=(C||48)-48)&1<<S%6)}function c(r,x){!function(r,x){var b;(b=r,b.replace(/U\+/gi,"").replace(/^,+|,+$/g,"").split(/,+/).map((function(r){return r.split("-").map((function(r){return parseInt(r.trim(),16)}))}))).forEach((function(r){var b=r[0],S=r[1];void 0===S&&(S=b),x(b,S)}))}(r,(function(r,b){for(var S=r;S<=b;S++)x(S)}))}var C={},A={},I=new WeakMap,R="https://cdn.jsdelivr.net/gh/lojjic/unicode-font-resolver@v1.0.1/packages/data";function d(r){var x=I.get(r);return x||(x=new n,c(r.ranges,(function(r){return x.add(r)})),I.set(r,x)),x}var B,D=new Map;function g(r,x,b){return r[x]?x:r[b]?b:function(r){for(var x in r)return x}(r)}function w(r,x){var b=x;if(!r.includes(b)){b=1/0;for(var S=0;S<r.length;S++)Math.abs(r[S]-x)<Math.abs(b-x)&&(b=r[S])}return b}function k(r){return B||(B=new Set,c("9-D,20,85,A0,1680,2000-200A,2028-202F,205F,3000",(function(r){B.add(r)}))),B.has(r)}return r.CodePointSet=n,r.clearCache=function(){C={},A={}},r.getFontsForString=function(r,x){void 0===x&&(x={});var b,S=x.lang;void 0===S&&(S=/\p{Script=Hangul}/u.test(b=r)?"ko":/\p{Script=Hiragana}|\p{Script=Katakana}/u.test(b)?"ja":"en");var I=x.category;void 0===I&&(I="sans-serif");var B=x.style;void 0===B&&(B="normal");var F=x.weight;void 0===F&&(F=400);var G=(x.dataUrl||R).replace(/\/$/g,""),N=new Map,H=new Uint8Array(r.length),W={},V={},j=new Array(r.length),X=new Map,q=!1;function M(r){var x=D.get(r);return x||(x=fetch(G+"/"+r).then((function(r){if(!r.ok)throw new Error(r.statusText);return r.json().then((function(r){if(!Array.isArray(r)||1!==r[0])throw new Error("Incorrect schema version; need 1, got "+r[0]);return r[1]}))})).catch((function(x){if(G!==R)return q||(console.error('unicode-font-resolver: Failed loading from dataUrl "'+G+'", trying default CDN. '+x.message),q=!0),G=R,D.delete(r),M(r);throw x})),D.set(r,x)),x}for(var P=function(x){var b=r.codePointAt(x),S=a(b);j[x]=S,C[S]||X.has(S)||X.set(S,M(S).then((function(r){C[S]=r}))),b>65535&&(x++,K=x)},K=0;K<r.length;K++)P(K);return Promise.all(X.values()).then((function(){X.clear();for(var n=function(b){var I=r.codePointAt(b),R=null,B=C[j[b]],D=void 0;for(var F in B){var G=V[F];if(void 0===G&&(G=V[F]=new RegExp(F).test(S||"en")),G){for(var N in D=F,B[F])if(i(I,B[F][N])){R=N;break}break}}if(!R)e:for(var H in B)if(H!==D)for(var W in B[H])if(i(I,B[H][W])){R=W;break e}R||(console.debug("No font coverage for U+"+I.toString(16)),R="latin"),j[b]=R,A[R]||X.has(R)||X.set(R,M("font-meta/"+R+".json").then((function(r){A[R]=r}))),I>65535&&(b++,x=b)},x=0;x<r.length;x++)n(x);return Promise.all(X.values())})).then((function(){for(var x,b=null,S=0;S<r.length;S++){var C=r.codePointAt(S);if(b&&(k(C)||d(b).has(C)))H[S]=H[S-1];else{b=A[j[S]];var R=W[b.id];if(!R){var D=b.typeforms,V=g(D,I,"sans-serif"),X=g(D[V],B,"normal"),q=w(null===(x=D[V])||void 0===x?void 0:x[X],F);R=W[b.id]=G+"/font-files/"+b.id+"/"+V+"."+X+"."+q+".woff"}var K=N.get(R);null==K&&(K=N.size,N.set(R,K)),H[S]=K}C>65535&&(S++,H[S]=H[S-1])}return{fontUrls:Array.from(N.keys()),chars:H}}))},Object.defineProperty(r,"__esModule",{value:!0}),r}({})}],init:(r,x,b)=>r(x,b())});const now=()=>(self.performance||Date).now(),Pi=SDFGenerator();let Li;const Oi=[];let Di=0;function nextChunk(){const r=now();for(;Oi.length&&now()-r<5;)Oi.shift()();Di=Oi.length?setTimeout(nextChunk,0):0}const generateSDF_GL=(...r)=>new Promise(((x,b)=>{Oi.push((()=>{const S=now();try{Pi.webgl.generateIntoCanvas(...r),x({timing:now()-S})}catch(r){b(r)}})),Di||(Di=setTimeout(nextChunk,0))})),Ui=4,Fi=2e3,Gi={};let Ni=0;function generateSDF_JS_Worker(r,x,b,S,C,A,I,R,B,D){const F="TroikaTextSDFGenerator_JS_"+Ni++%Ui;let G=Gi[F];return G||(G=Gi[F]={workerModule:defineWorkerModule({name:F,workerId:F,dependencies:[SDFGenerator,now],init(r,x){const b=r().javascript.generate;return function(...r){const S=x();return{textureData:b(...r),timing:x()-S}}},getTransferables:r=>[r.textureData.buffer]}),requests:0,idleTimer:null}),G.requests++,clearTimeout(G.idleTimer),G.workerModule(r,x,b,S,C,A).then((({textureData:b,timing:S})=>{const C=now(),A=new Uint8Array(4*b.length);for(let r=0;r<b.length;r++)A[4*r+D]=b[r];return Pi.webglUtils.renderImageData(I,A,R,B,r,x,1<<3-D),S+=now()-C,0==--G.requests&&(G.idleTimer=setTimeout((()=>{!function(r){xi[r]&&xi[r].forEach((function(r){r()})),vi[r]&&(vi[r].terminate(),delete vi[r])}(F)}),Fi)),{timing:S}}))}const Hi=Pi.webglUtils.resizeWebGLCanvasWithoutClearing,Wi={defaultFontURL:null,unicodeFontsURL:null,sdfGlyphSize:64,sdfMargin:1/16,sdfExponent:9,textureWidth:2048},Vi=new be;let zi=!1;function now$1(){return(self.performance||Date).now()}const ji=Object.create(null);function getTextRenderInfo(r,x){zi=!0,r=assign({},r);const b=now$1(),{defaultFontURL:S}=Wi,C=[];if(S&&C.push({label:"default",src:toAbsoluteURL(S)}),r.font&&C.push({label:"user",src:toAbsoluteURL(r.font)}),r.font=C,r.text=""+r.text,r.sdfGlyphSize=r.sdfGlyphSize||Wi.sdfGlyphSize,r.unicodeFontsURL=r.unicodeFontsURL||Wi.unicodeFontsURL,null!=r.colorRanges){let x={};for(let b in r.colorRanges)if(r.colorRanges.hasOwnProperty(b)){let S=r.colorRanges[b];"number"!=typeof S&&(S=Vi.set(S).getHex()),x[b]=S}r.colorRanges=x}Object.freeze(r);const{textureWidth:A,sdfExponent:I}=Wi,{sdfGlyphSize:R}=r,B=A/R*4;let D=ji[R];if(!D){const r=document.createElement("canvas");r.width=A,r.height=256*R/B,D=ji[R]={glyphCount:0,sdfGlyphSize:R,sdfCanvas:r,sdfTexture:new ot(r,void 0,void 0,void 0,Le,Le),contextLost:!1,glyphsByFont:new Map},D.sdfTexture.generateMipmaps=!1,function(r){const x=r.sdfCanvas;x.addEventListener("webglcontextlost",(x=>{console.log("Context Lost",x),x.preventDefault(),r.contextLost=!0})),x.addEventListener("webglcontextrestored",(x=>{console.log("Context Restored",x),r.contextLost=!1;const b=[];r.glyphsByFont.forEach((x=>{x.forEach((x=>{b.push(generateGlyphSDF(x,r,!0))}))})),Promise.all(b).then((()=>{safariPre15Workaround(r),r.sdfTexture.needsUpdate=!0}))}))}(D)}const{sdfTexture:F,sdfCanvas:G}=D;Ki(r).then((S=>{const{glyphIds:C,glyphFontIndices:N,fontData:H,glyphPositions:W,fontSize:V,timings:j}=S,X=[],q=new Float32Array(4*C.length);let K=0,$=0;const Y=now$1(),J=H.map((r=>{let x=D.glyphsByFont.get(r.src);return x||D.glyphsByFont.set(r.src,x=new Map),x}));C.forEach(((r,x)=>{const b=N[x],{src:A,unitsPerEm:I}=H[b];let B=J[b].get(r);if(!B){const{path:x,pathBounds:C}=S.glyphData[A][r],I=Math.max(C[2]-C[0],C[3]-C[1])/R*(Wi.sdfMargin*R+.5),F=D.glyphCount++,G=[C[0]-I,C[1]-I,C[2]+I,C[3]+I];J[b].set(r,B={path:x,atlasIndex:F,sdfViewBox:G}),X.push(B)}const{sdfViewBox:F}=B,G=W[$++],j=W[$++],Y=V/I;q[K++]=G+F[0]*Y,q[K++]=j+F[1]*Y,q[K++]=G+F[2]*Y,q[K++]=j+F[3]*Y,C[x]=B.atlasIndex})),j.quads=(j.quads||0)+(now$1()-Y);const Z=now$1();j.sdf={};const Q=G.height,ee=Math.ceil(D.glyphCount/B),te=Math.pow(2,Math.ceil(Math.log2(ee*R)));te>Q&&(console.info(`Increasing SDF texture size ${Q}->${te}`),Hi(G,A,te),F.dispose()),Promise.all(X.map((x=>generateGlyphSDF(x,D,r.gpuAccelerateSDF).then((({timing:r})=>{j.sdf[x.atlasIndex]=r}))))).then((()=>{X.length&&!D.contextLost&&(safariPre15Workaround(D),F.needsUpdate=!0),j.sdfTotal=now$1()-Z,j.total=now$1()-b,x(Object.freeze({parameters:r,sdfTexture:F,sdfGlyphSize:R,sdfExponent:I,glyphBounds:q,glyphAtlasIndices:C,glyphColors:S.glyphColors,caretPositions:S.caretPositions,chunkedBounds:S.chunkedBounds,ascender:S.ascender,descender:S.descender,lineHeight:S.lineHeight,capHeight:S.capHeight,xHeight:S.xHeight,topBaseline:S.topBaseline,blockBounds:S.blockBounds,visibleBounds:S.visibleBounds,timings:S.timings}))}))})),Promise.resolve().then((()=>{var r;D.contextLost||(r=G)._warm||(Pi.webgl.isSupported(r),r._warm=!0)}))}function generateGlyphSDF({path:r,atlasIndex:x,sdfViewBox:b},{sdfGlyphSize:S,sdfCanvas:C,contextLost:A},I){if(A)return Promise.resolve({timing:-1});const{textureWidth:R,sdfExponent:B}=Wi,D=Math.max(b[2]-b[0],b[3]-b[1]),F=Math.floor(x/4);return function(r,x,b,S,C,A,I,R,B,D,F=!0){return F?generateSDF_GL(r,x,b,S,C,A,I,R,B,D).then(null,(F=>(Li||(console.warn("WebGL SDF generation failed, falling back to JS",F),Li=!0),generateSDF_JS_Worker(r,x,b,S,C,A,I,R,B,D)))):generateSDF_JS_Worker(r,x,b,S,C,A,I,R,B,D)}(S,S,r,b,D,B,C,F%(R/S)*S,Math.floor(F/(R/S))*S,x%4,I)}function assign(r,x){for(let b in x)x.hasOwnProperty(b)&&(r[b]=x[b]);return r}let Xi;function toAbsoluteURL(r){return Xi||(Xi="undefined"==typeof document?{}:document.createElement("a")),Xi.href=r,Xi.href}function safariPre15Workaround(r){if("function"!=typeof createImageBitmap){console.info("Safari<15: applying SDF canvas workaround");const{sdfCanvas:x,sdfTexture:b}=r,{width:S,height:C}=x,A=r.sdfCanvas.getContext("webgl");let I=b.image.data;I&&I.length===S*C*4||(I=new Uint8Array(S*C*4),b.image={width:S,height:C,data:I},b.flipY=!1,b.isDataTexture=!0),A.readPixels(0,0,S,C,A.RGBA,A.UNSIGNED_BYTE,I)}}const qi=defineWorkerModule({name:"Typesetter",dependencies:[function(r,x){const b=1/0,S=/[\u00AD\u034F\u061C\u115F-\u1160\u17B4-\u17B5\u180B-\u180E\u200B-\u200F\u202A-\u202E\u2060-\u206F\u3164\uFE00-\uFE0F\uFEFF\uFFA0\uFFF0-\uFFF8]/,C="[^\\S\\u00A0]",A=new RegExp(`${C}|[\\-\\u007C\\u00AD\\u2010\\u2012-\\u2014\\u2027\\u2056\\u2E17\\u2E40]`);function typeset({text:I="",font:R,lang:B,sdfGlyphSize:D=64,fontSize:F=400,fontWeight:G=1,fontStyle:N="normal",letterSpacing:H=0,lineHeight:W="normal",maxWidth:V=b,direction:j,textAlign:X="left",textIndent:q=0,whiteSpace:K="normal",overflowWrap:$="normal",anchorX:Y=0,anchorY:J=0,metricsOnly:Z=!1,unicodeFontsURL:Q,preResolvedFonts:ee=null,includeCaretPositions:te=!1,chunkedBoundsSize:ne=8192,colorRanges:re=null},ie){const se=now(),oe={fontLoad:0,typesetting:0};I.indexOf("\r")>-1&&(console.info("Typesetter: got text with \\r chars; normalizing to \\n"),I=I.replace(/\r\n/g,"\n").replace(/\r/g,"\n")),F=+F,H=+H,V=+V,W=W||"normal",q=+q,function({text:x,lang:b,fonts:S,style:C,weight:A,preResolvedFonts:I,unicodeFontsURL:R},B){const onResolved=({chars:r,fonts:x})=>{let b,S;const C=[];for(let A=0;A<r.length;A++)r[A]!==S?(S=r[A],C.push(b={start:A,end:A,fontObj:x[r[A]]})):b.end=A;B(C)};I?onResolved(I):r(x,onResolved,{lang:b,fonts:S,style:C,weight:A,unicodeFontsURL:R})}({text:I,lang:B,style:N,weight:G,fonts:"string"==typeof R?[{src:R}]:R,unicodeFontsURL:Q,preResolvedFonts:ee},(r=>{oe.fontLoad=now()-se;const R=isFinite(V);let B=null,D=null,G=null,N=null,Q=null,ee=null,ae=null,le=null,he=0,ce=0,de="nowrap"!==K;const ue=new Map,pe=now();let fe=q,ge=0,me=new TextLine;const _e=[me];r.forEach((r=>{const{fontObj:x}=r,{ascender:b,descender:B,unitsPerEm:D,lineGap:G,capHeight:N,xHeight:j}=x;let X=ue.get(x);if(!X){const r=F/D,S="normal"===W?(b-B+G)*r:W*F,C=(S-(b-B)*r)/2,A=Math.min(S,(b-B)*r),I=(b+B)/2*r+A/2;X={index:ue.size,src:x.src,fontObj:x,fontSizeMult:r,unitsPerEm:D,ascender:b*r,descender:B*r,capHeight:N*r,xHeight:j*r,lineHeight:S,baseline:-C-b*r,caretTop:I,caretBottom:I-A},ue.set(x,X)}const{fontSizeMult:K}=X,Y=I.slice(r.start,r.end+1);let J,Z;x.forEachGlyph(Y,F,H,((x,b,B,D)=>{b+=ge,D+=r.start,J=b,Z=x;const G=I.charAt(D),N=x.advanceWidth*K,W=me.count;let j;if("isEmpty"in x||(x.isWhitespace=!!G&&new RegExp(C).test(G),x.canBreakAfter=!!G&&A.test(G),x.isEmpty=x.xMin===x.xMax||x.yMin===x.yMax||S.test(G)),x.isWhitespace||x.isEmpty||ce++,de&&R&&!x.isWhitespace&&b+N+fe>V&&W){if(me.glyphAt(W-1).glyphObj.canBreakAfter)j=new TextLine,fe=-b;else for(let r=W;r--;){if(0===r&&"break-word"===$){j=new TextLine,fe=-b;break}if(me.glyphAt(r).glyphObj.canBreakAfter){j=me.splitAt(r+1);const x=j.glyphAt(0).x;fe-=x;for(let r=j.count;r--;)j.glyphAt(r).x-=x;break}}j&&(me.isSoftWrapped=!0,me=j,_e.push(me),he=V)}let Y=me.glyphAt(me.count);Y.glyphObj=x,Y.x=b+fe,Y.y=B,Y.width=N,Y.charIndex=D,Y.fontData=X,"\n"===G&&(me=new TextLine,_e.push(me),fe=-(b+N+H*F)+q)})),ge=J+Z.advanceWidth*K+H*F}));let ye=0;_e.forEach((r=>{let x=!0;for(let b=r.count;b--;){const S=r.glyphAt(b);x&&!S.glyphObj.isWhitespace&&(r.width=S.x+S.width,r.width>he&&(he=r.width),x=!1);let{lineHeight:C,capHeight:A,xHeight:I,baseline:R}=S.fontData;C>r.lineHeight&&(r.lineHeight=C);const B=R-r.baseline;B<0&&(r.baseline+=B,r.cap+=B,r.ex+=B),r.cap=Math.max(r.cap,r.baseline+A),r.ex=Math.max(r.ex,r.baseline+I)}r.baseline-=ye,r.cap-=ye,r.ex-=ye,ye+=r.lineHeight}));let ve=0,xe=0;if(Y&&("number"==typeof Y?ve=-Y:"string"==typeof Y&&(ve=-he*("left"===Y?0:"center"===Y?.5:"right"===Y?1:parsePercent(Y)))),J&&("number"==typeof J?xe=-J:"string"==typeof J&&(xe="top"===J?0:"top-baseline"===J?-_e[0].baseline:"top-cap"===J?-_e[0].cap:"top-ex"===J?-_e[0].ex:"middle"===J?ye/2:"bottom"===J?ye:"bottom-baseline"===J?-_e[_e.length-1].baseline:parsePercent(J)*ye)),!Z){const r=x.getEmbeddingLevels(I,j);B=new Uint16Array(ce),D=new Uint8Array(ce),G=new Float32Array(2*ce),N={},ae=[b,b,-b,-b],le=[],te&&(ee=new Float32Array(4*I.length)),re&&(Q=new Uint8Array(3*ce));let S,C,A=0,R=-1,F=-1;if(_e.forEach(((H,W)=>{let{count:V,width:j}=H;if(V>0){let W=0;for(let r=V;r--&&H.glyphAt(r).glyphObj.isWhitespace;)W++;let q=0,K=0;if("center"===X)q=(he-j)/2;else if("right"===X)q=he-j;else if("justify"===X&&H.isSoftWrapped){let r=0;for(let x=V-W;x--;)H.glyphAt(x).glyphObj.isWhitespace&&r++;K=(he-j)/r}if(K||q){let r=0;for(let x=0;x<V;x++){let b=H.glyphAt(x);const S=b.glyphObj;b.x+=q+r,0!==K&&S.isWhitespace&&x<V-W&&(r+=K,b.width+=K)}}const $=x.getReorderSegments(I,r,H.glyphAt(0).charIndex,H.glyphAt(H.count-1).charIndex);for(let r=0;r<$.length;r++){const[x,b]=$[r];let S=1/0,C=-1/0;for(let r=0;r<V;r++)if(H.glyphAt(r).charIndex>=x){let x=r,A=r;for(;A<V;A++){let r=H.glyphAt(A);if(r.charIndex>b)break;A<V-W&&(S=Math.min(S,r.x),C=Math.max(C,r.x+r.width))}for(let r=x;r<A;r++){const x=H.glyphAt(r);x.x=C-(x.x+x.width-S)}break}}let Y;const setGlyphObj=r=>Y=r;for(let W=0;W<V;W++){const V=H.glyphAt(W);Y=V.glyphObj;const j=Y.index,X=1&r.levels[V.charIndex];if(X){const r=x.getMirroredCharacter(I[V.charIndex]);r&&V.fontData.fontObj.forEachGlyph(r,0,0,setGlyphObj)}if(te){const{charIndex:r,fontData:x}=V,b=V.x+ve,S=V.x+V.width+ve;ee[4*r]=X?S:b,ee[4*r+1]=X?b:S,ee[4*r+2]=H.baseline+x.caretBottom+xe,ee[4*r+3]=H.baseline+x.caretTop+xe;const C=r-R;C>1&&fillLigatureCaretPositions(ee,R,C),R=r}if(re){const{charIndex:r}=V;for(;r>F;)F++,re.hasOwnProperty(F)&&(C=re[F])}if(!Y.isWhitespace&&!Y.isEmpty){const r=A++,{fontSizeMult:x,src:I,index:R}=V.fontData,F=N[I]||(N[I]={});F[j]||(F[j]={path:Y.path,pathBounds:[Y.xMin,Y.yMin,Y.xMax,Y.yMax]});const W=V.x+ve,X=V.y+H.baseline+xe;G[2*r]=W,G[2*r+1]=X;const q=W+Y.xMin*x,K=X+Y.yMin*x,$=W+Y.xMax*x,J=X+Y.yMax*x;q<ae[0]&&(ae[0]=q),K<ae[1]&&(ae[1]=K),$>ae[2]&&(ae[2]=$),J>ae[3]&&(ae[3]=J),r%ne==0&&(S={start:r,end:r,rect:[b,b,-b,-b]},le.push(S)),S.end++;const Z=S.rect;if(q<Z[0]&&(Z[0]=q),K<Z[1]&&(Z[1]=K),$>Z[2]&&(Z[2]=$),J>Z[3]&&(Z[3]=J),B[r]=j,D[r]=R,re){const x=3*r;Q[x]=C>>16&255,Q[x+1]=C>>8&255,Q[x+2]=255&C}}}}})),ee){const r=I.length-R;r>1&&fillLigatureCaretPositions(ee,R,r)}}const be=[];ue.forEach((({index:r,src:x,unitsPerEm:b,ascender:S,descender:C,lineHeight:A,capHeight:I,xHeight:R})=>{be[r]={src:x,unitsPerEm:b,ascender:S,descender:C,lineHeight:A,capHeight:I,xHeight:R}})),oe.typesetting=now()-pe,ie({glyphIds:B,glyphFontIndices:D,glyphPositions:G,glyphData:N,fontData:be,caretPositions:ee,glyphColors:Q,chunkedBounds:le,fontSize:F,topBaseline:xe+_e[0].baseline,blockBounds:[ve,xe-ye,ve+he,xe],visibleBounds:ae,timings:oe})}))}function parsePercent(r){let x=r.match(/^([\d.]+)%$/),b=x?parseFloat(x[1]):NaN;return isNaN(b)?0:b/100}function fillLigatureCaretPositions(r,x,b){const S=r[4*x],C=r[4*x+1],A=r[4*x+2],I=r[4*x+3],R=(C-S)/b;for(let C=0;C<b;C++){const b=4*(x+C);r[b]=S+R*C,r[b+1]=S+R*(C+1),r[b+2]=A,r[b+3]=I}}function now(){return(self.performance||Date).now()}function TextLine(){this.data=[]}const I=["glyphObj","x","y","width","charIndex","fontData"];return TextLine.prototype={width:0,lineHeight:0,baseline:0,cap:0,ex:0,isSoftWrapped:!1,get count(){return Math.ceil(this.data.length/I.length)},glyphAt(r){let x=TextLine.flyweight;return x.data=this.data,x.index=r,x},splitAt(r){let x=new TextLine;return x.data=this.data.splice(r*I.length),x}},TextLine.flyweight=I.reduce(((r,x,b,S)=>(Object.defineProperty(r,x,{get(){return this.data[this.index*I.length+b]},set(r){this.data[this.index*I.length+b]=r}}),r)),{data:null,index:0}),{typeset:typeset,measure:function(r,x){typeset({...r,metricsOnly:!0},(r=>{const[b,S,C,A]=r.blockBounds;x({width:C-b,height:A-S})}))}}},Bi,function(){var r=function(r){var x={R:"13k,1a,2,3,3,2+1j,ch+16,a+1,5+2,2+n,5,a,4,6+16,4+3,h+1b,4mo,179q,2+9,2+11,2i9+7y,2+68,4,3+4,5+13,4+3,2+4k,3+29,8+cf,1t+7z,w+17,3+3m,1t+3z,16o1+5r,8+30,8+mc,29+1r,29+4v,75+73",EN:"1c+9,3d+1,6,187+9,513,4+5,7+9,sf+j,175h+9,qw+q,161f+1d,4xt+a,25i+9",ES:"17,2,6dp+1,f+1,av,16vr,mx+1,4o,2",ET:"z+2,3h+3,b+1,ym,3e+1,2o,p4+1,8,6u,7c,g6,1wc,1n9+4,30+1b,2n,6d,qhx+1,h0m,a+1,49+2,63+1,4+1,6bb+3,12jj",AN:"16o+5,2j+9,2+1,35,ed,1ff2+9,87+u",CS:"18,2+1,b,2u,12k,55v,l,17v0,2,3,53,2+1,b",B:"a,3,f+2,2v,690",S:"9,2,k",WS:"c,k,4f4,1vk+a,u,1j,335",ON:"x+1,4+4,h+5,r+5,r+3,z,5+3,2+1,2+1,5,2+2,3+4,o,w,ci+1,8+d,3+d,6+8,2+g,39+1,9,6+1,2,33,b8,3+1,3c+1,7+1,5r,b,7h+3,sa+5,2,3i+6,jg+3,ur+9,2v,ij+1,9g+9,7+a,8m,4+1,49+x,14u,2+2,c+2,e+2,e+2,e+1,i+n,e+e,2+p,u+2,e+2,36+1,2+3,2+1,b,2+2,6+5,2,2,2,h+1,5+4,6+3,3+f,16+2,5+3l,3+81,1y+p,2+40,q+a,m+13,2r+ch,2+9e,75+hf,3+v,2+2w,6e+5,f+6,75+2a,1a+p,2+2g,d+5x,r+b,6+3,4+o,g,6+1,6+2,2k+1,4,2j,5h+z,1m+1,1e+f,t+2,1f+e,d+3,4o+3,2s+1,w,535+1r,h3l+1i,93+2,2s,b+1,3l+x,2v,4g+3,21+3,kz+1,g5v+1,5a,j+9,n+v,2,3,2+8,2+1,3+2,2,3,46+1,4+4,h+5,r+5,r+a,3h+2,4+6,b+4,78,1r+24,4+c,4,1hb,ey+6,103+j,16j+c,1ux+7,5+g,fsh,jdq+1t,4,57+2e,p1,1m,1m,1m,1m,4kt+1,7j+17,5+2r,d+e,3+e,2+e,2+10,m+4,w,1n+5,1q,4z+5,4b+rb,9+c,4+c,4+37,d+2g,8+b,l+b,5+1j,9+9,7+13,9+t,3+1,27+3c,2+29,2+3q,d+d,3+4,4+2,6+6,a+o,8+6,a+2,e+6,16+42,2+1i",BN:"0+8,6+d,2s+5,2+p,e,4m9,1kt+2,2b+5,5+5,17q9+v,7k,6p+8,6+1,119d+3,440+7,96s+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+1,1ekf+75,6p+2rz,1ben+1,1ekf+1,1ekf+1",NSM:"lc+33,7o+6,7c+18,2,2+1,2+1,2,21+a,1d+k,h,2u+6,3+5,3+1,2+3,10,v+q,2k+a,1n+8,a,p+3,2+8,2+2,2+4,18+2,3c+e,2+v,1k,2,5+7,5,4+6,b+1,u,1n,5+3,9,l+1,r,3+1,1m,5+1,5+1,3+2,4,v+1,4,c+1,1m,5+4,2+1,5,l+1,n+5,2,1n,3,2+3,9,8+1,c+1,v,1q,d,1f,4,1m+2,6+2,2+3,8+1,c+1,u,1n,g+1,l+1,t+1,1m+1,5+3,9,l+1,u,21,8+2,2,2j,3+6,d+7,2r,3+8,c+5,23+1,s,2,2,1k+d,2+4,2+1,6+a,2+z,a,2v+3,2+5,2+1,3+1,q+1,5+2,h+3,e,3+1,7,g,jk+2,qb+2,u+2,u+1,v+1,1t+1,2+6,9,3+a,a,1a+2,3c+1,z,3b+2,5+1,a,7+2,64+1,3,1n,2+6,2,2,3+7,7+9,3,1d+g,1s+3,1d,2+4,2,6,15+8,d+1,x+3,3+1,2+2,1l,2+1,4,2+2,1n+7,3+1,49+2,2+c,2+6,5,7,4+1,5j+1l,2+4,k1+w,2db+2,3y,2p+v,ff+3,30+1,n9x+3,2+9,x+1,29+1,7l,4,5,q+1,6,48+1,r+h,e,13+7,q+a,1b+2,1d,3+3,3+1,14,1w+5,3+1,3+1,d,9,1c,1g,2+2,3+1,6+1,2,17+1,9,6n,3,5,fn5,ki+f,h+f,r2,6b,46+4,1af+2,2+1,6+3,15+2,5,4m+1,fy+3,as+1,4a+a,4x,1j+e,1l+2,1e+3,3+1,1y+2,11+4,2+7,1r,d+1,1h+8,b+3,3,2o+2,3,2+1,7,4h,4+7,m+1,1m+1,4,12+6,4+4,5g+7,3+2,2,o,2d+5,2,5+1,2+1,6n+3,7+1,2+1,s+1,2e+7,3,2+1,2z,2,3+5,2,2u+2,3+3,2+4,78+8,2+1,75+1,2,5,41+3,3+1,5,x+5,3+1,15+5,3+3,9,a+5,3+2,1b+c,2+1,bb+6,2+5,2d+l,3+6,2+1,2+1,3f+5,4,2+1,2+6,2,21+1,4,2,9o+1,f0c+4,1o+6,t5,1s+3,2a,f5l+1,43t+2,i+7,3+6,v+3,45+2,1j0+1i,5+1d,9,f,n+4,2+e,11t+6,2+g,3+6,2+1,2+4,7a+6,c6+3,15t+6,32+6,gzhy+6n",AL:"16w,3,2,e+1b,z+2,2+2s,g+1,8+1,b+m,2+t,s+2i,c+e,4h+f,1d+1e,1bwe+dp,3+3z,x+c,2+1,35+3y,2rm+z,5+7,b+5,dt+l,c+u,17nl+27,1t+27,4x+6n,3+d",LRO:"6ct",RLO:"6cu",LRE:"6cq",RLE:"6cr",PDF:"6cs",LRI:"6ee",RLI:"6ef",FSI:"6eg",PDI:"6eh"},b={},S={};b.L=1,S[1]="L",Object.keys(x).forEach((function(r,x){b[r]=1<<x+1,S[b[r]]=r})),Object.freeze(b);var C=b.LRI|b.RLI|b.FSI,A=b.L|b.R|b.AL,I=b.B|b.S|b.WS|b.ON|b.FSI|b.LRI|b.RLI|b.PDI,R=b.BN|b.RLE|b.LRE|b.RLO|b.LRO|b.PDF,B=b.S|b.WS|b.B|C|b.PDI|R,D=null;function getBidiCharType(r){return function(){if(!D){D=new Map;var loop=function(r){if(x.hasOwnProperty(r)){var S=0;x[r].split(",").forEach((function(x){var C=x.split("+"),A=C[0],I=C[1];A=parseInt(A,36),I=I?parseInt(I,36):0,D.set(S+=A,b[r]);for(var R=0;R<I;R++)D.set(++S,b[r])}))}};for(var r in x)loop(r)}}(),D.get(r.codePointAt(0))||b.L}var F,G,N,H={pairs:"14>1,1e>2,u>2,2wt>1,1>1,1ge>1,1wp>1,1j>1,f>1,hm>1,1>1,u>1,u6>1,1>1,+5,28>1,w>1,1>1,+3,b8>1,1>1,+3,1>3,-1>-1,3>1,1>1,+2,1s>1,1>1,x>1,th>1,1>1,+2,db>1,1>1,+3,3>1,1>1,+2,14qm>1,1>1,+1,4q>1,1e>2,u>2,2>1,+1",canonical:"6f1>-6dx,6dy>-6dx,6ec>-6ed,6ee>-6ed,6ww>2jj,-2ji>2jj,14r4>-1e7l,1e7m>-1e7l,1e7m>-1e5c,1e5d>-1e5b,1e5c>-14qx,14qy>-14qx,14vn>-1ecg,1ech>-1ecg,1edu>-1ecg,1eci>-1ecg,1eda>-1ecg,1eci>-1ecg,1eci>-168q,168r>-168q,168s>-14ye,14yf>-14ye"};function parseCharacterMap(r,x){var b,S=0,C=new Map,A=x&&new Map;return r.split(",").forEach((function visit(r){if(-1!==r.indexOf("+"))for(var I=+r;I--;)visit(b);else{b=r;var R=r.split(">"),B=R[0],D=R[1];B=String.fromCodePoint(S+=parseInt(B,36)),D=String.fromCodePoint(S+=parseInt(D,36)),C.set(B,D),x&&A.set(D,B)}})),{map:C,reverseMap:A}}function parse$1(){if(!F){var r=parseCharacterMap(H.pairs,!0),x=r.map,b=r.reverseMap;F=x,G=b,N=parseCharacterMap(H.canonical,!1).map}}function openingToClosingBracket(r){return parse$1(),F.get(r)||null}function closingToOpeningBracket(r){return parse$1(),G.get(r)||null}function getCanonicalBracket(r){return parse$1(),N.get(r)||null}var W=b.L,V=b.R,j=b.EN,X=b.ES,q=b.ET,K=b.AN,$=b.CS,Y=b.B,J=b.S,Z=b.ON,Q=b.BN,ee=b.NSM,te=b.AL,ne=b.LRO,re=b.RLO,ie=b.LRE,se=b.RLE,oe=b.PDF,ae=b.LRI,le=b.RLI,he=b.FSI,ce=b.PDI;var de,ue="14>1,j>2,t>2,u>2,1a>g,2v3>1,1>1,1ge>1,1wd>1,b>1,1j>1,f>1,ai>3,-2>3,+1,8>1k0,-1jq>1y7,-1y6>1hf,-1he>1h6,-1h5>1ha,-1h8>1qi,-1pu>1,6>3u,-3s>7,6>1,1>1,f>1,1>1,+2,3>1,1>1,+13,4>1,1>1,6>1eo,-1ee>1,3>1mg,-1me>1mk,-1mj>1mi,-1mg>1mi,-1md>1,1>1,+2,1>10k,-103>1,1>1,4>1,5>1,1>1,+10,3>1,1>8,-7>8,+1,-6>7,+1,a>1,1>1,u>1,u6>1,1>1,+5,26>1,1>1,2>1,2>2,8>1,7>1,4>1,1>1,+5,b8>1,1>1,+3,1>3,-2>1,2>1,1>1,+2,c>1,3>1,1>1,+2,h>1,3>1,a>1,1>1,2>1,3>1,1>1,d>1,f>1,3>1,1a>1,1>1,6>1,7>1,13>1,k>1,1>1,+19,4>1,1>1,+2,2>1,1>1,+18,m>1,a>1,1>1,lk>1,1>1,4>1,2>1,f>1,3>1,1>1,+3,db>1,1>1,+3,3>1,1>1,+2,14qm>1,1>1,+1,6>1,4j>1,j>2,t>2,u>2,2>1,+1";function getMirroredCharacter(r){return function(){if(!de){var r=parseCharacterMap(ue,!0),x=r.map;r.reverseMap.forEach((function(r,b){x.set(b,r)})),de=x}}(),de.get(r)||null}function getReorderSegments(r,x,b,S){var C=r.length;b=Math.max(0,null==b?0:+b),S=Math.min(C-1,null==S?C-1:+S);var A=[];return x.paragraphs.forEach((function(C){var I=Math.max(b,C.start),R=Math.min(S,C.end);if(I<R){for(var D=x.levels.slice(I,R+1),F=R;F>=I&&getBidiCharType(r[F])&B;F--)D[F]=C.level;for(var G=C.level,N=1/0,H=0;H<D.length;H++){var W=D[H];W>G&&(G=W),W<N&&(N=1|W)}for(var V=G;V>=N;V--)for(var j=0;j<D.length;j++)if(D[j]>=V){for(var X=j;j+1<D.length&&D[j+1]>=V;)j++;j>X&&A.push([X+I,j+I])}}})),A}function getReorderedIndices(r,x,b,S){for(var C=getReorderSegments(r,x,b,S),A=[],I=0;I<r.length;I++)A[I]=I;return C.forEach((function(r){for(var x=r[0],b=r[1],S=A.slice(x,b+1),C=S.length;C--;)A[b-C]=S[C]})),A}return r.closingToOpeningBracket=closingToOpeningBracket,r.getBidiCharType=getBidiCharType,r.getBidiCharTypeName=function(r){return S[getBidiCharType(r)]},r.getCanonicalBracket=getCanonicalBracket,r.getEmbeddingLevels=function(r,x){for(var b=new Uint32Array(r.length),S=0;S<r.length;S++)b[S]=getBidiCharType(r[S]);var D=new Map;function changeCharType(r,x){var S=b[r];b[r]=x,D.set(S,D.get(S)-1),S&I&&D.set(I,D.get(I)-1),D.set(x,(D.get(x)||0)+1),x&I&&D.set(I,(D.get(I)||0)+1)}for(var F=new Uint8Array(r.length),G=new Map,N=[],H=null,de=0;de<r.length;de++)H||N.push(H={start:de,end:r.length-1,level:"rtl"===x?1:"ltr"===x?0:determineAutoEmbedLevel(de,!1)}),b[de]&Y&&(H.end=de,H=null);for(var ue=se|ie|re|ne|C|ce|oe|Y,nextEven=function(r){return r+(1&r?1:2)},nextOdd=function(r){return r+(1&r?2:1)},pe=0;pe<N.length;pe++){var fe=[{_level:(H=N[pe]).level,_override:0,_isolate:0}],ge=void 0,me=0,_e=0,ye=0;D.clear();for(var ve=H.start;ve<=H.end;ve++){var xe=b[ve];if(ge=fe[fe.length-1],D.set(xe,(D.get(xe)||0)+1),xe&I&&D.set(I,(D.get(I)||0)+1),xe&ue)if(xe&(se|ie)){F[ve]=ge._level;var be=(xe===se?nextOdd:nextEven)(ge._level);be<=125&&!me&&!_e?fe.push({_level:be,_override:0,_isolate:0}):me||_e++}else if(xe&(re|ne)){F[ve]=ge._level;var Te=(xe===re?nextOdd:nextEven)(ge._level);Te<=125&&!me&&!_e?fe.push({_level:Te,_override:xe&re?V:W,_isolate:0}):me||_e++}else if(xe&C){xe&he&&(xe=1===determineAutoEmbedLevel(ve+1,!0)?le:ae),F[ve]=ge._level,ge._override&&changeCharType(ve,ge._override);var we=(xe===le?nextOdd:nextEven)(ge._level);we<=125&&0===me&&0===_e?(ye++,fe.push({_level:we,_override:0,_isolate:1,_isolInitIndex:ve})):me++}else if(xe&ce){if(me>0)me--;else if(ye>0){for(_e=0;!fe[fe.length-1]._isolate;)fe.pop();var Se=fe[fe.length-1]._isolInitIndex;null!=Se&&(G.set(Se,ve),G.set(ve,Se)),fe.pop(),ye--}ge=fe[fe.length-1],F[ve]=ge._level,ge._override&&changeCharType(ve,ge._override)}else xe&oe?(0===me&&(_e>0?_e--:!ge._isolate&&fe.length>1&&(fe.pop(),ge=fe[fe.length-1])),F[ve]=ge._level):xe&Y&&(F[ve]=H.level);else F[ve]=ge._level,ge._override&&xe!==Q&&changeCharType(ve,ge._override)}for(var Ce=[],Ae=null,Ie=H.start;Ie<=H.end;Ie++){var ke=b[Ie];if(!(ke&R)){var Ee=F[Ie],Re=ke&C,Me=ke===ce;Ae&&Ee===Ae._level?(Ae._end=Ie,Ae._endsWithIsolInit=Re):Ce.push(Ae={_start:Ie,_end:Ie,_level:Ee,_startsWithPDI:Me,_endsWithIsolInit:Re})}}for(var Be=[],Pe=0;Pe<Ce.length;Pe++){var Le=Ce[Pe];if(!Le._startsWithPDI||Le._startsWithPDI&&!G.has(Le._start)){for(var Oe=[Ae=Le],De=void 0;Ae&&Ae._endsWithIsolInit&&null!=(De=G.get(Ae._end));)for(var Ue=Pe+1;Ue<Ce.length;Ue++)if(Ce[Ue]._start===De){Oe.push(Ae=Ce[Ue]);break}for(var Fe=[],Ge=0;Ge<Oe.length;Ge++)for(var Ne=Oe[Ge],He=Ne._start;He<=Ne._end;He++)Fe.push(He);for(var We=F[Fe[0]],Ve=H.level,ze=Fe[0]-1;ze>=0;ze--)if(!(b[ze]&R)){Ve=F[ze];break}var je=Fe[Fe.length-1],Xe=F[je],qe=H.level;if(!(b[je]&C))for(var Ke=je+1;Ke<=H.end;Ke++)if(!(b[Ke]&R)){qe=F[Ke];break}Be.push({_seqIndices:Fe,_sosType:Math.max(Ve,We)%2?V:W,_eosType:Math.max(qe,Xe)%2?V:W})}}for(var $e=0;$e<Be.length;$e++){var Ye=Be[$e],Je=Ye._seqIndices,Ze=Ye._sosType,Qe=Ye._eosType,et=1&F[Je[0]]?V:W;if(D.get(ee))for(var tt=0;tt<Je.length;tt++){var nt=Je[tt];if(b[nt]&ee){for(var rt=Ze,it=tt-1;it>=0;it--)if(!(b[Je[it]]&R)){rt=b[Je[it]];break}changeCharType(nt,rt&(C|ce)?Z:rt)}}if(D.get(j))for(var st=0;st<Je.length;st++){var ot=Je[st];if(b[ot]&j)for(var at=st-1;at>=-1;at--){var lt=-1===at?Ze:b[Je[at]];if(lt&A){lt===te&&changeCharType(ot,K);break}}}if(D.get(te))for(var ht=0;ht<Je.length;ht++){var ct=Je[ht];b[ct]&te&&changeCharType(ct,V)}if(D.get(X)||D.get($))for(var dt=1;dt<Je.length-1;dt++){var ut=Je[dt];if(b[ut]&(X|$)){for(var pt=0,ft=0,gt=dt-1;gt>=0&&(pt=b[Je[gt]])&R;gt--);for(var mt=dt+1;mt<Je.length&&(ft=b[Je[mt]])&R;mt++);pt===ft&&(b[ut]===X?pt===j:pt&(j|K))&&changeCharType(ut,pt)}}if(D.get(j))for(var _t=0;_t<Je.length;_t++){var yt=Je[_t];if(b[yt]&j){for(var vt=_t-1;vt>=0&&b[Je[vt]]&(q|R);vt--)changeCharType(Je[vt],j);for(_t++;_t<Je.length&&b[Je[_t]]&(q|R|j);_t++)b[Je[_t]]!==j&&changeCharType(Je[_t],j)}}if(D.get(q)||D.get(X)||D.get($))for(var xt=0;xt<Je.length;xt++){var bt=Je[xt];if(b[bt]&(q|X|$)){changeCharType(bt,Z);for(var Tt=xt-1;Tt>=0&&b[Je[Tt]]&R;Tt--)changeCharType(Je[Tt],Z);for(var wt=xt+1;wt<Je.length&&b[Je[wt]]&R;wt++)changeCharType(Je[wt],Z)}}if(D.get(j))for(var St=0,Ct=Ze;St<Je.length;St++){var At=Je[St],It=b[At];It&j?Ct===W&&changeCharType(At,W):It&A&&(Ct=It)}if(D.get(I)){for(var kt=V|j|K,Et=kt|W,Rt=[],Mt=[],Bt=0;Bt<Je.length;Bt++)if(b[Je[Bt]]&I){var Pt=r[Je[Bt]],Lt=void 0;if(null!==openingToClosingBracket(Pt)){if(!(Mt.length<63))break;Mt.push({char:Pt,seqIndex:Bt})}else if(null!==(Lt=closingToOpeningBracket(Pt)))for(var Ot=Mt.length-1;Ot>=0;Ot--){var Dt=Mt[Ot].char;if(Dt===Lt||Dt===closingToOpeningBracket(getCanonicalBracket(Pt))||openingToClosingBracket(getCanonicalBracket(Dt))===Pt){Rt.push([Mt[Ot].seqIndex,Bt]),Mt.length=Ot;break}}}Rt.sort((function(r,x){return r[0]-x[0]}));for(var Ut=0;Ut<Rt.length;Ut++){for(var Ft=Rt[Ut],Gt=Ft[0],Nt=Ft[1],Ht=!1,Wt=0,Vt=Gt+1;Vt<Nt;Vt++){var zt=Je[Vt];if(b[zt]&Et){Ht=!0;var jt=b[zt]&kt?V:W;if(jt===et){Wt=jt;break}}}if(Ht&&!Wt){Wt=Ze;for(var Xt=Gt-1;Xt>=0;Xt--){var qt=Je[Xt];if(b[qt]&Et){var Kt=b[qt]&kt?V:W;Wt=Kt!==et?Kt:et;break}}}if(Wt){if(b[Je[Gt]]=b[Je[Nt]]=Wt,Wt!==et)for(var $t=Gt+1;$t<Je.length;$t++)if(!(b[Je[$t]]&R)){getBidiCharType(r[Je[$t]])&ee&&(b[Je[$t]]=Wt);break}if(Wt!==et)for(var Yt=Nt+1;Yt<Je.length;Yt++)if(!(b[Je[Yt]]&R)){getBidiCharType(r[Je[Yt]])&ee&&(b[Je[Yt]]=Wt);break}}}for(var Jt=0;Jt<Je.length;Jt++)if(b[Je[Jt]]&I){for(var Zt=Jt,Qt=Jt,en=Ze,tn=Jt-1;tn>=0;tn--){if(!(b[Je[tn]]&R)){en=b[Je[tn]]&kt?V:W;break}Zt=tn}for(var nn=Qe,rn=Jt+1;rn<Je.length;rn++){if(!(b[Je[rn]]&(I|R))){nn=b[Je[rn]]&kt?V:W;break}Qt=rn}for(var sn=Zt;sn<=Qt;sn++)b[Je[sn]]=en===nn?en:et;Jt=Qt}}}for(var on=H.start;on<=H.end;on++){var an=F[on],ln=b[on];if(1&an?ln&(W|j|K)&&F[on]++:ln&V?F[on]++:ln&(K|j)&&(F[on]+=2),ln&R&&(F[on]=0===on?H.level:F[on-1]),on===H.end||getBidiCharType(r[on])&(J|Y))for(var hn=on;hn>=0&&getBidiCharType(r[hn])&B;hn--)F[hn]=H.level}}return{levels:F,paragraphs:N};function determineAutoEmbedLevel(x,S){for(var A=x;A<r.length;A++){var I=b[A];if(I&(V|te))return 1;if(I&(Y|W)||S&&I===ce)return 0;if(I&C){var R=indexOfMatchingPDI(A);A=-1===R?r.length:R}}return 0}function indexOfMatchingPDI(x){for(var S=1,A=x+1;A<r.length;A++){var I=b[A];if(I&Y)break;if(I&ce){if(0==--S)return A}else I&C&&S++}return-1}},r.getMirroredCharacter=getMirroredCharacter,r.getMirroredCharactersMap=function(r,x,b,S){var C=r.length;b=Math.max(0,null==b?0:+b),S=Math.min(C-1,null==S?C-1:+S);for(var A=new Map,I=b;I<=S;I++)if(1&x[I]){var R=getMirroredCharacter(r[I]);null!==R&&A.set(I,R)}return A},r.getReorderSegments=getReorderSegments,r.getReorderedIndices=getReorderedIndices,r.getReorderedString=function(r,x,b,S){var C=getReorderedIndices(r,x,b,S),A=[].concat(r);return C.forEach((function(b,S){A[S]=(1&x.levels[b]?getMirroredCharacter(r[b]):null)||r[b]})),A.join("")},r.openingToClosingBracket=openingToClosingBracket,Object.defineProperty(r,"__esModule",{value:!0}),r}({});return r}],init:(r,x,b)=>r(x,b())}),Ki=defineWorkerModule({name:"Typesetter",dependencies:[qi],init:r=>function(x){return new Promise((b=>{r.typeset(x,b)}))},getTransferables(r){const x=[];for(let b in r)r[b]&&r[b].buffer&&x.push(r[b].buffer);return x}});const $i={};const Yi="aTroikaGlyphIndex";class GlyphsGeometry extends _t{constructor(){super(),this.detail=1,this.curveRadius=0,this.groups=[{start:0,count:1/0,materialIndex:0},{start:0,count:1/0,materialIndex:1}],this.boundingSphere=new D,this.boundingBox=new A}computeBoundingSphere(){}computeBoundingBox(){}setSide(r){const x=this.getIndex().count;this.setDrawRange(r===ue?x/2:0,r===pe?x:x/2)}set detail(r){if(r!==this._detail){this._detail=r,("number"!=typeof r||r<1)&&(r=1);let x=function(r){let x=$i[r];if(!x){const b=new yt(1,1,r,r),S=b.clone(),C=b.attributes,A=S.attributes,I=new Z,R=C.uv.count;for(let r=0;r<R;r++)A.position.array[3*r]*=-1,A.normal.array[3*r+2]*=-1;["position","normal","uv"].forEach((r=>{I.setAttribute(r,new vt([...C[r].array,...A[r].array],C[r].itemSize))})),I.setIndex([...b.index.array,...S.index.array.map((r=>r+R))]),I.translate(.5,.5,0),x=$i[r]=I}return x}(r);["position","normal","uv"].forEach((r=>{this.attributes[r]=x.attributes[r].clone()})),this.setIndex(x.getIndex().clone())}}get detail(){return this._detail}set curveRadius(r){r!==this._curveRadius&&(this._curveRadius=r,this._updateBounds())}get curveRadius(){return this._curveRadius}updateGlyphs(r,x,b,S,C){updateBufferAttr(this,"aTroikaGlyphBounds",r,4),updateBufferAttr(this,Yi,x,1),updateBufferAttr(this,"aTroikaGlyphColor",C,3),this._blockBounds=b,this._chunkedBounds=S,this.instanceCount=x.length,this._updateBounds()}_updateBounds(){const r=this._blockBounds;if(r){const{curveRadius:x,boundingBox:b}=this;if(x){const{PI:S,floor:C,min:A,max:I,sin:R,cos:B}=Math,D=S/2,F=2*S,G=Math.abs(x),N=r[0]/G,H=r[2]/G,W=C((N+D)/F)!==C((H+D)/F)?-G:A(R(N)*G,R(H)*G),V=C((N-D)/F)!==C((H-D)/F)?G:I(R(N)*G,R(H)*G),j=C((N+S)/F)!==C((H+S)/F)?2*G:I(G-B(N)*G,G-B(H)*G);b.min.set(W,r[1],x<0?-j:0),b.max.set(V,r[3],x<0?0:j)}else b.min.set(r[0],r[1],0),b.max.set(r[2],r[3],0);b.getBoundingSphere(this.boundingSphere)}}applyClipRect(r){let x=this.getAttribute(Yi).count,b=this._chunkedBounds;if(b)for(let S=b.length;S--;){x=b[S].end;let C=b[S].rect;if(C[1]<r.w&&C[3]>r.y&&C[0]<r.z&&C[2]>r.x)break}this.instanceCount=x}}function updateBufferAttr(r,x,b,S){const C=r.getAttribute(x);b?C&&C.array.length===b.length?(C.array.set(b),C.needsUpdate=!0):(r.setAttribute(x,new Ee(b,S)),delete r._maxInstanceCount,r.dispose()):C&&r.deleteAttribute(x)}function createTextDerivedMaterial(r){const x=createDerivedMaterial(r,{chained:!0,extensions:{derivatives:!0},uniforms:{uTroikaSDFTexture:{value:null},uTroikaSDFTextureSize:{value:new b},uTroikaSDFGlyphSize:{value:0},uTroikaSDFExponent:{value:0},uTroikaTotalBounds:{value:new le(0,0,0,0)},uTroikaClipRect:{value:new le(0,0,0,0)},uTroikaDistanceOffset:{value:0},uTroikaOutlineOpacity:{value:0},uTroikaFillOpacity:{value:1},uTroikaPositionOffset:{value:new b},uTroikaCurveRadius:{value:0},uTroikaBlurRadius:{value:0},uTroikaStrokeWidth:{value:0},uTroikaStrokeColor:{value:new be},uTroikaStrokeOpacity:{value:1},uTroikaOrient:{value:new Q},uTroikaUseGlyphColors:{value:!0},uTroikaSDFDebug:{value:!1}},vertexDefs:"\nuniform vec2 uTroikaSDFTextureSize;\nuniform float uTroikaSDFGlyphSize;\nuniform vec4 uTroikaTotalBounds;\nuniform vec4 uTroikaClipRect;\nuniform mat3 uTroikaOrient;\nuniform bool uTroikaUseGlyphColors;\nuniform float uTroikaDistanceOffset;\nuniform float uTroikaBlurRadius;\nuniform vec2 uTroikaPositionOffset;\nuniform float uTroikaCurveRadius;\nattribute vec4 aTroikaGlyphBounds;\nattribute float aTroikaGlyphIndex;\nattribute vec3 aTroikaGlyphColor;\nvarying vec2 vTroikaGlyphUV;\nvarying vec4 vTroikaTextureUVBounds;\nvarying float vTroikaTextureChannel;\nvarying vec3 vTroikaGlyphColor;\nvarying vec2 vTroikaGlyphDimensions;\n",vertexTransform:"\nvec4 bounds = aTroikaGlyphBounds;\nbounds.xz += uTroikaPositionOffset.x;\nbounds.yw -= uTroikaPositionOffset.y;\n\nvec4 outlineBounds = vec4(\n  bounds.xy - uTroikaDistanceOffset - uTroikaBlurRadius,\n  bounds.zw + uTroikaDistanceOffset + uTroikaBlurRadius\n);\nvec4 clippedBounds = vec4(\n  clamp(outlineBounds.xy, uTroikaClipRect.xy, uTroikaClipRect.zw),\n  clamp(outlineBounds.zw, uTroikaClipRect.xy, uTroikaClipRect.zw)\n);\n\nvec2 clippedXY = (mix(clippedBounds.xy, clippedBounds.zw, position.xy) - bounds.xy) / (bounds.zw - bounds.xy);\n\nposition.xy = mix(bounds.xy, bounds.zw, clippedXY);\n\nuv = (position.xy - uTroikaTotalBounds.xy) / (uTroikaTotalBounds.zw - uTroikaTotalBounds.xy);\n\nfloat rad = uTroikaCurveRadius;\nif (rad != 0.0) {\n  float angle = position.x / rad;\n  position.xz = vec2(sin(angle) * rad, rad - cos(angle) * rad);\n  normal.xz = vec2(sin(angle), cos(angle));\n}\n  \nposition = uTroikaOrient * position;\nnormal = uTroikaOrient * normal;\n\nvTroikaGlyphUV = clippedXY.xy;\nvTroikaGlyphDimensions = vec2(bounds[2] - bounds[0], bounds[3] - bounds[1]);\n\n\nfloat txCols = uTroikaSDFTextureSize.x / uTroikaSDFGlyphSize;\nvec2 txUvPerSquare = uTroikaSDFGlyphSize / uTroikaSDFTextureSize;\nvec2 txStartUV = txUvPerSquare * vec2(\n  mod(floor(aTroikaGlyphIndex / 4.0), txCols),\n  floor(floor(aTroikaGlyphIndex / 4.0) / txCols)\n);\nvTroikaTextureUVBounds = vec4(txStartUV, vec2(txStartUV) + txUvPerSquare);\nvTroikaTextureChannel = mod(aTroikaGlyphIndex, 4.0);\n",fragmentDefs:"\nuniform sampler2D uTroikaSDFTexture;\nuniform vec2 uTroikaSDFTextureSize;\nuniform float uTroikaSDFGlyphSize;\nuniform float uTroikaSDFExponent;\nuniform float uTroikaDistanceOffset;\nuniform float uTroikaFillOpacity;\nuniform float uTroikaOutlineOpacity;\nuniform float uTroikaBlurRadius;\nuniform vec3 uTroikaStrokeColor;\nuniform float uTroikaStrokeWidth;\nuniform float uTroikaStrokeOpacity;\nuniform bool uTroikaSDFDebug;\nvarying vec2 vTroikaGlyphUV;\nvarying vec4 vTroikaTextureUVBounds;\nvarying float vTroikaTextureChannel;\nvarying vec2 vTroikaGlyphDimensions;\n\nfloat troikaSdfValueToSignedDistance(float alpha) {\n  // Inverse of exponential encoding in webgl-sdf-generator\n  \n  float maxDimension = max(vTroikaGlyphDimensions.x, vTroikaGlyphDimensions.y);\n  float absDist = (1.0 - pow(2.0 * (alpha > 0.5 ? 1.0 - alpha : alpha), 1.0 / uTroikaSDFExponent)) * maxDimension;\n  float signedDist = absDist * (alpha > 0.5 ? -1.0 : 1.0);\n  return signedDist;\n}\n\nfloat troikaGlyphUvToSdfValue(vec2 glyphUV) {\n  vec2 textureUV = mix(vTroikaTextureUVBounds.xy, vTroikaTextureUVBounds.zw, glyphUV);\n  vec4 rgba = texture2D(uTroikaSDFTexture, textureUV);\n  float ch = floor(vTroikaTextureChannel + 0.5); //NOTE: can't use round() in WebGL1\n  return ch == 0.0 ? rgba.r : ch == 1.0 ? rgba.g : ch == 2.0 ? rgba.b : rgba.a;\n}\n\nfloat troikaGlyphUvToDistance(vec2 uv) {\n  return troikaSdfValueToSignedDistance(troikaGlyphUvToSdfValue(uv));\n}\n\nfloat troikaGetAADist() {\n  \n  #if defined(GL_OES_standard_derivatives) || __VERSION__ >= 300\n  return length(fwidth(vTroikaGlyphUV * vTroikaGlyphDimensions)) * 0.5;\n  #else\n  return vTroikaGlyphDimensions.x / 64.0;\n  #endif\n}\n\nfloat troikaGetFragDistValue() {\n  vec2 clampedGlyphUV = clamp(vTroikaGlyphUV, 0.5 / uTroikaSDFGlyphSize, 1.0 - 0.5 / uTroikaSDFGlyphSize);\n  float distance = troikaGlyphUvToDistance(clampedGlyphUV);\n \n  // Extrapolate distance when outside bounds:\n  distance += clampedGlyphUV == vTroikaGlyphUV ? 0.0 : \n    length((vTroikaGlyphUV - clampedGlyphUV) * vTroikaGlyphDimensions);\n\n  \n\n  return distance;\n}\n\nfloat troikaGetEdgeAlpha(float distance, float distanceOffset, float aaDist) {\n  #if defined(IS_DEPTH_MATERIAL) || defined(IS_DISTANCE_MATERIAL)\n  float alpha = step(-distanceOffset, -distance);\n  #else\n\n  float alpha = smoothstep(\n    distanceOffset + aaDist,\n    distanceOffset - aaDist,\n    distance\n  );\n  #endif\n\n  return alpha;\n}\n",fragmentColorTransform:"\nfloat aaDist = troikaGetAADist();\nfloat fragDistance = troikaGetFragDistValue();\nfloat edgeAlpha = uTroikaSDFDebug ?\n  troikaGlyphUvToSdfValue(vTroikaGlyphUV) :\n  troikaGetEdgeAlpha(fragDistance, uTroikaDistanceOffset, max(aaDist, uTroikaBlurRadius));\n\n#if !defined(IS_DEPTH_MATERIAL) && !defined(IS_DISTANCE_MATERIAL)\nvec4 fillRGBA = gl_FragColor;\nfillRGBA.a *= uTroikaFillOpacity;\nvec4 strokeRGBA = uTroikaStrokeWidth == 0.0 ? fillRGBA : vec4(uTroikaStrokeColor, uTroikaStrokeOpacity);\nif (fillRGBA.a == 0.0) fillRGBA.rgb = strokeRGBA.rgb;\ngl_FragColor = mix(fillRGBA, strokeRGBA, smoothstep(\n  -uTroikaStrokeWidth - aaDist,\n  -uTroikaStrokeWidth + aaDist,\n  fragDistance\n));\ngl_FragColor.a *= edgeAlpha;\n#endif\n\nif (edgeAlpha == 0.0) {\n  discard;\n}\n",customRewriter({vertexShader:r,fragmentShader:x}){let b=/\buniform\s+vec3\s+diffuse\b/;return b.test(x)&&(x=x.replace(b,"varying vec3 vTroikaGlyphColor").replace(/\bdiffuse\b/g,"vTroikaGlyphColor"),b.test(r)||(r=r.replace(Ti,"uniform vec3 diffuse;\n$&\nvTroikaGlyphColor = uTroikaUseGlyphColors ? aTroikaGlyphColor / 255.0 : diffuse;\n"))),{vertexShader:r,fragmentShader:x}}});return x.transparent=!0,Object.defineProperties(x,{isTroikaTextMaterial:{value:!0},shadowSide:{get(){return this.side},set(){}}}),x}const Ji=new V({color:16777215,side:pe,transparent:!0}),Zi=8421504,Qi=new F,es=new x,ts=new x,ns=[],rs=new x,is="+x+y";function first(r){return Array.isArray(r)?r[0]:r}let getFlatRaycastMesh=()=>{const r=new I(new yt(1,1),Ji);return getFlatRaycastMesh=()=>r,r},getCurvedRaycastMesh=()=>{const r=new I(new yt(1,1,32,1),Ji);return getCurvedRaycastMesh=()=>r,r};const ss={type:"syncstart"},os={type:"synccomplete"},as=["font","fontSize","fontStyle","fontWeight","lang","letterSpacing","lineHeight","maxWidth","overflowWrap","text","direction","textAlign","textIndent","whiteSpace","anchorX","anchorY","colorRanges","sdfGlyphSize"],ls=as.concat("material","color","depthOffset","clipRect","curveRadius","orientation","glyphGeometryDetail");class Text extends I{constructor(){super(new GlyphsGeometry,null),this.text="",this.anchorX=0,this.anchorY=0,this.curveRadius=0,this.direction="auto",this.font=null,this.unicodeFontsURL=null,this.fontSize=.1,this.fontWeight="normal",this.fontStyle="normal",this.lang=null,this.letterSpacing=0,this.lineHeight="normal",this.maxWidth=1/0,this.overflowWrap="normal",this.textAlign="left",this.textIndent=0,this.whiteSpace="normal",this.material=null,this.color=null,this.colorRanges=null,this.outlineWidth=0,this.outlineColor=0,this.outlineOpacity=1,this.outlineBlur=0,this.outlineOffsetX=0,this.outlineOffsetY=0,this.strokeWidth=0,this.strokeColor=Zi,this.strokeOpacity=1,this.fillOpacity=1,this.depthOffset=0,this.clipRect=null,this.orientation=is,this.glyphGeometryDetail=1,this.sdfGlyphSize=null,this.gpuAccelerateSDF=!0,this.debugSDF=!1}sync(r){this._needsSync&&(this._needsSync=!1,this._isSyncing?(this._queuedSyncs||(this._queuedSyncs=[])).push(r):(this._isSyncing=!0,this.dispatchEvent(ss),getTextRenderInfo({text:this.text,font:this.font,lang:this.lang,fontSize:this.fontSize||.1,fontWeight:this.fontWeight||"normal",fontStyle:this.fontStyle||"normal",letterSpacing:this.letterSpacing||0,lineHeight:this.lineHeight||"normal",maxWidth:this.maxWidth,direction:this.direction||"auto",textAlign:this.textAlign,textIndent:this.textIndent,whiteSpace:this.whiteSpace,overflowWrap:this.overflowWrap,anchorX:this.anchorX,anchorY:this.anchorY,colorRanges:this.colorRanges,includeCaretPositions:!0,sdfGlyphSize:this.sdfGlyphSize,gpuAccelerateSDF:this.gpuAccelerateSDF,unicodeFontsURL:this.unicodeFontsURL},(x=>{this._isSyncing=!1,this._textRenderInfo=x,this.geometry.updateGlyphs(x.glyphBounds,x.glyphAtlasIndices,x.blockBounds,x.chunkedBounds,x.glyphColors);const b=this._queuedSyncs;b&&(this._queuedSyncs=null,this._needsSync=!0,this.sync((()=>{b.forEach((r=>r&&r()))}))),this.dispatchEvent(os),r&&r()}))))}onBeforeRender(r,x,b,S,C,A){this.sync(),C.isTroikaTextMaterial&&this._prepareForRender(C),C._hadOwnSide=C.hasOwnProperty("side"),this.geometry.setSide(C._actualSide=C.side),C.side=N}onAfterRender(r,x,b,S,C,A){C._hadOwnSide?C.side=C._actualSide:delete C.side}dispose(){this.geometry.dispose()}get textRenderInfo(){return this._textRenderInfo||null}get material(){let r=this._derivedMaterial;const x=this._baseMaterial||this._defaultMaterial||(this._defaultMaterial=Ji.clone());if(r&&r.baseMaterial===x||(r=this._derivedMaterial=createTextDerivedMaterial(x),x.addEventListener("dispose",(function onDispose(){x.removeEventListener("dispose",onDispose),r.dispose()}))),this.outlineWidth||this.outlineBlur||this.outlineOffsetX||this.outlineOffsetY){let x=r._outlineMtl;return x||(x=r._outlineMtl=Object.create(r,{id:{value:r.id+.1}}),x.isTextOutlineMaterial=!0,x.depthWrite=!1,x.map=null,r.addEventListener("dispose",(function onDispose(){r.removeEventListener("dispose",onDispose),x.dispose()}))),[x,r]}return r}set material(r){r&&r.isTroikaTextMaterial?(this._derivedMaterial=r,this._baseMaterial=r.baseMaterial):this._baseMaterial=r}get glyphGeometryDetail(){return this.geometry.detail}set glyphGeometryDetail(r){this.geometry.detail=r}get curveRadius(){return this.geometry.curveRadius}set curveRadius(r){this.geometry.curveRadius=r}get customDepthMaterial(){return first(this.material).getDepthMaterial()}get customDistanceMaterial(){return first(this.material).getDistanceMaterial()}_prepareForRender(r){const x=r.isTextOutlineMaterial,b=r.uniforms,S=this.textRenderInfo;if(S){const{sdfTexture:r,blockBounds:C}=S;b.uTroikaSDFTexture.value=r,b.uTroikaSDFTextureSize.value.set(r.image.width,r.image.height),b.uTroikaSDFGlyphSize.value=S.sdfGlyphSize,b.uTroikaSDFExponent.value=S.sdfExponent,b.uTroikaTotalBounds.value.fromArray(C),b.uTroikaUseGlyphColors.value=!x&&!!S.glyphColors;let A,I,R,B=0,D=0,F=0,G=0,N=0;if(x){let{outlineWidth:r,outlineOffsetX:x,outlineOffsetY:b,outlineBlur:S,outlineOpacity:C}=this;B=this._parsePercent(r)||0,D=Math.max(0,this._parsePercent(S)||0),A=C,G=this._parsePercent(x)||0,N=this._parsePercent(b)||0}else F=Math.max(0,this._parsePercent(this.strokeWidth)||0),F&&(R=this.strokeColor,b.uTroikaStrokeColor.value.set(null==R?Zi:R),I=this.strokeOpacity,null==I&&(I=1)),A=this.fillOpacity;b.uTroikaDistanceOffset.value=B,b.uTroikaPositionOffset.value.set(G,N),b.uTroikaBlurRadius.value=D,b.uTroikaStrokeWidth.value=F,b.uTroikaStrokeOpacity.value=I,b.uTroikaFillOpacity.value=null==A?1:A,b.uTroikaCurveRadius.value=this.curveRadius||0;let H=this.clipRect;if(H&&Array.isArray(H)&&4===H.length)b.uTroikaClipRect.value.fromArray(H);else{const r=100*(this.fontSize||.1);b.uTroikaClipRect.value.set(C[0]-r,C[1]-r,C[2]+r,C[3]+r)}this.geometry.applyClipRect(b.uTroikaClipRect.value)}b.uTroikaSDFDebug.value=!!this.debugSDF,r.polygonOffset=!!this.depthOffset,r.polygonOffsetFactor=r.polygonOffsetUnits=this.depthOffset||0;const C=x?this.outlineColor||0:this.color;if(null==C)delete r.color;else{const x=r.hasOwnProperty("color")?r.color:r.color=new be;C===x._input&&"object"!=typeof C||x.set(x._input=C)}let A=this.orientation||is;if(A!==r._orientation){let x=b.uTroikaOrient.value;A=A.replace(/[^-+xyz]/g,"");let S=A!==is&&A.match(/^([-+])([xyz])([-+])([xyz])$/);if(S){let[,r,b,C,A]=S;es.set(0,0,0)[b]="-"===r?1:-1,ts.set(0,0,0)[A]="-"===C?-1:1,Qi.lookAt(rs,es.cross(ts),ts),x.setFromMatrix4(Qi)}else x.identity();r._orientation=A}}_parsePercent(r){if("string"==typeof r){let x=r.match(/^(-?[\d.]+)%$/),b=x?parseFloat(x[1]):NaN;r=(isNaN(b)?0:b/100)*this.fontSize}return r}localPositionToTextCoords(r,x=new b){x.copy(r);const S=this.curveRadius;return S&&(x.x=Math.atan2(r.x,Math.abs(S)-Math.abs(r.z))*Math.abs(S)),x}worldPositionToTextCoords(r,x=new b){return es.copy(r),this.localPositionToTextCoords(this.worldToLocal(es),x)}raycast(r,x){const{textRenderInfo:b,curveRadius:S}=this;if(b){const C=b.blockBounds,A=S?getCurvedRaycastMesh():getFlatRaycastMesh(),I=A.geometry,{position:R,uv:B}=I.attributes;for(let r=0;r<B.count;r++){let x=C[0]+B.getX(r)*(C[2]-C[0]);const b=C[1]+B.getY(r)*(C[3]-C[1]);let A=0;S&&(A=S-Math.cos(x/S)*S,x=Math.sin(x/S)*S),R.setXYZ(r,x,b,A)}I.boundingSphere=this.geometry.boundingSphere,I.boundingBox=this.geometry.boundingBox,A.matrixWorld=this.matrixWorld,A.material.side=this.material.side,ns.length=0,A.raycast(r,ns);for(let r=0;r<ns.length;r++)ns[r].object=this,x.push(ns[r])}}copy(r){const x=this.geometry;return super.copy(r),this.geometry=x,ls.forEach((x=>{this[x]=r[x]})),this}clone(){return(new this.constructor).copy(this)}}function getCaretAtPoint(r,x,b){let S=null;const C=function(r){let x=cs.get(r);if(!x){x=[];const{caretPositions:b}=r;let S;const visitCaret=(r,b,C,A)=>{(!S||C<(S.top+S.bottom)/2)&&x.push(S={bottom:b,top:C,carets:[]}),C>S.top&&(S.top=C),b<S.bottom&&(S.bottom=b),S.carets.push({x:r,y:b,height:C-b,charIndex:A})};let C=0;for(;C<b.length;C+=4)visitCaret(b[C],b[C+2],b[C+3],C/4);visitCaret(b[C-3],b[C-2],b[C-1],C/4)}return cs.set(r,x),x}(r);let A=null;return C.forEach((r=>{(!A||Math.abs(b-(r.top+r.bottom)/2)<Math.abs(b-(A.top+A.bottom)/2))&&(A=r)})),A.carets.forEach((r=>{(!S||Math.abs(x-r.x)<Math.abs(x-S.x))&&(S=r)})),S}as.forEach((r=>{const x="_private_"+r;Object.defineProperty(Text.prototype,r,{get(){return this[x]},set(r){r!==this[x]&&(this[x]=r,this._needsSync=!0)}})}));const hs=new WeakMap;const cs=new WeakMap;var ds=Object.freeze({__proto__:null,GlyphsGeometry:GlyphsGeometry,Text:Text,configureTextBuilder:function(r){zi?console.warn("configureTextBuilder called after first font request; will be ignored."):assign(Wi,r)},createTextDerivedMaterial:createTextDerivedMaterial,dumpSDFTextures:function(){Object.keys(ji).forEach((r=>{const x=ji[r].sdfCanvas,{width:b,height:S}=x;console.log("%c.",`\n      background: url(${x.toDataURL()});\n      background-size: ${b}px ${S}px;\n      color: transparent;\n      font-size: 0;\n      line-height: ${S}px;\n      padding-left: ${b}px;\n    `)}))},fontResolverWorkerModule:Bi,getCaretAtPoint:getCaretAtPoint,getSelectionRects:function(r,x,b){let S;if(r){let C=hs.get(r);if(C&&C.start===x&&C.end===b)return C.rects;const{caretPositions:A}=r;if(b<x){const r=x;x=b,b=r}x=Math.max(x,0),b=Math.min(b,A.length+1),S=[];let I=null;for(let r=x;r<b;r++){const x=A[4*r],b=A[4*r+1],C=Math.min(x,b),R=Math.max(x,b),B=A[4*r+2],D=A[4*r+3];(!I||B!==I.bottom||D!==I.top||C>I.right||R<I.left)&&(I={left:1/0,right:-1/0,bottom:B,top:D},S.push(I)),I.left=Math.min(C,I.left),I.right=Math.max(R,I.right)}S.sort(((r,x)=>x.bottom-r.bottom||r.left-x.left));for(let r=S.length-1;r-- >0;){const x=S[r],b=S[r+1];x.bottom===b.bottom&&x.top===b.top&&x.left<=b.right&&x.right>=b.left&&(b.left=Math.min(b.left,x.left),b.right=Math.max(b.right,x.right),S.splice(r,1))}hs.set(r,{start:x,end:b,rects:S})}return S},getTextRenderInfo:getTextRenderInfo,preloadFont:function({font:r,characters:x,sdfGlyphSize:b},S){getTextRenderInfo({font:r,sdfGlyphSize:b,text:Array.isArray(x)?x.join("\n"):""+x},S)},typesetterWorkerModule:qi});class Checkbox extends InteractableComponent{constructor(...r){super(...r),this._defaults.backgroundVisible=!0,this._defaults.borderMaterial.color.set(5197647),this._defaults.borderMaterial.opacity=.9,this._defaults.borderWidth=.002,this._defaults.color=16777215,this._defaults.height=.08,this._defaults.width=.08,this._text=new Text,this._content.add(this._text),this._text.text=" ",this._text.color=this.color,this._text.lineHeight=1,this._text.textAlign="center",this._text.anchorX="center",this._text.anchorY="middle",this.onClick=this.onTouch=()=>this._change(),"visible"!=this.overflow&&(this._text.material.clippingPlanes=this._getClippingPlanes()),this.updateLayout()}updateLayout(){super.updateLayout(),this._text.fontSize=.65*Math.min(this.computedHeight,this.computedWidth)}_updateMaterialOffset(r){super._updateMaterialOffset(r),this._text.depthOffset=-1*this._materialOffset-1,this._text.renderOrder=this._materialOffset+1}_change(){this._checked=!this._checked,this._checked?(this._text.text="✔",this.material.color.set(12543),this._text.sync()):(this._text.text="",this.material.color.set(16777215)),this._onChange&&this._onChange(this._checked)}get checked(){return this._checked}get onChange(){return this._onChange}set checked(r){r!=this._checked&&(this._checked=r,r?(this._text.text="✔",this.material.color.set(12543)):(this._text.text="",this.material.color.set(16777215)),this._text.sync())}set onChange(r){this._onChange=r}}class Div extends ScrollableComponent{constructor(...r){super(...r),this.updateLayout()}}const us=new r.Vector3;let ps=class extends InteractableComponent{constructor(r,...x){super(...x),this._defaults.backgroundVisible=!0,this._defaults.textureFit="fill",this._imageHeight=0,this._imageWidth=0,this.updateLayout(),this.updateTexture(r)}_handleStyleUpdateForTextureFit(){this._updateFit(-1,1)}_computeDimension(r){if("auto"!=this[r])return super._computeDimension(r);let x="height"==r?"width":"height",b=capitalizeFirstLetter(r),S=capitalizeFirstLetter(x),C="computed"+b;if("auto"==this[x])this[C]=this["_image"+b]/100;else{"height"==r&&this._computeDimension("width");let x=this["computed"+S]/this["_image"+S];this[C]=this["_image"+b]*x||0}return this._computeUnpaddedAndMarginedDimensions(r,this[C]),this[C]}updateLayout(){let r=this.computedHeight,x=this.computedWidth;super.updateLayout(),this._updateFit(r,x)}_updateFit(r,x){let b=this.computedHeight,S=this.computedWidth;if((r!=this.computedHeight||x!=this.computedWidth)&&this?._texture?.image)if("cover"==this.textureFit){let C=S/b;if(C!=x/r){let r=this._texture.image.width/this._texture.image.height;C<r?(this._texture.repeat.x=C/r,this._texture.repeat.y=1,this._texture.offset.x=(1-this._texture.repeat.x)/2,this._texture.offset.y=0):(this._texture.repeat.x=1,this._texture.repeat.y=r/C,this._texture.offset.x=0,this._texture.offset.y=(1-this._texture.repeat.y)/2)}}else this._texture.repeat.x=1,this._texture.repeat.y=1,this._texture.offset.x=0,this._texture.offset.y=0}updateTexture(x){x?x instanceof r.Texture?this._updateTexture(x.bypassCloning?x:x.clone()):(new r.TextureLoader).load(x,(x=>{x.colorSpace=r.SRGBColorSpace,this._updateTexture(x)}),(()=>{}),(()=>{console.error("Couldn't load image :(")})):(this._texture&&this._texture.dispose(),this._texture=null,this.material.map=null,this.material.needsUpdate=!0)}_updateTexture(r){let x=this._texture;this._texture=r,this._imageWidth=r.image.width,this._imageHeight=r.image.height,this.material.map=r,this.material.needsUpdate=!0,this.updateLayout(),this._updateFit(-1,1),x&&x.dispose()}_createBackground(){super._createBackground();let r=this.computedWidth/2,x=this.computedHeight/2,b=this._background.geometry.attributes.position,S=this._background.geometry.attributes.uv;for(let C=0;C<b.count;C++)us.fromBufferAttribute(b,C),S.setXY(C,(us.x+r)/this.computedWidth,(us.y+x)/this.computedHeight)}};class HueSaturationWheel extends ps{constructor(r,...x){super(r,...x)}_createBackground(){this._defaults.borderRadius=Math.min(this.computedHeight,this.computedHeight)/2,super._createBackground()}}const fs=new r.Plane,gs=new r.Vector3,ms=256,_s=128;class HSLColor{constructor(r){this._hue=171,this._saturation=1,this._lightness=.5,this._radius=r||.1,this._createTextures(),this._createCursors()}_createTextures(){let x=2*this._radius,b=document.createElement("canvas"),S=document.createElement("canvas");b.width=256,b.height=256,S.width=1,S.height=ms,this._colorContext=b.getContext("2d"),this._lightnessContext=S.getContext("2d"),this._updateColorWheel(),this._updateLightnessBar(),this._colorTexture=new r.CanvasTexture(b),this._colorTexture.colorSpace=r.SRGBColorSpace,this._colorTexture.bypassCloning=!0,this._lightnessTexture=new r.CanvasTexture(S),this._lightnessTexture.colorSpace=r.SRGBColorSpace,this._lightnessTexture.bypassCloning=!0,this.hueSaturationWheel=new HueSaturationWheel(this._colorTexture,{height:x,width:x}),this.lightnessBar=new ps(this._lightnessTexture,{borderRadius:x/20,height:x,width:x/10}),this.hueSaturationWheel.pointerInteractable.addEventListener("down",(r=>this.hueSaturationWheel.pointerInteractable.capture(r.owner))),this.hueSaturationWheel.onClick=r=>{this._handleColorCursorDrag(r),this._onBlur&&this._onBlur(this.getColor())},this.hueSaturationWheel.onDrag=r=>{this._handleColorCursorDrag(r)},this.lightnessBar.pointerInteractable.addEventListener("down",(r=>this.lightnessBar.pointerInteractable.capture(r.owner))),this.lightnessBar.onClick=r=>{this._handleLightnessCursorDrag(r),this._onBlur&&this._onBlur(this.getColor())},this.lightnessBar.onDrag=r=>{this._handleLightnessCursorDrag(r)}}_updateColorWheel(){let r=this._colorContext.getImageData(0,0,256,256),x=r.data;this._drawColorWheel(x),this._colorContext.putImageData(r,0,0)}_drawColorWheel(r){let x=this._lightness;for(let b=-128;b<=_s;b++){let S=b*b,C=Math.ceil(Math.sqrt(16384-S));for(let S=-C;S<=C;S++){let[C,A]=cartesianToPolar(b,S);if(C>_s)continue;let I=4*(b+_s+(S+_s)*256),R=radiansToDegrees(A),B=C/_s,[D,F,G]=hslToRGB(R,B,x);r[I]=D,r[I+1]=F,r[I+2]=G,r[I+3]=255}}}_updateLightnessBar(){let r=this._lightnessContext.getImageData(0,0,1,ms),x=r.data;for(let r=0;r<1;r++)for(let b=0;b<ms;b++){let S=4*(r+1*b),C=this._hue,A=this._saturation,I=1-b/ms,[R,B,D]=hslToRGB(C,A,I);x[S]=R,x[S+1]=B,x[S+2]=D,x[S+3]=255}this._lightnessContext.putImageData(r,0,0)}_handleColorCursorDrag(r){let{owner:x,point:b}=r;b||(fs.set(gs.set(0,0,1),0),fs.applyMatrix4(this.hueSaturationWheel.matrixWorld),b=x.raycaster.ray.intersectPlane(fs,gs)),gs.copy(b),this.hueSaturationWheel.worldToLocal(gs);let S=this.selectColorFromXY(gs.x,gs.y);null!=S&&this._onChange&&(this._onChange(S),this._updateColorCursor(),this._colorCursor.visible||(this._colorCursor.visible=!0))}_handleLightnessCursorDrag(r){let{owner:x,point:b}=r;b||(fs.set(gs.set(0,0,1),0),fs.applyMatrix4(this.lightnessBar.matrixWorld),b=x.raycaster.ray.intersectPlane(fs,gs)),gs.copy(b),this.lightnessBar.worldToLocal(gs);let S=this.selectLightnessFromXY(gs.x,gs.y);null!=S&&this._onChange&&(this._onChange(S),this._updateLightnessCursor(),this._lightnessCursor.visible||(this._lightnessCursor.visible=!0))}_createCursors(){let x=new r.RingGeometry(this._radius/12,this._radius/10,16),b=new r.MeshBasicMaterial({color:16777215,side:r.FrontSide,transparent:!0,polygonOffset:!0,polygonOffsetFactor:-10,polygonOffsetUnits:-10});this._colorCursor=new r.Mesh(x,b),this._colorCursor.position.setZ(2e-8),this.hueSaturationWheel.add(this._colorCursor),this._colorCursor.visible=!1,x=new r.RingGeometry(this._radius/9,this._radius/7.5,4,1,Math.PI/4);let S=x.getAttribute("position");for(let r=0;r<S.count;r++){let x=S.getY(r);x>0&&S.setY(r,x-this._radius/20),x<0&&S.setY(r,x+this._radius/20)}this._lightnessCursor=new r.Mesh(x,b),this._lightnessCursor.position.setZ(2e-8),this.lightnessBar.add(this._lightnessCursor),this._lightnessCursor.visible=!1}_updateColorCursor(){let[r,x]=this.getXY(this._radius);gs.set(r,-x,0),this._colorCursor.position.setX(gs.x),this._colorCursor.position.setY(gs.y);let b=this._colorCursor.material,S=this.hueSaturationWheel._materialOffset+1;b.polygonOffsetFactor!=-1*S&&(b.polygonOffsetFactor=-1*S,b.polygonOffsetUnits=-1*S,this._colorCursor.renderOrder=S)}_updateLightnessCursor(){let r=this.getLightness(this._radius);gs.set(0,(r-.5)*this._radius*2,0),this._lightnessCursor.position.setX(gs.x),this._lightnessCursor.position.setY(gs.y)}getColorTexture(){return this._colorTexture}getLightnessTexture(){return this._lightnessTexture}getXY(x){return polarToCartesian(this._saturation*x,r.MathUtils.degToRad(this._hue+180))}getLightness(){return this._lightness}setFromHSL(r){this._hue=360*r.h,this._saturation=r.s,this._lightness=r.l,this._updateColorWheel(),this._updateColorCursor(),this._updateLightnessBar(),this._updateLightnessCursor(),this._colorTexture.needsUpdate=!0,this._lightnessTexture.needsUpdate=!0}selectColorFromXY(r,x){let[b,S]=cartesianToPolar(r,x);b>this._radius&&(b=this._radius);let C=radiansToDegrees(-S),A=b/this._radius;return this._hue=C,this._saturation=A,this._updateLightnessBar(),this._lightnessTexture.needsUpdate=!0,this.getColor()}selectLightnessFromXY(r,x){let b=x/(2*this._radius)+.5;return b<0&&(b=0),b>1&&(b=1),this._lightness=b,this._updateColorWheel(),this._colorTexture.needsUpdate=!0,this.getColor()}getColor(){let[r,x,b]=hslToRGB(this._hue,this._saturation,this._lightness);return rgbToHex(r,x,b)}isDragging(){return this.hueSaturationWheel.pointerInteractable.state==Dr.SELECTED||Dr.SELECTED==this.lightnessBar.pointerInteractable.state}get onBlur(){return this._onBlur}get onChange(){return this._onChange}get radius(){return this._radius}set onBlur(r){this._onBlur=r}set onChange(r){this._onChange=r}set radius(r){this._radius=r}}class Span extends ScrollableComponent{constructor(...r){super(...r),this._defaults.contentDirection="row",this.updateLayout()}}class TextComponent extends LayoutComponent{constructor(r,...x){super(...x),this._defaults.color=0,this._defaults.fontSize=.1,this._defaults.textAlign="left",this._text=new Text,this._content.add(this._text),this.font&&(this._text.font=this.font),this._text.color=this.color,this._text.fontSize=this.fontSize,this._text.textAlign=this.textAlign,this._text.anchorX="center",this._text.anchorY="middle",this._text.overflowWrap="break-word",typeof this.maxWidth==Number&&(this._text.maxWidth=this.maxWidth),this._text.addEventListener("synccomplete",(()=>this.updateLayout())),this._text.sync(),this._text.text=r||"",this._text.sync(),"visible"!=this.overflow&&(this._text.material.clippingPlanes=this._getClippingPlanes())}_handleStyleUpdateForColor(){this._text.color=this.color}_handleStyleUpdateForFont(){this._text.font=this.font,"auto"!=this.width&&"auto"!=this.height||this.updateLayout()}_handleStyleUpdateForFontSize(){this._text.fontSize=this.fontSize,"auto"!=this.width&&"auto"!=this.height||this.updateLayout()}_handleStyleUpdateForTextAlign(){this._text.textAlign=this.textAlign}_handleStyleUpdateForMaxWidth(){null!=this.maxWidth?"number"==typeof this.maxWidth&&(this._text.maxWidth=this.maxWidth):this._text.maxWidth=null,super._handleStyleUpdateForMaxWidth()}_computeDimension(r,x){if("auto"!=this[x||r]){let b=super._computeDimension(r,x);return"width"==r&&(this._text.maxWidth=b),b}let b=capitalizeFirstLetter(r),S="computed"+b,C="max"+b,A="min"+b,I=this._text.textRenderInfo;if(I){let x=I.blockBounds;this[S]="width"==r?Math.abs(x[0]-x[2]):Math.abs(x[1]-x[3])}if(x)return this[S];if(0==this[S]&&null!=this[A])this._computeDimension(r,A);else if("width"==r&&this[C]){let x=this[S];this._computeDimension(r,C),this._text.maxWidth=this[S],x<this[S]&&(this[S]=x)}return this._computeUnpaddedAndMarginedDimensions(r,this[S]),this[S]}_updateMaterialOffset(r){super._updateMaterialOffset(r),this._text.depthOffset=-1*this._materialOffset-1,this._text.renderOrder=this._materialOffset+1}get text(){return this._text.text}get troikaText(){return this._text}set text(r){this._text.text=r,this._text.sync()}}const ys={name:"English",pages:[{style:{padding:.01},rows:[{keys:["q","w",{text:"e",type:"key",value:"e",additionalCharacters:["è","é","ë","ê"]},"r","t","y",{text:"u",type:"key",value:"u",additionalCharacters:["ù","ú","ü","û"]},{text:"i",type:"key",value:"i",additionalCharacters:["ì","í","ï","î"]},{text:"o",type:"key",value:"o",additionalCharacters:["ò","ó","ö","ô","ø"]},"p"]},{keys:[{text:"a",type:"key",value:"a",additionalCharacters:["à","á","ä","â"]},"s","d","f","g","h","j","k","l"]},{keys:[{text:"⇧",type:"shift",style:{width:.155}},"z","x",{text:"c",type:"key",value:"c",additionalCharacters:["ç"]},"v","b",{text:"n",type:"key",value:"n",additionalCharacters:["ñ"]},"m",{text:"⌫",type:"key",value:"Backspace",style:{width:.155}}]},{keys:[{text:"123",type:"page",page:1,style:{width:.155}},",",{text:"space",type:"key",value:" ",style:{width:.539}},".",{text:"⏎",type:"key",value:"Enter",style:{width:.155}}]}]},{style:{padding:.01},rows:[{keys:["1","2","3","4","5","6","7","8","9","0"]},{keys:["-","/",":",";","(",")","$","&","@",'"']},{keys:[{text:"#+=",type:"page",page:2,style:{width:.155,marginRight:.115}},".",",","?","!","'",{text:"⌫",type:"key",value:"Backspace",style:{width:.155,marginLeft:.115}}]},{keys:[{text:"ABC",type:"page",page:0,style:{width:.155}},{text:"space",type:"key",value:" ",style:{width:.759}},{text:"⏎",type:"key",value:"Enter",style:{width:.155}}]}]},{style:{padding:.01},rows:[{keys:["[","]","{","}","#","%","^","*","+","="]},{keys:["_","\\","|","~","<",">","€","£","¥","•"]},{style:{justifyContent:"spaceBetween",width:"100%"},keys:[{text:"123",type:"page",page:1,style:{width:.155,marginRight:.115}},".",",","?","!","'",{text:"⌫",type:"key",value:"Backspace",style:{width:.155,marginLeft:.115}}]},{keys:[{text:"ABC",type:"page",page:0,style:{width:.155}},{text:"space",type:"key",value:" ",style:{width:.759}},{text:"⏎",type:"key",value:"Enter",style:{width:.155}}]}]}]},vs={name:"Numbers",pages:[{style:{padding:.01},rows:[{keys:["1","2","3"]},{keys:["4","5","6"]},{keys:["7","8","9"]},{keys:[".","0",{text:"⌫",type:"key",value:"Backspace"}]},{keys:["±",{text:"⏎",type:"key",value:"Enter",style:{width:.21}}]}]}]},xs={name:"русский",pages:[{style:{padding:.01},rows:[{keys:["й","ц","у","к","е","н","г","ш","щ","з","х","ъ"]},{keys:["ф","ы","в","а","п","р","о","л","д","ж","э","ë"]},{keys:[{text:"⇧",type:"shift",style:{width:.155}},"я","ч","с","м","и","т","ь","б","ю",{text:"⌫",type:"key",value:"Backspace",style:{width:.155}}]},{keys:[{text:"123",type:"page",page:1,style:{width:.155}},",",{text:"space",type:"key",value:" ",style:{width:.539}},".",{text:"⏎",type:"key",value:"Enter",style:{width:.155}}]}]},{style:{padding:.01,marginLeft:.11,marginRight:.11},rows:[{keys:["1","2","3","4","5","6","7","8","9","0"]},{keys:["@","#",":",";","%","-","+","=","(",")"]},{keys:[{text:"~[<",type:"page",page:2,style:{width:.155}},".",",","?","!",'"',"'","₽",{text:"⌫",type:"key",value:"Backspace",style:{width:.155}}]},{keys:[{text:"АБВ",type:"page",page:0,style:{width:.155}},"\\",{text:"space",type:"key",value:" ",style:{width:.539}},"/",{text:"⏎",type:"key",value:"Enter",style:{width:.155}}]}]},{style:{padding:.01,marginLeft:.11,marginRight:.11},rows:[{keys:["[","]","{","}","`","^","*","&","«","»"]},{keys:["$","€","£","¥","•","_","|","~","<",">"]},{style:{justifyContent:"spaceBetween",width:"100%"},keys:[{text:"123",type:"page",page:1,style:{width:.155}},".",",","?","!",'"',"'","₽",{text:"⌫",type:"key",value:"Backspace",style:{width:.155}}]},{keys:[{text:"АБВ",type:"page",page:0,style:{width:.155}},"\\",{text:"space",type:"key",value:" ",style:{width:.539}},"/",{text:"⏎",type:"key",value:"Enter",style:{width:.155}}]}]}]},bs={name:"😀",pages:[{style:{padding:.01},rows:[{keys:["😀","😃","😄","😁","😆","😅","🤣","😂","🙂","🙃"]},{keys:["🫠","😉","😊","😇","🥰","😍","🤩","😘","😗","☺"]},{keys:["😚","😙","🥲","😋","😛","😜","🤪","😝","🤑","🤗"]},{keys:[{text:"←",type:"page",page:3,style:{width:.155}},{text:"→",type:"page",page:1,style:{width:.155}},{text:"space",type:"key",value:" ",style:{width:.429}},{text:"⏎",type:"key",value:"Enter",style:{width:.155}},{text:"⌫",type:"key",value:"Backspace",style:{width:.155}}]}]},{style:{padding:.01},rows:[{keys:["🤭","🫢","🫣","🤫","🤔","🫡","🤐","🤨","😐","😑"]},{keys:["😶","🫥","😶‍🌫","😏","😒","🙄","😬","😮‍💨","🤥","😌"]},{keys:["😔","😪","🤤","😴","😷","🤒","🤕","🤢","🤮","🤧"]},{keys:[{text:"←",type:"page",page:0,style:{width:.155}},{text:"→",type:"page",page:2,style:{width:.155}},{text:"space",type:"key",value:" ",style:{width:.429}},{text:"⏎",type:"key",value:"Enter",style:{width:.155}},{text:"⌫",type:"key",value:"Backspace",style:{width:.155}}]}]},{style:{padding:.01},rows:[{keys:["🥵","🥶","🥴","😵","😵‍💫","🤯","🤠","🥳","🥸","😎"]},{keys:["🤓","🧐","😕","🫤","😟","🙁","☹","😮","😯","😲"]},{keys:["😳","🥺","🥹","😦","😧","😨","😰","😥","😢","😭"]},{keys:[{text:"←",type:"page",page:1,style:{width:.155}},{text:"→",type:"page",page:3,style:{width:.155}},{text:"space",type:"key",value:" ",style:{width:.429}},{text:"⏎",type:"key",value:"Enter",style:{width:.155}},{text:"⌫",type:"key",value:"Backspace",style:{width:.155}}]}]},{style:{padding:.01},rows:[{keys:["😱","😖","😣","😞","😓","😩","😫","🥱","😤","😡"]},{keys:["😠","🤬","😈","👿","💀","☠","💩","","",""]},{keys:["","","","","","","","","",""]},{keys:[{text:"←",type:"page",page:2,style:{width:.155}},{text:"→",type:"page",page:0,style:{width:.155}},{text:"space",type:"key",value:" ",style:{width:.429}},{text:"⏎",type:"key",value:"Enter",style:{width:.155}},{text:"⌫",type:"key",value:"Backspace",style:{width:.155}}]}]}]},Ts=new Style({backgroundVisible:!0,borderRadius:.01,height:.1,justifyContent:"center",margin:.005,paddingLeft:.02,paddingRight:.02,width:.1}),ws=new Style({material:new r.MeshBasicMaterial({color:15790320,side:r.DoubleSide,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1})}),Ss={fontSize:.065},Cs="UNSHIFTED",As="SHIFTED",Is="CAPS_LOCK";function getComponentBody(r){for(;r&&!(r instanceof Body);)r=r.parent;return r}let ks=new class extends InteractableComponent{constructor(...r){super(...r),this.bypassContentPositioning=!0,this._defaults.backgroundVisible=!0,this._defaults.materialColor=12633550,this._layouts={},this._keyboardPageLayouts=[],this._timeoutIds=new Map,this._updateListeners=new Map,this._setupGrabBar(),this._createOptionsPanel(),this._addLayout(ys),this._addLayout(xs),this._addLayout(bs),this._setLayout(ys),this.types={NUMBER:"NUMBER"},this.onClick=()=>{},this.updateLayout()}_createBackground(){this._defaults.borderRadius=Math.min(this.computedHeight,this.computedHeight)/20,super._createBackground()}_createOptionsPanel(){this._optionsPanelParent=new r.Object3D,this.add(this._optionsPanelParent),this._optionsPanel=new Div({backgroundVisible:!0,borderRadius:.06,height:.12,justifyContent:"center",materialColor:12633550,width:.12});let x=new Div({backgroundVisible:!0,borderRadius:.05,height:.1,justifyContent:"center",width:.1}),b=new TextComponent("🌐",Ss);this._optionsPanel.add(x),x.add(b),x.pointerInteractable.addHoveredCallback((r=>{r?x.addStyle(ws):x.removeStyle(ws)})),x.onClick=x.onTouch=()=>{this._setLanguagesPage()}}_addOptionsPanel(){this._optionsPanelParent.add(this._optionsPanel),this._optionsPanelParent.position.x=this.computedWidth/-2-.1}_addLayout(r){this._layouts[r.name]=r}_setLayout(r){if("string"!=typeof r||(r=this._layouts[r])){for(let r of this._content.children)r instanceof LayoutComponent&&this.remove(r);this._keyboardLayout=r,this._keyboardPageLayouts=[],this._keyboardPage=null,this._shiftState=Cs,this._setPage(0)}}_setPage(r){if(this._keyboardPage==r)return;for(let r of this._content.children)r instanceof LayoutComponent&&this.remove(r);if(this._keyboardPage=r,this._keyboardPageLayouts[r])return this.add(this._keyboardPageLayouts[r]),void this._addOptionsPanel();let x=new Div(this._keyboardLayout.pages[r].style);for(let b of this._keyboardLayout.pages[r].rows){let S=new Span(b.style);for(let x of b.keys){let b=new Div(Ts,x.style),C=x;"string"!=typeof x&&(C=x.text);let A=new TextComponent(C,Ss);b.add(A),S.add(b),b.pointerInteractable.addHoveredCallback((r=>{r?b.addStyle(ws):b.removeStyle(ws)})),"string"!=typeof x&&x.additionalCharacters&&this._addAdditionalCharacters(b,x);let listener=()=>{if(this._registeredComponent)if("string"==typeof x){let x=this._shiftState==Cs?C:C.toUpperCase();this._registeredComponent.handleKey(x),this._shiftState==As&&x!=C&&(this._shiftState=Cs,this._shiftCase(r,!1))}else if("key"==x.type){let b=this._shiftState==Cs||x.value.length>1?x.value:x.value.toUpperCase();this._registeredComponent.handleKey(b),this._shiftState==As&&b!=x.value&&(this._shiftState=Cs,this._shiftCase(r,!1))}else"page"==x.type?(this._shiftState!=Cs&&(this._shiftState=Cs,this._shiftCase(r,!1)),this._setPage(x.page)):"shift"==x.type&&(this._shiftState==Cs?(this._shiftState=As,this._shiftCase(r,!0)):this._shiftState==As?this._shiftState=Is:this._shiftState==Is&&(this._shiftState=Cs,this._shiftCase(r,!1)))};b.pointerInteractable.addEventListener("click",listener),b.touchInteractable.addEventListener("click",listener)}x.add(S)}this._keyboardPageLayouts[r]=x,this.add(x),this._addOptionsPanel(),this._reposition()}_addAdditionalCharacters(r,x){r.pointerInteractable.addEventListener("down",(b=>{let S=b.owner;if(b.additionalCharactersOwner)return;this._timeoutIds.set(S,setTimeout((()=>{this._displayAdditionalCharacters(r,x),this._timeoutIds.delete(S)}),500)),r.additionalCharactersOwner=S;let outCallback=x=>{x.owner==S&&(this._timeoutIds.has(S)&&(clearTimeout(this._timeoutIds.get(S)),this._timeoutIds.delete(S),Mr.remove(this._updateListeners.get(S)),delete r.additionalCharactersOwner),r.pointerInteractable.removeEventListener("out",outCallback))};r.pointerInteractable.addEventListener("out",outCallback),this._updateListeners.set(S,(()=>{let x;x="XR"==Fr.active?this._isXRControllerPressed(S):"POINTER"==Fr.active?hi.isPointerPressed():hi.isScreenTouched(),x||(this._timeoutIds.has(S)&&(clearTimeout(this._timeoutIds.get(S)),this._timeoutIds.delete(S)),r.additionalCharactersSpan&&r.remove(r.additionalCharactersSpan),r.pointerInteractable.removeEventListener("out",outCallback),Mr.remove(this._updateListeners.get(S)),delete r.additionalCharactersOwner)})),Mr.add(this._updateListeners.get(S))}))}_isXRControllerPressed(r){let x=r.object.xrInputDeviceType,b=r.object.handedness;if(x==Nr.HAND){let r=hi.getXRControllerModel(x,b);return 1==r?.motionController?.isPinching}{let r=hi.getXRGamepad(b);return null!=r?.buttons&&r.buttons[0].pressed}}_displayAdditionalCharacters(r,x){if(r.additionalCharactersSpan)return r.additionalCharactersSpan.borderRadius=this.borderRadius,r.additionalCharactersSpan._updateMaterialOffset(r._materialOffset+1),void r.add(r.additionalCharactersSpan);let b=x.additionalCharacters,S=new Span({backgroundVisible:!0,materialColor:12633550});S.bypassContentPositioning=!0,S.position.y=r.computedHeight;for(let r of b){let b=new Div(Ts,x.style),C=new TextComponent(r,Ss);this._shiftState!=Cs&&(C.text=C.text.toUpperCase()),b.add(C),S.add(b),b.pointerInteractable.addEventListener("over",(()=>{b.addStyle(ws)})),b.pointerInteractable.addEventListener("out",(()=>{b.removeStyle(ws)})),b.pointerInteractable.addEventListener("up",(()=>{let x=this._shiftState==Cs?r:r.toUpperCase();this._registeredComponent.handleKey(x),this._shiftState==As&&(this._shiftState=Cs,this._shiftCase(this._keyboardPage,!1))}))}S.borderRadius=this.borderRadius;let C=r?.parentComponent?.parentComponent?.padding;C&&(S.padding=C,S.position.y+=C),S._updateMaterialOffset(r._materialOffset+1),r.additionalCharactersSpan=S,r.add(S)}_setLanguagesPage(){for(let r of this._content.children)r instanceof LayoutComponent&&this.remove(r);let r,x=0,b=new Div({padding:.01});for(let S in this._layouts){x%2==0&&(r=new Span,b.add(r)),x++;let C=new Div(Ts,{width:.3}),A=new TextComponent(S,Ss);C.add(A),r.add(C),C.pointerInteractable.addHoveredCallback((r=>{r?C.addStyle(ws):C.removeStyle(ws)})),C.onClick=C.onTouch=()=>{this._setLayout(S)}}this.add(b),this._optionsPanelParent.remove(this._optionsPanel),this._reposition()}_setNumberPage(){this._lastKeyboardLayout||(this._lastKeyboardLayout=this._keyboardLayout),this._setLayout(vs),this._optionsPanelParent.remove(this._optionsPanel)}_shiftCase(r,x){let b=x?"toUpperCase":"toLowerCase";for(let x of this._keyboardPageLayouts[r]._content.children)for(let r of x._content.children){let x=r._content.children[0];if(1==x.text.length&&(x.text=x.text[b]()),r.additionalCharactersSpan){let x=r.additionalCharactersSpan._content.children;for(let r of x){let x=r._content.children[0];x.text=x.text[b]()}}}}_reposition(){if(this._placeGrabBar(),!this._onPopup&&this._registeredComponent){let r=getComponentBody(this._registeredComponent);if(r||(r=this._registeredComponent),this.parent!=r)return;this.position.set(0,(-r.computedHeight-this.computedHeight*this.scale.y)/2-.025,0)}}register(r,x){this._registeredComponent&&this._registeredComponent.blur(),this._registeredComponent=r;let b=getComponentBody(r);x==this.types.NUMBER&&this._setNumberPage(),this._placeGrabBar(),this._onPopup?this._onPopup(r,b):(b||(b=r),this.position.set(0,(-b.computedHeight-this.computedHeight*this.scale.y)/2-.025,0),this.rotation.set(0,0,0),b.add(this),this._updateMaterialOffset(r._materialOffset))}unregister(r){this._registeredComponent==r&&(this._registeredComponent=null,this.parent&&this.parent.remove(this),this._grabBarOwner=this._priorParent=null),this._lastKeyboardLayout&&(this._setLayout(this._lastKeyboardLayout),this._lastKeyboardLayout=null)}_placeGrabBar(){this._grabBar.position.y=-this.computedHeight/2-.025}_setupGrabBar(){this._grabBar=new Body({backgroundVisible:!1,borderRadius:.025,height:.05,justifyContent:"center",width:.21});let r=new Div({backgroundVisible:!0,borderRadius:.01,height:.02,materialColor:12633550,width:.2});this._grabBar.pointerInteractable.addHoveredCallback((x=>{r.material.color.set(x?16777215:12633550)})),this._grabBar.pointerInteractable.addEventListener("down",(r=>{this._grabBarOwner||(this._priorParent=this.parent),this._grabBarOwner=r.owner,r.owner.object.attach(this),this._grabBar.pointerInteractable.capture(r.owner)})),this._grabBar.pointerInteractable.addEventListener("click",(r=>{this.parent==r.owner.object&&(this._priorParent.attach(this),this._grabBarOwner=this._priorParent=null)})),this._grabBar.add(r),this.add(this._grabBar)}get onPopup(){return this._onPopup}set onPopup(r){this._onPopup=r}};let Es=new class{constructor(){this._listeners=new Set}setup(){"XR"!=Fr.active&&(this._eventType="TOUCH_SCREEN"==Fr.active?"touchend":"click",this._clickListener=()=>{setTimeout((()=>{for(let r of this._listeners)r(),this._listeners.delete(r)}),30)},document.addEventListener(this._eventType,this._clickListener))}trigger(r){this._listeners.add(r)}};var Rs;!function(r){r[r.HIGH_SURROGATE_START=55296]="HIGH_SURROGATE_START",r[r.HIGH_SURROGATE_END=56319]="HIGH_SURROGATE_END",r[r.LOW_SURROGATE_START=56320]="LOW_SURROGATE_START",r[r.REGIONAL_INDICATOR_START=127462]="REGIONAL_INDICATOR_START",r[r.REGIONAL_INDICATOR_END=127487]="REGIONAL_INDICATOR_END",r[r.FITZPATRICK_MODIFIER_START=127995]="FITZPATRICK_MODIFIER_START",r[r.FITZPATRICK_MODIFIER_END=127999]="FITZPATRICK_MODIFIER_END",r[r.VARIATION_MODIFIER_START=65024]="VARIATION_MODIFIER_START",r[r.VARIATION_MODIFIER_END=65039]="VARIATION_MODIFIER_END",r[r.DIACRITICAL_MARKS_START=8400]="DIACRITICAL_MARKS_START",r[r.DIACRITICAL_MARKS_END=8447]="DIACRITICAL_MARKS_END",r[r.SUBDIVISION_INDICATOR_START=127988]="SUBDIVISION_INDICATOR_START",r[r.TAGS_START=917504]="TAGS_START",r[r.TAGS_END=917631]="TAGS_END",r[r.ZWJ=8205]="ZWJ"}(Rs||(Rs={}));const Ms=Object.freeze([776,2359,2367,2984,3007,3021,3633,3635,3648,3657,4352,4449,4520]);var Bs;function runes(r){if("string"!=typeof r)throw new TypeError("string cannot be undefined or null");const x=[];let b=0,S=0;for(;b<r.length;)S+=nextUnits(b+S,r),isGrapheme(r[b+S])&&S++,isVariationSelector(r[b+S])&&S++,isDiacriticalMark(r[b+S])&&S++,isZeroWidthJoiner(r[b+S])?S++:(x.push(r.substring(b,b+S)),b+=S,S=0);return x}function nextUnits(r,x){const b=x[r];if(!function(r){return r&&betweenInclusive(r[0].charCodeAt(0),55296,56319)}(b)||r===x.length-1)return 1;const S=b+x[r+1];let C=x.substring(r+2,r+5);return isRegionalIndicator(S)&&isRegionalIndicator(C)?4:function(r){return betweenInclusive(codePointFromSurrogatePair(r),127988,127988)}(S)&&function(r){const x=r.codePointAt(0);return"string"==typeof r&&"number"==typeof x&&betweenInclusive(x,917504,917631)}(C)?x.slice(r).indexOf(String.fromCodePoint(917631))+2:function(r){return betweenInclusive(codePointFromSurrogatePair(r),127995,127999)}(C)?4:2}function isRegionalIndicator(r){return betweenInclusive(codePointFromSurrogatePair(r),127462,127487)}function isVariationSelector(r){return"string"==typeof r&&betweenInclusive(r.charCodeAt(0),65024,65039)}function isDiacriticalMark(r){return"string"==typeof r&&betweenInclusive(r.charCodeAt(0),8400,8447)}function isGrapheme(r){return"string"==typeof r&&Ms.includes(r.charCodeAt(0))}function isZeroWidthJoiner(r){return"string"==typeof r&&8205===r.charCodeAt(0)}function codePointFromSurrogatePair(r){return(r.charCodeAt(0)-55296<<10)+(r.charCodeAt(1)-56320)+65536}function betweenInclusive(r,x,b){return r>=x&&r<=b}!function(r){r[r.unit_1=1]="unit_1",r[r.unit_2=2]="unit_2",r[r.unit_4=4]="unit_4"}(Bs||(Bs={}));const Ps=new r.Vector3,Ls=new Set,Os=new Set;Ls.add("ArrowLeft"),Ls.add("ArrowRight"),Ls.add("ArrowUp"),Ls.add("ArrowDown"),Os.add("Alt"),Os.add("Backspace"),Os.add("CapsLock"),Os.add("Control"),Os.add("Enter"),Os.add("Escape"),Os.add("Meta"),Os.add("Shift"),Os.add("Tab");class TextArea extends ScrollableComponent{constructor(...r){super(...r),this._defaults.alignItems="start",this._defaults.backgroundVisible=!0,this._defaults.borderMaterial.color.set(5197647),this._defaults.borderWidth=.002,this._defaults.color=0,this._defaults.contentDirection="row",this._defaults.justifyContent="start",this._defaults.fontSize=.06,this._defaults.overflow="scroll",this._defaults.paddingLeft=.01,this._defaults.height=.1,this._defaults.width=.4,this._latestValue.overflow=null,this._value=[],this._runeLengths=[],this._textStyle=new Style({color:this.color,fontSize:this.fontSize,textAlign:"left",maxWidth:0,minHeight:0}),this._text=new TextComponent("",this._textStyle),this._placeholder=new TextComponent("",this._textStyle,{color:8421504}),this._placeholder.troikaText.material.opacity=.75,this._content.add(this._text),this._content.add(this._placeholder),this._createCaret(),this.onClick=r=>this._select(r),this.onTouch=r=>this._selectTouch(r),this._keyListener=r=>this.handleKey(r.key),this._pasteListener=r=>this._handlePaste(r),this._downListener=r=>{let x=r.target;for(;x;){if(x==ks||x==this)return;x=x.parent}this.blur()},this._syncCompleteListener=()=>{this._updateCaret(),this._checkForCaretScroll()},this.updateLayout(),"visible"==this.overflow||this.clippingPlanes||this._createClippingPlanes()}_handleStyleUpdateForColor(){this._textStyle.color=this.color}_handleStyleUpdateForFontSize(){this._textStyle.fontSize=this.fontSize}_computeUnpaddedAndMarginedDimensions(r,x){super._computeUnpaddedAndMarginedDimensions(r,x),"width"==r&&this._textStyle.maxWidth!=this.unpaddedWidth&&(this._textStyle.maxWidth=this.unpaddedWidth)}_updateMaterialOffset(r){super._updateMaterialOffset(r),this._caret._updateMaterialOffset(this._materialOffset+1)}_selectTouch(r){let x=this.touchInteractable.getClosestPointTo(r.owner.object),b=x[1].object,S=b.bvhGeometry.index.array[3*x[1].faceIndex],C=b.bvhGeometry.getAttribute("position");Ps.fromBufferAttribute(C,S),b.localToWorld(Ps),this._select({point:Ps})}_select(r){let{point:x}=r;if(!x)return;this._textStyle.minHeight!=this._caret.computedHeight&&(this._textStyle.minHeight=this._caret.computedHeight),this._text._content.add(this._caretParent);let b=this._text._text;b.worldToLocal(Ps.copy(x));let S=getCaretAtPoint(b.textRenderInfo,Ps.x,Ps.y);this._setCaretIndexFromCharIndex(S.charIndex),this._updateCaret(),this._hasListeners||this._addListeners()}_addListeners(){this._hasListeners=!0,"XR"==Fr.active?(ks.register(this),di.addEventListener("down",this._downListener)):"TOUCH_SCREEN"==Fr.active?this._displayMobileTextArea():(document.addEventListener("keydown",this._keyListener),document.addEventListener("paste",this._pasteListener),di.addEventListener("down",this._downListener)),this._text._text.addEventListener("synccomplete",this._syncCompleteListener),this._onFocus&&this._onFocus()}_removeListeners(){this._hasListeners=!1,"XR"==Fr.active?(ks.unregister(this),di.removeEventListener("down",this._downListener)):"TOUCH_SCREEN"==Fr.active?document.body.removeChild(this._mobileTextAreaParent):(document.removeEventListener("keydown",this._keyListener),document.removeEventListener("paste",this._pasteListener),di.removeEventListener("down",this._downListener)),this._text._text.removeEventListener("synccomplete",this._syncCompleteListener),this._text._content.remove(this._caretParent),this._triggerBlurCallback()}_triggerBlurCallback(){this._onBlur&&this._onBlur(this._text.text)}_triggerChangeCallback(){this._onChange&&this._onChange(this._text.text)}_displayMobileTextArea(){if(!this._mobileTextArea){let r=document.createElement("div"),x=document.createElement("textarea");x.rows=5,x.style.fontSize="16px",x.style.minWidth="250px",x.style.width="33%",r.style.width="100%",r.style.height="100%",r.style.position="fixed",r.style.top="0px",r.style.left="0px",r.style.display="flex",r.style.justifyContent="center",r.style.alignItems="center",r.style.backgroundColor="#00000069",r.appendChild(x),r.onclick=b=>{b.target==r&&(this._text.text=x.value,this.blur())},x.onblur=()=>{this._text.text=x.value,this.blur()},x.addEventListener("compositionend",(()=>{this._text.text!=x.value&&(this._text.text=x.value,this._triggerChangeCallback())})),x.onkeyup=()=>{this._text.text!=x.value&&(this._text.text=x.value,this._triggerChangeCallback())},this._mobileTextAreaParent=r,this._mobileTextArea=x}document.body.appendChild(this._mobileTextAreaParent),Es.trigger((()=>this._mobileTextArea.click()))}_createCaret(){this._caretParent=new r.Object3D,this._caret=new TextComponent("|",this._textStyle),this._caret._text.fillOpacity=.75,this._caretParent.add(this._caret)}_getCharIndex(r=this._caretIndex){let x=0;for(let b=0;b<r;b++)x+=this._runeLengths[b];return x}_setCaretIndexFromCharIndex(r=0){let x,b=0,S=0;for(x=0;x<this._runeLengths.length&&b<r;x++)S=b,b+=this._runeLengths[x];let C=Math.abs(r-b),A=Math.abs(r-S);this._caretIndex=b==r||C<A?x:x-1}_updateCaret(){let r=this._getCharIndex(),x=4*r,b=0;if(r==this._text.text.length){if(0==r)return void this._caretParent.position.set(0,0,0);x-=4,b=1}let S=this._text._text.textRenderInfo.caretPositions,C=S[x+b],A=(S[x+2]+S[x+3])/2;isNaN(A)||this._caretParent.position.set(C,A,0)}handleKey(r){hi.isKeyPressed("Control")||hi.isKeyPressed("Meta")||("Backspace"==r?this._deleteChar():"Enter"==r?this.insertContent("\n"):"Escape"==r?this.blur():Ls.has(r)?this._moveCaret(r):Os.has(r)||this.insertContent(r))}_handlePaste(r){if(r.clipboardData.types.indexOf("text/plain")<0)return;let x=r.clipboardData.getData("text/plain");this.insertContent(x),r.preventDefault()}_moveCaret(r){if("ArrowLeft"==r)this._caretIndex>0&&(this._caretIndex--,this._updateCaret());else if("ArrowRight"==r)this._caretIndex<this._value.length&&(this._caretIndex++,this._updateCaret());else{let x=this._getCharIndex(),b=this._text.text,S="ArrowUp"==r?1:-1,C=4*x,A=0;this._caretIndex==b.length&&0!=this._caretIndex&&(C-=4,A=1);let I=this._text._text,R=I.textRenderInfo.caretPositions,B=R[C+A],D=(R[C+2]+R[C+3])/2,F=Math.abs(R[C+2]-R[C+3]),G=getCaretAtPoint(I.textRenderInfo,B,D+S*F);this._setCaretIndexFromCharIndex(G.charIndex),this._updateCaret()}this._checkForCaretScroll()}_deleteChar(){0!=this._caretIndex&&(this._value.splice(this._caretIndex-1,1),this._runeLengths.splice(this._caretIndex-1,1),this._text.text=this._value.join(""),this._caretIndex--,this._updateCaret(),0!=this._value.length||this._placeholder.parentComponent||this._content.add(this._placeholder),this._triggerChangeCallback())}_checkForCaretScroll(){if(!this._scrollable&&0!=this._content.position.y)return void(this._content.position.y=0);Ps.copy(this._caretParent.position),this._caretParent.parent.localToWorld(Ps),this.worldToLocal(Ps);let r=this.computedHeight/2,x=this._caret.computedHeight/2;Ps.y+x>r?this._content.position.y+=r-Ps.y-x:Ps.y-x<this.computedHeight/-2&&(this._content.position.y+=-r-Ps.y+x)}_sanitizeText(){}blur(){this._hasListeners&&this._removeListeners()}insertContent(r){let x=runes(r);this._value.splice(this._caretIndex,0,...x),this._text.text=this._value.join("");for(let r=0;r<x.length;r++)this._runeLengths.splice(this._caretIndex,0,x[r].length),this._caretIndex++;this._sanitizeText(),this._placeholder.parentComponent&&this._content.remove(this._placeholder),this._triggerChangeCallback()}get onBlur(){return this._onBlur}get onChange(){return this._onChange}get onFocus(){return this._onFocus}get placeholder(){return this._placeholder.text}get value(){return this._text.text}set onBlur(r){this._onBlur=r}set onChange(r){this._onChange=r}set onFocus(r){this._onFocus=r}set placeholder(r){this._placeholder.text=r}set value(r){r||(r=""),this._value=runes(r),this._text.text=r,this._runeLengths=[];for(let r=0;r<this._value.length;r++)this._runeLengths.push(this._value[r].length);0==this._value.length?this._placeholder.parentComponent||this._content.add(this._placeholder):this._placeholder.parentComponent&&this._content.remove(this._placeholder)}}const Ds=new r.Vector3,Us=new Set,Fs=new Set;Us.add("ArrowLeft"),Us.add("ArrowRight"),Fs.add("ArrowUp"),Fs.add("ArrowDown"),Fs.add("Alt"),Fs.add("Backspace"),Fs.add("CapsLock"),Fs.add("Control"),Fs.add("Enter"),Fs.add("Escape"),Fs.add("Meta"),Fs.add("Shift"),Fs.add("Tab");class TextInput extends TextArea{constructor(...r){super(...r),this._defaults.alignItems="center",this._latestValue.alignItems=null,this._text._overrideStyle.maxWidth=null,this._text._text.whiteSpace="nowrap",this.updateLayout()}_displayMobileTextArea(){if(!this._mobileTextArea){let r=document.createElement("div"),x=document.createElement("input");x.type="text",x.style.fontSize="16px",x.style.minWidth="250px",x.style.width="33%",r.style.width="100%",r.style.height="100%",r.style.position="fixed",r.style.top="0px",r.style.left="0px",r.style.display="flex",r.style.justifyContent="center",r.style.alignItems="center",r.style.backgroundColor="#00000069",r.appendChild(x),r.onclick=b=>{b.target==r&&(this._text.text=x.value,this.blur())},x.onblur=()=>{this._text.text=x.value,this.blur()},x.addEventListener("compositionend",(()=>{this._text.text!=x.value&&(this._text.text=x.value,this._triggerChangeCallback())})),x.onkeyup=r=>{"Enter"!=r.code?this._text.text!=x.value&&(this._text.text=x.value,this._triggerChangeCallback()):this._onEnter&&this._onEnter(this._text.text)},this._mobileTextAreaParent=r,this._mobileTextArea=x}document.body.appendChild(this._mobileTextAreaParent),Es.trigger((()=>this._mobileTextArea.click()))}handleKey(r){hi.isKeyPressed("Control")||hi.isKeyPressed("Meta")||("Backspace"==r?this._deleteChar():"Enter"==r?this._onEnter&&this._onEnter(this._text.text):"Escape"==r?this.blur():Us.has(r)?this._moveCaret(r):Fs.has(r)||this.insertContent(r))}_handlePaste(r){if(r.clipboardData.types.indexOf("text/plain")<0)return;let x=r.clipboardData.getData("text/plain");this.insertContent(x.replaceAll("\n"," ")),r.preventDefault()}_moveCaret(r){"ArrowLeft"==r?this._caretIndex>0&&(this._caretIndex--,this._updateCaret()):"ArrowRight"==r&&this._caretIndex<this._value.length&&(this._caretIndex++,this._updateCaret()),this._checkForCaretScroll()}_checkForCaretScroll(){if(!this._scrollable&&0!=this._content.position.x)return void(this._content.position.x=0);Ds.copy(this._caretParent.position),this._caretParent.parent.localToWorld(Ds),this.worldToLocal(Ds);let r=this.computedWidth/2,x=this._caret.computedWidth/2;Ds.x+x>r?this._content.position.x+=r-Ds.x-x:Ds.x-x<this.computedWidth/-2&&(this._content.position.x+=-r-Ds.x+x)}get onEnter(){return this._onEnter}get value(){return super.value}set onEnter(r){this._onEnter=r}set value(r){r||(r=""),r=r.replaceAll("\n"," "),super.value=r}}const Gs=new r.Vector3,Ns=new Set,Hs=new Set;Ns.add("ArrowLeft"),Ns.add("ArrowRight"),Hs.add("e"),Hs.add("E"),Hs.add("+");class NumberInput extends TextInput{constructor(...r){super(...r),this._defaults.alignItems="center",this._latestValue.alignItems=null,this._text._overrideStyle.maxWidth=null,this._text._text.whiteSpace="nowrap",this._minValue=-1/0,this._maxValue=1/0,this._lastValidValue="",this.updateLayout()}_addListeners(){this._hasListeners=!0,"XR"==Fr.active?(ks.register(this,ks.types.NUMBER),di.addEventListener("down",this._downListener)):"TOUCH_SCREEN"==Fr.active?this._displayMobileTextArea():(document.addEventListener("keydown",this._keyListener),document.addEventListener("paste",this._pasteListener),di.addEventListener("down",this._downListener)),this._text._text.addEventListener("synccomplete",this._syncCompleteListener),this._onFocus&&this._onFocus()}_displayMobileTextArea(){if(!this._mobileTextArea){let r=document.createElement("div"),x=document.createElement("input");x.type="text",x.inputMode="decimal",x.style.fontSize="16px",x.style.minWidth="250px",x.style.width="33%",r.style.width="100%",r.style.height="100%",r.style.position="fixed",r.style.top="0px",r.style.left="0px",r.style.display="flex",r.style.justifyContent="center",r.style.alignItems="center",r.style.backgroundColor="#00000069",r.appendChild(x),r.onclick=b=>{b.target==r&&(this._text.text=x.value,this.blur())},x.onblur=()=>{this._text.text=x.value,this.blur()},x.onkeydown=r=>{(Hs.has(r.key)||x.value.includes(".")&&"."==r.key||!r.key.match(/^[0-9.-]*$/)&&"Backspace"!=r.key&&"Enter"!=r.key)&&r.preventDefault()},x.onkeyup=r=>{"Enter"!=r.key?this._text.text!=x.value&&(this._text.text=x.value,this._triggerChangeCallback()):this._onEnter&&this._onEnter(this._text.text)},this._mobileTextAreaParent=r,this._mobileTextArea=x}document.body.appendChild(this._mobileTextAreaParent),Es.trigger((()=>this._mobileTextArea.click()))}handleKey(r){hi.isKeyPressed("Control")||hi.isKeyPressed("Meta")||("Backspace"==r?this._deleteChar():"Enter"==r?this._onEnter&&this._onEnter(this._text.text):"Escape"==r?this.blur():"±"==r?this._negate():Ns.has(r)?this._moveCaret(r):r.match(/^[0-9.-]*$/)&&this.insertContent(r))}_handlePaste(r){if(r.clipboardData.types.indexOf("text/plain")<0)return;let x=r.clipboardData.getData("text/plain");this.insertContent(x),r.preventDefault()}_checkForCaretScroll(){if(!this._scrollable&&0!=this._content.position.x)return void(this._content.position.x=0);Gs.copy(this._caretParent.position),this._caretParent.parent.localToWorld(Gs),this.worldToLocal(Gs);let r=this.computedWidth/2,x=this._caret.computedWidth/2;Gs.x+x>r?this._content.position.x+=r-Gs.x-x:Gs.x-x<this.computedWidth/-2&&(this._content.position.x+=-r-Gs.x+x)}_triggerBlurCallback(){let r=Number.parseFloat(this._text.text);isNaN(r)?this.value=this._lastValidValue:"number"==typeof this._minValue&&r<this._minValue?this.value=this._minValue:"number"==typeof this._maxValue&&r>this._maxValue&&(this.value=this._maxValue),this._lastValidValue=this._text.text,this._onBlur&&this._onBlur(this._text.text)}_triggerChangeCallback(){let r=Number.parseFloat(this._text.text);isNaN(r)||"number"==typeof this._minValue&&r<this._minValue||"number"==typeof this._maxValue&&r>this._maxValue||(this._lastValidValue=this._text.text,this._onChange&&this._onChange(this._text.text))}_sanitizeIncomingText(r,x){let b=!1,S=!1;return r=r.replaceAll(/[^0-9.-]/g,""),x&&(-1!=x.indexOf(".")&&(b=!0),-1!=x.indexOf("-")&&(S=!0)),b?r=r.replaceAll(".",""):-1!=r.indexOf(".")&&(r=r.split(".")[0]+"."+r.split(".").slice(1).join("")),S?r=r.replaceAll("-",""):-1!=r.indexOf("-")&&(r="-"+r.replaceAll("-","")),r}_negate(){this._text.text.indexOf("-")>=0?(this.value=this._text.text.replaceAll("-",""),this._moveCaret("ArrowLeft")):(this.value="-"+this.value,this._moveCaret("ArrowRight"))}_sanitizeScientificNotation(r){let x=r.toString().split("e"),b=x[0].replaceAll(".",""),S=Math.abs(x[1])-1,C="0."+"0".repeat(S)+b;return C.indexOf("-")>-1&&(C="-"+C.replace("-","")),C}_sanitizeText(){this._text.text.indexOf("-")>0&&(this.value="-"+this._text.text.replaceAll("-",""))}insertContent(r){r=this._sanitizeIncomingText(r,this._text.text),super.insertContent(r)}get maxValue(){return this._maxValue}get minValue(){return this._minValue}get onEnter(){return this._onEnter}get value(){return super.value}set maxValue(r){this._maxValue=r}set minValue(r){this._minValue=r}set onEnter(r){this._onEnter=r}set value(r){null==r&&(r=Math.max(this._minValue,0)),r=Math.abs(r)<=1e-7?this._sanitizeScientificNotation(r):this._sanitizeIncomingText(String(r)),super.value=r,this._lastValidValue=this._text.text}}const Ws={},Vs=new r.MeshBasicMaterial({color:12543,side:r.DoubleSide,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1});class Radio extends InteractableComponent{constructor(r,...x){super(...x),this._defaults.backgroundVisible=!0,this._defaults.borderMaterial.color.set(5197647),this._defaults.borderWidth=.002,this._defaults.height=.08,this._defaults.materialColor=16777215,this._defaults.width=.08,this._name=r,this._toggleMaterial=Vs.clone(),this.onClick=this.onTouch=()=>this._select(),this.updateLayout(),r in Ws||(Ws[r]=new Set),Ws[r].add(this)}_createBackground(){this._defaults.borderRadius=Math.min(this.computedHeight,this.computedHeight)/2,super._createBackground(),this._toggleChild?.parent&&this._toggleChild.parent.remove(this._toggleChild),this._toggleChild=new r.Mesh(this._background.geometry,this._toggleMaterial),this._background.add(this._toggleChild),this._toggleChild.scale.set(.75,.75,.75),this._toggleChild.visible=!!this._selected,this.borderMaterial.color.set(this._selected?12543:5197647)}_updateMaterialOffset(r){super._updateMaterialOffset(r),this._toggleMaterial.polygonOffsetFactor=this._toggleMaterial.polygonOffsetUnits=-1*this._materialOffset-1,this._toggleChild&&(this._toggleChild.renderOrder=this._materialOffset+1)}_select(r){for(let r of Ws[this._name])r!=this&&r.unselect();this._selected=!0,this.borderMaterial.color.set(12543),this._toggleChild.visible=!0,r||(this._onChange&&this._onChange(this._selected),this._onSelect&&this._onSelect())}_unselect(r){this._selected=!1,this.borderMaterial.color.set(5197647),this._toggleChild.visible=!1,this._onChange&&!r&&this._onChange(this._selected)}select(){this._select()}unselect(){this._unselect()}get onChange(){return this._onChange}get onSelect(){return this._onSelect}get selected(){return this._selected}set onChange(r){this._onChange=r}set onSelect(r){this._onSelect=r}set selected(r){r!=this._selected&&(r?this._select(!0):this.unselect(!0))}}const zs=new r.MeshBasicMaterial({color:12543,side:r.DoubleSide,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1}),js=new r.Vector3,Xs=new r.Plane;class Range extends InteractableComponent{constructor(...r){super(...r),this._defaults.backgroundVisible=!0,this._defaults.borderMaterial.color.set(5197647),this._defaults.borderWidth=.002,this._defaults.height=.02,this._defaults.materialColor=16777215,this._defaults.width=.4,this._value=0,this._scrubberMaterial=zs.clone(),this._scrubbingOwner,this.pointerInteractable.addEventListener("down",(r=>this.pointerInteractable.capture(r.owner))),this.onClick=r=>this._select(r),this.onTouch=r=>this._touchSelect(r),this.onDrag=r=>this._drag(r),this.onTouchDrag=r=>this._touchDrag(r),this.updateLayout()}_createBackground(){this._defaults.borderRadius=Math.min(this.computedHeight,this.computedWidth)/2,super._createBackground(),this._scrubberChild?.parent&&this._scrubberChild.parent.remove(this._scrubberChild),this._scrubberValue?.parent&&this._scrubberValue.parent.remove(this._scrubberValue);let x=new r.CircleGeometry(1.5*this.computedHeight);this._scrubberChild=new r.Mesh(x,this._scrubberMaterial),this._scrubberValue=new r.Mesh(this._background.geometry,this._scrubberMaterial),this._background.add(this._scrubberChild),this._background.add(this._scrubberValue),this._updateScrubber()}_updateScrubber(){this._scrubberChild.position.setX((this._value-.5)*this.width),this._scrubberValue.scale.setX(this._value),this._scrubberValue.position.setX(this.width*(this._value-1)/2)}_updateMaterialOffset(r){super._updateMaterialOffset(r),this._scrubberMaterial.polygonOffsetFactor=this._scrubberMaterial.polygonOffsetUnits=-1*this._materialOffset-1,this._scrubberChild&&(this._scrubberChild.renderOrder=this._materialOffset+1)}_select(r){let{owner:x,point:b}=r;this._scrubbingOwner==x&&(this._updateValue(x,b),this._scrubbingOwner=null,this._onBlur&&this._onBlur(this._value))}_touchSelect(r){this._scrubbingOwner==r.owner&&(this._scrubbingOwner=null,this._onBlur&&this._onBlur(this._value))}_drag(r){let{owner:x,point:b}=r;this._updateValue(x,b)&&this._onChange&&this._onChange(this._value)}_touchDrag(r){let x=r.owner;this._updateValueFromTouch(x)&&this._onChange&&this._onChange(this._value)}_updateValue(r,x){if(this._scrubbingOwner){if(this._scrubbingOwner!=r)return!1}else this._scrubbingOwner=r;if(x?x=js.copy(x):(Xs.set(js.set(0,0,1),0),Xs.applyMatrix4(this.matrixWorld),x=r.raycaster.ray.intersectPlane(Xs,js)),x){let r=(x=this.worldToLocal(x)).x/this.width+.5;r=Math.max(0,Math.min(r,1));let b=this._value!=r;return this._value=r,b&&this._updateScrubber(),b}return!1}_updateValueFromTouch(r){if(this._scrubbingOwner){if(this._scrubbingOwner!=r)return!1}else{this._scrubbingOwner=r;let x=this.touchInteractable.getClosestPointTo(r.object);this._touchController=x[1].object,this._scrollVertex=this._touchController.bvhGeometry.index.array[3*x[1].faceIndex]}let x=this._touchController.bvhGeometry.getAttribute("position");js.fromBufferAttribute(x,this._scrollVertex),this._touchController.localToWorld(js),this.worldToLocal(js);let b=js.x/this.width+.5;b=Math.max(0,Math.min(b,1));let S=this._value!=b;return this._value=b,S&&this._updateScrubber(),S}get onBlur(){return this._onBlur}get onChange(){return this._onChange}get value(){return this._value}set onBlur(r){this._onBlur=r}set onChange(r){this._onChange=r}set value(r){this._value=Math.max(0,Math.min(r,1)),this._updateScrubber()}}class Select extends ScrollableComponent{constructor(...r){super(...r),this._defaults.backgroundVisible=!0,this._defaults.borderMaterial.color.set(5197647),this._defaults.borderWidth=.002,this._defaults.height=.1,this._defaults.width=.4,this._optionsDivStyle=new Style({backgroundVisible:this.backgroundVisible,borderMaterial:this.borderMaterial.clone(),borderWidth:this.borderWidth,overflow:"scroll",paddingBottom:this.borderWidth,paddingTop:this.borderWidth,width:this.width}),this._optionsDiv=new Div(this._optionsDivStyle),this._optionsDiv._content.position.z*=3,this._optionsStyle=new Style({backgroundVisible:this.backgroundVisible,width:"90%"}),this.pointerInteractableClassOverride&&(this._optionsStyle.pointerInteractableClassOverride=this.pointerInteractableClassOverride),this._optionsTextStyle=new Style({maxWidth:"100%"}),this.padding&&(this._optionsTextStyle.padding=this.padding),this._value,this._options=[],this._textSpan=new Span({alignItems:"start",justifyContent:"spaceBetween",height:"100%",overflow:"hidden",width:"90%"}),this._text=new TextComponent(" ",this._optionsTextStyle,{maxWidth:"85%",minWidth:"85%"}),this._text._text.lineHeight=1/.55,this._caret=new TextComponent("⌄"),this._caret._text.anchorY="85%",this._content.add(this._textSpan),this._textSpan.add(this._text),this._textSpan.add(this._caret),this._downListener=r=>{let x=r.target;for(;x;){if(x==this)return;x=x.parent}this.hideOptions()},this.onClick=this.onTouch=()=>this._select(),this.updateLayout()}updateLayout(){super.updateLayout(),this._optionsStyle.minHeight!=this.computedHeight&&(this._optionsStyle.minHeight=this.computedHeight),this._optionsTextStyle.minWidth!=.9*this.unpaddedWidth&&(this._optionsTextStyle.minWidth=.9*this.unpaddedWidth),this._optionsTextStyle.fontSize!=.55*this.unpaddedHeight&&(this._optionsTextStyle.fontSize=.55*this.unpaddedHeight,this._caret.fontSize=.8*this.unpaddedHeight)}_handleStyleUpdateForWidth(){super._handleStyleUpdateForWidth(),this._optionsDivStyle.width=this.width}_select(){this.remove(this._textSpan),this.add(this._optionsDiv),this._optionsDiv._updateMaterialOffset(this._materialOffset+3),this.onClick=this.onTouch=null,di.addEventListener("down",this._downListener)}_selectOption(r){let x=this._value!=r;this._value=r,this._text.text=r,this.hideOptions(),x&&this._onChange&&this._onChange(this._value)}addOptions(...r){for(let x of r){let r=new Span(this._optionsStyle),b=new TextComponent(x,this._optionsTextStyle);r.onClick=r.onTouch=()=>this._selectOption(b.text),r.add(b),r.pointerInteractable.addStateCallback((x=>{x==Dr.HOVERED?r.material.color.set(30207):x==Dr.IDLE&&r.material.color.set(16777215)})),this._optionsDiv.add(r)}}hideOptions(){this.remove(this._optionsDiv),this.add(this._textSpan),this.onClick=this.onTouch=()=>this._select(),di.removeEventListener("down",this._downListener)}get maxDisplayOptions(){return this._maxDisplayOptions}get onChange(){return this._onChange}get value(){return this._value}set maxDisplayOptions(r){this._maxDisplayOptions=r,this._optionsDivStyle.maxHeight=null==r?null:100*this._maxDisplayOptions+"%"}set onChange(r){this._onChange=r}set value(r){this._value=r,this._text.text=r}}const qs=new r.MeshBasicMaterial({color:16777215,side:r.DoubleSide,transparent:!0,polygonOffset:!0,polygonOffsetFactor:1,polygonOffsetUnits:1});class Toggle extends InteractableComponent{constructor(...r){super(...r),this._defaults.backgroundVisible=!0,this._defaults.color=16777215,this._defaults.height=.08,this._defaults.materialColor=13421772,this._defaults.width=.14,this._toggleMaterial=qs.clone(),this.onClick=this.onTouch=()=>this._change(),this.updateLayout()}_createBackground(){super._createBackground(),this._toggleChild?.parent&&this._toggleChild.parent.remove(this._toggleChild);let x=this.borderRadius||0,b=numberOr(this.borderTopLeftRadius,x),S=numberOr(this.borderTopRightRadius,x),C=numberOr(this.borderBottomLeftRadius,x),A=numberOr(this.borderBottomRightRadius,x),I=.24*this.computedHeight,R=this.computedHeight-I,B=(this.computedWidth-I)/2;this._toggleOffset=(this.computedWidth-B-I)/2,b=Math.max(b-I/2,0),S=Math.max(S-I/2,0),C=Math.max(C-I/2,0),A=Math.max(A-I/2,0);let D=this._materialOffset+1,F=Toggle.createShape(B,R,b,S,C,A),G=new r.ShapeGeometry(F);this._toggleChild=new r.Mesh(G,this._toggleMaterial),this._toggleChild.renderOrder=D,this._background.add(this._toggleChild),this._checked?this._toggleChild.position.setX(this._toggleOffset):this._toggleChild.position.setX(-this._toggleOffset)}_updateMaterialOffset(r){super._updateMaterialOffset(r),this._toggleMaterial.polygonOffsetFactor=this._toggleMaterial.polygonOffsetUnits=-1*this._materialOffset-1,this._toggleChild&&(this._toggleChild.renderOrder=this._materialOffset+1)}_change(){this._checked=!this._checked,this._checked?(this.material.color.set(12543),this._toggleChild.position.setX(this._toggleOffset)):(this.material.color.set(13421772),this._toggleChild.position.setX(-this._toggleOffset)),this._onChange&&this._onChange(this._checked)}get checked(){return this._checked}get onChange(){return this._onChange}set checked(r){r!=this._checked&&(this._checked=r,r?(this.material.color.set(12543),this._toggleChild.position.setX(this._toggleOffset)):(this.material.color.set(13421772),this._toggleChild.position.setX(-this._toggleOffset)))}set onChange(r){this._onChange=r}}const Ks=new r.Vector3;class GripInteractable extends Interactable{constructor(r){super(r),r&&(r.gripInteractable=this),this._createBoundingObject()}_createBoundingObject(){this._boundingBox=new r.Box3}_getBoundingObject(){return this._boundingBox.setFromObject(this._object),this._boundingBox}intersectsSphere(r){let x,b=this._getBoundingObject();return x=!!b&&r.intersectsBox(b),x}distanceToSphere(r){return r.distanceToPoint(this._boundingBox.getCenter(Ks))}}let $s=new class extends InteractableHandler{constructor(){super()}init(x){super.init(),this._scene=x,this._sphere=new r.Sphere,this._box3=new r.Box3}_getBoundingSphere(r){return r?(this._box3.setFromObject(r).getBoundingSphere(this._sphere),this._sphere):null}_isXRControllerPressed(r,x){if(r==Nr.HAND){let b=hi.getXRControllerModel(r,x);return 1==b?.motionController?.isGrabbing}{let r=hi.getXRGamepad(x);return null!=r?.buttons&&r.buttons[1].pressed}}_scopeInteractables(r,x){let b=r.boundingSphere;if(null!=b)for(let S of x){if((0!=S.children.size&&this._scopeInteractables(r,S.children),null!=S.object&&!S.isOnlyGroup())&&S.intersectsSphere(b)){let x=S.distanceToSphere(b);x<r.closestPointDistance&&(r.closestPointDistance=x,r.closestInteractable=S)}}}_updateInteractables(r){let x=r.owner,b=r.isPressed,S=this._hoveredInteractables.get(x),C=this._selectedInteractables.get(x),A=this._overInteractables.get(x),I=r.closestInteractable;I!=S&&(S&&(S.removeHoveredBy(x),this._hoveredInteractables.delete(x)),!I||(C||b)&&I!=C||(I.addHoveredBy(x),this._hoveredInteractables.set(x,I),S=I));let R={owner:x};C?(b||(C.removeSelectedBy(x),this._selectedInteractables.delete(x)),C==I?(A!=I&&(A&&A.out(R),I.over(R),this._overInteractables.set(x,I)),I.move(R),I.drag(R),b||(this._trigger("up",R,I),I.click(R))):C.isCapturedBy(x)?(C!=A&&(A&&A.out(R),C.over(R),this._overInteractables.set(x,C),A=C),C.move(R),C.drag(R),b||(this._trigger("up",R,C),C.click(R),A&&A.out(R),I?(I.over(R),this._overInteractables.set(x,I)):this._overInteractables.delete(x))):I?(A!=I&&(A&&A.out(R),I.over(R),this._overInteractables.set(x,I)),I.move(R),b||this._trigger("up",R,I)):A&&(A.out(R),this._overInteractables.delete(x))):I?(A!=I&&(A&&A.out(R),I.over(R),this._overInteractables.set(x,I)),I.move(R),b&&!this._wasPressed.get(x)?(this._trigger("down",R,I),I.addSelectedBy(x),this._selectedInteractables.set(x,I)):!b&&this._wasPressed.get(x)&&this._trigger("up",R,I)):(A&&(A.out(R),this._overInteractables.delete(x)),b?this._wasPressed.get(x)||this._trigger("down",R):this._wasPressed.get(x)&&this._trigger("up",R)),this._wasPressed.set(x,b)}_updateForXR(){for(let r in Gr){let x=!1;for(let b of[Nr.CONTROLLER,Nr.HAND]){let S=hi.getXRController(b,r,"grip"),C=hi.getXRControllerModel(b,r);if(S||(S=hi.getXRController(b,r,"targetRay")),!S)continue;let A,I,R=this._getOwner(S),B=isDescendant(this._scene,S);if(B&&(b==Nr.CONTROLLER?x=!0:x&&(B=!1)),B){A=isDescendant(S,C)?this._getBoundingSphere(C):this._getBoundingSphere(S),I=this._isXRControllerPressed(b,r)}let D={owner:R,boundingSphere:A,isPressed:I,closestPointDistance:Number.MAX_SAFE_INTEGER},F=!1;this._toolHandlers[this._tool]&&(F=this._toolHandlers[this._tool](D)),F||(this._scopeInteractables(D,this._interactables),this._updateInteractables(D))}}}};!function(r,x){"object"==typeof exports&&"object"==typeof module?module.exports=x():"function"==typeof define&&define.amd?define("nipplejs",[],x):"object"==typeof exports?exports.nipplejs=x():r.nipplejs=x()}(window,(function(){return function(r){var x={};function e(b){if(x[b])return x[b].exports;var S=x[b]={i:b,l:!1,exports:{}};return r[b].call(S.exports,S,S.exports,e),S.l=!0,S.exports}return e.m=r,e.c=x,e.d=function(r,x,b){e.o(r,x)||Object.defineProperty(r,x,{enumerable:!0,get:b})},e.r=function(r){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(r,"__esModule",{value:!0})},e.t=function(r,x){if(1&x&&(r=e(r)),8&x)return r;if(4&x&&"object"==typeof r&&r&&r.__esModule)return r;var b=Object.create(null);if(e.r(b),Object.defineProperty(b,"default",{enumerable:!0,value:r}),2&x&&"string"!=typeof r)for(var S in r)e.d(b,S,function(x){return r[x]}.bind(null,S));return b},e.n=function(r){var x=r&&r.__esModule?function(){return r.default}:function(){return r};return e.d(x,"a",x),x},e.o=function(r,x){return Object.prototype.hasOwnProperty.call(r,x)},e.p="",e(e.s=0)}([function(r,x,b){b.r(x);var S,n=function(r,x){var b=x.x-r.x,S=x.y-r.y;return Math.sqrt(b*b+S*S)},s=function(r){return r*(Math.PI/180)},C=new Map,a=function(r){C.has(r)&&clearTimeout(C.get(r)),C.set(r,setTimeout(r,100))},p=function(r,x,b){for(var S,C=x.split(/[ ,]+/g),A=0;A<C.length;A+=1)S=C[A],r.addEventListener?r.addEventListener(S,b,!1):r.attachEvent&&r.attachEvent(S,b)},c=function(r,x,b){for(var S,C=x.split(/[ ,]+/g),A=0;A<C.length;A+=1)S=C[A],r.removeEventListener?r.removeEventListener(S,b):r.detachEvent&&r.detachEvent(S,b)},l=function(r){return r.preventDefault(),r.type.match(/^touch/)?r.changedTouches:r},h=function(){return{x:void 0!==window.pageXOffset?window.pageXOffset:(document.documentElement||document.body.parentNode||document.body).scrollLeft,y:void 0!==window.pageYOffset?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop}},u=function(r,x){x.top||x.right||x.bottom||x.left?(r.style.top=x.top,r.style.right=x.right,r.style.bottom=x.bottom,r.style.left=x.left):(r.style.left=x.x+"px",r.style.top=x.y+"px")},f=function(r,x,b){var S=y(r);for(var C in S)if(S.hasOwnProperty(C))if("string"==typeof x)S[C]=x+" "+b;else{for(var A="",I=0,R=x.length;I<R;I+=1)A+=x[I]+" "+b+", ";S[C]=A.slice(0,-2)}return S},y=function(r){var x={};return x[r]="",["webkit","Moz","o"].forEach((function(b){x[b+r.charAt(0).toUpperCase()+r.slice(1)]=""})),x},m=function(r,x){for(var b in x)x.hasOwnProperty(b)&&(r[b]=x[b]);return r},v=function(r,x){if(r.length)for(var b=0,S=r.length;b<S;b+=1)x(r[b]);else x(r)},A=!!("ontouchstart"in window),I=!!window.PointerEvent,R=!!window.MSPointerEvent,B={start:"mousedown",move:"mousemove",end:"mouseup"},D={};function _(){}I?S={start:"pointerdown",move:"pointermove",end:"pointerup, pointercancel"}:R?S={start:"MSPointerDown",move:"MSPointerMove",end:"MSPointerUp"}:A?(S={start:"touchstart",move:"touchmove",end:"touchend, touchcancel"},D=B):S=B,_.prototype.on=function(r,x){var b,S=r.split(/[ ,]+/g);this._handlers_=this._handlers_||{};for(var C=0;C<S.length;C+=1)b=S[C],this._handlers_[b]=this._handlers_[b]||[],this._handlers_[b].push(x);return this},_.prototype.off=function(r,x){return this._handlers_=this._handlers_||{},void 0===r?this._handlers_={}:void 0===x?this._handlers_[r]=null:this._handlers_[r]&&this._handlers_[r].indexOf(x)>=0&&this._handlers_[r].splice(this._handlers_[r].indexOf(x),1),this},_.prototype.trigger=function(r,x){var b,S=this,C=r.split(/[ ,]+/g);S._handlers_=S._handlers_||{};for(var A=0;A<C.length;A+=1)b=C[A],S._handlers_[b]&&S._handlers_[b].length&&S._handlers_[b].forEach((function(r){r.call(S,{type:b,target:S},x)}))},_.prototype.config=function(r){this.options=this.defaults||{},r&&(this.options=function(r,x){var b={};for(var S in r)r.hasOwnProperty(S)&&x.hasOwnProperty(S)?b[S]=x[S]:r.hasOwnProperty(S)&&(b[S]=r[S]);return b}(this.options,r))},_.prototype.bindEvt=function(r,x){var b=this;return b._domHandlers_=b._domHandlers_||{},b._domHandlers_[x]=function(){"function"==typeof b["on"+x]?b["on"+x].apply(b,arguments):console.warn('[WARNING] : Missing "on'+x+'" handler.')},p(r,S[x],b._domHandlers_[x]),D[x]&&p(r,D[x],b._domHandlers_[x]),b},_.prototype.unbindEvt=function(r,x){return this._domHandlers_=this._domHandlers_||{},c(r,S[x],this._domHandlers_[x]),D[x]&&c(r,D[x],this._domHandlers_[x]),delete this._domHandlers_[x],this};var F=_;function k(r,x){return this.identifier=x.identifier,this.position=x.position,this.frontPosition=x.frontPosition,this.collection=r,this.defaults={size:100,threshold:.1,color:"white",fadeTime:250,dataOnly:!1,restJoystick:!0,restOpacity:.5,mode:"dynamic",zone:document.body,lockX:!1,lockY:!1,shape:"circle"},this.config(x),"dynamic"===this.options.mode&&(this.options.restOpacity=0),this.id=k.id,k.id+=1,this.buildEl().stylize(),this.instance={el:this.ui.el,on:this.on.bind(this),off:this.off.bind(this),show:this.show.bind(this),hide:this.hide.bind(this),add:this.addToDom.bind(this),remove:this.removeFromDom.bind(this),destroy:this.destroy.bind(this),setPosition:this.setPosition.bind(this),resetDirection:this.resetDirection.bind(this),computeDirection:this.computeDirection.bind(this),trigger:this.trigger.bind(this),position:this.position,frontPosition:this.frontPosition,ui:this.ui,identifier:this.identifier,id:this.id,options:this.options},this.instance}k.prototype=new F,k.constructor=k,k.id=0,k.prototype.buildEl=function(r){return this.ui={},this.options.dataOnly||(this.ui.el=document.createElement("div"),this.ui.back=document.createElement("div"),this.ui.front=document.createElement("div"),this.ui.el.className="nipple collection_"+this.collection.id,this.ui.back.className="back",this.ui.front.className="front",this.ui.el.setAttribute("id","nipple_"+this.collection.id+"_"+this.id),this.ui.el.appendChild(this.ui.back),this.ui.el.appendChild(this.ui.front)),this},k.prototype.stylize=function(){if(this.options.dataOnly)return this;var r=this.options.fadeTime+"ms",x=function(r,x){var b=y("borderRadius");for(var S in b)b.hasOwnProperty(S)&&(b[S]="50%");return b}(),b=f("transition","opacity",r),S={};return S.el={position:"absolute",opacity:this.options.restOpacity,display:"block",zIndex:999},S.back={position:"absolute",display:"block",width:this.options.size+"px",height:this.options.size+"px",marginLeft:-this.options.size/2+"px",marginTop:-this.options.size/2+"px",background:this.options.color,opacity:".5"},S.front={width:this.options.size/2+"px",height:this.options.size/2+"px",position:"absolute",display:"block",marginLeft:-this.options.size/4+"px",marginTop:-this.options.size/4+"px",background:this.options.color,opacity:".5",transform:"translate(0px, 0px)"},m(S.el,b),"circle"===this.options.shape&&m(S.back,x),m(S.front,x),this.applyStyles(S),this},k.prototype.applyStyles=function(r){for(var x in this.ui)if(this.ui.hasOwnProperty(x))for(var b in r[x])this.ui[x].style[b]=r[x][b];return this},k.prototype.addToDom=function(){return this.options.dataOnly||document.body.contains(this.ui.el)||this.options.zone.appendChild(this.ui.el),this},k.prototype.removeFromDom=function(){return this.options.dataOnly||!document.body.contains(this.ui.el)||this.options.zone.removeChild(this.ui.el),this},k.prototype.destroy=function(){clearTimeout(this.removeTimeout),clearTimeout(this.showTimeout),clearTimeout(this.restTimeout),this.trigger("destroyed",this.instance),this.removeFromDom(),this.off()},k.prototype.show=function(r){var x=this;return x.options.dataOnly||(clearTimeout(x.removeTimeout),clearTimeout(x.showTimeout),clearTimeout(x.restTimeout),x.addToDom(),x.restCallback(),setTimeout((function(){x.ui.el.style.opacity=1}),0),x.showTimeout=setTimeout((function(){x.trigger("shown",x.instance),"function"==typeof r&&r.call(this)}),x.options.fadeTime)),x},k.prototype.hide=function(r){var x=this;if(x.options.dataOnly)return x;if(x.ui.el.style.opacity=x.options.restOpacity,clearTimeout(x.removeTimeout),clearTimeout(x.showTimeout),clearTimeout(x.restTimeout),x.removeTimeout=setTimeout((function(){var b="dynamic"===x.options.mode?"none":"block";x.ui.el.style.display=b,"function"==typeof r&&r.call(x),x.trigger("hidden",x.instance)}),x.options.fadeTime),x.options.restJoystick){var b=x.options.restJoystick,S={};S.x=!0===b||!1!==b.x?0:x.instance.frontPosition.x,S.y=!0===b||!1!==b.y?0:x.instance.frontPosition.y,x.setPosition(r,S)}return x},k.prototype.setPosition=function(r,x){var b=this;b.frontPosition={x:x.x,y:x.y};var S=b.options.fadeTime+"ms",C={};C.front=f("transition",["transform"],S);var A={front:{}};A.front={transform:"translate("+b.frontPosition.x+"px,"+b.frontPosition.y+"px)"},b.applyStyles(C),b.applyStyles(A),b.restTimeout=setTimeout((function(){"function"==typeof r&&r.call(b),b.restCallback()}),b.options.fadeTime)},k.prototype.restCallback=function(){var r={};r.front=f("transition","none",""),this.applyStyles(r),this.trigger("rested",this.instance)},k.prototype.resetDirection=function(){this.direction={x:!1,y:!1,angle:!1}},k.prototype.computeDirection=function(r){var x,b,S,C=r.angle.radian,A=Math.PI/4,I=Math.PI/2;if(C>A&&C<3*A&&!r.lockX?x="up":C>-A&&C<=A&&!r.lockY?x="left":C>3*-A&&C<=-A&&!r.lockX?x="down":r.lockY||(x="right"),r.lockY||(b=C>-I&&C<I?"left":"right"),r.lockX||(S=C>0?"up":"down"),r.force>this.options.threshold){var R,B={};for(R in this.direction)this.direction.hasOwnProperty(R)&&(B[R]=this.direction[R]);var D={};for(R in this.direction={x:b,y:S,angle:x},r.direction=this.direction,B)B[R]===this.direction[R]&&(D[R]=!0);if(D.x&&D.y&&D.angle)return r;D.x&&D.y||this.trigger("plain",r),D.x||this.trigger("plain:"+b,r),D.y||this.trigger("plain:"+S,r),D.angle||this.trigger("dir dir:"+x,r)}else this.resetDirection();return r};var G=k;function E(r,x){this.nipples=[],this.idles=[],this.actives=[],this.ids=[],this.pressureIntervals={},this.manager=r,this.id=E.id,E.id+=1,this.defaults={zone:document.body,multitouch:!1,maxNumberOfNipples:10,mode:"dynamic",position:{top:0,left:0},catchDistance:200,size:100,threshold:.1,color:"white",fadeTime:250,dataOnly:!1,restJoystick:!0,restOpacity:.5,lockX:!1,lockY:!1,shape:"circle",dynamicPage:!1,follow:!1},this.config(x),"static"!==this.options.mode&&"semi"!==this.options.mode||(this.options.multitouch=!1),this.options.multitouch||(this.options.maxNumberOfNipples=1);var b=getComputedStyle(this.options.zone.parentElement);return b&&"flex"===b.display&&(this.parentIsFlex=!0),this.updateBox(),this.prepareNipples(),this.bindings(),this.begin(),this.nipples}E.prototype=new F,E.constructor=E,E.id=0,E.prototype.prepareNipples=function(){var r=this.nipples;r.on=this.on.bind(this),r.off=this.off.bind(this),r.options=this.options,r.destroy=this.destroy.bind(this),r.ids=this.ids,r.id=this.id,r.processOnMove=this.processOnMove.bind(this),r.processOnEnd=this.processOnEnd.bind(this),r.get=function(x){if(void 0===x)return r[0];for(var b=0,S=r.length;b<S;b+=1)if(r[b].identifier===x)return r[b];return!1}},E.prototype.bindings=function(){this.bindEvt(this.options.zone,"start"),this.options.zone.style.touchAction="none",this.options.zone.style.msTouchAction="none"},E.prototype.begin=function(){var r=this.options;if("static"===r.mode){var x=this.createNipple(r.position,this.manager.getIdentifier());x.add(),this.idles.push(x)}},E.prototype.createNipple=function(r,x){var b=this.manager.scroll,S={},C=this.options,A=this.parentIsFlex?b.x:b.x+this.box.left,I=this.parentIsFlex?b.y:b.y+this.box.top;if(r.x&&r.y)S={x:r.x-A,y:r.y-I};else if(r.top||r.right||r.bottom||r.left){var R=document.createElement("DIV");R.style.display="hidden",R.style.top=r.top,R.style.right=r.right,R.style.bottom=r.bottom,R.style.left=r.left,R.style.position="absolute",C.zone.appendChild(R);var B=R.getBoundingClientRect();C.zone.removeChild(R),S=r,r={x:B.left+b.x,y:B.top+b.y}}var D=new G(this,{color:C.color,size:C.size,threshold:C.threshold,fadeTime:C.fadeTime,dataOnly:C.dataOnly,restJoystick:C.restJoystick,restOpacity:C.restOpacity,mode:C.mode,identifier:x,position:r,zone:C.zone,frontPosition:{x:0,y:0},shape:C.shape});return C.dataOnly||(u(D.ui.el,S),u(D.ui.front,D.frontPosition)),this.nipples.push(D),this.trigger("added "+D.identifier+":added",D),this.manager.trigger("added "+D.identifier+":added",D),this.bindNipple(D),D},E.prototype.updateBox=function(){this.box=this.options.zone.getBoundingClientRect()},E.prototype.bindNipple=function(r){var x,b=this,o=function(r,S){x=r.type+" "+S.id+":"+r.type,b.trigger(x,S)};r.on("destroyed",b.onDestroyed.bind(b)),r.on("shown hidden rested dir plain",o),r.on("dir:up dir:right dir:down dir:left",o),r.on("plain:up plain:right plain:down plain:left",o)},E.prototype.pressureFn=function(r,x,b){var S=this,C=0;clearInterval(S.pressureIntervals[b]),S.pressureIntervals[b]=setInterval(function(){var b=r.force||r.pressure||r.webkitForce||0;b!==C&&(x.trigger("pressure",b),S.trigger("pressure "+x.identifier+":pressure",b),C=b)}.bind(S),100)},E.prototype.onstart=function(r){var x=this,b=x.options,S=r;return r=l(r),x.updateBox(),v(r,(function(C){x.actives.length<b.maxNumberOfNipples?x.processOnStart(C):S.type.match(/^touch/)&&(Object.keys(x.manager.ids).forEach((function(b){if(Object.values(S.touches).findIndex((function(r){return r.identifier===b}))<0){var C=[r[0]];C.identifier=b,x.processOnEnd(C)}})),x.actives.length<b.maxNumberOfNipples&&x.processOnStart(C))})),x.manager.bindDocument(),!1},E.prototype.processOnStart=function(r){var x,b=this,S=b.options,C=b.manager.getIdentifier(r),A=r.force||r.pressure||r.webkitForce||0,I={x:r.pageX,y:r.pageY},R=b.getOrCreate(C,I);R.identifier!==C&&b.manager.removeIdentifier(R.identifier),R.identifier=C;var p=function(x){x.trigger("start",x),b.trigger("start "+x.id+":start",x),x.show(),A>0&&b.pressureFn(r,x,x.identifier),b.processOnMove(r)};if((x=b.idles.indexOf(R))>=0&&b.idles.splice(x,1),b.actives.push(R),b.ids.push(R.identifier),"semi"!==S.mode)p(R);else{if(!(n(I,R.position)<=S.catchDistance))return R.destroy(),void b.processOnStart(r);p(R)}return R},E.prototype.getOrCreate=function(r,x){var b,S=this.options;return/(semi|static)/.test(S.mode)?(b=this.idles[0])?(this.idles.splice(0,1),b):"semi"===S.mode?this.createNipple(x,r):(console.warn("Coudln't find the needed nipple."),!1):b=this.createNipple(x,r)},E.prototype.processOnMove=function(r){var x=this.options,b=this.manager.getIdentifier(r),S=this.nipples.get(b),C=this.manager.scroll;if(function(r){return isNaN(r.buttons)?0!==r.pressure:0!==r.buttons}(r)){if(!S)return console.error("Found zombie joystick with ID "+b),void this.manager.removeIdentifier(b);if(x.dynamicPage){var A=S.el.getBoundingClientRect();S.position={x:C.x+A.left,y:C.y+A.top}}S.identifier=b;var I=S.options.size/2,R={x:r.pageX,y:r.pageY};x.lockX&&(R.y=S.position.y),x.lockY&&(R.x=S.position.x);var B,D,F,G,N,H,W,V,j,X,q=n(R,S.position),K=(B=R,F=(D=S.position).x-B.x,G=D.y-B.y,function(r){return r*(180/Math.PI)}(Math.atan2(G,F))),$=s(K),Y=q/I,J={distance:q,position:R};if("circle"===S.options.shape?(N=Math.min(q,I),W=S.position,V=N,X={x:0,y:0},j=s(j=K),X.x=W.x-V*Math.cos(j),X.y=W.y-V*Math.sin(j),H=X):(H=function(r,x,b){return{x:Math.min(Math.max(r.x,x.x-b),x.x+b),y:Math.min(Math.max(r.y,x.y-b),x.y+b)}}(R,S.position,I),N=n(H,S.position)),x.follow){if(q>I){var Z=R.x-H.x,Q=R.y-H.y;S.position.x+=Z,S.position.y+=Q,S.el.style.top=S.position.y-(this.box.top+C.y)+"px",S.el.style.left=S.position.x-(this.box.left+C.x)+"px",q=n(R,S.position)}}else R=H,q=N;var ee=R.x-S.position.x,te=R.y-S.position.y;S.frontPosition={x:ee,y:te},x.dataOnly||(S.ui.front.style.transform="translate("+ee+"px,"+te+"px)");var ne={identifier:S.identifier,position:R,force:Y,pressure:r.force||r.pressure||r.webkitForce||0,distance:q,angle:{radian:$,degree:K},vector:{x:ee/I,y:-te/I},raw:J,instance:S,lockX:x.lockX,lockY:x.lockY};(ne=S.computeDirection(ne)).angle={radian:s(180-K),degree:180-K},S.trigger("move",ne),this.trigger("move "+S.id+":move",ne)}else this.processOnEnd(r)},E.prototype.processOnEnd=function(r){var x=this,b=x.options,S=x.manager.getIdentifier(r),C=x.nipples.get(S),A=x.manager.removeIdentifier(C.identifier);C&&(b.dataOnly||C.hide((function(){"dynamic"===b.mode&&(C.trigger("removed",C),x.trigger("removed "+C.id+":removed",C),x.manager.trigger("removed "+C.id+":removed",C),C.destroy())})),clearInterval(x.pressureIntervals[C.identifier]),C.resetDirection(),C.trigger("end",C),x.trigger("end "+C.id+":end",C),x.ids.indexOf(C.identifier)>=0&&x.ids.splice(x.ids.indexOf(C.identifier),1),x.actives.indexOf(C)>=0&&x.actives.splice(x.actives.indexOf(C),1),/(semi|static)/.test(b.mode)?x.idles.push(C):x.nipples.indexOf(C)>=0&&x.nipples.splice(x.nipples.indexOf(C),1),x.manager.unbindDocument(),/(semi|static)/.test(b.mode)&&(x.manager.ids[A.id]=A.identifier))},E.prototype.onDestroyed=function(r,x){this.nipples.indexOf(x)>=0&&this.nipples.splice(this.nipples.indexOf(x),1),this.actives.indexOf(x)>=0&&this.actives.splice(this.actives.indexOf(x),1),this.idles.indexOf(x)>=0&&this.idles.splice(this.idles.indexOf(x),1),this.ids.indexOf(x.identifier)>=0&&this.ids.splice(this.ids.indexOf(x.identifier),1),this.manager.removeIdentifier(x.identifier),this.manager.unbindDocument()},E.prototype.destroy=function(){for(var r in this.unbindEvt(this.options.zone,"start"),this.nipples.forEach((function(r){r.destroy()})),this.pressureIntervals)this.pressureIntervals.hasOwnProperty(r)&&clearInterval(this.pressureIntervals[r]);this.trigger("destroyed",this.nipples),this.manager.unbindDocument(),this.off()};var N=E;function z(r){var x=this;x.ids={},x.index=0,x.collections=[],x.scroll=h(),x.config(r),x.prepareCollections();var e=function(){var r;x.collections.forEach((function(b){b.forEach((function(b){r=b.el.getBoundingClientRect(),b.position={x:x.scroll.x+r.left,y:x.scroll.y+r.top}}))}))};p(window,"resize",(function(){a(e)}));var o=function(){x.scroll=h()};return p(window,"scroll",(function(){a(o)})),x.collections}z.prototype=new F,z.constructor=z,z.prototype.prepareCollections=function(){var r=this;r.collections.create=r.create.bind(r),r.collections.on=r.on.bind(r),r.collections.off=r.off.bind(r),r.collections.destroy=r.destroy.bind(r),r.collections.get=function(x){var b;return r.collections.every((function(r){return!(b=r.get(x))})),b}},z.prototype.create=function(r){return this.createCollection(r)},z.prototype.createCollection=function(r){var x=new N(this,r);return this.bindCollection(x),this.collections.push(x),x},z.prototype.bindCollection=function(r){var x,b=this,o=function(r,S){x=r.type+" "+S.id+":"+r.type,b.trigger(x,S)};r.on("destroyed",b.onDestroyed.bind(b)),r.on("shown hidden rested dir plain",o),r.on("dir:up dir:right dir:down dir:left",o),r.on("plain:up plain:right plain:down plain:left",o)},z.prototype.bindDocument=function(){this.binded||(this.bindEvt(document,"move").bindEvt(document,"end"),this.binded=!0)},z.prototype.unbindDocument=function(r){Object.keys(this.ids).length&&!0!==r||(this.unbindEvt(document,"move").unbindEvt(document,"end"),this.binded=!1)},z.prototype.getIdentifier=function(r){var x;return r?void 0===(x=void 0===r.identifier?r.pointerId:r.identifier)&&(x=this.latest||0):x=this.index,void 0===this.ids[x]&&(this.ids[x]=this.index,this.index+=1),this.latest=x,this.ids[x]},z.prototype.removeIdentifier=function(r){var x={};for(var b in this.ids)if(this.ids[b]===r){x.id=b,x.identifier=this.ids[b],delete this.ids[b];break}return x},z.prototype.onmove=function(r){return this.onAny("move",r),!1},z.prototype.onend=function(r){return this.onAny("end",r),!1},z.prototype.oncancel=function(r){return this.onAny("end",r),!1},z.prototype.onAny=function(r,x){var b,S=this,C="processOn"+r.charAt(0).toUpperCase()+r.slice(1);x=l(x);var s=function(r,x,b){b.ids.indexOf(x)>=0&&(b[C](r),r._found_=!0)};return v(x,(function(r){b=S.getIdentifier(r),v(S.collections,s.bind(null,r,b)),r._found_||S.removeIdentifier(b)})),!1},z.prototype.destroy=function(){this.unbindDocument(!0),this.ids={},this.index=0,this.collections.forEach((function(r){r.destroy()})),this.off()},z.prototype.onDestroyed=function(r,x){if(this.collections.indexOf(x)<0)return!1;this.collections.splice(this.collections.indexOf(x),1)};var H=new z;x.default={create:function(r){return H.create(r)},factory:H}}]).default}));const{computeBoundsTree:Ys,disposeBoundsTree:Js,acceleratedRaycast:Zs}=Er;r.BufferGeometry.prototype.computeBoundsTree=Ys,r.BufferGeometry.prototype.disposeBoundsTree=Js,r.Mesh.prototype.raycast=Zs;const Qs="0.1.5",addGripInteractable=r=>{$s.addInteractable(r)},removeGripInteractable=r=>{$s.removeInteractable(r)},addPointerInteractable=r=>{di.addInteractable(r)},removePointerInteractable=r=>{di.removeInteractable(r)},addTouchInteractable=r=>{pi.addInteractable(r)},removeTouchInteractable=r=>{pi.removeInteractable(r)};const init=async(r,x,b,S,C,A)=>{C||(await async function(){if(navigator.userAgent){let r=navigator.userAgent.toLowerCase();if(r.indexOf("iphone")>=0||r.indexOf("ipad")>=0)return!1}return"xr"in navigator&&(await navigator.xr.isSessionSupported("immersive-vr")||await navigator.xr.isSessionSupported("immersive-ar"))}()?(C="XR",x.xr.enabled||(x.xr.enabled=!0)):C="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0?"TOUCH_SCREEN":"POINTER"),Fr.active=C,x.localClippingEnabled=!0,hi.init(r,x),di.init(x,b,S,A),$s.init(b),pi.init(b),"XR"!=C&&Es.setup()},update=r=>{"XR"==Fr.active&&(hi.update(r),$s.update(),pi.update()),di.update(),Mr.update()};export{Body,Checkbox,Es as DelayedClickHandler,Fr as DeviceTypes,Div,GripInteractable,$s as GripInteractableHandler,HSLColor,Gr as Handedness,ps as Image,hi as InputHandler,Interactable,Dr as InteractableStates,Or as InteractionToolHandler,ks as Keyboard,NumberInput,PointerInteractable,di as PointerInteractableHandler,Radio,Range,Select,Span,Style,TextComponent as Text,TextArea,TextInput,Er as ThreeMeshBVH,Toggle,TouchInteractable,pi as TouchInteractableHandler,ds as TroikaThreeText,Mr as UpdateHandler,Nr as XRInputDeviceTypes,addGripInteractable,addPointerInteractable,addTouchInteractable,init,removeGripInteractable,removePointerInteractable,removeTouchInteractable,update,Rr as utils,Qs as version};
